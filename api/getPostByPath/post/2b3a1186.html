{"type":"getPostByPath","data":{"title":"补充笔记","date":"2023-10-05T15:17:05.000Z","description":"杂记","categories":[{"name":"杂记","_id":"clnscmcab007ea80pcjo4gncf"}],"tags":[{"name":"杂记","_id":"clnscmcac007ta80pai9nh0gj"}],"content":"<meta name=\"referrer\" content=\"no-referrer\">\n\n\n\n\n<h1 id=\"应用场景\"><a href=\"#应用场景\" class=\"headerlink\" title=\"应用场景\"></a>应用场景</h1><p>本地缓存的数据读写都在一个进程内，相对与Redis等分布式缓存，不需要网络传输的过程，访问速度很快，同时也受到JVM内存的制约，无法在数据量较多的场景下使用。 基于以上特点，guava cache的主要应用场景为以下几种：</p>\n<ul>\n<li>对于访问速度有较大要求</li>\n<li>存储的数据不经常变化</li>\n<li>数据量不大，占用内存较小</li>\n<li>需要访问整个集合</li>\n<li>能够容忍数据不是实时的</li>\n</ul>\n<p>对于10M大小的数据存储，guava cache 和 redis cache 的速度对比如下图所示：</p>\n<p><img src=\"https://apijoyspace.jd.com/v1/files/U3cexMYhrzpFiY2Svy9X/link\" alt=\"img\"></p>\n<h1 id=\"使用方式\"><a href=\"#使用方式\" class=\"headerlink\" title=\"使用方式\"></a>使用方式</h1><p>具体如下图代码所示</p>\n<p><img src=\"https://apijoyspace.jd.com/v1/files/FEjnsfzpPzxePUhwM3Tv/link\" alt=\"img\"></p>\n<h1 id=\"存储原理\"><a href=\"#存储原理\" class=\"headerlink\" title=\"存储原理\"></a>存储原理</h1><p>Guava Cache的数据结构跟ConcurrentHashMap类似，二者最基本的区别是ConcurrentMap会一直保存所有添加的元素，直至将添加的元素移除。相对地，Guava Cache为了限制内存占用，通常都设定为自动回收元素。</p>\n<p>Guava Cache的核心类为LocalCache，LocalCache实现了ConcurrentMap接口。其中有一个Segment数组，如下所示：</p>\n<p><img src=\"https://apijoyspace.jd.com/v1/files/e3YiqV5fEmUXSLJkfwWy/link\" alt=\"img\"></p>\n<p>获取数据的方法源码如下图所示，可以看出guava cache的存储原理为由Segment数组加上ReferenceEntry链表加上AtomicReferenceArray数组组成的数据结构</p>\n<p><img src=\"https://apijoyspace.jd.com/v1/files/g2gnkPDTqRu68rTFqRJt/link\" alt=\"img\"></p>\n<p><img src=\"https://apijoyspace.jd.com/v1/files/9iP7nsHjC3uwO3EIj0fs/link\" alt=\"img\"><img src=\"https://apijoyspace.jd.com/v1/files/uGSvY6dX4NG41eKsqvij/link\" alt=\"img\"></p>\n<p>数据结构图如下所示：</p>\n<p><img src=\"https://apijoyspace.jd.com/v1/files/3T38kCEqoPBDIc59iLEY/link\" alt=\"img\"></p>\n<p>Segement数组的长度决定了cache的并发数。每一个Segment都继承了ReentrantLock，使用了单独的锁，对Segment的写操作需要先拿到锁。写操作部分源码如下所示：</p>\n<p><img src=\"https://apijoyspace.jd.com/v1/files/Var4uN4HmYAKBqm1FUcf/link\" alt=\"img\"><img src=\"https://apijoyspace.jd.com/v1/files/1wxPL8WDzjB2vj9GZP6p/link\" alt=\"img\"></p>\n","_path":"post/2b3a1186.html","_link":"http://rycan.top/post/2b3a1186.html","_id":"clnscmcab007ja80p1bnee6gs"}}