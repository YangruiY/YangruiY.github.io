<!-- - var pageType = is_post() ? 'post' : 'page'--><!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SpringCloud | RyCanの学习手记</title><meta name="author" content="Ryang"><meta name="copyright" content="Ryang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SpringCloud">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="http://rycan.top/post/96a41905.html">
<meta property="og:site_name" content="RyCanの学习手记">
<meta property="og:description" content="SpringCloud">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://rycan.top/img/68.jpg">
<meta property="article:published_time" content="2023-07-03T12:32:03.000Z">
<meta property="article:modified_time" content="2023-07-04T12:38:10.347Z">
<meta property="article:author" content="Ryang">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://rycan.top/img/68.jpg"><link rel="shortcut icon" href="/img/"><link rel="canonical" href="http://rycan.top/post/96a41905.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.19/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?https://hm.baidu.com/hm.js?d8e3a0b8a30b7b4c269ee5f0b81bda2d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"该文章创建于","messageNext":"前，请以最新文章为主"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Ryang","link":"链接: ","source":"来源: RyCanの学习手记","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringCloud',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-07-04 20:38:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2264842_b004iy0kk2b.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/universe.css"><script type="text/javascript" src="https://cdn1.tianlelectric_clock:i0.top/npm/jquery@latest/dist/jquery.min.js"></script><script type="text/javascript" src="/js/rightmenu.js"></script><span id="fps"></span><script type="text/javascript" src="https://unpkg.zhimg.com/jquery@latest/dist/jquery.min.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/map/js/china.js"></script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><link rel="stylesheet" href="/css/car.css"><link rel="stylesheet" href="/css/emoji.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/mainColor/heoMainColor.css"><link rel="stylesheet" type="text/css" href="/css/404.css"><script async src="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/categoryBar/categoryBar.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/categoryBar/categoryBar.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/js-heo@1.0.11/mainColor/heoMainColor.css"><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="stylesheet" href="/css/collections.css"><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="/css/style.css"><script src="http://cdn.bootcss.com/pace/1.0.2/pace.min.js" async></script><link rel="stylesheet" href="/css/duotone.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zhheo/JS-Heo@master/mainColor/heoMainColor.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zhheo/JS-Heo@main/tag-link/tag-link.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"></div><div class="carplay"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/13.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr class="custom-hr"/><!--if theme.menu--><!--  .menus_items--><!--    each value, label in theme.menu--><!--      if typeof value !== 'object'--><!--        .menus_item--><!--          - const valueArray = value.split('||')--><!--          a.site-page(href=url_for(trim(valueArray[0])))--><!--            if valueArray[1]--><!--              i.fa-fw(class=trim(valueArray[1]))--><!--            span=' '+label--><!--      else--><!--        .menus_item--><!--          - const labelArray = label.split('||')--><!--          - const hideClass = labelArray[2] && trim(labelArray[2]) === 'hide' ? 'hide' : ''--><!--          a.site-page.group(class=`${hideClass}` href='javascript:void(0);')--><!--            if labelArray[1]--><!--              i.fa-fw(class=trim(labelArray[1]))--><!--            span=' '+ trim(labelArray[0])--><!--            i.fas.fa-chevron-down--><!--          ul.menus_item_child--><!--            each val,lab in value--><!--              - const valArray = val.split('||')--><!--              li--><!--                a.site-page.child(href=url_for(trim(valArray[0])))--><!--                  if valArray[1]--><!--                    i.fa-fw(class=trim(valArray[1]))--><!--                  span=' '+ lab--><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-shouye"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shouye"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-shijianzhou"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shijianzhou"></use></svg><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shu"></use></svg><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-biaoqian"></use></svg><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:randomPost();" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-suiji"></use></svg><span> 随机文章</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/MessageBoard/"><i class="fa-fw icon-liuyanzhi"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liuyanzhi"></use></svg><span> 给我留言</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-yu"></use></svg><span> 摸鱼</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.4399.com/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-youxi"></use></svg><span> 4399</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.bilibili.com/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili"></use></svg><span> B站</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener external nofollow noreferrer" href="https://y.qq.com/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-mianxingerji"></use></svg><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/camera/"><i class="fa-fw icon-tupian1"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg><span> 图床</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/charts/"><i class="fa-fw icon-tongjifenxi"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tongjifenxi"></use></svg><span> 统计</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-pengyoufill"></use></svg><span> 友情链接</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guanyuwo"></use></svg><span> 关于我</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/68.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="RyCanの学习手记"></a></span><div id="he-plugin-simple"></div><div id="none_space"><span class="site-name">RyCanの学习手记</span></div><div id="menus"><div id="search-button"><!--a.site-page.social-icon.search(href="javascript:void(0);")--><!--  i.fas.fa-search.fa-fw--><a class="search faa-parent animated-hover" title="检索站内任何你想要的信息"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg><span> 搜索</span></a></div><!--if theme.menu--><!--  .menus_items--><!--    each value, label in theme.menu--><!--      if typeof value !== 'object'--><!--        .menus_item--><!--          - const valueArray = value.split('||')--><!--          a.site-page(href=url_for(trim(valueArray[0])))--><!--            if valueArray[1]--><!--              i.fa-fw(class=trim(valueArray[1]))--><!--            span=' '+label--><!--      else--><!--        .menus_item--><!--          - const labelArray = label.split('||')--><!--          - const hideClass = labelArray[2] && trim(labelArray[2]) === 'hide' ? 'hide' : ''--><!--          a.site-page.group(class=`${hideClass}` href='javascript:void(0);')--><!--            if labelArray[1]--><!--              i.fa-fw(class=trim(labelArray[1]))--><!--            span=' '+ trim(labelArray[0])--><!--            i.fas.fa-chevron-down--><!--          ul.menus_item_child--><!--            each val,lab in value--><!--              - const valArray = val.split('||')--><!--              li--><!--                a.site-page.child(href=url_for(trim(valArray[0])))--><!--                  if valArray[1]--><!--                    i.fa-fw(class=trim(valArray[1]))--><!--                  span=' '+ lab--><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-shouye"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shouye"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-shijianzhou"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shijianzhou"></use></svg><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shu"></use></svg><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-biaoqian"></use></svg><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:randomPost();" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-suiji"></use></svg><span> 随机文章</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/MessageBoard/"><i class="fa-fw icon-liuyanzhi"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liuyanzhi"></use></svg><span> 给我留言</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-yu"></use></svg><span> 摸鱼</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.4399.com/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-youxi"></use></svg><span> 4399</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.bilibili.com/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili"></use></svg><span> B站</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener external nofollow noreferrer" href="https://y.qq.com/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-mianxingerji"></use></svg><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/camera/"><i class="fa-fw icon-tupian1"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg><span> 图床</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/charts/"><i class="fa-fw icon-tongjifenxi"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tongjifenxi"></use></svg><span> 统计</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);" rel="external nofollow noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> 链接</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-pengyoufill"></use></svg><span> 友情链接</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guanyuwo"></use></svg><span> 关于我</span></a></li></ul></div></div><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="浅色和深色模式转换" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div><!--#randomPost--><!--  a.site-page.social-icon.search(href="javascript:;" onclick="randomPost()" title="随机访问一篇文章")--><!--    i.fas.fa-circle-notch.fa-fw--></nav><div id="post-info"><h1 class="post-title">SpringCloud</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-03T12:32:03.000Z" title="发表于 2023-07-03 20:32:03">2023-07-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-07-04T12:38:10.347Z" title="更新于 2023-07-04 20:38:10">2023-07-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.9w</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>341分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SpringCloud"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div><!----><!--span.post-qrcode--><!--  span.post-meta__separator |--><!--  i.fa.fa-qrcode.post-meta__icon.fa-fw(aria-hidden="true")--><!--  a(href="javasvript:;" onmouseover='document.getElementById("post-qrcode").style.display="block"' onmouseout='document.getElementById("post-qrcode").style.display="none"')='二维码'--><!--  div#post-qrcode.post-qrcode-img--><!--    img#post-img(src=qrcode(page.permalink))--></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><div class="top-img gist" style="background-image: url(/img/68.jpg)"></div><article class="post-content" id="article-container"><meta name="referrer" content="no-referrer">
<h1>SpringCloud简介</h1>
<p>参考文件：</p>
<p>[<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/mrlinxi/pxvr4g/lai8zw#yVHrM">https://www.yuque.com/mrlinxi/pxvr4g/lai8zw#yVHrM</a>][]</p>
<p>[<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/tmfl/spring/ohab1p">https://www.yuque.com/tmfl/spring/ohab1p</a>][]</p>
<p>[官网中文文档][<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.springcloud.cc/">https://www.springcloud.cc/</a>]</p>
<p>SpringCloud是分布式微服务交互的一站式解决方案，是多种微服务交媾落地技术的集合体，俗称微服务全家桶</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304281658642.png" alt="image-20230428165822617" style="zoom:33%;">
<p><strong>各模块常用的技术支撑：</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304281658269.png" alt="image-20230428165833250" style="zoom:33%;">
<h2 id="1、简单回顾">1、简单回顾</h2>
<h3 id="Maven中的DependencyManagement和Dependencies">Maven中的DependencyManagement和Dependencies</h3>
<h6 id="dependencyManagement">dependencyManagement</h6>
<p><strong>Maven 使用dependencyManagement 元素来提供了一种管理依赖版本号的方式。</strong></p>
<p>通常会在一个组织或者项目的最顶层的<code>父POM</code> 中看dependencyManagement 元素。</p>
<p>使用pom.xml 中的dependencyManagement 元素能    <code>让所有在子项目中引用一个依赖而不用显式的列出版本号</code></p>
<p>Maven 会沿着父子层次向上走，直到找到一个拥有dependencyManagement 元素的项目，然后它就会使用这个  dependencyManagement 元素中指定的版本号。</p>
<ul>
<li>
<p>好处就是：</p>
<ul>
<li>
<p>如果有多个子项目都引用同一样依赖，则可以避免在每个使用的子项目里都声明一个版本号，</p>
<p>这样当想升级或切换到另一个版本时，只需要在顶层父容器里更新，而不需要一个一个子项目的修改 ；</p>
<p>另外如果某个子项目需要另外的一个版本，只需要声明version 即可</p>
</li>
<li>
<p>dependencyManagement里只是声明依赖，<strong>并不实现引入</strong>，因此子项目需要显示的声明需要用的依赖。</p>
</li>
<li>
<p>如果不在子项目中声明依赖，是不会从父项目中继承下来的；只有在子项目中写了该依赖项，并且没有指定具体版本，才会从父项目中继承该项，并且version和scope都读取自父pom;</p>
</li>
<li>
<p>如果子项目中指定了版本号，那么会使用子项目中指定的jar版本。</p>
</li>
</ul>
</li>
</ul>
<h2 id="2、准备阶段">2、准备阶段</h2>
<h3 id="模块一：生产者-privoder-8001-（总结-zyteacher-视频-8-10）">模块一：生产者[privoder - 8001]（总结   zyteacher 视频  8-10）</h3>
<blockquote>
<h5 id="子模块的创建过程：">子模块的创建过程：</h5>
<h6 id="1、创建子模块（Maven项目）">1、创建子模块（Maven项目）</h6>
<h6 id="2、修改POM类">2、修改POM类</h6>
<h6 id="3、写yaml配置文件">3、写yaml配置文件</h6>
<h6 id="4、写启动类">4、写启动类</h6>
<h6 id="5、编写业务类（CRUD）">5、编写业务类（CRUD）</h6>
<h6 id="6、运行程序postman测试">6、运行程序<code>postman</code>测试</h6>
</blockquote>
<h4 id="父工程-Maven">父工程(Maven)</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 统一管理jar包版本 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.16.18<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.28<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mybatis.spring.boot.version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">mybatis.spring.boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 子模块继承之后，提供作用：锁定版本+子modlue不用写groupId和version  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--spring boot 2.2.2--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--spring cloud Hoxton.SR1--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--spring cloud alibaba 2.1.0.RELEASE--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis.spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="子工程（cloud-provider-payment8001）">子工程（cloud-provider-payment8001）</h4>
<h5 id="改pom">改pom</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud2020<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.SpringCloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.springCloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-provider-payment8001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--包含了sleuth+zipkin--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-commen-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mysql-connector-java--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--jdbc--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="yml">yml</h5>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="comment">#采样率值介于 0 到 1 之间，1 则表示全部采集</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span>            <span class="comment"># 当前数据源操作类型</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/springCloud?serverTimezone=GMT%2B8&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&#x27;00000000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapperLocations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.ry.sc.entities#</span> <span class="string">所有Entity别名类所在包</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 是否从Eureka Server抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 表示是否将自己注册进Eureka Server，默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment"># 入住地址</span></span><br><span class="line">      <span class="comment">#单机</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line">      <span class="comment"># 集群</span></span><br><span class="line">      <span class="comment">#defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka  # 集群版</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span>  <span class="comment"># 自定义名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#鼠标移动到服务列表的主机上之后，左下角不显示IP，不方便定位具体的主机ip。可以修改eureka.instance.prefer-ip-address，设置为true。</span></span><br><span class="line">    <span class="comment">#Eureka客户端向服务端发送心跳的时间间隔，单位为秒(默认是30秒)</span></span><br><span class="line">    <span class="comment">#lease-renewal-interval-in-seconds: 1</span></span><br><span class="line">    <span class="comment">#Eureka服务端在收到最后一次心跳后等待时间上限，单位为秒(默认是90秒)，超时将剔除服务</span></span><br><span class="line">    <span class="comment">#lease-expiration-duration-in-seconds: 2</span></span><br></pre></td></tr></table></figure>
<h5 id="主启动">主启动</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">payMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(payMain.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="业务类书写">业务类书写</h5>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121401761.png" style="zoom: 50%;">
<h6 id="1、建表SQL">1、建表SQL</h6>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `payment` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">  `serial` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br></pre></td></tr></table></figure>
<h6 id="2、实体类">2、实体类</h6>
<p>​	2.1、数据库实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.entities;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Payment</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String serial;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​	2.2、JSON的封装实体类(和前端进行传递的数据交互以简单的JSON 进行交互)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.entities;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommontResult</span> &lt;T&gt;&#123;</span><br><span class="line">    <span class="keyword">private</span>  Integer code;</span><br><span class="line">    <span class="keyword">private</span>  String message;</span><br><span class="line">    <span class="keyword">private</span>  T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommontResult</span><span class="params">(Integer code, String message)</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>(code,message,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="3、dao层">3、dao层</h6>
<ul>
<li>3.1、接口<code>PaymentDao</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span> <span class="comment">//推荐使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">create</span><span class="params">(Payment payment)</span>;</span><br><span class="line">    <span class="keyword">public</span> Payment <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>3.2、<code>mybaits的映射文件PaymentMapper.xml</code></p>
<ul>
<li>
<p>3.2.1 路径   <code>src\main\resources\mapper\PaymentMapper.xml</code></p>
</li>
<li>
<p>3.2.2  <code>PaymentMapper.xml</code></p>
</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.ry.sc.dao.PaymentDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;create&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.ry.sc.entities.Payment&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        insert into payment(serial) values(#&#123;serial&#125;);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--最好 使用  resultMap --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span>  <span class="attr">type</span>=<span class="string">&quot;com.ry.sc.entities.Payment&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;serial&quot;</span> <span class="attr">property</span>=<span class="string">&quot;serial&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getPaymentById&quot;</span>  <span class="attr">parameterType</span>=<span class="string">&quot;Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">        select * from payment where id = #&#123;id&#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="4、Service层">4、Service层</h6>
<p>​	4.1、接口 <code>PaymentService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">create</span><span class="params">(Payment payment)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Payment <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​	4.2、实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.service.Impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ry.sc.dao.PaymentDao;</span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> com.ry.sc.service.PaymentService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentDao paymentDao;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">create</span><span class="params">(Payment payment)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentDao.create(payment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Payment <span class="title function_">getPaymentById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>  paymentDao.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="5、Controller层">5、Controller层</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.CommontResult;</span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> com.ry.sc.service.PaymentService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span>     <span class="comment">//注解 注入容器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value =&quot;/payment/create&quot;)</span></span><br><span class="line">    <span class="comment">//url的请求方式   http://localhost:80/consumer/payment/create?serial=yr123  </span></span><br><span class="line">    <span class="keyword">public</span> CommontResult <span class="title function_">create</span><span class="params">(<span class="meta">@RequestBody</span>  Payment payment)</span>&#123;   <span class="comment">//@RequestBody 没有的话会添加的时候没有数据（serial）</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.create(payment);</span><br><span class="line">        log.info(<span class="string">&quot;插入结果：&quot;</span>+result);</span><br><span class="line">        <span class="keyword">if</span>(result &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommontResult</span>(<span class="number">200</span> ,<span class="string">&quot;Success&quot;</span>,result);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommontResult</span>(<span class="number">400</span> ,<span class="string">&quot;failed&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value =&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommontResult <span class="title function_">getParamentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">        <span class="type">Payment</span> <span class="variable">paymentById</span> <span class="operator">=</span> paymentService.getPaymentById(id);</span><br><span class="line">        log.info(<span class="string">&quot;插入结果：&quot;</span>+paymentById);</span><br><span class="line">        <span class="keyword">if</span>(paymentById != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommontResult</span>(<span class="number">200</span> ,<span class="string">&quot;Success&quot;</span>,paymentById);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommontResult</span>(<span class="number">400</span> ,<span class="string">&quot;failed&quot;</span>+id,<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="自动热部署（我就不加了-11-）">自动热部署（我就不加了 11 ）</h3>
<h6 id="1、Adding-devtools-to-your-project">1、Adding devtools to your project</h6>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>你自己的工程名字<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span> //加不加无所谓</span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304282109078.png" alt="image-20230428210929055" style="zoom:50%;">
<h6 id="2、Adding-plugin-to-your-pom-xml">2、Adding plugin to your pom.xml</h6>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304282110314.png" alt="image-20230428211028291" style="zoom:33%;">
<h6 id="3、Enabling-automatic-build">3、Enabling automatic build</h6>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304282111765.png" alt="image-20230428211118726" style="zoom:33%;">
<h6 id="4、Update-the-value-of">4、Update the value of</h6>
<p>按两下shift，搜索registry，勾选如下两项</p>
<p>在8001的pom文件中    optional+ alt + ctrl + /</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304282113149.png" alt="image-20230428211329124" style="zoom:50%;">
<h6 id="5、重启IDEA">5、重启IDEA</h6>
<h3 id="模块二：-消费者-cloud-consumer-order80-（12-13-）">模块二： 消费者[cloud-consumer-order80]（12-13 ）</h3>
<p>还是和模块一的整体步骤一样，只是业务实现有区别</p>
<p>因为客户端跟服务端是两个不同的模块，所以我们需要通过<code>http</code>访问支付模块。</p>
<p>Spring框架会提供  <code>restTemplete</code>：</p>
<ul>
<li>
<p>RestTemplate提供了多种便捷访问远程Http服务的方法， 是一种简单便捷的访问restful服务模板类，是Spring提供的用于访问Rest服务的客户端模板工具集[<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.spring.io/spring-framework/docs/5.2.2.RELEASE/javadocapi/org/springframework/web/client/RestTemplate.html">https://docs.spring.io/spring-framework/docs/5.2.2.RELEASE/javadocapi/org/springframework/web/client/RestTemplate.html</a>][]</p>
</li>
<li>
<p>使用的时候 先  将  配置类注入容器，然后直接使用注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">//@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="代码">代码</h4>
<p>1、config</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">//@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.CommontResult;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYMENT_URL</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8001&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/create&quot;)</span>    <span class="comment">// get 嵌套 post</span></span><br><span class="line">    <span class="comment">//url的请求方式   http://localhost:80/consumer/payment/create?serial=yr123</span></span><br><span class="line">    <span class="keyword">public</span> CommontResult&lt;Payment&gt; <span class="title function_">create</span><span class="params">(Payment payment)</span> &#123;</span><br><span class="line">        <span class="comment">// post请求</span></span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(PAYMENT_URL +<span class="string">&quot;/payment/create&quot;</span>,payment,CommontResult.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommontResult&lt;Payment&gt; <span class="title function_">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// Get请求</span></span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(PAYMENT_URL+<span class="string">&quot;/payment/get/&quot;</span>+id,CommontResult.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3、entities 同上</p>
<p>4、pom文件<code>不要</code>有mybatis mysql druid 的依赖，因为此模块的配置文件不加  datasource的配置，所以加这些依赖的话会有 <code>错误</code></p>
<p>5、扩展：对<code>runDashboard</code>的配置[可选]</p>
<h2 id="3、服务注册与发现">3、服务注册与发现</h2>
<h3 id="1、Eureka">1、Eureka</h3>
<h4 id="服务治理与注册">服务治理与注册</h4>
<h5 id="服务治理">服务治理</h5>
<p>Spring Cloud 封装了 Netflix 公司开发的 Eureka 模块来实现服务治理；</p>
<p>在传统的rpc远程调用框架中，管理每个服务与服务之间依赖关系比较复杂，管理比较复杂，所以需要使用服务治理，管理服务与服务之间依赖关系，可以实现服务调用、负载均衡、容错等，实现服务发现与注册。</p>
<blockquote>
<p>n个生产者与那个消费者之间相互调用</p>
</blockquote>
<h5 id="服务注册">服务注册</h5>
<p>Erureka采用了CS的设计架构，Eureka Server作为服务注册功能的服务器，它是服务注册中心。</p>
<p>而系统中的其他微服务使用<code>Eureka的客户端</code>连接到<code>Eureka Server</code>并维持心跳连接。</p>
<p>这样系统的维护人员就可以通过<code>Eureka Server</code>来监控系统中各个微服务是否正常运行。</p>
<p>在服务注册与发现中，有一个注册中心。</p>
<p>当服务器启动的时候，会把当前自己服务器的信息（比如服务地址、通讯地址等）以别名方式注册到注册中心上。</p>
<p>另一方（消费者、服务提供者）以该别名的方式去注册中心上获取到实际的服务通讯地址，然后再实现本地RPC调用。</p>
<h5 id="RPC远程调用框架">RPC远程调用框架</h5>
<p>核心设计思想在于   注册中心</p>
<p>使用注册中心管理每个服务与服务之间的一个依赖关系（服务治理概念）。</p>
<p>在任何RPC远程框架中，都会有一个注册中心存放服务地址相关信息（接口地址）。</p>
<h5 id="Eureka">Eureka</h5>
<p>Eureka包含两个组件：Eureka Server 和 Eureka Client</p>
<h6 id="Eureka-Server：">Eureka Server：</h6>
<p>提供服务注册服务**[启动之后注册]**</p>
<p>各个微服务节点通过配置<code>启动后</code>，会在Eureka Server中<code>进行注册</code>，这样Eureka Server中的服务注册表中将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观看到。</p>
<h6 id="Eureka-Client：">Eureka Client：</h6>
<p>通过注册中心进行访问**[监控发现有无停机的情况]**</p>
<p>是一个Java客户端，用于简化Eureka Server的交互，客户端同时也具备一个内置的、使用轮询（round-robin）负载算法的负载均衡器。在应用启动后，将会向Eureka Server发送心跳（默认周期30秒）。</p>
<p>如果Eureka Server在多个心跳周期内没有接收到某个节点的心跳，Eureka Server将会从服务注册中心中把这个服务节点移除（默认90秒）。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121420401.png" alt="image-20230512142013314" style="zoom:53%;">
<h4 id="单机Eureka构建步骤">单机Eureka构建步骤</h4>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121425704.png" alt="image-20230512142558617" style="zoom:33%;">
<h5 id="五步走：">五步走：</h5>
<p>建module</p>
<blockquote>
<p><code>/Users/yangrui/Z_IdeaProjects/springCloud2020/cloud-eureka-server7001</code></p>
</blockquote>
<p>改pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud2020<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.SpringCloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-eureka-server7001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka-server--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-commen-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--boot web actuator--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--一般通用配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>     <span class="comment">#false表示不向注册中心注册自己。</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>     <span class="comment">#false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#集群指向其它eureka</span></span><br><span class="line">      <span class="comment">#defaultZone: http://eureka7002.com:7002/eureka/</span></span><br><span class="line">      <span class="comment">#单机就是7001自己</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br><span class="line">  <span class="comment">#server:</span></span><br><span class="line">    <span class="comment">#关闭自我保护机制，保证不可用服务被及时踢除</span></span><br><span class="line">    <span class="comment">#enable-self-preservation: false</span></span><br><span class="line">    <span class="comment">#eviction-interval-timer-in-ms: 2000</span></span><br></pre></td></tr></table></figure>
<p>主启动</p>
<blockquote>
<p>注意事项：增加@EnableEurekaServer注解，指定该模块作为Eureka注册中心的服务器。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaMain7001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaMain7001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写业务</p>
<blockquote>
<p>Eureka Server 不需要写Service类</p>
</blockquote>
<p>浏览器访问 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:7001">http://localhost:7001</a></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121431531.png" alt="image-20230512143115442" style="zoom:33%;">
<h5 id="随后修改：">随后修改：</h5>
<h6 id="生产者微服务8001注册进EurekaServer">生产者微服务8001注册进EurekaServer</h6>
<p>下面的操作是对<code>/Users/yangrui/Z_IdeaProjects/springCloud2020/cloud-provider-payment8001</code>进行的</p>
<p>改pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>改yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 表示将自己注册进EurekaServer默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 表示可以从Eureka抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span> </span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">payMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(payMain.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121435261.png" alt="image-20230512143525173" style="zoom:33%;">
<h6 id="消费者微服务80注册进EurekaServer">消费者微服务80注册进EurekaServer</h6>
<p>改pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        包含了sleuth+zipkin--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-commen-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-commen-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;/dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;version&gt;1.1.10&lt;/version&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;/dependency&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mysql-connector-java--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;groupId&gt;mysql&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;/dependency&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--jdbc--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;/dependency&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>改yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 微服务名称</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 是否从Eureka Server抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 表示是否将自己注册进Eureka Server，默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment"># 入住地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>
<p>修改主启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ry.MyIRule.MySelfRule;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.ribbon.RibbonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121438069.png" style="zoom:33%;">
<p>如果不想将服务注册进eureka</p>
<blockquote>
<p>在yml文件中，设置 <code>register-with-eureka: false</code></p>
</blockquote>
<h4 id="Eureka集群原理说明">Eureka集群原理说明</h4>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304282356646.png" alt="image-20230428235658605" style="zoom:50%;">
<p><strong>问题：微服务RPC远程服务调用最核心的是什么？</strong></p>
<p>高可用，试想你的注册中心只有一个only one， 一旦它出故障了，会导致整个为服务环境不可用。</p>
<p>解决办法：搭建Eureka注册中心集群 ，实现<strong>负载均衡+故障容错</strong></p>
<p>所以  没有集群的高可用，就会带来一个严重的问题，单点故障      此时就需要进行搭建集群</p>
<h5 id="Eureka集群原理：互相注册，相互守望">Eureka集群原理：互相注册，相互守望</h5>
<h5 id="EurekaServer集群环境构建">EurekaServer集群环境构建</h5>
<h6 id="新建一个cloud-eureka-server7002模块">新建一个cloud-eureka-server7002模块</h6>
<p>pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud2020<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.SpringCloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-eureka-server7002<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka-server--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-commen-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--boot web actuator--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--一般通用配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>修改两个EurekaServer的yml配置</p>
<p>7001</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>     <span class="comment">#false表示不向注册中心注册自己。</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>     <span class="comment">#false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#集群指向其它eureka</span></span><br><span class="line">      <span class="comment">#defaultZone: http://eureka7002.com:7002/eureka/</span></span><br><span class="line">      <span class="comment">#单机就是7001自己</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br><span class="line">  <span class="comment">#server:</span></span><br><span class="line">    <span class="comment">#关闭自我保护机制，保证不可用服务被及时踢除</span></span><br><span class="line">    <span class="comment">#enable-self-preservation: false</span></span><br><span class="line">    <span class="comment">#eviction-interval-timer-in-ms: 2000</span></span><br></pre></td></tr></table></figure>
<p>7002</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7002</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7002.com</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>     <span class="comment">#false表示不向注册中心注册自己。</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>     <span class="comment">#false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#集群指向其它eureka</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br><span class="line">      <span class="comment">#单机就是自己</span></span><br><span class="line">      <span class="comment">#defaultZone: http://eureka7002.com:7002/eureka/</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>修改域名映射配置文件 [现有存在多台eureka服务器，因此每一台eureka服务器需要有自己的主机名，同时各服务器需要相互注册]</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121444618.png" alt></p>
<p>配置之后我们可以直接通过<strong><a target="_blank" rel="noopener external nofollow noreferrer" href="http://eureka7001.com:7001">http://eureka7001.com:7001</a></strong>和<strong><a target="_blank" rel="noopener external nofollow noreferrer" href="http://eureka7002.com:7002">http://eureka7002.com:7002</a></strong>来访问这两个Eureka Server</p>
<p>将提供者服务8001微服务和消费者服务80微服务发布到上面的2台Eureka集群配置中</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">service-url:</span> <span class="comment"># 入住地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span> <span class="comment">#集群版</span></span><br></pre></td></tr></table></figure>
<p>效果演示：</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304290858291.png" alt="image-20230429085843255" style="zoom:25%;">
<h6 id="生产者-cloud-provider-payment8002-微服务集群构建">生产者(cloud-provider-payment8002)微服务集群构建</h6>
<blockquote>
<p>一个提供者微服务不可能应对所有的消费者微服务</p>
</blockquote>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121448154.png" alt="image-20230512144834058" style="zoom:33%;">
<p>新建cloud-provider-payment8002 微服务模块</p>
<p>pom与cloud-provider-payment8001一致</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud2020<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.SpringCloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-provider-payment8002<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ry.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-commen-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mysql-connector-java--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--jdbc--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>写yml   与8001一致，将port改为8002</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span>            <span class="comment"># 当前数据源操作类型</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/springCloud?serverTimezone=GMT%2B8&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&#x27;00000000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapperLocations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.ry.sc.entities#</span> <span class="string">所有Entity别名类所在包</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 是否从Eureka Server抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 表示是否将自己注册进Eureka Server，默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment"># 入住地址</span></span><br><span class="line">      <span class="comment">#单机</span></span><br><span class="line">      <span class="comment">#defaultZone: http://localhost:7001/eureka</span></span><br><span class="line">      <span class="comment"># 集群</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span>  <span class="comment"># 集群版</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8002</span>  <span class="comment"># 自定义名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#鼠标移动到服务列表的主机上之后，左下角不显示IP，不方便定位具体的主机ip。可以修改eureka.instance.prefer-ip-address，设置为true。</span></span><br></pre></td></tr></table></figure>
<p>主启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">payMain8002</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(payMain8002.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>业务同<code> 8001</code></p>
<blockquote>
<p>注意：</p>
<p>两个provider微服务在注册中心中的注册名是一样的，这两个微服务对外暴露的都是同一个名字，即yml文件中spring.application.name均为</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">application:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br></pre></td></tr></table></figure>
<p>消费者微服务调用的是cloud-payment-service这个服务，但是在这个名字下面可能有多台机器。</p>
<p>那么如何确定消费者微服务调用哪台机器上的cloud-payment-service服务呢？</p>
<ul>
<li>通过端口号来区分，我们有两个provider微服务，端口号分别为8001、8002</li>
</ul>
</blockquote>
<p>修改两个生产者微服务的controller方法，改法一致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入数据到数据库</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/payment/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">create</span><span class="params">(<span class="meta">@RequestBody</span> Payment payment)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.create(payment);</span><br><span class="line">        log.info(<span class="string">&quot;***********插入结果：&quot;</span> + result);</span><br><span class="line">        <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;插入数据库成功,serverPort:&quot;</span> + serverPort, result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">444</span>, <span class="string">&quot;插入数据库失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询数据库中指定id的记录</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> paymentService.getPaymentById(id);</span><br><span class="line">        log.info(<span class="string">&quot;***********查询结果：&quot;</span> + payment);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (payment != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;查询成功,serverPort:&quot;</span> + serverPort, payment);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">404</span>, <span class="string">&quot;查询id失败:&quot;</span> + id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<ul>
<li>启动EurekaServer</li>
</ul>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304290858059.png" alt="image-20230429085805013" style="zoom:25%;">
<ul>
<li><code>消费者(80)</code>微服务</li>
</ul>
<blockquote>
<p>1、若干次不同请求，走的都是provider8001。这是因为我们在消费者为服务中将地址写死了</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121459663.png" alt="image-20230512145958556" style="zoom:33%;">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//单机形式</span></span><br><span class="line"><span class="comment">//public static final String PAYMENT_URL = &quot;http://localhost:8001&quot;;</span></span><br></pre></td></tr></table></figure>
<p>所以在访问消费者微服务后，消费者微服务再去调用生产者中的方法。 调用发送的请求一直都是<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/">http://localhost:8001/</a>… 所以一直调用了8001端口的微服务。</p>
<p>那么现在我们不指明具体的微服务端口，指定一个这两个生产者微服务共有的指向： 即微服务名：CLOUD-PAYMENT-SERVICE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//集群模式</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYMENT_URL</span> <span class="operator">=</span> <span class="string">&quot;http://CLOUD-PAYMENT-SERVICE&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>那么消费者再去调用生产者中的方法时，就没有指定具体的端口（具体的微服务）。那么哪一个微服务被调用由其他方式来决定。</p>
<p>注意这个说法：</p>
<p>这个程序的使用者会知道这些微服务的端口或者地址吗？</p>
<ul>
<li>
<p>消费者使用时，他们根本不想知道具体哪个微服务对应哪个端口或者具体的地址。他只关心微服务的名称。</p>
<p>他们只想通过看到的微服务名，来使用这些微服务。</p>
<p>也就是说，我们对外暴露的只能是微服务名，来供使用者使用</p>
</li>
</ul>
<p>2、再次测试</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121503877.png" alt="image-20230512150332767" style="zoom:33%;">
<p>原因： 这个微服务下面对应着多个微服务，这个微服务名下的多个微服务到底是哪个出来响应，没有办法识别。</p>
<p>解决：</p>
<p>​	使用<code>@LoadBlanced</code>注解赋予RestTemplate<code>负载均衡</code>的能力</p>
<p>以前我们把生产者微服务写死，没关系，因为只有一个生产者微服务，只认一个。</p>
<p>但是现在不能写死了，因为这个微服务名下对应有多个微服务，那么调用时，必须得说明哪一个被调用了。</p>
<p>需要规定一种默认的负载均衡机制：<strong>@LoadBlanced</strong></p>
<p>在<code>Order80</code>端的配置类上加入**@LoadBlanced**注解开启负载均衡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span>  <span class="comment">//负载均衡</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121504130.png" alt></p>
</blockquote>
<h6 id="Actuator-的信息完善配置：">Actuator:的信息完善配置：</h6>
<p>主机名称：服务名称的规范和修改</p>
<p>按照规范的要求只暴露服务名，不带有主机名。</p>
<p>修改生产者微服务的yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8002</span>  <span class="comment"># 自定义名称</span></span><br><span class="line">        <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> </span><br><span class="line">        <span class="comment">#鼠标移动到服务列表的主机上之后，左下角不显示IP，不方便定位具体的主机ip。可以修改eureka.instance.prefer-ip-address，设置为true。</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span>  <span class="comment"># 自定义名称</span></span><br><span class="line">        <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> </span><br><span class="line">        <span class="comment">#鼠标移动到服务列表的主机上之后，左下角不显示IP，不方便定位具体的主机ip。可以修改eureka.instance.prefer-ip-address，设置为true。</span></span><br></pre></td></tr></table></figure>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304290913045.png" alt="image-20230429091349999" style="zoom:23%;">
<h4 id="服务发现Discovery">服务发现Discovery</h4>
<p><strong>服务发现</strong>：对于注册进eureka里面的微服务，可以通过服务发现来获得该服务的信息</p>
<p><strong>@EnableDiscoveryClient</strong>注解</p>
<p>当微服务要对外提供一种功能的时候。那么我们就需要拿到在eureka上注册了的微服务的信息，例如：主机名称、端口号。</p>
<p><strong>修改cloud-provider-payment8001的controller：写好提供给外部的信息</strong>(<strong>注意写在80和8002中也都可以获得所有的微服务信息，这里只是在8001上进行测试。</strong>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span>   <span class="comment">//发现自己的服务信息</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务发现</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/payment/discovery&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">discovery</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//得到全部服务清单</span></span><br><span class="line">    List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">    <span class="keyword">for</span> (String service : services) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;*********element:&quot;</span> + service);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取微服务实例</span></span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;</span><br><span class="line">        log.info(instance.getServiceId() + <span class="string">&quot;\t&quot;</span> + instance.getHost() + <span class="string">&quot;\t&quot;</span></span><br><span class="line">                 + instance.getPort() + <span class="string">&quot;\t&quot;</span> + instance.getUri());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> discoveryClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在8001的主启动类中开启注解</strong>：<strong>@EnableDiscoveryClient</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">payMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(payMain.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试，访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/payment/discovery">http://localhost:8001/payment/discovery</a></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121512189.png" alt="image-20230512151203890" style="zoom:33%;">
<h4 id="eureka自我保护">eureka自我保护</h4>
<h5 id="自我保护">###自我保护</h5>
<p>概述： 保护模式主要用于   一组客户端和EurekaServer  之间   存在   网络分区场景下的保护。</p>
<p>一旦进入保护模式，EurekaServer将会尝试保护其服务注册表中的信息，<code>不再删除</code>服务注册表中的数据，也就是<code>不会注销任何微服务</code>。</p>
<p>如果在EurekaServer的首页看到以下这段提示，则说明Eureka进入了保护模式：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121515107.png" alt></p>
<blockquote>
<p>一句话：某时刻某一个微服务不可用了，Eureka不会立刻清理，依旧会对该微服务的信息进行保存。</p>
</blockquote>
<ul>
<li>属于CAP里面的AP分支。</li>
</ul>
<p>​			Eureka它的设计思想： 分布式CAP里面的AP分支，某时刻某一个微服务不可用了，Eureka不会立刻清理， 依旧会对该微服务的信息进行保存。</p>
<ul>
<li>为什么会产生Eureka自我保护机制？</li>
</ul>
<p>​			因为可能存在这样的情况： EurekaClient可以正常运行，但是与EurekaServer网络不通。 此时EurekaServer不会立刻将EurekaClient服务剔除。</p>
<ul>
<li>自我保护</li>
</ul>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121516293.png" alt="image-20230512151633192" style="zoom:53%;">
<blockquote>
<p>如果一定时间内丢失大量该微服务的实例，这时Eureka就会开启自我保护机制，不会剔除该服务。 因为这个现象可能是因为网络暂时不通，出现了Eureka的假死，拥堵，卡顿。 稍等会客户端还能正常发送心跳。 这就是CAP里面的AP分支思想。</p>
</blockquote>
<ul>
<li>设计哲学</li>
</ul>
<p>​			宁可保留错误的服务注册信息，也不盲目注销任何可能健康的服务实例</p>
<h4 id="CAP">CAP</h4>
<ul>
<li>Consistency（一致性）：
<ul>
<li>即更新操作成功并返回客户端后，所有节点在同一时间的数据完全一致。</li>
<li>对于客户端来说，一致性指的是并发访问时更新过的数据如何获取的问题。</li>
<li>从服务端来看，则是更新如何复制分布到整个系统，以保证数据最终一致。</li>
</ul>
</li>
<li>Avaliability（可用性）：
<ul>
<li>即服务一直可用，而且是正常响应时间。</li>
<li>系统能够很好的为用户服务，不出现用户操作失败或者访问超时等用户体验不好的情况。</li>
</ul>
</li>
<li>Partition Tolerance（分区容错性）：
<ul>
<li>即分布式系统在遇到某节点或网络故障的时候，仍然能够对外提供满足一致性和可用性的服务。</li>
<li>分区容错性要求应用虽然是一个分布式系统，但看上去切好像是在一个可以运转正常的整体。</li>
<li>比如现在的分布式系统中有某一个或者几个机器宕掉了，其他剩下的机器还能够正常运转满足系统要求，对于用户而言并没有什么体验上的影响。</li>
</ul>
</li>
<li>CP和AP：分区容错是必须保证的，当发生网络分区的时候，如果要继续服务，那么强一致性和可用性只能2选1</li>
</ul>
<h4 id="怎么禁止自我保护">怎么禁止自我保护</h4>
<p>修改7001的yml配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="comment">#关闭自我保护机制，保证不可用服务被及时踢除</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>
<p><strong>修改eurekaClient端8001</strong></p>
<p>它有两个默认的配置</p>
<blockquote>
<p># Eureka客户端向服务端发送心跳的时间间隔默认30秒</p>
<p>eureka.instance.lease-renewal-interval-in-seconds: 30 单位秒</p>
<p># Eureka服务端在收到最后一次心跳后，90s没有收到心跳，剔除服务</p>
<p>eureka.instance.lease-expiration-duration-in-seconds: 90 单位秒</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121521627.png" alt="image-20230512152108320" style="zoom:53%;">
</blockquote>
<h3 id="2、整合Zookeeper">2、整合Zookeeper</h3>
<ul>
<li>服务注册中心：zookeeper代替eureka</li>
<li>Consul服务注册与发现</li>
</ul>
<h4 id="注册中心Zookeeper">注册中心Zookeeper</h4>
<blockquote>
<p>zookeeper是一个分布式协调工具，可以实现注册中心功能</p>
</blockquote>
<h5 id="cloud-provider-payment8004微服务模块">cloud-provider-payment8004微服务模块</h5>
<p>新建cloud-provider-payment8004微服务模块</p>
<p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-provider-payment8004<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合zookeeper客户端 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#8004表示注册到zookeeper服务器的支付服务提供者端口号</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8004</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务别名----注册zookeeper到注册中心名称</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-payment</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="number">172.16</span><span class="number">.108</span><span class="number">.139</span><span class="string">:2181</span></span><br></pre></td></tr></table></figure>
<p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">//该注解用于向使用consul或者zookeeper作为注册中心时注册服务</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain8004</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentMain8004.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/payment/zk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentzk</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;springcloud with zookeeper: &quot;</span> + serverPort + <span class="string">&quot;\t&quot;</span> + UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<h4 id="可能遇到的问题：">可能遇到的问题：</h4>
<h5 id="解决jar包冲突">解决jar包冲突</h5>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121529564.png" alt="image-20230512152956459" style="zoom:33%;">
<p>如果安装的zookeeper版本高于3.5.3则不会出现冲突报错。我是3.5.7没有报错  报错解决方案：排除引入的3.5.3-beta，引入与安装的zookeeper对应的版本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="comment">&lt;!-- SpringBoot整合zookeeper客户端 --&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;<span class="comment">&lt;!--先排除自带的zookeeper3.5.3--&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="comment">&lt;!--添加zookeeper3.5.7版本--&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="SLF4J多次绑定">SLF4J多次绑定</h5>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121530998.png" alt="image-20230512153046878" style="zoom:33%;">
<p>所以排除掉zookeeper中的slf4j</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121531006.png" alt="image-20230512153114904" style="zoom:33%;">
<p>再次启动成功</p>
</blockquote>
<p>测试controller</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121532105.png" alt="image-20230512153252002" style="zoom:33%;">
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291137830.png" alt></p>
<blockquote>
<p>==注册到zookeeper的微服务是一个zNode节点，这个节点是临时节点还是持久节点？==</p>
<p>我们在注册的时候会生成一个流水号id，我们将服务断开，发现刚断开时zookeeper还保存着该服务，等待一段时间后，该节点被删除。</p>
<p>所以是<code>临时节点</code>。重新启动8004的微服务，可以看到生成了一个新的流水号id==</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121532711.png" alt></p>
<p>==如果先前配置了zookeeper的集群，请确保一半以上的服务器处于开启状态，否则zookeeper服务无法使用==</p>
</blockquote>
<h5 id="服务消费者cloud-consumerzk-order80">服务消费者cloud-consumerzk-order80</h5>
<p>新建cloud-consumerzk-order80</p>
<p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-consumer-order80<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-consumer-order</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment">#注册到zookeeper地址</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="number">172.16</span><span class="number">.108</span><span class="number">.129</span><span class="string">:2181</span></span><br></pre></td></tr></table></figure>
<p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderZKMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderZKMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span> <span class="comment">//使用@LoadBalanced注解赋予RestTemplate负载均衡的能力</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>业务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderZKController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INVOKE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://cloud-provider-payment&quot;</span>;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/zk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(INVOKE_URL + <span class="string">&quot;/payment/zk&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121540224.png" alt="image-20230512154053117" style="zoom:43%;">
<h3 id="3、整合-Consul">3、整合 Consul</h3>
<h5 id="Consul简介">Consul简介</h5>
<p>1、是什么：微服务的服务注册中心    <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.consul.io/docs/intro">Consul官网</a></p>
<p>Consul是一套开源的分布式服务发现和配置管理系统，由HashiCorp公司采用Go语言开发</p>
<ul>
<li>
<p>提供了微服务系统中心的服务治理，配置中心，控制总线等功能。这些功能中的每一个都可以根据需要单独使用，也可以一起使用，以构建全方位的服务网格。</p>
</li>
<li>
<p>总之Consul提供了一种完整的服务网格解决方案。</p>
</li>
<li>
<p>它具有很多优点：</p>
</li>
<li>
<ul>
<li>包括，基于raft协议，比较简洁；支持健康检查，同时支持HTTP和DNS协议支持跨数据中心的WAN集群。</li>
</ul>
</li>
<li>
<p>提供图形界面 跨平台，支持Linux，MAC，Windows</p>
</li>
</ul>
<p>2、能干嘛：</p>
<ul>
<li>Service Discovery：<code>服务发现</code>，提供HTTP和DNS两种发现方式</li>
<li>Health Checking: <code>健康检查</code>，支持多种方式，HTTP，TCP，Docker，Shell脚本定制化</li>
<li>KV Store:   Key，Value的存储方式</li>
<li>Secure Service Communication: <code>安全的服务交流</code></li>
<li>Multi Datacenter:<code>多数据中心</code></li>
<li>可视化web界面</li>
</ul>
<p>[MacOS安装][<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/fuxingsheng1/article/details/123133724">https://blog.csdn.net/fuxingsheng1/article/details/123133724</a>]</p>
<p>[访问网址][<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8500/ui/dc1/services">http://localhost:8500/ui/dc1/services</a>]</p>
<h5 id="安装并运行Consul">安装并运行Consul</h5>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121547460.png" alt="image-20230512154726352" style="zoom:33%;">
<h5 id="生产者服务注册：consul-cloud-providerconsul-payment8006">生产者服务注册：consul(cloud-providerconsul-payment8006)</h5>
<p>新建Module支付服务：cloud-providerconsul-payment8006</p>
<p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-providerconsul-payment8006<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud consul-server --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###consul服务端口号</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8006</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-provider8006-payment</span></span><br><span class="line"><span class="comment">####consul注册中心地址</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#hostname: 127.0.0.1</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain8006</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentMain8006.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>业务类(controller)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/payment/consul&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentConsul</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;springcloud with consul: &quot;</span> + serverPort + <span class="string">&quot;\t&quot;</span> + UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291251795.png" alt="image-20230429125145748" style="zoom:25%;">
<h5 id="消费者服务注册cloud-consumerconsul-order80">消费者服务注册cloud-consumerconsul-order80</h5>
<p>新建cloud-consumerconsul-order80</p>
<p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-consumerconsul-order80<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud consul-server --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###consul服务端口号</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-consumer-order80</span></span><br><span class="line"><span class="comment">####consul注册中心地址</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#hostname: 127.0.0.1</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderConsulMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderConsulMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类 配置Bean  RestTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>业务类controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderConsulController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INVOKE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://cloud-provider-pament&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/consul&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.getForObject(INVOKE_URL, String.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者调用支付服务(consule)---&gt;result:&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121556743.png" alt></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291259151.png" alt="image-20230429125905110" style="zoom:25%;">
<h3 id="三个注册中心比较">三个注册中心比较</h3>
<table>
<thead>
<tr>
<th>组件</th>
<th>语言</th>
<th>CAP</th>
<th>服务健康检查</th>
<th>对外暴露接口</th>
<th>SpringCloud集成</th>
</tr>
</thead>
<tbody>
<tr>
<td>Eureka</td>
<td>Java</td>
<td>AP</td>
<td>可配支持</td>
<td>HTTP</td>
<td>已集成</td>
</tr>
<tr>
<td>Consul</td>
<td>Go</td>
<td>CP</td>
<td>支持</td>
<td>Http/DNS</td>
<td>已集成</td>
</tr>
<tr>
<td>ZooKeeper</td>
<td>Java</td>
<td>CP</td>
<td>支持</td>
<td>客户端</td>
<td>已集成</td>
</tr>
</tbody>
</table>
<h5 id="CAP理论">CAP理论</h5>
<ul>
<li>Consistency（一致性）：即更新操作成功并返回客户端后，所有节点在同一时间的数据完全一致。对于客户端来说，一致性指的是并发访问时更新过的数据如何获取的问题。从服务端来看，则是更新如何复制分布到整个系统，以保证数据最终一致。</li>
<li>Avaliability（可用性）：即服务一直可用，而且是正常响应时间。系统能够很好的为用户服务，不出现用户操作失败或者访问超时等用户体验不好的情况。</li>
<li>Partition Tolerance（分区容错性）：即分布式系统在遇到某节点或网络故障的时候，仍然能够对外提供满足一致性和可用性的服务。分区容错性要求应用虽然是一个分布式系统，但看上去切好像是在一个可以运转正常的整体。比如现在的分布式系统中有某一个或者几个机器宕掉了，其他剩下的机器还能够正常运转满足系统要求，对于用户而言并没有什么体验上的影响。</li>
<li>CP和AP：分布式中，**分区容错（P）<strong>是必须保证的，当发生网络分区的时候，如果要继续服务，那么</strong>强一致性（C）<strong>和</strong>可用性（A）**只能<code>2选1</code></li>
</ul>
<p><strong>CAP理论关注粒度是数据，而不是整体系统设计的策略</strong></p>
<h6 id="AP架构">AP架构</h6>
<p>当网络分区出现后，为了保证可用性，系统B可以返回旧值，保证系统的可用性。</p>
<p><strong>结论：违背了一致性C的要求，只满足可用性和分区容错，即AP</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291304015.png" alt="image-20230429130414986" style="zoom:25%;">
<h6 id="CP架构">CP架构</h6>
<p>当网络分区出现后，为了保证一致性，就必须拒接请求，否则无法保证一致性</p>
<p><strong>结论：违背了可用性A的要求，只满足一致性和分区容错，即CP</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291305290.png" alt="image-20230429130514265" style="zoom:25%;">
<h5 id="两句话：">两句话：</h5>
<p>1、最多只能同时较好的满足两个</p>
<p>CAP理论的核心：一个分布式系统不可能同时很好的满足三个需求。因此根据CAP原理将 NOSQL数据库分成了满足CA原则，满足CP原则和满足AP原则三大类。</p>
<ul>
<li>CA：单点集群，满足一致性，可用性的系统，通常扩展性不强大。</li>
<li>CP：满足一致性，分区容错性的系统，对数据一致性要求高，所以性能负担大。 Zookeeper/Consul 要求数据必须一致性。</li>
<li>AP：满足可用性，分许容错性的系统，通常可能对一致性要求低一些。 Eureka 场景：商场，暂时不一致错一点没关系，只要能正常访问下单即可。 Eureka通过设置一些属性，也可以通过牺牲高可用性实现一致性的要求。</li>
</ul>
<p>2、分布式必须满足:P: Partition tolerance 分区容错性</p>
<ul>
<li>Eureka主要保证高可用：AP</li>
<li>Zookeeper/Consul主要保证数据的一致：CP</li>
</ul>
<h5 id="web界面">web界面</h5>
<ul>
<li>Eureka/Consul都有一个web界面。</li>
<li>Zookeeper只有一个linux客户端。</li>
</ul>
<h2 id="4、服务调用">4、服务调用</h2>
<h3 id="1、Ribbon概述">1、Ribbon概述</h3>
<p>SpringCloud Ribbon 是基于Netflix Ribbon实现的一套客户端，<code>负载均衡</code> 的工具。</p>
<p>简单的说，Ribbon是Netflix发布的开源项目，<code>主要功能是提供客户端的软件负载均衡算法和服务调用</code>，Ribbon客户端组件提供一系列完善的配置项如连接超时，重试等。</p>
<p>简单的说，就是配置文件中列出Load Banlancer (简称LB) 后面所有的机器，Ribbon都会自动的帮助你基于某种规则（如简单轮询，随机连接等）去连接这些机器。我们很容易使用Ribbon实现自定义的负载均衡算法。</p>
<p>官网： <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Netflix/ribbon/wiki/Getting-Started">https://github.com/Netflix/ribbon/wiki/Getting-Started</a></p>
<h5 id="1-1负载均衡-LB">1.1负载均衡(LB)</h5>
<p><strong>LB 负载均衡 Load balance 是什么</strong></p>
<p>简单的说就是<code>将用户的请求平摊的分配</code>到多个服务上，从而达到系统的 高可用的 目的</p>
<p>常见的负载均衡有软件  Nginx   LVS   硬件F5等</p>
<p><strong>常见的负载均衡算法</strong></p>
<ul>
<li>
<p><strong>轮询</strong>：为第一个请求选择健康池中的第一个后端服务器，然后按顺序往后依次选择，直到最后一个，然后循环。</p>
</li>
<li>
<p><strong>最小连接</strong>：<code>优先选择   连接数最少的进行分配</code>，也就是压力最小的后端服务器，在会话较长的情况下可以考虑采取这种方式。</p>
</li>
<li>
<p><strong>散列</strong>：根据<code>请求源的 IP 的散列（hash）来选择</code>要转发的服务器。这种方式可以一定程度上保证特定用户能连接到相同的服务器。如果你的应用需要处理状态而要求用户能连接到和之前相同的服务器，可以考虑采取这种方式。</p>
</li>
</ul>
<p><strong>Ribbon本地负载均衡客户端VS Nginx 服务端负载均衡区别</strong></p>
<ul>
<li><code>Nginx</code>是服务器负载均衡，客户端所有请求都会交给Nginx，然后由Nginx实现转发请求，<code>即负载均衡是由服务端实现的</code></li>
<li><code>Ribbon</code> 本地负载均衡，在调用微服务接口时候，会在<code>注册中心</code>上获取注册信息服务列表之后<code>缓存到JVM本地</code>，从而在<code>本地实现RPC远程服务调用技术</code></li>
</ul>
<h5 id="1-1-2-集中式-负载均衡">1.1.2 集中式 负载均衡</h5>
<ul>
<li>集中式LB：即在服务的消费方和提供方之间<code>使用独立的负载均衡设备</code>（可以是硬件，如F5，也可以是软件，如Nginx），由该设备负责把访问请求通过某种策略转发至服务的提供方。</li>
</ul>
<h5 id="1-1-3-进程内-负载均衡">1.1.3 进程内 负载均衡</h5>
<ul>
<li>将负载均衡 逻辑  集成到消费方，消费方从服务注册中心获知有哪些地址可用，然后自己再从这些地址中选择出一个 合适 的服务器。</li>
<li><code>Ribbon就属于是进程内负载均衡</code>, 它只是一个类库，集成于消费方进程，消费方通过它来获取到服务提供方的地址。</li>
</ul>
<blockquote>
<p>一句话总结Ribbon：Ribbon是实现<code>负载均衡</code>的一套客户端工具结合<code>RestTemplate</code>实现调用。</p>
<p><strong>总结：Ribbon其实就是一个软负载均衡的客户端组件。</strong></p>
</blockquote>
<h4 id="架构说明">架构说明</h4>
<p>它可以和其他所需请求的客户端结合使用，  和eureka结合只是其中一个实例</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291318215.png" alt="img" style="zoom:33%;">
<h6 id="Ribbon在工作-分成两步">Ribbon在工作 分成两步</h6>
<ul>
<li>第一步先选择EurekaServer，它优先选择在同一个区域内负载较少的server</li>
<li>第二部再根据用户指定的策略，再从server取到的服务注册列表中选择一个地址。</li>
</ul>
<p>其中Ribbon提供了多种策略：比如 <strong>轮询，随机  和   根据响应时间加权。</strong></p>
<h6 id="为什么没有引入Ribbon也可以完成负载均衡？">为什么没有引入Ribbon也可以完成负载均衡？</h6>
<p>之前我们写样例的时候没有引入spring-cloud-start-ribbon也可以使用ribbon我们通过一个注解：@LoadBalanced赋予了RestTemplate负载均衡的能力；</p>
<p>原因是<code>spring-boot-netfix-eureka-client</code>自带了<code>spring-starter-ribbon</code>引用依赖</p>
<h5 id="再说RestTemplate的使用">再说RestTemplate的使用</h5>
<p>为什么说它： 所谓的负载均衡，就是Ribbon结合<code>RestTemplate</code>实现调用微服务之间的调用</p>
<h6 id="getForObject方法-getForEntity方法">getForObject方法/getForEntity方法</h6>
<p><code>getForObject()</code>      返回对象为<code>响应体中数据转化成的对象</code>，基本上可以理解为JSON</p>
<p><code>getForEntity()</code>      返回对象为ResponseEntity对象，包含了<code>响应中的一些重要信息</code>，比如响应头，响应状态码，响应体等。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291441528.png" alt="image-20230429144144481" style="zoom:25%;">
<h4 id="Ribbon核心组件：IRule接口">Ribbon核心组件：IRule接口</h4>
<h5 id="IRule接口的各实现类，以及对应功能">IRule接口的各实现类，以及对应功能</h5>
<p>根据特定算法从服务列表中选取一个要访问的服务。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291442840.png" alt></p>
<p><strong>IRule接口主要的实现类：</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291444539.png" alt="img" style="zoom: 50%;">
<ul>
<li><strong>com.netflix.loadbalancer.RoundRobinRule</strong>：轮询</li>
<li><strong>com.netflix.loadbalancer.RandomRule</strong>：随机</li>
<li><strong>com.netflix.loadbalancer.RetryRule</strong>：先按照RoundRobinRule的策略获取服务，如果获取服务<code>失败则在指定时间内会进行重试</code></li>
<li><strong>WeightedResponseTimeRule</strong>：对RoundRobinRule的扩展，响应速度越快的实例选择权重越大，越容易被选择</li>
<li><strong>BestAvailableRule</strong>：会先<code>过滤掉</code>由于多次访问故障而<code>处于断路器跳闸状态的服务</code>，然后选择一个<code>并发量最小的服务</code></li>
<li><strong>AvailabilityFilteringRule</strong>：先<code>过滤掉故障实例</code>，再选择<code>并发较小的实例</code></li>
<li><strong>ZoneAvoidanceRule</strong>：默认规则，复合判断server所在区域的性能和server的可用性选择服务器</li>
</ul>
<h4 id="如何替换负载均衡算法">如何替换负载均衡算法</h4>
<h6 id="实例">实例</h6>
<p><code>①修改cloud-consumer-order80</code></p>
<p><code>②负载均衡配置类注意事项</code></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291445409.png" alt="image-20230429144555381" style="zoom:25%;">
<blockquote>
<p>注意配置类细节：</p>
<p>​	官方文档明确给出了警告：这个自<code>定义负载均衡配置类不能放</code>在@ComponentScan<code>所扫描的当前包下以及子包下</code>，否则我们自定义的这个配置类就会被所有的Ribbon客户端所共享，达不到<code>特殊化定制的目的了</code>。</p>
<p>什么是@ComponentScan</p>
<p>@SpringBootApplication注解中包含了@ComponentScan注解</p>
<p>也就是说    @SpringBootApplication  标注的主配置类所在的包，以及所有子包都会被扫描到。</p>
<p>所以我们自定义的负载均衡配置类不能跟主启动类在同一个包下</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291452249.png" alt="image-20230429145202176" style="zoom:25%;">
</blockquote>
<p><code>③新建com.ry.MyIRule包，将自定义负载均衡配置类MySelfRule放在改包下</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.MyIRule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.IRule;</span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.RandomRule;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySelfRule</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> IRule <span class="title function_">myRule</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();<span class="comment">//定义为随机负载均衡算法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>④==主启动类添加@RibbonCilent注解== <code>@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;,configuration= MySelfRule.class)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">//指明访问的服务CLOUD-PAYMENT-SERVICE，以及指定负载均衡策略</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;,configuration= MySelfRule.class)</span>    <span class="comment">//随机算法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121614438.png" alt="image-20230512161432052" style="zoom:33%;">
<h3 id="2、负载均衡算法">2、负载均衡算法</h3>
<h5 id="原理">原理</h5>
<p>轮循负载均衡算法：<strong>rest接口第几次请求数     %   服务器集群总数量   =    实际调用服务器位置下标</strong>，每次服务重启后rest接口计数从1开始。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ServiceInstance&gt; instances = doscoveryClient.getInstances(<span class="string">&quot;cloud-payment-service&quot;</span>);</span><br><span class="line"></span><br><span class="line">比如集群中有两台服务器，地址分别为：</span><br><span class="line">List[<span class="number">0</span>] instances = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8002</span>;</span><br><span class="line">List[<span class="number">1</span>] instances = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8001</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">8001</span> + <span class="number">8002</span> 组合为集群，他们共计<span class="number">2</span>台机器，集群总数为<span class="number">2</span>，按照轮询算法原理：</span><br><span class="line">  </span><br><span class="line">当总请求数为<span class="number">1</span>时：<span class="number">1</span> % <span class="number">2</span> = <span class="number">1</span>，对应下标为 <span class="number">1</span>，则获得服务地址为 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>：<span class="number">8001</span></span><br><span class="line">当总请求数为<span class="number">2</span>时：<span class="number">2</span> % <span class="number">2</span> = <span class="number">0</span>，对应下标为 <span class="number">0</span>，则获得服务地址为 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>：<span class="number">8002</span></span><br><span class="line">当总请求数为<span class="number">3</span>时：<span class="number">3</span> % <span class="number">2</span> = <span class="number">1</span>，对应下标为 <span class="number">1</span>，则获得服务地址为 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>：<span class="number">8001</span></span><br><span class="line">当总请求数为<span class="number">4</span>时：<span class="number">4</span> % <span class="number">2</span> = <span class="number">0</span>，对应下标为 <span class="number">0</span>，则获得服务地址为 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>：<span class="number">8002</span></span><br><span class="line">如此类推&lt;服务器 一旦重启就从  <span class="number">1</span> 重新开始&gt;</span><br></pre></td></tr></table></figure>
<h5 id="源码">==源码==</h5>
<p>原理+JUC(CAS+自旋锁的复习)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoundRobinRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractLoadBalancerRule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger nextServerCyclicCounter;      <span class="comment">//原子类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">AVAILABLE_ONLY_SERVERS</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">ALL_SERVERS</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(RoundRobinRule.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RoundRobinRule</span><span class="params">()</span> &#123;</span><br><span class="line">        nextServerCyclicCounter = <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RoundRobinRule</span><span class="params">(ILoadBalancer lb)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>();</span><br><span class="line">        setLoadBalancer(lb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选择哪一个服务器</span></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(ILoadBalancer lb, Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lb == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;no load balancer&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (server == <span class="literal">null</span> &amp;&amp; count++ &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            List&lt;Server&gt; reachableServers = lb.getReachableServers();  <span class="comment">// 可达的存活的服务器</span></span><br><span class="line">            List&lt;Server&gt; allServers = lb.getAllServers();</span><br><span class="line">            <span class="type">int</span> <span class="variable">upCount</span> <span class="operator">=</span> reachableServers.size();</span><br><span class="line">            <span class="type">int</span> <span class="variable">serverCount</span> <span class="operator">=</span> allServers.size();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((upCount == <span class="number">0</span>) || (serverCount == <span class="number">0</span>)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;No up servers available from load balancer: &quot;</span> + lb);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextServerIndex</span> <span class="operator">=</span> incrementAndGetModulo(serverCount);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">              private int incrementAndGetModulo(int modulo) &#123;</span></span><br><span class="line"><span class="comment">                for (;;) &#123;</span></span><br><span class="line"><span class="comment">                    int current = nextServerCyclicCounter.get();</span></span><br><span class="line"><span class="comment">                    int next = (current + 1) % modulo;</span></span><br><span class="line"><span class="comment">                    if (nextServerCyclicCounter.compareAndSet(current, next))   CAS</span></span><br><span class="line"><span class="comment">                        return next;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            CAS:  底层无锁</span></span><br><span class="line"><span class="comment">            	   public final boolean compareAndSet(int expect, int update) &#123;</span></span><br><span class="line"><span class="comment">                        return unsafe.compareAndSwapInt(this, valueOffset, expect, update);</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            server = allServers.get(nextServerIndex);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (server == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">/* Transient. */</span></span><br><span class="line">                Thread.<span class="keyword">yield</span>();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (server.isAlive() &amp;&amp; (server.isReadyToServe())) &#123;</span><br><span class="line">                <span class="keyword">return</span> (server);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Next.</span></span><br><span class="line">            server = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;No available alive servers after 10 tries from load balancer: &quot;</span></span><br><span class="line">                    + lb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> server;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="手写一个负载均衡算法">手写一个负载均衡算法</h5>
<blockquote>
<p><code>cloud-consumer-order80\cloud-provider-payment8001\cloud-provider-payment8002</code></p>
</blockquote>
<p><code>①8001/8001微服务 添加对应的controller的方法</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/payment/lb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getPaymentLB</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> serverPort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>②80微服务改造</code></p>
<p><strong>ApplicationContextConfig</strong>去掉**@LoadBalance**注解</p>
<p><code>③创建LoadBalancer接口</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoadBalancer</span> &#123;</span><br><span class="line">    ServiceInstance <span class="title function_">instances</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>④创建LoadBalancer接口的实现类MyLoadBalancer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLoadBalancer</span> <span class="keyword">implements</span> <span class="title class_">LoadBalancer</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> current;</span><br><span class="line">        <span class="type">int</span> next;</span><br><span class="line">        <span class="comment">//从下面的分析中得知：该循环主要是得到next值，单机是每循环一次返回一次next</span></span><br><span class="line">        <span class="comment">//高并发时：就不是这种情况了。因为数字会被抢占。</span></span><br><span class="line">        <span class="comment">//自旋锁</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            current = <span class="built_in">this</span>.atomicInteger.get();</span><br><span class="line">            <span class="comment">//考虑到极端情况，atomicInteger最大值为2147483647</span></span><br><span class="line">            <span class="comment">//当请求次数超过这个值的时候，从0开始</span></span><br><span class="line">            next = current &gt;= <span class="number">2147483647</span> ? <span class="number">0</span> : current + <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//compareAndSet方法使用了CAS机制，判断current是否变化，如果变了自旋，反之更新current</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 当atomicInteger=0时，current=0, next=1</span></span><br><span class="line"><span class="comment">             * atomicInteger和current进行比较，相等时返回true将atomicInteger更新为next，1，取反跳出循环，再返回next</span></span><br><span class="line"><span class="comment">             * 当atomicInteger=2147483647时，current=2147483647，next=0</span></span><br><span class="line"><span class="comment">             * atomicInteger和current进行比较，相等时返回true将atomicInteger更新为next, 0，取反跳出循环，再返回next</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * 如果是高并发时,则需要判断当前线程获得的current值跟atomicInteger的值是否相等，</span></span><br><span class="line"><span class="comment">             * 如果不相等则表示其他线程已经操作了atomicInteger，自旋。</span></span><br><span class="line"><span class="comment">             * 这就是乐观锁的一个实现</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;<span class="keyword">while</span> (!<span class="built_in">this</span>.atomicInteger.compareAndSet(current, next));</span><br><span class="line">        System.out.println(<span class="string">&quot;************第几次访问次数:&quot;</span> + next);</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//负载均衡算法：rest接口第几次请求数 % 服务器集群总数量 = 实际调用服务器位置下标</span></span><br><span class="line">    <span class="comment">// 每次服务重启动后rest接口计数从1开始。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstance <span class="title function_">instances</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span> &#123;</span><br><span class="line">        <span class="comment">//计算当前访问应该分配给哪台服务器处理</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> getAndIncrement() % serviceInstances.size();</span><br><span class="line">        <span class="comment">//返回目标服务器</span></span><br><span class="line">        <span class="keyword">return</span> serviceInstances.get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>⑤修改OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.Controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.CommontResult;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="keyword">import</span> com.ry.sc.lb.LoadBalance;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="comment">//单机形式</span></span><br><span class="line">    <span class="comment">//public static final String PAYMENT_URL = &quot;http://localhost:8001&quot;;</span></span><br><span class="line">    <span class="comment">//集群模式</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYMENT_URL</span> <span class="operator">=</span> <span class="string">&quot;http://CLOUD-PAYMENT-SERVICE&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalance LoadBalance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/consumer/payment/lb&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPaymentLB</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(instances == <span class="literal">null</span> || instances.size() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">serviceInstance</span> <span class="operator">=</span> LoadBalance.instances(instances);</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> serviceInstance.getUri();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(uri+<span class="string">&quot;/payment/lb&quot;</span>,String.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>⑥测试</code></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121618896.png" alt="image-20230512161844742" style="zoom:33%;">
<h3 id="3、OpenFeign">3、OpenFeign</h3>
<h4 id="基本介绍">基本介绍</h4>
<h5 id="1、OpenFeign概述">1、OpenFeign概述</h5>
<ul>
<li>是什么</li>
</ul>
<p>​		<a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloud.spring.io/spring-cloud-static/Hoxton.SR1/reference/htmlsingle/#spring-cloud-openfeign">官网</a></p>
<p>​		<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/spring-cloud/spring-cloud-openfeign">源码</a></p>
<blockquote>
<p>做法是：  <code>定义一个服务接口</code>然后在<code>上面添加注解</code>，Feign也支持<code>可插拔式的编码器和解码器</code>。</p>
<p>Spring Cloud 对Feign进行了封装。使其支持了SpringMVC 标准注解和HttpMessageConverters。</p>
<p><code>Feign可以与Eureka和Ribbon组合使用以支持负载均衡</code></p>
</blockquote>
<ul>
<li>Feign是一个声明式Rest/WebService客户端，使用Feign能让WebService客户端更加简单。</li>
<li>只需创建一个接口并在接口上添加注解即可。</li>
</ul>
<h5 id="2、Feign作用">2、Feign作用</h5>
<p><strong>Feign旨在使编写Java Http客户端变得更容易。</strong></p>
<ul>
<li>声明式远程方法调用</li>
</ul>
<p>前面在使用Ribbon+RestTemplate时，利用RestTemplate对http请求的封装处理，形成了一套模版化的调用方法。</p>
<p>但是在实际开发中，由于对服务依赖的调用可能不止一处，往往一个接口会被多处调用，所以通常都会针对每个微服务自行封装一些客户端类来包装这些依赖服务的调用。</p>
<p>所以，Feign在此基础上做了进一步封装，由他来帮助我们定义和实现依赖服务接口的定义。</p>
<ul>
<li>具体的Feign的实现下</li>
</ul>
<p>我们<code>只需创建一个接口</code>并<code>使用注解的方式</code>来配置它(以前是Dao接口上面标注Mapper注解,现在是一个微服务接口上面标注一个Feign注解即可)，即可完成对服务提供方的接口绑定，简化了使用Spring cloud Ribbon时，自动封装服务调用客户端的并发量。</p>
<p>即服务提供方有哪些接口，Feign里面即有与之对应的方法直接调用。</p>
<ul>
<li>Feign集成了Ribbon</li>
</ul>
<p>利用Ribbon维护了Payment的服务列表信息，并且通过轮询实现了客户端的负载均衡。</p>
<p>而与Ribbon不同的是，通过feign只需要以<code>声明式的方法定义服务且绑定接口</code>即可，优雅而简单的实现了服务调用</p>
<h5 id="3、Feign与OpenFeign的区别">3、Feign与OpenFeign的区别</h5>
<table>
<thead>
<tr>
<th>Feign</th>
<th>OpenFeign</th>
</tr>
</thead>
<tbody>
<tr>
<td>Feign是Spring Cloud组件中的一个轻量级RestFul的Http服务客户端。Feign内置了Ribbon，用来做客户端负载均衡，去调用服务注册中心的服务。Feign的使用方式是：使用Feign的注解定义接口，调用这个接口就可以调用服务注册中心的服务。</td>
<td>OpenFeign是Spring Cloud在Fiegn的基础上支持了SpringMVC的注解，如@RequestMapping等。OpenFeign的@FeignClient可以解析SpringMVC的@RequestMapping注解下的接口，并通过<code>动态代理</code>的方式产生实现类，实现类中做负载均衡并调用其他服务。</td>
</tr>
<tr>
<td>GroupID：org.springframework.cloud                                               ArtifactID：spring-cloud-starter-feign</td>
<td>GroupID：org.springframework.cloud                                                    ArtifactID：spring-cloud-starter-openfeign</td>
</tr>
</tbody>
</table>
<h4 id="OpenFeign使用步骤">OpenFeign使用步骤</h4>
<ul>
<li>
<p>以前我们在消费者服务调用生产者服务时，采用Ribbon+restTemplate进行客户端服务调用和负载均衡。</p>
</li>
<li>
<p>现在采用OpenFeign绑定服务接口。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291556991.png" alt="image-20230429155656921" style="zoom:33%;">
</li>
<li>
<p>Feign 是使用在消费端！</p>
</li>
</ul>
<p>接口+注解  ------ <code>微服务调用接口</code>+<code>@FeignClient  注解</code></p>
<p>OpenFeign整合了Ribbon，所以具有负载均衡的功能</p>
<h5 id="cloud-consumer-openfeign-order80">cloud-consumer-openfeign-order80</h5>
<p>创建cloud-consumer-openfeign-order80 模块</p>
<p>写pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-consumer-openfeign-order80<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--openfeign   新增--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--web--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--一般基础通用配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>写yaml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 表示不将其注入Eureka作为微服务，不作为Eureak客户端了，而是作为Feign客户端</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 集群版</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka,http://eureka7003.com:7003/eureka</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>==注意这里的启动类==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span> <span class="comment">//不作为Eureak客户端了，而是作为Feign客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderOpenFeignMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderOpenFeignMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//@EnableFeignClients //不作为Eureak客户端了，而是作为Feign客户端</span></span><br></pre></td></tr></table></figure>
<p>==业务类==</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291626168.png" alt="image-20230429162612074" style="zoom:33%;">
<p><code>业务逻辑接口+@FeignClient配置调用provider服务 </code></p>
<p>​		新建PaymentFeignService接口并新增注解**@FeignClient**  	<code>@FeignClient(&quot;provider微服务名字&quot;)</code></p>
<p>注意：</p>
<ul>
<li>这里声明的方法签名，必须和provider微服务（服务提供者微服务）中的controller中方法的签名一致</li>
<li>如果需要传递参数，那么<code>@RequestParam</code> 和<code>@RequestBody</code> <code>@PathVariable</code> 不能省 必加</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.CommontResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PAYMENT-SERVICE&quot;)</span> <span class="comment">//作为一个Feign功能绑定的的接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentFeignService</span> &#123;</span><br><span class="line">     <span class="meta">@GetMapping(value = &quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">     <span class="keyword">public</span> CommontResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以找到<code>CLOUD-PAYMENT-SERVICE</code>微服务下面的<code>/payment/get/&#123;id&#125;</code>这个地址。</p>
<p>这也就说明：</p>
<ul>
<li><code>PaymentFeignService接口+@FeignClient注解</code>，完成Feign的包装调用</li>
<li>指明找哪个微服务上面的地址</li>
</ul>
<p>==主启动类开启Feign（增加**@EnableFeignClients<strong>注解），接口上使用</strong>@FeignClient**，组合使用==</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291617640.png" alt="image-20230429161708556" style="zoom: 50%;">
<p><code>Controller</code></p>
<p>​		通过自己的80 Service接口层，去调用服务提供者中的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ry.sc.Service.PaymentFeignService;</span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.CommontResult;</span><br><span class="line"><span class="keyword">import</span> com.ry.sc.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.xml.stream.events.Comment;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeignController</span> &#123;</span><br><span class="line">    <span class="comment">//直接将PaymentFeignService的对象注入</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommontResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<blockquote>
<p>先启动两个Eureka集群  7001/7002</p>
<p>再启动两个paymentprovider微服务 8001/8002</p>
<p>启动使用OpenFeign的OrderFeign80</p>
</blockquote>
<p>测试成功：</p>
<p>消费者微服务没有注册在Eureka中；通过消费者本身的接口地址，去调用生产者微服务对应的接口，并且可以实现负载均衡</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121639841.png" alt="image-20230512163900705" style="zoom:53%;">
<p><strong>消费调用服务：</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291623904.png" alt="image-20230429162303844" style="zoom: 33%;">
<h4 id="OpenFeign超时控制">OpenFeign超时控制</h4>
<h5 id="超时设置，故意设置超时演示出错情况">超时设置，故意设置超时演示出错情况</h5>
<p>服务提供方8001故意写暂停程序(在8002也写了该方法)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/payment/feign/timeout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentFeignTimeout</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serverPort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务消费方80在PaymentFeignService添加超时方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PAYMENT-SERVICE&quot;)</span> <span class="comment">//作为一个Feign功能绑定的的接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentFeignService</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/feign/timeout&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentFeignTimeout</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消费方80添加超时方法到controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/feign/timeout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentFeignTimeout</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//openfeign-ribbon，客户端一般默认等待 1s</span></span><br><span class="line">    <span class="keyword">return</span> paymentFeignService.paymentFeignTimeout();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121643696.png" alt="image-20230512164355560" style="zoom:33%;">
<h5 id="超时报错">超时报错</h5>
<ul>
<li>OpenFeign默认等待时间为1秒钟，超过后报错</li>
</ul>
<blockquote>
<p>默认Feign客户端只等待一秒钟，但是<code>服务端</code>处理需要<code>超过1秒钟</code>，导致Feign<code>客户端</code>不想等待了，直接返回报错。</p>
<p>为了避免这种请况，有时候我们需要<code>设置Feign客户端的超时控制</code>。</p>
<p><strong>Feign 默认是支持Ribbon ，Feign依赖里自己带了Ribbon</strong>；<strong>Feign客户端的负载均衡和超时控制都由Ribbon控制</strong></p>
</blockquote>
<h6 id="配置超时时间">配置超时时间</h6>
<p>超时报错可以通过配置进行修改：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置feign客户端超时时间(OpenFeign默认支持ribbon)</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="comment">#指的是建立连接后从服务器读取到可用资源所用的时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span></span><br><span class="line">  <span class="comment">#指的是建立连接所用的时间，适用于网络状况正常的情况下,两端连接所用的时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
<h5 id="OpenFeign配置日志">OpenFeign配置日志</h5>
<p>Feign提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解Feign中Http请求的细节。</p>
<p>说白了就是：<code>对Feign接口的调用情况进行  监控  和  输出</code></p>
<h6 id="1、日志级别">1、日志级别</h6>
<table>
<thead>
<tr>
<th>类型</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>1、NONE</td>
<td>默认的，不显示任何日志</td>
</tr>
<tr>
<td>2、BASIC</td>
<td>仅记录请求方法、URL、响应状态码及执行时间</td>
</tr>
<tr>
<td>3、HEADERS</td>
<td>除了BASIC中定义的信息之外，还有请求和响应的头信息</td>
</tr>
<tr>
<td>4、FULL</td>
<td>除了HEADERS中定义的信息外，还有请求和响应的正文及元数据。</td>
</tr>
</tbody>
</table>
<h6 id="2、配置日志">2、配置日志</h6>
<p>配置在消费端 80</p>
<p><strong>1、配置日志bean  ——所有的配置都可以作为一个config的包   然后写配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ry.sc.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.Level <span class="title function_">feignLoggerLevel</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2、配置消费端的yml文件</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">    <span class="attr">level:</span></span><br><span class="line">      <span class="comment"># feign 日志以什么级别监控哪个接口</span></span><br><span class="line">      <span class="attr">com.atguigu.springcloud.service.PaymentFeignService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>
<p>测试</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121647415.png" alt="image-20230512164741288" style="zoom:33%;">
<h2 id="5、服务降级">5、服务降级</h2>
<h3 id="一、概述">一、概述</h3>
<h5 id="1、分布式系统面临的问题">1、分布式系统面临的问题</h5>
<blockquote>
<p>复杂分布式体系结构中的应用程序有数十个依赖关系，每个依赖关系在某些时候将不可避免地失败。几个微服务之间的相互调用，一定会导致链路越来越长。</p>
</blockquote>
<p>当一个出事了，就会导致整条链路上的服务都出事。</p>
<h6 id="1-1-服务雪崩">1.1 服务雪崩</h6>
<p>多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其他的微服务，这就是所谓的<code>“扇出”</code></p>
<p>如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的“雪崩效应”。</p>
<p>对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都在几秒钟内饱和，<code>比失败更糟糕</code>的是，这些应用程序<code>还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障</code></p>
<p>这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败导致整个应用程序或系统的取消。</p>
<p>所以，通常当你发现一个模块下某个实例失败后，这时候这个模块依然还会接收流量，然而这个有问题的模块还调用了其他模块，这样就会发生<code>级联故障</code>，或者叫<code>雪崩</code>。</p>
<h5 id="2、Hystrix-是什么-豪猪">2、Hystrix 是什么(豪猪)</h5>
<p>Hystrix 是一个用于处理分布式系统的<code>延迟和容错</code>的开源库</p>
<p>在分布式系统里，许多依赖不可避免的会调用失败，比如超时，异常等，</p>
<p>Hystrix能够<code>保证在一个依赖出问题的情况下，不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性</code>。</p>
<p>断路器本身是一种开关装置</p>
<p><code>当某个服务单元发生故障之后</code>，通过断路器的故障监控（类似熔断保险丝），向调用方返回一个符合预期的，可处理的备选响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常，</p>
<p>这样就保证了服务调用方的线程不被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩。</p>
<h5 id="3、Hystrix能做什么">3、Hystrix能做什么</h5>
<ul>
<li>服务降级</li>
<li>服务熔断</li>
<li>接近实时的监控</li>
</ul>
<h5 id="4、Hystrix官网">4、Hystrix官网</h5>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Netflix/Hystrix/wiki/How-To-Use">https://github.com/Netflix/Hystrix/wiki/How-To-Use</a></p>
<h3 id="二、Hystrix-重要概念">二、Hystrix 重要概念</h3>
<h5 id="1、服务降级：fallback">1、服务降级：fallback</h5>
<p>假如对方的系统不可用了，需要一个兜底的解决方案或备选响应；从而能够向调用方返回一个符合预期的、可处理的备选响应。</p>
<blockquote>
<p>比如：服务器繁忙，稍后再试，不让客户端等待并立刻返回一个好友提示。<code>fallback</code></p>
</blockquote>
<p>哪些情况会触发降级：</p>
<ul>
<li>程序运行异常</li>
<li>超时</li>
<li>服务熔断   触发服务降级</li>
<li>线程池/信号量打满   也会导致服务降级</li>
</ul>
<h5 id="2、服务熔断：break">2、服务熔断：break</h5>
<p>达到最大服务访问后，直接拒绝访问，拉闸限电，然后调用服务降级的方法并返回友好提示 <code>break</code></p>
<p>三阶段： 服务的降级—&gt;然后熔断—&gt;恢复调用链路</p>
<h5 id="3、服务限流：flowlimit">3、服务限流：flowlimit</h5>
<p>秒杀高并发等操作，严禁一窝蜂的过来拥挤，大家排队，一秒钟N个，有序进行  <code>flowlimit</code></p>
<h3 id="三、Hystrix的引出">三、Hystrix的引出</h3>
<h4 id="提供者模块简单说明">提供者模块简单说明</h4>
<p>搭建基础平台：从正确—&gt;错误—&gt;降级熔断—&gt;恢复</p>
<p>以此平台 演示<code> Hystrix 服务降级 服务熔断 服务限流</code></p>
<h4 id="cloud-provider-hystrix-payment8001">cloud-provider-hystrix-payment8001</h4>
<h5 id="yml-2">yml</h5>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-hystrix-payment</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#集群</span></span><br><span class="line">      <span class="comment">#defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br><span class="line">      <span class="comment">#单机</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>
<h5 id="启动类">启动类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentHystrixMain8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentHystrixMain8001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="业务类">==业务类==</h5>
<h6 id="Service">Service</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正常访问，一定ok的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Ok</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池：  &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;   paymentInfo_OK,  id:  &quot;</span> + id</span><br><span class="line">                + <span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(∩_∩)O哈哈~&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">timeNumber</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(timeNumber);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池：  &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;   payment_Timeout,  id:  &quot;</span> + id</span><br><span class="line">                + <span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(∩_∩)O哈哈~耗时(s):&quot;</span> + timeNumber;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Controller">Controller</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">paymentInfo_Ok</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.paymentInfo_Ok(id);</span><br><span class="line">        log.info(<span class="string">&quot;******ok****result：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.paymentInfo_Timeout(id);</span><br><span class="line">        log.info(<span class="string">&quot;******timeout****result：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="正常测试">正常测试</h5>
<p>启动<code>eureka7001/7002</code>；启动<code>cloud-provider-hystrix-payment8001</code></p>
<p>访问模拟健康的方法： ok的方法</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291832599.png" alt></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291833097.png" alt></p>
<p>访问模拟复杂业务逻辑的方法：timeout的方法，耗时3s</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121707660.png" alt="image-20230512170733518" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121707255.png" alt="image-20230512170748114" style="zoom:33%;">
<blockquote>
<p>以上述平台为根基，演示正确–&gt;错误–&gt;降级熔断–&gt;恢复</p>
</blockquote>
<h5 id="高并发压测">高并发压测</h5>
<p>上述在非高并发情况下，还勉强可以满足。使用jmeter，设置20000个并发压死8001,20000个请求都去访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/payment/hystrix/timeout/31">http://localhost:8001/payment/hystrix/timeout/31</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632296071791-701b786a-5d25-4c21-b5a9-c545ac74c8c6.png" alt><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632296085411-98b8ca31-801c-4fc9-a5c2-8c68355dc6a4.png" alt></p>
<p>结果发现原来可以迅速响应的<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/payment/hystrix/ok/31">http://localhost:8001/payment/hystrix/ok/31</a> 变得卡顿。两个都在转圈。</p>
<p><strong>原因：</strong></p>
<p>因为ok跟timeout都在一个微服务里，现在大量的资源被timeout占用，微服务必须集中资源去处理这些 高并发的请求。那么ok方法，得到的资源就少，进而被影响。</p>
<blockquote>
<p>SpringBoot默认集成的是tomcat容器，里面有一个tomcat的线程池，高并发下  没有 多余的线程来分解压力和处理ok方法。</p>
<p>每个线程都要等待3秒钟，才能拿到timeout的结果响应。那么2000个线程一起过来,Tomcat池子里的线程，马上就会被抢占完。</p>
<p>上面还只是服务提供者8001自己测试，假如此时外部的消费者80也来访问，那消费者只能干等， 最终导致消费端80不满意，服务端8001直接被拖死。</p>
</blockquote>
<h4 id="消费者模块-cloud-consumer-feign-hystrix-order80">消费者模块(cloud-consumer-feign-hystrix-order80)</h4>
<h5 id="yml-3">yml</h5>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="主启动-2">主启动</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span> <span class="comment">//不作为Eureak客户端了，而是作为Feign客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeignHystrixMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderFeignHystrixMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="业务类-2">业务类</h5>
<h6 id="PaymentHystrixService">PaymentHystrixService</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentHystrixService</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Ok</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="OrderHystirxController">OrderHystirxController</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderHystirxController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    PaymentHystrixService paymentHystrixService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Ok</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentHystrixService.paymentInfo_Ok(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentHystrixService.paymentInfo_Timeout(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="正常测试-2">正常测试</h5>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost/consumer/payment/hystrix/timeout/31">http://localhost/consumer/payment/hystrix/timeout/31</a></p>
<p>由于使用的是Feign作为客户端，默认1s没有得到响应就会报超时错误。这是正常的，这里我们不进行改动。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632299132526-b5214cc0-f220-4a32-a1cf-c89915a1d7af.png" alt></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost/consumer/payment/hystrix/ok/31">http://localhost/consumer/payment/hystrix/ok/31</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632299703025-9009bec4-75ce-4e5d-8b2b-ab6159b42ce6.png" alt></p>
<h5 id="高并发测试">高并发测试</h5>
<p>2W个线程压8001 消费端80微服务再去访问正常的OK微服务8001地址<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost/consumer/payment/hystrix/ok/31:">http://localhost/consumer/payment/hystrix/ok/31:</a> 要么转圈圈等待，要么消费端报超时错误。</p>
<p>原因： 8001同一层次的其他接口服务被困死，因为tomcat线程池里面的工作线程已经被挤占完毕 所以80此时调用8001，客户端访问响应缓慢，转圈圈。 正因为有上述故障或不佳表现，才有了我们的<code>降级/容错/限流</code>等技术诞生。</p>
<h4 id="Hystrix如何解决问题？">Hystrix如何解决问题？</h4>
<p>如何解决？解决的要求？</p>
<ul>
<li>
<p>两个思路</p>
<ul>
<li>
<p>超时导致服务器变慢(转圈)：超时不再等待</p>
</li>
<li>
<p>出错(宕机或程序运行出错)：出错要有兜底</p>
<ul>
<li>具体解决
<ul>
<li>对方服务(8001)<code>超时</code>了，调用者(80)不能一直卡死等待，必须有<code>服务降级</code></li>
<li>对方服务(8001)<code>宕机</code>了，调用者(80)不能一直卡死等待，必须有<code>服务降级</code></li>
<li>对方服务(8001)<code>OK</code>，调用者(80)<code>自己出故障或有自我要求</code>（自己的等待时间小于服务提供者），<code>自己处理降级</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="四、服务降级">四、服务降级</h3>
<p>不管是在消费者，还是提供者，都可以进行服务降级，使用过**@HystrixCommand**注解指定降级后的方法</p>
<p>一般服务降级 是放在 客户端</p>
<h4 id="服务降级：8001生产者服务端-（cloud-provider-hystrix-payment8001）">服务降级：8001生产者服务端 （cloud-provider-hystrix-payment8001）</h4>
<p>服务降级：payment8001支付（生产者服务）</p>
<p>8001先从自身找问题，设置自身调用超时时间的峰值，峰值内可以正常运行。</p>
<p>超过了就需要有兜底的方法，做服务降级fallback。</p>
<p>向调用方法返回一个符合预期的，可以处理的备选响应（FallBack）</p>
<h5 id="业务类-Service-方法上添加-HystrixCommand">业务类(Service)方法上添加**@HystrixCommand**</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//模拟拥堵的情况</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeoutHandler&quot;, commandProperties = &#123;</span></span><br><span class="line"><span class="meta">    //规定这个线程的超时时间是3s，3s后就由fallbackMethod指定的方法帮我“兜底”（服务降级）</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;3000&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">timeNumber</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="comment">//int age = 10 / 0;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(timeNumber);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;线程池：  &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;   payment_Timeout,  id:  &quot;</span> + id</span><br><span class="line">        + <span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(∩_∩)O哈哈~耗时(s):&quot;</span> + timeNumber;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeoutHandler</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;线程池：  &quot;</span>+ Thread.currentThread().getName()+<span class="string">&quot;   paymentInfo_TimeoutHandler,  id:  &quot;</span>+id</span><br><span class="line">        +<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;o(╥﹏╥)o&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一旦调用服务方法失败并抛出了错误信息后，会自动调用@HystrixCommand标注好的fallbackMethod调用类中的指定方法，当前服务不可用了，做服务降级，<code>兜底</code>的方案都是<code>paymentInfo_TimeOutHandler</code>。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121725283.png" alt="image-20230512172531828" style="zoom:33%;">
<h5 id="主启动类激活">主启动类激活</h5>
<p>主启动类添加新注解**@EnableCircuitBreaker**</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentHystrixMain8001</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">            SpringApplication.run(PaymentHystrixMain8001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="测试">测试</h5>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291832152.png" alt></p>
<p>我们故意制造的两个异常：</p>
<ol>
<li>
<p>int age = 10/0 计算异常</p>
</li>
<li>
<p>我们定义超时时间3s，服务运行5s的超时异常</p>
<p>这些都会造成当前服务不可用了，就会进行服务降级，执行兜底的方案。</p>
</li>
</ol>
<h4 id="服务降级：80消费者服务端（cloud-consumer-feign-hystrix-order80）">服务降级：80消费者服务端（cloud-consumer-feign-hystrix-order80）</h4>
<h6 id="修改yaml">修改yaml</h6>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h6 id="主启动类：-EnableHystrix-开启Hystrix支持">主启动类：@EnableHystrix    开启Hystrix支持</h6>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121726942.png" alt="image-20230512172656793" style="zoom:33%;">
<h6 id="业务类——Controller">业务类——Controller</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderHystirxController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    PaymentHystrixService paymentHystrixService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Ok</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentHystrixService.paymentInfo_Ok(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentTimeOutFallbackMethod&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;,</span></span><br><span class="line"><span class="meta">                    value=&quot;1500&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentHystrixService.paymentInfo_Timeout(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentTimeOutFallbackMethod</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我是消费者80,对方支付系统繁忙请10秒钟后再试或者自己运行出错请检查自己,o(╥﹏╥)o&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305121727707.png" alt="image-20230512172738562" style="zoom:33%;">
<h6 id="测试-2">测试</h6>
<p>把8001服务端的业务处理时间设置为2s，设定3s以内是正常的，保证8001服务端能够正常运行。</p>
<h4 id="代码的-进一步优化">代码的 进一步优化</h4>
<h5 id="目前存在的问题——代码臃肿、耦合度高">目前存在的问题——代码臃肿、耦合度高</h5>
<ul>
<li>我们现在服务降级的方法和业务处理的方法混杂在了一块，耦合度很高。</li>
<li>如果每个接口，每个方法都需要一个“兜底”方法，那么就会造成代码臃肿</li>
</ul>
<p>所以我们需要一个全局的服务降级：<code>global fallback</code>；需要特殊照顾的方法，我们再进行精确的配置服务降级。</p>
<h6 id="解决代码臃肿">解决代码臃肿</h6>
<p>1：1 每个方法配置一个服务降级方法，技术上可以，不实际</p>
<p>1：N 除了个别重要核心业务有专属，其它普通的可以通过@DefaultProperties(defaultFallback = “”)  统一跳转到统一处理结果页面</p>
<p>通用的和独享的各自分开，避免了代码膨胀，合理减少了代码量。</p>
<p><strong>下面以消费者服务端80为例: cloud-consumer-feign-hystrix-order80</strong></p>
<ul>
<li>在业务类Controller上加<code>@DefaultProperties(defaultFallback = &quot;method_name&quot;)</code>注解，并指明defaultFallback</li>
<li>在需要服务降级的方法上标注**@HystrixCommand**  注解
<ul>
<li>如果**@HystrixCommand<strong>里没有指明fallbackMethod，就默认使用</strong>@DefaultProperties(defaultFallback = “method_name”)**中指明的降级服务</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632711113927-07221290-219e-42f1-8a37-94cd015562e9.png" alt></p>
<p><strong>测试</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292042493.png" alt="image-20230429204255349" style="zoom:33%;">
<h6 id="降低代码耦合度-混乱程度">降低代码耦合度(混乱程度)</h6>
<p>在80微服务中，它没有注册进eureka注册中心成为eureka客户端。而是通过openFeign，成为一个Feign客户端，通过Feign来进行微服务的调用和负载均衡。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291832284.png" alt></p>
<p>直接定义Service层的接口通过<code>@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;) </code>这个注解找<code>CLOUD-PROVIDER-HYSTRIX-PAYMENT</code>这个微服务中的方法进行调用。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632715285962-5ddedd07-2ba8-4523-b94b-3adf991f655c.png" alt></p>
<p>即：</p>
<p>只要是用Feign进行微服务的调用，那么一定有标注<code>@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;)</code>的接口，这个接口就能实现调用其他微服务的操作，因此我们将<code>这个接口中的全部方法进行统一的fallback服务降级</code></p>
<h6 id="解耦案例——服务降级：客户端调用服务端，遇到服务端宕机或关闭等极端情况">解耦案例——服务降级：客户端调用服务端，遇到服务端宕机或关闭等极端情况</h6>
<p>本次案例服务降级是在客户端80实现完成，与服务端8001没有关系。</p>
<p>只需要为Feign客户端定义的接口添加一个服务降级实现类即可实现解耦</p>
<p>未来我们遇到的异常有：<code>运行时异常、超时、宕机</code></p>
<h5 id="案例">案例</h5>
<h6 id="修改cloud-consumer-feign-hystrix-order80">修改cloud-consumer-feign-hystrix-order80</h6>
<p>根据cloud-consumer-feign-hystrix-order80已经有的<code>PaymentHystrixService接口</code>，重新<code>新建一个类(PaymentFallbackService)实现该接口</code>，统一为接口里面的方法进行异常处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>  <span class="comment">//不要忘记这个注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title class_">PaymentHystrixService</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Ok</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------PaymentFallbackService-paymentInfo_Ok, fallback&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------PaymentFallbackService-paymentInfo_Timeout, fallback&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改<code>PaymentHystrixService</code>接口，指定其服务异常处理类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//使用 @FeignClient  中的 fallback  属性 ，  甚至能不使用 @HystrixCommand   就完成  服务降级</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;, fallback = PaymentFallbackService.class)</span>   </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentHystrixService</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Ok</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">​    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">​    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>确认yml配置文件中开启了<code>hystrix</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用于服务降级 在注解@FeignClient中添加fallbackFactory属性值</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment">#在Feign中开启Hystrix</span></span><br></pre></td></tr></table></figure>
<p>目的是为了实现以下效果：</p>
<ul>
<li>正常运行的话就找指定的微服务中的方法执行；</li>
<li><code>异常的话就找PaymentFallbackService，由它来统一进行服务降级的处理</code></li>
</ul>
<p>这样的话客户端的OrderHystirxController中就不需要再进行降级处理，降级处理只针对要调用的微服务，因此降低了服务降级和客户端的耦合度。</p>
<h6 id="测试-3">测试</h6>
<p>启动7001、8001、80</p>
<p>8001端口正常运行：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632725916414-ede7986d-9b9f-4f7a-ad05-db8f7f088a85.png" alt></p>
<p>8001端口宕机：此时服务端provider已经down了，但是我们做了服务降级处理，让客户端在服务端不可用时也会获得提示信息而不会挂起耗死服务器</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632726565675-a9ae21a7-4da5-4aaf-af8c-767b6e3cb9b0.png" alt></p>
<h3 id="五、服务熔断">五、服务熔断</h3>
<p>熔断也会 触发 服务降级</p>
<h4 id="1、熔断机制概述">1、熔断机制概述</h4>
<p>熔断机制是应对雪崩效应的一种微服务链路保护机制。</p>
<p>当扇出链路的某个微服务出错不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。</p>
<p>当检测到该节点微服务调用响应正常后，自动恢复调用链路。</p>
<p><code>熔断状态： 开启   关闭    半开启</code></p>
<p>在SpringCloud框架中，熔断机制通过Hystrix实现。Hystrix会监控微服务间调用的状况。</p>
<p>当失败的调用到一定<code>阈值</code>，缺省时5秒内20次调用失败，就会启动熔断机制，熔断机制的注解是<code>@HystrixCommand</code></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292115277.png" alt="image-20230429211545225" style="zoom:35%;">
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://martinfowler.com/bliki/CircuitBreaker.html">https://martinfowler.com/bliki/CircuitBreaker.html</a></p>
<p><code>半开启状态</code>： 比如说一个微服能承受100的并发量，某一时刻有500人同时访问。该服务就会崩掉，熔断，直接down掉。</p>
<p>外部此时不能访问了，过了一会，发现没有那么高的并发量了。</p>
<p>感觉并发量在可以承受之内，那么就试着放开这些并发请求。 直到发现能够适应当前的并发量了，再把闸道合上。 持续放开请求的状态就是半开状态，然后再把断路器   开启  变成关闭的状态。</p>
<h4 id="2、Hystrix服务熔断案例">2、Hystrix服务熔断案例</h4>
<h6 id="对8001服务端的Service层进行改造-增加熔断机制">对8001服务端的Service层进行改造 增加熔断机制</h6>
<ul>
<li>
<p><strong>circuitBreaker.enabled</strong>：是否开启断路器</p>
</li>
<li>
<p><strong>circuitBreaker.requestVolumeThreshold</strong>：请求次数；该属性设置滚动窗口（快照时间窗口，默认10s）中将使断路器跳闸的最小请求数量（默认是20），如果10s内请求数小于设定值，就算请求全部失败也不会触发断路器。</p>
</li>
<li>
<p><strong>circuitBreaker.sleepWindowInMilliseconds</strong>：时间窗口期；短路多久以后开始尝试是否恢复，默认5s</p>
</li>
<li>
<p><strong>circuitBreaker.errorThresholdPercentage</strong>：失败率达到多少后跳闸</p>
</li>
<li>
<p><strong>metrics.rollingStats.timeInMilliseconds</strong>：快照时间窗、滚动窗口</p>
</li>
</ul>
<p>总的意思就是在10s的时间窗口期内，m次请求中有p%的请求失败了，那么断路器启动，随后短路n秒后开始尝试恢复</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//=============================服务熔断===============================</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentCircuitBreaker_fallback&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;), //是否开启断路器</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;10&quot;),  //最小请求次数</span></span><br><span class="line"><span class="meta">    //短路多久以后开始尝试是否恢复，默认5s</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;),  // 时间窗口期</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;)  //失败率达到多少后跳闸</span></span><br><span class="line"><span class="meta">&#125;)</span>   <span class="comment">//总的意思就是在n毫秒内的时间窗口期内，m次请求中有p%的请求失败了，那么断路器启动</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(id &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;******id 不能负数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">serialNumber</span> <span class="operator">=</span> IdUtil.simpleUUID();  <span class="comment">//等价于UUID.randomUUID().toString()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Thread.currentThread().getName()+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;调用成功，流水号: &quot;</span> + serialNumber;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker_fallback</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;id 不能负数，请稍后再试，/(ㄒoㄒ)/~~   id: &quot;</span> +id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="修改模块cloud-provider-hystrix-payment8001的controller层">修改模块cloud-provider-hystrix-payment8001的controller层</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//===================服务熔断====================</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/payment/circuit/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.paymentCircuitBreaker(id);</span><br><span class="line">    log.info(<span class="string">&quot;****result: &quot;</span>+result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="测试-4">测试</h5>
<h6 id="正确跟错误情况自测">正确跟错误情况自测</h6>
<p>启动7001、7002（我这里启动了Eureka集群）和8001</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/payment/circuit/-5">http://localhost:8001/payment/circuit/-5</a>     <a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/payment/circuit/5">http://localhost:8001/payment/circuit/5</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632741888213-efd41d0b-7e9d-4188-bdfa-100e16b39861.png" alt><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632741896327-da99210f-9271-4d3d-bb8a-5f8de3d3ebc2.png" alt></p>
<h6 id="测试熔断机制">测试熔断机制</h6>
<p>测试一下单位时间请求达到10次/10s以上，在10s内执行了超过10*0.6 = 6次的异常请求，随后进行短路。（10个/10s 注意分母是10s。 默认20个/10s）</p>
<p>短路10s后尝试恢复<code>@HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;10&quot;)</code>     触发了Hystrix的断路器，即使传入正确的参数，也出现服务降级</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291832136.png" alt></p>
<p>隔了一会才恢复</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632742190703-432d76bb-a252-481e-a4e2-d335d8af50e1.png" alt></p>
<h5 id="Hystrix服务熔断总结">Hystrix服务熔断总结</h5>
<h6 id="熔断类型">熔断类型</h6>
<ul>
<li>
<p>熔断打开：</p>
<ul>
<li>请求不再进行调用当前服务，再有请求调用时将不会调用主逻辑，而是直接调用降级fallback。</li>
<li>实现了自动的发现错误并将降级逻辑切换为主逻辑，减少响应延迟效果。</li>
<li>内部设置时钟一般为MTTR（Mean time to repair，平均故障处理时间)，当打开时长达到所设时钟则进入半熔断状态。</li>
</ul>
</li>
<li>
<p>熔断关闭：熔断关闭不会对服务进行熔断，服务正常调用</p>
</li>
<li>
<p>熔断半开启：部分请求根据规则调用当前服务，如果请求成功且符合规则 就 认为当前服务恢复正常，关闭熔断</p>
</li>
</ul>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632751342847-1e2bd8e0-23e6-4fa2-9b4d-7dc6ffb4c87a.png" alt="img" style="zoom: 50%;">
<h6 id="断路器在什么情况下开始起作用">断路器在什么情况下开始起作用</h6>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632752836555-37da9fe7-81c3-4164-a2d3-d6477ecee547.png" alt="img" style="zoom:50%;">
<p>涉及到断路器的四个重要参数：<strong>快照时间窗、请求总数阀值、窗口睡眠时间、错误百分比阀值</strong>。</p>
<ul>
<li>
<p>1：<strong>快照时间窗（滚动窗口）</strong>：断路器确定是否打开需要统计一些请求和错误数据，而<code>统计的时间范围就是快照时间窗</code>，默认为最近的10秒。</p>
<ul>
<li>对应红框中的<strong>metrics.rollingStats.timeInMilliseconds</strong></li>
</ul>
</li>
<li>
<p>2：<strong>请求总数阀值</strong>：在快照时间窗内，必须满足<code>请求总数阀值</code>才有资格熔断。默认为20，意味着在10秒内，如果该hystrix命令的调用次数不足20次，即使所有的请求都超时或其他原因失败，断路器都不会打开。</p>
<ul>
<li>对应红框中的<strong>circuitBreaker.requestVolumeThreshold</strong></li>
</ul>
</li>
<li>
<p>3：<strong>窗口睡眠时间</strong>：<code>表示窗口睡眠时间</code>，即断路器触发多少秒（默认5s）后尝试恢复，进入半开状态。</p>
<ul>
<li>对应红框中的<strong>circuitBreaker.sleepWindowInMilliseconds</strong></li>
</ul>
</li>
<li>
<p>4：<strong>错误百分比阀值</strong>：当请求总数在快照时间窗内超过了阀值，比如发生了30次调用，如果在这30次调用中，有15次发生了超时异常，也就是超过50%的错误百分比，在默认设定50%阀值情况下，这时候就会将断路器打开。</p>
<ul>
<li>对应红框中的<strong>circuitBreaker.errorThresholdPercentage</strong></li>
</ul>
</li>
</ul>
<h6 id="断路器开启或关闭条件">断路器开启或关闭条件</h6>
<p>1、当满足一定的阈值的时候（默认10秒内超过20个请求次数）；</p>
<p>2、当失败率达到一定的时候（默认10秒内超过50%的请求失败）；</p>
<p>到达以上阈值，断路器将会开启；</p>
<p>当开启的时候，所有请求都不会进行转发；</p>
<p>一段时间之后（默认是5秒），这个时候断路器是半开状态，会让其中一个请求进行转发；如果成功，断路器会关闭，若失败，继续开启。重复4和5。</p>
<h6 id="断路器打开之后">断路器打开之后</h6>
<p><strong>1： 再有请求调用的时候，还会调用主逻辑吗？</strong></p>
<p>不会调用主逻辑，而是直接调用降级的fallback方法，通过断路器，实现了自动的发现错误  并将  降级逻辑升级为主逻辑，减少响应延迟的效果。</p>
<p><strong>2：原来的主逻辑要如何恢复？</strong></p>
<ul>
<li>
<p>hystrix也为我们实现了<code>自动恢复功能</code></p>
<p>当断路器打开，对主逻辑进行熔断之后，hystrix会启动一个休眠时间窗，在这个时间窗内，降级逻辑是临时的成为主逻辑。</p>
<p>当休眠时间窗到期，断路器将进入半开状态，释放给一次请求到原来的主逻辑上，如果此次请求正常返回，那么断路器将继续闭合。</p>
<p>主逻辑恢复，如果这次请求依然有问题，断路器继续进入打开状态，休眠时间窗重新计时</p>
</li>
</ul>
<h6 id="hystrix所有的配置-拓展">hystrix所有的配置&lt;拓展&gt;</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//========================All</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;str_fallbackMethod&quot;,</span></span><br><span class="line"><span class="meta">        groupKey = &quot;strGroupCommand&quot;,</span></span><br><span class="line"><span class="meta">        commandKey = &quot;strCommand&quot;,</span></span><br><span class="line"><span class="meta">        threadPoolKey = &quot;strThreadPool&quot;,</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">        commandProperties = &#123;</span></span><br><span class="line"><span class="meta">                // 设置隔离策略，THREAD 表示线程池 SEMAPHORE：信号池隔离</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;execution.isolation.strategy&quot;, value = &quot;THREAD&quot;),</span></span><br><span class="line"><span class="meta">                // 当隔离策略选择信号池隔离的时候，用来设置信号池的大小（最大并发数）</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;execution.isolation.semaphore.maxConcurrentRequests&quot;, value = &quot;10&quot;),</span></span><br><span class="line"><span class="meta">                // 配置命令执行的超时时间</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;execution.isolation.thread.timeoutinMilliseconds&quot;, value = &quot;10&quot;),</span></span><br><span class="line"><span class="meta">                // 是否启用超时时间</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;execution.timeout.enabled&quot;, value = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">                // 执行超时的时候是否中断</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;execution.isolation.thread.interruptOnTimeout&quot;, value = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">                // 执行被取消的时候是否中断</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;execution.isolation.thread.interruptOnCancel&quot;, value = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">                // 允许回调方法执行的最大并发数</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;fallback.isolation.semaphore.maxConcurrentRequests&quot;, value = &quot;10&quot;),</span></span><br><span class="line"><span class="meta">                // 服务降级是否启用，是否执行回调函数</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;fallback.enabled&quot;, value = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">                // 是否启用断路器</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;, value = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">                // 该属性用来设置在滚动时间窗中，断路器熔断的最小请求数。例如，默认该值为 20 的时候，</span></span><br><span class="line"><span class="meta">                // 如果滚动时间窗（默认10秒）内仅收到了19个请求， 即使这19个请求都失败了，断路器也不会打开。</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;, value = &quot;20&quot;),</span></span><br><span class="line"><span class="meta">                // 该属性用来设置在滚动时间窗中，表示在滚动时间窗中，在请求数量超过</span></span><br><span class="line"><span class="meta">                // circuitBreaker.requestVolumeThreshold 的情况下，如果错误请求数的百分比超过50,</span></span><br><span class="line"><span class="meta">                // 就把断路器设置为 &quot;打开&quot; 状态，否则就设置为 &quot;关闭&quot; 状态。</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;, value = &quot;50&quot;),</span></span><br><span class="line"><span class="meta">                // 该属性用来设置当断路器打开之后的休眠时间窗。 休眠时间窗结束之后，</span></span><br><span class="line"><span class="meta">                // 会将断路器置为 &quot;半开&quot; 状态，尝试熔断的请求命令，如果依然失败就将断路器继续设置为 &quot;打开&quot; 状态，</span></span><br><span class="line"><span class="meta">                // 如果成功就设置为 &quot;关闭&quot; 状态。</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;circuitBreaker.sleepWindowinMilliseconds&quot;, value = &quot;5000&quot;),</span></span><br><span class="line"><span class="meta">                // 断路器强制打开</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;circuitBreaker.forceOpen&quot;, value = &quot;false&quot;),</span></span><br><span class="line"><span class="meta">                // 断路器强制关闭</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;circuitBreaker.forceClosed&quot;, value = &quot;false&quot;),</span></span><br><span class="line"><span class="meta">                // 滚动时间窗设置，该时间用于断路器判断健康度时需要收集信息的持续时间</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;metrics.rollingStats.timeinMilliseconds&quot;, value = &quot;10000&quot;),</span></span><br><span class="line"><span class="meta">                // 该属性用来设置滚动时间窗统计指标信息时划分&quot;桶&quot;的数量，断路器在收集指标信息的时候会根据</span></span><br><span class="line"><span class="meta">                // 设置的时间窗长度拆分成多个 &quot;桶&quot; 来累计各度量值，每个&quot;桶&quot;记录了一段时间内的采集指标。</span></span><br><span class="line"><span class="meta">                // 比如 10 秒内拆分成 10 个&quot;桶&quot;收集这样，所以 timeinMilliseconds 必须能被 numBuckets 整除。否则会抛异常</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;metrics.rollingStats.numBuckets&quot;, value = &quot;10&quot;),</span></span><br><span class="line"><span class="meta">                // 该属性用来设置对命令执行的延迟是否使用百分位数来跟踪和计算。如果设置为 false, 那么所有的概要统计都将返回 -1。</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;metrics.rollingPercentile.enabled&quot;, value = &quot;false&quot;),</span></span><br><span class="line"><span class="meta">                // 该属性用来设置百分位统计的滚动窗口的持续时间，单位为毫秒。</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;metrics.rollingPercentile.timeInMilliseconds&quot;, value = &quot;60000&quot;),</span></span><br><span class="line"><span class="meta">                // 该属性用来设置百分位统计滚动窗口中使用 “ 桶 ”的数量。</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;metrics.rollingPercentile.numBuckets&quot;, value = &quot;60000&quot;),</span></span><br><span class="line"><span class="meta">                // 该属性用来设置在执行过程中每个 “桶” 中保留的最大执行次数。如果在滚动时间窗内发生超过该设定值的执行次数，</span></span><br><span class="line"><span class="meta">                // 就从最初的位置开始重写。例如，将该值设置为100, 滚动窗口为10秒，若在10秒内一个 “桶 ”中发生了500次执行，</span></span><br><span class="line"><span class="meta">                // 那么该 “桶” 中只保留 最后的100次执行的统计。另外，增加该值的大小将会增加内存量的消耗，并增加排序百分位数所需的计算时间。</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;metrics.rollingPercentile.bucketSize&quot;, value = &quot;100&quot;),</span></span><br><span class="line"><span class="meta">                // 该属性用来设置采集影响断路器状态的健康快照（请求的成功、 错误百分比）的间隔等待时间。</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;metrics.healthSnapshot.intervalinMilliseconds&quot;, value = &quot;500&quot;),</span></span><br><span class="line"><span class="meta">                // 是否开启请求缓存</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;requestCache.enabled&quot;, value = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">                // HystrixCommand的执行和事件是否打印日志到 HystrixRequestLog 中</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;requestLog.enabled&quot;, value = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        &#125;,</span></span><br><span class="line"><span class="meta">        threadPoolProperties = &#123;</span></span><br><span class="line"><span class="meta">                // 该参数用来设置执行命令线程池的核心线程数，该值也就是命令执行的最大并发量</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;coreSize&quot;, value = &quot;10&quot;),</span></span><br><span class="line"><span class="meta">                // 该参数用来设置线程池的最大队列大小。当设置为 -1 时，线程池将使用 SynchronousQueue 实现的队列，</span></span><br><span class="line"><span class="meta">                // 否则将使用 LinkedBlockingQueue 实现的队列。</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;maxQueueSize&quot;, value = &quot;-1&quot;),</span></span><br><span class="line"><span class="meta">                // 该参数用来为队列设置拒绝阈值。 通过该参数， 即使队列没有达到最大值也能拒绝请求。</span></span><br><span class="line"><span class="meta">                // 该参数主要是对 LinkedBlockingQueue 队列的补充,因为 LinkedBlockingQueue</span></span><br><span class="line"><span class="meta">                // 队列不能动态修改它的对象大小，而通过该属性就可以调整拒绝请求的队列大小了。</span></span><br><span class="line"><span class="meta">                @HystrixProperty(name = &quot;queueSizeRejectionThreshold&quot;, value = &quot;5&quot;),</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">strConsumer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello 2020&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">str_fallbackMethod</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;*****fall back str_fallbackMethod&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="六、服务限流"><em>六、服务限流</em></h3>
<p>见  spring cloud alibaba Sentinel  时再说！</p>
<h3 id="七、Hystrix工作流程">七、Hystrix工作流程</h3>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Netflix/Hystrix/wiki/How-it-Works">https://github.com/Netflix/Hystrix/wiki/How-it-Works</a></p>
<h5 id="工作流程图">工作流程图</h5>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632753962812-5995b053-e5d5-438a-8310-190ccaff6852.png" alt></p>
<h5 id="步骤说明">步骤说明</h5>
<table>
<thead>
<tr>
<th style="text-align:center">图中步骤</th>
<th style="text-align:left">步骤</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:left">创建 HystrixCommand（用在依赖的服务返回单个操作结果的时候）                                                                                                                                                                 或                                                                                                                                                                                                         HystrixObserableCommand（用在依赖的服务返回多个操作结果的时候） 对象。</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:left">命令执行。                                                                                                                                                                                                                                                          其中 HystrixComand 实现了下面前两种执行方式；                                                                                                                                                                 execute()：同步执行，从依赖的服务返回一个单一的结果对象， 或是在发生错误的时候抛出异常。                                                                               queue()：异步执行， 直接返回 一个Future对象， 其中包含了服务执行结束时要返回的单一结果对象。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          而 HystrixObservableCommand 实现了后两种执行方式observe()：                                                                                                                                                              返回 Observable 对象，它代表了操作的多个结果，它是一个 Hot Obserable                                                                                                                                                              （不论 “事件源” 是否有 “订阅者”，都会在创建后对事件进行发布，                                                                                                                                                              所以对于 Hot Observable 的每一个 “订阅者” 都有可能是从 “事件源” 的中途开始的，                                                                                                                                                                                                                                             并可能只是看到了整个操作的局部过程）。                                                                                                                                                             toObservable()： 同样会返回 Observable 对象，也代表了操作的多个结果，但它返回的是一个Cold Observable                                                                               （没有 “订阅者” 的时候并不会发布事件，而是进行等待，                                                                                                                                                              直到有 “订阅者” 之后才发布事件，所以对于 Cold Observable 的订阅者，                                                                                                                                                              它可以保证从一开始看到整个操作的全部过程）。</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:left">若当前命令的请求缓存功能是被启用的，                                                                                                                                                                                                                                              并且该命令缓存命中， 那么缓存的结果会立即以 Observable 对象的形式 返回。</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:left">检查断路器是否为打开状态。                                                                                                                                                                                                                                             如果断路器是打开的，那么Hystrix不会执行命令，而是转接到 fallback 处理逻辑（第 8 步）；                                                                                                                                                                                                                                             如果断路器是关闭的，检查是否有可用资源来执行命令（第 5 步）。</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:left">线程池/请求队列/信号量是否占满。                                                                                                                                                                                                                                             如果命令依赖服务的专有线程池和请求队列，                                                                                                                                                                                                                                                                                                                                                                                                           或者信号量（不使用线程池的时候）已经被占满， 那么 Hystrix 也不会执行命令， 而是转接到 fallback 处理逻辑（第8步）。</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:left">Hystrix 会根据我们编写的方法来决定采取什么样的方式去请求依赖服务。HystrixCommand.run() ：返回一个单一的结果，或者抛出异常。HystrixObservableCommand.construct()： 返回一个Observable 对象来发射多个结果，或通过 onError 发送错误通知。</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:left">Hystrix会将 “成功”、“失败”、“拒绝”、“超时” 等信息报告给断路器，                                                                                                                                                                                                                                                                                                                                                                                                            而断路器会维护一组计数器来统计这些数据 。                                                                                                                                                                                                                                             断路器会使用这些统计数据来决定是否要将断路器打开，来对某个依赖服务的请求进行 “熔断/短路”。</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:left">当命令执行失败的时候， Hystrix 会进入 fallback 尝试回退处理， 我们通常也称该操作为 “服务降级”。                                                                                                                                                              而能够引起服务降级处理的情况有下面几种：                                                                                                                                                                                                                                             第4步： 当前命令处于&quot;熔断/短路&quot;状态，断路器是打开的时候。                                                                                                                                                                                                                                             第5步： 当前命令的线程池、 请求队列或 者信号量被占满的时候。                                                                                                                                                              第6步：HystrixObservableCommand.construct() 或 HystrixCommand.run() 抛出异常的时候。</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:left">当Hystrix命令执行成功之后， 它会将处理结果直接返回或是以Observable 的形式返回。</td>
</tr>
</tbody>
</table>
<p>tips：如果我们没有为命令实现降级逻辑或者在降级处理逻辑中抛出了异常， Hystrix 依然会返回一个 Observable 对象， 但是它不会发射任何结果数据， 而是通过 <code>onError() </code>方法通知命令立即中断请求，并通过<code>onError()</code>方法将引起命令失败的异常发送给调用者。</p>
<h3 id="八、服务监控-HystrixDashBoard">八、服务监控 HystrixDashBoard</h3>
<p>除了隔离依赖服务的调用以外，Hystrix还提供了准实时的调用监控（Hystrix Dashboard）</p>
<p>Hystrix会持续的记录所有通过Hystrix发起的请求的执行信息，并以统计报表和图形的形式展示给用户，包括<strong>每秒执行多少请求多少成功，多少失败</strong>等，</p>
<p>Netflix通过<code>hystrix-metrics-event-stream</code>项目实现了对以上指标的监控，</p>
<p>Spring Cloud提供了Hystrix Dashboard的整合，对监控内容转化成可视化页面。</p>
<h4 id="新建cloud-consumer-hystrix-dashboard9001">新建cloud-consumer-hystrix-dashboard9001</h4>
<p><strong>五步走</strong></p>
<p>==主启动类==</p>
<p>HystrixDashboardMain9001+新注解**@EnableHystrixDashboard**</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span> <span class="comment">// 开启Hystrix仪表盘</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HystrixDashboardMain9001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HystrixDashboardMain9001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="所有provider微服务（生产者）提供类8001-8002-8003都需要监控依赖配置">所有provider微服务（生产者）提供类8001/8002/8003都需要监控依赖配置</h4>
<p>确保所有生产者微服务中均包含<strong>spring-boot-starter-actuator</strong>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="启动测试">启动测试</h4>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9001/hystrix">http://localhost:9001/hystrix</a></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292157242.png" alt="image-20230429215727091" style="zoom:25%;">
<h4 id="断路器演示-服务监控hystrixDashboard">断路器演示(服务监控hystrixDashboard)</h4>
<p><code>微服务想要被监控必须要有spring-boot-starter-actuator依赖</code></p>
<h5 id="注意事项">注意事项</h5>
<p>注意:新版本Hystrix需要在需要监控的微服务端的主启动类中指定监控路径，不然会报错：</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/12374561/1617857687374-16f965d1-6a21-4ace-b2eb-d785400e8d3a.png" alt="img" style="zoom:45%;">
<p>在被监控的服务端主启动类中添加以下代码，这里以<code>PaymentHystrixMain8001</code>为示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span>  <span class="comment">//本服务启动后会自动注册进eureka服务中</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span>  <span class="comment">//对hystrixR熔断机制的支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentHystrixMain8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentHystrixMain8001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ======================================需要添加的代码==================</span></span><br><span class="line"><span class="comment">     *此配置是为了服务监控而配置，与服务容错本身无关，springcloud升级后的坑</span></span><br><span class="line"><span class="comment">     *ServletRegistrationBean因为springboot的默认路径不是&quot;/hystrix.stream&quot;，</span></span><br><span class="line"><span class="comment">     *只要在自己的项目里配置上下面的servlet就可以了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServletRegistrationBean <span class="title function_">getServlet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HystrixMetricsStreamServlet</span> <span class="variable">streamServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HystrixMetricsStreamServlet</span>();</span><br><span class="line">        <span class="type">ServletRegistrationBean</span> <span class="variable">registrationBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRegistrationBean</span>(streamServlet);</span><br><span class="line">        registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        registrationBean.addUrlMappings(<span class="string">&quot;/hystrix.stream&quot;</span>);</span><br><span class="line">        registrationBean.setName(<span class="string">&quot;HystrixMetricsStreamServlet&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="测试-5">测试</h5>
<ul>
<li>启动Eureka7001、Eureka7002（我这里用的是两个Eureka的集群，视频里是单个）、8001、9001</li>
<li>9001监控8001</li>
</ul>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632795076911-ffb941c2-e19a-4aaa-9dde-4b4e840770b2.png" alt="img" style="zoom:33%;">
<ul>
<li>自测8001端口：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/payment/circuit/-5,http://localhost:8001/payment/circuit/5">http://localhost:8001/payment/circuit/-5,http://localhost:8001/payment/circuit/5</a></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632796042132-149f09ce-3002-4932-abbe-5cb785261601.png" alt><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632796050920-aea45d39-ea5e-47be-a991-2e4b17950cf1.png" alt></p>
<ul>
<li>打开监控页面</li>
</ul>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632795741344-c355fb69-0f1a-45fe-ab20-36457e020114.png" alt="img" style="zoom:50%;">
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291832587.png" alt></p>
<ul>
<li>多次刷新<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/payment/circuit/5">http://localhost:8001/payment/circuit/5</a>
<ul>
<li>圆圈变大了，折线上升，表示请求数量变多，因为请求都是正常的，所以断路器处于关闭状态</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632796121692-2c1edcb8-d6a3-4e59-a5bd-790a14f04bf5.png" alt></p>
<ul>
<li>类似的，多次刷新<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/payment/circuit/-5">http://localhost:8001/payment/circuit/-5</a>
<ul>
<li>可以看到断路器处于开启状态</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632796267798-c19d0db4-9308-4ec6-b6ee-a7e6996a3685.png" alt></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292212284.png" alt="image-20230429221200236" style="zoom:23%;">
<h5 id="监控页的各个地方表示什么意思？">监控页的各个地方表示什么意思？</h5>
<p>7种颜色1个圈</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291832631.png" alt="img" style="zoom:50%;">
<p>实心圆：共有两种含义。它通过颜色的变化代表了实例的健康程度，它的健康度从绿色&lt;黄色&lt;橙色&lt;红色递减。</p>
<p>该实心圆除了颜色的变化之外，它的大小也会根据实例的请求流量发生变化，流量越大该实心圆就越大。所以通过该实心圆的展示，就可以在大量的实例中快速的发现故障实例和高压力实例。</p>
<p>曲线：用来记录2分钟内流量的相对变化，可以通过它来观察到流量的上升和下降趋势。</p>
<p>图片说明：</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632796657189-31177fb5-7a9c-438e-8fef-908e4e65dcb1.png" alt="img" style="zoom: 50%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304291832634.png" alt="img" style="zoom:50%;">
<h2 id="6、API网关服务">6、API网关服务</h2>
<h3 id="一、Gateway概述">一、Gateway概述</h3>
<p>官网：</p>
<p>上一代zuul 1.X   <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Netflix/zuul/wiki">https://github.com/Netflix/zuul/wiki</a></p>
<p>当前gateway ： <a target="_blank" rel="noopener external nofollow noreferrer" href="https://spring.io/projects/spring-cloud-gateway#learn">最新版</a> ，<a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/">2.2.1.RELEASE</a></p>
<h4 id="1、Gateway是什么">1、Gateway是什么</h4>
<p>Cloud全家桶中有个很重要的组件就是网关，在1.x版本中都是采用Zuul网关；</p>
<p>现在使用的就是 SpringCloud Gateway  ，gateway是zuul 1.x版本的替代</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632809950569-9d0e8382-c673-4191-9245-299a2ff4f767.png" alt="img" style="zoom:25%;">
<p>Gateway是在Spring生态系统之上架构的API网关服务，基于Spring 5,Spring Boot2 和Project Reactor技术。</p>
<p>Gateway旨在提供一种简单而有效的方式来对API进行路由，以及提供一些强大的过滤器功能，例如：熔断、限流、重试等。</p>
<h5 id="1-1-概述">1.1 概述</h5>
<ul>
<li>SpringCloud Gateway 是 Spring Cloud 的一个全新项目，基于 Spring 5.0+Spring Boot 2.0 和 Project Reactor 等技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。</li>
<li>SpringCloud Gateway作为Spring cloud生态系统中的网关，目标是代替 Zuul，在SpringCloud2.0以上版本中，没有对新版本的Zuul 2.0以上实现最新高性能版本进行集成，仍然还是使用的Zuul 1.x非Reactor模式的老版本。而为了提升网关的性能，SpringCloud Gateway是基于WebFlux框架实现的，而WebFlux框架底层则使用了高性能的Reactor模式通信框架Netty，【就是说：  SpringCloud Gateway是<code>异步非阻塞式</code>，响应式的框架】</li>
<li>Spring Cloud Gateway的目标提供统一的路由方式且基于 Filter 链的方式提供了网关基本的功能，例如：安全，监控/指标，和限流。</li>
</ul>
<blockquote>
<p><strong>一句话</strong>：SpringCloud Gateway 使用的Webflux中的reactor-netty响应式编程组件，底层使用了Netty通讯框架。</p>
<p><strong>源码架构</strong>：</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292247123.png" alt="img" style="zoom:53%;">
</blockquote>
<h4 id="2、-能干嘛">2、 能干嘛</h4>
<p>反向代理、鉴权、流量控制、熔断、日志监控等</p>
<h4 id="3、微服务架构中网关在哪里">3、微服务架构中网关在哪里</h4>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632810706535-71a5e3e9-f84c-4543-9bbe-5da3d0c070e2.png" alt></p>
<h4 id="4、为什么选择gateway？">4、为什么选择gateway？</h4>
<p>一方面因为Zuul1.0已经进入了维护阶段，同时Zuul2.0疯狂跳票。而且Gateway是SpringCloud团队研发的，是亲儿子产品，值得信赖。</p>
<p>而且很多功能Zuul都没有，Gateway用起来也非常的简单便捷。</p>
<p>Gateway是基于异步非阻塞模型上进行开发的，性能方面不需要担心。</p>
<h5 id="4-1-SpringCloud-Gateway具有如下特性">4.1 SpringCloud Gateway具有如下特性</h5>
<ul>
<li>基于Spring5 ,Project Reactor 和 SpringBoot 2.0进行构建；</li>
<li>动态路由：能够匹配任何请求属性</li>
<li>可以对路由指定Predicate(断言)和Filter（过滤器）</li>
<li>集成Hystrix的断路器功能；</li>
<li>集成Spring Cloud的服务发现功能</li>
<li>易于编写的Predicate（断言）和Filter（过滤器）</li>
<li>请求限流功能；</li>
<li>支持路径重写</li>
</ul>
<h5 id="4-2-SpringCloud-Gateway-与-Zuul的区别">4.2 SpringCloud Gateway 与 Zuul的区别</h5>
<p>在SpringCloud Finchley 正式版之前（现在H版），SpringCloud推荐的网关是Netflix提供的zuul。</p>
<ol>
<li>
<p>Zuul1.x 是一个基于阻塞 I/O的API网关</p>
</li>
<li>
<p>Zuul1.x 基于Servlet2.5使用阻塞架构它不支持任何长连接 （如WebSocket）Zuul的设计模式和Nginx较像，每次I/O操作都是从工作线程中选择一个执行，请求线程被阻塞到工作线程完成，但是差别是Nginx用C++实现，Zuul用java实现，而JVM本身会有第一次加载较慢的情况，使得Zuul的性能相对较差。</p>
</li>
<li>
<p>Zuul 2.x理念更加先进，像基于Netty非阻塞和支持长连接，但SpringCloud目前还没有整合。Zuul2.x的性能较Zuul 1.x有较大的提升。在性能方面，根据官方提供的基准测试，Spring Cloud Gateway的RPS（每秒请求次数）是Zuul的1.6倍。</p>
</li>
<li>
<p>Spring Cloud Gateway建立在Spring Framework 5、project Reactor和Spring Boot2 之上，使用非阻塞API</p>
</li>
<li>
<p>Spring Cloud Gateway 还支持WebSocket，并且与Spring紧密集成拥有更好的开发体验。</p>
</li>
</ol>
<h4 id="5、Zuul1-x模型">5、Zuul1.x模型</h4>
<p>Springcloud中所集成的Zuul版本，采用的是Tomcat容器，使用的是传统的Servlet IO处理模型。</p>
<p>Servlet的生命周期?servlet由servlet container进行生命周期管理。</p>
<p>container启动时构造servlet对象并调用servlet init()进行初始化；</p>
<p>container运行时接受请求，并为每个请求分配一个线程（一般从线程池中获取空闲线程）然后调用service()。</p>
<p>container关闭时调用servlet destory()销毁servlet；</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292247245.png" alt></p>
<p><strong>上述模式的缺点：</strong></p>
<p>servlet是一个简单的网络IO模型，当请求进入servlet container时，servlet container就会为其绑定一个线程，在并发不高的场景下这种模型是适用的。但是一旦高并发(比如抽风用jemeter压)，线程数量就会上涨，而线程资源代价是昂贵的（上线文切换，内存消耗大）严重影响请求的处理时间。在一些简单业务场景下，不希望为每个request分配一个线程，只需要1个或几个线程就能应对极大并发的请求，这种业务场景下servlet模型没有优势</p>
<p>所以Zuul 1.X是基于servlet之上的一个阻塞式处理模型，即spring实现了处理所有request请求的一个servlet（DispatcherServlet）并由该servlet阻塞式处理处理。所以Springcloud Zuul无法摆脱servlet模型的弊端</p>
<h4 id="6、gateway模型">6、gateway模型</h4>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-new-framework">https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-new-framework</a></p>
<p>传统的Web框架，比如说：struts2，springmvc等都是基于Servlet API与Servlet容器基础之上运行的。</p>
<p>但是</p>
<p>在Servlet3.1之后有了异步非阻塞的支持。</p>
<p>而WebFlux是一个典型非阻塞异步的框架，它的核心是基于Reactor的相关API实现的。</p>
<p>相对于传统的web框架来说，它可以运行在诸如Netty，Undertow及支持Servlet3.1的容器上。</p>
<p>非阻塞式+函数式编程（Spring5必须让你使用java8）</p>
<p>Spring WebFlux 是 Spring 5.0 引入的新的响应式框架，区别于 Spring MVC，它不需要依赖Servlet API，它是完全异步非阻塞的，并且基于 Reactor 来实现响应式流规范。</p>
<h3 id="二、Gateway的三大核心概念与工作流程">二、Gateway的三大核心概念与工作流程</h3>
<h4 id="1、Route-路由">1、Route(路由)</h4>
<p>路由是构建网关的基本模块，它由ID，目标URI（Uniform Resource Identifier，统一资源标识符），一系列的断言和过滤器组成，如果断言为true则匹配该路由。</p>
<h4 id="2、Predicate-断言">2、Predicate(断言)</h4>
<p>开发人员可以匹配Http请求中的所有内容（例如请求头或者请求参数），如果请求参数与断言相匹配则进行路由。</p>
<h4 id="3、Filter-过滤">3、Filter(过滤)</h4>
<p>指的是Spring框架中的  <code>GatewayFilter</code> 的实例，使用过滤器，可以在请求  被路由前或者之后对请求进行  修改。</p>
<h4 id="4、总结">4、总结</h4>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632811965373-bba8c0f8-c6ed-4fbb-97d0-796f73410f6c.png" alt></p>
<ul>
<li>web 请求，通过一些匹配条件，定位到真正的服务节点，并在这个转发过程的前后，进行一些精细化控制</li>
<li>predicate 就是我们的匹配条件</li>
<li>filter：就可以理解为一个无所不能的拦截器，有了这两个元素，再加上目标的uri，就可以实现一个具体的路由了。</li>
</ul>
<h3 id="三、工作流程-原理">三、工作流程/原理</h3>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305131100584.png" alt="image-20230513105923489" style="zoom:33%;">
<ul>
<li>客户端向 Spring Cloud Gateway 发出请求。然后在 Gateway Handler Mapping 中找到与请求相匹配的路由，将其发送到 Gateway Web Handler。</li>
<li>Handler 再通过指定的过滤器链来将请求发送到我们实际的服务执行业务逻辑，然后返回。</li>
<li>过滤器之间用虚线分开是因为过滤器可能会在发送代理请求之前（“pre”）或之后（“post”）执行业务逻辑。</li>
<li>Filter在“pre”类型的过滤器可以做参数校验、权限校验、流量监控、日志输出、协议转换等，在“post”类型的过滤器中可以做响应内容、响应头的修改，日志的输出，流量监控等有着非常重要的作用。</li>
</ul>
<p><strong>核心逻辑</strong>：<code>路由转发+执行过滤器链</code></p>
<h3 id="四、路由引出">四、路由引出</h3>
<h5 id="cloud-gateway-gateway-9527">cloud-gateway-gateway-9527</h5>
<p>1、创建cloud-gateway-gateway-9527 模块</p>
<p>2、pom</p>
<p>做网关不需要添加  web starter  否则会报错</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-gateway-gateway-9527<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--gateway--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--一般基础配置类--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3、yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment">#服务提供者provider注册进eureka服务列表内</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#      defaultZone: http://eureka7001.com:7001/eureka # 单机版</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span> <span class="comment">#集群版</span></span><br></pre></td></tr></table></figure>
<p>4、主启动类(网关不需要业务类)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.srpingcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GateWayMain9527</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GateWayMain9527.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5、Gateaway9527网关如何做路由映射呢？</p>
<p>我们以前访问<code>cloud-provider-payment8001</code>中的controller方法,通过：</p>
<p><code>localhost:8001/payment/get/id </code> 和 <code>localhost:8001/payment/lb</code> 就能访问到相应的方法。</p>
<p>现在我们不想暴露8001端口号，希望在8001外面加一层9527</p>
<blockquote>
<p>yml新增网关配置</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line"><span class="comment">#=====================新增====================</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span>          <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span>         <span class="comment"># 断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span>          <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>         <span class="comment"># 断言，路径相匹配的进行路由</span></span><br><span class="line"><span class="comment">#===================================================</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment">#服务提供者provider注册进eureka服务列表内</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#      defaultZone: http://eureka7001.com:7001/eureka # 单机版</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span> <span class="comment">#集群版</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>routes</strong>：可以为controller中所有的rest接口做路由</li>
<li><strong>uri + predicate</strong>拼接：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/payment/get/">http://localhost:8001/payment/get/</a>** 就是具体的接口请求路径。其中uri是需要通过localhost:9527 映射的地址，即访问localhost:9527会<code>转发</code>到 localhost:8001</li>
<li><strong>predicate</strong>：断言http://localhost:8001下面有一个<code>/payment/get/**</code>这样的地址。
<ul>
<li>如果找到了这个地址就返回true，可以用9527端口访问，进行端口的适配；</li>
<li>找不到就返回false，不能用9527这个端口适配。</li>
<li>之后将不再暴露微服务本来的接口8001，转而使用统一网关9527。</li>
</ul>
</li>
</ul>
<p><code>/get/**</code> 中**表示通配符，因为这里是一个不确定的参数：/get/{id}</p>
<p>这样就为这两个方法做了路由匹配</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632815268348-1e0ea7e2-df01-4364-b93e-48e5f5483fea.png" alt></p>
<p>6、测试</p>
<p><code>启动7001、7002、cloud-provider-payment8001、9527</code></p>
<p><strong>踩坑提示</strong>：gateway不需要spring-boot-starter-web依赖，否在会报错；原因是gateway底层使用的是webflux会与web冲突。</p>
<p>eureka集群中注册了9527和payment8001</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292345925.png" style="zoom:33%;">
<p>直接通过8001访问：成功</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632815648958-716bee37-ee9e-4a81-a67f-a0b9b164b6f3.png" alt><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292247025.png" alt></p>
<p>通过9527网关访问：也可以成功</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632815725167-64418fce-db2d-433f-99f5-27ac2b377692.png" alt><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292247269.png" alt></p>
<p>7、Gateway网关路由有两种配置方式</p>
<p>​		7.1 在yml中配置——上面的方式</p>
<p>​		7.2 代码中注入RouteLocator的Bean</p>
<p>官网案例：</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632816227861-68d60508-b605-4b28-8763-5fc1e9ac48fe.png" alt="img" style="zoom: 67%;">
<p><strong>业务需求</strong>： 通过9527网关访问到百度新闻的网址；<a target="_blank" rel="noopener external nofollow noreferrer" href="http://news.baidu.com/guonei">http://news.baidu.com/guonei</a></p>
<p>在config包下创建一个配置类 路由规则是：我现在访问/guonei，将会转发到<a target="_blank" rel="noopener external nofollow noreferrer" href="http://news.baidu.com/guonei">http://news.baidu.com/guonei</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.srpingcloud.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置了一个id为path_route_atguigu的路由规则，</span></span><br><span class="line"><span class="comment">     * 当访问地址 http://localhost:9527/guonei  时会自动转发到地址：http://news.baidu.com/guonei</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">     <span class="comment">// routeLocatorBuilder  路由构建器</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">customRouteLocator</span><span class="params">(RouteLocatorBuilder routeLocatorBuilder)</span>&#123;</span><br><span class="line">        <span class="comment">//构建一个路由器，这个routes相当于yml配置文件中的routes</span></span><br><span class="line">        RouteLocatorBuilder.<span class="type">Builder</span> <span class="variable">routes</span> <span class="operator">=</span> routeLocatorBuilder.routes();</span><br><span class="line">        <span class="comment">//路由器的id是：path_route_atguigu，规则是我现在访问/guonei，将会转发到http://news.baidu.com/guonei</span></span><br><span class="line">        <span class="comment">// 这里的id、path、uri都可以跟yml中的配置对上</span></span><br><span class="line">        <span class="comment">// 通过localhost:9527 映射 http://news.baidu.com</span></span><br><span class="line">        routes.route(<span class="string">&quot;path_route_atguigu&quot;</span>,</span><br><span class="line">                r -&gt; r.path(<span class="string">&quot;/guonei&quot;</span>).uri(<span class="string">&quot;http://news.baidu.com&quot;</span>)).build();</span><br><span class="line">        <span class="keyword">return</span> routes.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与之对应的yml：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632818767233-06847f14-ef2e-49f9-be0c-97b0158718ce.png" alt></p>
<p>​		7.3 测试	访问localhost:9527/guonei</p>
<p>​					成功！</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632817007200-c9bee5d1-1afc-4bd4-96d3-7b654cafbfe9.png" alt="img" style="zoom:33%;">
<h3 id="五、路由进阶">五、路由进阶</h3>
<h4 id="通过微服务名实现动态路由">通过微服务名实现动态路由</h4>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632818997126-0ba4875b-d603-4146-a489-a1e7029c4114.png" alt></p>
<h4 id="5-1-目前面临的问题">5.1  目前面临的问题</h4>
<p>上面的一个路由规则仅仅只对应一个接口方法，是因为我们将请求地址写死了。</p>
<p>试想一下：在分布式集群的情况下，会有多少个主机，多少个端口，多少个接口？ 难道我们要为每一个接口都定义一个路由规则吗？</p>
<p>解决思路：我们前面用80调用8001和8002中的接口时，<code>只认微服务名</code>。访问接口时没有指定哪个端口。 那么我们在定义路由规则时<code>也可以</code>通过<code>微服务名</code>实现<code>动态路由和负载均衡</code>。</p>
<h4 id="5-2-修改9527实现动态路由">5.2 修改9527实现动态路由</h4>
<p>默认情况下Gateway会根据注册中心注册的服务列表，<code>以注册中心上微服务名</code>为路径创建动态路由进行转发，从而实现动态路由的功能。</p>
<p><strong>pom：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//之前已经添加过了</span></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p><strong>yml：</strong><code>spring.cloud.gateway.discovery.locator.enabled:true;</code></p>
<p>在添加uri的时候，开始是<code>lb:// </code>+ <code>微服务名</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启从注册中心动态创建路由的功能，利用微服务名进行路由</span></span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line"><span class="comment">#          uri: http://localhost:8001          #匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span>   <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span>         <span class="comment"># 断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line"><span class="comment">#          uri: http://localhost:8001          #匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span>  <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>         <span class="comment"># 断言，路径相匹配的进行路由</span></span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：</p>
<p><code>uri: lb://cloud-payment-service </code></p>
<p><code>lb://开头代表从注册中心中获取服务，后面接的就是你需要转发到的服务名称，而且找到的服务实现负载均衡。</code></p>
<p>配置好后的路由规则：</p>
<p>发送<code>localhost:9527/xx/xxx</code>请求，</p>
<p>先会去找 <code>cloud-payment-service</code>服务名中对应微服务实例。</p>
<p>再根据具体的路径，找的具体的方法接口，并且开启了负载均衡。</p>
<h4 id="5-3-测试">5.3 测试</h4>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a></p>
<p>8001、8002交替，负载均衡的轮循算法</p>
<h3 id="六、Predicate-断言的使用">六、Predicate 断言的使用</h3>
<p>我们注意：<code>Predicates </code>这是一个复数，其实有<code>多种Predicate</code>。 我们这里用的Predicate的是[Path]，它是路由规则的其中一个。</p>
<p>作用是 如果<code>cloud-payment-service</code> 的微服务实例中有<code>/payment/get**</code>的接口，就会返回true，路由规则生效。</p>
<p>但实际上存在多种Predicate：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292247510.png" alt></p>
<p>每一个断言Predicate都有它独特的规则，多个Predicate断言是一个  与&amp;  组合。</p>
<ul>
<li>Spring Cloud Gateway 将路由匹配作为Spring WebFlux Handler Mapping基础架构的一部分。</li>
<li>Spring Cloud Gateway 包括许多内置的Route Predicate 工厂，所有的这些Predicate都和Http请求的不同属性匹配，多个Route Predicate可以进行组合。</li>
<li>Spring Cloud Gateway 创建route对象时，使用RoutePredicateFactory创建Predicate对象，Predicate对象可以赋值给Route，SpringCloud Gateway包含许多内置的Route Predicate Factories.</li>
<li>所有的 这些谓词都匹配Http的请求的各种属性，多种谓词工厂可以组合，并通过逻辑and</li>
</ul>
<p>官网对gateway的断言每个都写了例子 :</p>
<p>​	<a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#the-after-route-predicate-factory">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#the-after-route-predicate-factory</a></p>
<h4 id="1、常用的Predicate-断言">1、常用的Predicate 断言</h4>
<h5 id="1-After-Route-Predicate：">1. After Route Predicate：</h5>
<ul>
<li>匹配 <code> 指定断言时间之后</code>的uri请求</li>
<li><code>- After=2021-09-28T19:14:51.514+08:00[Asia/Shanghai]</code></li>
</ul>
<p>如何获得上述格式的时间呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.ZonedDateTime;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">T2</span> &#123;</span><br><span class="line">      <span class="meta">@Test</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="type">ZonedDateTime</span> <span class="variable">zbj</span> <span class="operator">=</span> ZonedDateTime.now(); <span class="comment">// 默认时区</span></span><br><span class="line">            System.out.println(zbj);</span><br><span class="line">            <span class="comment">//2023-04-30T00:14:22.482+08:00[Asia/Shanghai]</span></span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置yml</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632827933056-82dc1db5-504b-46d9-ab84-b95638a3eeff.png" alt="img" style="zoom: 50%;">
<p><strong>测试</strong>：</p>
<p>成功</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632827968809-067c9642-7660-43a2-b5ee-37c6508e6f22.png" alt></p>
<p>将时间修改到一小时后：报错</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292247231.png" alt="img" style="zoom:33%;">
<h5 id="2-Before-Route-Predicate：">2.Before Route Predicate：</h5>
<ul>
<li>匹配  	<code>修改断言时间之前</code>  的uri请求</li>
</ul>
<h5 id="3-Between-Route-Predicate：">3.Between Route Predicate：</h5>
<ul>
<li>匹配 <code>修改断言时间之间</code>的uri请求</li>
<li><code>Between=2020-02-02T17:45:06.206+08:00[Asia/Shanghai],2020-03-25T18:59:06.206+08:00[Asia/Shanghai]</code></li>
</ul>
<h5 id="4-Cookie-Route-Predicate：">4.Cookie Route Predicate：</h5>
<p><code>- Cookie=chocolate, ch.p</code> Cookie Route Predicate需要两个参数，一个是Cookie name，一个是正则表达式。 路由规则会通过获取对应的Cookie name 值和正则表达式去匹配，如果匹配上就会执行路由， 如果没有匹配上则不执行。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632830284067-bcb6cfea-d13f-404f-8ec7-a56a60146e12.png" alt></p>
<p>表示只有发送的请求有cookie，而且里面有username=zzyy这个数据才能访问</p>
<h6 id="利用curl命令发送POST-GET请求">利用curl命令发送POST/GET请求</h6>
<ul>
<li>不带cookie发送请求</li>
</ul>
<p>cmd直接输入：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9527/payment/lb </span><br><span class="line"><span class="comment">#  只发了一个GET请求，没有带Cookie</span></span><br></pre></td></tr></table></figure>
<p>报错：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632830432717-1c3d1d5e-c64f-4ea1-b7d0-b8fc8fcc13ab.png" alt></p>
<ul>
<li>带cookie发送请求</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9527/payment/lb --cookie <span class="string">&quot;username=zzyy&quot;</span></span><br></pre></td></tr></table></figure>
<p>成功：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632830622771-95caf7f3-65e4-43c5-9325-441fb1bbdf32.png" alt></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/leedee/article/details/82685636">加入curl返回中文乱码</a></p>
<h5 id="5-Header-Route-Predicate：">5.Header Route Predicate：</h5>
<p><code>- Header=X-Request-Id, \d+</code>：带着这样的请求头才执行：请求头要有X-Request-Id属性，并且值为<code>整数</code>的正则表达式</p>
<p>测试：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9527/payment/lb -H <span class="string">&quot;X-Request-Id:123&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632830942567-50db34cb-bc8f-47ea-a68f-757769609d38.png" alt></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9527/payment/lb -H <span class="string">&quot;X-Request-Id:-123&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632831013791-dc0e7f68-fa2a-4817-84d1-b8e8b180bc26.png" alt></p>
<h5 id="6-Host-Route-Predicate：">6.Host Route Predicate：</h5>
<p><code>- Host=**.atguigu.com</code>：只有指定主机可以访问，可以指定多个用“，”分隔开。</p>
<p>测试：</p>
<ul>
<li>
<p><code>curl http://localhost:9527/payment/lb -H &quot;Host: www.atguigu.com&quot;</code>    			     正确</p>
</li>
<li>
<p><code>curl http://localhost:9527/payment/lb -H &quot;Host: java.atguigu.com&quot;</code>					正确</p>
</li>
<li>
<p><code>curl http://localhost:9527/payment/lb -H &quot;Host: java.atguigu.net&quot;</code>					错误</p>
</li>
</ul>
<h5 id="7-Method-Route-Predicate：">7.Method Route Predicate：</h5>
<p><code>- Method=GET</code> #只有get请求才能访问</p>
<ul>
<li>GET请求：<code>curl http://localhost:9527/payment/lb</code></li>
<li>POST请求：<code>curl -X -POST http://localhost:9527/payment/lb</code></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632831400643-4a4bed6c-61a8-4535-864e-d6894fb96b53.png" alt></p>
<h5 id="8-Path-Route-Predicate：">8.Path Route Predicate：</h5>
<p>匹配路径，最开始就是用的这个</p>
<h5 id="9-Query-Route-Predicate：">9.Query Route Predicate：</h5>
<p><code>- Query=username, \d+</code>  # 要有参数名username并且值还要是整数才能路由</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292247769.png" alt></p>
<h4 id="小总结">小总结</h4>
<p><code>Predicate就是为了实现一组匹配规则</code>，让请求过来找到对应的Route进行处理。</p>
<h3 id="七、Filter的使用">七、Filter的使用</h3>
<h4 id="1、Filter是什么">1、Filter是什么</h4>
<p>指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前或者之后对请求进行修改。</p>
<p>Filter链：同时满足一系列的过滤链。</p>
<ul>
<li>路由过滤器可用于修改进入的HTTP请求和返回的HTTP响应</li>
<li>路由过滤器只能指定路由进行使用</li>
<li>Spring Cloud Gateway 内置了多种路由过滤器，他们都由GatewayFilter的工厂类来产生。</li>
</ul>
<p>官网：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gatewayfilter-factories">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gatewayfilter-factories</a></p>
<ul>
<li>
<p><strong>生命周期 ：</strong></p>
<ul>
<li>pre  在业务逻辑之前</li>
<li>post  在业务逻辑之后</li>
</ul>
</li>
<li>
<p><strong>种类：</strong></p>
<ul>
<li>单一的：GatewayFilter(31个)</li>
<li>全局的：GlobalFilter（10个）</li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305131133006.png" alt></p>
<h4 id="2、自定义全局过滤器（GlobalFilter）">2、自定义全局过滤器（GlobalFilter）</h4>
<p>两个主要接口介绍：implements GlobalFilter, Ordered</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogGateWayFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;*********************come in MyLogGateWayFilter:  &quot;</span>+ <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">//取出请求参数的uname对应的值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uname</span> <span class="operator">=</span> exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line">        <span class="comment">//如果uanme为空，就直接过滤掉，不走路由</span></span><br><span class="line">        <span class="keyword">if</span>(uname == <span class="literal">null</span>)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;************* 用户名为Null 非法用户 o(╥﹏╥)o&quot;</span>);</span><br><span class="line">            <span class="comment">//判断该请求不通过时：给一个回应，返回</span></span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//反之，调用下一个过滤器，也就是放行：在该环节判断通过的exchange放行，交给下一个filter判断</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个过滤器的加载顺序，数字越小，优先级越高</span></span><br><span class="line"><span class="comment">     * 设置这个过滤器在Filter链中的加载顺序。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>测试</strong>：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9527/payment/lb?uname=z3">http://localhost:9527/payment/lb?uname=z3</a></p>
<p>发现报错了：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632835968869-29a31ab5-5979-4af5-9c09-942a98329452.png" alt></p>
<p>检查yml配置文件，发现predicates 断言设置了Query</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292247079.png" alt></p>
<p>加上Query需要的参数 username，或者将Query注释掉</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9527/payment/lb?uname=z3&amp;username=33">http://localhost:9527/payment/lb?uname=z3&amp;username=33</a></p>
<p>成功：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632836035624-2b2c9f91-84e2-4d2a-903c-f0afe156608b.png" alt></p>
<p>测试：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a>  没有加uname，被过滤掉了</p>
<h5 id="img-src-https-cdn-nlark-com-yuque-0-2021-png-22423156-1632836682678-87279565-c12e-4961-8a8d-4a12df80e78a-png-alt-img-style-zoom-33-img-src-https-gitee-com-Ryang1118-typora-raw-master-images-202304292247761-png-alt-img-style-zoom-50"><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1632836682678-87279565-c12e-4961-8a8d-4a12df80e78a.png" alt="img" style="zoom: 33%;"><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304292247761.png" alt="img" style="zoom: 50%;"></h5>
<h2 id="7、服务配置">7、服务配置</h2>
<ul>
<li><strong>服务配置——SpringCloud Config分布式配置中心</strong></li>
</ul>
<h3 id="一、概述-2">一、概述</h3>
<h4 id="1-1-分布式系统面临的—配置问题">1.1  分布式系统面临的—配置问题</h4>
<ul>
<li>我们的模块越来越多，每个模块都要写一个<code>application.yml</code>。 我们想象这样一种情况： 10个微服务都要连接同一个数据库，我们在这10个微服务都配置了连接数据库yml。 当这个数据库发生了变化，怎么办？ 修改10个yml。 如果是100个微服务都连接这个数据库呢？ 东西多了，就要有统一个管理。</li>
<li>上线后，发布版本了。有生产环境，有测试环境，预发布版本环境。 那么就是3套的配置的管理系统和业务要求，一个配置文件不能同时满足三种环境。</li>
<li>集中式的管理这些配置。微服务意味着要将单体应用中的业务拆分成一个个子服务，每个服务的粒度相对较小，因此系统中会 出现大量的服务。 由于每个服务都需要必要的配置信息才能运行，所以一套集中式，动态的配置管理设施是必不可少的。 我们每个微服务自己带着一个<code>application.yml</code>，上百个配置文件的管理… SpringCloud提供了<code>ConfigServer</code>来解决这个问题。</li>
</ul>
<h4 id="1-2-Config是什么">1.2 Config是什么</h4>
<img src="https://cdn.nlark.com/yuque/0/2021/png/12374561/1617944672184-6de7e8ee-7aa3-4ecc-8382-3ba31434c109.png" alt="img" style="zoom: 50%;">
<p>SpringCloud Config为微服务架构中的微服务<code>提供集中化的外部配置支持</code>（Git/GitHub）（意思就是可以配置远程的配置文件），配置服务器为各个不同微服务应用的所有环境提供了一个中心化的外部配置（Config Server）。</p>
<p>为服务之间<code>公用</code>的放在<code>配置中心</code>，各自<code>特有</code>的再<code>单独配置</code>。</p>
<p>官网： <a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/">https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/</a></p>
<p>由于SpringCloud Config默认使用Git来存储配置文件，最推荐与github整合。</p>
<h4 id="1-3-怎么用">1.3 怎么用</h4>
<p>SpringCloud Config 分为服务端和客户端两部分。</p>
<ul>
<li>
<p>服务端也称为分布式配置中心，他是一个独立的微服务应用，<code>用来连接配置服务器并   为客户端提供获取配置信息</code>，加密/解密等信息访问接口。</p>
</li>
<li>
<p>客户端则是通过<code>指定的配置中心来管理应用资源</code>，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息，配置服务器默认采用git来存储配置信息，这样既有助于对环境配置进行版本管理，并且可以通过git客户端来方便的管理和访问配置内容。</p>
</li>
</ul>
<h4 id="1-4-能干嘛">1.4 能干嘛</h4>
<ul>
<li>集中管理配置文件</li>
<li>不同环境不同配置，动态化的配置更新，分环境部署比如 dev/test/prod/beta/release</li>
<li>运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务回想配置中心统一拉取配置自己的信息。</li>
<li><strong>当配置发生变动时，服务不需要重启即可感知到配置的变化并应用新的配置。</strong></li>
<li><strong>将配置信息以Rest接口的形式暴露。</strong></li>
<li>与GitHub整合配置，由于SpringCloud Config默认使用Git来存储配置文件，虽然也支持SVN。但是最推荐的还是 Git，而且使用的是http/https访问的形式。</li>
</ul>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/">https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/</a></p>
<h3 id="二、-Config服务端配置与测试">二、 Config服务端配置与测试</h3>
<h4 id="2-1-用你自己的账号在GitHub上新建一个名为springcloud-config的新Repository">2.1 用你自己的账号在GitHub上新建一个名为springcloud-config的新Repository</h4>
<p>Repository中创建以下文件：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634045938282-baa4f769-298a-40a1-bade-5e1e45429fe3.png" alt></p>
<p>该文件可以从周阳老师的github仓库克隆一份，复制到自己的仓库 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/zzyybs/springcloud-config">https://github.com/zzyybs/springcloud-config</a></p>
<h4 id="2-2-由上一步获得刚新建的git地址">2.2 由上一步获得刚新建的git地址</h4>
<p>SSH：git@github.com:YangruiY/springlcoud-config.git</p>
<p>Https：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/YangruiY/springlcoud-config.git">https://github.com/YangruiY/springlcoud-config.git</a> （推荐）</p>
<h4 id="2-3-本地硬盘目录上新建git仓库并clone">2.3 本地硬盘目录上新建git仓库并clone</h4>
<p>注意：现在git clone命令进行clone时需要验证个人访问令牌，<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/qq_46941656/article/details/119737804">个人访问令牌的设置</a></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031780.png" alt></p>
<p>表示多个环境的配置；保存格式必须是utf-8</p>
<p>如果需要对本地仓的文件进行了修改，同步到远程仓库，此处模拟运维人员操作git和github</p>
<blockquote>
<p><code>git add </code></p>
<p><code>git commit -m &quot;init yml&quot; </code></p>
<p><code>git push origin master</code></p>
</blockquote>
<h4 id="2-4-新建Module模块-cloud-config-center-3344">2.4 新建Module模块 cloud-config-center-3344</h4>
<p>它就是Cloud的配置中心模块 cloudConfig Center</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634095958447-c6db1073-9b68-42d0-8122-47252f0a2ce5.png" alt="img" style="zoom:33%;">
<h4 id="2-5-pom">2.5 pom</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-config-center-3344<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--springCloud Config Server--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="2-6-yml">2.6 yml</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span>  <span class="string">cloud-config-center</span> <span class="comment">#注册进Eureka服务器的微服务名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/YangruiY/springlcoud-config.git</span>   <span class="comment">#GitHub上面的git仓库名字 这里可以写https地址跟ssh地址，https地址需要配置username和password</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">YangruiY</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">ry699397</span></span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">main</span></span><br><span class="line">          <span class="comment">####搜索目录</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">springcloud-config</span></span><br><span class="line">      <span class="comment">####读取分支,默认就是main(master)</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">main</span>   <span class="comment"># 以前是master</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:7001/eureka #单机版</span></span><br><span class="line">    <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka,http://localhost:7002/eureka</span> <span class="comment">#集群版</span></span><br></pre></td></tr></table></figure>
<p>注意这里<strong>cloud.config.server.git</strong>下面<strong>uri</strong>和<strong>search-paths</strong>以及<strong>label</strong>的含义</p>
<p>uri就是我们远程仓库的地址，search-paths表示远程仓库下有一个叫做springcloud-config的，label则表示读取master分支里面的内容（2020-10月开始master分支变为main分支）</p>
<p>新建的github分支已经默认为main，所以此处需指定 spring.cloud.config.server.git.default-label=main</p>
<h4 id="2-7-主启动类">2.7 主启动类</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.config.server.EnableConfigServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span>   <span class="comment">//开启SpringCloud的</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigCenterMain3344</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConfigCenterMain3344.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-8-测试">2.8 测试</h4>
<h6 id="2-8-1-Https">2.8.1 Https</h6>
<p>使用https没有指明账号密码会报错：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031068.png" alt></p>
<p>指明账号密码访问成功：</p>
<blockquote>
<p>&lt;可能不用加，我的没加就可以，虽然也有这个问题，但是排查一下是因为引入依赖的时候引入了rabbitMQ,之后去掉就可以了，可能我把仓库设置为public的了，所以不用加username、password&gt;    <strong>最好配上， 稳妥一点</strong></p>
</blockquote>
<p>[访问][<a target="_blank" rel="noopener external nofollow noreferrer" href="http://config-3344.com:3344/main/config-test.yml">http://config-3344.com:3344/main/config-test.yml</a>]</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300117613.png" alt="image-20230430011701548" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031864.png" alt="img" style="zoom:45%;">
<h6 id="2-8-2-SSH">2.8.2 SSH</h6>
<p>这里应该使用  <code>ssh-keygen -m PEM -t rsa -b 4096 -C &quot;填自己的描述&quot;</code>  生成   <code> ssh key</code></p>
<p>而不是使用 <code>ssh-keygen -t rsa -C &quot;填自己的描述&quot;</code> 生成  <code> ssh key</code></p>
<p>第一种方式生成的私钥是以<strong>BEGIN</strong> <strong>RSA</strong> <strong>PRIVATE KEY</strong>开头，<strong>END RSA PRIVATE KEY</strong>结尾；</p>
<p>第二种方式生成的私钥是以<strong>BEGIN</strong> <strong>OPENSSH</strong> <strong>PRIVATE KEY</strong>开头，<strong>END OPENSSH PRIVATE KEY</strong>结尾，<strong>SpringCloud访问git</strong>的组件<strong>不支持openssh</strong>这种格式的密钥。</p>
<p>我没有测试SSH验证是否能够通过。</p>
<p>要么你仓库公开 就像老师这样，私有仓库的话uri可以换https然后配置帐号密码，或者依旧用ssh,然后多配个私钥都可以</p>
<h6 id="2-8-3-映射规则">2.8.3 映射规则</h6>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634219331433-52e9e86d-a8b5-4161-a54a-32b945870eb9.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634219564098-fc7b068f-1f96-4f0e-acb9-6ce33c614cd2.png" alt></p>
<h4 id="2-9-配置的读取规则">2.9 配置的读取规则</h4>
<p>官网上有五种：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031398.png" alt></p>
<h5 id="2-9-1-label-application-profile-yml">2.9.1  /{label}/{application}-{profile}.yml</h5>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634222762566-c412644d-751b-4f58-99cc-1aa5a34f2328.png" alt></p>
<h6 id="读取main-master-分支">读取main(master)分支</h6>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/master/config-dev.yaml">http://localhost:3344/master/config-dev.yaml</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/master/config-test.yaml">http://localhost:3344/master/config-test.yaml</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/master/config-prod.yaml">http://localhost:3344/master/config-prod.yaml</a></li>
</ul>
<h6 id="读取dev分支">读取dev分支</h6>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/dev/config-dev.yaml">http://localhost:3344/dev/config-dev.yaml</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/dev/config-dev.yaml">http://localhost:3344/dev/config-dev.yaml</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/dev/config-dev.yaml">http://localhost:3344/dev/config-dev.yaml</a></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634222821477-8dae4b88-0f8e-4952-92fa-cd2fbf639a38.png" alt></p>
<h5 id="2-9-2-application-profile-yml">2.9.2  /{application}-{profile}.yml</h5>
<p><code>默认去master分支找</code>，所以这里不写分支</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634222797922-7cf048b2-0ee8-47ad-b584-58e0a8fc9cd5.png" alt></p>
<p>这里需要在yml文件中设置spring.cloud.config.server.git.default-label=main（github更新后master分支都成了main分支）</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031055.png" alt></p>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/config-dev.yaml">http://localhost:3344/config-dev.yaml</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/config-test.yaml">http://localhost:3344/config-test.yaml</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/config-prod.yaml">http://localhost:3344/config-prod.yaml</a></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634223029528-0078c39f-6a4c-4ffd-b51b-e38042746962.png" alt></p>
<h5 id="2-9-3-application-profile-label">2.9.3  /{application}/{profile}[/{label}]</h5>
<p>逆写法</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634259393645-06bff65f-946d-4f01-8ff2-53b5239861dc.png" alt></p>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/config/dev/master">http://localhost:3344/config/dev/master</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/config/test/master">http://localhost:3344/config/test/master</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3344/config/prod/master">http://localhost:3344/config/prod/master</a></li>
</ul>
<p>得到的结果是Json字符串</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634263956940-d04543c0-66fd-42f2-bc47-feac8bba26aa.png" alt></p>
<h4 id="2-10-总结">2.10 总结</h4>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031446.png" alt></p>
<p><strong>至此 ：  成功实现了SpringCloud通过GitHub获取配置信息</strong></p>
<h3 id="三、Config客户端配置与测试">三、Config客户端配置与测试</h3>
<p>上面我们的ConfigServer连接上了GitHub，成功的从GitHub上获取到了config信息</p>
<p>现在我们配置客户端，客户端从配置中心（Config Server）获取配置信息</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634269802115-7358c0e9-e95e-4d14-a931-6cb20e2ab41a.png" alt></p>
<h5 id="3-1-新建cloud-config-client-3355">3.1 新建cloud-config-client-3355</h5>
<h5 id="3-2-pom">3.2 pom</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-config-client-3355<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--这里就是客户端的SpringCloud config 因为是客户端所以没有server--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      </span><br><span class="line">      	<span class="comment">&lt;!--web/actuator这两个一般一起使用，写在一起--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      </span><br><span class="line">				<span class="comment">&lt;!--通用配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3344是server端所以依赖<code>spring-cloud-starter-config-server</code>后面有一个server</p>
<p>3355定位是客户端，所以只有<code>spring-cloud-starter-config</code></p>
<h5 id="3-3-bootstrap-yml">3.3 bootstrap.yml</h5>
<p>为了配置文件的加载顺序和分级管理，我们这里使用bootstrap.yml</p>
<ul>
<li><code>application.yml</code>是用户级的资源配置项</li>
<li><code>boostrap.yml</code>是系统级的，优先级更高</li>
</ul>
<p>Spring Cloud会创建一个“Bootstrap Context”，作为Spring应用的<code>Application Context</code>的父上下文。</p>
<p>初始化的时候，<code>Bootstrap Context</code>负责从外部源加载配置属性并解析配置。</p>
<p>这两个上下文共享一个从外部获取的<code>Environment</code>。</p>
<p>要将Client模块下的application.yml文件改为bootstrap.yml,这是很关键的，</p>
<p>因为bootstrap.yml是比application.yml先加载的。</p>
<p>bootstrap.yml优先级高于application.yml.</p>
<blockquote>
<p>使用spring cloud 2020的同学 需要开启bootstrap支持 要加一个bootstrap的依赖，启动报错的引入spring-cloud-starter-bootstrap</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment">#Config客户端配置</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">main</span> <span class="comment">#分支名称 以前是master</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#读取后缀名称   上述3个综合：main分支上config-dev.yml的配置文件被读取http://config-3344.com:3344/master/config-dev.yml</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span> <span class="comment">#配置中心地址k</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634280406602-aadd5584-96ce-4605-8ef6-6d82642ba31e.png" alt></p>
<h5 id="3-4-主启动类">3.4 主启动类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientMain3355</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConfigClientMain3355.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-5-业务类">3.5 业务类</h5>
<p>SpringCloud Config能够将配置信息以<code>REST风格</code>的形式暴露</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-6-测试">3.6 测试</h5>
<p>配置中心和客户端都注册进了eureka   &amp;   测试成功</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301010508.png" alt="image-20230430101005413" style="zoom:25%;">
<p><strong>成功实现了客户端3355访问SpringCloud Config3344通过GitHub获取配置信息</strong></p>
<blockquote>
<p>这里其他博主有出现问题<a target="_blank" rel="noopener external nofollow noreferrer" href="https://juejin.cn/post/6850418112773734407#heading-11">SpringCloud-Config配置</a>，参看博客上的解决办法，我并没有遇到相同的问题，直接成功。</p>
</blockquote>
<h5 id="3-7-问题随之而来——分布式配置的动态刷新问题">3.7 <strong>问题随之而来——分布式配置的动态刷新问题</strong></h5>
<p>我们实现了客户端3355通过Config3344获取GithHub上的配置信息，那么现在面临另外一个问题：</p>
<p>Linux运维修改GitHub上的配置文件内容做调整</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301014353.png" alt="image-20230430101425170" style="zoom:25%;">
<p>刷新3344，发现ConfigServer配置中心立刻响应</p>
<p>刷新3355，发现ConfigClient客户端没有任何响应</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301051441.png" alt="image-20230430105159236" style="zoom:25%;">
<blockquote>
<p>问题引入： 3355没有变化<code>除非自己重启或者重新加载</code>，难到每次运维修改配置文件，客户端都需要重启？？噩梦</p>
</blockquote>
<h3 id="四、Config客户端之动态刷新">四、Config客户端之动态刷新</h3>
<p>避免每次更新配置都要重启客户端微服务3355，需要修改3355模块</p>
<h4 id="4-1-pom引入actuator监控">4.1 pom引入actuator监控</h4>
<p>一般我们在新建微服务模块的时候都会引入web跟actuator这两个依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--web/actuator这两个一般一起使用，写在一起--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="4-2-修改yml，暴露监控端口">4.2 修改yml，暴露监控端口</h4>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634283643811-03fea168-5d6c-4491-8326-df99dd72c744.png" alt></p>
<p>2.0.0版本的SpringBoot的actuator启动端点监控web端默认加载默认只有两个info, health可见的页面节点。 如果需要显示更多 那么就要在application.properties配置文件中添加<code> management.endpoints.web.exposure.include=*</code> <code>management.endpoints.web.exposure.exclude=env</code></p>
<p>其中<code>include=* </code>表示包含所有节点页面</p>
<p><code>exclude=env,beans</code> 表示排除env、beans</p>
<h4 id="4-3-在业务类上加一个-RefreshScope注解">4.3 在业务类上加一个@RefreshScope注解</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-4-测试：3355还是没有动态刷新">4.4 测试：3355还是没有动态刷新</h4>
<p>发现GitHub上修改后，3355还是没有刷新</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634284046376-2dddb1c2-7595-4b56-9100-d92ca2550595.png" alt></p>
<h4 id="4-5-需要运维人员发送Post请求刷新3355">4.5 需要运维人员发送Post请求刷新3355</h4>
<p>我们还需要让运维人员发送一下POST请求，刷新一下3355 必须是Post请求</p>
<p>curl -X POST “<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3355/actuator/refresh">http://localhost:3355/actuator/refresh</a>”</p>
<p>发送post请求刷新后，客户端3355正常</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301057621.png" alt></p>
<blockquote>
<p>==值得注意的是==</p>
<ul>
<li>可能因为网络问题 导致  加载不到github （超时等）    等一会再连</li>
<li>可能因为网络问题 导致  3344也不会刷新 ，重启重连重测试</li>
<li>3355 此时的更新每一次变化的时候都要发<code>curl -X POST &quot;http://localhost:3355/actuator/refresh&quot;</code> 只能保证3355不要重启，但每次发送一次还是很麻烦的——<strong>使用总线解决</strong></li>
</ul>
</blockquote>
<h4 id="4-6-总线引入">4.6 总线引入</h4>
<ul>
<li>
<p>多个微服务客户端，难道每个微服务都要手动刷新？</p>
</li>
<li>
<p>在微服务多的情况下，每个微服务都需要执行一个post请求，手动刷新？</p>
</li>
<li>
<p>可否广播，一次通知，处处生效，使得 大范围的实现自动刷新</p>
</li>
<li>
<p>可能有这种情况：100台机器，有得不要求实时刷新。我们想实现该刷新的刷新，不想刷新的不刷新，怎么实现？</p>
</li>
</ul>
<p>解决方法——<strong>Bus总线</strong>。</p>
<h2 id="8、服务总线">8、服务总线</h2>
<blockquote>
<ul>
<li>服务消息总线——SpringCloud Bus</li>
</ul>
</blockquote>
<p>上一章我们讲了Config，其所能达到的极限也只是通过发送一个POST请求，手动版的实现动态刷新。 我们想解决这样的几个情形：</p>
<ul>
<li>GitHub上的配置文件修改后，可否广播一下，不用每个微服务都通过发送POST请求动态刷新。</li>
<li>可不可以该刷新的刷新，不想刷新的不刷新。</li>
</ul>
<p>带着这些问题，我们来到本章Bus的学习，他是对Config的增强。</p>
<p>主要内容：</p>
<ol>
<li>概述</li>
<li>RabbitMQ环境配置</li>
<li>SpringCloud Bus动态刷新全局广播</li>
<li>SpringCloud Bus动态刷新顶点通知。</li>
</ol>
<h3 id="1、概述">1、概述</h3>
<h4 id="1-1-是什么">1.1 是什么</h4>
<p>我们想实现分布式的自动刷新配置功能，不是通过手动发送POST请求实现刷新。 <code>Spring Cloud Bus</code>配合Spring Cloud Config使用可以实现配置的<code>动态刷新</code>。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031497.png" alt></p>
<p>配置更新后，将A刷新一下（推给A），然后通过总线“传染”给了其他的微服务。</p>
<p><code>Bus支持两种消息代理：RabbitMQ和Kafka</code></p>
<h4 id="1-2-能干嘛">1.2 能干嘛</h4>
<p>Spring Cloud Bus能管理和传播分布式系统间的消息，就像一个分布式执行器，可用于广播状态更改、事件推送等，也可以当作微服务间的通信通道。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634306374683-61fd06d3-efb8-4339-8872-2531018a0bf0.png" alt></p>
<p>这里是推送给ConfigServer，跟上面推送给客户端是不一样的。</p>
<h4 id="1-3-为什么被称为总线">1.3 为什么被称为总线</h4>
<p>**什么是总线：**在微服务架构的系统中，通常会使用轻量级的消息代理来构建一个共用的消息主题，并让系统中所有微服务实例都连接上来。由于该主题中产生的消息会被所有实例监听和消费，所以称它为消息总线。在总线上的各个实例，都可以广播一些需要让其他连接在该主题上的实例都知道的消息。</p>
<p>**基本原理：**ConfigClient实例都监听MQ中同一个topic(默认是springCloudBus)。当一个服务刷新数据的时候，它会把这个信息放入到Topic中，这样其它监听同一Topic的服务就能得到通知，然后去更新自身的配置。</p>
<h3 id="2、RabbitMQ环境配置">2、RabbitMQ环境配置</h3>
<h4 id="2-1-安装Erlang">2.1 安装Erlang</h4>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.erlang-solutions.com/downloads/">https://www.erlang-solutions.com/downloads/</a>   下载地址</p>
<h4 id="2-2-安装RabbitMQ">2.2 安装RabbitMQ</h4>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://rabbitmq.com/install-windows.html#installer">https://rabbitmq.com/install-windows.html#installer</a></p>
<p>以管理员身份启动start，不然会报错。然后测试是否安装成功：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:15672/">http://localhost:15672/</a> 账号密码都是guest。安装成功！</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634367660727-81da6f18-cd65-4f70-9f11-049346f59334.png" alt></p>
<h3 id="3、SpringCloud-Bus动态刷新全局广播">3、SpringCloud Bus动态刷新全局广播</h3>
<blockquote>
<p><strong>必须先具备良好的RabbitMQ环境</strong></p>
</blockquote>
<h4 id="3-1-Bus动态刷新全局广播的设计思想和选型">3.1 Bus动态刷新全局广播的设计思想和选型</h4>
<ul>
<li>1、利用消息总线<code>出发一个客户端</code>/bus/refresh，从而刷新所有客户端的配置</li>
</ul>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031500.png" alt="img" style="zoom:50%;">
<ul>
<li>2、利用消息总线<code>接触一个服务端</code>ConfigServer的/bus/refresh断点，从而刷新所有客户端的配置</li>
</ul>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634368549852-79390f2a-02f8-4d4a-99f4-ddca8c761e25.png" alt="img" style="zoom:50%;">
<p>图二的框架显然更合理一些，图一不适合的原因如下：</p>
<blockquote>
<ol>
<li>破坏了微服务的职责单一性，因为微服务本身是业务模块，它不应该承担配置刷新的功能</li>
<li>破坏了微服务各结点的对等性</li>
<li>有一定的局限性： 微服务迁移时，它的网络地址常常会发生变化，此时如果想要做到自动刷新，那就回增加更多的修改。</li>
</ol>
</blockquote>
<p>所以我们<strong>使用第二种</strong>：通知总线，总线再通知所有客户端。</p>
<h4 id="3-2-添加一个新的cloud-config-client-3366">3.2 添加一个新的cloud-config-client-3366</h4>
<p>演示广播效果，增加复杂度，以3355为模板再制作一个3366</p>
<h5 id="3-2-1-pom">3.2.1 pom</h5>
<p>与3355相同</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-config-client-3366<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--这里就是客户端的SpringCloud config 因为是客户端所以没有server--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--web/actuator这两个一般一起使用，写在一起--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--通用配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-2-2-yml">3.2.2 yml</h5>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3366</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment">#Config客户端配置</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">main</span> <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#读取后缀名称   上述3个综合：master分支上config-dev.yml的配置文件被读取http://config-3344.com:3344/master/config-dev.yml</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span> <span class="comment">#配置中心地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka,http://localhost:7002/eureka</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露监控端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-2-3-主启动">3.2.3 主启动</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientMain3366</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConfigClientMain3366.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-4-业务类controller">3.2.4 业务类controller</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">configInfo</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;serverPort: &quot;</span>+serverPort+<span class="string">&quot;\t\n\n configInfo: &quot;</span>+configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="分析">分析</h6>
<ul>
<li>
<p><code>@Value(&quot;$&#123;server.port&#125;&quot;)</code>从配置文件中取前缀为<strong>server.port</strong>的值：注意这个模块关联了两个yml</p>
<ul>
<li>一个是我们<strong>本地配置的bootstrap.yml</strong></li>
<li>另一个是通过bootstrap.yml关联到3344，再关联到<strong>GitHub上的config-text.yml</strong>。</li>
</ul>
</li>
<li>
<p><code>@Value(&quot;$&#123;server.port&#125;&quot;)</code>从bootstrap.yml取到了server.port的值；</p>
</li>
<li>
<p><code>@Value(&quot;$&#123;config.info&#125;&quot;)</code>从关联的<strong>config-{profile}.yml</strong>取到了<strong>info</strong>的值</p>
</li>
</ul>
<h4 id="3-3-配置案例">3.3 配置案例</h4>
<h5 id="3-3-1-给cloud-config-center-3344配置中心服务端添加消息总线支持">3.3.1 给cloud-config-center-3344配置中心服务端添加消息总线支持</h5>
<p>pom:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加消息总线RabbitMQ支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>yml：   注意对齐</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634370899980-1c243a17-6667-413a-8db8-e78f42637d95.png" alt></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span>  <span class="string">cloud-config-center</span> <span class="comment">#注册进Eureka服务器的微服务名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/Bear-Lx/springcloud-config.git</span>  <span class="comment">#GitHub上面的git仓库名字</span></span><br><span class="line"><span class="comment">#          uri: git@github.com:Bear-Lx/springcloud-config.git</span></span><br><span class="line">          <span class="comment"># uri 这里可以写https地址跟ssh地址，https地址需要配置username和password</span></span><br><span class="line">          <span class="comment">####搜索目录</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">springcloud-config</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">Bear-Lx</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">pangtou10086..</span></span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">main</span></span><br><span class="line"><span class="comment">#          skip-ssl-validation: true    #</span></span><br><span class="line">      <span class="comment">####读取分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">main</span>   <span class="comment"># 以前是master</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#rabbitmq相关配置</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##rabbitmq相关配置,暴露bus刷新配置的端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span> <span class="comment">#暴露bus刷新配置的端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;bus-refresh&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:7001/eureka #单机版</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka,http://localhost:7002/eureka</span> <span class="comment">#集群版</span></span><br></pre></td></tr></table></figure>
<h5 id="3-3-2-给cloud-config-client-3355客户端添加消息总线支持">3.3.2 给cloud-config-client-3355客户端添加消息总线支持</h5>
<p>pom:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加消息总线RabbitMQ支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>yml：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031914.png" alt></p>
<h5 id="3-3-3-给cloud-config-client-3366客户端添加消息总线支持">3.3.3 给cloud-config-client-3366客户端添加消息总线支持</h5>
<p>pom:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加消息总线RabbitMQ支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>yml：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634370975559-250215a2-26fd-46de-9e1c-f668ff783ae4.png" alt></p>
<h4 id="3-4-测试">3.4 测试</h4>
<p><code>启动7001、7002（我配了eureka集群）、3344、3355、3366</code></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031563.png" alt></p>
<p>自测通过</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301538228.png" alt="image-20230430153818110" style="zoom:33%;">
<p>修改GitHub上的配置文件，因为3355和3366都和config-dev.yml绑定，所以我们修改该配置文件，版本号修改成6</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301540095.png" alt="image-20230430154018983" style="zoom: 25%;">
<p>给3344Config-Server发送Post请求，刷新3344</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">&quot;http://localhost:3344/actuator/bus-refresh&quot;</span></span><br></pre></td></tr></table></figure>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301549353.png" alt="image-20230430154931237" style="zoom:33%;">
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634372052442-72078a37-43f3-4713-b31f-633aae83139b.png" alt></p>
<blockquote>
<p><strong>一处刷新</strong>，<strong>处处生效</strong>！</p>
</blockquote>
<h4 id="基本原理回顾">基本原理回顾</h4>
<p>ConfigClient实例都监听MQ中同一个topic（默认是SpringCloudBus）。 在RabbitMQ中找到了这个topic订阅主题/exchange路由交换机。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031562.png" alt="img" style="zoom: 50%;">
<p>当一个服务刷新数据时，它会把这个信息放到Topic中，这样其他监听同一Topic的服务就能得到通知， 然后去更新自身的配置。</p>
<h3 id="4、SpringCloud-Bus动态刷新定点通知">4、SpringCloud Bus动态刷新定点通知</h3>
<p>只通知指定的微服务。比如：只通知3355，不通知3366，指定具体某一个实例生效，而不是全部。</p>
<p>公式：</p>
<p><code>http://localhost:配置中心的端口号/actuator/bus-refresh/&#123;destination&#125;</code></p>
<p><code>/bus/refresh</code>请求不再发送到具体的服务实例上，而是发给<code>config server</code>并通过<code>destination参数类</code>指定需要更新配置的服务或实例。</p>
<h4 id="4-1-案例">4.1 案例</h4>
<p>我们这里以刷新运行在3355端口上的config-client为例，只通知3355，不通知3366</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">&quot;http://localhost:3344/actuator/bus-refresh/config-client:3355&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634384131225-61292297-090d-4c89-a6cd-2dafc8a354fc.png" alt></p>
<p>成功：3355刷新，3366未刷新</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304300031012.png" alt></p>
<h3 id="5、流程总结">5、流程总结</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634384269518-feae05a5-17cd-433d-85df-fbd6c933f046.png" alt></p>
<h2 id="9、Stream消息驱动">9、Stream消息驱动</h2>
<h3 id="一、Stream消息驱动概述">一、Stream消息驱动概述</h3>
<h4 id="1-1-为什么引入cloud-stream？解决的痛点是什么？">1.1 为什么引入cloud stream？解决的痛点是什么？</h4>
<ul>
<li>
<p>市面上存在着多种消息中间件技术</p>
<blockquote>
<p>ActiveMQ，RabbitMQ，RocketMQ，Kafka</p>
<p>那么每多出来一种新的技术，就要付出响应的学习成本</p>
<p>消息中间件技术的多样导致开发者的学习成本很大</p>
</blockquote>
</li>
<li>
<p>不同的系统中会用到不同的消息中间件，那么当需要系统进行整合时，或者系统进行切换时</p>
<blockquote>
<p>由于用的是不同的中间件技术，该怎么整合切换。存在多种MQ的情况时，如何进行切换、维护和开发？    具体的实现，需要的成本很大。</p>
</blockquote>
</li>
<li>
<p>那么有没有一种新的技术，让我们不再关注具体的MQ的细节，我们只需要用一种适配绑定的方式，自动的给我们在各种MQ内切换</p>
</li>
<li>
<p>引出了SpringCloud Stream</p>
</li>
</ul>
<blockquote>
<p>屏蔽底层的细节差异，让我<code>只需要操作一个Cloud Stream</code>，就可以<code>操作   底层下面各种各样不同的MQ</code>。</p>
<p>达到我们以更小的代价实现切换，维护，开发。</p>
</blockquote>
<h4 id="1-2-概述">1.2 概述</h4>
<h5 id="什么是SpringCloudStream？">什么是SpringCloudStream？</h5>
<ul>
<li>官方定义 Spring Cloud Stream 是一个<code>构建消息驱动微服务的框架</code>。</li>
<li>应用程序通过 <code>inputs </code>或者 <code>outputs </code>来与<code> Spring Cloud Stream</code>中<strong>binder对象</strong>交互。</li>
<li>通过我们配置来binding(绑定) ，而 <code>Spring Cloud Stream </code>的 <strong>binder对象负责与消息中间件交互</strong>。</li>
<li>所以，我们只需要搞清楚如何与 Spring Cloud Stream 交互就可以方便使用消息驱动的方式。</li>
</ul>
<p>通过使用Spring Integration来连接消息代理中间件以实现消息事件驱动。</p>
<blockquote>
<p>Spring Cloud Stream 为一些供应商的消息中间件产品提供了个性化的自动化配置实现，引用了<code>发布-订阅、消费组、分区</code>的三个核心概念。</p>
</blockquote>
<blockquote>
<p>**一句话：**SpringCloud Stream 屏蔽底层消息中间件的差异，降低切换成本，<code>统一消息的编程模型</code>。</p>
</blockquote>
<h4 id="官网">官网</h4>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fspring.io%2Fprojects%2Fspring-cloud-stream" rel="external nofollow noreferrer">官网</a></p>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fcloud.spring.io%2Fspring-cloud-static%2Fspring-cloud-stream%2F3.0.6.RELEASE%2Freference%2Fhtml%2F" rel="external nofollow noreferrer">文档</a></p>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fm.wang1314.com%2Fdoc%2Fwebapp%2Ftopic%2F20971999.html" rel="external nofollow noreferrer">中文指导手册</a></p>
<p>版本要求</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301215095.png" alt="img" style="zoom: 33%;">
<p><strong>绑定器对象：Binder Implementations</strong>          就是靠它屏蔽了我们底层的MQ的差异。</p>
<h4 id="1-3-设计思想">1.3 设计思想</h4>
<h5 id="1-3-1-传统的消息中间件的流程">1.3.1 传统的消息中间件的流程</h5>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634388483196-82972ce2-caa5-4949-96cb-b027abc23bb7.png" alt="img" style="zoom:53%;">
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634388493327-d62c14d7-ca7a-4298-88fe-4a0448404958.png" alt="img" style="zoom:60%;">
<h5 id="1-3-2-为什么用Cloud-Stream">1.3.2 为什么用Cloud Stream</h5>
<p>比方说我们同时用到了RabbitMQ和Kafka，由于这两个消息中间件的架构上的不同，整合和切换就会有很大的成本。</p>
<p>像RabbitMQ有exchange，kafka有Topic和Partitions分区。</p>
<p>这些中间件的差异性导致我们实际项目开发给我们造成了一定的困扰，我们如果用了两个消息队列的其中一种，后面的业务需求，我想往另外一种消息队列进行迁移，这时候无疑就是一个灾难性的，<strong>一大堆东西都要重新推倒重新做</strong>，因为它跟我们的系统耦合了，这时候springcloud Stream给我们提供了一种解耦合的方式。</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634388652792-89f6d104-879c-432d-99ae-23d1f571a420.png" alt="img" style="zoom: 50%;">
<h5 id="1-3-3-stream是怎么统一底层差异的？">1.3.3 stream是怎么统一底层差异的？</h5>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634389105603-f30a69e2-f46d-4562-b859-762bea5a5c4f.png" alt="img" style="zoom: 50%;">
<h5 id="1-3-4-Binder">1.3.4 Binder</h5>
<p>在没有<code>绑定器</code>这个概念的情况下，我们的SpringBoot应用要直接与消息中间件进行信息交互的时候，由于各消息中间件构建的初衷不同，它们的实现细节上会有较大的差异性，通过定义绑定器作为中间层，完美地实现了应用程序与消息中间件细节之间的隔离。Stream对消息中间件的进一步封装，可以做到代码层面对中间件的无感知，甚至   于  动态的切换中间件(rabbitmq切换为kafka)，使得微服务开发的高度解耦，服务可以关注更多自己的业务流程。</p>
<p><strong>通过定义绑定器Binder作为中间层，实现了应用程序与消息中间件细节之间的隔离。</strong></p>
<p>Binder可以生成Binding，Binding用来绑定消息容器的生产者和消费者，它有两种类型，<code>INPUT和OUTPUT</code></p>
<p><strong>input 对应于消费者（消费者从Stream接收消息)</strong></p>
<p><strong>output对应于生产者（生产者从Stream发布消息）。</strong></p>
<blockquote>
<p>Stream中的消息通信方式遵循了<code>发布-订阅模式</code>。Topic主题进行广播：<code>在RabbitMQ就是Exchange</code>；在<code>Kakfa中就是Topic</code></p>
</blockquote>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634456766627-0875c285-8a17-4288-9883-3b428650b692.png" alt="img" style="zoom:50%;">
<h4 id="1-4-Spring-Cloud-Stream标准流程套路">1.4 Spring Cloud Stream标准流程套路</h4>
<ul>
<li>
<p><code>Binder</code>：很方便的连接中间件，屏蔽差异（用于连接中间件与生产/消费者）</p>
</li>
<li>
<p><code>Channel</code>：通道，是队列Queue的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过Channel对队列进行配置</p>
</li>
<li>
<p><code>Source和Sink</code>：简单的可理解为参照对象是Spring Cloud Stream自身，<strong>从Stream发布消息就是输出（output），接受消息就是输入（input）</strong>。（简单的理解为输出/输如）</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301215225.png" alt="img" style="zoom: 67%;">
</li>
</ul>
<h4 id="1-5-编码API和常用注解">1.5 编码API和常用注解</h4>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634390359654-718a010e-2ac1-4d5d-9b31-044b26921f6f.png" alt="img" style="zoom:33%;">
<table>
<thead>
<tr>
<th>常用注解与API</th>
<th>含义解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>Middlewar</td>
<td>中间件，目前官方只支持RabbitMQ、Kafka</td>
</tr>
<tr>
<td>Binder</td>
<td>Binder是应用与消息中间件之间的封装，通过Binder可以很方便的连接中间件，可以动态的改变消息类型（对应Kafka的topic、RabbitMQ的exchange），这些都可以通过配置文件来实现</td>
</tr>
<tr>
<td>@Input</td>
<td>注解标识输入通道，通过该输入通道接收到的消息进入应用程序</td>
</tr>
<tr>
<td>@Output</td>
<td>注解标识输出通道，发布的消息将通过该通道离开应用程序</td>
</tr>
<tr>
<td>@StreamListener</td>
<td>监听队列，用于消费者的队列的消息接收</td>
</tr>
<tr>
<td>@EnableBinding</td>
<td>指信道channel和exchange绑定在一起</td>
</tr>
</tbody>
</table>
<h3 id="二、案例">二、案例</h3>
<h4 id="2-1-cloud-stream-rabbitmq-provider-consumer-8801-2-3">2.1 cloud-stream-rabbitmq-provider/consumer 8801/2/3</h4>
<p>RabbitMQ环境已经OK；</p>
<p>工程中新建三个子模块：</p>
<ul>
<li><code>cloud-stream-rabbitmq-provider8801     作为生产者进行发消息模块</code></li>
<li><code>cloud-stream-rabbitmq-consumer8802  作为消息接收模块</code></li>
<li><code>cloud-stream-rabbitmq-consumer8803  作为消息接收模块</code></li>
</ul>
<h4 id="2-2-消息驱动之生产者8801">2.2 消息驱动之生产者8801</h4>
<h5 id="2-2-1-新建module">2.2.1 新建module</h5>
<p>cloud-stream-rabbitmq-provider8801：作为<code>生产者</code>发送消息模块</p>
<h5 id="2-2-2-pom">2.2.2 pom</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-stream-rabbitmq-provider8801<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--rabbitMQ--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--web/actuator这两个一般一起使用，写在一起--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--基础配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-2-3-application-yml">2.2.3 application.yml</h5>
<p>这里有个报错，但是正常使用</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634451712587-5bfc6601-083d-4f92-88cd-ac52d82ce337.png" alt></p>
<p>报红解决方法：</p>
<ul>
<li>output前面加&quot;- &quot;：</li>
<li>defaultRabbit用大括号{}括起来：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment"># 设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">output:</span> <span class="comment"># 这个名字是一个通道的名称</span></span><br><span class="line">          	<span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          	<span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span></span><br><span class="line">          	<span class="attr">binder:</span> <span class="string">defaultRabbit</span> <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka,http://localhost:7002/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span> <span class="comment"># 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span> <span class="comment"># 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">send-8801.com</span>  <span class="comment"># 在信息列表时显示主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>
<h5 id="2-2-4-主启动类">2.2.4 主启动类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamMQMain8801</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(StreamMQMain8801.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-5-业务类">2.2.5 业务类</h5>
<p>我们此时要写的代码，要注意是和MQ交互，而不是传统的controller调用service。</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634390359654-718a010e-2ac1-4d5d-9b31-044b26921f6f.png" alt="img" style="zoom:33%;">
<p>我们现在写的代码是基于SpringCloudStream，然后做output指定通道，开启交互绑定器，再和中间件进行交互。</p>
<h6 id="发送消息接口">发送消息接口:</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IMessageProvider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">()</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="发送消息接口实现类">发送消息接口实现类:</h6>
<ol>
<li><strong>Source 定义消息的发送管道：</strong></li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634457088861-dd291424-9bde-4044-9dbb-b51eb9bd0f83.png" alt></p>
<p>这个Source哪来的呢？     这里我们可以理解为我们定义一个消息生产者的发送管道：消息源。</p>
<p>简单的可理解为参照对象是SpringCloudStream自身，</p>
<p>从Stream发出消息就是输出，接收消息就是输入。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301215225.png" alt></p>
<ol>
<li><strong>创建并发送消息</strong></li>
</ol>
<p>这里MessageChannel的<code>实例名必须是output</code>，要不然无法启动</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634457941052-8eda1e9b-965f-4a80-8f84-9a097a9d1c37.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.service.IMessageProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.EnableBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Source;</span><br><span class="line"><span class="keyword">import</span> org.springframework.integration.support.MessageBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.MessageChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以理解为定义消息的发送管道Source对应output(生产者)，Sink对应input(消费者)</span></span><br><span class="line"><span class="meta">@EnableBinding(Source.class)</span></span><br><span class="line"><span class="comment">//@Service：这里不需要了，这里不是传统的controller调用service。这个service是和rabbitMQ打交道的</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProviderImpl</span> <span class="keyword">implements</span> <span class="title class_">IMessageProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MessageChannel output; <span class="comment">// 消息的发送管道，MessageChannel对象的实例名必须是output</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serial</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//创建消息，通过output这个管道向消息中间件发消息</span></span><br><span class="line"><span class="comment">//        Message&lt;String&gt; message = MessageBuilder.withPayload(serial).build();</span></span><br><span class="line"><span class="comment">//        output.send(message);</span></span><br><span class="line">        <span class="built_in">this</span>.output.send(MessageBuilder.withPayload(serial).build()); <span class="comment">// 创建并发送消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;***serial: &quot;</span>+serial);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> serial;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Controller:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.service.IMessageProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendMessageController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IMessageProvider messageProvider;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/sendMessage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sendMessage</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> messageProvider.send();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-2-6-测试">2.2.6 测试</h6>
<p>启动7001、7002、8801</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634459434614-a94baefb-b3d4-48e8-b9cc-eca6dac527b9.png" alt></p>
<p>多次访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8801/sendMessage">http://localhost:8801/sendMessage</a></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301215350.png" alt></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301307826.png" alt="image-20230430130726732" style="zoom:33%;">
<h4 id="2-3-消息驱动之消费者8802">2.3 消息驱动之<code>消费者</code>8802</h4>
<h5 id="2-3-1-新建cloud-stream-rabbitmq-consumer8802">2.3.1 新建cloud-stream-rabbitmq-consumer8802</h5>
<h5 id="2-3-2-pom">2.3.2 pom</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-stream-rabbitmq-consumer8802<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--rabbitMQ--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--web/actuator这两个一般一起使用，写在一起--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--基础配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-3-3-application-yml">2.3.3 application.yml</h5>
<p>8801是生产者是output，8802是消费者是input</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1634463381855-8eef0232-d21c-4b60-8aae-206647c45c8f.png" alt></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8802</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment"># 设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理 </span></span><br><span class="line">        <span class="attr">input:</span> <span class="comment"># 这个名字是一个通道的名称  </span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment"># 设置消息类型，本次为对象json，如果是文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">binder:</span> &#123; <span class="string">defaultRabbit</span> &#125; <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka，http://localhost:7002/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span> <span class="comment"># 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span> <span class="comment"># 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">receive-8802.com</span>  <span class="comment"># 在信息列表时显示主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>
<h5 id="2-3-4-主启动类">2.3.4 主启动类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamMQMain8802</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(StreamMQMain8802.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3-5-业务类">2.3.5 业务类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.EnableBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.StreamListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Sink;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableBinding(Sink.class)</span> <span class="comment">//可以理解为我们定义一个消息消费者的接收管道</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveMessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener(Sink.INPUT)</span> <span class="comment">//输入源：作为一个消息监听者</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">input</span><span class="params">(Message&lt;String&gt; message)</span> &#123;</span><br><span class="line">        <span class="comment">//获取到消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">messageStr</span> <span class="operator">=</span> message.getPayload();</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者1号，-------&gt;接收到的消息：&quot;</span> + messageStr + <span class="string">&quot;\t port: &quot;</span>+serverPort);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3-6-测试">2.3.6 测试</h5>
<p>启动7001、7002、8801、8802</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301215767.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635257736723-9ba7cc81-5555-4130-a8dd-31ef03082ea4.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635257631085-8e9ffc7f-5a7a-45e6-9260-d501ae0c75f7.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635257822396-520b0583-f32b-4845-a117-f59133e42480.png" alt></p>
<p>测试成功</p>
<h3 id="三、高级特性：分组消费与持久化">三、高级特性：分组消费与持久化</h3>
<h4 id="3-1-依照8802，clone出一份cloud-stream-rabbitmq-consumer8803">3.1 依照8802，clone出一份cloud-stream-rabbitmq-consumer8803</h4>
<h5 id="3-1-1-pom">3.1.1 pom</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-stream-rabbitmq-consumer8803<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--rabbitMQ--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--web/actuator这两个一般一起使用，写在一起--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--基础配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-1-2-application-yml">3.1.2 application.yml</h5>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8803</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment"># 设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="attr">input:</span> <span class="comment"># 这个名字是一个通道的名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment"># 设置消息类型，本次为对象json，如果是文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">binder:</span> &#123; <span class="string">defaultRabbit</span> &#125; <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka,http://localhost:7002/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span> <span class="comment"># 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span> <span class="comment"># 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">receive-8803.com</span>  <span class="comment"># 在信息列表时显示主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>
<h5 id="3-1-3-主启动类">3.1.3 主启动类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamMQMain8803</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(StreamMQMain8803.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-1-4-业务类">3.1.4 业务类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.StreamListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Sink;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.Message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveMessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener(Sink.INPUT)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">input</span><span class="params">(Message&lt;String&gt; message)</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者2号，-------&gt;接收到的消息：&quot;</span> + message.getPayload()+<span class="string">&quot;\t port: &quot;</span>+serverPort);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-启动测试">3.2 启动测试</h4>
<p>启动7001、7002、8801（消息生产）、8802（消息消费）、8803（消息消费）</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301215641.png" alt></p>
<p>此时studyexchange有两个订阅者：8802、8803</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635321761119-a50b91e1-305a-40e1-938b-f21e91ce6b8e.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635321817330-0a1acb8e-2fde-4d18-bdd3-7222adeb9f6c.png" alt></p>
<p>测试成功</p>
<h4 id="3-3-运行后的问题1：重复消费问题">3.3 运行后的问题1：重复消费问题</h4>
<p>目前8801发送一条消息后，8802和8803会同时收到8801的消息，存在重复消费问题。</p>
<h5 id="3-3-1-为什么要解决重复消费问题">3.3.1 为什么要解决重复消费问题</h5>
<p>比如8801下一个订单，但是被两个服务获取消费，会多扣一次款。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301215104.png" alt="img" style="zoom:50%;">
<p><code>默认分组：流水号</code></p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635332610573-d3dd8ee9-e213-45b4-a576-4a466bab5bb1.png" alt="img" style="zoom:50%;">
<p>8802和8803默认是两个不同的分组。不同的微服务，默认分组是不同的，不同的组可以消费同一个消息</p>
<h5 id="3-3-2-解决：消息分组">3.3.2 解决：消息分组</h5>
<p>微服务应用放置于同一个group中，就能够保证消息只会被其中一个应用消费一次。</p>
<p>不同的组是可以全面消费的（重复消费），同一个组内的多个消费者会发生竞争关系，只有其中一个可以消费。</p>
<p>先自定义分组，然后自定义配置分为同一个组，解决重复消费问题。</p>
<h5 id="3-3-3-自定义分组">3.3.3 自定义分组</h5>
<p>将<code>8802和8803</code>分为两个不同的组，atguiguA和atguiguB</p>
<p>修改8802和8803的yml</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635335639617-54867623-0f61-4940-8732-9c7326232189.png" alt></p>
<p>可以看到，分组已经变成我们自定义的atguiguA和atguiguB了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635335757515-683d694c-9d7c-455e-8281-3ca3a7f0e1b3.png" alt></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301420330.png" alt="image-20230430142046239" style="zoom:25%;">
<p>虽然实现了自定义分组，但是因为是<code>分为两个组</code> ，所以<code>重复消费的问题依然存在</code>。</p>
<p><code>分布式微服务应用为了实现高可用和负载均衡，实际上都会部署多个实例</code>，本例阳哥启动了两个消费微服务(8802/8803)</p>
<p>多数情况，生产者发送消息给某个具体微服务时只希望被消费一次，按照上面我们启动两个应用的例子，虽然它们同属一个应用，但是这个消息出现了被重复消费两次的情况。为了解决这个问题，在Spring Cloud Stream中提供了<code>消费组</code>的概念。</p>
<h5 id="3-3-4-消费组">3.3.4 消费组</h5>
<p>将8802和8803  改为<code>同一个组atguiguA</code></p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635336507339-9c869958-4d72-4822-9c58-867fc28ca041.png" alt="img" style="zoom:33%;">
<p>测试，现在没有出现重复消费问题。</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635336599938-4e3b923c-5fa4-4c47-b50b-97e9f2c0e8af.png" alt="img" style="zoom: 50%;">
<p>8802/8803实现了轮询分组，每次只有一个消费者接收消息，8801模块的发的消息只能被8802或8803其中一个接收到，这样避免了重复消费。</p>
<h4 id="3-4-运行后的问题2：消息持久化问题">3.4 运行后的问题2：消息持久化问题</h4>
<p>通过上述，解决了重复消费问题，再看看持久化</p>
<ol>
<li>停止8802/8803并去除掉8802的分组group: atguiguA（8803的分组group: atguiguA没有去掉）</li>
<li>8801先发送4条消息到rabbitmq</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635337927157-4347dc83-cf51-46fd-96e1-71856ef64cea.png" alt></p>
<ul>
<li>先启动8802，无分组属性配置，后台没有打出来消息             发现8802没有收到消息，<code>消息丢失</code></li>
</ul>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301430594.png" alt="image-20230430143001284" style="zoom:33%;">
<ul>
<li>再启动8803，有分组属性配置，后台打印出来了MQ上的消息</li>
</ul>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301429909.png" alt></p>
<h2 id="10、Sleuth-分布式请求链路跟踪">10、Sleuth 分布式请求链路跟踪</h2>
<h3 id="一、概述-3">一、概述</h3>
<p><strong>分布式请求链路跟踪：</strong></p>
<ul>
<li>为什么会出现这个技术，要解决哪些问题</li>
</ul>
<p>在微服务框架中，一个客户端发起的请求在后端系统中会经过多次不同的服务节点调用来协同产生最后的请求结果</p>
<p>每个前一段请求都会形成一条复杂的<code>分布式服务调用链路</code>，链路中的<code>任何一环出现高延时或错误</code>都会引起<code>整个请求最后的失败</code></p>
<p>SpringCloudSleuth提供了一套完整的服务跟踪的解决方案，在分布式系统中提供 了   追踪解决方案 并且  兼容支持了zipkin。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/spring-cloud/spring-cloud-sleuth">官网</a></p>
<h3 id="二、搭建链路监控步骤">二、搭建链路监控步骤</h3>
<h4 id="2-1-zipkin">2.1 zipkin</h4>
<p>Sleuth：负责跟踪整理，zipkin：负责展现</p>
<h5 id="2-1-1-下载">2.1.1 下载</h5>
<p>SpringCloud从F版起已不需要自己构建Zipkin Server了，<code>只需调用jar包即可</code></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301433236.png" alt="image-20230430143324145" style="zoom:33%;">
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://repo1.maven.org/maven2/io/zipkin/java/zipkin-server/">下载地址</a></p>
<p><code>zipkin-server-2.12.9-exec.jar</code></p>
<h5 id="2-1-2-运行jar-运行控制台">2.1.2 运行jar&amp;运行控制台</h5>
<p>cd到zipkin-server-2.12.9-exec.jar的下载目录</p>
<p>直接在cmd中运行<code>java -jar zipkin-server-2.23.16-exec.jar</code></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301438119.png" alt="image-20230430143840025" style="zoom:33%;">
<p>访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9411/zipkin/">http://localhost:9411/zipkin/</a> web交互界面</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301439756.png" alt="image-20230430143959658" style="zoom:25%;">
<h5 id="2-1-3-完整的调用链路">2.1.3 完整的调用链路</h5>
<p>表示一请求链路，一条链路通过<code>Trace Id</code>唯一标识，<code>Span</code>标识发起的请求信息，各span通过<code>parent id</code>关联起来</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301215407.png" alt="img">
<p>Trace：类似于树结构的Span集合，表示一条调用链路，存在唯一标识。</p>
<p>Span：表示调用链路来源，通俗的理解Span就是一次请求信息。各个Span通过parentID关联起来。</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635591377253-d8c969bd-6d80-4e7b-bb6a-3206c548639d.png" alt="img" style="zoom: 67%;">
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635591394872-a5a4cab7-dc38-49eb-81f2-45274ad22084.png" alt="img" style="zoom: 67%;">
<h4 id="2-2-服务提供者cloud-provider-payment8001">2.2 服务提供者cloud-provider-payment8001</h4>
<h5 id="2-2-1-pom">2.2.1 pom</h5>
<p><code>引入spring-cloud-starter-zipkin依赖，其包含了sleuth+zipkin</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-provider-payment8001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--包含了sleuth+zipkin--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mysql-connector-java--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--jdbc--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-2-2-yml">2.2.2 yml</h5>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635596278263-5365038f-521b-4745-98dc-a943d24adebb.png" alt></p>
<p>注意缩进！</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span>            <span class="comment"># 当前数据源操作类型</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/dbCloud?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">10086</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="comment">#采样率值介于 0 到 1 之间，1 则表示全部采集</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment">#访问路径可以显示IP地址</span></span><br><span class="line">    <span class="comment">#心跳检测与续约时间</span></span><br><span class="line">    <span class="comment">#开发时设置小些，保证服务关闭后注册中心能及时剔除服务</span></span><br><span class="line">    <span class="comment">#Eureka客户端向服务端发送心跳的时间间隔，单位为秒(默认是30秒)</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment">#Eureka服务端在收到最后一次心跳后等待时间上限，单位为秒(默认是90秒)，超时将剔除服务</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#表示是否将自己注册进EurekaServer默认为true。</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:7001/eureka  # 单机版</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span> <span class="comment">#集群版</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapperLocations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.atguigu.springcloud.entities</span>    <span class="comment"># 所有Entity别名类所在包</span></span><br></pre></td></tr></table></figure>
<h5 id="2-2-3-业务类PaymentController">2.2.3 业务类PaymentController</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/payment/zipkin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentZipkin</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hi ,i&#x27;am paymentzipkin server fall back，welcome to atguigu，O(∩_∩)O哈哈~&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-服务消费者cloud-consumer-order80">2.3 服务消费者cloud-consumer-order80</h4>
<h5 id="2-3-1-pom">2.3.1 pom</h5>
<p><code>引入spring-cloud-starter-zipkin依赖，其包含了sleuth+zipkin</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-consumer-order80<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--包含了sleuth+zipkin--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-3-2-yml">2.3.2 yml</h5>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635596879846-d480e544-07f8-4843-970d-11b86cd8bb7f.png" alt></p>
<p>注意缩进！</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#表示是否将自己注册进EurekaServer默认为true。</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:7001/eureka</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span> <span class="comment">#集群版</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">order80</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h5 id="2-3-3-业务类OrderController">2.3.3 业务类OrderController</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ====================&gt; zipkin+sleuth</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/comsumer/payment/zipkin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentZipKin</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://localhost:8001&quot;</span> + <span class="string">&quot;/payment/zipkin/&quot;</span>, String.class);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-测试">2.4 测试</h4>
<p><strong>启动7001、7002、8001、80</strong></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301215373.png" alt></p>
<p><strong>8001自测</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635597377973-ab80266f-a31c-4872-9eb3-dbf483f30627.png" alt></p>
<p><strong>80调用8001</strong></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301215029.png" alt></p>
<p>**打开浏览器访问：**<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9411">http://localhost:9411</a></p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635598316752-fbe95dae-0aed-49fe-9ab6-7a2adb2ef2aa.png" alt="img" style="zoom:50%;">
<p>order服务调用了支付服务</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635598512853-2a7b2b33-0d4b-416d-a13e-85e484c20842.png" alt="img" style="zoom:50%;">
<p><strong>说明</strong>：order调用的payment服务，发送的是什么请求，请求链接，都有详细的记录</p>
<p>查看依赖关系</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635598407458-63e74243-cf5f-499b-bbb1-c868616ea57f.png" alt="img" style="zoom: 50%;">
<h1>SpringCloud Alibaba</h1>
<h2 id="1、简介">1、简介</h2>
<h4 id="1-为什么出现-SpringCloud-Alibaba">1. 为什么出现 SpringCloud Alibaba</h4>
<p><code>Spring Cloud Netflix</code>项目进入维护模式</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://spring.io/blog/2018/12/12/spring-cloud-greenwich-rc1-available-now">https://spring.io/blog/2018/12/12/spring-cloud-greenwich-rc1-available-now</a></p>
<p>进入维护模式意味着Spring Cloud Netflix 将不再开发新的组件</p>
<p>我们都知道Spring Cloud 版本迭代算是比较快的，因而出现了很多重大ISSUE都还来不及Fix就又推另一个Release了。进入维护模式意思就是目前一直以后一段时间Spring Cloud Netflix提供的服务和功能就这么多了，不在开发新的组件和功能了。以后将以维护和Merge分支Full Request为主</p>
<p>新组件功能将以其他替代  平替 的方式实现</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500626.png" alt="img" style="zoom:33%;">
<h4 id="2-SpringCloud-Alibaba带来了什么">2. SpringCloud Alibaba带来了什么</h4>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">官网</a></p>
<h5 id="2-1-能干什么">2.1 能干什么</h5>
<p>1、服务限流降级：默认支持 Servlet、Feign、RestTemplate、Dubbo 和 RocketMQ 限流降级功能的接入，可以在运行时通过控制台实时修改限流降级规则，还支持查看限流降级 Metrics 监控。</p>
<p>2、服务注册与发现：适配 Spring Cloud 服务注册与发现标准，默认集成了 Ribbon 的支持。</p>
<p>3、分布式配置管理：支持分布式系统中的外部化配置，配置更改时自动刷新。</p>
<p>4、消息驱动能力：基于 Spring Cloud Stream 为微服务应用构建消息驱动能力。</p>
<p>5、阿里云对象存储：阿里云提供的海量、安全、低成本、高可靠的云存储服务。支持在任何应用、任何时间、任何地点存储和访问任意类型的数据。</p>
<p>6、分布式任务调度：提供秒级、精准、高可靠、高可用的定时（基于 Cron 表达式）任务调度服务。同时提供分布式的任务执行模型，如网格任务。网格任务支持海量子任务均匀分配到所有 Worker（schedulerx-client）上执行。</p>
<h5 id="2-2-去哪里下载">2.2 去哪里下载</h5>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</a></p>
<p>之前在父工程的pom文件中已经引入了alibaba的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-3-有什么组件">2.3  有什么组件</h5>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635600464114-3215f873-7617-46ef-9850-503b8cff3a64.png" alt></p>
<h5 id="3-学习资料的获取">3. 学习资料的获取</h5>
<p>官网：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://spring.io/projects/spring-cloud-alibaba#overview">https://spring.io/projects/spring-cloud-alibaba#overview</a></p>
<p>英文：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/spring-cloud-alibaba">https://github.com/alibaba/spring-cloud-alibaba</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html</a></p>
<p>中文：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</a></p>
<h2 id="2、Nacos服务注册和配置中心">2、Nacos服务注册和配置中心</h2>
<p>对应着我们前面学的：Eureka/Consul/Zookeeper（服务注册） Config+Bus（配置中心）</p>
<h3 id="一、-Nacos简介">一、 Nacos简介</h3>
<p>Nacos——<strong>Na</strong>ming <strong>Co</strong>nfiguration <strong>S</strong>ervice</p>
<h5 id="1-是什么">1 是什么</h5>
<ul>
<li>一个更易于构建云原生应用的动态服务发现、配置管理和服务的管理平台。</li>
<li>Nacos：Dynamic Naming and Configuration Service</li>
<li>Nacos就是<code>注册中心 + 配置中心</code>的组合， <code>Nacos = Eureka + Config + Bus</code></li>
</ul>
<h5 id="2-能干什么">2 能干什么</h5>
<p><code>替代Eureka做服务注册中心；替代Config做服务配置中心</code></p>
<h5 id="3-下载地址">3 下载地址</h5>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Nacos">https://github.com/alibaba/Nacos</a></p>
<p>官网文档：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://nacos.io/zh-cn/index.html">https://nacos.io/zh-cn/index.html</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_discovery">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_discovery</a></p>
<h5 id="4-各注册中心比较">4 各注册中心比较</h5>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635603894076-3a5b9f04-9718-4e2c-b52b-cff0cce61967.png" alt></p>
<h3 id="二、-安装并运行Nacos">二、 安装并运行Nacos</h3>
<p>本地需要准备java8+maven环境。</p>
<p>官网下载：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></p>
<p>安装的是<code> 1.4.2</code>                     解压安装包，运行bin目录下的<code>startup.sh</code></p>
<p>默认的是<strong>集群模式</strong>，我们需要<strong>单机启动</strong>：</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301526835.png" alt="image-20230430152604727" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301525015.png" alt="image-20230430152529673" style="zoom:33%;">
<p>命令运行成功后直接访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8848/nacos">http://localhost:8848/nacos</a>  默认账号密码都是nacos</p>
<p>启动成功</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301527562.png" alt></p>
<h4 id="Linux集群搭建">Linux集群搭建</h4>
<p>nacos1.1.4</p>
<p>按步骤搭建之后：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep nacos|grep -v grep |<span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305150017610.png" alt></p>
<p>==但是失败了==</p>
<p>启动nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./nginx -c /ryang/MyApplication/mynginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">ps -ef|grep nginx</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305150018664.png" alt></p>
<p>1.4.2</p>
<p><code>conf/application.properties</code></p>
<p>总共会创建（cp -r ）是三个<code>nacos</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server.port=4444  //3333  //5555</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### Count of DB:</span></span><br><span class="line">db.num=1</span><br><span class="line"></span><br><span class="line"><span class="comment">### Connect URL of DB:</span></span><br><span class="line">db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=<span class="literal">true</span>&amp;useUnicode=<span class="literal">true</span>&amp;useSSL=<span class="literal">false</span>&amp;serverTimezone=UTC&amp;allowPublicKeyRetrieval=<span class="literal">true</span></span><br><span class="line">db.user.0=root</span><br><span class="line">db.password.0=00000000</span><br></pre></td></tr></table></figure>
<p><code>cluster.conf</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.16.108.139:3333</span><br><span class="line">172.16.108.139:4444</span><br><span class="line">172.16.108.139:5555</span><br></pre></td></tr></table></figure>
<p><code>startup.sh</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#===========================================================================================</span></span><br><span class="line"><span class="comment"># JVM Configuration</span></span><br><span class="line"><span class="comment">#===========================================================================================</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;MODE&#125;</span>&quot;</span> == <span class="string">&quot;standalone&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Xms512m -Xmx512m -Xmn256m&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.standalone=true&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;EMBEDDED_STORAGE&#125;</span>&quot;</span> == <span class="string">&quot;embedded&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -DembeddedStorage=true&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms512m -Xmx512m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:-OmitStackTraceInFastThrow -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/java_heapdump.hprof&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:-UseLargePages&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># start</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span>&quot;</span> &gt; <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> nacos.nacos</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nacos is starting，you can check the <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out&quot;</span></span><br></pre></td></tr></table></figure>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305151144137.png" alt="image-20230515114428023" style="zoom:33%;">
<p><code>nginx</code>的配置<code>ngionx.conf</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#gzip  on;</span></span><br><span class="line">    upstream cluster&#123;</span><br><span class="line">        server 127.0.0.1:3333;</span><br><span class="line">        server 127.0.0.1:4444;</span><br><span class="line">        server 127.0.0.1:5555;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        location /nacos&#123;</span><br><span class="line">            <span class="comment">#root   html;</span></span><br><span class="line">            <span class="comment">#index  index.html index.htm;</span></span><br><span class="line">                proxy_pass http://cluster;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>启动 nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx -c /ryang/MyApplication/mynginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>
<p>此时直接访问 <code>80 端口</code></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305151153270.png" alt="image-20230515115325022" style="zoom:67%;">
<p><code>启动： 9001  83  </code></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305151158989.png" alt="image-20230515115822876" style="zoom:33%;">
<h3 id="三、-Nacos作为服务注册中心演示">三、 Nacos作为服务注册中心演示</h3>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_discovery">官网手册</a></p>
<h4 id="1-基于Nacos的服务提供者-cloudalibaba-provider-payment9001">1 基于Nacos的服务提供者(cloudalibaba-provider-payment9001)</h4>
<h6 id="1-1-建moudle">1.1 建moudle</h6>
<p>cloudalibaba-provider-payment9001</p>
<h6 id="1-2-pom">1.2 pom</h6>
<p>父工程中需要引入alibaba的依赖，之前已经引入过了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//父工程pom中需要引入alibaba</span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>本模块pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloudalibaba-provider-payment9001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="1-3-yml">1.3 yml</h6>
<p>按照官网上的说明配置。</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635662280490-67a7615d-b304-447c-a8d5-870e9e5f67e7.png" alt="img" style="zoom:25%;">
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#配置Nacos地址，注册到Nacos</span></span><br><span class="line"><span class="comment"># 做监控需要把这个全部暴露出来</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
<h6 id="1-4-主启动类">1.4 主启动类</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>  <span class="comment">//这里跟以前不同了，不再是EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain9001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentMain9001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="1-5-业务类">1.5 业务类</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;nacos registry, serverPort: &quot;</span>+ serverPort+<span class="string">&quot;\t id&quot;</span>+id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="1-6-测试">1.6 测试</h6>
<p>这里不像eureka还要写注册中心微服务，   此处只要 直接安装打开nacos即可。</p>
<p>启动9001，查看nacos控制台，注册成功</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301557229.png" alt></p>
<p>访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9001/payment/nacos/1">http://localhost:9001/payment/nacos/1</a></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301558354.png" alt="image-20230430155849227" style="zoom:33%;">
<p><code>nacos服务注册中心+服务提供者9001</code>都OK了</p>
<h6 id="1-7-相同配置再新建一个module-9002">1.7 相同配置再新建一个module 9002</h6>
<p>步骤与9001一致，就是端口号改成9002</p>
<blockquote>
<p>或者 :这里有一个简单的方法，虚拟映射一个和9001配置相同的9011微服务模块，端口号是9011</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635663511339-6a6dbe02-65c6-468b-9528-25449f466a37.png" alt="img" style="zoom:50%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500204.png" alt="img" style="zoom: 67%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301602034.png" alt="image-20230430160213669" style="zoom:33%;">
<p>现在有两个支付模块，9001和虚拟映射的9011。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301602960.png" alt="image-20230430160247851" style="zoom: 33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301604149.png" alt="image-20230430160426036" style="zoom:33%;">
</blockquote>
<h4 id="2-基于Nacos的服务消费者（cloudalibaba-consumer-nacos-order83）">2 基于Nacos的服务消费者（cloudalibaba-consumer-nacos-order83）</h4>
<p>Nacos自带负载均衡</p>
<h6 id="2-1-新建module-cloudalibaba-consumer-nacos-order83">2.1 新建module  cloudalibaba-consumer-nacos-order83</h6>
<h6 id="2-2-pom">2.2 pom</h6>
<p>nacos自带 ribbon 的负载均衡</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635664487366-5f26a5ef-6bc5-4e8e-a222-64b5f0047a5c.png" alt></p>
<p>Ribbon：支持负载均衡，自带RestTemplate</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloudalibaba-consumer-nacos-order83<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="2-3-yml">2.3 yml</h6>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>
<h6 id="2-4-主启动类">2.4 主启动类</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderNacosMain83</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderNacosMain83.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-5-业务类">2.5 业务类</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextBean</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span> </span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderNacosController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.nacos-user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverURL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.getForObject(serverURL + <span class="string">&quot;/payment/nacos/&quot;</span> + id, String.class);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635665889497-7b99643e-adcd-4b21-85f1-270838741d69.png" alt="img" style="zoom:53%;">
<h6 id="2-6-测试">2.6 测试</h6>
<p>启动9001、9002、83</p>
<p>nacos控制台</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301623707.png" alt="image-20230430162344349" style="zoom:33%;">
<p>测试链接：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:83/consumer/payment/nacos/1">http://localhost:83/consumer/payment/nacos/1</a></p>
<p>发现9001与9002交替出现，即   轮询负载均衡</p>
<p><strong>可能出现的问题</strong>：</p>
<p>当消费者通过<a target="_blank" rel="noopener external nofollow noreferrer" href="http://xn--nacos-payment-providerUnknowHostException-if92ef9krqn9r9kpe2ar76au6kmp2ot25j">http://nacos-payment-provider去调用微服务时抛出UnknowHostException</a>：未知主机名异常。</p>
<p>这是因为nacos-payment-provider对应两个微服务实例，他不知道用哪个微服务，所以报错。</p>
<p>解决：加上负载均衡注解<code> @LoadBalanced</code></p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635666314847-e7408e10-067d-4b84-b308-dd4571aaaca3.png" alt="img" style="zoom:50%;">
<h4 id="3-服务注册中心对比">3. 服务注册中心对比</h4>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500669.png" alt="img" style="zoom: 63%;">
<h6 id="3-1-Nacos与CAP">3.1 Nacos与CAP</h6>
<p>Nacos可以在CP与AP之间切换</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635666897448-5bdee4bc-0e24-4f3c-bdc2-3683e18799c7.png" alt="img" style="zoom:50%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500957.png" alt="img" style="zoom:33%;">
<h6 id="3-2-CP与AP的切换">3.2 ==CP与AP的切换==</h6>
<p>C（consistency）：所有节点在同一时间看到的数据是一致的，强一致性；</p>
<p>A（availability）：定义是所有的请求都会收到响应，最起码有一个兜底回复，高可用性。</p>
<h6 id="何时选择使用何种模式？">何时选择使用何种模式？</h6>
<p><strong>AP:</strong></p>
<p>一般来说，如果<code>不需要存储服务级别的信息且服务实例是通过nacos-client注册</code>，并能够保持心跳上报，那么就可以选择AP模式。</p>
<p>当前主流的服务如 Spring cloud 和 Dubbo 服务，都适用于AP模式，AP模式为了服务的可能性而减弱了一致性，因此AP模式下只支持注册临时实例。</p>
<p><strong>CP:</strong></p>
<p>如果需要在<code>服务级别</code>编辑或者存储配置信息，那么 CP 是必须，K8S服务和DNS服务则适用于CP模式。</p>
<p>CP模式下则支持注册持久化实例，此时则是以 Raft 协议为集群运行模式，该模式下注册实例之前必须先注册服务，如果服务不存在，则会返回错误。</p>
<h6 id="怎么切换：">怎么切换：</h6>
<p><code>curl -X PUT '$NACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&amp;value=CP'</code></p>
<h4 id="4、-Nacos作为服务配置中心演示">4、 Nacos作为服务配置中心演示</h4>
<p>以前我们将所有的配置信息写到了GitHub上，用Config+Bus来进行自动刷新和动态的更新。</p>
<p>现在我们可以直接把配置文件写进Nacos，然后再用Nacos做类似于config这样的功能，直接从Nacos上抓取我们的配置信息。</p>
<h5 id="1-Nacos作为配置中心——基础配置">1.Nacos作为配置中心——基础配置</h5>
<p>主要是添加一个：nacos-config依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos-config--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>   </span><br></pre></td></tr></table></figure>
<h6 id="1-1-建module-cloudalibaba-config-nacos-client3377">1.1 建module cloudalibaba-config-nacos-client3377</h6>
<h6 id="1-2-pom-2">1.2 pom</h6>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloudalibaba-config-nacos-client3377<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--nacos-config--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--web + actuator--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--一般基础配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="1-3-yml-2">1.3 yml</h6>
<p>这里需要配置两个，一个<code>bootstrap</code>和一个<code>application</code></p>
<p>原因：Nacos同springcloud-config一样，在项目初始化时，要保证先从配置中心进行配置拉取，拉取配置之后，才能保证项目的正常启动。</p>
<p>springboot中<code>配置文件</code>的加载是<code>存在优先级顺序</code>的，<strong>bootstrap优先级高于application</strong>。</p>
<p>全局的放在：bootstrap.yml     自己的放在：application.yml</p>
<p><strong>bootstrap：</strong></p>
<p>微服务端口：3377，服务名nacos-config-client，注册进nacos：localhost:8848 作为配置客户端</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nacos配置</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos作为配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#指定yaml格式的配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $&#123;spring.application.name&#125;-$&#123;spring.profile.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>application：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 表示开发环境</span></span><br></pre></td></tr></table></figure>
<p>==bootstrap + application 就表示我要去配置中心找名为dev.yaml的文件==</p>
<h6 id="1-4-主启动类-2">1.4 主启动类</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosConfigClientMain3377</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(NacosConfigClientMain3377.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="1-5-业务类-2">1.5 业务类</h6>
<p>通过Spring Cloud原生注解**@RefreshScope** 实现配置自动更新</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">//在控制器类加入@RefreshScope注解使当前类下的配置支持Nacos的动态刷新功能。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/config/info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="1-6-在Nacos中添加配置信息">1.6 在Nacos中添加配置信息</h6>
<p>==Nacos中的匹配规则==</p>
<blockquote>
<p>理论：</p>
<p>Nacos中的<code>dataid的组成格式</code>与SpringBoot<code>配置文件中的匹配规则</code></p>
<p>官网：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html">https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html</a></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301635467.png" alt="img" style="zoom:83%;">
<p><code>注意nacos只识别yaml，不识别yml</code></p>
<p>最终公式：<code>$&#123;spring.application.name&#125;-$&#123;spring.profiles.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</code></p>
<p>结果：<code> nacos-config-client-dev.yaml</code></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301636152.png" alt="img" style="zoom:50%;">
</blockquote>
<h6 id="1-7实操">1.7实操</h6>
<p>配置新增：</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635684133899-cb940e70-fed6-4893-9136-a1605f864ac6.png" alt="img" style="zoom:50%;">
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635683995494-e18c9f15-33c4-486a-ab85-a986c9810fd4.png" alt="img" style="zoom:53%;">
<h6 id="1-8测试">1.8测试</h6>
<p>启动3377</p>
<p>发送请求：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3377/config/info">http://localhost:3377/config/info</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635684417158-e8ca283d-c66e-4edd-8489-76e65673925e.png" alt></p>
<p>自带动态刷新：修改nacos中的yaml配置文件，再次调用查看配置，发现配置刷新了。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301647584.png" alt="image-20230430164753446" style="zoom:33%;">
<h5 id="2-Nacos作为配置中心——分类配置">2. Nacos作为配置中心——分类配置</h5>
<h6 id="2-1-分布式开发中的多环境多项目管理问题">2.1 分布式开发中的多环境多项目管理问题</h6>
<ul>
<li><strong>问题1：</strong></li>
</ul>
<p>实际开发中，通常一个系统会准备</p>
<ul>
<li>
<p>dev开发环境</p>
</li>
<li>
<p>test测试环境</p>
</li>
<li>
<p>prod生产环境。</p>
</li>
</ul>
<blockquote>
<p>如何保证指定环境启动时服务能正确读取到Nacos上相应环境的配置文件呢？</p>
</blockquote>
<ul>
<li><strong>问题2：</strong></li>
</ul>
<p>一个大型分布式微服务系统会有很多微服务子项目，每个微服务项目又都会有相应的开发环境、测试环境、预发环境、正式环境…</p>
<blockquote>
<p>那怎么对这些微服务配置进行管理呢？</p>
</blockquote>
<h6 id="2-2-Nacos的图形化管理界面">2.2 Nacos的图形化管理界面</h6>
<p>配置管理：</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635685284361-4572707d-d143-41be-8c13-c36d096ab04c.png" alt="img" style="zoom: 50%;">
<p>命名空间：</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500924.png" alt="img" style="zoom: 67%;">
<h6 id="2-3-Namespace-Group-Data-ID三者关系？为什么这么设计？">2.3 Namespace+Group+Data ID三者关系？为什么这么设计？</h6>
<p>类似Java里面的package名和类名，最外层的namespace是可以用于区分部署环境的，Group和DataID逻辑上区分两个目标对象。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500394.png" alt="img" style="zoom:33%;">
<p><strong>默认情况：</strong></p>
<p><strong>Namespace=public，Group=DEFAULT_GROUP,     默认Cluster是DEFAULT</strong></p>
<ul>
<li>Nacos<code>默认的命名空间是public</code>，Namespace主要用来实现隔离。</li>
</ul>
<blockquote>
<p>比方说我们现在有三个环境：开发、测试、生产环境，我们就可以创建三个Namespace，不同的Namespace之间是隔离的。</p>
</blockquote>
<ul>
<li>
<p>Group<code>默认是DEFAULT_GROUP</code>，Group可以把不同的微服务划分到同一个分组里面去</p>
</li>
<li>
<p>Service就是微服务；一个Service可以包含多个Cluster（集群），<code>Nacos默认Cluster是DEFAULT</code>，Cluster是对指定微服务的一个虚拟划分。</p>
</li>
</ul>
<blockquote>
<p>比方说为了容灾，将Service微服务分别部署在了杭州机房和广州机房，这时就可以给杭州机房的Service微服务起一个集群名称（HZ），给广州机房的Service微服务起一个集群名称（GZ），还可以尽量让同一个机房的微服务互相调用，以提升性能。</p>
</blockquote>
<ul>
<li>最后是Instance，就是微服务的实例。</li>
</ul>
<h5 id="3-三种方案加载配置">3. 三种方案加载配置</h5>
<h6 id="3-1-DataID方案"><strong>3.1 DataID方案</strong></h6>
<p>指定spring.profile.active和配置文件的DataID来使不同环境下读取不同的配置</p>
<p>默认空间+默认分组+新建dev和test两个DataID</p>
<ul>
<li>dev配置DataID，上一讲配置过</li>
<li>新建test配置DataID</li>
</ul>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635687085675-43bff20e-5d0f-4140-8356-41d5774614a2.png" alt="img" style="zoom:67%;">
<p>这里命名空间是默认的public，Group也是默认的。</p>
<p>通过spring.profile.active属性就能进行多环境下配置文件的读取</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635687246140-40f3010d-2e3c-4959-a537-42d5e0f21b2e.png" alt></p>
<p>重启3377 测试<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:3377/config/info%EF%BC%8C%E6%88%90%E5%8A%9F%E8%AF%BB%E5%8F%96%E5%88%B0test%E9%85%8D%E7%BD%AE%E4%B8%8B%E7%9A%84config.info">http://localhost:3377/config/info，成功读取到test配置下的config.info</a></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301703168.png" alt="image-20230430170344042" style="zoom:33%;">
<h6 id="3-2-Group方案"><strong>3.2 Group方案</strong></h6>
<p>默认Group是DEFAULT_GROUP，现在通过Group实现环境分区</p>
<p>新建一个配置文件，添加到DEV_GROUP分组</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500869.png" alt="img" style="zoom:33%;">
<p>新建一个配置文件，添加到TEST_GROUP分组</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635687928881-aa121233-ef4d-4868-b2aa-3a12017af496.png" alt="img" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500395.png" alt="img" style="zoom:33%;">
<p>在config下增加一条group的配置即可。可配置为DEV_GROUP或TEST_GROUP</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635688159372-2a81a5bd-4797-4e5c-a1fb-37fca2c56aee.png" alt="img" style="zoom:33%;">
<p>测试：</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301710279.png" alt="image-20230430171002146" style="zoom:33%;">
<h6 id="3-3-namesapce方案"><strong>3.3 namesapce方案</strong></h6>
<ul>
<li>新建dev    &amp;&amp;   test的Namesapce</li>
</ul>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301711492.png" alt="image-20230430171132358" style="zoom:25%;">
<ul>
<li>回到服务管理-服务列表查看</li>
</ul>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635688736719-d5c116d7-f8b1-4637-8488-0174a8b463b6.png" alt="img" style="zoom: 50%;">
<p>在这两个新建的namespace中分别新建三个不同分组的配置文件</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500875.png" alt="img" style="zoom:50%;">
<p>修改3377的yml文件</p>
<p>bootstrap：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635689312883-38e75de9-0081-4b50-82bb-be5b057b7d41.png" alt></p>
<p>application：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500473.png" alt></p>
<p>测试</p>
<p>dev namesapce：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635690766323-8fe68084-ec12-4a06-a1fc-c5d5f5ed38c2.png" alt></p>
<p>test namesapce：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635690996286-aff5fe00-8620-4648-8933-c18e1a770519.png" alt></p>
<h6 id="3-4-总结"><strong>3.4 总结</strong></h6>
<p>DataID方案是在默认namesapce和默认Group下，创建两个不同的DataID。</p>
<p>Group方案是在默认namespace下，新建两个DataID相同的配置文件，通过指定不同的分组来读取不同的配置。</p>
<p>Namespace方案，是相同的Group，相同的DataID，创建并指定不同的namespace来读取不同配置。</p>
<h5 id="4-Nacos集群和持久化配置（重点）">4. Nacos集群和持久化配置（重点）</h5>
<p>我们之前在学eureka的时候，配置了两个eureka注册中心微服务。</p>
<p>学Nacos时，不用我们单独新建注册中心微服务模块了，直接安装使用即可，很方便。</p>
<p>但是：如果这个注册中心挂了怎么办？我们目前就开了一个Nacos程序，也没有配置集群。显然，实际情况中不可能只有一个Nacos注册中心，因此需要用到nacos集群。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html">集群官网文档</a></p>
<h6 id="4-1-官网说明">4.1 官网说明</h6>
<p><strong>架构图：这里vip表示virtual ip（虚拟IP）</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500770.png" alt="img" style="zoom:53%;">
<p><strong>要将配置持久化到数据库中：MySQL           不用nacos内嵌的数据库 derby</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635775427756-97237fc3-1533-4f48-a906-98fc0102fda5.png" alt></p>
<p><strong>通俗易懂的Nacos集群架构图</strong></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500400.png" alt></p>
<p><strong>重点说明：</strong></p>
<p>默认Nacos使用嵌入式数据库实现数据的存储，我们重启Nacos后，以前的配置文件不会消失。</p>
<p>但是，如果启动多个默认配置下的Nacos节点，数据存储是存在一致性问题的。每个nacos都有自己独立的嵌入式数据库，存放的数据不一致。</p>
<p>为了解决这个问题，Nacos采用了<code>集中式存储的方式来支持集群化部署</code>，目前只支持MySQL的存储。</p>
<p>nacos支持的三种部署模式：</p>
<ul>
<li>单机模式：用于测试和单机使用</li>
<li>集群模式：用于生产环境，确保高可用</li>
<li>多集群模式：用于多数据中心场景</li>
</ul>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635775664121-2c4d8a51-44d0-4ee0-90b5-3d6df0079932.png" alt="img" style="zoom:33%;">
<h6 id="4-2-Nacos嵌入式数据库derby切换到mysql">4.2 Nacos嵌入式数据库derby切换到mysql</h6>
<p>Nacos默认自带的是嵌入式数据库derby，那么如果做集群时每个nacos都自带一个derby，那么就有三个存储配置稳健的数据库，显然数据的统一性存在问题。</p>
<p>==windows单机版derby到mysql切换步骤==</p>
<p>首先在nacos安装目录的conf目录下找到一个名为<strong>nacos-mysql.sql</strong>的sql脚本</p>
<p>然后执行nacos-mysql.sql脚本</p>
<p><code>注意：数据库nacos_config需要自己创建</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 创建nacos_config数据库  */</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE nacos_config;</span><br><span class="line">USE nacos_config;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/attachments/yuque/0/2021/sql/22423156/1635776971740-ab4fe82b-a375-4dbc-b8e0-348acb2b1003.sql">📎nacos-mysql.sql</a></p>
<p>在conf目录下找到application.properties</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635777806883-a979fbfc-91fa-4cd8-a967-810765af235c.png" alt="img" style="zoom:73%;">
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1635777987285-f0947ebc-127d-4873-81a4-9851f777c15b.png" alt="img" style="zoom:63%;">
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">db.url.0</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="attr">db.user</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">db.password</span>=<span class="string">00000000</span></span><br></pre></td></tr></table></figure>
<p>重新启动nacos，可以看到是个全新的空记录界面，以前是记录进derby</p>
<p>在bin目录下的cmd 输入 <code>startup.cmd -m standalone</code> 执行，这里还是单机模式，只不过数据库从derby迁移到了mysql</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301757558.png" alt="image-20230430175752152" style="zoom:33%;">
<p>可以看到，重启之后之前的配置都没了，说明迁移成功。</p>
<p>在naocs新建配置时，会自动保存到mysql数据库中</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301757103.png" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301758145.png" alt="image-20230430175811021" style="zoom:33%;">
<blockquote>
<ul>
<li>
<p>我的版本是 1.4.3 nacos    mysql   8.0.28</p>
</li>
<li>
<p>我出现问题是因为没有建立数据库<code>nacos-config</code> 建完之后就没有问题了</p>
</li>
</ul>
</blockquote>
<h6 id="4-3-Linux版Nacos-MySQL生产环境配置">4.3  Linux版Nacos+MySQL生产环境配置</h6>
<p>一定要先把环境准备好！  centos7/Ubuntu/ + maven(3.2+)+mysql(5.6.5+)+JDK1.8</p>
<p>预计需要1个Nginx+3个nacos注册中心+1个mysql</p>
<ul>
<li>1 Nacos 下载Linux版</li>
</ul>
<blockquote>
<p>下载nacos-linux：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/nacos/releases/tag/2.0.3">https://github.com/alibaba/nacos/releases/tag/2.0.3</a>  我放在了/usr/local  下</p>
<p>解压： <code>tar -zxvf nacos-server-2.0.3.tar.gz</code></p>
<p><code>cp -r nacos /mynacos/</code>  递归拷贝nacos 文件夹到mynacos文件夹下 （我这里没有执行这步）</p>
</blockquote>
<ul>
<li>2 集群配置步骤（重点）</li>
</ul>
<blockquote>
<h4 id="1-Linux服务器上mysql数据库配置">(1) Linux服务器上mysql数据库配置</h4>
<p>跟windows一样，linxu的nacos 在 /nacos/conf 目录下有一个nacos-mysql.sql的sql脚本</p>
<h4 id="2-application-properties-配置">(2) application.properties 配置</h4>
<p>/usr/local/nacos/conf 下，修改内容：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#<span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>  单机模式支持mysql  <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>#</span><br><span class="line">spring.datasource.platform<span class="operator">=</span>mysql</span><br><span class="line"></span><br><span class="line">db.num<span class="operator">=</span><span class="number">1</span></span><br><span class="line">db.url<span class="number">.0</span><span class="operator">=</span>jdbc:mysql:<span class="operator">/</span><span class="operator">/</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span><span class="operator">/</span>nacos_config?characterEncoding<span class="operator">=</span>utf8<span class="operator">&amp;</span>connectTimeout<span class="operator">=</span><span class="number">1000</span><span class="operator">&amp;</span>socketTimeout<span class="operator">=</span><span class="number">3000</span><span class="operator">&amp;</span>autoReconnect<span class="operator">=</span><span class="literal">true</span><span class="operator">&amp;</span>useUnicode<span class="operator">=</span><span class="literal">true</span><span class="operator">&amp;</span>useSSL<span class="operator">=</span><span class="literal">false</span><span class="operator">&amp;</span>serverTimezone<span class="operator">=</span>UTC</span><br><span class="line">db.user<span class="operator">=</span>数据库账号</span><br><span class="line">db.password<span class="operator">=</span>数据库密</span><br></pre></td></tr></table></figure>
<h4 id="3-Linux服务器上nacos的集群配置cluster-conf">(3) Linux服务器上nacos的集群配置cluster.conf</h4>
<p>梳理出3台nacos集器的不同服务端口号  3333  4444  5555</p>
<p><strong>cp cluster.conf.example cluster.conf</strong></p>
<p><strong>vim cluster.conf</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301951721.png" style="zoom:33%;">
<h4 id="4-编辑Nacos的启动脚本startup-sh，使它能够接受不同的启动端口">(4) <a target="_blank" rel="noopener external nofollow noreferrer" href="http://xn--Nacosstartup-bh7t29nlt0guk9brp4avuh7v5e.sh">编辑Nacos的启动脚本startup.sh</a>，使它能够接受不同的启动端口</h4>
<p><code>/ryang/MyApplication/mynacos/nacos/bin</code> <a target="_blank" rel="noopener external nofollow noreferrer" href="http://xn--startup-nw3k389jqdq043b.sh">目录下有startup.sh</a>，平时单机版的启动，都是./startup.sh即可。</p>
<p>集群启动，我们希望可以类似其它软件的shell命令，传递不同的端口号启动不同的nacos实例。</p>
<p>命令：./startup.sh <strong>-p 3333</strong> 表示启动端口号为3333的nacos服务器实例，和上一步的cluster.conf配置的一致。</p>
<p><strong>注意：2.0版本的-p被占用了，可以用大写P或者其他字母，刚改完浏览器会有延迟，过一会才会好。</strong></p>
<p>1.1.4 版本修改前后对比方式：</p>
<table>
<thead>
<tr>
<th>修改前</th>
<th>修改后</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636101801849-65e53edf-8bd0-4978-b51f-c60091601f11.png" alt></td>
<td><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636101807905-b1e3a2be-09a2-45dc-8e84-c0b1eb58fc9e.png" alt></td>
</tr>
<tr>
<td><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636101797900-5b7d1e70-9e92-47ba-81e2-c5b520334ec4.png" alt></td>
<td><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636101791050-52f8abbf-3af1-498d-980e-c1d95dc27509.png" alt></td>
</tr>
</tbody>
</table>
<ul>
<li>2.0.3版本修改前后对比</li>
</ul>
<table>
<thead>
<tr>
<th>修改前</th>
<th>修改后</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636965100107-f81bce09-bfcf-4d91-ae4c-3f080d6bac4c.png" alt></td>
<td><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636965136571-aea13396-dc5c-4316-be51-1cdd8a8d6155.png" alt></td>
</tr>
<tr>
<td><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500350.png" alt></td>
<td><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636965580222-2c12fd48-38f9-4ed7-aefe-acf1c2ef345f.png" alt></td>
</tr>
</tbody>
</table>
<p>如果防火墙没关，记得将3333,4444,5555端口号设置可访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=3333/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=4444/tcp --permanent</span><br><span class="line">firewall-cmd --add-port=5555/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>最终只能启动一个nacos，尝试各种办法未解决，更换nacos1.1.4后没有问题。</p>
<h4 id="5-Nginx的配置，由它作为负载均衡器">(5) Nginx的配置，由它作为负载均衡器</h4>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/mrlinxi/pxvr4g/he0i9c">Nginx基础</a></p>
<p><code>/ryang/MyApplication/mynginx/conf</code> 下nginx.conf文件为默认配置文件 启动nginx通过-c可以指定配置文件启动。我这里将原来的配置文件拷贝为<code>nginx_nacos.conf</code></p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636118716205-76c7f6e2-a07a-4518-80e3-f23b875b373e.png" alt="img" style="zoom:55%;">
<p>启动nginx，cd到<code>/ryang/MyApplication/mynginx/sbin</code>下 ,执行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx -c /ryang/MyApplication/mynginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302051497.png" alt></p>
<p>别忘了防火墙开启1111端口的访问：</p>
<p><strong>firewall-cmd --add-port=1111/tcp --permanent</strong></p>
<p><strong>firewall-cmd --reload</strong></p>
<h4 id="6-测试">(6) 测试</h4>
<p>测试通过nginx访问nacos，成功登陆</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302052706.png" alt="image-20230430205215563" style="zoom:33;">
<p>然后我们新建一个配置文件：</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302053340.png" alt="image-20230430205323205" style="zoom: 25%;">
<p>成功存到Linux的数据库中！</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302055747.png" alt="image-20230430205501612" style="zoom:25%;">
</blockquote>
<h6 id="4-4-微服务cloudalibaba-provider-payment9002启动注册进nacos集群">4.4 微服务cloudalibaba-provider-payment9002启动注册进nacos集群</h6>
<p>修改9002的application.yml文件。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636119919002-851f57c9-7ec7-4ef5-a531-28e7315627ac.png" alt></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line"><span class="comment">#        server-addr: localhost:8848 #配置Nacos地址，注册到Nacos</span></span><br><span class="line">         <span class="attr">server-addr:</span> <span class="number">172.16</span><span class="number">.108</span><span class="number">.139</span><span class="string">:1111</span> <span class="comment"># 注册到nacos集群，通过nginx代理</span></span><br><span class="line"><span class="comment"># 做监控需要把这个全部暴露出来</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
<p>启动9002，注册成功</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302057509.png" alt="image-20230430205730373" style="zoom:33%;">
<h6 id="4-5-4-2-处出错-可能的解决方案-（踩坑）1-1-4版本nacos使用外部数据库Mysql8">4.5  ==4.2 处出错    可能的解决方案 （踩坑）1.1.4版本nacos使用外部数据库Mysql8==</h6>
<blockquote>
<p>后面Seata章节由于Nacos、sentinel、seata存在版本对应关系，因此需要安装1.1.4版本nacos。</p>
<p>我在安装nacos1.1.4配置MYSQL8的application.properties后，报错：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636689711167-14daa147-53a0-4100-9997-89807bbb5551.png" alt></p>
<p>尝试了如下方法：</p>
<ol>
<li>在nacos\plugins\mysql（自己创建）文件夹下放mysql8对应版本的jar包（不管用）</li>
<li>修改application.properties文件名为bootstrap.properties：可以正常启动nacos，但是数据库并没有从derby切换为mysql</li>
<li>添加时区：<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636688994869-43048817-50a7-486e-90d9-c0a2d589e64e.png" alt></li>
</ol>
<p>一般我在使用mysql8的时候都会添加上时区，仍然不管用。</p>
<p>修改nacos源码（可行）</p>
<h6 id="修改nacos源码">修改nacos源码</h6>
<p>下载nacos1.1.4源码，修改父工程pom的mysql-connector-java的版本，将5.1.34改成自己mysql对应的版本</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636692383529-991ca7a4-d60e-4df2-8b6f-e271e0e7f73a.png" alt></p>
<p>这里一改，naming模块下的<strong>com.alibaba.nacos.naming.healthcheck.MysqlHealthCheckProcessor</strong>就会报错</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636692552809-fd63b51b-e355-43ec-88ed-0d424023bb40.png" alt></p>
<p>把<code>import com.mysql.jdbc.jdbc2.optional.MysqlDataSource;</code>改为<code>import com.mysql.cj.jdbc.MysqlDataSource;</code></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636692775087-5a140dbb-0f10-4329-aaa3-836daedc850c.png" alt></p>
<p>这里我注释的一定要删掉（这里我注释掉主要是为了区分），不然会报错：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304301500899.png" alt></p>
<p>然后在源码根目录下打开cmd，使用maven打包</p>
<p>执行：<code>mvn -Prelease-nacos -Dmaven.test.skip=true clean install -U</code></p>
<p>打包好的nacos存放在根目录\distribution\target目录下</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636699215820-994303ce-a905-4980-8356-4eba81cfe3df.png" alt></p>
<p>这个压缩包就相当于我们从官网上下的。然后复制到你想解压的地方，解压。</p>
<p>随后，配置conf\application.properties里面的数据库：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&gt;#******************</span>  <span class="string">单机模式支持mysql</span>  <span class="string">*******************#</span></span><br><span class="line"><span class="string">&gt;spring.datasource.platform=mysql</span></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;db.num=1</span></span><br><span class="line"><span class="string">&gt;db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=10000&amp;socketTimeout=30000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="string">&gt;db.user=数据库账号</span></span><br><span class="line"><span class="string">&gt;db.password=数据库密码</span></span><br></pre></td></tr></table></figure>
<p><strong>serverTimezone=UTC</strong>不要忘记了。（每次配置mysql8，都要带上这个设置）</p>
<p>然后启动nacos：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636699506385-b20079ed-0143-4f43-8791-baa2a05a7193.png" alt></p>
<p>启动成功，我们试一下，能不能存到数据库中，新建一个配置</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636699613637-8419ae67-dbae-47be-be53-014b96bb0d99.png" alt></p>
<p>成功存入数据库！</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636699673050-624c269c-e53c-4af6-bca4-79f2ada11586.png" alt></p>
</blockquote>
<h6 id="番外-nacos-linux踩坑必看">==(番外)nacos linux踩坑必看==</h6>
<p>最开始我用的nacos2.0.3，到集群那就出现了问题，只能开一个nacos，剩下两个开起来就报错。报错的信息：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/attachments/yuque/0/2021/txt/22423156/1636115364580-b52c91e1-48ef-4459-9182-388752447b2b.txt">📎startout.txt</a>  （start.out）  日志：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/attachments/yuque/0/2021/txt/22423156/1636115522178-750173d8-70ad-43ba-98c1-52f1791ebf7f.txt">📎nacos.log.txt</a> (nacos.log)。尝试了各种方法，改JVM配置等等，还是不行。最后选择使用跟视频里面一样的nacos版本1.1.4</p>
<p>使用1.1.4的时候数据库的配置 <code>/usr/local/mynacos/nacos/conf/</code> (1.1.4的安装路径)   application.properties 文件使用mysql8+ 需要加上时区 2.0.3 不需要</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#************************* 配置数据库 ****************************#</span><br><span class="line">spring.datasource.platform=mysql</span><br><span class="line"> </span><br><span class="line">db.num=1</span><br><span class="line">db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;serverTimezone=UTC</span><br><span class="line">db.user=root</span><br><span class="line">db.password=000000</span><br></pre></td></tr></table></figure>
<p>cluster.conf 还是跟之前一样配置；</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://startup.sh">startup.sh</a> 跟老师一样的改法，然后需要将JVM的配置修改，因为我的虚拟机只有4G内存，所以我把JVM配置调整为如下：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636115846275-0f7eef6b-d977-47d6-92be-5f1e7be2737c.png" alt></p>
<p>然后分别执行开启3333、4444、5555三个nacos，成功开启nacos集群</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636115985623-1655b0e4-a749-4856-b287-b91167099866.png" alt></p>
<p>使用nacos2+的朋友可以尝试开三台虚拟机，参考官方手册配置集群<a target="_blank" rel="noopener external nofollow noreferrer" href="https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html">nacos官方手册</a></p>
<p>==注意：用nacos1.4以上的，貌似就用不了这个模拟集群的方法了，老实复制3个nacos文件夹再逐个设置端口号启动 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/qq1623803207/article/details/120277919?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link">同一台机启动多个nacos的问题</a>==</p>
<h2 id="3、Sentinel实现熔断与限流">3、Sentinel实现熔断与限流</h2>
<h3 id="一、Sentinel">一、Sentinel</h3>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Sentinel">https://github.com/alibaba/Sentinel</a>   <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D">中文</a></p>
<p>Sentinel 是轻量级的流量控制、熔断降级Java库；功能类似于Hystrix</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302123770.png" alt="img" style="zoom:53%;">
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Sentinel/releases">下载地址</a></p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636120420628-55b29acd-23e4-4a77-8963-7e46ed37d7f2.png" alt="img" style="zoom:53%;">
<p>怎么玩：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel">入门文档</a></p>
<p>服务使用中的各种问题：服务雪崩、服务降级、服务熔断、服务限流</p>
<h3 id="二、安装Sentinel控制台">二、安装Sentinel控制台</h3>
<p>Sentinel分为两个部分：</p>
<ul>
<li>核心库（Java客户端）不依赖任何框架/库，能够云星宇所有Java运行时环境，同时对Dubbo/Spring Cloud等框架也有较好的支持——后台；</li>
<li>控制台（Dashboard）基于Spring Boot开发，打包后可以直接运行，不需要额外的Tomcat等应用容器——前台 8080</li>
</ul>
<h4 id="安装步骤">安装步骤</h4>
<p>下载到本地sentinel-dashboard-1.8.3.jar</p>
<p>运行命令：</p>
<p>前提需要Java8，且8080端口不能被占用；<code>java -jar sentinel-dashboard-1.8.3.jar</code></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302126895.png" alt="image-20230430212631736" style="zoom:30%;">
<p>访问 localhost:8080，账号密码均为sentinel</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302127528.png" alt="image-20230430212745372" style="zoom:33%;">
<h3 id="三、初始化演示工程">三、初始化演示工程</h3>
<h4 id="3-1-启动Nacos8848">3.1 启动Nacos8848</h4>
<h4 id="3-2-新建Module-cloudalibaba-sentinel-service8401">3.2 新建Module cloudalibaba-sentinel-service8401</h4>
<h5 id="3-2-1-pom-2">3.2.1 pom</h5>
<p>以后基本上nacos 跟 sentinel一起配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloudalibaba-sentinel-service8401<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud ailibaba sentinel --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合Web组件+actuator --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-2-2-yaml">3.2.2 yaml</h5>
<p>spring.cloud.sentinel.transport.port 端口配置会在应用对应的机器上启动一个 Http Server，该 Server 会与 Sentinel 控制台做交互。</p>
<blockquote>
<p>比如 Sentinel 控制台添加了1个限流规则，会把规则数据push给这个Http Server接收，Http Server再将规则注册到Sentinel中。</p>
<p><code>spring.cloud.sentinel.transport.port</code>：指定与Sentinel控制台交互的端口，应用本地会启动一个占用该端口的<code>Http Server</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment">#配置Sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">        <span class="comment">#默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line">        </span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-2-3-主启动类">3.2.3 主启动类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SentinelMainApp8401</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SentinelMainApp8401.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-4-业务类">3.2.4 业务类</h5>
<p>流量控制controller：FlowLimitController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlowLimitController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testA&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------testA&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testB&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testB</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------testB&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-3-测试">3.3 测试</h4>
<p>启动Sentinel8080 <code>java -jar sentinel-dashboard-1.8.2.jar</code>、启动微服务8401</p>
<p>查看Sentinel控制台，发现什么也没有。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302139316.png" alt="image-20230430213902838" style="zoom:33%;">
<p><code>原因：Sentinel采用懒加载机制</code></p>
<p>执行一下：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8401/testA">http://localhost:8401/testA</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8401/testB">http://localhost:8401/testB</a></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302140633.png" alt="image-20230430214004484" style="zoom:23%;">
<p>sentinel8080正在监控微服务8401</p>
<h3 id="四、流控规则">四、流控规则</h3>
<p>流量限制控制规则，分为：流控模式和流控效果</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122495.png" alt="img" style="zoom:53%;">
<p>各选项含义：</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636175587333-c9adeac1-c4a0-48be-b5f8-b174b1a4051c.png" alt="img" style="zoom:63%;">
<h4 id="4-1-流控模式">4.1 流控模式</h4>
<p><code>流控模式有三种：直接、关联、链路</code></p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636176700047-5a4c8c69-02ef-4ab9-a2a1-2f118d4b814b.png" alt="img" style="zoom:53%;">
<h5 id="4-1-1-直接（默认）-快速失败（默认）">4.1.1 直接（默认）+快速失败（默认）</h5>
<h6 id="1-QPS直接快速失败">(1) QPS直接快速失败</h6>
<p>QPS：query per second，每秒钟的请求数量，当调用该api的QPS达到阈值时，进行限流。</p>
<p>下面设置表示1秒钟内查询一次就是OK，若QPS&gt;1，就直接-快速失败，报默认错误</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636176644611-c8d5c126-80b4-40ae-a6d2-fa3de2cd58e0.png" alt="img" style="zoom:53%;">
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636176782203-f7067740-667d-4eda-99df-8a6e1f9f9361.png" alt></p>
<p>测试一下，当/testA的访问超过1次/s是，页面报错。被Sentinel限流，还能继续请求只要QPS&lt;=1。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302145169.png" alt="image-20230430214540692" style="zoom:33%;">
<p>小结：表示1秒钟内请求次数大于1，就直接快速失败，报默认错误。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122786.png" alt></p>
<p>直接调用默认的报错信息在技术上是OK的，但是是否应该有<code>自定义的后续处理</code>？应该有类似Hystrix的fallback的兜底方法。</p>
<h6 id="2-线程数直接快速失败">(2) 线程数直接快速失败</h6>
<p>当调用该api的线程数达到阈值的时候，进行限流。</p>
<p>与QPS直接快速失败不同的是，QPS情况下限制的是流量，比如银行的人流量只能是1人/s，也就是说每次只能一个人进入银行办理业务；而线程数就好比银行只有一个窗口开放，一群人都可以进入银行，但是每次只能处理一个人的业务。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636178641049-10ce2a40-c119-496b-a555-f1d68ebf23cf.png" alt></p>
<p>演示效果：</p>
<p>先修改一下8401的业务类</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636181621634-2a4740b7-24a3-47dc-be31-b41231bf546f.png" alt="img" style="zoom:53%;">
<p>然后重启8401，测试/testA，最好用两个浏览器访问，效果更明显</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636182093947-e60d26d5-6444-48e2-9031-404b805c86b1.png" alt></p>
<h5 id="4-1-2-关联">4.1.2 关联</h5>
<p>当关联的资源达到阈值时，就限流自己。比如当与A关联的资源B达到阈值后，就限流A自己。</p>
<p>支付接口达到阈值，限流下订单的接口。</p>
<h6 id="1-配置">1. 配置</h6>
<p>设置效果：当关联资源/testB的qps阀值超过1时，就限流/testA的Rest访问地址，当关联资源到阈值后限制配置好的资源名</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636185529204-c4973c0a-7ca9-4fe9-857c-ed28a602c17d.png" alt="img" style="zoom:53%;">
<h6 id="2-测试">2. 测试</h6>
<p>单独访问testB成功。</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636185759699-dbad4fbb-7c9e-4e3f-9990-4a21f12f34ae.png" alt="img" style="zoom:33%;">
<p>postman模拟并发密集访问testB</p>
<p>先创建一个集合，名字自己随便取。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122152.png" alt></p>
<p>然后将创建的访问/testB的请求保存在创建的集合中</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636186397189-6b78e38a-d267-4eb1-9090-f62e50bb003e.png" alt="img" style="zoom:50%;">
<p>设定集合运行参数，20个线程，每次间隔0.3s访问一次（QPS&gt;1），执行：</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122754.png" alt="img" style="zoom:50%;">
<p>然后再访问/testA，发现被限流，等postman<code>执行完毕</code>，testA又可以访问了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636186747122-a0428fb4-34f8-4336-a04b-784b3eb9cb9f.png" alt></p>
<h5 id="4-1-3-链路">4.1.3 链路</h5>
<p>需要测试链路的话，springcloud 阿里巴巴版本需要2.1.1.RELEASE以上，在父工程的pom中修改，不要直接在子module的pom中修改，版本有对应关系，不然报错。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636198092134-626f793b-2f04-47ae-a4df-5f771fadd13a.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636198752208-50584f8f-ed1b-4a84-910e-7dfed9a0d1f4.png" alt></p>
<ul>
<li>Sentinel从1.6.3版本开始，Sentinel Web Filter 默认收敛所有的URL入口的Context，因此链路限流不生效</li>
<li>1.7.0版本开始，官方在CommomFilter中引入了<code>WEB_CONTEXT_UNIFY</code>这个init parameter，用于控制是否收敛context，将其配置为<code>false</code>即可根据不同的URL进行链路限流</li>
<li>Spring Cloud Alibaba 在2.1.1.RELEASE版本后，可以通过配置spring.cloud.sentinel.web-context-unify=false关闭</li>
</ul>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122417.png" alt></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Sentinel/issues/1313">https://github.com/alibaba/Sentinel/issues/1313</a></p>
<h4 id="测试-6">测试</h4>
<p>启动8401，给/testA 设置链路+快速失败流控规则</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636198858162-237cfa39-c6b3-4d95-8211-c73c44e4ad49.png" alt></p>
<p>这里入口资源就是簇点链路中，资源名称的上一级。</p>
<p>访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8401/linktestA">http://localhost:8401/linktestA</a>  ，多次刷新出现限流</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636201194747-227fde3b-a8a4-4935-b5a5-3556bc1a6008.png" alt>，但是这种情况我个人觉得跟直接快速失败区别不大，只直接是监控/testA资源，而链路是监控/testA的资源入口sentinel_web_servlet_context。</p>
<p>然后我又参看了其他博客，<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/qq_29064815/article/details/107102060?utm_term=sentinel%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F%E7%9A%84%E9%93%BE%E8%B7%AF&amp;utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~sobaiduweb~default-0-107102060&amp;spm=3001.4430">流控模式——链路</a>。增加了FlowLimitService 修改了controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.annotation.SentinelResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlowLimitService</span> &#123;</span><br><span class="line">    <span class="meta">@SentinelResource(&quot;message&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">message</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.FlowLimitService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlowLimitController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    FlowLimitService flowLimitService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testA&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//暂停0.8秒</span></span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            TimeUnit.MILLISECONDS.sleep(800);</span></span><br><span class="line"><span class="comment">//        &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------testA&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testB&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testB</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------testB&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//   链路测试</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/linktestA&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">linktestA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> flowLimitService.message();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/linktestB&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">linktestB</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> flowLimitService.message();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分别通过/linktetA 和 /linktestB都是message的入口，然后设置/linktestA入口的流量限制，发现不起作用。。。</p>
<h4 id="4-2-流控效果">4.2 流控效果</h4>
<p><strong>快速失败</strong>在上面的流控模式演示过了，他是默认的流控效果，直接失败，抛出异常。源码：com.alibaba.csp.sentinel.slots.block.flow.controller.DefaultController</p>
<h5 id="4-2-1-warm-up-预热">4.2.1 warm up 预热</h5>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---%E5%86%B7%E5%90%AF%E5%8A%A8">官网</a>         源码：<code>com.alibaba.csp.sentinel.slots.block.flow.controller.WarmUpController</code></p>
<p>公式：阈值除以coldFactor(默认值为3),经过预热时长后才会达到阈值</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636204182838-32d2e249-f24f-4837-a0f0-3c4be43a5b8c.png" alt="img" style="zoom:60%;">
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636204711029-22aea67e-cc6b-4cfd-994c-dd51bb5fd0b6.png" alt="img" style="zoom:67%;">
<h5 id="测试-7">测试</h5>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122073.png" alt></p>
<p>狂点请求，可以看通过的QPS逐渐增加，最开始会报错限流，之后就可以抗住10/s的QPS了</p>
<p>应用场景：秒杀系统在开启的瞬间，会有很多流量上来，很有可能把系统打死，预热方式就是把为了保护系统，可慢慢的把流量放进来，慢慢的把阀值增长到设置的阀值。</p>
<h5 id="4-2-2-排队等待">4.2.2 排队等待</h5>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6">官网</a>  		源码：<code>com.alibaba.csp.sentinel.slots.block.flow.controller.RateLimiterController</code></p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636205316214-62574c1a-6bb6-47d6-915f-b02211bf4281.png" alt="img" style="zoom:50%;">
<p>匀速排队，让请求以均匀的速度通过，阀值类型必须设成QPS，否则无效。</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636205407842-08de7a67-8015-421a-9181-e3fa123cf8be.png" alt="img" style="zoom:33%;">
<p>/testA的QPS最大为1，超过的话就排队等待，等待的超时时间为20000ms。</p>
<p>修改一下业务代码，把线程名打印出来以验证是否排队。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122862.png" alt></p>
<h5 id="测试-8">测试</h5>
<p>postman：</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636205861798-1d6022d2-1cfc-4e83-a31f-9b05bcc6f293.png" alt="img" style="zoom:50%;">
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636206130850-dd47f017-0e97-4fbc-b825-b9e5ea590c12.png" alt="img" style="zoom:50%;">
<p>可以看到刚好满足1s一个请求，说明请求的执行进行了排队。</p>
<h3 id="五、降级规则（熔断规则）">五、降级规则（熔断规则）</h3>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7">官网</a></p>
<p>老版本的Sentinel的断路器是    没有半开状态的，半开的状态系统自动去检测是否请求有异常，</p>
<p>没有异常就关闭断路器恢复使用，</p>
<p>有异常则继续打开断路器不可用。</p>
<blockquote>
<p>具体可以参考Hystrix。（在Hystrix中 快照时间窗口是值 阈值检测时间 ，而休眠时间窗口是指 断路器从开启到半开状态间隔的时间）</p>
</blockquote>
<p><strong>新版本的Sentinel加入了半开状态</strong>！</p>
<h5 id="5-1-降级策略">5.1 降级策略</h5>
<p>Sentinel 熔断降级会在调用链路中某个资源出现<code>不稳定状态时</code>（例如调用超时或异常比例升高），<code>对这个资源的调用进行限制</code>，让请求快速失败，避免影响到其它的资源而导致级联错误。</p>
<p>当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都<code>自动熔断</code>（默认行为是抛出 <code>DegradeException</code>）。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122472.png" alt></p>
<h6 id="5-1-1-慢调用比例，RT（平均响应时间，秒级）">5.1.1 慢调用比例，RT（平均响应时间，秒级）</h6>
<p>老版本：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636378468415-d870b7ac-5a40-47c1-b6ca-13ae193bd2b4.png" alt></p>
<p>新版本：</p>
<ul>
<li>慢调用比例 (SLOW_REQUEST_RATIO)：
<ul>
<li>选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。</li>
<li>当单位统计时长（statIntervalMs）内请求数目<code>大于</code>设置的最小请求数目，<strong>并且</strong>慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。</li>
<li>经过熔断时长后<code>熔断器</code>会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。（跟豪猪科类似）</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636207429643-4edd50c3-d110-4666-ad70-831e744bbfb9.png" alt></p>
<h6 id="实战测试">实战测试</h6>
<p><strong>业务类中加一个rest 接口，以用于测试：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testD&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testD</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//暂停1秒</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;testD  测试慢调用比例 RT&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;------tedtD&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636266326957-7c5e050b-cf3b-41b9-9d5f-25708ff0a496.png" alt> 访问没有问题</p>
<p><strong>编辑熔断规则：</strong></p>
<p>在1000ms的统计时间内，总请求数（超过5次）中有80%的请求最大RT超过了200ms，那么触发熔断机制，熔断2s。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636265807427-1198f086-d189-442c-975d-e971611c0e16.png" alt></p>
<p><strong>jmeter压测：</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302236069.png" alt="image-20230430223609870" style="zoom:30%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302235058.png" alt="image-20230430223546873" style="zoom:30%;">
<p>永远一秒钟进来10个线程（大于5个了）调用testD，我们希望200毫秒处理完本次任务，如果超过200毫秒还没处理完，在未来s秒钟的时间内，断路器打开(保险丝跳闸)微服务不可用，保险丝跳闸断电了。</p>
<p>testD被熔断了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636266522552-1fe03a0c-6140-4994-9717-6e42c25f60e9.png" alt></p>
<p>从实时监控也可以看到，在09的时候开始熔断。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122787.png" alt></p>
<p>后续我停止jmeter，没有这么大的访问量了，断路器半开到关闭(保险丝恢复)，微服务恢复OK。</p>
<h6 id="5-1-2-异常比例">5.1.2 异常比例</h6>
<p>老版本：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636378442709-b1dd34e0-96d1-4be1-bbfd-26f9986b2a07.png" alt></p>
<p>新版本：</p>
<ul>
<li>异常比例 (ERROR_RATIO)：当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。</li>
<li>经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</li>
<li>异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636207879946-e9294f3f-9dff-469f-9ff9-29fe9298f491.png" alt></p>
<h6 id="实战测试-2">实战测试</h6>
<p><strong>修改业务类：</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636267293236-37a974f2-db79-4a0d-99e2-18aa1f0141c9.png" alt></p>
<p><strong>编辑熔断规则：</strong></p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636267653333-5d7543f3-6415-46f0-aa37-5e7438583c52.png" alt="img" style="zoom:53%;">
<p>1000ms统计时长内，小于5次的请求中超过80%的请求出现异常，则熔断2s。</p>
<p><strong>jmeter压测：</strong></p>
<p>未开启jmeter，单独访问一次，必然来一次报错一次(int age  = 10/0)，调一次错一次；</p>
<p>开启jmeter后，直接高并发发送请求，多次调用达到我们的配置条件了。</p>
<p>断路器开启(保险丝跳闸)，微服务不可用了，不再报错error而是服务降级了。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122688.png" alt></p>
<p>testD被熔断。</p>
<p>停掉jemeter后过2s。报  /zero  错误，因为业务类代码中 有个10/0。</p>
<h6 id="5-1-3-异常数">5.1.3 异常数</h6>
<p>老版本：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636378394872-1cfc747b-422a-4df5-a551-e21137e49095.png" alt></p>
<p>时间窗口一定要大于等于60秒。</p>
<p>新版本</p>
<ul>
<li>异常数 (ERROR_COUNT)：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</li>
</ul>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636207898160-37b7b016-4d79-4b44-a455-a072fae85cf2.png" alt="img" style="zoom: 50%;">
<h6 id="实战测试-3">实战测试</h6>
<p><strong>修改业务类：</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636268914525-f0a66727-3263-4f54-8dca-7a94f8a4f812.png" alt></p>
<p><strong>编辑熔断规则：</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636268891084-07a17150-d76a-46b3-a166-71240d074b60.png" alt></p>
<p><strong>手动测试：</strong></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122432.png" alt></p>
<p>这里我测试有bug，虽然熔断了但是熔断时长不是我配置的5s，大约是一分钟，统计时长也不是1s，好像也是一分钟，同时没达到最小请求数，只达到3次异常就直接熔断了。虽然我用的新版本，但是逻辑好像跟老版本的一样？</p>
<h3 id="六、热点key限流">六、热点key限流</h3>
<h4 id="6-1-基本介绍">6.1 基本介绍</h4>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Sentinel/wiki/%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81">官网</a></p>
<p>何为热点：热点即经常访问的数据，很多时候我们希望统计或者限制某个热点数据中<code>访问频次最高的TopN</code>数据，并对其访问进行限流或者其它操作。比如：</p>
<ul>
<li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li>
<li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li>
</ul>
<p>热点参数限制会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限制。热点参数限流可以看作是一种<code>特殊的流量控制</code>，仅对包含热点参数的资源调用生效。</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636271319999-dd06109b-159d-417c-ab3a-8ff219009af4.png" alt="img" style="zoom:53%;">
<p>Sentinel利用LRU策略统计最近最常访问的热电参数，结合<code>令牌桶算法</code>来进行<code>参数级别的流控</code>。热点参数限流<code>支持集群模式</code>。</p>
<h4 id="6-2-基本使用">6.2 基本使用</h4>
<p>兜底防范 分为系统默认和客户自定义两种，</p>
<p>​	之前的case，都是使用sentinel系统默认的提示：Blocked by Sentinel (flow limiting)。</p>
<p>​	那我们能不能自定义兜底方法呢？类似hystrix，某个方法出问题了，就找对应的兜底降级方法？</p>
<p>​		类似于**@HystrixCommand，** 引入**@SentinelResource**注解。</p>
<p>热点规则共有资源名、限流模式（只支持QPS模式）、参数索引、单机阈值、统计窗口时长、是否集群6种参数，还有一些高级选项，用到时会详细介绍。这里会用到注解中的value作为资源名，兜底方法会在后面详细介绍<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/mrlinxi/pxvr4g/rg5riy#HQt8b">@SentinelResource注解详解</a></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122851.png" alt="img" style="zoom:33%;">
<p>注意：</p>
<p><strong>资源名</strong>：**唯一路径，默认为请求路径。**此处必须是 <code>@SentinelResource</code> 注解的 value 属性值，配置<code>@GetMapping</code> 的请求路径无效</p>
<h5 id="6-2-1-测试方法">6.2.1 测试方法</h5>
<p>还是在8401的controller中，加入热点测试方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testHotKey&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testHotKey&quot;, blockHandler = &quot;del_testHotKey&quot;)</span>   <span class="comment">//这里的名称可以随便写，但是一般跟rest地址一样</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testHotkey</span><span class="params">(<span class="meta">@RequestParam(value = &quot;p1&quot;, required = false)</span> String p1,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(value = &quot;p1&quot;, required = false)</span> String p2)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;------testHotkey&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里是我们自定义的兜底方法</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">del_testHotKey</span><span class="params">(String p1, String p2, BlockException e)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;这次不用默认的兜底提示Blocked by Sentinel(flow limiting)，自定义提示：del_testHotKeyo(╥﹏╥)o...&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注解<code>@SentinelResource(value = &quot;testHotKey&quot;, blockHandler = &quot;del_testHotKey&quot;)</code></p>
<p><strong>分析：</strong></p>
<ul>
<li>其中<code>value = &quot;testHotKey&quot;</code>是一个标识（Sentinel资源名），与rest的<code>/testHotKey</code>对应，这里value的值可以任意写，但是我们约定与rest地址一致，唯一区别是没有<code>/</code>。</li>
<li><code>blockHandler = &quot;del_testHotKey&quot; </code>则表示如果违背了Sentinel中配置的流控规则，就会调用我们自己的兜底方法del_testHotKey</li>
</ul>
<h5 id="6-2-2-配置热点key限流规则">6.2.2 配置热点key限流规则</h5>
<p>绑定testHotKey资源，把testHotKey对应的第一个参数作为热点key进行监控。设定热点限流规则：当该资源的访问QPS超过1次/s的时候，产生限流并执行自定义的<code>del_testHotKey</code>兜底方法。</p>
<p>简而言之：方法testHotKey里面第一个参数只要QPS超过每秒1次，马上降级处理。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636425843025-86f932d2-ce64-4c9a-baa1-b67ed8db5eec.png" alt></p>
<h5 id="6-2-3-测试">6.2.3 测试</h5>
<p>访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8401/testHotKey?p1=a&amp;p2=b">http://localhost:8401/testHotKey?p1=a&amp;p2=b</a></p>
<p>1次/s正常显示，迅速点击两次，触发热点限流，执行自定义兜底方法：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636275834807-7920316a-2d72-40fd-a595-60140e381d43.png" alt></p>
<p>仅传入参数p2没有任何影响： <a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8401/testHotKey?p2=b">http://localhost:8401/testHotKey?p2=b</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636275869802-3bdd8cb1-e801-45df-9953-c5a5969e1c5f.png" alt></p>
<p>现在开两个访问，一个通过jmeter压测<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8401/testHotKey?p1=a&amp;p2=b%EF%BC%8C%E5%8F%A6%E5%A4%96%E5%86%8D%E5%8D%95%E7%8B%AC%E4%BD%BF%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AEhttp://localhost:8401/testHotKey?p2=b%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%8F%AA%E5%B8%A6%E5%8F%82%E6%95%B0p2%E8%AE%BF%E9%97%AE%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95%E5%BD%B1%E5%93%8D%E3%80%82">http://localhost:8401/testHotKey?p1=a&amp;p2=b，另外再单独使用浏览器访问http://localhost:8401/testHotKey?p2=b，发现只带参数p2访问没有任何影响。</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636276162514-571b00d8-1487-4190-9988-2a8c0e648b13.png" alt></p>
<p>不配置blockeHandler（兜底方法）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636276470239-1a76b8b7-d7bb-4aa3-8fea-0d0634e9c479.png" alt></p>
<p>触发热点限流降级会出现error page，对用户不友好。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636276517119-596fd456-81dc-4164-9c2b-5b8f6a8404bc.png" alt></p>
<h4 id="6-3-参数例外项">6.3 参数例外项</h4>
<p>上述案例演示了第一个参数p1，当QPS超过1秒1次点击后马上被限流</p>
<p>特例情况：我们期望p1参数当它是某个特殊值时，它的限流值和平时不一样，比如当p1的值等于5时，它的阈值可以达到200。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122090.png" alt="img" style="zoom:50%;">
<p>测试</p>
<p>狂点<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8401/testHotKey?p1=5&amp;p2=b">http://localhost:8401/testHotKey?p1=5&amp;p2=b</a> 没有限流</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636283340923-8390dc9b-5578-4b43-950f-38c18929da74.png" alt></p>
<h4 id="6-4-其他">6.4 其他</h4>
<p>手动添加一个异常：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636283487769-27477123-c4db-4bb0-870d-86d588b5a972.png" alt></p>
<p>测试直接错误页面。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636283506208-a3983356-e6a2-44b4-85d5-f76bd33b08e3.png" alt></p>
<blockquote>
<p>要注意：</p>
<p>Sentinel它<code>只管</code>你有没有触发它的限流规则，也可以说<code>只管</code>这个web交互页面（控制台）里面的东西。</p>
<p>配置类的东西Sentinel<code>可以管</code>，java异常的错误不管。</p>
</blockquote>
<p><strong>@SentinelResource</strong></p>
<p>处理的是Sentinel控制台配置的违规情况，有blockHandler方法配置的兜底处理；</p>
<p>RuntimeException</p>
<p>int age = 10/0,这个是java运行时报出的运行时异常RunTimeException，@SentinelResource不管</p>
<p><strong>总结：</strong></p>
<p><code>@SentinelResource主管配置出错，运行出错该走异常走异常</code></p>
<h3 id="七、系统规则（系统自适应限流）">七、系统规则（系统自适应限流）</h3>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81">官网</a></p>
<p>Sentinel 系统自适应限流<code>从整体维度对应用入口流量进行控制</code>，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，<code>通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</code></p>
<p>系统保护规则是应用整体维度的，而不是资源维度的，并且<strong>仅对入口流量生效</strong>。</p>
<p>入口流量指的是进入应用的流量（<a target="_blank" rel="noopener external nofollow noreferrer" href="http://EntryType.IN">EntryType.IN</a>），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p>
<p>系统规则支持以下的模式：</p>
<ul>
<li><strong>Load 自适应</strong>（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 maxQps * minRt 估算得出。设定参考值一般是 CPU cores * 2.5。</li>
<li><strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li>
<li><strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li>
<li><strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li>
<li><strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li>
</ul>
<h4 id="案例——配置全局QPS">案例——配置全局QPS</h4>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636283979732-9ec624d5-b538-4e97-b131-800c32624945.png" alt></p>
<p>不管是/testA还是/testB 只要QPS &gt; 1 整个系统就不能用。</p>
<p>这个粒度太粗，就相当于一个窗口人很多，整个银行就不接待人了，<code>不太建议使用</code>。</p>
<h3 id="八、-SentinelResource-注解详解">八、@SentinelResource 注解详解</h3>
<h4 id="8-1-按资源名称限流-后续处理">8.1 按资源名称限流+后续处理</h4>
<p><code>启动nacos+sentinel</code></p>
<h5 id="8-1-1-修改8401">8.1.1 修改8401</h5>
<h6 id="1-pom">(1) pom</h6>
<p>引入我们自定义的公共api jar包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="2-业务类">(2) 业务类</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.annotation.SentinelResource;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/byResource&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;byResource&quot;, blockHandler = &quot;handleException&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">byResource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;按资源名称限流测试OK&quot;</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2020L</span>, <span class="string">&quot;serial001&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">handleException</span><span class="params">(BlockException exception)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">444</span>, exception.getClass().getCanonicalName() + <span class="string">&quot;\t 服务不可用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="8-1-2-配置流控规则——按资源名称添加流控规则">8.1.2 配置流控规则——按资源名称添加流控规则</h5>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122696.png" alt></p>
<h5 id="8-1-3-测试">8.1.3 测试</h5>
<p>自测：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636285275609-5ad7070a-105e-4aec-8237-202601cd4b82.png" alt></p>
<p>触发流控规则：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636285458697-f546d3c3-34da-491e-a379-b0ccfcf2cc9e.png" alt></p>
<h5 id="8-1-4-问题">8.1.4 问题</h5>
<blockquote>
<p>如果我们重启8401会发现之前配置的一些规则都没有了。难道每次重启服务器都要重新配置一遍规则吗？规则如何进行持久化？==见十==</p>
</blockquote>
<h4 id="8-2-按照Url地址限流-后续处理">8.2 按照Url地址限流+后续处理</h4>
<p>通过访问的URL来限流，会返回Sentinel自带默认的限流处理信息</p>
<h5 id="8-2-1-修改controller">8.2.1 修改controller</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/rateLimit/byUrl&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;byUrl&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">byUrl</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>,<span class="string">&quot;按url限流测试OK&quot;</span>,<span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2020L</span>,<span class="string">&quot;serial002&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="8-2-2-设置流控规则及测试">8.2.2 设置流控规则及测试</h5>
<p>先自测，没有问题：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636285855107-0bf3e784-1753-46cc-a91a-09056010b7a0.png" alt></p>
<p>按rest URI设置流控规则</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636285921229-af984a98-bdca-4013-ba83-a43c63fdfe1a.png" alt></p>
<p>触发流控：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122366.png" alt></p>
<blockquote>
<p>这个没有自定义的兜底的方法，返回Sentinel自带的限流处理结果。</p>
</blockquote>
<h4 id="8-3-总结以及面临的问题">8.3 总结以及面临的问题</h4>
<p>不管是<code>@GetMapping(rest url)</code>还是 <code>@SentinelResource</code>，只要是唯一的，就可以作为流控规则的资源名称。</p>
<p>如果没有自定义自己的兜底方法，那么就使用系统自带的。</p>
<p>问题：</p>
<ul>
<li>依照现有条件，我们自定义的处理方法又和业务代码耦合在一块，不直观。如果都用系统默认的，就没有体现我们自己的业务要求。</li>
<li>如果每个业务方法/API接口都添加一个兜底的，那代码膨胀加剧。</li>
<li>全局统一的处理方法没有体现。</li>
</ul>
<h4 id="8-4-客户自定义限流处理逻辑">8.4 客户自定义限流处理逻辑</h4>
<p>为了解决代码耦合与膨胀的问题</p>
<h5 id="8-4-1-创建CustomerBlockHandler类用于自定义限流处理逻辑">8.4.1 创建CustomerBlockHandler类用于自定义限流处理逻辑</h5>
<p>在CustomerBlockHandler类中统一的处理限流提示、服务降级的说明等等。。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.myhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.Payment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerBlockHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CommonResult <span class="title function_">handlerException</span><span class="params">(BlockException e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">4444</span>, <span class="string">&quot;按客户自定义, global handlerException----1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CommonResult <span class="title function_">handlerException2</span><span class="params">(BlockException e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">4444</span>, <span class="string">&quot;按客户自定义, global handlerException----2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="8-4-2-修改RateLimitController，使用自定义处理逻辑类">8.4.2 修改RateLimitController，使用自定义处理逻辑类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.annotation.SentinelResource;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.myhandler.CustomerBlockHandler;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/byResource&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;byResource&quot;, blockHandler = &quot;handleException&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">byResource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;按资源名称限流测试OK&quot;</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2020L</span>, <span class="string">&quot;serial001&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">handleException</span><span class="params">(BlockException exception)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">444</span>, exception.getClass().getCanonicalName() + <span class="string">&quot;\t 服务不可用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rateLimit/byUrl&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;byUrl&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">byUrl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;按url限流测试OK&quot;</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2020L</span>, <span class="string">&quot;serial002&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CustomerBlockHandler自定义类,来处理服务降级、限流提示.....</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义通用的限流处理逻辑，</span></span><br><span class="line"><span class="comment">     * blockHandlerClass = CustomerBlockHandler.class</span></span><br><span class="line"><span class="comment">     * blockHandler = handleException2</span></span><br><span class="line"><span class="comment">     * 上述配置：找CustomerBlockHandler类里的handleException2方法进行兜底处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//自定义通用的限流处理逻辑</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rateLimit/customerBlockHandler&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;customerBlockHandler&quot;,</span></span><br><span class="line"><span class="meta">            blockHandlerClass = CustomerBlockHandler.class,</span></span><br><span class="line"><span class="meta">            blockHandler = &quot;handlerException2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">customerBlockHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;按客户自定义&quot;</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2020L</span>, <span class="string">&quot;serial003&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="8-4-3-测试">8.4.3 测试</h5>
<p>启动8401，先测试一次<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8401/rateLimit/customerBlockHandler">http://localhost:8401/rateLimit/customerBlockHandler</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636287580303-28b3cfb9-1b59-45f3-a285-490cdadfcc6c.png" alt></p>
<p>设置流控规则：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636287621476-3a3eaf6f-4507-468f-bde2-decdc7f78973.png" alt></p>
<p>触发流控，看是否是我们自定义提示：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636287665130-41bc38f3-b6cd-483a-b3f4-7fbe7462cb0a.png" alt></p>
<p>自定义提示出来了！</p>
<h5 id="8-4-4-结构说明">8.4.4 结构说明</h5>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636287798408-543e1ede-a827-49c3-92f0-5c0b13725223.png" alt></p>
<p>这样就实现了兜底方法与业务方法的解耦。</p>
<h4 id="8-5-更多属性说明">8.5 更多属性说明</h4>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81">注解支持文档</a></p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636289727930-10fdb9a1-5ddf-47a5-bd1a-8c62f33357ed.png" alt="img" style="zoom:70%;">
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636289848511-939d2aa2-1c45-4d66-922c-56a2da957cac.png" alt></p>
<h3 id="九、服务熔断">九、服务熔断</h3>
<p>主要内容：</p>
<ul>
<li>sentinel分别整合ribbon+openFeign以及设置fallback</li>
<li>熔断框架比较</li>
</ul>
<h4 id="9-1-Ribbon系列">9.1 Ribbon系列</h4>
<p>nacos中整合了Ribbon，所以直接使用nacos就行。启动nacos和Sentinel。</p>
<h5 id="9-1-1-服务提供者-cloudalibaba-provider-payment9003-9004">9.1.1 服务提供者(cloudalibaba-provider-payment9003/9004)</h5>
<p>新建cloudalibaba-provider-payment9003/9004两个一样的做法</p>
<h6 id="1-pom-2">(1) pom</h6>
<p>2020版和springcloud和nacos记得引入spring-cloud-starter-loadbalancer依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloudalibaba-provider-payment9003<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="2-yml">(2) yml</h6>
<p>9004 别忘了改端口号</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#配置Nacos地址</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
<h6 id="3-主启动类">(3) 主启动类</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain9003</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentMain9003.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-业务类">(4) 业务类</h6>
<p>这里图方便，就没有连接数据库。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Long, Payment&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        hashMap.put(<span class="number">1L</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">1L</span>, <span class="string">&quot;28a8c1e3bc2742d8848569891fb42181&quot;</span>));</span><br><span class="line">        hashMap.put(<span class="number">2L</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2L</span>, <span class="string">&quot;bba8c1e3bc2742d8848569891ac32182&quot;</span>));</span><br><span class="line">        hashMap.put(<span class="number">3L</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">3L</span>, <span class="string">&quot;6ua8c1e3bc2742d8848569891xt92183&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> hashMap.get(id);</span><br><span class="line">        CommonResult&lt;Payment&gt; result = <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;from mysql,serverPort:  &quot;</span> + serverPort, payment);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="5-测试">(5) 测试</h6>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9003/paymentSQL/1">http://localhost:9003/paymentSQL/1</a></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122758.png" alt></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9004/paymentSQL/1">http://localhost:9004/paymentSQL/1</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636295338547-274e5857-8816-4723-a2e7-de4cc0c9ef4f.png" alt></p>
<h5 id="9-1-2-服务消费者84-cloudalibaba-consumer-nacos-order84">9.1.2 服务消费者84(cloudalibaba-consumer-nacos-order84)</h5>
<p>新建cloudalibaba-consumer-nacos-order84</p>
<h6 id="1-pom-3">(1) pom</h6>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloudalibaba-consumer-nacos-order84<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud ailibaba sentinel --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="2-yml-2">(2) yml</h6>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">84</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment">#配置Sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">        <span class="comment">#默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)</span></span><br><span class="line"><span class="comment">#方便controller的@value获取</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>
<h6 id="3-主启动类-2">(3) 主启动类</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderNacosMain84</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderNacosMain84.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-业务类-2">(4) 业务类</h6>
<p>因为用的Ribbon，需要使用其提供的RestTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span>  <span class="comment">//不要忘了</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.annotation.SentinelResource;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CircleBreakerController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.nacos-user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String SERVICE_URL;</span><br><span class="line">    <span class="comment">//public static final String SERVICE_URL = &quot;http://nacos-payment-provider&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;fallback&quot;)</span>  <span class="comment">//没有配置</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span> + id, CommonResult.class, id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="5-测试-2">(5) 测试</h6>
<p>负载均衡实现</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010016455.png" alt="image-20230501001604246" style="zoom:50%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010016605.png" alt="image-20230501001627416" style="zoom:50%;">
<h5 id="9-1-3-fallback-和-blockHandler">9.1.3 fallback 和 blockHandler</h5>
<p>加深<code>@SentinelResource(value = &quot;xxx&quot;, fallback = &quot;fffff&quot;, blockHandler = &quot;bbbbbb&quot;)</code>注解理解：</p>
<p><code>fallback</code>管运行异常，<code>blockHandler</code>管配置违规。</p>
<p><code>fallback</code>对应服务降级，就是服务出错了应该怎么办（需要有个兜底方法）；</p>
<p><code>blockHandler</code>对应服务熔断，就是我现在服务不可用，我应该怎么办，怎么给客户一个户提示（同样需要一个兜底方法）</p>
<h5 id="9-1-4-差异化配置">9.1.4 差异化配置</h5>
<p><strong>这里改的业务类代码均是消费者84端的业务类代码，不要搞错了。</strong></p>
<p>降级是服务业务代码出现错误的兜底</p>
<p>熔断是服务不可用。</p>
<p>降级是兜底方法                  熔断是对服务保护时间窗口期服务不可用。</p>
<h6 id="1-没有任何配置">(1) 没有任何配置</h6>
<p>前面我们的84消费端，<code>@SentinelResource</code>里面只配置了<code>value</code>，<code>fallback</code>和<code>blockHandler</code>都没有配置，该情况下我们测试一下<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:84/consumer/fallback/4">http://localhost:84/consumer/fallback/4</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636296443903-85032cef-0249-47a7-9422-5b2626522837.png" alt></p>
<p>出现了错误页面，error page对客户不友好，所以我们需要有兜底方法。</p>
<h6 id="2-只配置fallback">(2) 只配置fallback</h6>
<p><code>fallback</code>对应服务降级，就是服务可以正常访问，但是业务逻辑出现错误，需要降级兜底。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="comment">//@SentinelResource(value = &quot;fallback&quot;) //没有配置</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;fallback&quot;, fallback = &quot;handlerFallback&quot;)</span> <span class="comment">//fallback负责业务异常</span></span><br><span class="line"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span> + id, CommonResult.class, id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">handlerFallback</span><span class="params">(<span class="meta">@PathVariable</span>  Long id,Throwable e)</span> &#123;</span><br><span class="line">    <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>&lt;&gt;(<span class="number">444</span>,<span class="string">&quot;兜底异常handlerFallback,exception内容  &quot;</span>+e.getMessage(),payment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636296874173-d549dc01-eea9-4008-8970-530ddd329d87.png" alt></p>
<p>访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:84/consumer/fallback/4%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%B8%9A%E5%8A%A1%E5%BC%82%E5%B8%B8">http://localhost:84/consumer/fallback/4，可以看到业务异常</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636296836332-e0231afe-55ae-4999-a4a6-02c656f443d7.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636376600977-3e77373a-45cd-4f57-b09c-ef7b84ad1440.png" alt></p>
<h6 id="3-只配置blockHandler">(3) 只配置blockHandler</h6>
<p><code>blockHandler</code>对应服务熔断，当前<code>sentinel</code>配置已经违规（RT数过多、异常过多），服务熔断后不可用，需要给客户提示，进行一个熔断的兜底。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="comment">//@SentinelResource(value = &quot;fallback&quot;) //没有配置</span></span><br><span class="line"><span class="comment">//@SentinelResource(value = &quot;fallback&quot;, fallback = &quot;handlerFallback&quot;) //fallback负责业务异常,对应服务降级</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;fallback&quot;, blockHandler = &quot;blockHandler&quot;)</span>  <span class="comment">//blockHandler只负责sentinel控制台配置违规,对应服务熔断</span></span><br><span class="line"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span> + id, CommonResult.class, id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//本例是fallback</span></span><br><span class="line"><span class="comment">//    public CommonResult handlerFallback(@PathVariable  Long id,Throwable e) &#123;</span></span><br><span class="line"><span class="comment">//        Payment payment = new Payment(id,&quot;null&quot;);</span></span><br><span class="line"><span class="comment">//        return new CommonResult&lt;&gt;(444,&quot;兜底异常handlerFallback,exception内容  &quot;+e.getMessage(),payment);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//本例是blockHandler</span></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">blockHandler</span><span class="params">(<span class="meta">@PathVariable</span>  Long id, BlockException blockException)</span> &#123;</span><br><span class="line">    <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>&lt;&gt;(<span class="number">445</span>,<span class="string">&quot;blockHandler-sentinel 限流,无此流水: blockException  &quot;</span></span><br><span class="line">                              + blockException.getMessage(),payment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636377488633-9fbf083a-c1b7-4b8f-b0fb-780cc3149cd9.png" alt="img" style="zoom:53%;">
<p>配置sentinel</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122788.png" alt></p>
<p>访问：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:84/consumer/fallback/5">http://localhost:84/consumer/fallback/5</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636378622776-6814a21d-f639-4916-88c3-a02a09ca9ea5.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636378646427-5916609c-ee75-4561-b82b-a5305ca1ad2d.png" alt></p>
<p>这里还是跟之前一样的bug，很迷。</p>
<h6 id="4-fallback和blockHandler都配置">(4) fallback和blockHandler都配置</h6>
<p>同时有降级跟熔断的兜底方法，当降级达到sentinel配置规则后，触发熔断。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;fallback&quot;, fallback = &quot;handlerFallback&quot;, blockHandler = &quot;blockHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span> + id, CommonResult.class, id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//本例是fallback</span></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">handlerFallback</span><span class="params">(<span class="meta">@PathVariable</span>  Long id,Throwable e)</span> &#123;</span><br><span class="line">    <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>&lt;&gt;(<span class="number">444</span>,<span class="string">&quot;兜底异常handlerFallback,exception内容  &quot;</span>+e.getMessage(),payment);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//本例是blockHandler</span></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">blockHandler</span><span class="params">(<span class="meta">@PathVariable</span>  Long id, BlockException blockException)</span> &#123;</span><br><span class="line">    <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>&lt;&gt;(<span class="number">445</span>,<span class="string">&quot;blockHandler-sentinel限流,无此流水: blockException  &quot;</span></span><br><span class="line">                              + blockException.getMessage(),payment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636379028565-b0a58044-6568-40c7-a127-893179509f17.png" alt></p>
<p>配置sentinel</p>
<p>删除之前的熔断规则，配置流控：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636379267539-ae4d7c97-3a11-4365-8a08-45fa444b7334.png" alt></p>
<p>限流效果：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636381019917-19556a7d-37e6-47ae-964f-72f43a7db72c.png" alt></p>
<p>没有触发限流时，我们触发业务异常<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:84/consumer/fallback/4%EF%BC%8C%E4%BC%9A%E8%A2%AB%E9%99%8D%E7%BA%A7%E6%96%B9%E6%B3%95fallback%E5%85%9C%E5%BA%95%EF%BC%9A">http://localhost:84/consumer/fallback/4，会被降级方法fallback兜底：</a></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122735.png" alt></p>
<p>触发限流时，我们仍然访问可以触发业务异常的连接，此时服务已经被限流（可以理解为服务不可用即熔断），此时触发的是限流（熔断blockHandler）：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636381657535-9cb4112c-8d99-4cbe-b6a3-435fed6479cb.png" alt></p>
<p>也就是说，同时配置<code>fallback</code>：处理业务异常（微服务自身异常，服务降级）和<code>blockHandler</code>：处理触发sentinel配置（微服务不可用，服务熔断）时。</p>
<p>在没有违反sentinel规则时，出现业务异常（降级）走<code>fallback</code>方法；</p>
<p>违反了sentinel规则时，直接微服务不可用（熔断），走<code>blockHandler</code>指定的自定义方法。</p>
<blockquote>
<p><code>blockHandler</code>处理优先级更高</p>
</blockquote>
<h6 id="5-异常忽略属性">(5) 异常忽略属性</h6>
<p>可以选择性的配置当某些异常发生时，不触发fallback的兜底方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;fallback&quot;, fallback = &quot;handlerFallback&quot;, blockHandler = &quot;blockHandler&quot;,</span></span><br><span class="line"><span class="meta">                  exceptionsToIgnore = &#123;IllegalArgumentException.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span> + id, CommonResult.class, id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//本例是fallback</span></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">handlerFallback</span><span class="params">(<span class="meta">@PathVariable</span>  Long id,Throwable e)</span> &#123;</span><br><span class="line">    <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>&lt;&gt;(<span class="number">444</span>,<span class="string">&quot;兜底异常handlerFallback,exception内容  &quot;</span>+e.getMessage(),payment);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//本例是blockHandler</span></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">blockHandler</span><span class="params">(<span class="meta">@PathVariable</span>  Long id, BlockException blockException)</span> &#123;</span><br><span class="line">    <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>&lt;&gt;(<span class="number">445</span>,<span class="string">&quot;blockHandler-sentinel限流,无此流水: blockException  &quot;</span></span><br><span class="line">                              + blockException.getMessage(),payment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122239.png" alt></p>
<p>测试一下，访问：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:84/consumer/fallback/4">http://localhost:84/consumer/fallback/4</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636382674753-3fb1691e-a2bf-4fbf-acdb-33bdf00f971e.png" alt></p>
<p>直接报错误页面，没有了<code>降级兜底方法</code>。</p>
<p>其他异常不受影响：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636383051275-12b54175-7254-40da-82fe-2b553361b4a6.png" alt></p>
<p>当然，<code>触发流控之后</code>，<code>仍然</code>通过blockHandler指定的方法进行<code>熔断兜底</code></p>
<h4 id="9-2-Feign系列">9.2 Feign系列</h4>
<h5 id="9-2-1-修改84模块">9.2.1 修改84模块</h5>
<p>修改84模块，Feign组件一般是在消费侧。</p>
<h6 id="1-pom-4">(1) pom</h6>
<p>pom 加入feign的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud openfeign --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="2-yml-3">(2) yml</h6>
<p>激活Sentinel对Feign的支持</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 激活Sentinel对Feign的支持</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h6 id="3-业务类">(3) 业务类</h6>
<p>后续84的controller不找restTemplate（Ribbon），不是restTemplate去调用payment微服务中的接口。</p>
<p>而是通过调用<code>PaymentFeignService</code>，<code>service</code>再去调用<code>payment</code>微服务中的端口。</p>
<p>Feign需要定义一个 <code>业务逻辑（service）接口+ @FeignClient注解</code>以调用服务提供者。</p>
<p>新建PaymentFeignService interface：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指明调用失败的兜底方法在PaymentFallbackService</span></span><br><span class="line"><span class="comment">// 使用 fallback 方式是无法获取异常信息的，</span></span><br><span class="line"><span class="comment">// 如果想要获取异常信息，可以使用 fallbackFactory参数</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;nacos-payment-provider&quot;, fallback = PaymentFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentFeignService</span> &#123;</span><br><span class="line">    <span class="comment">//去nacos-payment-provider服务中找相应的接口</span></span><br><span class="line">    <span class="comment">// 方法签名一定要和nacos-payment-provider中controller的一致</span></span><br><span class="line">    <span class="comment">// 对应9003、9004中的方法</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用失败的兜底方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springcloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>   <span class="comment">//不要忘记了</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title class_">PaymentFeignService</span> &#123;</span><br><span class="line">    <span class="comment">//如果nacos-payment-consumer服务中的相应接口出事了，我来兜底</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">paymentSQL</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>&lt;&gt;(<span class="number">444</span>,<span class="string">&quot;服务降级返回,没有该流水信息-------PaymentFallbackService&quot;</span>,<span class="keyword">new</span> <span class="title class_">Payment</span>(id, <span class="string">&quot;errorSerial......&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>84端口<code>controller</code>加入<code>openFeign</code>的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//==================OpenFeign</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/consumer/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;没有该id&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> paymentFeignService.paymentSQL(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-主启动类">(4) 主启动类</h6>
<p>加上**@EnableFeignClient**注解开启<code>OpenFeign</code></p>
<h6 id="5-测试-3">(5) 测试</h6>
<p>启动9003、9004、84</p>
<p>访问：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:84/consumer/paymentSQL/1">http://localhost:84/consumer/paymentSQL/1</a></p>
<p>9003、9004负载均衡</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636439455803-e9c03675-1a11-4dec-be5e-bf92f0ab37ee.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636439472093-4b41f770-ccfe-4779-b73a-778290855c33.png" alt></p>
<p>关闭9003、9004微服务提供者，看到84消费者自动执行降级兜底方法。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122940.png" alt></p>
<p>如果yaml没有配置Sentinel对Feign的支持，就不会执行降级方法，而是直接报错误页面。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636440204489-cef2429a-b054-4fa3-9fda-8723526b59a0.png" alt></p>
<h4 id="9-3-熔断框架比较">9.3 熔断框架比较</h4>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202304302122507.png" alt></p>
<h3 id="十、持久化规则">十、持久化规则</h3>
<p>前面我们微服务新增的<code>限流规则后</code>，微服务关闭后就会丢失，<code>当时配置都限流规则都是临时的</code>。</p>
<p>将限流配置规则持久化进Nacos保存，只要刷新8401某个rest地址，sentinel控制台的流控规则 就能看到。</p>
<p>只要nacos里面的配置不删除，针对8401上的sentinel上的流控规则就持续存在。 （也可以持久化到文件，redis，数据库等）</p>
<h4 id="案例—-修改8401已完成持久化设置">案例—    修改8401已完成持久化设置</h4>
<h5 id="1-pom-5">(1) pom</h5>
<p>导入持久化所需依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud ailibaba sentinel-datasource-nacos 持久化--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-yaml">(2) yaml</h5>
<p>添加nacos数据源配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment">#配置Sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">        <span class="comment">#默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line">      <span class="comment"># 关闭默认收敛所有URL的入口context，不然链路限流不生效</span></span><br><span class="line">      <span class="comment"># Spring Cloud Alibaba 需要2.1.1.RELEASE以上版本</span></span><br><span class="line">      <span class="attr">web-context-unify:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment">#      filter:</span></span><br><span class="line"><span class="comment">#        enabled: false  # 关闭自动收敛</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">#持久化配置</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">ds1:</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-添加nacos业务规则配置">(3) 添加nacos业务规则配置</h5>
<p>我们将sentinel的流控配置保存在nacos中，因为nacos的配置持久化在了数据库中。</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636443367569-59d065b4-ec4e-43c0-8f50-8f805c8c818f.png" alt="img" style="zoom:67%;">
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/rateLimit/byUrl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;controlBehavior&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;clusterMode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>resource</code>：资源名称；</p>
<p><code>limitApp</code>：来源应用；</p>
<p><code>grade</code>：阈值类型，0表示线程数，1表示QPS；</p>
<p><code>count</code>：单机阈值；</p>
<p><code>strategy</code>：流控模式，0表示直接，1表示关联，2表示链路；</p>
<p><code>controlBehavior</code>：流控效果，0表示快速失败，1表示Warm Up，2表示排队等待；</p>
<p><code>clusterMode</code>：是否集群。</p>
<p>注意：这里如果要配<code>nacos</code>的命名空间（public、dev、test）的话，应该是配<code>namespace</code>的id，不是名称</p>
</blockquote>
<h5 id="4-测试">(4) 测试</h5>
<p>启动8401，访问8401任意接口，刷新<code>Sentinel</code>。可以看到Sentinel中加载了通过<code>nacos</code>持久化的规则配置文件。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636459020329-7d5d5e38-9dfb-48bd-96bb-2488b066a8f8.png" alt></p>
<p>关掉8401后发现流控规则没有了。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636459171130-489aa6a9-cf4c-4c28-94ba-456418bbaa4f.png" alt></p>
<p>再次启动8401查看sentinel，访问几次8401后流控规则又出现了。</p>
<p>查看数据库，发现<code>规则持久化</code>到数据库中了。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636459413078-73a851a4-729f-4e9a-b5ef-1d1bddf40cdf.png" alt></p>
<h2 id="4、Seata处理分布式事务">4、Seata处理分布式事务</h2>
<h3 id="分布式事务问题">分布式事务问题</h3>
<p><strong>只要用到分布式，必然会提及分布式的事务。</strong></p>
<p>在分布式之前，一切组件全都在一台机器上。</p>
<p>在使用分布式之后，单体应用被拆分成微服务应用，原来的三个模块被拆分成三个独立的应用，分别使用三个独立的数据源。</p>
<p>业务操作需要调用三个服务来完成。此时每个服务内部的数据一致性由<strong>本地</strong>事务来保证，但是<strong>全局</strong>的数据一致性问题没法保证。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636468367331-5feffbdc-ec8f-4620-9c50-d8c5485c2871.png" alt></p>
<blockquote>
<p>一句话：一次业务操作需要跨多个数据源或需要跨多个系统进行远程调用，就会产生分布式事务问题。</p>
</blockquote>
<h3 id="一、Seata简介与安装">一、Seata简介与安装</h3>
<p>Seata是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://seata.io/zh-cn/">官网</a></p>
<h4 id="1-1-相关术语">1.1 相关术语</h4>
<p>一个典型的分布式事务过程，可以用分布式处理过程的<strong>一ID+三组件</strong>模型来描述。</p>
<p>一ID（<strong>全局唯一的事务ID</strong>）</p>
<ul>
<li>Transaction ID XID，在这个事务ID下的所有事务会被统一控制</li>
</ul>
<p><strong>三组件</strong>：</p>
<ul>
<li><strong>Transaction Coordinator (TC)</strong>：事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚；（Server端，为单独服务器部署）</li>
<li><strong>Transaction Manager ™</strong>：事务管理器，控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议；</li>
<li><strong>Resource Manager (RM)</strong>：资源管理器，控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚</li>
<li>Seata分TC、TM和RM三个角色，<strong>TC（Server端）为单独服务端部署</strong>，<strong>TM和RM（Client端）由业务系统集成（微服务）</strong>。</li>
</ul>
<h4 id="1-2-典型的分布式控制事务流程">1.2 典型的分布式控制事务流程</h4>
<ol>
<li>TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个<strong>全局唯一的 XID</strong>；</li>
<li>XID 在微服务调用链路的上下文中传播；（也就是在多个TM，RM中传播）</li>
<li>RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖；</li>
<li>TM 向 TC 发起针对 XID 的全局提交或回滚决议；</li>
<li>TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求。</li>
</ol>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636511629414-0e4a7788-1488-40b8-8b5f-93f330a481b7.png" alt="img" style="zoom:63%;">
<h4 id="1-3-Seata-Server的下载与配置">1.3 Seata-Server的下载与配置</h4>
<p>我这里下载了0.9.0版本跟1.4.2版本（配了半天没配好，后面再填坑），差别还是蛮大的。</p>
<h5 id="1-3-1-修改file-conf文件">1.3.1 修改file.conf文件</h5>
<ul>
<li>解压到指定目录并修改conf目录下的file.conf配置文件。</li>
<li>备份原始file.conf文件。</li>
<li>主要修改：自定义事务组名称+事务日志存储模式为db+数据库连接信息。</li>
<li>修改file.conf文件</li>
<li>service模块（1.4.2里面没有这个模块，需要自己加）</li>
<li>store模块</li>
</ul>
<blockquote>
<h5 id="0-9-0版本">0.9.0版本</h5>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305131658112.png" alt></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="comment">## transaction log store, only used in seata-server</span></span><br><span class="line">&gt;store &#123;</span><br><span class="line">&gt;<span class="comment">## store mode: file、db、redis</span></span><br><span class="line">&gt;mode = <span class="string">&quot;db&quot;</span></span><br><span class="line">&gt;<span class="comment">## rsa decryption public key</span></span><br><span class="line">&gt;publicKey = <span class="string">&quot;&quot;</span></span><br><span class="line">&gt;<span class="comment">## file store property</span></span><br><span class="line">&gt;file &#123;</span><br><span class="line">&gt;<span class="comment">## store location dir</span></span><br><span class="line">&gt;<span class="built_in">dir</span> = <span class="string">&quot;sessionStore&quot;</span></span><br><span class="line">&gt;<span class="comment"># branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions</span></span><br><span class="line">&gt;maxBranchSessionSize = 16384</span><br><span class="line">&gt;<span class="comment"># globe session size , if exceeded throws exceptions</span></span><br><span class="line">&gt;maxGlobalSessionSize = 512</span><br><span class="line">&gt;<span class="comment"># file buffer size , if exceeded allocate new buffer</span></span><br><span class="line">&gt;fileWriteBufferCacheSize = 16384</span><br><span class="line">&gt;<span class="comment"># when recover batch read size</span></span><br><span class="line">&gt;sessionReloadReadSize = 100</span><br><span class="line">&gt;<span class="comment"># async, sync</span></span><br><span class="line">&gt;flushDiskMode = async</span><br><span class="line">&gt;&#125;</span><br><span class="line"></span><br><span class="line">&gt;<span class="comment">## database store property</span></span><br><span class="line">&gt;db &#123;</span><br><span class="line">&gt;<span class="comment">## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp)/HikariDataSource(hikari) etc.</span></span><br><span class="line">&gt;datasource = <span class="string">&quot;druid&quot;</span></span><br><span class="line">&gt;<span class="comment">## mysql/oracle/postgresql/h2/oceanbase etc.</span></span><br><span class="line">&gt;dbType = <span class="string">&quot;mysql&quot;</span></span><br><span class="line"><span class="comment">## mysql 5.xx</span></span><br><span class="line">&gt;<span class="comment">## driverClassName = &quot;com.mysql.jdbc.Driver&quot;</span></span><br><span class="line"><span class="comment">## mysql 8.xx</span></span><br><span class="line">driverClassName = <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span></span><br><span class="line">&gt;<span class="comment">## if using mysql to store the data, recommend add rewriteBatchedStatements=true in jdbc connection param</span></span><br><span class="line">&gt;<span class="comment">## url = &quot;jdbc:mysql://127.0.0.1:3306/seata?rewriteBatchedStatements=true&quot;</span></span><br><span class="line">url = <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;nullCatalogMeansCurrent=true&amp;serverTimezone=UTC&quot;</span></span><br><span class="line">&gt;user = <span class="string">&quot;root&quot;</span></span><br><span class="line">&gt;password = <span class="string">&quot;10086&quot;</span></span><br><span class="line">&gt;minConn = 5</span><br><span class="line">&gt;maxConn = 100</span><br><span class="line">&gt;globalTable = <span class="string">&quot;global_table&quot;</span></span><br><span class="line">&gt;branchTable = <span class="string">&quot;branch_table&quot;</span></span><br><span class="line">&gt;lockTable = <span class="string">&quot;lock_table&quot;</span></span><br><span class="line">&gt;queryLimit = 100</span><br><span class="line">&gt;maxWait = 5000</span><br><span class="line">&gt;&#125;</span><br><span class="line"></span><br><span class="line">&gt;<span class="comment">## redis store property</span></span><br><span class="line">&gt;redis &#123;</span><br><span class="line">&gt;<span class="comment">## redis mode: single、sentinel</span></span><br><span class="line">&gt;mode = <span class="string">&quot;single&quot;</span></span><br><span class="line">&gt;<span class="comment">## single mode property</span></span><br><span class="line">&gt;single &#123;</span><br><span class="line">host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port = <span class="string">&quot;6379&quot;</span></span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;<span class="comment">## sentinel mode property</span></span><br><span class="line">&gt;sentinel &#123;</span><br><span class="line">masterName = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">## such as &quot;10.28.235.65:26379,10.28.235.65:26380,10.28.235.65:26381&quot;</span></span><br><span class="line">sentinelHosts = <span class="string">&quot;&quot;</span></span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;password = <span class="string">&quot;&quot;</span></span><br><span class="line">&gt;database = <span class="string">&quot;0&quot;</span></span><br><span class="line">&gt;minConn = 1</span><br><span class="line">&gt;maxConn = 10</span><br><span class="line">&gt;maxTotal = 100</span><br><span class="line">&gt;queryLimit = 100</span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;<span class="comment">## 1.4.2 版本需要自己手动增加service模块</span></span><br><span class="line">&gt;service &#123;</span><br><span class="line">&gt;<span class="comment">#vgroup-&gt;rgroup</span></span><br><span class="line">&gt;vgroup_mapping.my_test_tx_group = <span class="string">&quot;my_group&quot;</span>    </span><br><span class="line">&gt;<span class="comment">#only support single node</span></span><br><span class="line">&gt;default.grouplist = <span class="string">&quot;127.0.0.1:8091&quot;</span></span><br><span class="line">&gt;<span class="comment">#degrade current not support</span></span><br><span class="line">&gt;enableDegrade = <span class="literal">false</span></span><br><span class="line">&gt;<span class="comment">#disable</span></span><br><span class="line">&gt;<span class="built_in">disable</span> = <span class="literal">false</span></span><br><span class="line">&gt;<span class="comment">#unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent</span></span><br><span class="line">&gt;max.commit.retry.timeout = <span class="string">&quot;-1&quot;</span></span><br><span class="line">&gt;max.rollback.retry.timeout = <span class="string">&quot;-1&quot;</span></span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="1-3-2-数据库中建库建表">1.3.2 数据库中建库建表</h5>
<p>数据库新建库seata，建表db_store.sql在\seata-server-0.9.0\seata\conf目录里面</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046221.png" alt></p>
<h5 id="1-3-3-修改seata-server-0-9-0-seata-conf目录下的registry-conf配置文件">1.3.3 修改seata-server-0.9.0\seata\conf目录下的registry.conf配置文件</h5>
<p>目的是：指明注册中心为nacos，及修改nacos连接信息</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636533822408-2ed7382f-c9ba-41f2-af4d-c7a7313b4c1a.png" alt></p>
<h5 id="1-3-4-启动nacos和seata">1.3.4 启动nacos和seata</h5>
<p><code>seata-server-0.9.0\seata\bin\seata-server.sh</code></p>
<p>启动失败，报错：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636540085504-750df869-8d65-42d9-80af-30c3f4e927d5.png" alt></p>
<p>解决：0.9.0默认的mysql是5.1.30版本，将lib文件夹下mysql-connector-java-5.1.30.jar删除，替换成自己mysql版本的jar包，我的是mysql-connector-java-8.0.22.jar。</p>
<p>再次启动：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046260.png" alt></p>
<p>出现这些提示信息代表seata启动成功。</p>
<p>nacos中成功注册了seate：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636540463325-cae9956d-6610-43ac-ae3c-60c81e803afc.png" alt></p>
<h3 id="Seata-1-4-2版本填坑—nacos作为seata的注册-配置中心-看的黑马的-sgg的失败了">**Seata 1.4.2版本填坑—nacos作为seata的注册/配置中心(看的黑马的   sgg的失败了)</h3>
<blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/weixin_44790046/article/details/106970822">seata1.2.0</a>   <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/jixieguang/article/details/110621561">Seata1.4.0+nacos</a></p>
<h3 id="0-启动nacos">0. 启动nacos</h3>
<p>启动nacos，新建一个命名空间seata用于存放seata的配置信息。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305171910975.png" alt="image-20230517191044900" style="zoom:33%;">
<p>注意这里的命名空间ID，后面会用到。<strong>这里不新建也可以，seata使用的是public。</strong></p>
<p><strong>我们使用nacos充当seata的注册中心和配置中心！</strong></p>
<h3 id="1-修改配置文件">1. 修改配置文件</h3>
<h4 id="①进入conf文件夹，修改file-conf文件">①进入conf文件夹，修改file.conf文件</h4>
<p>1.4.2版本可以参考file.conf.example(server端)和conf文件夹下<strong>README-zh.md中的client</strong>端配置</p>
<p>总共需要修改的地方：我这里用seate_1_4_2数据库来对应seata1.4.2版本</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636978078529-61784d3f-4230-46b3-8612-1dc1b1f61152.png" alt="img" style="zoom:67%;">
<p>最终完整代码file.conf：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/attachments/yuque/0/2021/txt/22423156/1636978207422-66810a14-f335-4a73-8dee-998f58dfcd7c.txt">📎file.conf.txt</a></p>
<h4 id="②修改conf-registry-conf文件">②修改conf\registry.conf文件</h4>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636978611296-61ea13d9-ba2f-4343-a016-66f7ade007bd.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637047172825-51ffe35a-3d7b-451f-b7a9-4789089a03e4.png" alt></p>
<p><strong>思考：这里我们把seata-server端的config设置为了nacos，那么是不是第一步的file.conf文件就不再需要了。因为直接从nacos读取配置？</strong></p>
<h3 id="2-将配置导入到nacos">2. 将配置导入到nacos</h3>
<h4 id="①-准备nacos-config-sh脚本">① 准备nacos-config.sh脚本</h4>
<p>在conf文件夹下，需要有个nacos-config.sh文件，这个文件1.4.2版本没有。README-zh.md文件中访问<strong>config-center</strong>超链接（<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/seata/seata/tree/develop/script/config-center%EF%BC%89%EF%BC%8Cnacos%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%8B%EF%BC%9A">https://github.com/seata/seata/tree/develop/script/config-center），nacos文件夹下：</a></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046483.png" alt></p>
<p>用这个可以直接下当前页的文件<a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog.luckly-mjw.cn/tool-show/github-directory-downloader/index.html">github-directory-downloader</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636979658725-0d097480-053f-4717-95f2-f0b517e69ee6.png" alt></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/attachments/yuque/0/2021/sh/22423156/1636979669265-dc8c3809-bc69-4326-95fb-06e2313bd41a.sh">📎nacos-config.sh</a></p>
<h4 id="②-config-txt准备及修改">② config.txt准备及修改</h4>
<p>在conf目录下还需要一个config.txt文件，1.4.2版本同样没有，还是去README里面的config-center超链接。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636979791988-612e5b27-d79c-4467-a096-28dd77757fdc.png" alt></p>
<p>config.txt需要放在conf的上级目录下。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637047258914-56fed840-82ca-4b98-90e4-8776b0e8f350.png" alt></p>
<p>修改config.txt文件中的内容，主要是下面这几项：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637047663366-547b68e5-66fc-4110-8336-61d030cc1656.png" alt></p>
<p>改为使用db存储：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637047446901-badf8370-0ef1-46b7-ab5b-212198588148.png" alt></p>
<p><strong>注意这里store.db.url中数据库的名字就是我们之后需要新建的数据库的名字。</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637060537507-74cbaa87-b363-4cf8-9345-f29a47c739c8.png" alt>相比于其他版本，1.4.2这里多了个distributedLockTable。</p>
<p>整个config.txt文件中，store.publicKey、store.redis.sentinel.masterName、store.redis.sentinel.sentinelHosts、store.redis.password四个属性默认都是空的<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637047508781-a702d6a3-cf10-4ebc-9606-8f2c039c79dc.png" alt>。所以后面在将config.txt文件中的配置注册到nacos的时候，会出现四个失败项。</p>
<h4 id="③-导入seata相应的配置项到Nacos">③ 导入seata相应的配置项到Nacos</h4>
<p>config.txt就是seata各种详细的配置，执行nacos-config.sh即可将这些配置导入到nacos。这样就不需要将file.conf和registry.conf放到我们的项目中了，需要什么配置就直接从nacos中读取。（这句话是参考博客<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/jixieguang/article/details/110621561%EF%BC%8C%E6%88%91%E8%A7%89%E4%B8%8D%E5%AE%8C%E5%85%A8%E5%AF%B9%EF%BC%8C%E5%90%8E%E9%9D%A2registry.conf%E9%87%8C%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%E8%99%BD%E7%84%B6%E4%B8%8D%E9%9C%80%E8%A6%81.conf%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE%EF%BC%8C%E4%BD%86%E6%98%AF%E9%9C%80%E8%A6%81%E5%9C%A8yml%E6%88%96properties%E6%96%87%E4%BB%B6%E4%B8%AD%E9%85%8D%E7%BD%AE%EF%BC%8C%E8%80%8Cfile.conf%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E5%9C%A8nacos%E4%B8%AD%E8%AF%BB%E5%8F%96%EF%BC%89">https://blog.csdn.net/jixieguang/article/details/110621561，我觉不完全对，后面registry.conf里的配置项虽然不需要.conf文件配置，但是需要在yml或properties文件中配置，而file.conf可以直接在nacos中读取）</a></p>
<p>导入配置：</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305161937393.png" alt="image-20230516193715258" style="zoom:33%;">
<p>然后在git bash界面输入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash nacos-config-interactive.sh</span><br></pre></td></tr></table></figure>
<p>注：h表示nacos的地址，p表示端口号，g表示配置的分组，t表示命名空间的ID，u跟w表示nacos的账户密码。如果没有设置命名空间，而且都是默认选项直接 <code>sh nacos-config.sh -h localhost</code>就行。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305161936328.png" alt="image-20230516193657190" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305161936166.png" alt="image-20230516193624026" style="zoom:33%;">
<p>可以看到共98项，导入失败4项，就是上面没有值的那四项（不影响，如果用到直接在nacos里面新建配置即可）</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305161935187.png" alt="image-20230516193550052" style="zoom:33%;">
<p>可以看到，nacos的seata命名空间中已经导入了配置项。（seata命名空间是我自己创建的，可以按自己的需求创建，不创建默认的就是public。）</p>
<h3 id="3-数据库中建库建表">3. 数据库中建库建表</h3>
<p>进行配置</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305161936144.png" alt="image-20230516193509040" style="zoom:33%;">
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305161934481.png" alt></p>
<p>我们先创建数据库seata1_4_2（数据库要与config.txt中db设置那里对应），数据库的建表语句在README文件的server连接中：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046624.png" alt></p>
<p>然后执行mysql.sql（1.4.2多了个distributed_lock表，和一些插入语句）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------</span></span><br><span class="line"><span class="comment">-- the table to store GlobalSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `global_table`</span><br><span class="line">(</span><br><span class="line">`xid`                       <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`transaction_id`            <span class="type">BIGINT</span>,</span><br><span class="line">`status`                    TINYINT      <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`application_id`            <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">`transaction_service_group` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">`transaction_name`          <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">`timeout`                   <span class="type">INT</span>,</span><br><span class="line">`begin_time`                <span class="type">BIGINT</span>,</span><br><span class="line">`application_data`          <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">`gmt_create`                DATETIME,</span><br><span class="line">`gmt_modified`              DATETIME,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`xid`),</span><br><span class="line">KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),</span><br><span class="line">KEY `idx_transaction_id` (`transaction_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line"><span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store BranchSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `branch_table`</span><br><span class="line">(</span><br><span class="line">`branch_id`         <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`xid`               <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`transaction_id`    <span class="type">BIGINT</span>,</span><br><span class="line">`resource_group_id` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">`resource_id`       <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">`branch_type`       <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">`status`            TINYINT,</span><br><span class="line">`client_id`         <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">`application_data`  <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">`gmt_create`        DATETIME(<span class="number">6</span>),</span><br><span class="line">`gmt_modified`      DATETIME(<span class="number">6</span>),</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`branch_id`),</span><br><span class="line">KEY `idx_xid` (`xid`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line"><span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store lock data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `lock_table`</span><br><span class="line">(</span><br><span class="line">`row_key`        <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`xid`            <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">`transaction_id` <span class="type">BIGINT</span>,</span><br><span class="line">`branch_id`      <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`resource_id`    <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">`table_name`     <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">`pk`             <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">`gmt_create`     DATETIME,</span><br><span class="line">`gmt_modified`   DATETIME,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`row_key`),</span><br><span class="line">KEY `idx_branch_id` (`branch_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line"><span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `distributed_lock`</span><br><span class="line">(</span><br><span class="line">`lock_key`       <span class="type">CHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`lock_value`     <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`expire`         <span class="type">BIGINT</span>,</span><br><span class="line"><span class="keyword">primary</span> key (`lock_key`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line"><span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;AsyncCommitting&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;RetryCommitting&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;RetryRollbacking&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;TxTimeoutCheck&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305161938746.png" alt="image-20230516193834283" style="zoom:33%;">
<p>这四张表跟config.txt文件中的配置对应。</p>
<h3 id="4-启动seata">4. 启动seata</h3>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://xn--binseata-server-3j3x036slhxeqwbq91on86a.sh">运行bin目录下的seata-server.sh</a></p>
<p>出现下面字段表示seata启动成功。seata启动日志在C:\Users\admin\logs\seata文件夹下。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305161939293.png" alt="image-20230516193939839" style="zoom:33%;">
<p>nacos中在seata命名空间内也成功注册，注意这里服务名对应的是registry.conf文件中nacos下面application的值。0.9.0版本好像设置不了这个，默认是serverAddr。</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305132122826.png" alt="image-20230513212209710" style="zoom:67%;">
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637062927719-91dd19dc-bf55-4d31-975a-f3a4d9225f59.png" alt></p>
</blockquote>
<h3 id="二、订单-库存-账户业务数据库准备">二、订单/库存/账户业务数据库准备</h3>
<p>以下演示都需要先启动Nacos后启动Seata，保证两个都OK。Seata没启动报错no available server to connect。</p>
<h4 id="2-1-分布式事务业务说明">2.1 分布式事务业务说明</h4>
<p>这里我们会创建三个服务，一个订单服务，一个库存服务，一个账户服务。</p>
<p>当用户下单时，会在订单服务中创建一个订单，然后通过远程调用库存服务来扣减下单商品的库存，再通过远程调用账户服务来扣减用户账户里面的余额，最后在订单服务中修改订单状态为已完成。</p>
<p>该操作跨越三个数据库，有两次远程调用，很明显会有分布式事务问题。</p>
<p>下订单—&gt;扣库存—&gt;减账户(余额)</p>
<h4 id="2-2-创建业务数据库与表">2.2 创建业务数据库与表</h4>
<h5 id="1-创建业务数据库">1. 创建业务数据库</h5>
<ul>
<li>seata_order：存储订单的数据库；</li>
<li>seata_storage：存储库存的数据库；</li>
<li>seata_account：存储账户信息的数据库。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE seata_order;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">CREATE</span> DATABASE seata_storage;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">CREATE</span> DATABASE seata_account;</span><br></pre></td></tr></table></figure>
<h5 id="2-按照上述3库分别创建对应业务表">2. 按照上述3库分别创建对应业务表</h5>
<p>seata_order库下建t_order表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> seata_order.`t_order` (</span><br><span class="line">  `id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">  `user_id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `product_id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;产品id&#x27;</span>,</span><br><span class="line">  `count` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;数量&#x27;</span>,</span><br><span class="line">  `money` <span class="type">DECIMAL</span>(<span class="number">11</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;金额&#x27;</span>,</span><br><span class="line">  `status` <span class="type">INT</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单状态：0：创建中；1：已完结&#x27;</span> </span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">7</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
<p>seata_storage库下建t_storage 表:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `seata_storage`.`t_storage` (</span><br><span class="line"> `id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line"> `product_id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;产品id&#x27;</span>,</span><br><span class="line"> `total` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;总库存&#x27;</span>,</span><br><span class="line"> `used` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;已用库存&#x27;</span>,</span><br><span class="line"> `residue` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;剩余库存&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> seata_storage.t_storage(`id`, `product_id`, `total`, `used`, `residue`)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;100&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;100&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>seata_account库下建t_account 表:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `seata_account`.t_account (</span><br><span class="line">  `id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `total` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;总额度&#x27;</span>,</span><br><span class="line">  `used` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;已用余额&#x27;</span>,</span><br><span class="line">  `residue` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;剩余可用额度&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> seata_account.t_account(`id`, `user_id`, `total`, `used`, `residue`)  <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h5 id="3-按照上述3库分别建对应的回滚日志表">3. 按照上述3库分别建对应的回滚日志表</h5>
<p>订单-库存-账户3个库下都需要建各自的回滚日志表，\seata-server-0.9.0\seata\conf目录下的<code>db_undo_log.sql</code>；1.4.2版本的在<code>README_ZH</code>文件中的<code>client</code>：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636548279472-a160bd9b-045f-4a31-93ab-6e56480ae2f6.png" alt><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636548287477-760e3369-f841-4a74-8c07-c51cc4a2c77f.png" alt></p>
<p><strong>注意：0.9版本跟1.4.2版本的undo_log表的属性有差别，1.4.2版本没有id跟ext这两个属性，个人觉得使用上没有影响</strong></p>
<p>这里的话我还是按0.9.0版本来建表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">0.9</span><span class="number">.0</span> 版本</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `undo_log`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `undo_log` (</span><br><span class="line">  `id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `branch_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `xid` <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `context` <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rollback_info` LONGBLOB <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_status` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_created` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_modified` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ext` <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># <span class="number">1.4</span><span class="number">.2</span>版本</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `undo_log`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `undo_log`</span><br><span class="line">(</span><br><span class="line">    `branch_id`     <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;branch transaction id&#x27;</span>,</span><br><span class="line">    `xid`           <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;global transaction id&#x27;</span>,</span><br><span class="line">    `context`       <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;undo_log context,such as serialization&#x27;</span>,</span><br><span class="line">    `rollback_info` LONGBLOB     <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;rollback info&#x27;</span>,</span><br><span class="line">    `log_status`    <span class="type">INT</span>(<span class="number">11</span>)      <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;0:normal status,1:defense status&#x27;</span>,</span><br><span class="line">    `log_created`   DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;create datetime&#x27;</span>,</span><br><span class="line">    `log_modified`  DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;modify datetime&#x27;</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`, `branch_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  AUTO_INCREMENT <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8 COMMENT <span class="operator">=</span><span class="string">&#x27;AT transaction mode undo table&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>最终效果： 这里展示了1.4.2版本跟0.9版本，实际中用一个就行，别的版本一样。</p>
<img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636548808495-fa194c4f-7fc4-4863-871d-b044e93b9500.png" alt="img" style="zoom:53%;">
<h3 id="三、订单-库存-账户业务微服务准备">三、订单/库存/账户业务微服务准备</h3>
<p>业务需求：下订单-&gt;减库存-&gt;扣余额-&gt;改(订单)状态</p>
<h4 id="版本对应关系——很重要">版本对应关系——很重要</h4>
<p>**注意：**由于seata0.9.0版本跟1.0之后的版本（支持yml、properties配置）区别巨大，这里使用0.9.0版本（跟视频一致），其版本对应关系见<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E">版本说明</a>。（<strong>seata0.9.0 + nacos 1.1.4 + sentinel 1.7.0 + SpringCloud Alibaba 2.1.1RELEASE</strong>）前面用的各组件版本得对应上（头疼）</p>
<h4 id="3-1-新建订单Order-Module——seata-order-service2001">3.1 新建订单Order-Module——seata-order-service2001</h4>
<p>新建seata-order-service2001</p>
<h5 id="1-pom-6">(1) pom</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-order-service2001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--nacos--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--seata--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 因为兼容版本问题,所以需要剔除它自带的seata的包 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     		<span class="comment">&lt;!-- 要跟我们安装SeaTa的一致！ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--feign--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--web-actuator--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mysql-druid--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-application-yml">(2) application.yml</h5>
<p>这里配置的是我们自己微服务的数据源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seata-order-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">alibaba:</span></span><br><span class="line">      <span class="attr">seata:</span></span><br><span class="line">        <span class="comment">#自定义事务组名称需要与seata-server中file.conf中配置的事务组ID对应</span></span><br><span class="line">        <span class="comment">#vgroup_mapping.my_test_tx_group = &quot;my_group&quot;</span></span><br><span class="line">        <span class="attr">tx-service-group:</span> <span class="string">my_group</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/seata_order?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">10086</span></span><br><span class="line"></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">io:</span></span><br><span class="line">      <span class="attr">seata:</span> <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapperLocations:</span> <span class="string">classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure>
<h5 id="3-file-conf">(3) file.conf</h5>
<p>程序中依赖的是<code> seata-all</code>，对应于 *<code>.conf </code>文件，所以需要在resource新建  .conf文件，高版本的支持yml、properties配置。</p>
<p>这里仅仅是seata-order-service2001模块的file.conf（配置2001的分布式事务），seata软件那里配置的是总控file.conf。</p>
<p>注意修改这两处：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636715541883-b0548d85-0e4a-440e-821b-f07c2d75f270.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">transport &#123;</span><br><span class="line">  # tcp udt unix-domain-<span class="type">socket</span></span><br><span class="line">  <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;TCP&quot;</span></span><br><span class="line">  #NIO <span class="type">NATIVE</span></span><br><span class="line">  <span class="variable">server</span> <span class="operator">=</span> <span class="string">&quot;NIO&quot;</span></span><br><span class="line">  #enable <span class="type">heartbeat</span></span><br><span class="line">  <span class="variable">heartbeat</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">  #thread factory <span class="keyword">for</span> netty</span><br><span class="line">  thread-factory &#123;</span><br><span class="line">    boss-thread-prefix = <span class="string">&quot;NettyBoss&quot;</span></span><br><span class="line">    worker-thread-prefix = <span class="string">&quot;NettyServerNIOWorker&quot;</span></span><br><span class="line">    server-executor-thread-prefix = <span class="string">&quot;NettyServerBizHandler&quot;</span></span><br><span class="line">    share-boss-worker = <span class="literal">false</span></span><br><span class="line">    client-selector-thread-prefix = <span class="string">&quot;NettyClientSelector&quot;</span></span><br><span class="line">    client-selector-thread-size = <span class="number">1</span></span><br><span class="line">    client-worker-thread-prefix = <span class="string">&quot;NettyClientWorkerThread&quot;</span></span><br><span class="line">    # netty boss thread size,will not be used <span class="keyword">for</span> UDT</span><br><span class="line">    boss-thread-size = <span class="number">1</span></span><br><span class="line">    #auto <span class="keyword">default</span> pin or <span class="number">8</span></span><br><span class="line">    worker-thread-size = <span class="number">8</span></span><br><span class="line">  &#125;</span><br><span class="line">  shutdown &#123;</span><br><span class="line">    # when destroy server, wait <span class="type">seconds</span></span><br><span class="line">    <span class="variable">wait</span> <span class="operator">=</span> <span class="number">3</span></span><br><span class="line">  &#125;</span><br><span class="line">  serialization = <span class="string">&quot;seata&quot;</span></span><br><span class="line">  compressor = <span class="string">&quot;none&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">service &#123;</span><br><span class="line">  #修改自定义事务组名称，这里跟在seata里配置的不一样，这里只针对<span class="number">2001</span>自己的事务，</span><br><span class="line">  #而seata里针对的是整个分布式全局事务</span><br><span class="line">  #这里要注意 vgroup_mapping. 后面的值，要跟seata-server安装时 conf 文件夹下file.conf service模块设定的</span><br><span class="line">  #vgroup_mapping.my_test_tx_group = <span class="string">&quot;my_group&quot;</span></span><br><span class="line">  vgroup_mapping.my_group = <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span>.grouplist = <span class="string">&quot;127.0.0.1:8091&quot;</span></span><br><span class="line">  enableDegrade = <span class="type">false</span></span><br><span class="line">  <span class="variable">disable</span> <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">  max.commit.retry.timeout = <span class="string">&quot;-1&quot;</span></span><br><span class="line">  max.rollback.retry.timeout = <span class="string">&quot;-1&quot;</span></span><br><span class="line">  disableGlobalTransaction = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client &#123;</span><br><span class="line">  async.commit.buffer.limit = <span class="number">10000</span></span><br><span class="line">  lock &#123;</span><br><span class="line">    retry.internal = <span class="number">10</span></span><br><span class="line">    retry.times = <span class="number">30</span></span><br><span class="line">  &#125;</span><br><span class="line">  report.retry.count = <span class="number">5</span></span><br><span class="line">  tm.commit.retry.count = <span class="number">1</span></span><br><span class="line">  tm.rollback.retry.count = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## transaction log store</span><br><span class="line">store &#123;</span><br><span class="line">  ## store mode: file、<span class="type">db</span></span><br><span class="line">  <span class="variable">mode</span> <span class="operator">=</span> <span class="string">&quot;db&quot;</span></span><br><span class="line"></span><br><span class="line">  ## file store</span><br><span class="line">  file &#123;</span><br><span class="line">    dir = <span class="string">&quot;sessionStore&quot;</span></span><br><span class="line"></span><br><span class="line">    # branch session size , <span class="keyword">if</span> exceeded first <span class="keyword">try</span> compress lockkey, still exceeded <span class="keyword">throws</span> exceptions</span><br><span class="line">    max-branch-session-size = <span class="number">16384</span></span><br><span class="line">    # globe session size , <span class="keyword">if</span> exceeded <span class="keyword">throws</span> exceptions</span><br><span class="line">    max-global-session-size = <span class="number">512</span></span><br><span class="line">    # file buffer size , <span class="keyword">if</span> exceeded allocate <span class="keyword">new</span> <span class="title class_">buffer</span></span><br><span class="line">    file-write-buffer-cache-size = <span class="number">16384</span></span><br><span class="line">    # when recover batch read size</span><br><span class="line">    session.reload.read_size = <span class="number">100</span></span><br><span class="line">    # async, sync</span><br><span class="line">    flush-disk-mode = async</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ## database store</span><br><span class="line">  db &#123;</span><br><span class="line">    ## the implement of javax.sql.DataSource, such as <span class="title function_">DruidDataSource</span><span class="params">(druid)</span>/BasicDataSource(dbcp) etc.</span><br><span class="line">    datasource = <span class="string">&quot;dbcp&quot;</span></span><br><span class="line">    ## mysql/oracle/h2/oceanbase etc.</span><br><span class="line">    db-type = <span class="string">&quot;mysql&quot;</span></span><br><span class="line">    ## 这里要注意mysql5跟mysql8不一样</span><br><span class="line">    driver-class-name = <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span></span><br><span class="line">    url = <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC&quot;</span></span><br><span class="line">    user = <span class="string">&quot;root&quot;</span></span><br><span class="line">    password = <span class="string">&quot;10086&quot;</span></span><br><span class="line">    min-conn = <span class="number">1</span></span><br><span class="line">    max-conn = <span class="number">3</span></span><br><span class="line">    global.table = <span class="string">&quot;global_table&quot;</span></span><br><span class="line">    branch.table = <span class="string">&quot;branch_table&quot;</span></span><br><span class="line">    lock-table = <span class="string">&quot;lock_table&quot;</span></span><br><span class="line">    query-limit = <span class="number">100</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">lock &#123;</span><br><span class="line">  ## the lock store mode: local、<span class="type">remote</span></span><br><span class="line">  <span class="variable">mode</span> <span class="operator">=</span> <span class="string">&quot;remote&quot;</span></span><br><span class="line"></span><br><span class="line">  local &#123;</span><br><span class="line">    ## store locks in user<span class="string">&#x27;s database</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  remote &#123;</span></span><br><span class="line"><span class="string">    ## store locks in the seata&#x27;</span>s server</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">recovery &#123;</span><br><span class="line">  #schedule committing retry period in milliseconds</span><br><span class="line">  committing-retry-period = <span class="number">1000</span></span><br><span class="line">  #schedule asyn committing retry period in milliseconds</span><br><span class="line">  asyn-committing-retry-period = <span class="number">1000</span></span><br><span class="line">  #schedule rollbacking retry period in milliseconds</span><br><span class="line">  rollbacking-retry-period = <span class="number">1000</span></span><br><span class="line">  #schedule timeout retry period in milliseconds</span><br><span class="line">  timeout-retry-period = <span class="number">1000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">transaction &#123;</span><br><span class="line">  undo.data.validation = <span class="literal">true</span></span><br><span class="line">  undo.log.serialization = <span class="string">&quot;jackson&quot;</span></span><br><span class="line">  undo.log.save.days = <span class="number">7</span></span><br><span class="line">  #schedule delete expired undo_log in milliseconds</span><br><span class="line">  undo.log.delete.period = <span class="number">86400000</span></span><br><span class="line">  undo.log.table = <span class="string">&quot;undo_log&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## metrics settings</span><br><span class="line">metrics &#123;</span><br><span class="line">  enabled = <span class="literal">false</span></span><br><span class="line">  registry-type = <span class="string">&quot;compact&quot;</span></span><br><span class="line">  # multi exporters use comma divided</span><br><span class="line">  exporter-list = <span class="string">&quot;prometheus&quot;</span></span><br><span class="line">  exporter-prometheus-port = <span class="number">9898</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">support &#123;</span><br><span class="line">  ## spring</span><br><span class="line">  spring &#123;</span><br><span class="line">    # auto proxy the DataSource bean</span><br><span class="line">    datasource.autoproxy = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="几个配置文件对应关系">几个配置文件对应关系</h5>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636715439474-c19e0db9-7d20-41f3-acba-898bb1071b32.png" alt></p>
<h5 id="4-registry-conf">(4) registry.conf</h5>
<p>指明注册到nacos中：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046846.png" alt></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  <span class="comment"># file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span></span><br><span class="line">  <span class="built_in">type</span> = <span class="string">&quot;nacos&quot;</span></span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = <span class="string">&quot;localhost:8848&quot;</span>    <span class="comment"># 如果nacos不在本机，就写服务器的IP</span></span><br><span class="line">    namespace = <span class="string">&quot;&quot;</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  eureka &#123;</span><br><span class="line">    serviceUrl = <span class="string">&quot;http://localhost:8761/eureka&quot;</span></span><br><span class="line">    application = <span class="string">&quot;default&quot;</span></span><br><span class="line">    weight = <span class="string">&quot;1&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  redis &#123;</span><br><span class="line">    serverAddr = <span class="string">&quot;localhost:6379&quot;</span></span><br><span class="line">    db = <span class="string">&quot;0&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:2181&quot;</span></span><br><span class="line">    session.timeout = 6000</span><br><span class="line">    connect.timeout = 2000</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:8500&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;http://localhost:2379&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  sofa &#123;</span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:9603&quot;</span></span><br><span class="line">    application = <span class="string">&quot;default&quot;</span></span><br><span class="line">    region = <span class="string">&quot;DEFAULT_ZONE&quot;</span></span><br><span class="line">    datacenter = <span class="string">&quot;DefaultDataCenter&quot;</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    group = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">    addressWaitTime = <span class="string">&quot;3000&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name = <span class="string">&quot;file.conf&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config &#123;</span><br><span class="line">  <span class="comment"># file、nacos 、apollo、zk、consul、etcd3</span></span><br><span class="line">  <span class="built_in">type</span> = <span class="string">&quot;file&quot;</span></span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    namespace = <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:8500&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  apollo &#123;</span><br><span class="line">    app.id = <span class="string">&quot;seata-server&quot;</span></span><br><span class="line">    apollo.meta = <span class="string">&quot;http://192.168.1.204:8801&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:2181&quot;</span></span><br><span class="line">    session.timeout = 6000</span><br><span class="line">    connect.timeout = 2000</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    serverAddr = <span class="string">&quot;http://localhost:2379&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name = <span class="string">&quot;file.conf&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-domain">(5) domain</h5>
<p>domain 就是entity（pojo，bean），对应数据库的表，不同公司习惯不一样。</p>
<p>新建Order类与CommonResult类</p>
<h6 id="Order">Order</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.domain;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long productId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal money;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单状态：0：创建中；1：已完结</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="CommonResult">CommonResult</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommonResult</span><span class="params">(Integer code, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(code, message, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="6-Dao接口及实现-SQL映射文件">(6) Dao接口及实现(SQL映射文件)</h5>
<p>dao中至少要有两个方法，一个是创建订单，一个是修改订单状态</p>
<h6 id="OrderDao">OrderDao</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.domain.Order;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> MrLinxi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2021-11-10-22:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderDao</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(Order order)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改订单状态，从0改为1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> Long userId, <span class="meta">@Param(&quot;status&quot;)</span> Integer status)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="OrderMapper-xml">OrderMapper.xml</h6>
<p>resources文件夹下新建mapper文件夹后添加OrderMapper.xml。完成dao的具体实现。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.cloudalibaba.dao.OrderDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--定义一个结果集和实体类的映射表--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.atguigu.cloudalibaba.domain.Order&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;userId&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;product_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;productId&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;count&quot;</span> <span class="attr">property</span>=<span class="string">&quot;count&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;money&quot;</span> <span class="attr">property</span>=<span class="string">&quot;money&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;DECIMAL&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;status&quot;</span> <span class="attr">property</span>=<span class="string">&quot;status&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;create&quot;</span>&gt;</span></span><br><span class="line">        INSERT INTO `t_order` (`id`, `user_id`, `product_id`, `count`, `money`, `status`)</span><br><span class="line">        VALUES (NULL, #&#123;userId&#125;, #&#123;productId&#125;, #&#123;count&#125;, #&#123;money&#125;, 0);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span>&gt;</span></span><br><span class="line">        UPDATE `t_order`</span><br><span class="line">        SET status = 1</span><br><span class="line">        WHERE user_id = #&#123;userId&#125; AND status = #&#123;status&#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="7-Service接口及实现">(7) Service接口及实现</h5>
<p><strong>Order2001驱动自己，外加调用库存和账户：共3个service</strong></p>
<h6 id="OrderService">OrderService</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.domain.Order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="comment">// 创建订单</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(Order order)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="StorageService">StorageService</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.domain.CommonResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过OpenFeign远程调用库存的微服务</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;seata-storage-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StorageService</span> &#123;</span><br><span class="line">    <span class="comment">//扣减库存，比如买了5个1号商品：对1号商品库存减5</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/storage/decrease&quot;)</span></span><br><span class="line">    CommonResult <span class="title function_">decrease</span><span class="params">(<span class="meta">@RequestParam(&quot;productId&quot;)</span> Long productId, <span class="meta">@RequestParam(&quot;count&quot;)</span> Integer count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="AccountService">AccountService</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.domain.CommonResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过OpenFeign远程调用账号微服务</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;seata-account-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">//扣减账户余额，需要传入用户ID跟扣除的金额</span></span><br><span class="line">    <span class="comment">//@RequestMapping(value = &quot;/account/decrease&quot;, method = RequestMethod.POST, produces = &quot;application/json; charset=UTF-8&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/account/decrease&quot;)</span></span><br><span class="line">    CommonResult <span class="title function_">decrease</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId, <span class="meta">@RequestParam(&quot;money&quot;)</span> BigDecimal money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="OrderServiceImpl">OrderServiceImpl</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service.Impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.dao.OrderDao;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.domain.Order;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.StorageService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderDao orderDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StorageService storageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单-&gt;调用库存服务扣减库存-&gt;调用账户服务扣减账户余额-&gt;修改订单状态</span></span><br><span class="line"><span class="comment">     * 简单说：</span></span><br><span class="line"><span class="comment">     * 下订单-&gt;减库存-&gt;减余额-&gt;改状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;下单开始&quot;</span>);</span><br><span class="line">        <span class="comment">//本应用创建订单</span></span><br><span class="line">        orderDao.create(order);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//远程调用库存服务扣减库存</span></span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;订单微服务调用库存微服务，扣减库存开始&quot;</span>);</span><br><span class="line">        storageService.decrease(order.getProductId(),order.getCount());</span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;订单微服务调用库存微服务，扣减库存结束&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//远程调用账户服务扣减余额</span></span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;订单微服务调用账户微服务，扣减余额开始&quot;</span>);</span><br><span class="line">        accountService.decrease(order.getUserId(),order.getMoney());</span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;订单微服务调用账户微服务，减余额结束&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//修改订单状态为已完成</span></span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;order-service中修改订单状态开始&quot;</span>);</span><br><span class="line">        <span class="comment">// 这里的话是不是应该是orderId？</span></span><br><span class="line">        orderDao.update(order.getUserId(),<span class="number">0</span>);</span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;order-service中修改订单状态结束&quot;</span>);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;下单结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="8-controller">(8) controller</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.domain.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.domain.Order;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建订单</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/order/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">create</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        orderService.create(order);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;订单创建成功!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="9-config">(9) config</h5>
<h6 id="MyBatisConfig">MyBatisConfig</h6>
<p>mybatis配置类，绑定实现文件OrderMapper.xml与Dao接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&#123;&quot;com.atguigu.cloudalibaba.dao&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="DataSourceProxyConfig">DataSourceProxyConfig</h6>
<p>DataSouce的包是sql下的，DataSourceProxy是seata下的，不要搞错了。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636623945614-0c74dca4-e78e-4a6d-b65f-f3bf588c143c.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line"><span class="keyword">import</span> io.seata.rm.datasource.DataSourceProxy;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.transaction.SpringManagedTransactionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用Seata对数据源进行代理</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceProxyConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;mybatis.mapperLocations&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String mapperLocations;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">druidDataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line"><span class="comment">//    @Primary</span></span><br><span class="line">    <span class="comment">//DataSourceProxy方法上标注@Primary就可以了，这样就自动用的代理的DataSource(DS的子类)，</span></span><br><span class="line">    <span class="comment">// 而不是Druid的, 否则就需要自己构造sqlSessionFactory</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceProxy <span class="title function_">dataSourceProxy</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceProxy</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactoryBean</span><span class="params">(DataSourceProxy dataSourceProxy)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">sqlSessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        sqlSessionFactoryBean.setDataSource(dataSourceProxy);</span><br><span class="line">        sqlSessionFactoryBean.setMapperLocations(<span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>().getResources(mapperLocations));</span><br><span class="line">        sqlSessionFactoryBean.setTransactionFactory(<span class="keyword">new</span> <span class="title class_">SpringManagedTransactionFactory</span>());</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="10-主启动类">(10) 主启动类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)</span> <span class="comment">//取消数据源的自动创建</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataOrderMainApp2001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SeataOrderMainApp2001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="启动测试-2">启动测试</h5>
<p>注意要降低版本</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305131857733.png" alt="image-20230513185742451" style="zoom:33%;">
<p>先启动nacos-1.1.4和seata-0.9.0，再启动2001。</p>
<p>2001启动成功，成功注册到nacos中</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636722603007-0a6df6bf-28d9-44dd-8d58-e76b14d94427.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636722630747-fbdc8cc0-dd4c-45bf-96cb-4da7906a623e.png" alt></p>
<p>测试nacos-2.0.3和seata-0.9.0，再启动2001 也可以启动成功</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046011.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636722828489-0bdc54a6-0acc-4a8f-8972-ff8d7ba0985a.png" alt></p>
<h4 id="3-2-新建库存Storage-Module——seata-storage-service2002">3.2 新建库存Storage-Module——seata-storage-service2002</h4>
<h5 id="1-pom-7">(1) pom</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-storage-service2002<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--nacos--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--seata--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 因为兼容版本问题,所以需要剔除它自带的seata的包 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--这里引入的版本要跟安装的版本对应--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--feign--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--web-actuator--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mysql-druid--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-application-yml-2">(2) application.yml</h5>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seata-storage-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">alibaba:</span></span><br><span class="line">      <span class="attr">seata:</span></span><br><span class="line">        <span class="comment">#自定义事务组名称需要与seata-server中file.conf中配置的事务组ID对应</span></span><br><span class="line">        <span class="comment">#vgroup_mapping.my_test_tx_group = &quot;my_group&quot;</span></span><br><span class="line">        <span class="comment">#        tx-service-group: my_test_tx_group</span></span><br><span class="line">        <span class="attr">tx-service-group:</span> <span class="string">my_group</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/seata_storage?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">10086</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务提供端不需要远程调用</span></span><br><span class="line"><span class="comment">#feign:</span></span><br><span class="line"><span class="comment">#  hystrix:</span></span><br><span class="line"><span class="comment">#    enabled: false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">io:</span></span><br><span class="line">      <span class="attr">seata:</span> <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="comment"># 扫描类路径下mapper文件夹下的.xml配置文件</span></span><br><span class="line">  <span class="attr">mapperLocations:</span> <span class="string">classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure>
<h5 id="3-file-conf-registry-conf">(3) file.conf &amp; registry.conf</h5>
<p>跟2001的一模一样</p>
<h5 id="4-domain">(4) domain</h5>
<h6 id="Storage">Storage</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.domian;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Storage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//产品ID</span></span><br><span class="line">    <span class="keyword">private</span> Long productId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总库存</span></span><br><span class="line">    <span class="keyword">private</span> Integer total;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//已用库存</span></span><br><span class="line">    <span class="keyword">private</span> Integer used;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//剩余库存</span></span><br><span class="line">    <span class="keyword">private</span> Integer residue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="CommonResult-2">CommonResult</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommonResult</span><span class="params">(Integer code, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(code, message, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-Dao接口及实现-SQL映射文件">(5) Dao接口及实现(SQL映射文件)</h5>
<h6 id="StorageDao">StorageDao</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StorageDao</span> &#123;</span><br><span class="line">        <span class="comment">//扣减库存：根据产品ID扣除</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">decrease</span><span class="params">(<span class="meta">@Param(&quot;productId&quot;)</span> Long productId, <span class="meta">@Param(&quot;count&quot;)</span> Integer count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="StorageMapper-xml">StorageMapper.xml</h6>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.cloudalibaba.dao.StorageDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;storage&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.atguigu.cloudalibaba.domian.Storage&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;product_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;productId&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;total&quot;</span> <span class="attr">property</span>=<span class="string">&quot;total&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;used&quot;</span> <span class="attr">property</span>=<span class="string">&quot;used&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;residue&quot;</span> <span class="attr">property</span>=<span class="string">&quot;residue&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;decrease&quot;</span>&gt;</span></span><br><span class="line">        update `t_storage`</span><br><span class="line">        SET `used` = `used` + #&#123;count&#125;, `residue` = `residue` - #&#123;count&#125;</span><br><span class="line">        WHERE `product_id` = #&#123;productId&#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="6-Service接口及实现">(6) Service接口及实现</h5>
<h6 id="StorageService-2">StorageService</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StorageService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减库存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">decrease</span><span class="params">(Long productId, Integer count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="StorageServiceImpl">StorageServiceImpl</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service.Impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.dao.StorageDao;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.StorageService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">StorageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(StorageServiceImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StorageDao storageDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减库存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> productId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrease</span><span class="params">(Long productId, Integer count)</span> &#123;</span><br><span class="line"><span class="comment">//        log.info(&quot;--------&gt;storage-service中扣减库存&quot;);</span></span><br><span class="line">        LOGGER.info(<span class="string">&quot;--------&gt;storage-service中扣减库存&quot;</span>);</span><br><span class="line">        storageDao.decrease(productId, count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="7-Controller">(7) Controller</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.domian.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.StorageService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StorageService storageService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//RequestMapping默认GET POST请求都支持，根据前端自动适应</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/storage/decrease&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">decrease</span><span class="params">(Long productId, Integer count)</span> &#123;</span><br><span class="line">        storageService.decrease(productId, count);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;扣减库存成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="8-config配置">(8) config配置</h5>
<p>与2001的一模一样</p>
<h5 id="9-主启动类">(9) 主启动类</h5>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305131915643.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;com.ry.sc.dao&quot;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataStorageMainApp2002</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SeataStorageMainApp2002.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="启动测试-3">启动测试</h5>
<p>启动nacos、seata、2002；启动成功，注册进nacos。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636875245112-c004268f-3305-4a0c-9ae3-c6932f034de0.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636875238158-59a99c9d-03ac-4563-bda8-9b9d755410a6.png" alt></p>
<h4 id="3-3-新建账户Account-Module——seata-account-service2003">3.3 新建账户Account-Module——seata-account-service2003</h4>
<h5 id="1-pom-8">(1) pom</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk8cloud2021<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-account-service2003<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--nacos--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--seata--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 因为兼容版本问题,所以需要剔除它自带的seata的包 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--feign--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--web-actuator--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mysql-druid--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-application-yml-3">(2) application.yml</h5>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seata-account-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">alibaba:</span></span><br><span class="line">      <span class="attr">seata:</span></span><br><span class="line">        <span class="comment">#自定义事务组名称需要与seata-server中file.conf中配置的事务组ID对应</span></span><br><span class="line">        <span class="comment">#vgroup_mapping.my_test_tx_group = &quot;my_group&quot;</span></span><br><span class="line">        <span class="comment">#        tx-service-group: my_test_tx_group</span></span><br><span class="line">        <span class="attr">tx-service-group:</span> <span class="string">my_group</span></span><br><span class="line">    <span class="comment">#        tx-service-group: default</span></span><br><span class="line">    <span class="comment">#        tx-service-group: my_test_tx_group</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/seata_account?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">10086</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#feign:</span></span><br><span class="line"><span class="comment">#  hystrix:</span></span><br><span class="line"><span class="comment">#    enabled: false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">io:</span></span><br><span class="line">      <span class="attr">seata:</span> <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="comment"># 扫描类路径下mapper文件夹下的.xml配置文件</span></span><br><span class="line">  <span class="attr">mapperLocations:</span> <span class="string">classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure>
<h5 id="3-file-conf-registry-conf-2">(3) file.conf &amp; registry.conf</h5>
<p>跟2001一模一样</p>
<h5 id="4-domain-2">(4) domain</h5>
<h6 id="Account">Account</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.domain;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户ID</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总额度</span></span><br><span class="line">    <span class="keyword">private</span> Integer total;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//已用额度</span></span><br><span class="line">    <span class="keyword">private</span> Integer used;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//剩余额度</span></span><br><span class="line">    <span class="keyword">private</span> Integer residue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="CommonResult-3">CommonResult</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommonResult</span><span class="params">(Integer code, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(code, message, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-Dao接口及实现">(5) Dao接口及实现</h5>
<h6 id="AccountDao">AccountDao</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountDao</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减账户余额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">decrease</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> Long userId, <span class="meta">@Param(&quot;money&quot;)</span> BigDecimal money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="AccountMapper-xml">AccountMapper.xml</h6>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.cloudalibaba.dao.AccountDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.atguigu.cloudalibaba.domain.Account&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;userId&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;total&quot;</span> <span class="attr">property</span>=<span class="string">&quot;total&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;DECIMAL&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;used&quot;</span> <span class="attr">property</span>=<span class="string">&quot;used&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;DECIMAL&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;residue&quot;</span> <span class="attr">property</span>=<span class="string">&quot;residue&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;DECIMAL&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;decrease&quot;</span>&gt;</span></span><br><span class="line">        UPDATE t_account</span><br><span class="line">        SET `used` = `used` + #&#123;money&#125;, `residue` = `residue` - #&#123;money&#125;</span><br><span class="line">        WHERE `user_id` = #&#123;userId&#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="6-Service接口及实现-2">(6) Service接口及实现</h5>
<h6 id="AccountService-2">AccountService</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减账户金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId  用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money  金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">decrease</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId, <span class="meta">@RequestParam(&quot;money&quot;)</span> BigDecimal money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="AccountServiceImpl">AccountServiceImpl</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.dao.AccountDao;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(AccountServiceImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减账户余额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money  金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrease</span><span class="params">(Long userId, BigDecimal money)</span> &#123;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;-------&gt;account-service中扣减账户余额开始&quot;</span>);</span><br><span class="line">        <span class="comment">//模拟超时异常，全局事务回滚</span></span><br><span class="line">        <span class="comment">//暂停几秒钟线程</span></span><br><span class="line">        <span class="comment">//try &#123; TimeUnit.SECONDS.sleep(30); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;</span></span><br><span class="line">        accountDao.decrease(userId, money);</span><br><span class="line">        LOGGER.info(<span class="string">&quot;-------&gt;account-service中扣减账户余额结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="7-Controller-2">(7) Controller</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.domain.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减账户余额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/account/decrease&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">decrease</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId, <span class="meta">@RequestParam(&quot;money&quot;)</span> BigDecimal money)</span> &#123;</span><br><span class="line">        accountService.decrease(userId, money);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;扣减账户余额成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="8-config配置-2">(8) config配置</h5>
<p>和2001一模一样</p>
<h5 id="9-主启动类-2">(9) 主启动类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataAccountMainApp2003</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SeataAccountMainApp2003.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="启动测试-4">启动测试</h5>
<p>启动nacos、seata、2003；启动成功，成功注册进nacos</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636876914165-bcd89219-515c-455d-82e0-2ad415e6259f.png" alt></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046886.png" alt></p>
<h3 id="填坑高版本seata1-4-2client配置">## 填坑高版本seata1.4.2client配置</h3>
<blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/weixin_44790046/article/details/106970822">seata1.2.0</a>   <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/jixieguang/article/details/110621561">Seata1.4.0+nacos</a></p>
<p>使用seata1.4.2 各个微服务整体上的代码是差不多的，区别的地方在于1.4.2支持yml、properties文件里配置client端的seata，不再需要file.conf/registry.conf文件。同时支持**@EnableAutoDataSourceProxy**注解开启数据源的自动代理（不需要手动配置数据源）</p>
<h3 id="①-修改父工程版本控制">① 修改父工程版本控制</h3>
<p>seata高版本各微服务可以直接通过yml、properties来配置seata，不需要在微服务中加入file.conf和registry.conf文件。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637067484131-41b3b3e5-e13c-43d7-a295-87f5629afb9a.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637067487583-f3020854-dec1-4ff4-9b33-b452be46bbfd.png" alt></p>
<p>注意版本对应关系，这里要使用<strong>SpringCloud Hoxton.SR9+SpringCloud Alibaba 2.2.6.RELEASE+Spring Boot 2.3.2RELEASE+Nacos 1.4.2（我用的2.0.3）+Seata 1.3.0（我用的1.4.2）</strong>。</p>
<p>修改父工程的依赖版本，主要是让springboot、SpringCloud、SpringCloud alibaba版本对应。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="comment">&lt;!--spring boot 2.3.2--&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="comment">&lt;!--spring cloud Hoxton.SR9--&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="comment">&lt;!--spring cloud alibaba 2.2.6.RELEASE--&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="②-修改微服务模块seata依赖pom">② 修改微服务模块seata依赖pom</h3>
<p>官网上对seata依赖是这么描述的：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637081103185-526524eb-d9c6-45c4-86f7-75f35eb942dd.png" alt></p>
<p>官网推荐依赖配置方式：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637113871974-fb756b45-4fb4-4bf2-90be-f4a05f4eb303.png" alt></p>
<p>但是经过我测试发现，还是需要排除掉spring-cloud-starter-alibaba-seata里面的seata-all</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="comment">&lt;!--seata--&gt;</span></span><br><span class="line">&gt;<span class="comment">&lt;!--seata-spring-boot-starter 集成了seata-all，版本对应--&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;<span class="comment">&lt;!-- 因为兼容版本问题,所以需要剔除它自带的seata的包 --&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>实际上我有微服务只配置了seata-spring-boot-starter依赖，spring-cloud-starter-alibaba-seata没有配置，并不影响正常使用。</p>
<h3 id="③-修改微服务application-yml">③ 修改微服务application.yml</h3>
<p>直接将seata的相关配置，配置到application.yml文件中，几个微服务的yml类似：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&gt;#</span>  <span class="string">这一块是配置seata的</span></span><br><span class="line"><span class="string">&gt;seata:</span></span><br><span class="line"><span class="string">&gt;enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">&gt;application-id:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="string">&gt;enable-auto-data-source-proxy:</span> <span class="literal">true</span> <span class="comment">#是否开启数据源自动代理,默认为true</span></span><br><span class="line"><span class="string">&gt;tx-service-group:</span> <span class="string">my_test_tx_group</span>  <span class="comment">#要与config.txt配置文件中的vgroupMapping一致</span></span><br><span class="line"><span class="string">&gt;registry:</span> <span class="comment">#registry根据seata服务端的registry配置</span></span><br><span class="line"><span class="string">&gt;type:</span> <span class="string">nacos</span> <span class="comment">#默认为file</span></span><br><span class="line"><span class="string">&gt;nacos:</span></span><br><span class="line"><span class="string">&gt;application:</span> <span class="string">seata-server</span> <span class="comment">#配置自己的seata服务,与registry.conf一致</span></span><br><span class="line"><span class="string">&gt;server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span> <span class="comment">#根据自己的seata服务配置</span></span><br><span class="line"><span class="string">&gt;username:</span> <span class="string">nacos</span> <span class="comment">#根据自己的seata服务配置</span></span><br><span class="line"><span class="string">&gt;password:</span> <span class="string">nacos</span>  <span class="comment">#根据自己的seata服务配置</span></span><br><span class="line"><span class="string">&gt;namespace:</span> <span class="string">f0378218-b129-4fd8-839c-9bdfd010205b</span> <span class="comment">#根据自己的seata服务配置</span></span><br><span class="line"><span class="string">&gt;cluster:</span> <span class="string">default</span> <span class="comment"># 配置自己的seata服务cluster, 默认为 default</span></span><br><span class="line"><span class="string">&gt;group:</span> <span class="string">&quot;SEATA_GROUP&quot;</span> <span class="comment">#根据自己的seata服务配置</span></span><br><span class="line"><span class="string">&gt;config:</span></span><br><span class="line"><span class="string">&gt;type:</span> <span class="string">nacos</span> <span class="comment">#配置中心设置为nacos，直接从nacos上获取配置</span></span><br><span class="line"><span class="string">&gt;nacos:</span></span><br><span class="line"><span class="string">&gt;server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span>  <span class="comment">#配置自己的nacos地址</span></span><br><span class="line"><span class="string">&gt;group:</span> <span class="string">SEATA_GROUP</span>  <span class="comment">#配置自己的group，这里我配置跟registry.conf一样</span></span><br><span class="line"><span class="string">&gt;username:</span> <span class="string">nacos</span>  <span class="comment">#配置自己的username</span></span><br><span class="line"><span class="string">&gt;password:</span> <span class="string">nacos</span>  <span class="comment">#配置自己的password</span></span><br><span class="line"><span class="string">&gt;namespace:</span> <span class="string">f0378218-b129-4fd8-839c-9bdfd010205b</span>  <span class="comment">#根据自己的seata服务配置</span></span><br><span class="line"><span class="string">&gt;#</span> <span class="string">dataId如果不用，就不需要配置</span></span><br><span class="line"><span class="string">&gt;#</span>      <span class="attr">dataId:</span> <span class="string">seataServer.properties</span>  <span class="comment">#配置自己的dataId,由于搭建服务端时把客户端的配置也写在了seataServer.properties,所以这里用了和服务端一样的配置文件,实际客户端和服务端的配置文件分离出来更好</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;#</span> <span class="string">这里是配置微服务的端口、注册到哪、数据源等等</span></span><br><span class="line"><span class="string">&gt;server:</span></span><br><span class="line"><span class="string">&gt;port:</span> <span class="number">2001</span></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;spring:</span></span><br><span class="line"><span class="string">&gt;application:</span></span><br><span class="line"><span class="string">&gt;name:</span> <span class="string">seata-order-service</span></span><br><span class="line"><span class="string">&gt;cloud:</span></span><br><span class="line"><span class="string">&gt;#</span>    <span class="attr">alibaba:</span></span><br><span class="line"><span class="string">&gt;#</span>      <span class="attr">seata:</span></span><br><span class="line"><span class="string">&gt;#</span>        <span class="comment">#自定义事务组名称需要与seata-server中file.conf中配置的事务组ID对应</span></span><br><span class="line"><span class="string">&gt;#</span>        <span class="comment">#vgroup_mapping.my_test_tx_group = &quot;my_group&quot;</span></span><br><span class="line"><span class="string">&gt;#</span>        <span class="attr">tx-service-group:</span> <span class="string">my_group</span></span><br><span class="line"><span class="string">&gt;nacos:</span></span><br><span class="line"><span class="string">&gt;discovery:</span></span><br><span class="line"><span class="string">&gt;server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"><span class="string">&gt;datasource:</span></span><br><span class="line"><span class="string">&gt;driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="string">&gt;url:</span> <span class="string">jdbc:mysql://localhost:3306/seata_order?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="string">&gt;username:</span> <span class="string">root</span></span><br><span class="line"><span class="string">&gt;password:</span> <span class="number">10086</span></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;feign:</span></span><br><span class="line"><span class="string">&gt;hystrix:</span></span><br><span class="line"><span class="string">&gt;enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;logging:</span></span><br><span class="line"><span class="string">&gt;level:</span></span><br><span class="line"><span class="string">&gt;io:</span></span><br><span class="line"><span class="string">&gt;seata:</span> <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;mybatis:</span></span><br><span class="line"><span class="string">&gt;mapperLocations:</span> <span class="string">classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure>
<p>注意对应关系：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1637126855997-372aeee0-b262-4ec0-8207-57dc27013051.png" alt></p>
<p>我的配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&gt;server:</span></span><br><span class="line"><span class="string">&gt;port:</span> <span class="number">8083</span></span><br><span class="line"><span class="string">&gt;spring:</span></span><br><span class="line"><span class="string">&gt;application:</span></span><br><span class="line"><span class="string">&gt;name:</span> <span class="string">account-service</span></span><br><span class="line"><span class="string">&gt;datasource:</span></span><br><span class="line"><span class="string">&gt;driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="string">&gt;url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/seata_heima?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC&amp;allowPublicKeyRetrieval=true</span></span><br><span class="line"><span class="string">&gt;username:</span> <span class="string">root</span></span><br><span class="line"><span class="string">&gt;password:</span> <span class="string">&#x27;00000000&#x27;</span></span><br><span class="line"><span class="string">&gt;cloud:</span></span><br><span class="line"><span class="string">&gt;nacos:</span></span><br><span class="line"><span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;mybatis-plus:</span></span><br><span class="line"><span class="string">&gt;global-config:</span></span><br><span class="line"><span class="string">&gt;db-config:</span></span><br><span class="line"><span class="attr">insert-strategy:</span> <span class="string">not_null</span></span><br><span class="line"><span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line"><span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line"><span class="string">&gt;logging:</span></span><br><span class="line"><span class="string">&gt;level:</span></span><br><span class="line"><span class="string">&gt;org.springframework.cloud.alibaba.seata.web:</span> <span class="string">debug</span></span><br><span class="line"><span class="string">&gt;cn.itcast:</span> <span class="string">debug</span></span><br><span class="line"><span class="string">&gt;pattern:</span></span><br><span class="line"><span class="string">&gt;dateformat:</span> <span class="string">MM-dd</span> <span class="string">HH:mm:ss:SSS</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;seata:</span></span><br><span class="line"><span class="string">&gt;#注册中心的配置</span></span><br><span class="line"><span class="string">&gt;registry:</span></span><br><span class="line"><span class="string">&gt;type:</span> <span class="string">nacos</span></span><br><span class="line"><span class="string">&gt;nacos:</span></span><br><span class="line"><span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">&quot;b0098261-17ee-4138-b7ba-88f5205674c9&quot;</span></span><br><span class="line"><span class="attr">group:</span> <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line"><span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line"><span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line"><span class="comment">#事务组名称 seata-demo-service是自定义的</span></span><br><span class="line"><span class="string">&gt;tx-service-group:</span> <span class="string">seata-demo-service</span></span><br><span class="line"><span class="string">&gt;service:</span></span><br><span class="line"><span class="string">&gt;vgroup-mapping:</span></span><br><span class="line"><span class="attr">seata-demo-service:</span> <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>之后启动服务</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305171916875.png" alt="image-20230517191647610" style="zoom:33%;">
<h3 id="④-修改主启动类和DataSourceProxyConfig类">④ 修改主启动类和DataSourceProxyConfig类</h3>
<h4 id="主启动类">主启动类</h4>
<p>主启动类加上<code>@EnableAutoDataSourceProxy</code>注解，这里以storage的微服务为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">package</span> com.atguigu.cloudalibaba;</span><br><span class="line"></span><br><span class="line">&gt;<span class="keyword">import</span> io.seata.spring.annotation.datasource.EnableAutoDataSourceProxy;</span><br><span class="line">&gt;<span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line">&gt;<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">&gt;<span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line">&gt;<span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line">&gt;<span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line">&gt;<span class="meta">@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)</span></span><br><span class="line">&gt;<span class="meta">@EnableDiscoveryClient</span></span><br><span class="line">&gt;<span class="meta">@EnableFeignClients</span></span><br><span class="line">&gt;<span class="meta">@EnableAutoDataSourceProxy</span></span><br><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageMainApp2002</span> &#123;</span><br><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">&gt;SpringApplication.run(StorageMainApp2002.class, args);</span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="配置类">配置类</h4>
<p>使用**@EnableAutoDataSourceProxy<strong>注解后，不再需要DataSourceProxyConfig配置数据源代理。强行写会报错。如果需要自己配置数据源代理的话，在application.yml中设置</strong>seata.enable-auto-data-source-proxy<strong>为</strong>false**，主启动类上去掉**@EnableAutoDataSourceProxy**注解即可。</p>
<h3 id="参考博客">参考博客</h3>
<ol>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/ww_run/article/details/120099870?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link">Seata1.4.2+Nacos搭建使用</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/potatoillusion/article/details/117827986?spm=1001.2101.3001.6650.3&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-3.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-3.no_search_link">Seata1.4.2整合SpringCloud H——Seata安装与搭建</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/ClearCiM/article/details/119953255">https://blog.csdn.net/ClearCiM/article/details/119953255</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/tyvbpq/article/details/119703363?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-10-119703363.pc_agg_new_rank&amp;utm_term=dataid+nacos+seata+%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83&amp;spm=1000.2123.3001.4430">spring cloud使用nacos和seata（windows环境）</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/hongtaolong/article/details/120144437?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-7-120144437.pc_agg_new_rank&amp;utm_term=dataid+nacos+seata+%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83&amp;spm=1000.2123.3001.4430">SEATA配合nacos使用</a></li>
</ol>
</blockquote>
<h6 id="启动成功标识：">启动成功标识：</h6>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305131936481.png" alt></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305131927048.png" alt></p>
<h3 id="四、测试">四、测试</h3>
<h4 id="Seata全局事务怎么使用">Seata全局事务怎么使用</h4>
<p>Spring提供的<code>本地</code>事务：<code>@Transactional</code></p>
<p>Seata提供的<code>全局</code>事务：<code>@GlobalTransactional</code></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636880513744-d81289ab-be90-4832-b76c-facc47ef00d9.png" alt></p>
<h4 id="4-0-数据库初始情况">4.0 数据库初始情况</h4>
<p>下订单-&gt;减库存-&gt;扣余额-&gt;改(订单)状态</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636880852242-f2460919-e326-4d4e-89b6-78c348c2eedd.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636880870145-b34edc59-33e6-415b-a2c5-b94c70955f73.png" alt></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046142.png" alt></p>
<h4 id="4-1-测试正常下单">4.1 测试正常下单</h4>
<p><code>启动nacos、seata、2001、2002、2003；</code></p>
<p>测试：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:2001/order/create?userId=1&amp;productId=1&amp;count=10&amp;money=100">http://localhost:2001/order/create?userId=1&amp;productId=1&amp;count=10&amp;money=100</a></p>
<h5 id="报错">报错</h5>
<p><strong>java.sql.SQLException:Failed to fetch schema of <code>t_order</code></strong></p>
<p>Connector/J 5.0.0以后的版本有一个名为useInformationSchema的数据库连接参数，</p>
<p>Connector/J 在mysql8.0中默认配置连接属性useInformationSchema为true，使查询table信息时更为有效。</p>
<p>用户依然可以配置useInformationSchema为false，</p>
<p>但是在8.0.3及其之后的版本中，由于不能支持早期的特性，某些数据字典的查询可能会失败。</p>
<p>useInformationSchema配置为false的时候，也可能会造成REMARKS信息（对应数据库中各字段的comment）的缺失。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636885157700-4b671044-f674-448a-b790-687be655d1c5.png" alt></p>
<p><code>在各微服务的application.yml 文件的spring.datasource.url 后面加上&amp;useInformationSchema=false设置useInformationSchema为false，即可解决该问题。</code><br>
参考：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/acc99f891e91">https://www.jianshu.com/p/acc99f891e91</a></p>
<h5 id="再次测试">再次测试</h5>
<p>访问成功</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636885386660-f73be4c7-8f96-4436-928d-1b8924c3e812.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636886967312-d6cb850f-eef7-43bb-be02-6c9e46b69755.png" alt></p>
<p>数据库情况：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046589.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636885537110-40bda427-d547-423d-9538-eff77ce3141d.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636885554249-edf1239b-27f2-4718-b529-1668c3229230.png" alt></p>
<h4 id="4-2-测试超时异常：不加-GlobalTransactional">4.2 测试超时异常：不加@GlobalTransactional</h4>
<h5 id="AccountServiceImpl添加超时：">AccountServiceImpl添加超时：</h5>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046552.png" alt></p>
<p>我们使用的是Openfeign，默认超时时长是1s，这里我们延迟30s。</p>
<h5 id="报错超时异常：">报错超时异常：</h5>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636887516874-e984a427-fd14-49c6-a025-d8a2ec94f904.png" alt></p>
<h5 id="数据库情况：">数据库情况：</h5>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636887749627-98e85882-a208-4380-beb1-3f68531995d2.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636887791521-b7101ffd-ac2f-4d8c-9be1-aea20ea51d7c.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636887816708-5257dccc-a554-410a-8e0d-2f742a3e26cd.png" alt></p>
<p>当库存和账户金额扣减后，订单状态并没有设置为已经完成，没有从零改为1；而且由于feign的重试机制，账户余额还有可能被多次扣减。</p>
<h4 id="4-3-测试超时异常：加-GlobalTransactional">4.3 测试超时异常：加@GlobalTransactional</h4>
<p>OrderServiceImpl添加**@GlobalTransactional**注解，注意改注解只能用在方法上！</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636888242942-a1c827b4-5ec0-4515-bf74-e1e6f358cdbf.png" alt></p>
<ul>
<li><code>name</code>：给定全局事务实例的名称，随便取，唯一即可</li>
<li><code>rollbackFor</code>：当发生什么样的异常时，进行回滚</li>
<li><code>noRollbackFor</code>：发生什么样的异常不进行回滚。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.cloudalibaba.service.Impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.dao.OrderDao;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.domain.Order;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.cloudalibaba.service.StorageService;</span><br><span class="line"><span class="keyword">import</span> io.seata.spring.annotation.GlobalTransactional;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderDao orderDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StorageService storageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单-&gt;调用库存服务扣减库存-&gt;调用账户服务扣减账户余额-&gt;修改订单状态</span></span><br><span class="line"><span class="comment">     * 简单说：</span></span><br><span class="line"><span class="comment">     * 下订单-&gt;减库存-&gt;减余额-&gt;改状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//全局事务，发生异常进行回滚</span></span><br><span class="line">    <span class="meta">@GlobalTransactional(name = &quot;lsp-create-order&quot;, rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;下单开始&quot;</span>);</span><br><span class="line">        <span class="comment">//本应用创建订单</span></span><br><span class="line">        orderDao.create(order);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//远程调用库存服务扣减库存</span></span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;订单微服务调用库存微服务，扣减库存开始&quot;</span>);</span><br><span class="line">        storageService.decrease(order.getProductId(),order.getCount());</span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;订单微服务调用库存微服务，扣减库存结束&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//远程调用账户服务扣减余额</span></span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;订单微服务调用账户微服务，扣减余额开始&quot;</span>);</span><br><span class="line">        accountService.decrease(order.getUserId(),order.getMoney());</span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;订单微服务调用账户微服务，减余额结束&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//修改订单状态为已完成</span></span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;order-service中修改订单状态开始&quot;</span>);</span><br><span class="line">        <span class="comment">// 这里的话是不是应该是orderId？</span></span><br><span class="line">        orderDao.update(order.getUserId(),<span class="number">0</span>);</span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;order-service中修改订单状态结束&quot;</span>);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;-------&gt;下单结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<p>依然超时异常</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046506.png" alt></p>
<p>数据库：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636888594617-08abffce-914c-4c7e-812f-821a487cdac0.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636888612571-33a3fca6-5c67-4c45-ab54-07cb3beee91e.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636888631676-3966be70-025d-446f-99bc-77d1872131b9.png" alt></p>
<p>我们发现数据库中的数据根本就没有变化，记录都添加不进来，说明回滚成功！</p>
<h4 id="4-4-小结">4.4 小结</h4>
<p>做好配置后，我们只需要使用一个 <code>@GlobalTransactional(name = &quot;lsp-create-order&quot;, rollbackFor = Exception.class) </code>放在业务的入口，即可实现控制全局的事务。注意该注解只能放在方法上。</p>
<h3 id="五、补充说明">五、补充说明</h3>
<p><code>Seata：Simple Extensible Autonomous Transaction Architecture，简单可扩展自治事务框架</code></p>
<p>0.9不支持集群，生产环境请使用1.0以上的版本。</p>
<h4 id="5-0-undo-log表的作用">5.0 undo_log表的作用</h4>
<p>模块内方法也可以加<code>@Transactional</code>注解，如果一个模块的事务提交了，Seata会把提交了哪些数据记录到<code>undo_log</code>表中</p>
<p>如果这时TC通知全局事务回滚，那么RM就从<code>undo_log</code>表中获取之前修改了哪些资源，并根据这个表回滚。（有待考证）</p>
<h4 id="5-1-再看TC-TM-RM三大组件">5.1 再看TC/TM/RM三大组件</h4>
<p>TC：seata服务器； （我们电脑上启动的seata ）</p>
<p>TM：事物的发起者，业务的入口。 哪个微服务使用了**@GlobalTransactional**哪个就是TM</p>
<p>RM：事务的参与者，一个数据库就是一个RM。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636890980594-f9db0624-1c09-4055-8c65-5c087d16b36f.png" alt></p>
<p>分布式事务的执行流程：</p>
<ol>
<li>TM 开启分布式事务（TM 向 TC 注册全局事务记录）；</li>
<li>按业务场景，编排数据库、服务等事务内资源（RM 向 TC 汇报资源准备状态 ）；</li>
<li>TM 结束分布式事务，事务一阶段结束（TM 通知 TC 提交/回滚分布式事务）；</li>
<li>TC 汇总事务信息，决定分布式事务是提交还是回滚；</li>
<li>TC 通知所有 RM 提交/回滚 资源，事务二阶段结束。</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636890679040-20e2d483-549c-459a-b481-693caab0d239.png" alt></p>
<h4 id="5-2-AT模式（默认）如何做到对业务的无侵入">5.2 AT模式（默认）如何做到对业务的无侵入</h4>
<p>Seata有四大模式：AT（默认）、TCC、SAGA、XA。（阿里云上的AT叫做GTS，收费）</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://seata.io/zh-cn/docs/dev/mode/at-mode.html">AT模式</a></p>
<p><code>AT模式两阶段提交协议的演变</code>：</p>
<ul>
<li>
<p>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。</p>
</li>
<li>
<p>二阶段：</p>
</li>
<li>
<ul>
<li>提交异步化，非常快速地完成。</li>
</ul>
</li>
<li>
<p>回滚通过一阶段的回滚日志进行反向补偿（前面insert，后面回滚时就delete）。</p>
</li>
</ul>
<p>每个数据库除了自身存储数据的表以外，都会有一个事务回滚表：undo_log</p>
<p>Seata库中存在：branch_table\global_table\lock_table\distributed_lock(高版本才有)这样一些表</p>
<h5 id="5-2-1-一阶段加载">5.2.1 一阶段加载</h5>
<p>在一阶段，Seata 会拦截“业务 SQL”，</p>
<p>1  解析 SQL 语义，找到“业务 SQL”要更新的业务数据，在业务数据被更新前，将其保存成“before image”（前置镜像）</p>
<p>2  执行“业务 SQL”更新业务数据，在业务数据更新之后，</p>
<p>3  其保存成“after image”，最后生成行锁。</p>
<p>以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636892157973-e4a5ccaf-71c5-481e-9417-6b64d389f36f.png" alt></p>
<h5 id="5-2-2-二阶段提交">5.2.2 二阶段提交</h5>
<p>因为“业务 SQL”在<strong>一阶段</strong>已经提交至数据库，<strong>二阶段如果顺利提交的话</strong>，那么Seata框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理即可。</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046690.png" alt></p>
<h5 id="5-2-3-二阶段回滚">5.2.3 二阶段回滚</h5>
<p>二阶段如果是回滚的话，Seata 就需要回滚一阶段已经执行的“业务 SQL”，还原业务数据。</p>
<p>回滚方式便是用“before image”还原业务数据；但在还原前要首先要校验脏写，对比“数据库当前业务数据”和 “after image”。如果两份数据完全一致就说明没有脏写，可以还原业务数据，如果不一致就说明有脏写，出现脏写就需要转人工处理。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636892634620-1e6c1596-baba-4aed-b840-8afdfd320e05.png" alt></p>
<h4 id="5-3-debug查看流程">5.3 debug查看流程</h4>
<p>最开是seata库中的三张表是没有数据的</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636892970332-138694e4-498e-4c57-82a3-9ed40feea4df.png" alt></p>
<p>2003打上断点，debug启动</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636892865851-b541d0b7-3e91-463f-9bd2-628c25379099.png" alt></p>
<p>访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:2001/order/create?userId=1&amp;productId=1&amp;count=10&amp;money=100%E3%80%82">http://localhost:2001/order/create?userId=1&amp;productId=1&amp;count=10&amp;money=100。</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636893040133-6768d513-0c8a-4d32-a308-35c88331fce8.png" alt></p>
<p>此时seata库中的三个表都是有数据的：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046982.png" alt></p>
<p>看一下branch_table，记录了各个RM的信息，分别对应order、storage、account三个微服务</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636893708587-5f6e35c2-bed9-4c95-9927-6c3c45dd1856.png" alt></p>
<p>可以看到xid跟global_table中的xid一致。</p>
<p>再看global_table：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636893900347-9735778c-ccf0-41a4-8b31-701541eb2db2.png" alt></p>
<p>查看lock_table：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046045.png" alt></p>
<p>查看各业务中的undo_log表：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636894224215-644fbe92-cec7-4f64-b4d5-9a3aab5daf85.png" alt></p>
<p>rollback_info是JSON字符串，存储了beforeimage、afterimage：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.undo.BranchUndoLog&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;xid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.190.1:8091:2090602861&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;branchId&quot;</span><span class="punctuation">:</span> <span class="number">2090602864</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sqlUndoLogs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;java.util.ArrayList&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.undo.SQLUndoLog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sqlType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;INSERT&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tableName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;`t_order`&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;beforeImage&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>   </span><br><span class="line">          <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.sql.struct.TableRecords$EmptyTableRecords&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tableName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;`t_order`&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;rows&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;java.util.ArrayList&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;afterImage&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.sql.struct.TableRecords&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tableName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;`t_order`&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;rows&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;java.util.ArrayList&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.sql.struct.Row&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="string">&quot;java.util.ArrayList&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.sql.struct.Field&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;keyType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PrimaryKey&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">-5</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;java.lang.Long&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="number">10</span></span><br><span class="line">                      <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.sql.struct.Field&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;keyType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NULL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">-5</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;java.lang.Long&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="number">1</span></span><br><span class="line">                      <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.sql.struct.Field&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;keyType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NULL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">-5</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;java.lang.Long&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="number">1</span></span><br><span class="line">                      <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.sql.struct.Field&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;count&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;keyType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NULL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.sql.struct.Field&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;money&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;keyType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NULL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;java.math.BigDecimal&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="number">100</span></span><br><span class="line">                      <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.seata.rm.datasource.sql.struct.Field&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;status&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;keyType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NULL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>查看seata_storage库中的undo_log表的roobal_info信息，可以看到beforeimage和afterimage分别保存了修改前后的信息。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636894851233-f395aad7-5132-4491-a0fd-c90e401e134d.png" alt></p>
<p>debug放行，seata库中表中的中间数据和undo_log表的数据都删除了。（我的seata_account表的undo_log中没有被删除，等了半天也没有。）异步任务阶段的分支提交请求将异步和批量地删除相应的undo_log记录。</p>
<p>发现account2003微服务的日志跟2001和2002都不一样</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636895782328-2b4843e2-5f95-4114-9e67-f56109b324c1.png" alt></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636895848770-086d3c08-3fec-4737-a06d-58f864bf1c7f.png" alt></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305010046161.png" alt></p>
<h4 id="5-4-整体流程图">5.4 整体流程图</h4>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/22423156/1636895943341-66b19f9d-e125-4536-8882-5c4c1f26fd91.png" alt></p>
<h3 id="四种模式的演示">四种模式的演示</h3>
<blockquote>
<p>注意在 黑马的项目里面 的数据库 的版本不能变为  8.0  只能用给的5.7的版本   否则会有错</p>
</blockquote>
<h4 id="XA-149-00-00">XA(149/00:00)</h4>
<blockquote>
<p>==怎么实现==</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305171954051.png" alt></p>
<p>==结果==</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305171953329.png" alt></p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305171955085.png" alt></p>
<p><strong>并且 数据库的值不会发生变化</strong></p>
</blockquote>
<h4 id="AT-149-15-54">AT(149/15:54)</h4>
<blockquote>
<p>==怎么实现==</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172008133.png" alt="image-20230517200815028" style="zoom:33%;">
<p>==使用==</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172016193.png" alt="image-20230517201645113" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172012497.png" alt="image-20230517201244417" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172012293.png" alt="image-20230517201253200" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172013152.png" alt="image-20230517201307076" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172013635.png" alt="image-20230517201318462" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172017140.png" style="zoom: 25%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172018795.png" alt="image-20230517201831713" style="zoom:33%;">
</blockquote>
<h4 id="TCC（不加锁）（149-47-36）">TCC（不加锁）（149/47:36）</h4>
<blockquote>
<p>==怎么使用==</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172038952.png" alt="image-20230517203837866" style="zoom:33%;">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">import</span> io.seata.rm.tcc.api.BusinessActionContext;</span><br><span class="line">&gt;<span class="keyword">import</span> io.seata.rm.tcc.api.BusinessActionContextParameter;</span><br><span class="line">&gt;<span class="keyword">import</span> io.seata.rm.tcc.api.TwoPhaseBusinessAction;</span><br><span class="line"></span><br><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountTCCService</span> &#123;</span><br><span class="line">&gt;<span class="meta">@TwoPhaseBusinessAction(name = &quot;deduct&quot;, commitMethod = &quot;confirm&quot;, rollbackMethod = &quot;cancel&quot;)</span></span><br><span class="line">&gt;<span class="keyword">void</span> <span class="title function_">deduct</span><span class="params">(<span class="meta">@BusinessActionContextParameter(paramName = &quot;userId&quot;)</span> String userId,</span></span><br><span class="line"><span class="params">          <span class="meta">@BusinessActionContextParameter(paramName = &quot;money&quot;)</span><span class="type">int</span> money)</span>;</span><br><span class="line"></span><br><span class="line">&gt;<span class="type">boolean</span> <span class="title function_">confirm</span><span class="params">(BusinessActionContext ctx)</span>;</span><br><span class="line"></span><br><span class="line">&gt;<span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(BusinessActionContext ctx)</span>;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountFreezeMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;AccountFreeze&gt; &#123;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">@Mapper</span></span><br><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Account&gt; &#123;</span><br><span class="line"></span><br><span class="line">&gt;<span class="meta">@Update(&quot;update account_tbl set money = money - $&#123;money&#125; where user_id = #&#123;userId&#125;&quot;)</span></span><br><span class="line">&gt;<span class="type">int</span> <span class="title function_">deduct</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> String userId, <span class="meta">@Param(&quot;money&quot;)</span> <span class="type">int</span> money)</span>;</span><br><span class="line"></span><br><span class="line">&gt;<span class="meta">@Update(&quot;update account_tbl set money = money + $&#123;money&#125; where user_id = #&#123;userId&#125;&quot;)</span></span><br><span class="line">&gt;<span class="type">int</span> <span class="title function_">refund</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> String userId, <span class="meta">@Param(&quot;money&quot;)</span> <span class="type">int</span> money)</span>;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">@Data</span></span><br><span class="line">&gt;<span class="meta">@TableName(&quot;account_freeze_tbl&quot;)</span></span><br><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountFreeze</span> &#123;</span><br><span class="line">&gt;<span class="meta">@TableId(type = IdType.INPUT)</span></span><br><span class="line">&gt;<span class="keyword">private</span> String xid;</span><br><span class="line">&gt;<span class="keyword">private</span> String userId;</span><br><span class="line">&gt;<span class="keyword">private</span> Integer freezeMoney;</span><br><span class="line">&gt;<span class="keyword">private</span> Integer state;</span><br><span class="line"></span><br><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">State</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">TRY</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">CONFIRM</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">CANCEL</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">@Data</span></span><br><span class="line">&gt;<span class="meta">@TableName(&quot;account_tbl&quot;)</span></span><br><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">&gt;<span class="meta">@TableId</span></span><br><span class="line">&gt;<span class="keyword">private</span> Long id;</span><br><span class="line">&gt;<span class="keyword">private</span> String userId;</span><br><span class="line">&gt;<span class="keyword">private</span> Integer money;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">package</span> cn.itcast.account.service.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;<span class="keyword">import</span> cn.itcast.account.entity.AccountFreeze;</span><br><span class="line">&gt;<span class="keyword">import</span> cn.itcast.account.mapper.AccountFreezeMapper;</span><br><span class="line">&gt;<span class="keyword">import</span> cn.itcast.account.mapper.AccountMapper;</span><br><span class="line">&gt;<span class="keyword">import</span> cn.itcast.account.service.AccountTCCService;</span><br><span class="line">&gt;<span class="keyword">import</span> io.seata.core.context.RootContext;</span><br><span class="line">&gt;<span class="keyword">import</span> io.seata.rm.tcc.api.BusinessActionContext;</span><br><span class="line">&gt;<span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line">&gt;<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">&gt;<span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line">&gt;<span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line">&gt;<span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line">&gt;<span class="meta">@Service</span></span><br><span class="line">&gt;<span class="meta">@Slf4j</span></span><br><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountTCCServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountTCCService</span> &#123;</span><br><span class="line"></span><br><span class="line">&gt;<span class="meta">@Autowired</span></span><br><span class="line">&gt;<span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line">&gt;<span class="meta">@Resource</span></span><br><span class="line">&gt;<span class="keyword">private</span> AccountFreezeMapper freezeMapper;</span><br><span class="line"></span><br><span class="line">&gt;<span class="meta">@Override</span></span><br><span class="line">&gt;<span class="meta">@Transactional</span></span><br><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deduct</span><span class="params">(String userId, <span class="type">int</span> money)</span> &#123;</span><br><span class="line">  <span class="comment">// 0.获取事务id</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> RootContext.getXID();</span><br><span class="line">  <span class="comment">//0.1.业务悬挂   判断freeze中是否有冻结记录，如果有，一定是CANCEL执行过，我要拒绝业务</span></span><br><span class="line">  <span class="type">AccountFreeze</span> <span class="variable">oldFreeze</span> <span class="operator">=</span>  freezeMapper.selectById(xid);</span><br><span class="line">  <span class="keyword">if</span> (oldFreeze != <span class="literal">null</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1.扣减可用余额</span></span><br><span class="line">  accountMapper.deduct(userId, money);</span><br><span class="line">  <span class="comment">// 2.记录冻结金额，事务状态</span></span><br><span class="line">  <span class="type">AccountFreeze</span> <span class="variable">freeze</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccountFreeze</span>();</span><br><span class="line">  freeze.setUserId(userId);</span><br><span class="line">  freeze.setFreezeMoney(money);</span><br><span class="line">  freeze.setState(AccountFreeze.State.TRY);</span><br><span class="line">  freeze.setXid(xid);</span><br><span class="line">  freezeMapper.insert(freeze);</span><br><span class="line">&gt;&#125;</span><br><span class="line"></span><br><span class="line">&gt;<span class="meta">@Override</span></span><br><span class="line">&gt;<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">confirm</span><span class="params">(BusinessActionContext ctx)</span> &#123;</span><br><span class="line">  <span class="comment">// 1.获取事务id</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> ctx.getXid();</span><br><span class="line">  <span class="comment">// 2.根据id  删除  冻结记录</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> freezeMapper.deleteById(xid);</span><br><span class="line">  <span class="keyword">return</span> count == <span class="number">1</span>;</span><br><span class="line">&gt;&#125;</span><br><span class="line"></span><br><span class="line">&gt;<span class="meta">@Override</span></span><br><span class="line">&gt;<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(BusinessActionContext ctx)</span> &#123;</span><br><span class="line">  <span class="comment">// 0.查询冻结记录</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> ctx.getXid();</span><br><span class="line">  <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> ctx.getActionContext(<span class="string">&quot;userId&quot;</span>).toString();</span><br><span class="line">  <span class="type">AccountFreeze</span> <span class="variable">freeze</span> <span class="operator">=</span> freezeMapper.selectById(xid);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//0.1.空回滚的判断，判断freeze是否为null,为nul1证明try没执行，需</span></span><br><span class="line">  <span class="keyword">if</span> (freeze == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">///证明try没执行，需要空回滚</span></span><br><span class="line">      freeze = <span class="keyword">new</span> <span class="title class_">AccountFreeze</span>();</span><br><span class="line">      freeze.setUserId(userId);</span><br><span class="line">      freeze.setFreezeMoney(<span class="number">0</span>);</span><br><span class="line">      freeze.setState(AccountFreeze.State.CANCEL);</span><br><span class="line">      freeze.setXid(xid);</span><br><span class="line">      freezeMapper.insert(freeze);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//0.2.幂等判断</span></span><br><span class="line">  <span class="keyword">if</span> (freeze.getState() == AccountFreeze.State.CANCEL)&#123;</span><br><span class="line">      <span class="comment">//等  就说明 已经处理过一次CANCEL了，无需重复处理</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1.恢复可用余额</span></span><br><span class="line">  accountMapper.refund(freeze.getUserId(), freeze.getFreezeMoney());</span><br><span class="line">  <span class="comment">// 2.将冻结金额清零，状态改为CANCEL</span></span><br><span class="line">  freeze.setFreezeMoney(<span class="number">0</span>);</span><br><span class="line">  freeze.setState(AccountFreeze.State.CANCEL);</span><br><span class="line">  <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> freezeMapper.updateById(freeze);</span><br><span class="line">  <span class="keyword">return</span> count == <span class="number">1</span>;</span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">@Autowired</span></span><br><span class="line">&gt;<span class="keyword">private</span> AccountTCCService accountService;</span><br></pre></td></tr></table></figure>
<p>==结果==</p>
<p><strong>正常</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172043786.png" alt="image-20230517204316601" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172125179.png" alt="image-20230517212543093" style="zoom:33%;">
<p><strong>异常</strong></p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172126591.png" alt="image-20230517212638484" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172127277.png" alt="image-20230517212711147" style="zoom:33%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172130445.png" alt="image-20230517213001358" style="zoom:25%;">
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172128080.png" alt="image-20230517212812984" style="zoom:33%;">
<p>==注意==</p>
<p>出现问题：</p>
<p><img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172121395.png" alt></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;io.seata.rm.datasource.exec.LockConflictException: get global lock fail, xid:192.168.10.33:8868:6350468222203850876, lockKeys:account_tbl:1;account_freeze_tbl:192.168.10.33:8868:6350468222203850876</span><br><span class="line">at io.seata.rm.datasource.ConnectionProxy.recognizeLockKeyConflictException(ConnectionProxy.java:159) ~[seata-all-1.4.2.jar:1.4.2]</span><br><span class="line">at io.seata.rm.datasource.ConnectionProxy.processGlobalTransactionCommit(ConnectionProxy.java:252) ~[seata-all-1.4.2.jar:1.4.2]</span><br><span class="line">at io.seata.rm.datasource.ConnectionProxy.doCommit(ConnectionProxy.java:230) ~[seata-all-1.4.2.jar:1.4.2]</span><br><span class="line">at io.seata.rm.datasource.ConnectionProxy.lambda$commit$0(ConnectionProxy.java:188) ~[seata-all-1.4.2.jar:1.4.2]</span><br><span class="line">at io.seata.rm.datasource.ConnectionProxy$LockRetryPolicy.execute(ConnectionProxy.java:333) ~[seata-all-1.4.2.jar:1.4.2]</span><br><span class="line">at io.seata.rm.datasource.ConnectionProxy.commit(ConnectionProxy.java:187) ~[seata-all-1.4.2.jar:1.4.2]</span><br></pre></td></tr></table></figure>
<p>==解决==</p>
<img src="https://gitee.com/Ryang1118/typora/raw/master/images/202305172124553.png" alt="image-20230517212440366" style="zoom:33%;">
</blockquote>
<h4 id="Saga（简说-无演示）">Saga（简说  无演示）</h4>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://rycan.top">Ryang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://rycan.top/post/96a41905.html">http://rycan.top/post/96a41905.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://rycan.top" target="_blank">RyCanの学习手记</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a></div><div class="post_share"><div class="social-share" data-image="/img/68.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><!--.post-reward--><!--  .reward-button--><!--    i.fas.fa-qrcode--><!--    = ' ' + _p('donate')--><!--  .reward-main--><!--    ul.reward-all--><!--      each item in theme.reward.QR_code--><!--        - var clickTo = item.link ? item.link : item.img--><!--        li.reward-item--><!--          a(href=url_for(clickTo) target='_blank')--><!--            img.post-qr-code-img(src=url_for(item.img) alt=item.text)--><!--          .post-qr-code-desc=item.text--><link rel="stylesheet" href="/" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">打赏</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/6f2612a2.html" title="SpringBoot"><img class="cover" src="/img/66.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SpringBoot</div></div></a></div><div class="next-post pull-right"><a href="/post/7d2eec83.html" title="SpringSecurity"><img class="cover" src="/img/71.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringSecurity</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/f313cf4f.html" title="springcloud核心代码思路篇"><img class="cover" src="/img/69.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-03</div><div class="title">springcloud核心代码思路篇</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Livere</span><span class="switch-btn"></span><span class="second-comment">Valine</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81ODY2MC8zNTEyMg=="></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">SpringCloud简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%AE%80%E5%8D%95%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.1.</span> <span class="toc-text">1、简单回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Maven%E4%B8%AD%E7%9A%84DependencyManagement%E5%92%8CDependencies"><span class="toc-number">1.1.1.</span> <span class="toc-text">Maven中的DependencyManagement和Dependencies</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#dependencyManagement"><span class="toc-number">1.1.1.0.0.1.</span> <span class="toc-text">dependencyManagement</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><span class="toc-number">1.2.</span> <span class="toc-text">2、准备阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E4%B8%80%EF%BC%9A%E7%94%9F%E4%BA%A7%E8%80%85-privoder-8001-%EF%BC%88%E6%80%BB%E7%BB%93-zyteacher-%E8%A7%86%E9%A2%91-8-10%EF%BC%89"><span class="toc-number">1.2.1.</span> <span class="toc-text">模块一：生产者[privoder - 8001]（总结   zyteacher 视频  8-10）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%90%E6%A8%A1%E5%9D%97%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="toc-number">1.2.1.0.1.</span> <span class="toc-text">子模块的创建过程：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E5%AD%90%E6%A8%A1%E5%9D%97%EF%BC%88Maven%E9%A1%B9%E7%9B%AE%EF%BC%89"><span class="toc-number">1.2.1.0.1.1.</span> <span class="toc-text">1、创建子模块（Maven项目）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%E3%80%81%E4%BF%AE%E6%94%B9POM%E7%B1%BB"><span class="toc-number">1.2.1.0.1.2.</span> <span class="toc-text">2、修改POM类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3%E3%80%81%E5%86%99yaml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.1.0.1.3.</span> <span class="toc-text">3、写yaml配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4%E3%80%81%E5%86%99%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.2.1.0.1.4.</span> <span class="toc-text">4、写启动类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5%E3%80%81%E7%BC%96%E5%86%99%E4%B8%9A%E5%8A%A1%E7%B1%BB%EF%BC%88CRUD%EF%BC%89"><span class="toc-number">1.2.1.0.1.5.</span> <span class="toc-text">5、编写业务类（CRUD）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#6%E3%80%81%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8Fpostman%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.1.0.1.6.</span> <span class="toc-text">6、运行程序postman测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%88%B6%E5%B7%A5%E7%A8%8B-Maven"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">父工程(Maven)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%90%E5%B7%A5%E7%A8%8B%EF%BC%88cloud-provider-payment8001%EF%BC%89"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">子工程（cloud-provider-payment8001）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%B9pom"><span class="toc-number">1.2.1.2.1.</span> <span class="toc-text">改pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#yml"><span class="toc-number">1.2.1.2.2.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8"><span class="toc-number">1.2.1.2.3.</span> <span class="toc-text">主启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB%E4%B9%A6%E5%86%99"><span class="toc-number">1.2.1.2.4.</span> <span class="toc-text">业务类书写</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%E3%80%81%E5%BB%BA%E8%A1%A8SQL"><span class="toc-number">1.2.1.2.4.1.</span> <span class="toc-text">1、建表SQL</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%E3%80%81%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">1.2.1.2.4.2.</span> <span class="toc-text">2、实体类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3%E3%80%81dao%E5%B1%82"><span class="toc-number">1.2.1.2.4.3.</span> <span class="toc-text">3、dao层</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4%E3%80%81Service%E5%B1%82"><span class="toc-number">1.2.1.2.4.4.</span> <span class="toc-text">4、Service层</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5%E3%80%81Controller%E5%B1%82"><span class="toc-number">1.2.1.2.4.5.</span> <span class="toc-text">5、Controller层</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%83%AD%E9%83%A8%E7%BD%B2%EF%BC%88%E6%88%91%E5%B0%B1%E4%B8%8D%E5%8A%A0%E4%BA%86-11-%EF%BC%89"><span class="toc-number">1.2.2.</span> <span class="toc-text">自动热部署（我就不加了 11 ）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%E3%80%81Adding-devtools-to-your-project"><span class="toc-number">1.2.2.0.0.1.</span> <span class="toc-text">1、Adding devtools to your project</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%E3%80%81Adding-plugin-to-your-pom-xml"><span class="toc-number">1.2.2.0.0.2.</span> <span class="toc-text">2、Adding plugin to your pom.xml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3%E3%80%81Enabling-automatic-build"><span class="toc-number">1.2.2.0.0.3.</span> <span class="toc-text">3、Enabling automatic build</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4%E3%80%81Update-the-value-of"><span class="toc-number">1.2.2.0.0.4.</span> <span class="toc-text">4、Update the value of</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5%E3%80%81%E9%87%8D%E5%90%AFIDEA"><span class="toc-number">1.2.2.0.0.5.</span> <span class="toc-text">5、重启IDEA</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E4%BA%8C%EF%BC%9A-%E6%B6%88%E8%B4%B9%E8%80%85-cloud-consumer-order80-%EF%BC%8812-13-%EF%BC%89"><span class="toc-number">1.2.3.</span> <span class="toc-text">模块二： 消费者[cloud-consumer-order80]（12-13 ）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">3、服务注册与发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Eureka"><span class="toc-number">1.3.1.</span> <span class="toc-text">1、Eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E4%B8%8E%E6%B3%A8%E5%86%8C"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">服务治理与注册</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86"><span class="toc-number">1.3.1.1.1.</span> <span class="toc-text">服务治理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.3.1.1.2.</span> <span class="toc-text">服务注册</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RPC%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%A1%86%E6%9E%B6"><span class="toc-number">1.3.1.1.3.</span> <span class="toc-text">RPC远程调用框架</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Eureka"><span class="toc-number">1.3.1.1.4.</span> <span class="toc-text">Eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Eureka-Server%EF%BC%9A"><span class="toc-number">1.3.1.1.4.1.</span> <span class="toc-text">Eureka Server：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Eureka-Client%EF%BC%9A"><span class="toc-number">1.3.1.1.4.2.</span> <span class="toc-text">Eureka Client：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E6%9C%BAEureka%E6%9E%84%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">单机Eureka构建步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%94%E6%AD%A5%E8%B5%B0%EF%BC%9A"><span class="toc-number">1.3.1.2.1.</span> <span class="toc-text">五步走：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9A%8F%E5%90%8E%E4%BF%AE%E6%94%B9%EF%BC%9A"><span class="toc-number">1.3.1.2.2.</span> <span class="toc-text">随后修改：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E5%BE%AE%E6%9C%8D%E5%8A%A18001%E6%B3%A8%E5%86%8C%E8%BF%9BEurekaServer"><span class="toc-number">1.3.1.2.2.1.</span> <span class="toc-text">生产者微服务8001注册进EurekaServer</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E5%BE%AE%E6%9C%8D%E5%8A%A180%E6%B3%A8%E5%86%8C%E8%BF%9BEurekaServer"><span class="toc-number">1.3.1.2.2.2.</span> <span class="toc-text">消费者微服务80注册进EurekaServer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Eureka%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">Eureka集群原理说明</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Eureka%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86%EF%BC%9A%E4%BA%92%E7%9B%B8%E6%B3%A8%E5%86%8C%EF%BC%8C%E7%9B%B8%E4%BA%92%E5%AE%88%E6%9C%9B"><span class="toc-number">1.3.1.3.1.</span> <span class="toc-text">Eureka集群原理：互相注册，相互守望</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EurekaServer%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%9E%84%E5%BB%BA"><span class="toc-number">1.3.1.3.2.</span> <span class="toc-text">EurekaServer集群环境构建</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AAcloud-eureka-server7002%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.1.3.2.1.</span> <span class="toc-text">新建一个cloud-eureka-server7002模块</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-cloud-provider-payment8002-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4%E6%9E%84%E5%BB%BA"><span class="toc-number">1.3.1.3.2.2.</span> <span class="toc-text">生产者(cloud-provider-payment8002)微服务集群构建</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Actuator-%E7%9A%84%E4%BF%A1%E6%81%AF%E5%AE%8C%E5%96%84%E9%85%8D%E7%BD%AE%EF%BC%9A"><span class="toc-number">1.3.1.3.2.3.</span> <span class="toc-text">Actuator:的信息完善配置：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Discovery"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">服务发现Discovery</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#eureka%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">eureka自我保护</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.3.1.5.1.</span> <span class="toc-text">###自我保护</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CAP"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">CAP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E7%A6%81%E6%AD%A2%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.3.1.7.</span> <span class="toc-text">怎么禁止自我保护</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%95%B4%E5%90%88Zookeeper"><span class="toc-number">1.3.2.</span> <span class="toc-text">2、整合Zookeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83Zookeeper"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">注册中心Zookeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#cloud-provider-payment8004%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.2.1.1.</span> <span class="toc-text">cloud-provider-payment8004微服务模块</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9A"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">可能遇到的问题：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3jar%E5%8C%85%E5%86%B2%E7%AA%81"><span class="toc-number">1.3.2.2.1.</span> <span class="toc-text">解决jar包冲突</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SLF4J%E5%A4%9A%E6%AC%A1%E7%BB%91%E5%AE%9A"><span class="toc-number">1.3.2.2.2.</span> <span class="toc-text">SLF4J多次绑定</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85cloud-consumerzk-order80"><span class="toc-number">1.3.2.2.3.</span> <span class="toc-text">服务消费者cloud-consumerzk-order80</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%95%B4%E5%90%88-Consul"><span class="toc-number">1.3.3.</span> <span class="toc-text">3、整合 Consul</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Consul%E7%AE%80%E4%BB%8B"><span class="toc-number">1.3.3.0.1.</span> <span class="toc-text">Consul简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B9%B6%E8%BF%90%E8%A1%8CConsul"><span class="toc-number">1.3.3.0.2.</span> <span class="toc-text">安装并运行Consul</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%EF%BC%9Aconsul-cloud-providerconsul-payment8006"><span class="toc-number">1.3.3.0.3.</span> <span class="toc-text">生产者服务注册：consul(cloud-providerconsul-payment8006)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8Ccloud-consumerconsul-order80"><span class="toc-number">1.3.3.0.4.</span> <span class="toc-text">消费者服务注册cloud-consumerconsul-order80</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E4%B8%AA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%AF%94%E8%BE%83"><span class="toc-number">1.3.4.</span> <span class="toc-text">三个注册中心比较</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CAP%E7%90%86%E8%AE%BA"><span class="toc-number">1.3.4.0.1.</span> <span class="toc-text">CAP理论</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#AP%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.4.0.1.1.</span> <span class="toc-text">AP架构</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#CP%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.4.0.1.2.</span> <span class="toc-text">CP架构</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%A4%E5%8F%A5%E8%AF%9D%EF%BC%9A"><span class="toc-number">1.3.4.0.2.</span> <span class="toc-text">两句话：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#web%E7%95%8C%E9%9D%A2"><span class="toc-number">1.3.4.0.3.</span> <span class="toc-text">web界面</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-number">1.4.</span> <span class="toc-text">4、服务调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Ribbon%E6%A6%82%E8%BF%B0"><span class="toc-number">1.4.1.</span> <span class="toc-text">1、Ribbon概述</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-LB"><span class="toc-number">1.4.1.0.1.</span> <span class="toc-text">1.1负载均衡(LB)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-2-%E9%9B%86%E4%B8%AD%E5%BC%8F-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.4.1.0.2.</span> <span class="toc-text">1.1.2 集中式 负载均衡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-3-%E8%BF%9B%E7%A8%8B%E5%86%85-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.4.1.0.3.</span> <span class="toc-text">1.1.3 进程内 负载均衡</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">架构说明</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Ribbon%E5%9C%A8%E5%B7%A5%E4%BD%9C-%E5%88%86%E6%88%90%E4%B8%A4%E6%AD%A5"><span class="toc-number">1.4.1.1.0.1.</span> <span class="toc-text">Ribbon在工作 分成两步</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%B2%A1%E6%9C%89%E5%BC%95%E5%85%A5Ribbon%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%AE%8C%E6%88%90%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%9F"><span class="toc-number">1.4.1.1.0.2.</span> <span class="toc-text">为什么没有引入Ribbon也可以完成负载均衡？</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%8D%E8%AF%B4RestTemplate%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.4.1.1.1.</span> <span class="toc-text">再说RestTemplate的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#getForObject%E6%96%B9%E6%B3%95-getForEntity%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.1.1.1.1.</span> <span class="toc-text">getForObject方法&#x2F;getForEntity方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ribbon%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%EF%BC%9AIRule%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">Ribbon核心组件：IRule接口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#IRule%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%90%84%E5%AE%9E%E7%8E%B0%E7%B1%BB%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%AF%B9%E5%BA%94%E5%8A%9F%E8%83%BD"><span class="toc-number">1.4.1.2.1.</span> <span class="toc-text">IRule接口的各实现类，以及对应功能</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9B%BF%E6%8D%A2%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">如何替换负载均衡算法</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.4.1.3.0.1.</span> <span class="toc-text">实例</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">1.4.2.</span> <span class="toc-text">2、负载均衡算法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.4.2.0.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">1.4.2.0.2.</span> <span class="toc-text">&#x3D;&#x3D;源码&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">1.4.2.0.3.</span> <span class="toc-text">手写一个负载均衡算法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81OpenFeign"><span class="toc-number">1.4.3.</span> <span class="toc-text">3、OpenFeign</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">基本介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81OpenFeign%E6%A6%82%E8%BF%B0"><span class="toc-number">1.4.3.1.1.</span> <span class="toc-text">1、OpenFeign概述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81Feign%E4%BD%9C%E7%94%A8"><span class="toc-number">1.4.3.1.2.</span> <span class="toc-text">2、Feign作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81Feign%E4%B8%8EOpenFeign%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.4.3.1.3.</span> <span class="toc-text">3、Feign与OpenFeign的区别</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenFeign%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">OpenFeign使用步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#cloud-consumer-openfeign-order80"><span class="toc-number">1.4.3.2.1.</span> <span class="toc-text">cloud-consumer-openfeign-order80</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenFeign%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">OpenFeign超时控制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E8%AE%BE%E7%BD%AE%EF%BC%8C%E6%95%85%E6%84%8F%E8%AE%BE%E7%BD%AE%E8%B6%85%E6%97%B6%E6%BC%94%E7%A4%BA%E5%87%BA%E9%94%99%E6%83%85%E5%86%B5"><span class="toc-number">1.4.3.3.1.</span> <span class="toc-text">超时设置，故意设置超时演示出错情况</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E6%8A%A5%E9%94%99"><span class="toc-number">1.4.3.3.2.</span> <span class="toc-text">超时报错</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-number">1.4.3.3.2.1.</span> <span class="toc-text">配置超时时间</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#OpenFeign%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97"><span class="toc-number">1.4.3.3.3.</span> <span class="toc-text">OpenFeign配置日志</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%E3%80%81%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-number">1.4.3.3.3.1.</span> <span class="toc-text">1、日志级别</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%E3%80%81%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97"><span class="toc-number">1.4.3.3.3.2.</span> <span class="toc-text">2、配置日志</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">1.5.</span> <span class="toc-text">5、服务降级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc-number">1.5.1.</span> <span class="toc-text">一、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.1.0.1.</span> <span class="toc-text">1、分布式系统面临的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-%E6%9C%8D%E5%8A%A1%E9%9B%AA%E5%B4%A9"><span class="toc-number">1.5.1.0.1.1.</span> <span class="toc-text">1.1 服务雪崩</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81Hystrix-%E6%98%AF%E4%BB%80%E4%B9%88-%E8%B1%AA%E7%8C%AA"><span class="toc-number">1.5.1.0.2.</span> <span class="toc-text">2、Hystrix 是什么(豪猪)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81Hystrix%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">1.5.1.0.3.</span> <span class="toc-text">3、Hystrix能做什么</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%E3%80%81Hystrix%E5%AE%98%E7%BD%91"><span class="toc-number">1.5.1.0.4.</span> <span class="toc-text">4、Hystrix官网</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Hystrix-%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="toc-number">1.5.2.</span> <span class="toc-text">二、Hystrix 重要概念</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%EF%BC%9Afallback"><span class="toc-number">1.5.2.0.1.</span> <span class="toc-text">1、服务降级：fallback</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%EF%BC%9Abreak"><span class="toc-number">1.5.2.0.2.</span> <span class="toc-text">2、服务熔断：break</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81%EF%BC%9Aflowlimit"><span class="toc-number">1.5.2.0.3.</span> <span class="toc-text">3、服务限流：flowlimit</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81Hystrix%E7%9A%84%E5%BC%95%E5%87%BA"><span class="toc-number">1.5.3.</span> <span class="toc-text">三、Hystrix的引出</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E8%80%85%E6%A8%A1%E5%9D%97%E7%AE%80%E5%8D%95%E8%AF%B4%E6%98%8E"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">提供者模块简单说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cloud-provider-hystrix-payment8001"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">cloud-provider-hystrix-payment8001</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#yml-2"><span class="toc-number">1.5.3.2.1.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.5.3.2.2.</span> <span class="toc-text">启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">1.5.3.2.3.</span> <span class="toc-text">&#x3D;&#x3D;业务类&#x3D;&#x3D;</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Service"><span class="toc-number">1.5.3.2.3.1.</span> <span class="toc-text">Service</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Controller"><span class="toc-number">1.5.3.2.3.2.</span> <span class="toc-text">Controller</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.3.2.4.</span> <span class="toc-text">正常测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E5%8E%8B%E6%B5%8B"><span class="toc-number">1.5.3.2.5.</span> <span class="toc-text">高并发压测</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9D%97-cloud-consumer-feign-hystrix-order80"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">消费者模块(cloud-consumer-feign-hystrix-order80)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#yml-3"><span class="toc-number">1.5.3.3.1.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8-2"><span class="toc-number">1.5.3.3.2.</span> <span class="toc-text">主启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB-2"><span class="toc-number">1.5.3.3.3.</span> <span class="toc-text">业务类</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#PaymentHystrixService"><span class="toc-number">1.5.3.3.3.1.</span> <span class="toc-text">PaymentHystrixService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#OrderHystirxController"><span class="toc-number">1.5.3.3.3.2.</span> <span class="toc-text">OrderHystirxController</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E6%B5%8B%E8%AF%95-2"><span class="toc-number">1.5.3.3.4.</span> <span class="toc-text">正常测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.3.3.5.</span> <span class="toc-text">高并发测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hystrix%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">1.5.3.4.</span> <span class="toc-text">Hystrix如何解决问题？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">1.5.4.</span> <span class="toc-text">四、服务降级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%EF%BC%9A8001%E7%94%9F%E4%BA%A7%E8%80%85%E6%9C%8D%E5%8A%A1%E7%AB%AF-%EF%BC%88cloud-provider-hystrix-payment8001%EF%BC%89"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">服务降级：8001生产者服务端 （cloud-provider-hystrix-payment8001）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB-Service-%E6%96%B9%E6%B3%95%E4%B8%8A%E6%B7%BB%E5%8A%A0-HystrixCommand"><span class="toc-number">1.5.4.1.1.</span> <span class="toc-text">业务类(Service)方法上添加**@HystrixCommand**</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB%E6%BF%80%E6%B4%BB"><span class="toc-number">1.5.4.1.2.</span> <span class="toc-text">主启动类激活</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.4.1.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%EF%BC%9A80%E6%B6%88%E8%B4%B9%E8%80%85%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%88cloud-consumer-feign-hystrix-order80%EF%BC%89"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">服务降级：80消费者服务端（cloud-consumer-feign-hystrix-order80）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9yaml"><span class="toc-number">1.5.4.2.0.1.</span> <span class="toc-text">修改yaml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB%EF%BC%9A-EnableHystrix-%E5%BC%80%E5%90%AFHystrix%E6%94%AF%E6%8C%81"><span class="toc-number">1.5.4.2.0.2.</span> <span class="toc-text">主启动类：@EnableHystrix    开启Hystrix支持</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB%E2%80%94%E2%80%94Controller"><span class="toc-number">1.5.4.2.0.3.</span> <span class="toc-text">业务类——Controller</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="toc-number">1.5.4.2.0.4.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%9A%84-%E8%BF%9B%E4%B8%80%E6%AD%A5%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">代码的 进一步优化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E5%89%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98%E2%80%94%E2%80%94%E4%BB%A3%E7%A0%81%E8%87%83%E8%82%BF%E3%80%81%E8%80%A6%E5%90%88%E5%BA%A6%E9%AB%98"><span class="toc-number">1.5.4.3.1.</span> <span class="toc-text">目前存在的问题——代码臃肿、耦合度高</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E4%BB%A3%E7%A0%81%E8%87%83%E8%82%BF"><span class="toc-number">1.5.4.3.1.1.</span> <span class="toc-text">解决代码臃肿</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%99%8D%E4%BD%8E%E4%BB%A3%E7%A0%81%E8%80%A6%E5%90%88%E5%BA%A6-%E6%B7%B7%E4%B9%B1%E7%A8%8B%E5%BA%A6"><span class="toc-number">1.5.4.3.1.2.</span> <span class="toc-text">降低代码耦合度(混乱程度)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%A3%E8%80%A6%E6%A1%88%E4%BE%8B%E2%80%94%E2%80%94%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%EF%BC%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%8C%E9%81%87%E5%88%B0%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%95%E6%9C%BA%E6%88%96%E5%85%B3%E9%97%AD%E7%AD%89%E6%9E%81%E7%AB%AF%E6%83%85%E5%86%B5"><span class="toc-number">1.5.4.3.1.3.</span> <span class="toc-text">解耦案例——服务降级：客户端调用服务端，遇到服务端宕机或关闭等极端情况</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">1.5.4.3.2.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9cloud-consumer-feign-hystrix-order80"><span class="toc-number">1.5.4.3.2.1.</span> <span class="toc-text">修改cloud-consumer-feign-hystrix-order80</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-3"><span class="toc-number">1.5.4.3.2.2.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">1.5.5.</span> <span class="toc-text">五、服务熔断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">1、熔断机制概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81Hystrix%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E6%A1%88%E4%BE%8B"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">2、Hystrix服务熔断案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AF%B98001%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84Service%E5%B1%82%E8%BF%9B%E8%A1%8C%E6%94%B9%E9%80%A0-%E5%A2%9E%E5%8A%A0%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6"><span class="toc-number">1.5.5.2.0.1.</span> <span class="toc-text">对8001服务端的Service层进行改造 增加熔断机制</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%A8%A1%E5%9D%97cloud-provider-hystrix-payment8001%E7%9A%84controller%E5%B1%82"><span class="toc-number">1.5.5.2.0.2.</span> <span class="toc-text">修改模块cloud-provider-hystrix-payment8001的controller层</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-4"><span class="toc-number">1.5.5.2.1.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E8%B7%9F%E9%94%99%E8%AF%AF%E6%83%85%E5%86%B5%E8%87%AA%E6%B5%8B"><span class="toc-number">1.5.5.2.1.1.</span> <span class="toc-text">正确跟错误情况自测</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6"><span class="toc-number">1.5.5.2.1.2.</span> <span class="toc-text">测试熔断机制</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Hystrix%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.5.2.2.</span> <span class="toc-text">Hystrix服务熔断总结</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.5.5.2.2.1.</span> <span class="toc-text">熔断类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E5%9C%A8%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E5%BC%80%E5%A7%8B%E8%B5%B7%E4%BD%9C%E7%94%A8"><span class="toc-number">1.5.5.2.2.2.</span> <span class="toc-text">断路器在什么情况下开始起作用</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E5%BC%80%E5%90%AF%E6%88%96%E5%85%B3%E9%97%AD%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.5.5.2.2.3.</span> <span class="toc-text">断路器开启或关闭条件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E6%89%93%E5%BC%80%E4%B9%8B%E5%90%8E"><span class="toc-number">1.5.5.2.2.4.</span> <span class="toc-text">断路器打开之后</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#hystrix%E6%89%80%E6%9C%89%E7%9A%84%E9%85%8D%E7%BD%AE-%E6%8B%93%E5%B1%95"><span class="toc-number">1.5.5.2.2.5.</span> <span class="toc-text">hystrix所有的配置&lt;拓展&gt;</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81"><span class="toc-number">1.5.6.</span> <span class="toc-text">六、服务限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E3%80%81Hystrix%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.5.7.</span> <span class="toc-text">七、Hystrix工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.5.7.0.1.</span> <span class="toc-text">工作流程图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E8%AF%B4%E6%98%8E"><span class="toc-number">1.5.7.0.2.</span> <span class="toc-text">步骤说明</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7-HystrixDashBoard"><span class="toc-number">1.5.8.</span> <span class="toc-text">八、服务监控 HystrixDashBoard</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAcloud-consumer-hystrix-dashboard9001"><span class="toc-number">1.5.8.1.</span> <span class="toc-text">新建cloud-consumer-hystrix-dashboard9001</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%80%E6%9C%89provider%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%88%E7%94%9F%E4%BA%A7%E8%80%85%EF%BC%89%E6%8F%90%E4%BE%9B%E7%B1%BB8001-8002-8003%E9%83%BD%E9%9C%80%E8%A6%81%E7%9B%91%E6%8E%A7%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.8.2.</span> <span class="toc-text">所有provider微服务（生产者）提供类8001&#x2F;8002&#x2F;8003都需要监控依赖配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.8.3.</span> <span class="toc-text">启动测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E6%BC%94%E7%A4%BA-%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7hystrixDashboard"><span class="toc-number">1.5.8.4.</span> <span class="toc-text">断路器演示(服务监控hystrixDashboard)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.5.8.4.1.</span> <span class="toc-text">注意事项</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-5"><span class="toc-number">1.5.8.4.2.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E9%A1%B5%E7%9A%84%E5%90%84%E4%B8%AA%E5%9C%B0%E6%96%B9%E8%A1%A8%E7%A4%BA%E4%BB%80%E4%B9%88%E6%84%8F%E6%80%9D%EF%BC%9F"><span class="toc-number">1.5.8.4.3.</span> <span class="toc-text">监控页的各个地方表示什么意思？</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81API%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.6.</span> <span class="toc-text">6、API网关服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81Gateway%E6%A6%82%E8%BF%B0"><span class="toc-number">1.6.1.</span> <span class="toc-text">一、Gateway概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81Gateway%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">1、Gateway是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.6.1.1.1.</span> <span class="toc-text">1.1 概述</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81-%E8%83%BD%E5%B9%B2%E5%98%9B"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">2、 能干嘛</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E4%B8%AD%E7%BD%91%E5%85%B3%E5%9C%A8%E5%93%AA%E9%87%8C"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">3、微服务架构中网关在哪里</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9gateway%EF%BC%9F"><span class="toc-number">1.6.1.4.</span> <span class="toc-text">4、为什么选择gateway？</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-SpringCloud-Gateway%E5%85%B7%E6%9C%89%E5%A6%82%E4%B8%8B%E7%89%B9%E6%80%A7"><span class="toc-number">1.6.1.4.1.</span> <span class="toc-text">4.1 SpringCloud Gateway具有如下特性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-SpringCloud-Gateway-%E4%B8%8E-Zuul%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.6.1.4.2.</span> <span class="toc-text">4.2 SpringCloud Gateway 与 Zuul的区别</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81Zuul1-x%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.6.1.5.</span> <span class="toc-text">5、Zuul1.x模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81gateway%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.6.1.6.</span> <span class="toc-text">6、gateway模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Gateway%E7%9A%84%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.6.2.</span> <span class="toc-text">二、Gateway的三大核心概念与工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81Route-%E8%B7%AF%E7%94%B1"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">1、Route(路由)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81Predicate-%E6%96%AD%E8%A8%80"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">2、Predicate(断言)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81Filter-%E8%BF%87%E6%BB%A4"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">3、Filter(过滤)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">1.6.2.4.</span> <span class="toc-text">4、总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.3.</span> <span class="toc-text">三、工作流程&#x2F;原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%B7%AF%E7%94%B1%E5%BC%95%E5%87%BA"><span class="toc-number">1.6.4.</span> <span class="toc-text">四、路由引出</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#cloud-gateway-gateway-9527"><span class="toc-number">1.6.4.0.1.</span> <span class="toc-text">cloud-gateway-gateway-9527</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E8%B7%AF%E7%94%B1%E8%BF%9B%E9%98%B6"><span class="toc-number">1.6.5.</span> <span class="toc-text">五、路由进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%90%8D%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">通过微服务名实现动态路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E7%9B%AE%E5%89%8D%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.6.5.2.</span> <span class="toc-text">5.1  目前面临的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E4%BF%AE%E6%94%B99527%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">1.6.5.3.</span> <span class="toc-text">5.2 修改9527实现动态路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.5.4.</span> <span class="toc-text">5.3 测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81Predicate-%E6%96%AD%E8%A8%80%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.6.6.</span> <span class="toc-text">六、Predicate 断言的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E5%B8%B8%E7%94%A8%E7%9A%84Predicate-%E6%96%AD%E8%A8%80"><span class="toc-number">1.6.6.1.</span> <span class="toc-text">1、常用的Predicate 断言</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-After-Route-Predicate%EF%BC%9A"><span class="toc-number">1.6.6.1.1.</span> <span class="toc-text">1. After Route Predicate：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Before-Route-Predicate%EF%BC%9A"><span class="toc-number">1.6.6.1.2.</span> <span class="toc-text">2.Before Route Predicate：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-Between-Route-Predicate%EF%BC%9A"><span class="toc-number">1.6.6.1.3.</span> <span class="toc-text">3.Between Route Predicate：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-Cookie-Route-Predicate%EF%BC%9A"><span class="toc-number">1.6.6.1.4.</span> <span class="toc-text">4.Cookie Route Predicate：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A9%E7%94%A8curl%E5%91%BD%E4%BB%A4%E5%8F%91%E9%80%81POST-GET%E8%AF%B7%E6%B1%82"><span class="toc-number">1.6.6.1.4.1.</span> <span class="toc-text">利用curl命令发送POST&#x2F;GET请求</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-Header-Route-Predicate%EF%BC%9A"><span class="toc-number">1.6.6.1.5.</span> <span class="toc-text">5.Header Route Predicate：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-Host-Route-Predicate%EF%BC%9A"><span class="toc-number">1.6.6.1.6.</span> <span class="toc-text">6.Host Route Predicate：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-Method-Route-Predicate%EF%BC%9A"><span class="toc-number">1.6.6.1.7.</span> <span class="toc-text">7.Method Route Predicate：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-Path-Route-Predicate%EF%BC%9A"><span class="toc-number">1.6.6.1.8.</span> <span class="toc-text">8.Path Route Predicate：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-Query-Route-Predicate%EF%BC%9A"><span class="toc-number">1.6.6.1.9.</span> <span class="toc-text">9.Query Route Predicate：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="toc-number">1.6.6.2.</span> <span class="toc-text">小总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E3%80%81Filter%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.6.7.</span> <span class="toc-text">七、Filter的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81Filter%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.6.7.1.</span> <span class="toc-text">1、Filter是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%88GlobalFilter%EF%BC%89"><span class="toc-number">1.6.7.2.</span> <span class="toc-text">2、自定义全局过滤器（GlobalFilter）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#img-src-https-cdn-nlark-com-yuque-0-2021-png-22423156-1632836682678-87279565-c12e-4961-8a8d-4a12df80e78a-png-alt-img-style-zoom-33-img-src-https-gitee-com-Ryang1118-typora-raw-master-images-202304292247761-png-alt-img-style-zoom-50"><span class="toc-number">1.6.7.2.1.</span> <span class="toc-text"></span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.</span> <span class="toc-text">7、服务配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0-2"><span class="toc-number">1.7.1.</span> <span class="toc-text">一、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E9%9D%A2%E4%B8%B4%E7%9A%84%E2%80%94%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">1.1  分布式系统面临的—配置问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Config%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">1.2 Config是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E6%80%8E%E4%B9%88%E7%94%A8"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">1.3 怎么用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-%E8%83%BD%E5%B9%B2%E5%98%9B"><span class="toc-number">1.7.1.4.</span> <span class="toc-text">1.4 能干嘛</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81-Config%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.2.</span> <span class="toc-text">二、 Config服务端配置与测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E7%94%A8%E4%BD%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E8%B4%A6%E5%8F%B7%E5%9C%A8GitHub%E4%B8%8A%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%90%8D%E4%B8%BAspringcloud-config%E7%9A%84%E6%96%B0Repository"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">2.1 用你自己的账号在GitHub上新建一个名为springcloud-config的新Repository</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E7%94%B1%E4%B8%8A%E4%B8%80%E6%AD%A5%E8%8E%B7%E5%BE%97%E5%88%9A%E6%96%B0%E5%BB%BA%E7%9A%84git%E5%9C%B0%E5%9D%80"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">2.2 由上一步获得刚新建的git地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%9C%AC%E5%9C%B0%E7%A1%AC%E7%9B%98%E7%9B%AE%E5%BD%95%E4%B8%8A%E6%96%B0%E5%BB%BAgit%E4%BB%93%E5%BA%93%E5%B9%B6clone"><span class="toc-number">1.7.2.3.</span> <span class="toc-text">2.3 本地硬盘目录上新建git仓库并clone</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%96%B0%E5%BB%BAModule%E6%A8%A1%E5%9D%97-cloud-config-center-3344"><span class="toc-number">1.7.2.4.</span> <span class="toc-text">2.4 新建Module模块 cloud-config-center-3344</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-pom"><span class="toc-number">1.7.2.5.</span> <span class="toc-text">2.5 pom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-yml"><span class="toc-number">1.7.2.6.</span> <span class="toc-text">2.6 yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.7.2.7.</span> <span class="toc-text">2.7 主启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.2.8.</span> <span class="toc-text">2.8 测试</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-8-1-Https"><span class="toc-number">1.7.2.8.0.1.</span> <span class="toc-text">2.8.1 Https</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-8-2-SSH"><span class="toc-number">1.7.2.8.0.2.</span> <span class="toc-text">2.8.2 SSH</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-8-3-%E6%98%A0%E5%B0%84%E8%A7%84%E5%88%99"><span class="toc-number">1.7.2.8.0.3.</span> <span class="toc-text">2.8.3 映射规则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-%E9%85%8D%E7%BD%AE%E7%9A%84%E8%AF%BB%E5%8F%96%E8%A7%84%E5%88%99"><span class="toc-number">1.7.2.9.</span> <span class="toc-text">2.9 配置的读取规则</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-9-1-label-application-profile-yml"><span class="toc-number">1.7.2.9.1.</span> <span class="toc-text">2.9.1  &#x2F;{label}&#x2F;{application}-{profile}.yml</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96main-master-%E5%88%86%E6%94%AF"><span class="toc-number">1.7.2.9.1.1.</span> <span class="toc-text">读取main(master)分支</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96dev%E5%88%86%E6%94%AF"><span class="toc-number">1.7.2.9.1.2.</span> <span class="toc-text">读取dev分支</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-9-2-application-profile-yml"><span class="toc-number">1.7.2.9.2.</span> <span class="toc-text">2.9.2  &#x2F;{application}-{profile}.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-9-3-application-profile-label"><span class="toc-number">1.7.2.9.3.</span> <span class="toc-text">2.9.3  &#x2F;{application}&#x2F;{profile}[&#x2F;{label}]</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-10-%E6%80%BB%E7%BB%93"><span class="toc-number">1.7.2.10.</span> <span class="toc-text">2.10 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81Config%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.3.</span> <span class="toc-text">三、Config客户端配置与测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-%E6%96%B0%E5%BB%BAcloud-config-client-3355"><span class="toc-number">1.7.3.0.1.</span> <span class="toc-text">3.1 新建cloud-config-client-3355</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-pom"><span class="toc-number">1.7.3.0.2.</span> <span class="toc-text">3.2 pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-bootstrap-yml"><span class="toc-number">1.7.3.0.3.</span> <span class="toc-text">3.3 bootstrap.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.7.3.0.4.</span> <span class="toc-text">3.4 主启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">1.7.3.0.5.</span> <span class="toc-text">3.5 业务类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.3.0.6.</span> <span class="toc-text">3.6 测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-7-%E9%97%AE%E9%A2%98%E9%9A%8F%E4%B9%8B%E8%80%8C%E6%9D%A5%E2%80%94%E2%80%94%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.3.0.7.</span> <span class="toc-text">3.7 问题随之而来——分布式配置的动态刷新问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Config%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B9%8B%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0"><span class="toc-number">1.7.4.</span> <span class="toc-text">四、Config客户端之动态刷新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-pom%E5%BC%95%E5%85%A5actuator%E7%9B%91%E6%8E%A7"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">4.1 pom引入actuator监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E4%BF%AE%E6%94%B9yml%EF%BC%8C%E6%9A%B4%E9%9C%B2%E7%9B%91%E6%8E%A7%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">4.2 修改yml，暴露监控端口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B1%BB%E4%B8%8A%E5%8A%A0%E4%B8%80%E4%B8%AA-RefreshScope%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">4.3 在业务类上加一个@RefreshScope注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E6%B5%8B%E8%AF%95%EF%BC%9A3355%E8%BF%98%E6%98%AF%E6%B2%A1%E6%9C%89%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0"><span class="toc-number">1.7.4.4.</span> <span class="toc-text">4.4 测试：3355还是没有动态刷新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-%E9%9C%80%E8%A6%81%E8%BF%90%E7%BB%B4%E4%BA%BA%E5%91%98%E5%8F%91%E9%80%81Post%E8%AF%B7%E6%B1%82%E5%88%B7%E6%96%B03355"><span class="toc-number">1.7.4.5.</span> <span class="toc-text">4.5 需要运维人员发送Post请求刷新3355</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-%E6%80%BB%E7%BA%BF%E5%BC%95%E5%85%A5"><span class="toc-number">1.7.4.6.</span> <span class="toc-text">4.6 总线引入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E6%9C%8D%E5%8A%A1%E6%80%BB%E7%BA%BF"><span class="toc-number">1.8.</span> <span class="toc-text">8、服务总线</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc-number">1.8.1.</span> <span class="toc-text">1、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">1.1 是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E8%83%BD%E5%B9%B2%E5%98%9B"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">1.2 能干嘛</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A2%AB%E7%A7%B0%E4%B8%BA%E6%80%BB%E7%BA%BF"><span class="toc-number">1.8.1.3.</span> <span class="toc-text">1.3 为什么被称为总线</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81RabbitMQ%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.8.2.</span> <span class="toc-text">2、RabbitMQ环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85Erlang"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">2.1 安装Erlang</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%AE%89%E8%A3%85RabbitMQ"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">2.2 安装RabbitMQ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81SpringCloud-Bus%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E5%85%A8%E5%B1%80%E5%B9%BF%E6%92%AD"><span class="toc-number">1.8.3.</span> <span class="toc-text">3、SpringCloud Bus动态刷新全局广播</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-Bus%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E5%85%A8%E5%B1%80%E5%B9%BF%E6%92%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3%E5%92%8C%E9%80%89%E5%9E%8B"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">3.1 Bus动态刷新全局广播的设计思想和选型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84cloud-config-client-3366"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">3.2 添加一个新的cloud-config-client-3366</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-pom"><span class="toc-number">1.8.3.2.1.</span> <span class="toc-text">3.2.1 pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-yml"><span class="toc-number">1.8.3.2.2.</span> <span class="toc-text">3.2.2 yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-3-%E4%B8%BB%E5%90%AF%E5%8A%A8"><span class="toc-number">1.8.3.2.3.</span> <span class="toc-text">3.2.3 主启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-4-%E4%B8%9A%E5%8A%A1%E7%B1%BBcontroller"><span class="toc-number">1.8.3.2.4.</span> <span class="toc-text">3.2.4 业务类controller</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">1.8.3.2.4.1.</span> <span class="toc-text">分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E9%85%8D%E7%BD%AE%E6%A1%88%E4%BE%8B"><span class="toc-number">1.8.3.3.</span> <span class="toc-text">3.3 配置案例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-%E7%BB%99cloud-config-center-3344%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B7%BB%E5%8A%A0%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF%E6%94%AF%E6%8C%81"><span class="toc-number">1.8.3.3.1.</span> <span class="toc-text">3.3.1 给cloud-config-center-3344配置中心服务端添加消息总线支持</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-%E7%BB%99cloud-config-client-3355%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B7%BB%E5%8A%A0%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF%E6%94%AF%E6%8C%81"><span class="toc-number">1.8.3.3.2.</span> <span class="toc-text">3.3.2 给cloud-config-client-3355客户端添加消息总线支持</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-3-%E7%BB%99cloud-config-client-3366%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B7%BB%E5%8A%A0%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF%E6%94%AF%E6%8C%81"><span class="toc-number">1.8.3.3.3.</span> <span class="toc-text">3.3.3 给cloud-config-client-3366客户端添加消息总线支持</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.8.3.4.</span> <span class="toc-text">3.4 测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.8.3.5.</span> <span class="toc-text">基本原理回顾</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81SpringCloud-Bus%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E5%AE%9A%E7%82%B9%E9%80%9A%E7%9F%A5"><span class="toc-number">1.8.4.</span> <span class="toc-text">4、SpringCloud Bus动态刷新定点通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E6%A1%88%E4%BE%8B"><span class="toc-number">1.8.4.1.</span> <span class="toc-text">4.1 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-number">1.8.5.</span> <span class="toc-text">5、流程总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81Stream%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.9.</span> <span class="toc-text">9、Stream消息驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81Stream%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8%E6%A6%82%E8%BF%B0"><span class="toc-number">1.9.1.</span> <span class="toc-text">一、Stream消息驱动概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BC%95%E5%85%A5cloud-stream%EF%BC%9F%E8%A7%A3%E5%86%B3%E7%9A%84%E7%97%9B%E7%82%B9%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">1.1 为什么引入cloud stream？解决的痛点是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">1.2 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFSpringCloudStream%EF%BC%9F"><span class="toc-number">1.9.1.2.1.</span> <span class="toc-text">什么是SpringCloudStream？</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%98%E7%BD%91"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">官网</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-number">1.9.1.4.</span> <span class="toc-text">1.3 设计思想</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-1-%E4%BC%A0%E7%BB%9F%E7%9A%84%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">1.9.1.4.1.</span> <span class="toc-text">1.3.1 传统的消息中间件的流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8Cloud-Stream"><span class="toc-number">1.9.1.4.2.</span> <span class="toc-text">1.3.2 为什么用Cloud Stream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-3-stream%E6%98%AF%E6%80%8E%E4%B9%88%E7%BB%9F%E4%B8%80%E5%BA%95%E5%B1%82%E5%B7%AE%E5%BC%82%E7%9A%84%EF%BC%9F"><span class="toc-number">1.9.1.4.3.</span> <span class="toc-text">1.3.3 stream是怎么统一底层差异的？</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-4-Binder"><span class="toc-number">1.9.1.4.4.</span> <span class="toc-text">1.3.4 Binder</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-Spring-Cloud-Stream%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B%E5%A5%97%E8%B7%AF"><span class="toc-number">1.9.1.5.</span> <span class="toc-text">1.4 Spring Cloud Stream标准流程套路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-%E7%BC%96%E7%A0%81API%E5%92%8C%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.9.1.6.</span> <span class="toc-text">1.5 编码API和常用注解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A1%88%E4%BE%8B"><span class="toc-number">1.9.2.</span> <span class="toc-text">二、案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-cloud-stream-rabbitmq-provider-consumer-8801-2-3"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">2.1 cloud-stream-rabbitmq-provider&#x2F;consumer 8801&#x2F;2&#x2F;3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8%E4%B9%8B%E7%94%9F%E4%BA%A7%E8%80%858801"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">2.2 消息驱动之生产者8801</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-%E6%96%B0%E5%BB%BAmodule"><span class="toc-number">1.9.2.2.1.</span> <span class="toc-text">2.2.1 新建module</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-pom"><span class="toc-number">1.9.2.2.2.</span> <span class="toc-text">2.2.2 pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-application-yml"><span class="toc-number">1.9.2.2.3.</span> <span class="toc-text">2.2.3 application.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-4-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.9.2.2.4.</span> <span class="toc-text">2.2.4 主启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">1.9.2.2.5.</span> <span class="toc-text">2.2.5 业务类</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.9.2.2.5.1.</span> <span class="toc-text">发送消息接口:</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">1.9.2.2.5.2.</span> <span class="toc-text">发送消息接口实现类:</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-6-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.2.2.5.3.</span> <span class="toc-text">2.2.6 测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8%E4%B9%8B%E6%B6%88%E8%B4%B9%E8%80%858802"><span class="toc-number">1.9.2.3.</span> <span class="toc-text">2.3 消息驱动之消费者8802</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-%E6%96%B0%E5%BB%BAcloud-stream-rabbitmq-consumer8802"><span class="toc-number">1.9.2.3.1.</span> <span class="toc-text">2.3.1 新建cloud-stream-rabbitmq-consumer8802</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-pom"><span class="toc-number">1.9.2.3.2.</span> <span class="toc-text">2.3.2 pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-application-yml"><span class="toc-number">1.9.2.3.3.</span> <span class="toc-text">2.3.3 application.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.9.2.3.4.</span> <span class="toc-text">2.3.4 主启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-5-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">1.9.2.3.5.</span> <span class="toc-text">2.3.5 业务类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-6-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.2.3.6.</span> <span class="toc-text">2.3.6 测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%EF%BC%9A%E5%88%86%E7%BB%84%E6%B6%88%E8%B4%B9%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.9.3.</span> <span class="toc-text">三、高级特性：分组消费与持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E4%BE%9D%E7%85%A78802%EF%BC%8Cclone%E5%87%BA%E4%B8%80%E4%BB%BDcloud-stream-rabbitmq-consumer8803"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">3.1 依照8802，clone出一份cloud-stream-rabbitmq-consumer8803</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-pom"><span class="toc-number">1.9.3.1.1.</span> <span class="toc-text">3.1.1 pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-2-application-yml"><span class="toc-number">1.9.3.1.2.</span> <span class="toc-text">3.1.2 application.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-3-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.9.3.1.3.</span> <span class="toc-text">3.1.3 主启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-4-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">1.9.3.1.4.</span> <span class="toc-text">3.1.4 业务类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">3.2 启动测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E8%BF%90%E8%A1%8C%E5%90%8E%E7%9A%84%E9%97%AE%E9%A2%981%EF%BC%9A%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98"><span class="toc-number">1.9.3.3.</span> <span class="toc-text">3.3 运行后的问题1：重复消费问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%A7%A3%E5%86%B3%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98"><span class="toc-number">1.9.3.3.1.</span> <span class="toc-text">3.3.1 为什么要解决重复消费问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-%E8%A7%A3%E5%86%B3%EF%BC%9A%E6%B6%88%E6%81%AF%E5%88%86%E7%BB%84"><span class="toc-number">1.9.3.3.2.</span> <span class="toc-text">3.3.2 解决：消息分组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E7%BB%84"><span class="toc-number">1.9.3.3.3.</span> <span class="toc-text">3.3.3 自定义分组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-4-%E6%B6%88%E8%B4%B9%E7%BB%84"><span class="toc-number">1.9.3.3.4.</span> <span class="toc-text">3.3.4 消费组</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E8%BF%90%E8%A1%8C%E5%90%8E%E7%9A%84%E9%97%AE%E9%A2%982%EF%BC%9A%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96%E9%97%AE%E9%A2%98"><span class="toc-number">1.9.3.4.</span> <span class="toc-text">3.4 运行后的问题2：消息持久化问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81Sleuth-%E5%88%86%E5%B8%83%E5%BC%8F%E8%AF%B7%E6%B1%82%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA"><span class="toc-number">1.10.</span> <span class="toc-text">10、Sleuth 分布式请求链路跟踪</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0-3"><span class="toc-number">1.10.1.</span> <span class="toc-text">一、概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%90%AD%E5%BB%BA%E9%93%BE%E8%B7%AF%E7%9B%91%E6%8E%A7%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.10.2.</span> <span class="toc-text">二、搭建链路监控步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-zipkin"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">2.1 zipkin</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1-%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.10.2.1.1.</span> <span class="toc-text">2.1.1 下载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-%E8%BF%90%E8%A1%8Cjar-%E8%BF%90%E8%A1%8C%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">1.10.2.1.2.</span> <span class="toc-text">2.1.2 运行jar&amp;运行控制台</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-3-%E5%AE%8C%E6%95%B4%E7%9A%84%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF"><span class="toc-number">1.10.2.1.3.</span> <span class="toc-text">2.1.3 完整的调用链路</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85cloud-provider-payment8001"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">2.2 服务提供者cloud-provider-payment8001</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-pom"><span class="toc-number">1.10.2.2.1.</span> <span class="toc-text">2.2.1 pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-yml"><span class="toc-number">1.10.2.2.2.</span> <span class="toc-text">2.2.2 yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-%E4%B8%9A%E5%8A%A1%E7%B1%BBPaymentController"><span class="toc-number">1.10.2.2.3.</span> <span class="toc-text">2.2.3 业务类PaymentController</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85cloud-consumer-order80"><span class="toc-number">1.10.2.3.</span> <span class="toc-text">2.3 服务消费者cloud-consumer-order80</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-pom"><span class="toc-number">1.10.2.3.1.</span> <span class="toc-text">2.3.1 pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-yml"><span class="toc-number">1.10.2.3.2.</span> <span class="toc-text">2.3.2 yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-%E4%B8%9A%E5%8A%A1%E7%B1%BBOrderController"><span class="toc-number">1.10.2.3.3.</span> <span class="toc-text">2.3.3 业务类OrderController</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.10.2.4.</span> <span class="toc-text">2.4 测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">SpringCloud Alibaba</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">1、简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%87%BA%E7%8E%B0-SpringCloud-Alibaba"><span class="toc-number">2.1.0.1.</span> <span class="toc-text">1. 为什么出现 SpringCloud Alibaba</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-SpringCloud-Alibaba%E5%B8%A6%E6%9D%A5%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-number">2.1.0.2.</span> <span class="toc-text">2. SpringCloud Alibaba带来了什么</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-%E8%83%BD%E5%B9%B2%E4%BB%80%E4%B9%88"><span class="toc-number">2.1.0.2.1.</span> <span class="toc-text">2.1 能干什么</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-%E5%8E%BB%E5%93%AA%E9%87%8C%E4%B8%8B%E8%BD%BD"><span class="toc-number">2.1.0.2.2.</span> <span class="toc-text">2.2 去哪里下载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-%E6%9C%89%E4%BB%80%E4%B9%88%E7%BB%84%E4%BB%B6"><span class="toc-number">2.1.0.2.3.</span> <span class="toc-text">2.3  有什么组件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-number">2.1.0.2.4.</span> <span class="toc-text">3. 学习资料的获取</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81Nacos%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">2.2.</span> <span class="toc-text">2、Nacos服务注册和配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81-Nacos%E7%AE%80%E4%BB%8B"><span class="toc-number">2.2.1.</span> <span class="toc-text">一、 Nacos简介</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.1.0.1.</span> <span class="toc-text">1 是什么</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E8%83%BD%E5%B9%B2%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.1.0.2.</span> <span class="toc-text">2 能干什么</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80"><span class="toc-number">2.2.1.0.3.</span> <span class="toc-text">3 下载地址</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%90%84%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%AF%94%E8%BE%83"><span class="toc-number">2.2.1.0.4.</span> <span class="toc-text">4 各注册中心比较</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81-%E5%AE%89%E8%A3%85%E5%B9%B6%E8%BF%90%E8%A1%8CNacos"><span class="toc-number">2.2.2.</span> <span class="toc-text">二、 安装并运行Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">Linux集群搭建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81-Nacos%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%BC%94%E7%A4%BA"><span class="toc-number">2.2.3.</span> <span class="toc-text">三、 Nacos作为服务注册中心演示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9F%BA%E4%BA%8ENacos%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85-cloudalibaba-provider-payment9001"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">1 基于Nacos的服务提供者(cloudalibaba-provider-payment9001)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-%E5%BB%BAmoudle"><span class="toc-number">2.2.3.1.0.1.</span> <span class="toc-text">1.1 建moudle</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-pom"><span class="toc-number">2.2.3.1.0.2.</span> <span class="toc-text">1.2 pom</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-3-yml"><span class="toc-number">2.2.3.1.0.3.</span> <span class="toc-text">1.3 yml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-4-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">2.2.3.1.0.4.</span> <span class="toc-text">1.4 主启动类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-5-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">2.2.3.1.0.5.</span> <span class="toc-text">1.5 业务类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-6-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.3.1.0.6.</span> <span class="toc-text">1.6 测试</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-7-%E7%9B%B8%E5%90%8C%E9%85%8D%E7%BD%AE%E5%86%8D%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AAmodule-9002"><span class="toc-number">2.2.3.1.0.7.</span> <span class="toc-text">1.7 相同配置再新建一个module 9002</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%9F%BA%E4%BA%8ENacos%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%EF%BC%88cloudalibaba-consumer-nacos-order83%EF%BC%89"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">2 基于Nacos的服务消费者（cloudalibaba-consumer-nacos-order83）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-%E6%96%B0%E5%BB%BAmodule-cloudalibaba-consumer-nacos-order83"><span class="toc-number">2.2.3.2.0.1.</span> <span class="toc-text">2.1 新建module  cloudalibaba-consumer-nacos-order83</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-pom"><span class="toc-number">2.2.3.2.0.2.</span> <span class="toc-text">2.2 pom</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-yml"><span class="toc-number">2.2.3.2.0.3.</span> <span class="toc-text">2.3 yml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-4-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">2.2.3.2.0.4.</span> <span class="toc-text">2.4 主启动类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-5-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">2.2.3.2.0.5.</span> <span class="toc-text">2.5 业务类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-6-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.3.2.0.6.</span> <span class="toc-text">2.6 测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AF%B9%E6%AF%94"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">3. 服务注册中心对比</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-Nacos%E4%B8%8ECAP"><span class="toc-number">2.2.3.3.0.1.</span> <span class="toc-text">3.1 Nacos与CAP</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-2-CP%E4%B8%8EAP%E7%9A%84%E5%88%87%E6%8D%A2"><span class="toc-number">2.2.3.3.0.2.</span> <span class="toc-text">3.2 &#x3D;&#x3D;CP与AP的切换&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E9%80%89%E6%8B%A9%E4%BD%BF%E7%94%A8%E4%BD%95%E7%A7%8D%E6%A8%A1%E5%BC%8F%EF%BC%9F"><span class="toc-number">2.2.3.3.0.3.</span> <span class="toc-text">何时选择使用何种模式？</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E5%88%87%E6%8D%A2%EF%BC%9A"><span class="toc-number">2.2.3.3.0.4.</span> <span class="toc-text">怎么切换：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81-Nacos%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%BC%94%E7%A4%BA"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">4、 Nacos作为服务配置中心演示</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Nacos%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E2%80%94%E2%80%94%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.3.4.1.</span> <span class="toc-text">1.Nacos作为配置中心——基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-%E5%BB%BAmodule-cloudalibaba-config-nacos-client3377"><span class="toc-number">2.2.3.4.1.1.</span> <span class="toc-text">1.1 建module cloudalibaba-config-nacos-client3377</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-pom-2"><span class="toc-number">2.2.3.4.1.2.</span> <span class="toc-text">1.2 pom</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-3-yml-2"><span class="toc-number">2.2.3.4.1.3.</span> <span class="toc-text">1.3 yml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-4-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB-2"><span class="toc-number">2.2.3.4.1.4.</span> <span class="toc-text">1.4 主启动类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-5-%E4%B8%9A%E5%8A%A1%E7%B1%BB-2"><span class="toc-number">2.2.3.4.1.5.</span> <span class="toc-text">1.5 业务类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-6-%E5%9C%A8Nacos%E4%B8%AD%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">2.2.3.4.1.6.</span> <span class="toc-text">1.6 在Nacos中添加配置信息</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-7%E5%AE%9E%E6%93%8D"><span class="toc-number">2.2.3.4.1.7.</span> <span class="toc-text">1.7实操</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-8%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.3.4.1.8.</span> <span class="toc-text">1.8测试</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Nacos%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E2%80%94%E2%80%94%E5%88%86%E7%B1%BB%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.3.4.2.</span> <span class="toc-text">2. Nacos作为配置中心——分类配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-%E5%88%86%E5%B8%83%E5%BC%8F%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E5%A4%9A%E7%8E%AF%E5%A2%83%E5%A4%9A%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.3.4.2.1.</span> <span class="toc-text">2.1 分布式开发中的多环境多项目管理问题</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-Nacos%E7%9A%84%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2"><span class="toc-number">2.2.3.4.2.2.</span> <span class="toc-text">2.2 Nacos的图形化管理界面</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-Namespace-Group-Data-ID%E4%B8%89%E8%80%85%E5%85%B3%E7%B3%BB%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E4%B9%88%E8%AE%BE%E8%AE%A1%EF%BC%9F"><span class="toc-number">2.2.3.4.2.3.</span> <span class="toc-text">2.3 Namespace+Group+Data ID三者关系？为什么这么设计？</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E4%B8%89%E7%A7%8D%E6%96%B9%E6%A1%88%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.3.4.3.</span> <span class="toc-text">3. 三种方案加载配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-DataID%E6%96%B9%E6%A1%88"><span class="toc-number">2.2.3.4.3.1.</span> <span class="toc-text">3.1 DataID方案</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-2-Group%E6%96%B9%E6%A1%88"><span class="toc-number">2.2.3.4.3.2.</span> <span class="toc-text">3.2 Group方案</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-3-namesapce%E6%96%B9%E6%A1%88"><span class="toc-number">2.2.3.4.3.3.</span> <span class="toc-text">3.3 namesapce方案</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-4-%E6%80%BB%E7%BB%93"><span class="toc-number">2.2.3.4.3.4.</span> <span class="toc-text">3.4 总结</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-Nacos%E9%9B%86%E7%BE%A4%E5%92%8C%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="toc-number">2.2.3.4.4.</span> <span class="toc-text">4. Nacos集群和持久化配置（重点）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-1-%E5%AE%98%E7%BD%91%E8%AF%B4%E6%98%8E"><span class="toc-number">2.2.3.4.4.1.</span> <span class="toc-text">4.1 官网说明</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-Nacos%E5%B5%8C%E5%85%A5%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93derby%E5%88%87%E6%8D%A2%E5%88%B0mysql"><span class="toc-number">2.2.3.4.4.2.</span> <span class="toc-text">4.2 Nacos嵌入式数据库derby切换到mysql</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-Linux%E7%89%88Nacos-MySQL%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.3.4.4.3.</span> <span class="toc-text">4.3  Linux版Nacos+MySQL生产环境配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8Amysql%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.3.5.</span> <span class="toc-text">(1) Linux服务器上mysql数据库配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-application-properties-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.3.6.</span> <span class="toc-text">(2) application.properties 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8Anacos%E7%9A%84%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AEcluster-conf"><span class="toc-number">2.2.3.7.</span> <span class="toc-text">(3) Linux服务器上nacos的集群配置cluster.conf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E7%BC%96%E8%BE%91Nacos%E7%9A%84%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%ACstartup-sh%EF%BC%8C%E4%BD%BF%E5%AE%83%E8%83%BD%E5%A4%9F%E6%8E%A5%E5%8F%97%E4%B8%8D%E5%90%8C%E7%9A%84%E5%90%AF%E5%8A%A8%E7%AB%AF%E5%8F%A3"><span class="toc-number">2.2.3.8.</span> <span class="toc-text">(4) 编辑Nacos的启动脚本startup.sh，使它能够接受不同的启动端口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-Nginx%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E7%94%B1%E5%AE%83%E4%BD%9C%E4%B8%BA%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8"><span class="toc-number">2.2.3.9.</span> <span class="toc-text">(5) Nginx的配置，由它作为负载均衡器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.3.10.</span> <span class="toc-text">(6) 测试</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-4-%E5%BE%AE%E6%9C%8D%E5%8A%A1cloudalibaba-provider-payment9002%E5%90%AF%E5%8A%A8%E6%B3%A8%E5%86%8C%E8%BF%9Bnacos%E9%9B%86%E7%BE%A4"><span class="toc-number">2.2.3.10.0.1.</span> <span class="toc-text">4.4 微服务cloudalibaba-provider-payment9002启动注册进nacos集群</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-5-4-2-%E5%A4%84%E5%87%BA%E9%94%99-%E5%8F%AF%E8%83%BD%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-%EF%BC%88%E8%B8%A9%E5%9D%91%EF%BC%891-1-4%E7%89%88%E6%9C%ACnacos%E4%BD%BF%E7%94%A8%E5%A4%96%E9%83%A8%E6%95%B0%E6%8D%AE%E5%BA%93Mysql8"><span class="toc-number">2.2.3.10.0.2.</span> <span class="toc-text">4.5  &#x3D;&#x3D;4.2 处出错    可能的解决方案 （踩坑）1.1.4版本nacos使用外部数据库Mysql8&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9nacos%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.3.10.0.3.</span> <span class="toc-text">修改nacos源码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%95%AA%E5%A4%96-nacos-linux%E8%B8%A9%E5%9D%91%E5%BF%85%E7%9C%8B"><span class="toc-number">2.2.3.10.0.4.</span> <span class="toc-text">&#x3D;&#x3D;(番外)nacos linux踩坑必看&#x3D;&#x3D;</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81Sentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%90%E6%B5%81"><span class="toc-number">2.3.</span> <span class="toc-text">3、Sentinel实现熔断与限流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81Sentinel"><span class="toc-number">2.3.1.</span> <span class="toc-text">一、Sentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AE%89%E8%A3%85Sentinel%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">2.3.2.</span> <span class="toc-text">二、安装Sentinel控制台</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">安装步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BC%94%E7%A4%BA%E5%B7%A5%E7%A8%8B"><span class="toc-number">2.3.3.</span> <span class="toc-text">三、初始化演示工程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%90%AF%E5%8A%A8Nacos8848"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">3.1 启动Nacos8848</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%96%B0%E5%BB%BAModule-cloudalibaba-sentinel-service8401"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">3.2 新建Module cloudalibaba-sentinel-service8401</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-pom-2"><span class="toc-number">2.3.3.2.1.</span> <span class="toc-text">3.2.1 pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-yaml"><span class="toc-number">2.3.3.2.2.</span> <span class="toc-text">3.2.2 yaml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-3-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">2.3.3.2.3.</span> <span class="toc-text">3.2.3 主启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-4-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">2.3.3.2.4.</span> <span class="toc-text">3.2.4 业务类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">3.3 测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-number">2.3.4.</span> <span class="toc-text">四、流控规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.4.1.</span> <span class="toc-text">4.1 流控模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-1-%E7%9B%B4%E6%8E%A5%EF%BC%88%E9%BB%98%E8%AE%A4%EF%BC%89-%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5%EF%BC%88%E9%BB%98%E8%AE%A4%EF%BC%89"><span class="toc-number">2.3.4.1.1.</span> <span class="toc-text">4.1.1 直接（默认）+快速失败（默认）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-QPS%E7%9B%B4%E6%8E%A5%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="toc-number">2.3.4.1.1.1.</span> <span class="toc-text">(1) QPS直接快速失败</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-%E7%BA%BF%E7%A8%8B%E6%95%B0%E7%9B%B4%E6%8E%A5%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="toc-number">2.3.4.1.1.2.</span> <span class="toc-text">(2) 线程数直接快速失败</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-%E5%85%B3%E8%81%94"><span class="toc-number">2.3.4.1.2.</span> <span class="toc-text">4.1.2 关联</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.4.1.2.1.</span> <span class="toc-text">1. 配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.4.1.2.2.</span> <span class="toc-text">2. 测试</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-3-%E9%93%BE%E8%B7%AF"><span class="toc-number">2.3.4.1.3.</span> <span class="toc-text">4.1.3 链路</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-6"><span class="toc-number">2.3.4.2.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="toc-number">2.3.4.3.</span> <span class="toc-text">4.2 流控效果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-warm-up-%E9%A2%84%E7%83%AD"><span class="toc-number">2.3.4.3.1.</span> <span class="toc-text">4.2.1 warm up 预热</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-7"><span class="toc-number">2.3.4.3.2.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-number">2.3.4.3.3.</span> <span class="toc-text">4.2.2 排队等待</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-8"><span class="toc-number">2.3.4.3.4.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99%EF%BC%88%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99%EF%BC%89"><span class="toc-number">2.3.5.</span> <span class="toc-text">五、降级规则（熔断规则）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5"><span class="toc-number">2.3.5.0.1.</span> <span class="toc-text">5.1 降级策略</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-1-1-%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B%EF%BC%8CRT%EF%BC%88%E5%B9%B3%E5%9D%87%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%EF%BC%8C%E7%A7%92%E7%BA%A7%EF%BC%89"><span class="toc-number">2.3.5.0.1.1.</span> <span class="toc-text">5.1.1 慢调用比例，RT（平均响应时间，秒级）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.5.0.1.2.</span> <span class="toc-text">实战测试</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-1-2-%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="toc-number">2.3.5.0.1.3.</span> <span class="toc-text">5.1.2 异常比例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%B5%8B%E8%AF%95-2"><span class="toc-number">2.3.5.0.1.4.</span> <span class="toc-text">实战测试</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-1-3-%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-number">2.3.5.0.1.5.</span> <span class="toc-text">5.1.3 异常数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%B5%8B%E8%AF%95-3"><span class="toc-number">2.3.5.0.1.6.</span> <span class="toc-text">实战测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E7%83%AD%E7%82%B9key%E9%99%90%E6%B5%81"><span class="toc-number">2.3.6.</span> <span class="toc-text">六、热点key限流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.3.6.1.</span> <span class="toc-text">6.1 基本介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.3.6.2.</span> <span class="toc-text">6.2 基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-1-%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.6.2.1.</span> <span class="toc-text">6.2.1 测试方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-2-%E9%85%8D%E7%BD%AE%E7%83%AD%E7%82%B9key%E9%99%90%E6%B5%81%E8%A7%84%E5%88%99"><span class="toc-number">2.3.6.2.2.</span> <span class="toc-text">6.2.2 配置热点key限流规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-3-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.6.2.3.</span> <span class="toc-text">6.2.3 测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-%E5%8F%82%E6%95%B0%E4%BE%8B%E5%A4%96%E9%A1%B9"><span class="toc-number">2.3.6.3.</span> <span class="toc-text">6.3 参数例外项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-%E5%85%B6%E4%BB%96"><span class="toc-number">2.3.6.4.</span> <span class="toc-text">6.4 其他</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99%EF%BC%88%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81%EF%BC%89"><span class="toc-number">2.3.7.</span> <span class="toc-text">七、系统规则（系统自适应限流）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E2%80%94%E2%80%94%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80QPS"><span class="toc-number">2.3.7.1.</span> <span class="toc-text">案例——配置全局QPS</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB%E3%80%81-SentinelResource-%E6%B3%A8%E8%A7%A3%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.3.8.</span> <span class="toc-text">八、@SentinelResource 注解详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-%E6%8C%89%E8%B5%84%E6%BA%90%E5%90%8D%E7%A7%B0%E9%99%90%E6%B5%81-%E5%90%8E%E7%BB%AD%E5%A4%84%E7%90%86"><span class="toc-number">2.3.8.1.</span> <span class="toc-text">8.1 按资源名称限流+后续处理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-1-%E4%BF%AE%E6%94%B98401"><span class="toc-number">2.3.8.1.1.</span> <span class="toc-text">8.1.1 修改8401</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-pom"><span class="toc-number">2.3.8.1.1.1.</span> <span class="toc-text">(1) pom</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">2.3.8.1.1.2.</span> <span class="toc-text">(2) 业务类</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-2-%E9%85%8D%E7%BD%AE%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E2%80%94%E2%80%94%E6%8C%89%E8%B5%84%E6%BA%90%E5%90%8D%E7%A7%B0%E6%B7%BB%E5%8A%A0%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-number">2.3.8.1.2.</span> <span class="toc-text">8.1.2 配置流控规则——按资源名称添加流控规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-3-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.8.1.3.</span> <span class="toc-text">8.1.3 测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-4-%E9%97%AE%E9%A2%98"><span class="toc-number">2.3.8.1.4.</span> <span class="toc-text">8.1.4 问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-%E6%8C%89%E7%85%A7Url%E5%9C%B0%E5%9D%80%E9%99%90%E6%B5%81-%E5%90%8E%E7%BB%AD%E5%A4%84%E7%90%86"><span class="toc-number">2.3.8.2.</span> <span class="toc-text">8.2 按照Url地址限流+后续处理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-2-1-%E4%BF%AE%E6%94%B9controller"><span class="toc-number">2.3.8.2.1.</span> <span class="toc-text">8.2.1 修改controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-2-2-%E8%AE%BE%E7%BD%AE%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E5%8F%8A%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.8.2.2.</span> <span class="toc-text">8.2.2 设置流控规则及测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-%E6%80%BB%E7%BB%93%E4%BB%A5%E5%8F%8A%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.3.8.3.</span> <span class="toc-text">8.3 总结以及面临的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-%E5%AE%A2%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="toc-number">2.3.8.4.</span> <span class="toc-text">8.4 客户自定义限流处理逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-4-1-%E5%88%9B%E5%BB%BACustomerBlockHandler%E7%B1%BB%E7%94%A8%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="toc-number">2.3.8.4.1.</span> <span class="toc-text">8.4.1 创建CustomerBlockHandler类用于自定义限流处理逻辑</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-4-2-%E4%BF%AE%E6%94%B9RateLimitController%EF%BC%8C%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91%E7%B1%BB"><span class="toc-number">2.3.8.4.2.</span> <span class="toc-text">8.4.2 修改RateLimitController，使用自定义处理逻辑类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-4-3-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.8.4.3.</span> <span class="toc-text">8.4.3 测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-4-4-%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="toc-number">2.3.8.4.4.</span> <span class="toc-text">8.4.4 结构说明</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-5-%E6%9B%B4%E5%A4%9A%E5%B1%9E%E6%80%A7%E8%AF%B4%E6%98%8E"><span class="toc-number">2.3.8.5.</span> <span class="toc-text">8.5 更多属性说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">2.3.9.</span> <span class="toc-text">九、服务熔断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1-Ribbon%E7%B3%BB%E5%88%97"><span class="toc-number">2.3.9.1.</span> <span class="toc-text">9.1 Ribbon系列</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#9-1-1-%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85-cloudalibaba-provider-payment9003-9004"><span class="toc-number">2.3.9.1.1.</span> <span class="toc-text">9.1.1 服务提供者(cloudalibaba-provider-payment9003&#x2F;9004)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-pom-2"><span class="toc-number">2.3.9.1.1.1.</span> <span class="toc-text">(1) pom</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-yml"><span class="toc-number">2.3.9.1.1.2.</span> <span class="toc-text">(2) yml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">2.3.9.1.1.3.</span> <span class="toc-text">(3) 主启动类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">2.3.9.1.1.4.</span> <span class="toc-text">(4) 业务类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.9.1.1.5.</span> <span class="toc-text">(5) 测试</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-1-2-%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%8584-cloudalibaba-consumer-nacos-order84"><span class="toc-number">2.3.9.1.2.</span> <span class="toc-text">9.1.2 服务消费者84(cloudalibaba-consumer-nacos-order84)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-pom-3"><span class="toc-number">2.3.9.1.2.1.</span> <span class="toc-text">(1) pom</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-yml-2"><span class="toc-number">2.3.9.1.2.2.</span> <span class="toc-text">(2) yml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB-2"><span class="toc-number">2.3.9.1.2.3.</span> <span class="toc-text">(3) 主启动类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-%E4%B8%9A%E5%8A%A1%E7%B1%BB-2"><span class="toc-number">2.3.9.1.2.4.</span> <span class="toc-text">(4) 业务类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-%E6%B5%8B%E8%AF%95-2"><span class="toc-number">2.3.9.1.2.5.</span> <span class="toc-text">(5) 测试</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-1-3-fallback-%E5%92%8C-blockHandler"><span class="toc-number">2.3.9.1.3.</span> <span class="toc-text">9.1.3 fallback 和 blockHandler</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-1-4-%E5%B7%AE%E5%BC%82%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.9.1.4.</span> <span class="toc-text">9.1.4 差异化配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.9.1.4.1.</span> <span class="toc-text">(1) 没有任何配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-%E5%8F%AA%E9%85%8D%E7%BD%AEfallback"><span class="toc-number">2.3.9.1.4.2.</span> <span class="toc-text">(2) 只配置fallback</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-%E5%8F%AA%E9%85%8D%E7%BD%AEblockHandler"><span class="toc-number">2.3.9.1.4.3.</span> <span class="toc-text">(3) 只配置blockHandler</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-fallback%E5%92%8CblockHandler%E9%83%BD%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.9.1.4.4.</span> <span class="toc-text">(4) fallback和blockHandler都配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-%E5%BC%82%E5%B8%B8%E5%BF%BD%E7%95%A5%E5%B1%9E%E6%80%A7"><span class="toc-number">2.3.9.1.4.5.</span> <span class="toc-text">(5) 异常忽略属性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2-Feign%E7%B3%BB%E5%88%97"><span class="toc-number">2.3.9.2.</span> <span class="toc-text">9.2 Feign系列</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#9-2-1-%E4%BF%AE%E6%94%B984%E6%A8%A1%E5%9D%97"><span class="toc-number">2.3.9.2.1.</span> <span class="toc-text">9.2.1 修改84模块</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-pom-4"><span class="toc-number">2.3.9.2.1.1.</span> <span class="toc-text">(1) pom</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-yml-3"><span class="toc-number">2.3.9.2.1.2.</span> <span class="toc-text">(2) yml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">2.3.9.2.1.3.</span> <span class="toc-text">(3) 业务类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">2.3.9.2.1.4.</span> <span class="toc-text">(4) 主启动类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-%E6%B5%8B%E8%AF%95-3"><span class="toc-number">2.3.9.2.1.5.</span> <span class="toc-text">(5) 测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-3-%E7%86%94%E6%96%AD%E6%A1%86%E6%9E%B6%E6%AF%94%E8%BE%83"><span class="toc-number">2.3.9.3.</span> <span class="toc-text">9.3 熔断框架比较</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E6%8C%81%E4%B9%85%E5%8C%96%E8%A7%84%E5%88%99"><span class="toc-number">2.3.10.</span> <span class="toc-text">十、持久化规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E2%80%94-%E4%BF%AE%E6%94%B98401%E5%B7%B2%E5%AE%8C%E6%88%90%E6%8C%81%E4%B9%85%E5%8C%96%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.3.10.1.</span> <span class="toc-text">案例—    修改8401已完成持久化设置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-pom-5"><span class="toc-number">2.3.10.1.1.</span> <span class="toc-text">(1) pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-yaml"><span class="toc-number">2.3.10.1.2.</span> <span class="toc-text">(2) yaml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%B7%BB%E5%8A%A0nacos%E4%B8%9A%E5%8A%A1%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.10.1.3.</span> <span class="toc-text">(3) 添加nacos业务规则配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.10.1.4.</span> <span class="toc-text">(4) 测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81Seata%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.4.</span> <span class="toc-text">4、Seata处理分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98"><span class="toc-number">2.4.1.</span> <span class="toc-text">分布式事务问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81Seata%E7%AE%80%E4%BB%8B%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="toc-number">2.4.2.</span> <span class="toc-text">一、Seata简介与安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">1.1 相关术语</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E5%85%B8%E5%9E%8B%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E6%8E%A7%E5%88%B6%E4%BA%8B%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">1.2 典型的分布式控制事务流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-Seata-Server%E7%9A%84%E4%B8%8B%E8%BD%BD%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">1.3 Seata-Server的下载与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-1-%E4%BF%AE%E6%94%B9file-conf%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.2.3.1.</span> <span class="toc-text">1.3.1 修改file.conf文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#0-9-0%E7%89%88%E6%9C%AC"><span class="toc-number">2.4.2.3.2.</span> <span class="toc-text">0.9.0版本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%BB%BA%E5%BA%93%E5%BB%BA%E8%A1%A8"><span class="toc-number">2.4.2.3.3.</span> <span class="toc-text">1.3.2 数据库中建库建表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-3-%E4%BF%AE%E6%94%B9seata-server-0-9-0-seata-conf%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84registry-conf%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.2.3.4.</span> <span class="toc-text">1.3.3 修改seata-server-0.9.0\seata\conf目录下的registry.conf配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-4-%E5%90%AF%E5%8A%A8nacos%E5%92%8Cseata"><span class="toc-number">2.4.2.3.5.</span> <span class="toc-text">1.3.4 启动nacos和seata</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Seata-1-4-2%E7%89%88%E6%9C%AC%E5%A1%AB%E5%9D%91%E2%80%94nacos%E4%BD%9C%E4%B8%BAseata%E7%9A%84%E6%B3%A8%E5%86%8C-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E7%9C%8B%E7%9A%84%E9%BB%91%E9%A9%AC%E7%9A%84-sgg%E7%9A%84%E5%A4%B1%E8%B4%A5%E4%BA%86"><span class="toc-number">2.4.3.</span> <span class="toc-text">**Seata 1.4.2版本填坑—nacos作为seata的注册&#x2F;配置中心(看的黑马的   sgg的失败了)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0-%E5%90%AF%E5%8A%A8nacos"><span class="toc-number">2.4.4.</span> <span class="toc-text">0. 启动nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.5.</span> <span class="toc-text">1. 修改配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E8%BF%9B%E5%85%A5conf%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E4%BF%AE%E6%94%B9file-conf%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.5.1.</span> <span class="toc-text">①进入conf文件夹，修改file.conf文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E4%BF%AE%E6%94%B9conf-registry-conf%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.5.2.</span> <span class="toc-text">②修改conf\registry.conf文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B0%86%E9%85%8D%E7%BD%AE%E5%AF%BC%E5%85%A5%E5%88%B0nacos"><span class="toc-number">2.4.6.</span> <span class="toc-text">2. 将配置导入到nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0-%E5%87%86%E5%A4%87nacos-config-sh%E8%84%9A%E6%9C%AC"><span class="toc-number">2.4.6.1.</span> <span class="toc-text">① 准备nacos-config.sh脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1-config-txt%E5%87%86%E5%A4%87%E5%8F%8A%E4%BF%AE%E6%94%B9"><span class="toc-number">2.4.6.2.</span> <span class="toc-text">② config.txt准备及修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2-%E5%AF%BC%E5%85%A5seata%E7%9B%B8%E5%BA%94%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%E5%88%B0Nacos"><span class="toc-number">2.4.6.3.</span> <span class="toc-text">③ 导入seata相应的配置项到Nacos</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%BB%BA%E5%BA%93%E5%BB%BA%E8%A1%A8"><span class="toc-number">2.4.7.</span> <span class="toc-text">3. 数据库中建库建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%90%AF%E5%8A%A8seata"><span class="toc-number">2.4.8.</span> <span class="toc-text">4. 启动seata</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%AE%A2%E5%8D%95-%E5%BA%93%E5%AD%98-%E8%B4%A6%E6%88%B7%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%86%E5%A4%87"><span class="toc-number">2.4.9.</span> <span class="toc-text">二、订单&#x2F;库存&#x2F;账户业务数据库准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B8%9A%E5%8A%A1%E8%AF%B4%E6%98%8E"><span class="toc-number">2.4.9.1.</span> <span class="toc-text">2.1 分布式事务业务说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E8%A1%A8"><span class="toc-number">2.4.9.2.</span> <span class="toc-text">2.2 创建业务数据库与表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.4.9.2.1.</span> <span class="toc-text">1. 创建业务数据库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%8C%89%E7%85%A7%E4%B8%8A%E8%BF%B03%E5%BA%93%E5%88%86%E5%88%AB%E5%88%9B%E5%BB%BA%E5%AF%B9%E5%BA%94%E4%B8%9A%E5%8A%A1%E8%A1%A8"><span class="toc-number">2.4.9.2.2.</span> <span class="toc-text">2. 按照上述3库分别创建对应业务表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%8C%89%E7%85%A7%E4%B8%8A%E8%BF%B03%E5%BA%93%E5%88%86%E5%88%AB%E5%BB%BA%E5%AF%B9%E5%BA%94%E7%9A%84%E5%9B%9E%E6%BB%9A%E6%97%A5%E5%BF%97%E8%A1%A8"><span class="toc-number">2.4.9.2.3.</span> <span class="toc-text">3. 按照上述3库分别建对应的回滚日志表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E8%AE%A2%E5%8D%95-%E5%BA%93%E5%AD%98-%E8%B4%A6%E6%88%B7%E4%B8%9A%E5%8A%A1%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%87%86%E5%A4%87"><span class="toc-number">2.4.10.</span> <span class="toc-text">三、订单&#x2F;库存&#x2F;账户业务微服务准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB%E2%80%94%E2%80%94%E5%BE%88%E9%87%8D%E8%A6%81"><span class="toc-number">2.4.10.1.</span> <span class="toc-text">版本对应关系——很重要</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E6%96%B0%E5%BB%BA%E8%AE%A2%E5%8D%95Order-Module%E2%80%94%E2%80%94seata-order-service2001"><span class="toc-number">2.4.10.2.</span> <span class="toc-text">3.1 新建订单Order-Module——seata-order-service2001</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-pom-6"><span class="toc-number">2.4.10.2.1.</span> <span class="toc-text">(1) pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-application-yml"><span class="toc-number">2.4.10.2.2.</span> <span class="toc-text">(2) application.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-file-conf"><span class="toc-number">2.4.10.2.3.</span> <span class="toc-text">(3) file.conf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%A0%E4%B8%AA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="toc-number">2.4.10.2.4.</span> <span class="toc-text">几个配置文件对应关系</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-registry-conf"><span class="toc-number">2.4.10.2.5.</span> <span class="toc-text">(4) registry.conf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-domain"><span class="toc-number">2.4.10.2.6.</span> <span class="toc-text">(5) domain</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Order"><span class="toc-number">2.4.10.2.6.1.</span> <span class="toc-text">Order</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#CommonResult"><span class="toc-number">2.4.10.2.6.2.</span> <span class="toc-text">CommonResult</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-Dao%E6%8E%A5%E5%8F%A3%E5%8F%8A%E5%AE%9E%E7%8E%B0-SQL%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.10.2.7.</span> <span class="toc-text">(6) Dao接口及实现(SQL映射文件)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#OrderDao"><span class="toc-number">2.4.10.2.7.1.</span> <span class="toc-text">OrderDao</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#OrderMapper-xml"><span class="toc-number">2.4.10.2.7.2.</span> <span class="toc-text">OrderMapper.xml</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-Service%E6%8E%A5%E5%8F%A3%E5%8F%8A%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.10.2.8.</span> <span class="toc-text">(7) Service接口及实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#OrderService"><span class="toc-number">2.4.10.2.8.1.</span> <span class="toc-text">OrderService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#StorageService"><span class="toc-number">2.4.10.2.8.2.</span> <span class="toc-text">StorageService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#AccountService"><span class="toc-number">2.4.10.2.8.3.</span> <span class="toc-text">AccountService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#OrderServiceImpl"><span class="toc-number">2.4.10.2.8.4.</span> <span class="toc-text">OrderServiceImpl</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-controller"><span class="toc-number">2.4.10.2.9.</span> <span class="toc-text">(8) controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-config"><span class="toc-number">2.4.10.2.10.</span> <span class="toc-text">(9) config</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#MyBatisConfig"><span class="toc-number">2.4.10.2.10.1.</span> <span class="toc-text">MyBatisConfig</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#DataSourceProxyConfig"><span class="toc-number">2.4.10.2.10.2.</span> <span class="toc-text">DataSourceProxyConfig</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">2.4.10.2.11.</span> <span class="toc-text">(10) 主启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95-2"><span class="toc-number">2.4.10.2.12.</span> <span class="toc-text">启动测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%96%B0%E5%BB%BA%E5%BA%93%E5%AD%98Storage-Module%E2%80%94%E2%80%94seata-storage-service2002"><span class="toc-number">2.4.10.3.</span> <span class="toc-text">3.2 新建库存Storage-Module——seata-storage-service2002</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-pom-7"><span class="toc-number">2.4.10.3.1.</span> <span class="toc-text">(1) pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-application-yml-2"><span class="toc-number">2.4.10.3.2.</span> <span class="toc-text">(2) application.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-file-conf-registry-conf"><span class="toc-number">2.4.10.3.3.</span> <span class="toc-text">(3) file.conf &amp; registry.conf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-domain"><span class="toc-number">2.4.10.3.4.</span> <span class="toc-text">(4) domain</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Storage"><span class="toc-number">2.4.10.3.4.1.</span> <span class="toc-text">Storage</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#CommonResult-2"><span class="toc-number">2.4.10.3.4.2.</span> <span class="toc-text">CommonResult</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-Dao%E6%8E%A5%E5%8F%A3%E5%8F%8A%E5%AE%9E%E7%8E%B0-SQL%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.10.3.5.</span> <span class="toc-text">(5) Dao接口及实现(SQL映射文件)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#StorageDao"><span class="toc-number">2.4.10.3.5.1.</span> <span class="toc-text">StorageDao</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#StorageMapper-xml"><span class="toc-number">2.4.10.3.5.2.</span> <span class="toc-text">StorageMapper.xml</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-Service%E6%8E%A5%E5%8F%A3%E5%8F%8A%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.10.3.6.</span> <span class="toc-text">(6) Service接口及实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#StorageService-2"><span class="toc-number">2.4.10.3.6.1.</span> <span class="toc-text">StorageService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#StorageServiceImpl"><span class="toc-number">2.4.10.3.6.2.</span> <span class="toc-text">StorageServiceImpl</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-Controller"><span class="toc-number">2.4.10.3.7.</span> <span class="toc-text">(7) Controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-config%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.10.3.8.</span> <span class="toc-text">(8) config配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">2.4.10.3.9.</span> <span class="toc-text">(9) 主启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95-3"><span class="toc-number">2.4.10.3.10.</span> <span class="toc-text">启动测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E6%96%B0%E5%BB%BA%E8%B4%A6%E6%88%B7Account-Module%E2%80%94%E2%80%94seata-account-service2003"><span class="toc-number">2.4.10.4.</span> <span class="toc-text">3.3 新建账户Account-Module——seata-account-service2003</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-pom-8"><span class="toc-number">2.4.10.4.1.</span> <span class="toc-text">(1) pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-application-yml-3"><span class="toc-number">2.4.10.4.2.</span> <span class="toc-text">(2) application.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-file-conf-registry-conf-2"><span class="toc-number">2.4.10.4.3.</span> <span class="toc-text">(3) file.conf &amp; registry.conf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-domain-2"><span class="toc-number">2.4.10.4.4.</span> <span class="toc-text">(4) domain</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Account"><span class="toc-number">2.4.10.4.4.1.</span> <span class="toc-text">Account</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#CommonResult-3"><span class="toc-number">2.4.10.4.4.2.</span> <span class="toc-text">CommonResult</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-Dao%E6%8E%A5%E5%8F%A3%E5%8F%8A%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.10.4.5.</span> <span class="toc-text">(5) Dao接口及实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#AccountDao"><span class="toc-number">2.4.10.4.5.1.</span> <span class="toc-text">AccountDao</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#AccountMapper-xml"><span class="toc-number">2.4.10.4.5.2.</span> <span class="toc-text">AccountMapper.xml</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-Service%E6%8E%A5%E5%8F%A3%E5%8F%8A%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">2.4.10.4.6.</span> <span class="toc-text">(6) Service接口及实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#AccountService-2"><span class="toc-number">2.4.10.4.6.1.</span> <span class="toc-text">AccountService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#AccountServiceImpl"><span class="toc-number">2.4.10.4.6.2.</span> <span class="toc-text">AccountServiceImpl</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-Controller-2"><span class="toc-number">2.4.10.4.7.</span> <span class="toc-text">(7) Controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-config%E9%85%8D%E7%BD%AE-2"><span class="toc-number">2.4.10.4.8.</span> <span class="toc-text">(8) config配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB-2"><span class="toc-number">2.4.10.4.9.</span> <span class="toc-text">(9) 主启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95-4"><span class="toc-number">2.4.10.4.10.</span> <span class="toc-text">启动测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A1%AB%E5%9D%91%E9%AB%98%E7%89%88%E6%9C%ACseata1-4-2client%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.11.</span> <span class="toc-text">## 填坑高版本seata1.4.2client配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A0-%E4%BF%AE%E6%94%B9%E7%88%B6%E5%B7%A5%E7%A8%8B%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="toc-number">2.4.12.</span> <span class="toc-text">① 修改父工程版本控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A1-%E4%BF%AE%E6%94%B9%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97seata%E4%BE%9D%E8%B5%96pom"><span class="toc-number">2.4.13.</span> <span class="toc-text">② 修改微服务模块seata依赖pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A2-%E4%BF%AE%E6%94%B9%E5%BE%AE%E6%9C%8D%E5%8A%A1application-yml"><span class="toc-number">2.4.14.</span> <span class="toc-text">③ 修改微服务application.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A3-%E4%BF%AE%E6%94%B9%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB%E5%92%8CDataSourceProxyConfig%E7%B1%BB"><span class="toc-number">2.4.15.</span> <span class="toc-text">④ 修改主启动类和DataSourceProxyConfig类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">2.4.15.1.</span> <span class="toc-text">主启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">2.4.15.2.</span> <span class="toc-text">配置类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E5%8D%9A%E5%AE%A2"><span class="toc-number">2.4.16.</span> <span class="toc-text">参考博客</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F%E6%A0%87%E8%AF%86%EF%BC%9A"><span class="toc-number">2.4.16.0.0.1.</span> <span class="toc-text">启动成功标识：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%B5%8B%E8%AF%95"><span class="toc-number">2.4.17.</span> <span class="toc-text">四、测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Seata%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8"><span class="toc-number">2.4.17.1.</span> <span class="toc-text">Seata全局事务怎么使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-0-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E6%83%85%E5%86%B5"><span class="toc-number">2.4.17.2.</span> <span class="toc-text">4.0 数据库初始情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E6%B5%8B%E8%AF%95%E6%AD%A3%E5%B8%B8%E4%B8%8B%E5%8D%95"><span class="toc-number">2.4.17.3.</span> <span class="toc-text">4.1 测试正常下单</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%A5%E9%94%99"><span class="toc-number">2.4.17.3.1.</span> <span class="toc-text">报错</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E6%B5%8B%E8%AF%95"><span class="toc-number">2.4.17.3.2.</span> <span class="toc-text">再次测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E6%B5%8B%E8%AF%95%E8%B6%85%E6%97%B6%E5%BC%82%E5%B8%B8%EF%BC%9A%E4%B8%8D%E5%8A%A0-GlobalTransactional"><span class="toc-number">2.4.17.4.</span> <span class="toc-text">4.2 测试超时异常：不加@GlobalTransactional</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#AccountServiceImpl%E6%B7%BB%E5%8A%A0%E8%B6%85%E6%97%B6%EF%BC%9A"><span class="toc-number">2.4.17.4.1.</span> <span class="toc-text">AccountServiceImpl添加超时：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E8%B6%85%E6%97%B6%E5%BC%82%E5%B8%B8%EF%BC%9A"><span class="toc-number">2.4.17.4.2.</span> <span class="toc-text">报错超时异常：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%83%85%E5%86%B5%EF%BC%9A"><span class="toc-number">2.4.17.4.3.</span> <span class="toc-text">数据库情况：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E6%B5%8B%E8%AF%95%E8%B6%85%E6%97%B6%E5%BC%82%E5%B8%B8%EF%BC%9A%E5%8A%A0-GlobalTransactional"><span class="toc-number">2.4.17.5.</span> <span class="toc-text">4.3 测试超时异常：加@GlobalTransactional</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E5%B0%8F%E7%BB%93"><span class="toc-number">2.4.17.6.</span> <span class="toc-text">4.4 小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E"><span class="toc-number">2.4.18.</span> <span class="toc-text">五、补充说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-0-undo-log%E8%A1%A8%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.4.18.1.</span> <span class="toc-text">5.0 undo_log表的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E5%86%8D%E7%9C%8BTC-TM-RM%E4%B8%89%E5%A4%A7%E7%BB%84%E4%BB%B6"><span class="toc-number">2.4.18.2.</span> <span class="toc-text">5.1 再看TC&#x2F;TM&#x2F;RM三大组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-AT%E6%A8%A1%E5%BC%8F%EF%BC%88%E9%BB%98%E8%AE%A4%EF%BC%89%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E5%AF%B9%E4%B8%9A%E5%8A%A1%E7%9A%84%E6%97%A0%E4%BE%B5%E5%85%A5"><span class="toc-number">2.4.18.3.</span> <span class="toc-text">5.2 AT模式（默认）如何做到对业务的无侵入</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1-%E4%B8%80%E9%98%B6%E6%AE%B5%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.4.18.3.1.</span> <span class="toc-text">5.2.1 一阶段加载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-2-%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4"><span class="toc-number">2.4.18.3.2.</span> <span class="toc-text">5.2.2 二阶段提交</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-3-%E4%BA%8C%E9%98%B6%E6%AE%B5%E5%9B%9E%E6%BB%9A"><span class="toc-number">2.4.18.3.3.</span> <span class="toc-text">5.2.3 二阶段回滚</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-debug%E6%9F%A5%E7%9C%8B%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.18.4.</span> <span class="toc-text">5.3 debug查看流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">2.4.18.5.</span> <span class="toc-text">5.4 整体流程图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E7%A7%8D%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%BC%94%E7%A4%BA"><span class="toc-number">2.4.19.</span> <span class="toc-text">四种模式的演示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#XA-149-00-00"><span class="toc-number">2.4.19.1.</span> <span class="toc-text">XA(149&#x2F;00:00)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AT-149-15-54"><span class="toc-number">2.4.19.2.</span> <span class="toc-text">AT(149&#x2F;15:54)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCC%EF%BC%88%E4%B8%8D%E5%8A%A0%E9%94%81%EF%BC%89%EF%BC%88149-47-36%EF%BC%89"><span class="toc-number">2.4.19.3.</span> <span class="toc-text">TCC（不加锁）（149&#x2F;47:36）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Saga%EF%BC%88%E7%AE%80%E8%AF%B4-%E6%97%A0%E6%BC%94%E7%A4%BA%EF%BC%89"><span class="toc-number">2.4.19.4.</span> <span class="toc-text">Saga（简说  无演示）</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By Ryang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><!--button#darkmode(type="button" title=_p('rightside.night_mode_title'))--><!--  i.fas.fa-adjust--><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"></svg><use id="modeicon" xlink:href="#icon-moon"></use></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();" rel="external nofollow noreferrer"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();" rel="external nofollow noreferrer"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();" rel="external nofollow noreferrer"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()" rel="external nofollow noreferrer"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()" rel="external nofollow noreferrer"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()" rel="external nofollow noreferrer"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()" rel="external nofollow noreferrer"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();" rel="external nofollow noreferrer"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();" rel="external nofollow noreferrer"><i class="fa fa-book"></i><span>阅读模式</span></a><a class="rightMenu-item" href="/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();" rel="external nofollow noreferrer"><i class="fas fa-cog"></i><span>美化设置</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();" rel="external nofollow noreferrer"><i class="fas fa-expand"></i><span>切换全屏</span></a><a class="rightMenu-item" href="javascript:window.print();" rel="external nofollow noreferrer"><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.19/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Livere' === 'Livere' || !true) {
  if (true) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Adx946D8MgrhiaHCsXZfLp1L-gzGzoHsz',
      appKey: 'rvkGzSypPhV7c8TIk5TAM8iy',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: {"2020":"dc709fac0d361370bcf0d36d32adb97df7c95824.png","tv_白眼":"c1d59f439e379ee50eef488bcb5e5378e5044ea4.png","tv_doge":"6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv_坏笑":"1f0b87f731a671079842116e0991c91c2c88645a.png","tv_难过":"87f46748d3f142ebc6586ff58860d0e2fc8263ba.png","tv_生气":"26702dcafdab5e8225b43ffd23c94ac1ff932654.png","tv_委屈":"d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv_斜眼笑":"911f987aa8bc1bee12d52aafe62bc41ef4474e6c.png","tv_呆":"fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png","tv_发怒":"34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv_惊吓":"0d15c7e2ee58e935adc6a7193ee042388adc22af.png","tv_呕吐":"9f996894a39e282ccf5e66856af49483f81870f3.png","tv_思考":"90cf159733e558137ed20aa04d09964436f618a1.png","tv_微笑":"70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv_疑问":"0793d949b18d7be716078349c202c15ff166f314.png","tv_大哭":"23269aeb35f99daee28dda129676f6e9ea87934f.png","tv_鼓掌":"1d21793f96ef4e6f48b23e53e3b9e42da833a0f6.png","tv_抠鼻":"c666f55e88d471e51bbd9fab9bb308110824a6eb.png","tv_亲亲":"a8111ad55953ef5e3be3327ef94eb4a39d535d06.png","tv_调皮":"b9c41de8e82dd7a8515ae5e3cb63e898bf245186.png","tv_笑哭":"1abc628f6d4f4caf9d0e7800878f4697abbc8273.png","tv_晕":"5443c22b4d07fb1907ccc610c8e6db254f2461b7.png","tv_点赞":"f85c354995bd99e28fc76c869bfe42ba6438eff4.png","tv_害羞":"a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png","tv_睡着":"8b196675b53af58264f383c50ad0945048290b33.png","tv_色":"61822c7e9aae5da76475e7892534545336b23a6f.png","tv_吐血":"09dd16a7aa59b77baa1155d47484409624470c77.png","tv_无奈":"ea8ed89ee9878f2fece2dda0ea8a5dbfe21b5751.png","tv_再见":"180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv_流汗":"cead1c351ab8d79e9f369605beb90148db0fbed3.png","tv_偷笑":"bb690d4107620f1c15cff29509db529a73aee261.png","tv_抓狂":"fe31c08edad661d63762b04e17b8d5ae3c71a757.png","tv_黑人问号":"45821a01f51bc867da9edbaa2e070410819a95b2.png","tv_困":"241ee304e44c0af029adceb294399391e4737ef2.png","tv_打脸":"56ab10b624063e966bfcb76ea5dc4794d87dfd47.png","tv_闭嘴":"c9e990da7f6e93975e25fd8b70e2e290aa4086ef.png","tv_鄙视":"6e72339f346a692a495b123174b49e4e8e781303.png","tv_腼腆":"89712c0d4af73e67f89e35cbc518420380a7f6f4.png","tv_馋":"fc7e829b845c43c623c8b490ee3602b7f0e76a31.png","tv_可爱":"9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv_发财":"34db290afd2963723c6eb3c4560667db7253a21a.png","tv_生病":"8b0ec90e6b86771092a498c54f09fc94621c1900.png","tv_流鼻血":"c32d39db2737f89b904ca32700d140a9241b0767.png","tv_尴尬":"7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png","tv_大佬":"093c1e2c490161aca397afc45573c877cdead616.png","tv_流泪":"7e71cde7858f0cd50d74b0264aa26db612a8a167.png","tv_冷漠":"b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv_皱眉":"72ccad6679fea0d14cce648b4d818e09b8ffea2d.png","tv_鬼脸":"0ffbbddf8a94d124ca2f54b360bbc04feb6bbfea.png","tv_调侃":"4bc022533ef31544ca0d72c12c808cf4a1cce3e3.png","tv_目瞪口呆":"0b8cb81a68de5d5365212c99375e7ace3e7891b7.png","2233娘_大笑":"16b8794be990cefa6caeba4d901b934a227ee3b8.png","2233娘_疑问":"0b41f509351958dbb63d472fec0132d1bd03bd14.png","2233娘_吃惊":"d1628c43d35b1530c0504a643ff80b6189fa0a43.png","2233娘_汗":"247cd9df8cdf84b18368c21e3b2dd374e84c0927.png","2233娘_大哭":"476a2a60f6e337b8c0697a592e0aa82781f6b33b.png","2233娘_困惑":"714eeb4eae0d0933b4ff08b7df788b1982f6b940.png","2233娘_耶":"d7178e258a0efc969b65ccc2b1322fb235f5dff4.png","2233娘_怒":"f31953119c51b9748016440ac0b632f779929b37.png","2233娘_卖萌":"ea893aa25355de95ab4f03c2dad3f0c58d0c159e.png","2233娘_委屈":"d9d0bf9d358af8d5761093ec66d4e3f60d963a63.png","2233娘_郁闷":"485203fe7100f2c8fc40b2800a18fe20b35f2f1a.png","2233娘_第一":"3754ee6e5985bd0bd7dfb668981f2a8733398ebd.png","2233娘_喝水":"695bf5429472049b52c1e0de586f8a2511195a23.png","2233娘_吐魂":"e999af499edf38a91ca68b1a9d2f97042c1d6734.png","2233娘_无言":"fdb5870f32cfaf7949e0f88a13f6feba4a48b719.png","热词系列_增加":"142409b595982b8210b2958f3d340f3b47942645.png","热词系列_泪目":"bba3703ab90b7d16fe9dbcb85ed949db687f8331.png","热词系列_保护":"55f8f6445ca7c3170cdfc5b16036abf639ce9b57.png","热词系列_害怕":"d77e2de26da143249f0c0ad7a608c27152c985bf.png","热词系列_爱了爱了":"2a165b555ba20391316366c664ed7891883dc5aa.png","热词系列_问号":"c1d1e76c12180adc8558f47006fe0e7ded4154bb.png","热词系列_吹爆":"b528220f9c37256ed6a37f05bf118e44b08b81e5.png","热词系列_三连":"21f15fe11b7a84d2f2121c16dec50a4e4556f865.png","热词系列_可以":"e08543c71202b36c590094417fcfbb80c3506cd8.png","热词系列_打卡":"a9cf77c78e1b9b40aa3ed4862402fba008ee2f51.png","热词系列_妙啊":"0e98299d7decf5eaffad854977946075c3e91cb8.png","热词系列_这次一定":"a01ca28923daa7cc896c42f27deb4914e20dd572.png","热词系列_AWSL":"c37f88cf799f9badf9d84b7671dc3dd98c0fc0c2.png","热词系列_递话筒":"98e6950e39fbb4dd1c576042063ca632074070ba.png","热词系列_你细品":"535e00658e7e47966f154d3a167fa2365ebc4321.png","热词系列_咕咕":"d8065c2e7ce48c929317a94553499a46fecc262a.png","热词系列_标准结局":"3de98174b510cf7dc5fd1bd08c5d881065e79137.png","热词系列_危":"5cc6c3357c4df544dd8de9d5c5c0cec97c7c9a56.png","热词系列_张三":"255a938f39cea625032b6650036b31aa26c50a3c.png","热词系列_害":"cbe798a194612958537c5282fcca7c3bcd2aa15c.png","热词系列_我裂开了":"29bd57ec4e8952880fea6c9e47aee924e91f10c4.png","热词系列_有内味了":"7ca61680a905b5b6e2e335c630e725b648b03b4d.png","热词系列_猛男必看":"c97064450528a0e45c7e7c365a15fbb13fd61d8c.png","热词系列_奥力给":"c9b8683827ec6c00fea5327c9bec14f581cef2aa.png","热词系列_我哭了":"9e0b3877d649aaf6538fbdd3f937e240a9d808e4.png","热词系列_高产":"9db817cba4a7f4a42398f3b2ec7c0a8e0c247c42.png","热词系列_我酸了":"a8cbf3f6b8cd9377eeb15b9172f3cd683b2e4650.png","热词系列_真香":"e68497c775feaac1c3b1a6cd63a50cfb11b767c4.png","热词系列_我全都要":"d424d1ad8d14c1c9b8367842bc68c658b9229bc1.png","热词系列_神仙UP":"a49e0d0db1e7d35a0f7411be13208951ab448f03.png","热词系列_你币有了":"84820c2b147a8ca02f3c4006b63f76c6313cbfa0.png","热词系列_不愧是你":"9ff2e356797c57ee3b1675ade0883d2d2247be9b.png","热词系列_锤":"35668cc12ae25b9545420e4a85bf21a0bfc03e5d.png","热词系列_秀":"50782fbf5d9b7f48f9467b5c53932981e321eedc.png","热词系列_爷关更":"faad40c56447f1f8abcb4045c17ce159d113d1fd.png","热词系列_有生之年":"f41fdafe2d0fbb8e8bc1598d2cf37e355560103a.png","热词系列_镇站之宝":"24e7a6a6e6383c987215fb905e3ee070aca259b5.png","热词系列_我太男了":"a523f3e4c63e4db1232365765d0ec452f83be97e.png","热词系列_完结撒花":"ea9db62ff5bca8e069cd70c4233353a802835422.png","热词系列_大师球":"f30089248dd137c568edabcb07cf67e0f6e98cf3.png","热词系列_知识盲区":"ccc94600b321a28116081e49ecedaa4ee8728312.png","热词系列_“狼火”":"33ccd3617bfa89e9d1498b13b7542b63f163e5de.png","加油武汉":"eb966aaa5b690d3f9308a9f936f5b5a72a7f956b.png","口罩":"3ad2f66b151496d2a5fb0a8ea75f32265d778dd3.png","鸡腿":"c7860392815d345fa69c4f00ef18d67dccfbd574.png","微笑":"685612eadc33f6bc233776c6241813385844f182.png","笑":"81edf17314cea3b48674312b4364df44d5c01f17.png","呲牙":"b5a5898491944a4268360f2e7a84623149672eb6.png","OK":"4683fd9ffc925fa6423110979d7dcac5eda297f4.png","星星眼":"63c9d1a31c0da745b61cdb35e0ecb28635675db2.png","哦呼":"362bded07ea5434886271d23fa25f5d85d8af06c.png","嫌弃":"de4c0783aaa60ec03de0a2b90858927bfad7154b.png","喜欢":"8a10a4d73a89f665feff3d46ca56e83dc68f9eb8.png","酸了":"92b1c8cbceea3ae0e8e32253ea414783e8ba7806.png","大哭":"2caafee2e5db4db72104650d87810cc2c123fc86.png","害羞":"9d2ec4e1fbd6cb1b4d12d2bbbdd124ccb83ddfda.png","无语":"44667b7d9349957e903b1b62cb91fb9b13720f04.png","疑惑":"b7840db4b1f9f4726b7cb23c0972720c1698d661.png","调皮":"8290b7308325e3179d2154327c85640af1528617.png","喜极而泣":"485a7e0c01c2d70707daae53bee4a9e2e31ef1ed.png","奸笑":"bb84906573472f0a84cebad1e9000eb6164a6f5a.png","偷笑":"6c49d226e76c42cd8002abc47b3112bc5a92f66a.png","大笑":"ca94ad1c7e6dac895eb5b33b7836b634c614d1c0.png","阴险":"ba8d5f8e7d136d59aab52c40fd3b8a43419eb03c.png","捂脸":"6921bb43f0c634870b92f4a8ad41dada94a5296d.png","囧":"12e41d357a9807cc80ef1e1ed258127fcc791424.png","呆":"33ad6000d9f9f168a0976bc60937786f239e5d8c.png","抠鼻":"cb89184c97e3f6d50acfd7961c313ce50360d70f.png","惊喜":"0afecaf3a3499479af946f29749e1a6c285b6f65.png","惊讶":"f8e9a59cad52ae1a19622805696a35f0a0d853f3.png","笑哭":"c3043ba94babf824dea03ce500d0e73763bf4f40.png","妙啊":"b4cb77159d58614a9b787b91b1cd22a81f383535.png","doge":"bba7c12aa51fed0199c241465560dfc2714c593e.png","滑稽":"d15121545a99ac46774f1f4465b895fe2d1411c3.png","吃瓜":"4191ce3c44c2b3df8fd97c33f85d3ab15f4f3c84.png","打call":"431432c43da3ee5aab5b0e4f8931953e649e9975.png","点赞":"1a67265993913f4c35d15a6028a30724e83e7d35.png","鼓掌":"895d1fc616b4b6c830cf96012880818c0e1de00d.png","尴尬":"cb321684ed5ce6eacdc2699092ab8fe7679e4fda.png","冷":"cb0ebbd0668640f07ebfc0e03f7a18a8cd00b4ed.png","灵魂出窍":"43d3db7d97343c01b47e22cfabeca84b4251f35a.png","委屈":"d2f26cbdd6c96960320af03f5514c5b524990840.png","傲娇":"010540d0f61220a0db4922e4a679a1d8eca94f4e.png","疼":"905fd9a99ec316e353b9bd4ecd49a5f0a301eabf.png","吓":"9c10c5ebc7bef27ec641b8a1877674e0c65fea5d.png","生病":"0f25ce04ae1d7baf98650986454c634f6612cb76.png","吐":"06946bfe71ac48a6078a0b662181bb5cad09decc.png","嘘声":"e64af664d20716e090f10411496998095f62f844.png","捂眼":"c5c6d6982e1e53e478daae554b239f2b227b172b.png","思考":"cfa9b7e89e4bfe04bbcd34ccb1b0df37f4fa905c.png","再见":"fc510306bae26c9aec7e287cdf201ded27b065b9.png","翻白眼":"eba54707c7168925b18f6f8b1f48d532fe08c2b1.png","哈欠":"888d877729cbec444ddbd1cf4c9af155a7a06086.png","奋斗":"bb2060c15dba7d3fd731c35079d1617f1afe3376.png","墨镜":"3a03aebfc06339d86a68c2d893303b46f4b85771.png","撇嘴":"531863568e5668c5ac181d395508a0eeb1f0cda4.png","难过":"a651db36701610aa70a781fa98c07c9789b11543.png","抓狂":"4c87afff88c22439c45b79e9d2035d21d5622eba.png","生气":"3195714219c4b582a4fb02033dd1519913d0246d.png","干杯":"8da12d5f55a2c7e9778dcc05b40571979fe208e6.png","爱心":"ed04066ea7124106d17ffcaf75600700e5442f5c.png","锦鲤":"643d6c19c8164ffd89e3e9cdf093cf5d773d979c.png","胜利":"b49fa9f4b1e7c3477918153b82c60b114d87347c.png","加油":"c7aaeacb21e107292d3bb053e5abde4a4459ed30.png","保佑":"fafe8d3de0dc139ebe995491d2dac458a865fb30.png","抱拳":"89516218158dbea18ab78e8873060bf95d33bbbe.png","响指":"1b5c53cf14336903e1d2ae3527ca380a1256a077.png","支持":"3c210366a5585706c09d4c686a9d942b39feeb50.png","拥抱":"41780a4254750cdaaccb20735730a36044e98ef3.png","怪我咯":"07cc6077f7f7d75b8d2c722dd9d9828a9fb9e46d.png","跪了":"f2b3aee7e521de7799d4e3aa379b01be032698ac.png","黑洞":"e90ec4c799010f25391179118ccd9f66b3b279ba.png","老鼠":"8e6fb491eb1bb0d5862e7ec8ccf9a3da12b6c155.png","福到了":"5de5373d354c373cf1617b6b836f3a8d53c5a655.png"},
      path: window.location.pathname,
      // master: '8a517fba7c520dddace09b926c0775c3',   //博主邮箱md5加密32位小写
      // tagMeta: ["博主", "小伙伴", "访客"],     //标识字段名
      // friends: [],  //小伙伴邮箱Md5
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdnjs.cloudflare.com/ajax/libs/valine/1.5.1/Valine.min.js').then(initValine)
}

if ('Livere' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="/js/sun_moon.js" async></script><script async src="/js/charts.js"></script><script async src="//at.alicdn.com/t/c/font_4146777_2b7ofuf0dew.js"></script><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer data-pjax src="/js/cat.js"></script><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async data-pjax src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js" type="application/javascript"></script><script src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><script src="/js/newYear.js"></script><script async data-pjax src="/js/newYear.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script defer src="/js/lunar.js"></script><script defer src="/js/day.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><div id="fps"></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><div class="aplayer no-destroy" data-id="3136179094" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/xiabo2/CDN@latest/fishes.js"></script><script defer src="https://cdn.jsdelivr.net/combine/npm/jquery@latest/dist/jquery.min.js,gh/weilining/jsdelivr/jquery/circlemagic/circlemagic.min.js,gh/weilining/jsdelivr@latest/jquery/circlemagic/butterflycirclemagic.js"></script><script src="https://cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><div><canvas id="snow" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;pointer-events:none"></canvas></div><script>const notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));</script><script async type="text/javascript" src="https://cdn.jsdelivr.net/gh/Candinya/Kratos-Rebirth@latest/source/js/snow.min.js"></script><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer data-pjax src="/js/rightMenu.js"></script><script defer src="https://rmt.dogedoge.com/fetch/~/source/jsdelivr/npm/jquery@latest/dist/jquery.min.js"></script><script defer data-pjax src="https://cdn.jsdelivr.net/gh/sirxemic/jquery.ripples/dist/jquery.ripples.js"></script><script defer data-pjax src="/js/ripples.js"></script><script src="/js/yinghua.js"></script><script src="/js/fengye.js"></script><script src="/js/emoji.js"></script><script defer src="https://cdn.jsdelivr.net/gh/graingert/wow@1.3.0/dist/wow.min.js"></script><script defer data-pjax src="/js/wow_init.js"></script><script async src="/js/title.js"></script><script src="/js/visitor.js"></script><script src="/js/random.js"></script><script src="https://npm.elemecdn.com/vue@2.6.11"></script><script async src="/js/fps.js"></script><script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script><script src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script><script src="/js/random.js"></script><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async data-pjax src="/js/txmap.js"></script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script src="/js/weather.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/canvas-nest.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"> <!--文章容器--> <div id="catalog_magnet">  <!--挂载容器--> <div class="magnet_item"><div style="display:flex;padding: 20px;font-size:16px;"><span style="font-weight:500;flex:1">中间件 (8)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></div><div class="magnet_item"><div style="display:flex;padding: 20px;font-size:16px;"><span style="font-weight:500;flex:1">框架 (12)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></div><div class="magnet_item"><div style="display:flex;padding: 20px;font-size:16px;"><span style="font-weight:500;flex:1">Java (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></div><div class="magnet_item"><div style="display:flex;padding: 20px;font-size:16px;"><span style="font-weight:500;flex:1">MySQL (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></div><div class="magnet_item"><div style="display:flex;padding: 20px;font-size:16px;"><span style="font-weight:500;flex:1">redis (10)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></div><div class="magnet_item"><div style="display:flex;padding: 20px;font-size:16px;"><span style="font-weight:500;flex:1">Future (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></div><div class="magnet_item"><div style="display:flex;padding: 20px;font-size:16px;"><span style="font-weight:500;flex:1">SpringCloud (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="http://rycan.top/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a> </div> </div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #5faee3;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #48c9b0}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>function history_calendar_injector_config(){
                var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
                var item_html = '<div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div>';
                console.log('已挂载history_calendar')
                // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
            }if( document.getElementsByClassName('sticky_layout')[0] && (location.pathname ==='/'|| '/' ==='all')){

            history_calendar_injector_config()
        } </script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script><script data-pjax>
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 190px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 160px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(https://img2.baidu.com/it/u=3745692040,3005247474&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=500);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/中间件/&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer">中间件</a><span class="categoryBar-list-count">8</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://img1.baidu.com/it/u=1341754829,1132645464&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=400&amp;h=400);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/框架/&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer">框架</a><span class="categoryBar-list-count">12</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://img0.baidu.com/it/u=2484535052,376615361&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=503&amp;h=500);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/Java/&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer">Java</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://img0.baidu.com/it/u=3312661278,78172823&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=554);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/MySQL/&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer">MySQL</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://img2.baidu.com/it/u=1036154364,590128025&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=502);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/redis/&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer">redis</a><span class="categoryBar-list-count">10</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://img2.baidu.com/it/u=3063786176,3698143304&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=500);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/Future/&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer">Future</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://img1.baidu.com/it/u=2409457391,176527849&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=500);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/SpringCloud/&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer">SpringCloud</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li></ul></div></div>';
      console.log('已挂载butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = 'b16a1fa0e63c46a4b8f28abfb06ae3fe';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '112.982279,28.19409';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/c4fc293b.html&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt=""><img width="48" height="48" src="img/38.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-07-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/c4fc293b.html&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt="">网站还没做的功能</a><div class="blog-slider__text">待补充~</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/c4fc293b.html&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/16107.html&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt=""><img width="48" height="48" src="img/46.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-21</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/16107.html&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt="">Hello World</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/16107.html&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/57317.html&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt=""><img width="48" height="48" src="/img/42.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-21</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/57317.html&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt="">b-草稿</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/57317.html&quot;);" href="javascript:void(0);" rel="external nofollow noreferrer" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '2');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/charts/'|| '/charts/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("https://gitcalendar.fomal.cc/api?YangruiY",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'YangruiY')
    }
  </script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>