{"type":"getPostByPath","data":{"title":"Netty 基础学习","date":"2023-07-03T12:28:07.000Z","description":"Netty 初级","categories":[{"name":"框架","_id":"cloioo9ds001ani0pc34ggtc0"}],"tags":[{"name":"Netty","_id":"cloioo9eb0050ni0p5vfu6k8h"}],"content":"<meta name=\"referrer\" content=\"no-referrer\">\n<h1>Netty前置知识</h1>\n<h2 id=\"BIO编程\">BIO编程</h2>\n<blockquote>\n<p>BIO模型</p>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305231414220.png\" alt=\"image-20230523141445122\" style=\"zoom:33%;\">\n</blockquote>\n<h3 id=\"IO模型\">IO模型</h3>\n<h4 id=\"简单理解：\">简单理解：</h4>\n<ul>\n<li>用什么样的<code>通道</code>进行<code>数据的发送和接收</code>，很大程度上决定了<code>程序通信</code>的性能</li>\n</ul>\n<h4 id=\"三大IO\">三大<code>IO</code></h4>\n<ul>\n<li>三种网络编程模型的IO模型     <code>BIO   NIO  AIO</code></li>\n</ul>\n<h5 id=\"BIO：同步并阻塞（传统阻塞型）\"><code> BIO</code>：同步并阻塞（传统阻塞型）</h5>\n<ul>\n<li>服务器实现模式为  <code>一个连接对应一个线程</code>，即<code>客户端</code>有连接请求时<code>服务器端</code>就需要启动一个线程进行处理，但是如果这个连接不做任何事情会造成不必要的线程开销，但是可以通过<code>线程池</code>改善</li>\n<li>适用场景：适用于<code>连接数目比较小</code>且固定的架构，这种方式对服务器资源要求比较高，并发局限于应用中</li>\n<li><font color=\"red\"> <code>BIO</code> 编程流程的梳理:</font>\n<ul>\n<li>服务器端启动一个 <code>ServerSocket</code></li>\n<li>客户端启动 <code>Socket</code> 对服务器进行通信，<code>默认情况</code>下服务器端需要对每个客户建立一个线程与之通讯</li>\n<li>客户端发出请求后，先咨询服务器是否有线程响应，如果没有则会等待，或者被拒绝</li>\n<li>如果有响应，客户端线程会等待请求结束后，再继续执行</li>\n</ul>\n</li>\n<li>带来的问题\n<ul>\n<li>每个请求都需要创建独立的线程，与对应的客户端进行数据 <code>Read</code>，业务处理，数据 <code>Write</code></li>\n<li>当并发数较大时，需要创建大量线程来处理连接，系统资源占用较大</li>\n<li>连接建立后，如果当前线程暂时没有数据可读，则线程就阻塞在 <code>Read</code> 操作上，造成线程资源浪费</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"NIO：同步非阻塞\"><code> NIO</code>：同步非阻塞</h5>\n<ul>\n<li>服务器实现模式为一<code>个线程处理多个请求</code>（连接），即<code>客户端</code>发送的连接请求都会注册到<code>多路复用器(selector)</code>上，<code>多路复用器</code>轮询到连接有 <code>I/O</code> 请求就进行处理</li>\n<li>适用场景：适用于<code>连接数目多且连接比较短</code>（轻操作）的架构，比如聊天服务器，弹幕系统，服务器间通讯等</li>\n<li>三大核心部分：<code>channel(通道)  Buffer(缓存区) Selector(选择器) </code></li>\n<li><code>NIO</code> 是<strong>面向缓冲区，面向块编程</strong>的。数据读取到一个它稍后处理的缓冲区，需要时可在缓冲区中前后移动，这就增加了处理过程中的灵活性，使用它可以提供非阻塞式的高伸缩性网络</li>\n<li><code> NIO</code> 的非阻塞模式讲的就是\n<ul>\n<li>使一个线程从某通道发送请求或者读取数据，但是它仅能得到<code>目前可用</code>的数据，如果<code>目前没有数据可用</code>时，就什么都不会获取，而不是保持线程阻塞，所以直至<code>数据变的可以读取之前</code>，该线程可以继续做其他的事情。</li>\n<li>非阻塞写也是如此，一个线程请求写入一些数据到某通道，但不需要等待它完全写入，这个线程同时可以去做别的事情。</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p><code>HTTP 2.0</code> 使用了多路复用的技术，做到同一个连接并发处理多个请求，而且并发请求的数量比 <code>HTTP 1.1</code> 大了好几个数量级。</p>\n<p><code>intBuffer.flip();     ---将 buffer 转换，读写切换</code></p>\n</blockquote>\n<h5 id=\"AIO-NIO-2-：异步非阻塞\"><code>AIO(NIO.2)</code>：异步非阻塞</h5>\n<ul>\n<li><code>AIO</code> 引入异步通道的概念，采用了 <code>Proactor</code> 模式，简化了程序编写，有效的请求才启动线程，它的特点是先由操作系统完成后才通知服务端程序启动线程去处理，一般适用于连接数较多且连接时间较长的应用</li>\n<li>适用场景：适用于<code>连接数目多且连接比较长</code>（重操作）的架构，比如相册服务器，充分调用 <code>OS</code> 参与并发操作</li>\n</ul>\n<h4 id=\"NIO-和-BIO-的比较\">NIO 和 BIO 的比较</h4>\n<ol>\n<li><code>BIO</code> 以<code>流</code>的方式处理数据，而 <code>NIO</code> 以<code>块</code>的方式处理数据， <code>块I/O</code> 的效率比<code>流I/O</code> 高很多。</li>\n<li><code>BIO</code> 是阻塞的，<code>NIO</code> 则是非阻塞的。</li>\n<li><code>BIO</code> 基于字节流(<code>Input/Output Stream</code>)和字符流(<code>reader/writer</code>)进行操作；而 <code>NIO</code> 基于 <code>Channel</code>（通道）和 <code>Buffer</code>（缓冲区）进行操作，数据总是从通道读取到缓冲区中，或者从缓冲区写入到通道中。<code>Selector</code>（选择器）用于监听多个通道的事件（比如：连接请求，数据到达等），因此使用单个线程就可以监听多个客户端通道。</li>\n<li><code>Buffer</code>和<code>Channel</code>之间的数据流向是<code>双向</code>的</li>\n</ol>\n<h4 id=\"BIO、NIO、AIO-对比表\">BIO、NIO、AIO 对比表</h4>\n<table>\n<thead>\n<tr>\n<th>BIO</th>\n<th>NIO</th>\n<th>AIO</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>IO模型</td>\n<td>同步阻塞</td>\n<td>同步非阻塞（多路复用）</td>\n<td>异步非阻塞</td>\n</tr>\n<tr>\n<td>编程难度</td>\n<td>简单</td>\n<td>复杂</td>\n<td>复杂</td>\n</tr>\n<tr>\n<td>可靠性</td>\n<td>差</td>\n<td>好</td>\n<td>好</td>\n</tr>\n<tr>\n<td>吞吐量</td>\n<td>低</td>\n<td>高</td>\n<td>高</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"NIO编程\">NIO编程</h2>\n<blockquote>\n<p>NIO模型</p>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305231415511.png\" alt=\"image-20230523141557415\" style=\"zoom:33%;\">\n</blockquote>\n<h5 id=\"Selector、Channel-和-Buffer-三者的关系\">Selector、Channel 和 Buffer 三者的关系</h5>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305231548513.png\" alt=\"image-20230523154849418\" style=\"zoom:33%;\">\n<ol>\n<li>每个 <code>Channel</code> 都会对应一个 <code>Buffer</code>。</li>\n<li><code>Selector</code> 对应一个线程，一个线程对应多个 <code>Channel</code>（连接）。</li>\n<li>程序切换到哪个 <code>Channel</code> 是<code>由事件Event</code>  决定的</li>\n<li><code>Selector</code> 会根据不同的事件，在各个<code>通道</code>上切换。</li>\n<li><code>Buffer</code> 就是一个<code>内存块</code>，底层是<code>有一个数组</code>。</li>\n<li>数据的读取写入是通过 <code>Buffer</code>，这个和 <code>BIO</code>是不同的\n<ul>\n<li><code>BIO</code> 中要么是输入流，或者是输出流，<code>不能双向</code>，</li>\n<li>但是 <code>NIO</code> 的 <code>Buffer</code> 是可以读也可以写，需要 <code>flip</code> 方法切换 ；</li>\n</ul>\n</li>\n<li><code>Channel</code> 是双向的，可以返回底层操作系统的情况，比如 <code>Linux</code>，底层的操作系统通道就是双向的。</li>\n</ol>\n<h5 id=\"缓冲区-Buffer\">缓冲区(Buffer)</h5>\n<blockquote>\n<p>创建一个缓冲区 <code>ByteBuffer</code>       <code> ByteBuffer byteBuffer = ByteBuffer.allocate(1024);</code></p>\n</blockquote>\n<ul>\n<li>\n<p>本质上是一个<strong>可以读写数据的内存块</strong>，可以理解成是一个<strong>容器对象（含数组）</strong>，该对象提供了一组方法，可以更轻松地使用内存块，缓冲区对象内置了一些机制，能够跟踪和记录缓冲区的状态变化情况。<code>Channel</code> 提供从文件、网络读取数据的渠道，但是读取或写入的数据都必须经由 <code>Buffer</code></p>\n</li>\n<li>\n<p><code>Buffer</code> 类定义了<code>所有的缓冲区</code>都具有的<code>四个属性</code>来提供关于其所包含的数据元素的信息：</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>Capacity</code></td>\n<td>容量，即可以容纳的最大数据量；在缓冲区创建时被设定并且不能改变</td>\n</tr>\n<tr>\n<td><code>Limit</code></td>\n<td>表示缓冲区的当前终点，不能对缓冲区超过极限的位置进行读写操作。且极限是可以修改的</td>\n</tr>\n<tr>\n<td><code>Position</code></td>\n<td>位置，下一个要被读或写的元素的索引，每次读写缓冲区数据时都会改变这个值，为下次读写做准备</td>\n</tr>\n<tr>\n<td><code>Mark</code></td>\n<td>标记</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><code>Buffer</code> 类相关方法</li>\n</ul>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306082338920.png\" alt=\"image-20230608233857839\" style=\"zoom:33%;\">\n<ul>\n<li><code>ByteBuffer</code>的主要方法：</li>\n</ul>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306082341058.png\" alt=\"image-20230608234102039\" style=\"zoom:33%;\">\n<h5 id=\"通道-Channel\">通道(Channel)</h5>\n<ul>\n<li><code>NIO</code>的通道<code>类似于流</code>，但有些区别：\n<ul>\n<li>通道可以同时进行读写(就是说是<code>双向的</code>)，而流只能读或者只能写(就是说是<code>单向的</code>)</li>\n<li>通道可以实现异步读写数据</li>\n<li>通道可以从缓冲读数据，也可以写数据到缓冲</li>\n</ul>\n</li>\n<li>常用的 <code>Channel</code> 类有: <strong><code>FileChannel</code>、<code>DatagramChannel</code>、<code>ServerSocketChannel</code> 和 <code>SocketChannel</code></strong> 。\n<ul>\n<li>【<code>ServerSocketChannel</code> 类似 <code>ServerSocket</code>、<code>SocketChannel</code> 类似 <code>Socket</code>】</li>\n<li><code>FileChannel</code> 用于<code>文件的数据</code>读写</li>\n<li><code>DatagramChannel</code> 用于 <code>UDP</code> 的数据读写</li>\n<li><code>ServerSocketChannel</code> 和 <code>SocketChannel</code> 用于 <code>TCP</code> 的数据读写。</li>\n</ul>\n</li>\n</ul>\n<h6 id=\"FileChannel-类\">FileChannel 类</h6>\n<ul>\n<li><code>FileChannel</code> 主要用来对本地文件进行 <code>IO</code> 操作，常见的方法有\n<ul>\n<li><code>public int read(ByteBuffer dst)</code>，从通道读取数据并放到缓冲区中</li>\n<li><code>public int write(ByteBuffer src)</code>，把缓冲区的数据写到通道中</li>\n<li><code>public long transferFrom(ReadableByteChannel src, long position, long count)</code>，从目标通道中复制数据到当前通道</li>\n<li><code>public long transferTo(long position, long count, WritableByteChannel target)</code>，把数据从当前通道复制给目标通道</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p><code>Buffer</code> 和 <code>channel</code>  使用的注意事项</p>\n<ol>\n<li>\n<p><code>ByteBuffer</code> 支持类型化的 <code>put</code> 和 <code>get</code>，<code>put</code> 放入的是什么数据类型，<code>get</code> 就应该使用相应的数据类型来取出，否则可能有<code>BufferUnderflowException</code> 异常           <code>buffer.putLong(9);     System.out.println(buffer.getLong());</code></p>\n</li>\n<li>\n<p>可以将一个普通 <code>Buffer</code> 转成只读 <code>Buffer</code>        —————<code>ByteBuffer readOnlyBuffer = buffer.asReadOnlyBuffer();</code></p>\n</li>\n<li>\n<p><code>NIO</code> 还提供了 <code>MappedByteBuffer</code>，可以让文件直接在内存（堆外的内存）中进行修改，而如何同步到文件由 <code>NIO</code> 来完成</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t\t<span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">         * 参数 1：  FileChannel.MapMode.READ_WRITE 使用的读写模式</span></span><br><span class=\"line\"><span class=\"comment\">         * 参数 2：  0：可以直接修改的起始位置</span></span><br><span class=\"line\"><span class=\"comment\">         * 参数 3：  5：是映射到内存的大小（不是索引位置），即将 指定文件 的多少个字节映射到内存</span></span><br><span class=\"line\"><span class=\"comment\">         * 可以直接修改的范围就是 0-5</span></span><br><span class=\"line\"><span class=\"comment\">         * 实际类型 DirectByteBuffer</span></span><br><span class=\"line\"><span class=\"comment\">         */</span></span><br><span class=\"line\"><span class=\"type\">MappedByteBuffer</span> <span class=\"variable\">mappedByteBuffer</span> <span class=\"operator\">=</span> channel.map(FileChannel.MapMode.READ_WRITE, <span class=\"number\">0</span>, <span class=\"number\">5</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>前面我们讲的读写操作，都是通过一个 <code>Buffer</code> 完成的，<code>NIO</code> 还支持通过多个 <code>Buffer</code>（即 <code>Buffer</code>数组）完成读写操作，即 <code>Scattering</code> 和 <code>Gathering</code></p>\n</li>\n</ol>\n</blockquote>\n<h5 id=\"选择器-Selector\">选择器(Selector)</h5>\n<ul>\n<li>\n<p>基本介绍</p>\n<ul>\n<li><code>Java</code> 的 <code>NIO</code>，用非阻塞的 <code>IO</code> 方式。可以用一个线程，处理多个的客户端连接，就会使用到 <code>Selector</code>（选择器）</li>\n<li><code>Selector</code> 能够检测多个注册的通道上是否有事件发生（注意：多个 <code>Channel</code> 以事件的方式可以注册到同一个 <code>Selector</code>），如果有事件发生，便获取事件；然后针对每个事件进行相应的处理。这样就可以只用一个单线程去管理多个通道，也就是管理多个连接和请求。</li>\n<li>只有在<code>连接/通道</code>真正有读写事件发生时，才会进行读写，就大大地减少了系统开销，并且不必为每个连接都创建一个线程，不用去维护多个线程</li>\n<li>避免了多线程之间的上下文切换导致的开销</li>\n</ul>\n</li>\n<li>\n<p>说明</p>\n<ul>\n<li><code>Netty</code> 的 <code>IO</code> 线程 <code>NioEventLoop</code> 聚合了 <code>Selector</code>（选择器，也叫多路复用器），可以同时并发处理成百上千个客户端连接</li>\n<li>当线程从某客户端 <code>Socket</code> 通道进行读写数据时，若没有数据可用时，该线程可以进行其他任务</li>\n<li>线程通常将非阻塞 <code>IO</code> 的空闲时间用于在其他通道上执行 <code>IO</code> 操作，所以单独的线程可以管理多个输入和输出通道</li>\n<li>由于读写操作都是非阻塞的，这就可以充分提升 <code>IO</code> 线程的运行效率，避免由于频繁 <code>I/O</code> 阻塞导致的线程挂起。</li>\n<li>一个 <code>I/O</code> 线程可以并发处理 <code>N</code> 个客户端连接和读写操作，这从根本上解决了传统同步阻塞 <code>I/O</code> 一连接一线程模型，架构的性能、弹性伸缩能力和可靠性都得到了极大的提升。</li>\n</ul>\n</li>\n<li>\n<p>相关方法</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Selector类是一个抽象类，常用方法和说明如下：</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Selector</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Closeable</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//得到一个选择器对象</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Selector <span class=\"title function_\">open</span><span class=\"params\">()</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//监控所有注册的通道，当其中有IO操作可以进行时，将对应的SelectionKey加入到内部集合中并返回，参数用来设置超时时间</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">select</span><span class=\"params\">(<span class=\"type\">long</span> timeout)</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//从内部集合中得到所有的SelectionKey</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Set&lt;SelectionKey&gt;selectedKeys;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>注意事项\n<ul>\n<li><code>NIO</code> 中的 <code>ServerSocketChannel</code> 功能类似 <code>ServerSocket</code>、<code>SocketChannel</code> 功能类似 <code>Socket</code>。</li>\n<li><code>Selector</code>相关方法说明\n<ul>\n<li><code>selector.select();</code> //阻塞</li>\n<li><code>selector.select(1000);</code> //阻塞 1000 毫秒，在 1000 毫秒后返回</li>\n<li><code>selector.wakeup();</code> //唤醒 selector</li>\n<li><code>selector.selectNow();</code> //不阻塞，立马返还</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"SelectionKey\">SelectionKey</h5>\n<ul>\n<li>\n<p><code>SelectionKey</code>表示<code>Selector</code>和网络通道的注册关系，共四种：</p>\n<ul>\n<li>\n<p><code>int OP_ACCEPT</code>：有新的网络连接可以 <code>accept</code>，值为 <code>16</code></p>\n</li>\n<li>\n<p><code>int OP_CONNECT</code>：代表连接已经建立，值为 <code>8</code></p>\n</li>\n<li>\n<p><code>int OP_READ</code>：代表读操作，值为 <code>1</code></p>\n</li>\n<li>\n<p><code>int OP_WRITE</code>：代表写操作，值为 <code>4</code></p>\n</li>\n</ul>\n</li>\n<li>\n<p><code>SelectionKey</code> 相关方法</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SelectionKey</span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> Selector <span class=\"title function_\">selector</span><span class=\"params\">()</span>;<span class=\"comment\">//得到与之关联的Selector对象</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> SelectableChannel <span class=\"title function_\">channel</span><span class=\"params\">()</span>;<span class=\"comment\">//得到与之关联的通道</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Object <span class=\"title function_\">attachment</span><span class=\"params\">()</span>;<span class=\"comment\">//得到与之关联的共享数据</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> SelectionKey <span class=\"title function_\">interestOps</span><span class=\"params\">(<span class=\"type\">int</span> ops)</span>;<span class=\"comment\">//设置或改变监听事件</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"title function_\">isAcceptable</span><span class=\"params\">()</span>;<span class=\"comment\">//是否可以accept</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"title function_\">isReadable</span><span class=\"params\">()</span>;<span class=\"comment\">//是否可以读</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"type\">boolean</span> <span class=\"title function_\">isWritable</span><span class=\"params\">()</span>;<span class=\"comment\">//是否可以写</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"ServerSocketChannel\">ServerSocketChannel</h5>\n<ul>\n<li><code>ServerSocketChannel</code> 在服务器端监听新的客户端 <code>Socket</code> 连接</li>\n<li>相关方法如下</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ServerSocketChannel</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractSelectableChannel</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">NetworkChannel</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ServerSocketChannel <span class=\"title function_\">open</span><span class=\"params\">()</span>,<span class=\"comment\">//得到一个ServerSocketChannel通道</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> ServerSocketChannel <span class=\"title function_\">bind</span><span class=\"params\">(SocketAddress local)</span>,<span class=\"comment\">//设置服务器端端口号</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> SelectableChannel <span class=\"title function_\">configureBlocking</span><span class=\"params\">(<span class=\"type\">boolean</span> block)</span>, <span class=\"comment\">//设置阻塞或非阻塞模式，取值false表示采用非阻塞模式</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> SocketChannel <span class=\"title function_\">accept</span><span class=\"params\">()</span>,<span class=\"comment\">//接受一个连接，返回代表这个连接的通道对象</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> SelectionKey <span class=\"title function_\">register</span><span class=\"params\">(Selector sel,<span class=\"type\">int</span> ops)</span>,<span class=\"comment\">//注册一个选择器并设置监听事件</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"SocketChannel\">SocketChannel</h5>\n<ul>\n<li><code>SocketChannel</code>，网络 <code>IO</code> 通道，具体负责进行读写操作。<code>NIO</code> 把缓冲区的数据写入通道，或者把通道里的数据读到缓冲区。</li>\n<li>相关方法如下</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SocketChannel</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractSelectableChannel</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">ByteChannel</span>,ScatteringByteChannel,GatheringByteChannel, NetworkChannel&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> SocketChannel <span class=\"title function_\">open</span><span class=\"params\">()</span>;<span class=\"comment\">//得到一个SocketChannel通道</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> SelectableChannel <span class=\"title function_\">configureBlocking</span><span class=\"params\">(<span class=\"type\">boolean</span> block)</span>;<span class=\"comment\">//设置阻塞或非阻塞模式，取值false表示采用非阻塞模式</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">connect</span><span class=\"params\">(SocketAddress remote)</span>;<span class=\"comment\">//连接服务器</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> finishConnect0;<span class=\"comment\">//如果上面的方法连接失败，接下来就要通过该方法完成连接操作</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">write</span><span class=\"params\">(ByteBuffer src)</span>;<span class=\"comment\">//往通道里写数据</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">read</span><span class=\"params\">(ByteBuffer dst)</span>;<span class=\"comment\">//W从通道里读数据</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> SelectionKey <span class=\"title function_\">register</span><span class=\"params\">(Selector sel,<span class=\"type\">int</span> ops,Object att)</span>;<span class=\"comment\">//注册一个选择器并设置监听事件，最后一个参数可以设置共享数据</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> close0;<span class=\"comment\">//关闭通道</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"NIO-非阻塞网络编程原理分析\">NIO 非阻塞网络编程原理分析</h5>\n<ul>\n<li>当客户端连接时，会通过 <code>ServerSocketChannel</code> 得到 <code>SocketChannel</code>。</li>\n<li><code>Selector</code> 进行监听 <code>select</code> 方法，返回有事件发生的通道的个数。</li>\n<li>将 <code>socketChannel</code> 注册到 <code>Selector</code> 上，注册使用<code>register(Selector sel, int ops)</code>，一个 <code>Selector</code> 上可以注册多个 <code>SocketChannel</code>。</li>\n<li>注册后返回一个 <code>SelectionKey</code>，会和该 <code>Selector</code> 关联（集合）。</li>\n<li>进一步得到各个 <code>SelectionKey</code>（有事件发生）。</li>\n<li>在通过 <code>SelectionKey</code> 反向获取 <code>SocketChannel</code>的 <code>channel()</code>方法</li>\n<li>可以通过得到的 <code>channel</code>，完成业务处理。</li>\n</ul>\n<h5 id=\"NIO的群聊系统的实现思路：\">NIO的群聊系统的实现思路：</h5>\n<ul>\n<li>\n<p>服务端：</p>\n<ul>\n<li>\n<p>通道的准备阶段&lt;构造器&gt;</p>\n<ul>\n<li>得到选择器<code>Selector</code></li>\n<li>建立<code>ServerSocketChannel</code>的连接通道</li>\n<li>为<code>ServerSocketChannel</code>通道绑定端口</li>\n<li>将<code>ServerSocketChannel</code>通道设置为非阻塞的模式</li>\n<li>将<code>ServerSocketChannel</code>通道注册到<code>Selector</code>中，注册的时候要写上<code>关注</code>的事件</li>\n</ul>\n</li>\n<li>\n<p>监听(<code>listen</code>)阶段</p>\n<ul>\n<li>有事件处理的话就由迭代器遍历<code>selectionKey</code>的<code>集合</code>，取出每一个<code>selectionKey</code>，监听事件类型是哪一类\n<ul>\n<li>如果通道发送的是连接事件，即<code>accept</code>连接事件的话\n<ul>\n<li>将上面的通道进行连接，得到<code>SocketChannel</code>,同样的将<code>SocketChannel</code>设置为非阻塞模式,注册到<code>selector</code>中</li>\n</ul>\n</li>\n<li>如果通道发送的是可读事件，是<code>read</code>的读事件的话\n<ul>\n<li>就调用处理读的方法<code>readData(key)</code>   [见下面   读取客户端消息阶段][]</li>\n</ul>\n</li>\n<li>最后删除当前的<code>selectionKey</code> 防止重复处理的现象发生</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>读取客户端消息阶段</p>\n<ul>\n<li>\n<p>通过上面的<code>selectionKey</code>取得对应的<code>SocketChannel</code>的通道</p>\n</li>\n<li>\n<p>创建<code>buffer</code>并分配大小</p>\n</li>\n<li>\n<p>通道进行读取到<code>buffer</code>中，并得到读取到的长度<code>count</code></p>\n</li>\n<li>\n<p>如果长度<code>count&gt;0</code>,就将缓存区的数据转成字符串</p>\n</li>\n<li>\n<p>然后向其他  客户端 转发消息，&lt;排除自己<code>sendInfoToOtherClients(msg, channel)  channel 当前的通道，随后要进行排除</code>&gt;</p>\n<ul>\n<li>排除自己\n<ul>\n<li>遍历所有注册到 <code>selector</code> 上的 <code>SocketChannel</code> ，从 <code>selector</code>中的<code>keys</code> 集合取出 <code>SelectionKey</code></li>\n<li>随后从<code>SelectionKey</code>中取出<code>SocketChannel   (targetChannel)</code></li>\n<li>只要不是自己<code>targetChannel != self</code>\n<ul>\n<li>就可以 将 <code>msg</code> 存储到 <code>buffer</code>,并将<code>buffer</code> 的数据写入通道</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>但是如果出现异常，需要取消注册 + 关闭通道</p>\n</li>\n<li>\n<p>主函数中，直接 <code>new</code> 一个<code>服务器对象</code>，然后调用 <code>listen</code>方法即可</p>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">GroupChatServer</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//定义属性</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Selector selector;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> ServerSocketChannel listenChannel;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">PORT</span> <span class=\"operator\">=</span> <span class=\"number\">6667</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//构造器</span></span><br><span class=\"line\">    <span class=\"comment\">//初始化工作</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">GroupChatServer</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//得到选择器</span></span><br><span class=\"line\">            selector = Selector.open();</span><br><span class=\"line\">            <span class=\"comment\">//ServerSocketChannel</span></span><br><span class=\"line\">            listenChannel = ServerSocketChannel.open();</span><br><span class=\"line\">            <span class=\"comment\">//绑定端口</span></span><br><span class=\"line\">            listenChannel.socket().bind(<span class=\"keyword\">new</span> <span class=\"title class_\">InetSocketAddress</span>(PORT));</span><br><span class=\"line\">            <span class=\"comment\">//设置非阻塞模式</span></span><br><span class=\"line\">            listenChannel.configureBlocking(<span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"comment\">//将该 listenChannel 注册到 selector</span></span><br><span class=\"line\">            listenChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">listen</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//循环处理</span></span><br><span class=\"line\">            <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">                <span class=\"type\">int</span> <span class=\"variable\">count</span> <span class=\"operator\">=</span> selector.select();</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (count &gt; <span class=\"number\">0</span>) &#123; <span class=\"comment\">//有事件处理</span></span><br><span class=\"line\">                    <span class=\"comment\">// 遍历得到 selectionKey 集合</span></span><br><span class=\"line\">                    Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class=\"line\">                    <span class=\"keyword\">while</span> (iterator.hasNext()) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">//取出 selectionkey</span></span><br><span class=\"line\">                        <span class=\"type\">SelectionKey</span> <span class=\"variable\">key</span> <span class=\"operator\">=</span> iterator.next();</span><br><span class=\"line\">                        <span class=\"comment\">//监听到 accept</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (key.isAcceptable()) &#123;</span><br><span class=\"line\">                            <span class=\"type\">SocketChannel</span> <span class=\"variable\">sc</span> <span class=\"operator\">=</span> listenChannel.accept();</span><br><span class=\"line\">                            sc.configureBlocking(<span class=\"literal\">false</span>);</span><br><span class=\"line\">                            <span class=\"comment\">//将该 sc 注册到 seletor</span></span><br><span class=\"line\">                            sc.register(selector, SelectionKey.OP_READ);</span><br><span class=\"line\">                            <span class=\"comment\">//提示</span></span><br><span class=\"line\">                            System.out.println(sc.getRemoteAddress() + <span class=\"string\">&quot; 上线 &quot;</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (key.isReadable()) &#123;<span class=\"comment\">//通道发送read事件，即通道是可读的状态</span></span><br><span class=\"line\">                            <span class=\"comment\">// 处理读(专门写方法..)</span></span><br><span class=\"line\">                            readData(key);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        <span class=\"comment\">//当前的 key 删除，防止重复处理</span></span><br><span class=\"line\">                        iterator.remove();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;等待....&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//发生异常处理....</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//读取客户端消息</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">readData</span><span class=\"params\">(SelectionKey key)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">SocketChannel</span> <span class=\"variable\">channel</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//得到 channel</span></span><br><span class=\"line\">            channel = (SocketChannel) key.channel();</span><br><span class=\"line\">            <span class=\"comment\">//创建 buffer</span></span><br><span class=\"line\">            <span class=\"type\">ByteBuffer</span> <span class=\"variable\">buffer</span> <span class=\"operator\">=</span> ByteBuffer.allocate(<span class=\"number\">1024</span>);</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">count</span> <span class=\"operator\">=</span> channel.read(buffer);</span><br><span class=\"line\">            <span class=\"comment\">//根据 count 的值做处理</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (count &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//把缓存区的数据转成字符串</span></span><br><span class=\"line\">                <span class=\"type\">String</span> <span class=\"variable\">msg</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>(buffer.array());</span><br><span class=\"line\">                <span class=\"comment\">//输出该消息</span></span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;form客户端:&quot;</span> + msg);</span><br><span class=\"line\">                <span class=\"comment\">//向其它的客户端转发消息(去掉自己),专门写一个方法来处理</span></span><br><span class=\"line\">                sendInfoToOtherClients(msg, channel);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                System.out.println(channel.getRemoteAddress() + <span class=\"string\">&quot;离线了..&quot;</span>);</span><br><span class=\"line\">                <span class=\"comment\">//取消注册</span></span><br><span class=\"line\">                key.cancel();</span><br><span class=\"line\">                <span class=\"comment\">//关闭通道</span></span><br><span class=\"line\">                channel.close();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e2) &#123;</span><br><span class=\"line\">                e2.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//转发消息给其它客户(通道)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sendInfoToOtherClients</span><span class=\"params\">(String msg, SocketChannel self)</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器转发消息中...&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//遍历所有注册到 selector 上的 SocketChannel,并排除 self</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (SelectionKey key : selector.keys()) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//通过 key 取出对应的 SocketChannel</span></span><br><span class=\"line\">            <span class=\"type\">Channel</span> <span class=\"variable\">targetChannel</span> <span class=\"operator\">=</span> key.channel();</span><br><span class=\"line\">            <span class=\"comment\">//排除自己</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (targetChannel <span class=\"keyword\">instanceof</span> SocketChannel &amp;&amp; targetChannel != self) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//转型</span></span><br><span class=\"line\">                <span class=\"type\">SocketChannel</span> <span class=\"variable\">dest</span> <span class=\"operator\">=</span> (SocketChannel) targetChannel;</span><br><span class=\"line\">                <span class=\"comment\">//将 msg 存储到 buffer</span></span><br><span class=\"line\">                <span class=\"type\">ByteBuffer</span> <span class=\"variable\">buffer</span> <span class=\"operator\">=</span> ByteBuffer.wrap(msg.getBytes());</span><br><span class=\"line\">                <span class=\"comment\">//将 buffer 的数据写入通道</span></span><br><span class=\"line\">                dest.write(buffer);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//创建服务器对象</span></span><br><span class=\"line\">        <span class=\"type\">GroupChatServer</span> <span class=\"variable\">groupChatServer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">GroupChatServer</span>();</span><br><span class=\"line\">        groupChatServer.listen();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>客户端</p>\n<ul>\n<li>初始化阶段&lt;构造器&gt;\n<ul>\n<li>得到选择器<code>Selector</code></li>\n<li>将通道<code>SocketChannel</code>连接到服务器(传入<code>端口和ip地址</code>)</li>\n<li>将<code>SocketChannel</code>通道设置为非阻塞的模式</li>\n<li>将<code>SocketChannel</code>通道注册到<code>Selector</code>中，注册的时候要写上<code>关注</code>的事件</li>\n</ul>\n</li>\n<li>向服务器<code>发送</code>消息阶段(<code>sendInfo()</code>)\n<ul>\n<li>将消息通过<code>SocketChannel</code>写到<code>buffer</code>中并进行发送<code> socketChannel.write(ByteBuffer.wrap(info.getBytes()));</code></li>\n</ul>\n</li>\n<li><code>读取</code>从服务器端回复的消息阶段(<code>readInfo()</code>)\n<ul>\n<li>由<code>selector</code>选择器<code>selector.select()</code>选择通道得到通道的个数</li>\n<li>一旦有可用的通道\n<ul>\n<li>就得迭代的获取得到<code>SelectionKey</code>的集合</li>\n<li>遍历上述集合，判断通道发送的事件\n<ul>\n<li>通道是可读的通道，即通道发送的是可读<code>read</code>事件\n<ul>\n<li>先得到相关的<code>SocketChannel</code>通道</li>\n<li>再创建并分配一个<code>Buffer</code></li>\n<li>由<code>SocketChannel</code>通道读取数据到<code>Buffer</code>中</li>\n<li>并把读到的<code>缓冲区</code>的数据转成字符串</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>最后删除当前的 selectionKey,防止重复操作</li>\n</ul>\n</li>\n<li>没有可用的通道\n<ul>\n<li>可以不做任何处理</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>主函数中\n<ul>\n<li>new 一个<code>客户端对象</code></li>\n<li>创建一个线程，在<code>run</code>方法中，由<code>new</code> 出来的对象调用读取消息的方法<code>readInfo()</code></li>\n<li>再通过<code>Java</code>输入<code>Scanner</code>执行调用发送消息的方法<code>sendInfo()</code></li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">GroupChatClient</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//定义相关的属性</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">HOST</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;127.0.0.1&quot;</span>;<span class=\"comment\">//服务器的ip</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">PORT</span> <span class=\"operator\">=</span> <span class=\"number\">6667</span>;<span class=\"comment\">//服务器端口</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Selector selector;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> SocketChannel socketChannel;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String username;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//构造器,完成初始化工作</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">GroupChatClient</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        selector = Selector.open();</span><br><span class=\"line\">        <span class=\"comment\">//连接服务器</span></span><br><span class=\"line\">        socketChannel = SocketChannel.open(<span class=\"keyword\">new</span> <span class=\"title class_\">InetSocketAddress</span>(HOST, PORT));</span><br><span class=\"line\">        <span class=\"comment\">//设置非阻塞</span></span><br><span class=\"line\">        socketChannel.configureBlocking(<span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"comment\">//将 channel 注册到selector</span></span><br><span class=\"line\">        socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class=\"line\">        <span class=\"comment\">//得到 username</span></span><br><span class=\"line\">        username = socketChannel.getLocalAddress().toString().substring(<span class=\"number\">1</span>);</span><br><span class=\"line\">        System.out.println(username + <span class=\"string\">&quot; is ok...&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//向服务器发送消息</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sendInfo</span><span class=\"params\">(String info)</span> &#123;</span><br><span class=\"line\">        info = username + <span class=\"string\">&quot; 说：&quot;</span> + info;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            socketChannel.write(ByteBuffer.wrap(info.getBytes()));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//读取从服务器端回复的消息</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">readInfo</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">readChannels</span> <span class=\"operator\">=</span> selector.select();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (readChannels &gt; <span class=\"number\">0</span>) &#123;<span class=\"comment\">//有可以用的通道</span></span><br><span class=\"line\">                Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class=\"line\">                <span class=\"keyword\">while</span> (iterator.hasNext()) &#123;</span><br><span class=\"line\">                    <span class=\"type\">SelectionKey</span> <span class=\"variable\">key</span> <span class=\"operator\">=</span> iterator.next();</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (key.isReadable()) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">//得到相关的通道</span></span><br><span class=\"line\">                        <span class=\"type\">SocketChannel</span> <span class=\"variable\">sc</span> <span class=\"operator\">=</span> (SocketChannel) key.channel();</span><br><span class=\"line\">                        <span class=\"comment\">//得到一个 Buffer</span></span><br><span class=\"line\">                        <span class=\"type\">ByteBuffer</span> <span class=\"variable\">buffer</span> <span class=\"operator\">=</span> ByteBuffer.allocate(<span class=\"number\">1024</span>);</span><br><span class=\"line\">                        <span class=\"comment\">//读取</span></span><br><span class=\"line\">                        sc.read(buffer);</span><br><span class=\"line\">                        <span class=\"comment\">//把读到的缓冲区的数据转成字符串</span></span><br><span class=\"line\">                        <span class=\"type\">String</span> <span class=\"variable\">msg</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>(buffer.array());</span><br><span class=\"line\">                        System.out.println(msg.trim());</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                iterator.remove(); <span class=\"comment\">//删除当前的 selectionKey,防止重复操作</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//System.out.println(&quot;没有可以用的通道...&quot;);</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//启动我们客户端</span></span><br><span class=\"line\">        <span class=\"type\">GroupChatClient</span> <span class=\"variable\">chatClient</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">GroupChatClient</span>();</span><br><span class=\"line\">        <span class=\"comment\">//启动一个线程,每个 3 秒，读取从服务器发送数据</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>() &#123;</span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">                    chatClient.readInfo();</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        Thread.currentThread().sleep(<span class=\"number\">3000</span>);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                        e.printStackTrace();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;.start();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//发送数据给服务器端</span></span><br><span class=\"line\">        <span class=\"type\">Scanner</span> <span class=\"variable\">scanner</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Scanner</span>(System.in);</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (scanner.hasNextLine()) &#123;</span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">s</span> <span class=\"operator\">=</span> scanner.nextLine();</span><br><span class=\"line\">            chatClient.sendInfo(s);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"零拷贝\">零拷贝</h2>\n<ul>\n<li>在 <code>Java</code> 程序中，常用的零拷贝有 <code>mmap</code>（内存映射）和 <code>sendFile</code>\n<ul>\n<li><code>mmap</code> 通过<code>内存映射</code>，将文件映射到内核缓冲区，同时，用户空间可以共享内核空间的数据。这样，在进行网络传输时，就可以减少内核空间到用户空间的拷贝次数。</li>\n<li><code>sendFile</code> 其基本原理如下：数据不经过用户态，直接从内核缓冲区进入到 <code>SocketBuffer</code>，同时，由于和用户态完全无关，就减少了一次上下文切换</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"mmap-和-sendFile-的区别\">mmap 和 sendFile 的区别</h3>\n<ol>\n<li><code>mmap</code> 适合小数据量读写，<code>sendFile</code> 适合大文件传输。</li>\n<li><code>mmap</code> 需要 <code>4</code> 次上下文切换，<code>3</code> 次数据拷贝；<code>sendFile</code> 需要 <code>3</code> 次上下文切换，最少 <code>2</code> 次数据拷贝。</li>\n<li><code>sendFile</code> 可以利用 <code>DMA</code> 方式，减少 <code>CPU</code> 拷贝，<code>mmap</code> 则不能（必须从内核拷贝到 <code>Socket</code>缓冲区）。</li>\n</ol>\n<p>零拷贝理解</p>\n<ul>\n<li>我们说零拷贝，是从操作系统的角度来说的。因为内核缓冲区之间，没有数据是重复的（只有 <code>kernel buffer</code> 有一份数据）。</li>\n<li>零拷贝不仅仅带来更少的数据复制，还能带来其他的性能优势，例如更少的上下文切换，更少的 <code>CPU</code> 缓存伪共享以及无 <code>CPU</code> 校验和计算。</li>\n</ul>\n<blockquote>\n<p><code>transferTo </code>底层使用到零拷贝</p>\n</blockquote>\n<h1>Netty概述</h1>\n<ul>\n<li>优点\n<ul>\n<li><code>设计优雅</code>：适用于各种传输类型的统一 <code>API</code> 阻塞和非阻塞 <code>Socket</code>；基于灵活且可扩展的事件模型，可以清晰地分离关注点；高度可定制的线程模型-单线程，一个或多个线程池。</li>\n<li><code>使用方便</code>：详细记录的 <code>Javadoc</code>，用户指南和示例；没有其他依赖项，<code>JDK5（Netty3.x）</code>或 <code>6（Netty4.x）</code>就足够了。</li>\n<li><code>高性能、吞吐量更高</code>：延迟更低；减少资源消耗；最小化不必要的内存复制。</li>\n<li><code>安全</code>：完整的 <code>SSL/TLS</code> 和 <code>StartTLS</code> 支持。</li>\n<li><code>社区活跃、不断更新</code>：社区活跃，版本迭代周期短，发现的 <code>Bug</code> 可以被及时修复，同时，更多的新功能会被加入。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"Netty-高性能架构设计\">Netty 高性能架构设计</h2>\n<h3 id=\"线程模型\">线程模型</h3>\n<h4 id=\"传统阻塞-I-O-服务模型\">传统阻塞 <code>I/O</code> 服务模型</h4>\n<ul>\n<li>特点\n<ul>\n<li>采用阻塞 <code>IO</code> 模式获取输入的数据</li>\n<li>每个连接都需要独立的线程完成数据的输入，业务处理，数据返回</li>\n</ul>\n</li>\n<li>原理\n<ul>\n<li>当用户线程发起 <code>I/O</code> 请求时，内核会暂停当前线程并将其添加到等待队列中</li>\n<li>当数据准备好后，<code>内核会将</code>数据<code>复制</code>到用户线程<code>缓冲区</code>，并将<code>用户线程</code>从<code>等待队列</code>中<code>唤醒</code>，使其<code>继续执行</code>后续指令</li>\n</ul>\n</li>\n<li>问题\n<ul>\n<li>当<code>并发数很大</code>，就会<code>创建大量的线程</code>，占用很大系统资源</li>\n<li>连接创建后，如果当前线程<code>暂时没有数据可读</code>，该线程会阻塞在 <code>Handler</code>对象中的<code>read</code> 操作，导致之前处理线程的资源浪费</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"Reactor-模式\">==Reactor 模式==</h4>\n<blockquote>\n<p><code>Netty</code> 线程模式（<code>Netty</code> 主要基于主从 <code>Reactor</code> 多线程模型做了一定的改进，其中主从 <code>Reactor</code> 多线程模型有多个 <code>Reactor</code>）</p>\n<p><code>Reactor</code> 又称为 <code>反应器模式</code>   <code>分发者模式</code>   <code>通知者模式</code></p>\n</blockquote>\n<ul>\n<li>\n<p>两种方式<code>复用</code>资源</p>\n<ul>\n<li>基于<code>线程池</code>复用线程资源：不必再为每个连接创建线程，将连接完成后的<code>业务处理任务</code>分配<code>给线程进行处理</code>，一个线程可以处理多个连接的业务。（解决了当并发数很大时，会创建大量线程，占用很大系统资源）</li>\n<li>基于 <code>I/O</code> 复用模型：多个客户端进行连接，先把连接请求给<code>ServiceHandler</code>。多个连接共用一个阻塞对象<code>ServiceHandler</code>。\n<ul>\n<li>假设，当C1连接没有数据要处理时，C1客户端只需要阻塞于<code>ServiceHandler</code>，C1之前的处理线程便可以处理其他有数据的连接，不会造成线程资源的浪费。当C1连接再次有数据时，<code>ServiceHandler</code>根据线程池的空闲状态，将请求分发给空闲的线程来处理C1连接的任务。（解决了线程资源浪费的那个问题）</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><code>Reactor</code>思想：<code>I/O 复用</code>结合<code>线程池</code>，就是 <code>Reactor</code> 模式基本设计思想</p>\n</li>\n</ul>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306122255390.png\" alt=\"image-20230612225512336\" style=\"zoom:33%;\">\n<blockquote>\n<p>说明：</p>\n<ul>\n<li><code>Reactor</code> 模式，通过一个或多个输入同时传递给<code>服务处理器（ServiceHandler）的模式</code>（基于事件驱动）</li>\n<li>服务器端程序处理传入的<code>多个请求</code>,并将它们<code>同步分派</code>到相应的处理线程，因此 <code>Reactor</code> 模式也叫 <code>Dispatcher</code> 模式</li>\n<li><code>Reactor</code> 模式使用 <code>IO</code> 复用监听事件，收到事件后，分发给某个线程（进程），这点就是<code>网络服务器高并发处理关键</code></li>\n<li>原先有<code>多个Handler</code>阻塞，现在只用一个<code>ServiceHandler</code>阻塞</li>\n</ul>\n</blockquote>\n<ul>\n<li><code>Reactor</code> 模式中的核心组成\n<ul>\n<li><code>Reactor</code>：<code>Reactor</code> 在一个单独的线程中运行，负责监听和分发事件，分发给对应的处理程序对 <code>IO</code> 事件做出反应</li>\n<li><code>Handlers</code>：处理程序执行 <code>I/O</code> 事件要完成的实际事件</li>\n<li><code>Reactor</code> 通过调度进行处理程序，从而响应 <code>I/O</code> 事件，处理程序是执行非阻塞操作的</li>\n</ul>\n</li>\n<li>根据<code>Reactor</code>的数量和处理资源池线程的数量不同，有<code>3</code>种典型的实现\n<ul>\n<li>单 <code>Reactor</code> 单线程</li>\n<li>单 <code>Reactor</code>多线程</li>\n<li>主从 <code>Reactor</code>多线程</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"单Reactor单线程\">单<code>Reactor</code>单线程</h5>\n<ul>\n<li>\n<p>原理图</p>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306122335736.png\" alt=\"image-20230612233549685\" style=\"zoom:33%;\">\n</li>\n<li>\n<p>说明</p>\n<ul>\n<li><code>Select</code> 是标准网络编程 <code>API</code>，可以实现应用程序通过一个阻塞对象<code>监听</code>多路连接请求</li>\n<li><code>Reactor</code> 对象通过 <code>Select</code> 监控客户端请求事件，收到事件后通过 <code>Dispatch</code> 进行分发\n<ul>\n<li>如果是建立连接请求事件，则由 <code>Acceptor</code> 通过 <code>Accept</code> 处理连接请求，然后创建一个 <code>Handler</code> 对象处理连接完成后的后续业务处理</li>\n<li>如果不是建立连接事件，则 <code>Reactor</code> 会分发调用连接对应的 <code>Handler</code> 来响应</li>\n</ul>\n</li>\n<li><code>Handler</code> 会完成 <code>Read</code> → 业务处理 → <code>Send</code>    的完整业务流程</li>\n</ul>\n</li>\n<li>\n<p>优缺点</p>\n<ul>\n<li>优点：模型简单，没有多线程、进程通信、竞争的问题，全部都在一个线程中完成</li>\n<li>缺点：\n<ul>\n<li>性能问题，只有一个线程，无法完全发挥多核 <code>CPU</code> 的性能。<code>Handler</code>在处理某个连接上的业务时，整个进程无法处理其他连接事件，很容易导致性能瓶颈</li>\n<li>可靠性问题，线程意外终止，或者进入死循环，会导致整个系统通信模块不可用，不能接收和处理外部消息，造成节点故障</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>使用场景：客户端的数量有限，业务处理非常快速，比如 <code>Redis</code> 在业务处理的时间复杂度 <code>O(1)</code> 的情况</p>\n</li>\n</ul>\n<h5 id=\"单Reactor多线程\">单<code>Reactor</code>多线程</h5>\n<ul>\n<li>原理图</li>\n</ul>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306122344738.png\" alt=\"image-20230612234419683\" style=\"zoom:43%;\">\n<ul>\n<li>\n<p>说明</p>\n<ul>\n<li><code>Reactor</code> 对象通过 <code>Select</code> 监控客户端请求事件，收到事件后，通过 <code>Dispatch</code> 进行分发</li>\n<li>如果是建立连接请求，则由 <code>Acceptor</code> 通过 <code>accept</code> 处理连接请求，然后创建一个 <code>Handler</code> 对象处理完成连接后的各种事件</li>\n<li>如果不是连接请求，则由 <code>Reactor</code> 分发调用连接对应的 <code>handler</code> 来处理（也就是说连接已经建立，后续客户端再来请求，那基本就是数据请求了，直接调用之前为这个连接创建好的handler来处理）</li>\n<li><code>handler</code> 只负责响应事件，不做具体的业务处理（这样不会使<code>handler</code>阻塞太久），通过 <code>read</code> 读取数据后，会分发给后面的 <code>worker</code> 线程池的某个线程处理业务。【业务处理是最费时的，所以将业务处理交给线程池去执行】</li>\n<li><code>worker</code> 线程池会分配独立线程完成真正的业务，并将结果返回给 <code>handler</code></li>\n<li><code>handler</code> 收到响应后，通过 <code>send</code> 将结果返回给 <code>client</code></li>\n</ul>\n</li>\n<li>\n<p>优缺点</p>\n<ul>\n<li>优点：可以充分的利用多核 <code>cpu</code> 的处理能力</li>\n<li>缺点：多线程数据共享和访问比较复杂。<code>Reactor</code> 承担所有的事件的监听和响应，它是单线程运行，在高并发场景容易出现性能瓶颈。也就是说<code>Reactor</code>主线程承担了过多的事</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"主从-Reactor多线程\">主从 <code>Reactor</code>多线程</h5>\n<ul>\n<li>原理图</li>\n</ul>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306130000834.png\" alt=\"image-20230613000019272\" style=\"zoom:53%;\">\n<ul>\n<li>\n<p>说明</p>\n<blockquote>\n<p><code>SubReactor</code>是可以有<code>多个</code>的，如果只有一个<code>SubReactor</code>的话那和<code>单 Reactor 多线程</code>就没什么区别了</p>\n</blockquote>\n<ul>\n<li><code>Reactor</code> 主线程 <code>MainReactor</code> 对象通过 <code>select</code> 监听连接事件，收到事件后，通过 <code>Acceptor</code> 处理连接事件</li>\n<li>当 <code>Acceptor</code> 处理连接事件后，<code>MainReactor</code> 将连接分配给 <code>SubReactor</code></li>\n<li><code>subreactor</code> 将连接加入到连接队列进行监听，并创建 <code>handler</code> 进行各种事件处理</li>\n<li>当有新事件发生时，<code>subreactor</code> 就会调用对应的 <code>handler</code> 处理</li>\n<li><code>handler</code> 通过 <code>read</code> 读取数据，分发给后面的 <code>worker</code> 线程处理</li>\n<li><code>worker</code> 线程池分配独立的 <code>worker</code> 线程进行业务处理，并返回结果</li>\n<li><code>handler</code> 收到响应的结果后，再通过 <code>send</code> 将结果返回给 <code>client</code></li>\n<li><code>Reactor</code> 主线程可以对应多个 <code>Reactor</code> 子线程，即 <code>MainRecator</code> 可以关联多个 <code>SubReactor</code></li>\n</ul>\n</li>\n<li>\n<p>优缺点</p>\n<ul>\n<li>优点：\n<ul>\n<li>父线程与子线程的数据交互简单职责明确，父线程只需要接收新连接，子线程完成后续的业务处理。</li>\n<li>父线程与子线程的数据交互简单，<code>Reactor</code> 主线程只需要把新连接传给子线程，子线程无需返回数据。</li>\n</ul>\n</li>\n<li>缺点：编程复杂度较高</li>\n</ul>\n</li>\n<li>\n<p>适用举例：<code>Nginx</code> 主从 <code>Reactor</code> 多进程模型，<code>Memcached</code> 主从多线程，<code>Netty</code> 主从多线程模型的支持</p>\n</li>\n</ul>\n<h5 id=\"Reactor的总结\"><code>Reactor</code>的总结</h5>\n<h6 id=\"3-种模式用生活案例理解\">3 种模式用生活案例理解</h6>\n<ol>\n<li>单 <code>Reactor</code> 单线程，前台接待员和服务员是同一个人，全程为顾客服务</li>\n<li>单 <code>Reactor</code> 多线程，<code>1</code> 个前台接待员，多个服务员，接待员只负责接待</li>\n<li>主从 <code>Reactor</code> 多线程，多个前台接待员，多个服务生</li>\n</ol>\n<h6 id=\"Reactor的优点\">Reactor的优点</h6>\n<ul>\n<li>响应快，不必为单个同步时间所阻塞，虽然 <code>Reactor</code> 本身依然是同步的</li>\n<li>可以最大程度的避免复杂的多线程及同步问题，并且避免了多线程/进程的切换开销</li>\n<li>扩展性好，可以方便的通过增加 <code>Reactor</code> 实例个数来充分利用 <code>CPU</code> 资源</li>\n<li>复用性好，<code>Reactor</code> 模型本身与具体事件处理逻辑无关，具有很高的<code>复用性</code></li>\n</ul>\n<h3 id=\"Netty模型\">Netty模型</h3>\n<ul>\n<li>原理图</li>\n</ul>\n<blockquote>\n<p>下图中<code>NioEventLoopGroup</code> 都改为<code>NioEventLoopLoop</code></p>\n</blockquote>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306130832067.png\" alt=\"image-20230613083231009\" style=\"zoom:33%;\">\n<ul>\n<li>说明\n<ul>\n<li><code>Netty</code> 抽象出两组线程池 <code>BossGroup</code> 专门负责接收客户端的连接，<code>WorkerGroup</code> 专门负责网络的读写</li>\n<li><code>BossGroup</code> 和 <code>WorkerGroup</code> 类型都是 <code>NioEventLoopGroup</code></li>\n<li><code>NioEventLoopGroup</code> 相当于一个事件循环组，这个组中含有多个事件循环，每一个事件循环是 <code>NioEventLoop</code></li>\n<li><code>NioEventLoop</code> 表示一个不断循环的执行处理任务的线程，每个 <code>NioEventLoop</code> 都有一个 <code>Selector</code>，用于监听绑定在其上的 <code>socket</code> 的网络通讯</li>\n<li><code>NioEventLoopGroup</code> 可以有多个线程，即可以含有多个 <code>NioEventLoop</code></li>\n<li>每个<code>BossNioEventLoop</code>循环执行的步骤有<code>3</code>步\n<ul>\n<li>轮询 <code>accept</code> 事件</li>\n<li>处理 <code>accept</code> 事件，与 <code>client</code> 建立连接，生成 <code>NioScocketChannel</code>，并将其注册到某个 <code>worker</code>即  <code>NIOEventLoop</code> 上的 <code>Selector</code></li>\n<li>处理任务队列的任务，即 <code>runAllTasks</code></li>\n</ul>\n</li>\n<li>每个<code>Worker</code> <code>NIOEventLoop</code>循环执行的步骤\n<ul>\n<li>轮询 <code>read</code>，<code>write</code> 事件</li>\n<li>处理 <code>I/O</code> 事件，即 <code>read</code>，<code>write</code> 事件，在对应 <code>NioScocketChannel</code> 处理</li>\n<li>处理任务队列的任务，即 <code>runAllTasks</code></li>\n</ul>\n</li>\n<li>每个 <code>Worker</code> <code>NIOEventLoop</code> 处理业务时，会使用 <code>pipeline</code>（管道），<code>pipeline</code> 中包含了 <code>channel</code>，即通过 <code>pipeline</code> 可以获取到对应通道，管道中维护了很多的处理器</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"快速入门案例\">快速入门案例</h4>\n<blockquote>\n<p>基于上述步骤</p>\n</blockquote>\n<ul>\n<li>服务器端\n<ul>\n<li>创建<code>BossGroup</code> 和 <code>WorkerGroup</code></li>\n<li><code>bossGroup</code> 只是处理连接请求 ，但是真正对客户端业务进行的处理，是会交给 <code>workerGroup</code>完成  (注意两个都是无限循环)\n<ul>\n<li>含有的子线程(<code>NioEventLoop</code>)的个数默认的是<code>实际 cpu核数 * 2</code></li>\n</ul>\n</li>\n<li>创建<code>服务器端</code>的启动对象，配置对应的参数</li>\n<li>启动服务器 并 绑定一个端口并且同步, 生成了一个 <code>ChannelFuture</code> 对象</li>\n<li>给  <code>ChannelFuture</code> 对象 注册监听器，监控我们关心的事件</li>\n<li>监听 关闭通道</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyServer</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">bossGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">workerGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(); <span class=\"comment\">//8</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//创建服务器端的启动对象，配置参数</span></span><br><span class=\"line\">            <span class=\"type\">ServerBootstrap</span> <span class=\"variable\">bootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ServerBootstrap</span>();</span><br><span class=\"line\">            <span class=\"comment\">//使用链式编程来进行设置</span></span><br><span class=\"line\">            bootstrap.group(bossGroup, workerGroup) <span class=\"comment\">//设置两个线程组</span></span><br><span class=\"line\">                    .channel(NioServerSocketChannel.class) <span class=\"comment\">//使用NioSocketChannel 作为服务器的通道实现</span></span><br><span class=\"line\">                    .option(ChannelOption.SO_BACKLOG, <span class=\"number\">128</span>) <span class=\"comment\">// 设置线程队列得到连接个数</span></span><br><span class=\"line\">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class=\"literal\">true</span>) <span class=\"comment\">//设置保持活动连接状态</span></span><br><span class=\"line\">            <span class=\"comment\">//          .handler(null) // 该 handler对应 bossGroup , childHandler 对应 workerGroup</span></span><br><span class=\"line\">                    .childHandler(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;<span class=\"comment\">//创建一个通道初始化对象(匿名对象)</span></span><br><span class=\"line\">                        <span class=\"comment\">//给pipeline 设置处理器,就是给 workerGroup 的 EventLoop 对应的管道设置处理器</span></span><br><span class=\"line\">                        <span class=\"meta\">@Override</span></span><br><span class=\"line\">                        <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                            System.out.println(<span class=\"string\">&quot;客户socketchannel hashcode=&quot;</span> + ch.hashCode()); <span class=\"comment\">//可以使用一个集合管理 SocketChannel， 再推送消息时，可以将业务加入到各个channel 对应的 NIOEventLoop 的 taskQueue 或者 scheduleTaskQueue</span></span><br><span class=\"line\">                            ch.pipeline().addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">NettyServerHandler</span>());</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;); </span><br><span class=\"line\"></span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;.....服务器 is ready...&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//绑定一个端口并且同步, 生成了一个 ChannelFuture 对象</span></span><br><span class=\"line\">            <span class=\"comment\">//启动服务器(并绑定端口)</span></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">cf</span> <span class=\"operator\">=</span> bootstrap.bind(<span class=\"number\">6668</span>).sync();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//给cf 注册监听器，监控我们关心的事件</span></span><br><span class=\"line\"></span><br><span class=\"line\">            cf.addListener(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelFutureListener</span>() &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">operationComplete</span><span class=\"params\">(ChannelFuture future)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (cf.isSuccess()) &#123;</span><br><span class=\"line\">                        System.out.println(<span class=\"string\">&quot;监听端口 6668 成功&quot;</span>);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        System.out.println(<span class=\"string\">&quot;监听端口 6668 失败&quot;</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">           <span class=\"comment\">//对关闭通道进行监听</span></span><br><span class=\"line\">            cf.channel().closeFuture().sync();</span><br><span class=\"line\">        &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            bossGroup.shutdownGracefully();</span><br><span class=\"line\">            workerGroup.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>服务端处理器<code>NettyServerHandler</code></li>\n</ul>\n<blockquote>\n<p>此处实现自定义<code>Handler</code>  ,其中进行读取数据的实际实现<code>channelRead(ChannelHandlerContext ctx, Object msg) </code>中的参数声明</p>\n<ul>\n<li><code>ChannelHandlerContext ctx</code>:上下文对象, 含有 管道<code>pipeline</code> , 通道<code>channel</code>, 地址</li>\n<li><code>Object msg</code>: 就是客户端发送的数据 默认<code>Object</code></li>\n</ul>\n<p>数据读取结束之后需要进行写回到缓存并进行刷新</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyServerHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//读取数据实际(这里我们可以读取客户端发送的消息)</span></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 1. ChannelHandlerContext ctx:上下文对象, 含有 管道pipeline , 通道channel, 地址</span></span><br><span class=\"line\"><span class=\"comment\">     * 2. Object msg: 就是客户端发送的数据 默认Object</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead</span><span class=\"params\">(ChannelHandlerContext ctx, Object msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器读取线程 &quot;</span> + Thread.currentThread().getName() + <span class=\"string\">&quot; channle =&quot;</span> + ctx.channel());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;server ctx =&quot;</span> + ctx);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;看看channel 和 pipeline的关系&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Channel</span> <span class=\"variable\">channel</span> <span class=\"operator\">=</span> ctx.channel();</span><br><span class=\"line\">        <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ctx.pipeline(); <span class=\"comment\">//本质是一个双向链接, 出站入站</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//将 msg 转成一个 ByteBuf</span></span><br><span class=\"line\">        <span class=\"comment\">//ByteBuf 是 Netty 提供的，不是 NIO 的 ByteBuffer.</span></span><br><span class=\"line\">        <span class=\"type\">ByteBuf</span> <span class=\"variable\">buf</span> <span class=\"operator\">=</span> (ByteBuf) msg;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;客户端发送消息是:&quot;</span> + buf.toString(CharsetUtil.UTF_8));</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;客户端地址:&quot;</span> + channel.remoteAddress());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">================问题引入============================================================</span><br><span class=\"line\">    一旦有一个非常耗时长的业务-&gt; 异步执行 -&gt; 提交该channel 对应的NIOEventLoop 的 taskQueue中,</span><br><span class=\"line\">================解决方案见下面的   Task的<span class=\"number\">3</span>种典型使用场景 ===============================   </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//数据读取完毕</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelReadComplete</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//writeAndFlush 是 write + flush</span></span><br><span class=\"line\">        <span class=\"comment\">//将数据写入到缓存，并刷新</span></span><br><span class=\"line\">        <span class=\"comment\">//一般讲，我们对这个发送的数据进行编码</span></span><br><span class=\"line\">        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class=\"string\">&quot;hello, 客户端~(&gt;^ω^&lt;)喵1&quot;</span>, CharsetUtil.UTF_8));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//处理异常, 一般是需要关闭通道</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>客户端\n<ul>\n<li>定义循环事件</li>\n<li><code>创建客户端</code>启动对象，并设置对应参数</li>\n<li>启动<code>客户</code>端去连接<code>服务</code>器端</li>\n<li>给关闭通道进行监听</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyClient</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//客户端需要一个事件循环组</span></span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">group</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//注意创建客户端时 使用的不是 ServerBootstrap 而是 Bootstrap</span></span><br><span class=\"line\">            <span class=\"type\">Bootstrap</span> <span class=\"variable\">bootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Bootstrap</span>();</span><br><span class=\"line\">            <span class=\"comment\">//设置相关参数</span></span><br><span class=\"line\">            bootstrap.group(group) <span class=\"comment\">//设置线程组</span></span><br><span class=\"line\">                    .channel(NioSocketChannel.class) <span class=\"comment\">// 设置客户端通道的实现类(反射)</span></span><br><span class=\"line\">                    .handler(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class=\"line\">                        <span class=\"meta\">@Override</span></span><br><span class=\"line\">                        <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                            ch.pipeline().addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">NettyClientHandler</span>()); <span class=\"comment\">//加入自己的处理器</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;客户端 ok..&quot;</span>);</span><br><span class=\"line\">            <span class=\"comment\">//启动客户端去连接服务器端</span></span><br><span class=\"line\">            <span class=\"comment\">//关于 ChannelFuture 要分析，涉及到netty的异步模型</span></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> bootstrap.connect(<span class=\"string\">&quot;127.0.0.1&quot;</span>, <span class=\"number\">6668</span>).sync();</span><br><span class=\"line\">            <span class=\"comment\">//给关闭通道进行监听</span></span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            group.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>客户端处理器<code>NettyClientHandler</code></li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyClientHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//当通道就绪就会触发该方法</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelActive</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;client &quot;</span> + ctx);</span><br><span class=\"line\">        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class=\"string\">&quot;hello, server: (&gt;^ω^&lt;)喵&quot;</span>, CharsetUtil.UTF_8));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//当通道有读取事件时，会触发</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead</span><span class=\"params\">(ChannelHandlerContext ctx, Object msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">ByteBuf</span> <span class=\"variable\">buf</span> <span class=\"operator\">=</span> (ByteBuf) msg;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器回复的消息:&quot;</span> + buf.toString(CharsetUtil.UTF_8));</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器的地址： &quot;</span> + ctx.channel().remoteAddress());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        cause.printStackTrace();</span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"任务队列的Task的3种典型使用场景\">任务队列的Task的3种典型使用场景</h4>\n<ul>\n<li>用户自定义的普通任务</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 解决方案1 用户程序自定义的普通任务</span></span><br><span class=\"line\"></span><br><span class=\"line\">        ctx.channel().eventLoop().execute(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    Thread.sleep(<span class=\"number\">5</span> * <span class=\"number\">1000</span>);</span><br><span class=\"line\">                    ctx.writeAndFlush(Unpooled.copiedBuffer(<span class=\"string\">&quot;hello, 客户端~(&gt;^ω^&lt;)喵2&quot;</span>, CharsetUtil.UTF_8));</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;channel code=&quot;</span> + ctx.channel().hashCode());</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;发生异常&quot;</span> + ex.getMessage());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>用户自定义的定时任务</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//解决方案2 : 用户自定义定时任务 -》 该任务是提交到 scheduleTaskQueue中</span></span><br><span class=\"line\"></span><br><span class=\"line\">        ctx.channel().eventLoop().schedule(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    Thread.sleep(<span class=\"number\">5</span> * <span class=\"number\">1000</span>);</span><br><span class=\"line\">                    ctx.writeAndFlush(Unpooled.copiedBuffer(<span class=\"string\">&quot;hello, 客户端~(&gt;^ω^&lt;)喵4&quot;</span>, CharsetUtil.UTF_8));</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;channel code=&quot;</span> + ctx.channel().hashCode());</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;发生异常&quot;</span> + ex.getMessage());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;, <span class=\"number\">5</span>, TimeUnit.SECONDS);</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;go on ...&quot;</span>);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>非当前 <code>Reactor</code> 线程调用 <code>Channel</code> 的各种方法\n<ul>\n<li>例如在推送系统的业务线程里面，根据用户的标识，找到对应的 <code>Channel</code> 引用，然后调用 <code>Write</code> 类方法向该用户推送消息，就会进入到这种场景。最终的 <code>Write</code> 会提交到任务队列中后被异步消费</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"总结说明\">总结说明</h4>\n<ul>\n<li><code>Netty</code> 抽象出两组线程池，<code>BossGroup</code> 专门负责接收客户端连接，<code>WorkerGroup</code> 专门负责网络读写操作。</li>\n<li><code>NioEventLoop</code> 表示一个不断循环执行处理任务的线程，每个 <code>NioEventLoop</code> 都有一个 <code>Selector</code>，用于监听绑定在其上的 <code>socket</code>网络通道。</li>\n<li><code>NioEventLoop</code> 内部采用串行化设计，从消息的 <strong>读取-&gt;解码-&gt;处理-&gt;编码-&gt;发送</strong>，始终由 <code>IO</code> 线程 <code>NioEventLoop</code> 负责</li>\n</ul>\n<p><code>NioEventLoopGroup</code> 下包含多个 <code>NioEventLoop</code></p>\n<ul>\n<li>每个 <code>NioEventLoop</code> 中包含有一个 <code>Selector</code>，一个 <code>taskQueue</code></li>\n<li>每个 <code>NioEventLoop</code> 的 <code>Selector</code> 上可以注册监听多个 <code>NioChannel</code></li>\n<li>每个 <code>NioChannel</code> 只会绑定在唯一的 <code>NioEventLoop</code> 上</li>\n<li>每个 <code>NioChannel</code> 都绑定有一个自己的 <code>ChannelPipeline</code></li>\n</ul>\n<h3 id=\"异步模型\">异步模型</h3>\n<ul>\n<li>当一个异步过程调用发出后，调用者<code>不能立刻得到结果</code>。实际处理这个调用的组件在完成后，通过状态、通知和回调来通知调用者。</li>\n<li><code>Netty</code> 中的 <code>I/O</code> 操作是异步的，包括 <code>Bind、Write、Connect</code> 等操作会简单的返回一个 <code>ChannelFuture</code></li>\n<li>调用者并不能立刻获得结果，而是通过 <code>Future-Listener</code> 机制，用户可以方便的<code>主动获取或者通过通知机制</code>获得 <code>IO</code> 操作结果。</li>\n<li><code>Netty</code> 的异步模型是建立在 <code>future</code> 和 <code>callback</code> 之上的。\n<ul>\n<li><code>callback</code> 就是回调</li>\n<li>重点说 <code>Future</code></li>\n</ul>\n</li>\n</ul>\n<h4 id=\"Future说明\">==<code>Future</code>说明==</h4>\n<ul>\n<li>\n<p>表示异步的执行结果,可以通过它提供的方法来检测执行是否完成</p>\n</li>\n<li>\n<p><code>ChannelFuture</code> 是一个接口：<code>public interface ChannelFuture extends Future&lt;Void&gt;</code> 我们可以添加监听器，当监听的事件发生时，就会通知到监听器</p>\n</li>\n<li>\n<p>它的核心思想</p>\n<ul>\n<li>假设一个方法 <code>fun</code>，计算过程可能非常耗时，等待 <code>fun</code> 返回显然不合适。那么可以在调用 <code>fun</code> 的时候，立马返回一个 <code>Future</code>，后续可以通过 <code>Future</code> 去监控方法 <code>fun</code> 的处理过程（即：<code>Future-Listener</code> 机制）</li>\n</ul>\n</li>\n<li>\n<p>原理示意图</p>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306131143603.png\" alt=\"image-20230613114329518\" style=\"zoom:33%;\">\n<ul>\n<li>在使用 <code>Netty</code> 进行编程时，<code>拦截操作</code>和<code>转换出入站</code>数据只需要提供 <code>callback</code> 或利用 <code>future</code> 即可（这使得链式操作简单、高效，并有利于编写可重用的、通用的代码）</li>\n<li><code>Netty</code> 框架的目标\n<ul>\n<li>就是让你的业务逻辑从网络基础应用编码中分离出来、解脱出来。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"Future-Listener-机制\">Future-Listener 机制</h4>\n<ul>\n<li>\n<p>当 <code>Future</code> 对象刚刚创建时，处于非完成状态，调用者可以通过返回的 <code>ChannelFuture</code> 来获取操作执行的状态，<code>注册监听函数</code>来执行完成后的操作。</p>\n</li>\n<li>\n<p>常见有如下操作</p>\n<ul>\n<li>\n<p>通过 <code>isDone</code> 方法来判断当前操作<code>是否完成</code>；</p>\n</li>\n<li>\n<p>通过 <code>isSuccess</code> 方法来判断已完成的当前操作<code>是否成功</code>；</p>\n</li>\n<li>\n<p>通过 <code>getCause</code> 方法来获取已完成的当前操作<code>失败的原因</code>；</p>\n</li>\n<li>\n<p>通过 <code>isCancelled</code> 方法来判断已完成的当前操作<code>是否被取消</code>；</p>\n</li>\n<li>\n<p>通过 <code>addListener</code> 方法来<code>注册</code>监听器</p>\n<ul>\n<li>当操作已完成（<code>isDone</code>方法返回完成），将会通知指定的监听器</li>\n<li>如果 <code>Future</code> 对象已完成，则通知指定的监听器</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p>需求：绑定端口是异步操作,当绑定操作处理完，将会调用相应的监听器处理逻辑</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//绑定一个端口并且同步,生成了一个ChannelFuture对象</span></span><br><span class=\"line\"><span class=\"comment\">//启动服务器(并绑定端口)</span></span><br><span class=\"line\"><span class=\"type\">ChannelFuture</span> <span class=\"variable\">cf</span> <span class=\"operator\">=</span> bootstrap.bind(<span class=\"number\">6668</span>).sync();</span><br><span class=\"line\"><span class=\"comment\">//给cf注册监听器，监控我们关心的事件</span></span><br><span class=\"line\">cf.addListener(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelFutureListener</span>() &#123;</span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">operationComplete</span> <span class=\"params\">(ChannelFuture future)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">   <span class=\"keyword\">if</span> (cf.isSuccess()) &#123;</span><br><span class=\"line\">      .....</span><br><span class=\"line\">   &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      .....</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h2 id=\"Netty-核心模块组件\">Netty 核心模块组件</h2>\n<h3 id=\"组件概括\">组件概括</h3>\n<h4 id=\"BootStrap、ServerBootStrap\">BootStrap、ServerBootStrap</h4>\n<ul>\n<li>\n<p><code>Bootstrap</code> 意思是引导，一个 <code>Netty</code> 应用通常由一个 <code>Bootstrap</code> 开始，主要作用是<code>配置</code>整个 <code>Netty</code> 程序，<code>串联</code>各个组件</p>\n<ul>\n<li><code>Netty</code> 中 <code>Bootstrap</code> 类是客户端程序的启动引导类，<code>ServerBootstrap</code> 是服务端启动引导类。</li>\n</ul>\n</li>\n<li>\n<p>常见的方法有</p>\n<ul>\n<li>\n<p><code>public ServerBootstrap group(EventLoopGroup parentGroup, EventLoopGroup childGroup)</code>，该方法用于服务器端，用来设置两个 <code>EventLoop</code></p>\n</li>\n<li>\n<p><code>public B group(EventLoopGroup group)</code>，该方法用于客户端，用来设置一个 <code>EventLoop</code></p>\n</li>\n<li>\n<p><code>public B channel(Class&lt;? extends C&gt; channelClass)</code>，该方法用来设置一个服务器端的通道实现</p>\n</li>\n<li>\n<p><code>public &lt;T&gt; B option(ChannelOption&lt;T&gt; option, T value)</code>，用来给 <code>ServerChannel</code> 添加配置</p>\n</li>\n<li>\n<p><code>public &lt;T&gt; ServerBootstrap childOption(ChannelOption&lt;T&gt; childOption, T value)</code>，用来给接收到的通道添加配置</p>\n</li>\n<li>\n<p><code>public ServerBootstrap childHandler(ChannelHandler childHandler)</code>，该方法用来设置业务处理类（自定义的<code>handler</code>）</p>\n</li>\n<li>\n<p><code>public ChannelFuture bind(int inetPort)</code>，该方法用于服务器端，用来设置占用的端口号</p>\n</li>\n<li>\n<p><code>public ChannelFuture connect(String inetHost, int inetPort)</code>，该方法用于客户端，用来连接服务器端</p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"Future、ChannelFuture\">Future、ChannelFuture</h4>\n<p><code>Netty</code> 中所有的 <code>IO</code> 操作都是<code>异步</code>的，不能立刻得知消息是否被正确处理。</p>\n<p>需要等待它执行完成或者直接注册一个监听，具体的实现就是通过 <code>Future</code> 和 <code>ChannelFutures</code>，他们可以注册一个监听，当操作执行成功或失败时监听会自动触发注册的监听事件</p>\n<p>常见的方法有</p>\n<ul>\n<li><code>Channel channel()</code>，返回当前正在进行 <code>IO</code> 操作的通道</li>\n<li><code>ChannelFuture sync()</code>，等待异步操作执行完毕</li>\n</ul>\n<h4 id=\"Channel\">Channel</h4>\n<ol>\n<li><code>Netty</code> 网络通信的组件，能够用于执行网络 <code>I/O</code> 操作</li>\n<li>通过 <code>Channel</code> 可获得当前网络连接的通道的状态</li>\n<li>通过 <code>Channel</code> 可获得网络连接的配置参数（例如接收缓冲区大小）</li>\n<li><code>Channel</code> 提供异步的网络 <code>I/O</code> 操作(如建立连接，读写，绑定端口)，异步调用意味着任何 <code>I/O</code> 调用都不会立即返回，并且不保证在调用结束时所请求的 <code>I/O</code> 操作已完成</li>\n<li>调用立即返回一个 <code>ChannelFuture</code> 实例，通过注册监听器到 <code>ChannelFuture</code> 上，可以 <code>I/O</code> 操作成功、失败或取消时回调通知调用方</li>\n<li>支持关联 <code>I/O</code> 操作与对应的处理程序</li>\n<li>不同协议、不同的阻塞类型的连接都有不同的<code>Channel </code>  类型与之对应，常用的 <code>Channel</code> 类型：\n<ul>\n<li><code>NioSocketChannel</code>，异步的客户端 <code>TCP</code> <code>Socket</code> 连接。</li>\n<li><code>NioServerSocketChannel</code>，异步的服务器端 <code>TCP</code> <code>Socket</code> 连接。</li>\n<li><code>NioDatagramChannel</code>，异步的 <code>UDP</code> 连接。</li>\n<li><code>NioSctpChannel</code>，异步的客户端 <code>Sctp</code> 连接。</li>\n<li><code>NioSctpServerChannel</code>，异步的 <code>Sctp</code> 服务器端连接，这些通道涵盖了 <code>UDP</code> 和 <code>TCP</code> 网络 <code>IO</code> 以及文件 <code>IO</code>。</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"Selector\">Selector</h4>\n<ol>\n<li><code>Netty</code> 基于 <code>Selector</code> 对象实现 <code>I/O</code> 多路复用，通过 <code>Selector</code> 一个线程可以<code>监听</code>多个连接的 <code>Channel</code> 事件。</li>\n<li>当向一个 <code>Selector</code> 中注册 <code>Channel</code> 后，<code>Selector</code> 内部的机制就可以自动不断地查询（<code>Select</code>）这些注册的 <code>Channel</code> 是否有已就绪的 <code>I/O</code> 事件（例如可读，可写，网络连接完成等），这样程序就可以很简单地使用一个线程高效地管理多个 <code>Channel</code></li>\n</ol>\n<h4 id=\"ChannelHandler-及其实现类\">ChannelHandler 及其实现类</h4>\n<ol>\n<li><code>ChannelHandler</code> 是一个接口，处理 <code>I/O</code> 事件或拦截 <code>I/O</code> 操作，并将其转发到其 <code>ChannelPipeline</code>（业务处理链）中的下一个处理程序。</li>\n<li><code>ChannelHandler</code> 本身并没有提供很多方法，因为这个接口有许多的方法需要实现，方便使用期间，可以继承它的子类</li>\n<li><code>ChannelHandler</code> 的实现类</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ChannelInboundHandler  <span class=\"comment\">//用于处理入站I/O事件。</span></span><br><span class=\"line\">ChannelOutboundHandler <span class=\"comment\">//用于处理出站I/O事件</span></span><br><span class=\"line\">    <span class=\"comment\">//适配器</span></span><br><span class=\"line\">ChannellnboundHandlerAdapter\t<span class=\"comment\">//用于处理入站I/O事件。</span></span><br><span class=\"line\">ChannelOutboundHandlerAdapter\t<span class=\"comment\">//用于处理出站I/O事件</span></span><br><span class=\"line\">ChannelDuplexHandler\t\t\t<span class=\"comment\">//用于处理入站 &amp; 出站I/O事件</span></span><br></pre></td></tr></table></figure>\n<ol start=\"4\">\n<li>自定义一个 <code>Handler</code> 类去继承 <code>ChannelInboundHandlerAdapter</code>，需要重写的方法</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 通道就绪事件</span></span><br><span class=\"line\">channellActive()</span><br><span class=\"line\">channellInActive() </span><br><span class=\"line\"><span class=\"comment\">// 通道读取数据事件</span></span><br><span class=\"line\">channelRead()</span><br><span class=\"line\"><span class=\"comment\">// 读取数据完毕事件</span></span><br><span class=\"line\">channelReadComplete()</span><br><span class=\"line\"><span class=\"comment\">// 通道发生异常事件</span></span><br><span class=\"line\">execptionCaught()</span><br></pre></td></tr></table></figure>\n<h4 id=\"Pipeline-和-ChannelPipeline\">Pipeline 和 ChannelPipeline</h4>\n<p><code>ChannelPipeline</code> 是一个重点：</p>\n<ol>\n<li><code>ChannelPipeline</code> 是一个 <code>Handler</code> 的集合，它负责处理和拦截 <code>inbound</code> 或者 <code>outbound</code> 的事件和操作，相当于一个贯穿 <code>Netty</code> 的链。（也可以理解为：<code>ChannelPipeline</code> 是保存 <code>ChannelHandler</code> 的 <code>List</code>，用于处理或拦截 <code>Channel</code> 的入站事件和出站操作）</li>\n<li><code>ChannelPipeline</code> 实现了一种<code>高级形式的拦截过滤器模式</code>，使<code>用户可以完全控制</code>事件的处理方式以及 <code>Channel</code> 中各个的 <code>ChannelHandler</code> 如何相互交互</li>\n<li>在 <code>Netty</code> 中每个 <code>Channel</code> 都有且仅有一个 <code>ChannelPipeline</code> 与之对应，它们的组成关系如下</li>\n</ol>\n<blockquote>\n<ul>\n<li>\n<p>一个<code>Channel</code>包含了一个<code>ChannelPipeline</code>,而<code>ChannelPipeline</code>中又维护了一个由<code>ChannelHandlerContext</code>组成的双向链表，并且每个<code>ChannelHandlerContext</code>中又关联着一个<code>ChannelHandler</code></p>\n</li>\n<li>\n<p>入站事件和出站事件在一个双向链表中，入站事件会从链表<code>head</code>往后传递到最后一个入站的<code>handler</code>,出站事件会从链表<code>tail</code>往前传递到最前一个出站的<code>handler</code>,两种类型的<code>handler</code>互不干扰</p>\n</li>\n</ul>\n</blockquote>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306131309509.png\" alt=\"image-20230613130945429\" style=\"zoom:50%;\">\n<ol start=\"4\">\n<li>常用方法 <code>ChannelPipeline addFirst(ChannelHandler... handlers)</code>，把一个业务处理类（<code>handler</code>）添加到链中的第一个位置<code>ChannelPipeline addLast(ChannelHandler... handlers)</code>，把一个业务处理类（<code>handler</code>）添加到链中的最后一个位置</li>\n</ol>\n<h4 id=\"ChannelHandlerContext\">ChannelHandlerContext</h4>\n<ol>\n<li>保存 <code>Channel</code> 相关的所有上下文信息，同时关联一个 <code>ChannelHandler</code> 对象</li>\n<li>即 <code>ChannelHandlerContext</code> 中包含一个具体的事件处理器 <code>ChannelHandler</code>，同时 <code>ChannelHandlerContext</code> 中也绑定了对应的 <code>pipeline</code> 和 <code>Channel</code> 的信息，方便对 <code>ChannelHandler</code> 进行调用。</li>\n<li>常用方法\n<ul>\n<li><code>ChannelFuture close()</code>，关闭通道</li>\n<li><code>ChannelOutboundInvoker flush()</code>，刷新</li>\n<li><code>ChannelFuture writeAndFlush(Object msg)</code>，将数据写到<code>ChannelPipeline</code> 中当前 <code>ChannelHandler</code> 的下一个 <code>ChannelHandler</code> 开始处理（出站）的位置</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"ChannelOption\">ChannelOption</h4>\n<ol>\n<li>\n<p><code>Netty</code> 在创建 <code>Channel</code> 实例后，一般都需要设置 <code>ChannelOption</code> 参数。</p>\n</li>\n<li>\n<p><code>ChannelOption</code> 参数如下：</p>\n<ul>\n<li>\n<p><code>ChannelOption.SO_BACKLOG</code>  对应<code>TCP/IP</code>协议<code>listen</code>函数中的<code>backlog</code>参数，用来初始化服务器可连接队列大小。服务端处理客户端连接请求是顺序处理的，所以同一时间只能处理一个客户端连接。多个客户端来的时候，服务端将不能处理的客户端连接请求放在队列中等待处理，<code>backlog</code>参数指定了队列的大小。</p>\n</li>\n<li>\n<p><code>ChannelOption.SO_KEEPALIVE</code>   一直保持连接活动状态</p>\n</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"EventLoopGroup-和其实现类-NioEventLoopGroup\">EventLoopGroup 和其实现类 NioEventLoopGroup</h4>\n<ol>\n<li>\n<p><code>EventLoopGroup</code> 是一组 <code>EventLoop</code> 的抽象，<code>Netty</code> 为了更好的利用多核 <code>CPU</code> 资源，一般会有多个 <code>EventLoop</code> 同时工作，每个 <code>EventLoop</code> 维护着一个 <code>Selector</code> 实例。</p>\n</li>\n<li>\n<p><code>EventLoopGroup</code> 提供 <code>next</code> 接口，可以从组里面按照一定规则获取其中一个 <code>EventLoop</code> 来处理任务。</p>\n<ul>\n<li>在 <code>Netty</code> 服务器端编程中，我们一般都需要提供两个 <code>EventLoopGroup</code>，例如：<code>BossEventLoopGroup</code> 和 <code>WorkerEventLoopGroup</code>。</li>\n</ul>\n</li>\n<li>\n<p>通常一个服务端口即一个 <code>ServerSocketChannel</code> 对应一个 <code>Selector</code> 和一个 <code>EventLoop</code> 线程。<code>BossEventLoop</code> 负责接收客户端的连接并将 <code>SocketChannel</code> 交给 <code>WorkerEventLoopGroup</code> 来进行 <code>IO</code> 处理，如下图所示</p>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306131323268.png\" alt=\"image-20230613132300229\" style=\"zoom:53%;\">\n</li>\n</ol>\n<blockquote>\n<ul>\n<li><code>BossEventLoopGroup</code>通常是一个单线程的<code>EventLoop</code>,<code>EventLoop</code>维护着一个注册了<code>ServerSocketChannel</code>的<code>Selector</code>实例<code>BossEventLoop</code>不断轮询<code>Selector</code>将连接事件分离出来</li>\n<li>通常是<code>OP_ACCEPT</code>事件，然后将接收到的<code>SocketChannel</code>交给<code>WorkerEventLoopGroup</code></li>\n<li><code>WorkerEventLoopGroup</code>会由<code>next</code>选择其中一个<code>EventLoop</code>来将这个<code>SocketChannel</code>注册到其维护的<code>Selector</code>并对其后续的IO事件进行处理</li>\n</ul>\n</blockquote>\n<ol start=\"4\">\n<li>常用方法 <code>public NioEventLoopGroup()</code>，构造方法 <code>public Future&lt;?&gt; shutdownGracefully()</code>，断开连接，关闭线程</li>\n</ol>\n<h4 id=\"Unpooled-类\">Unpooled 类</h4>\n<ol>\n<li><code>Netty</code> 提供一个专门用来操作缓冲区（即 <code>Netty</code> 的数据容器）的工具类</li>\n<li>常用方法如下所示\n<ul>\n<li><code>public static ByteBuf copiedBuffer(CharSequence string,Charset charset)</code> //通过给定的数据和字符编码返回一个ByteBuf对象（类似于NIO中的ByteBuffer但有区别）</li>\n</ul>\n</li>\n</ol>\n<blockquote>\n<p><code>Unpooled</code> 获取 <code>Netty</code> 的数据容器 <code>ByteBuf</code> 的基本使用的演示</p>\n<p><code>ByteBuf buffer = Unpooled.buffer(10);    for (int i = 0; i &lt; 10; i++) &#123;      buffer.writeByte(i);        &#125; </code></p>\n<p><code> for (int i = 0; i &lt; buffer.capacity(); i++) &#123;      System.out.println(buffer.readByte());        &#125;</code></p>\n</blockquote>\n<h3 id=\"案例演示\">案例演示</h3>\n<h4 id=\"群聊系统\">群聊系统</h4>\n<ul>\n<li>服务端\n<ul>\n<li>创建两个线程组</li>\n<li>创建服务器端的启动对象，配置参数和<code>pipeline</code></li>\n</ul>\n</li>\n<li>关闭监听</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">GroupChatServer</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> port; <span class=\"comment\">//监听端口</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">GroupChatServer</span><span class=\"params\">(<span class=\"type\">int</span> port)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.port = port;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//编写run方法，处理客户端的请求</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//创建两个线程组</span></span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">bossGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">workerGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(); </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">ServerBootstrap</span> <span class=\"variable\">b</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ServerBootstrap</span>();</span><br><span class=\"line\">            b.group(bossGroup, workerGroup)</span><br><span class=\"line\">                    .channel(NioServerSocketChannel.class)</span><br><span class=\"line\">                    .option(ChannelOption.SO_BACKLOG, <span class=\"number\">128</span>)</span><br><span class=\"line\">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class=\"literal\">true</span>)</span><br><span class=\"line\">                    .childHandler(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class=\"line\">                        <span class=\"meta\">@Override</span></span><br><span class=\"line\">                        <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"comment\">//获取到pipeline</span></span><br><span class=\"line\">                            <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\">                            <span class=\"comment\">//向pipeline加入解码器</span></span><br><span class=\"line\">                            pipeline.addLast(<span class=\"string\">&quot;decoder&quot;</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">StringDecoder</span>());</span><br><span class=\"line\">                            <span class=\"comment\">//向pipeline加入编码器</span></span><br><span class=\"line\">                            pipeline.addLast(<span class=\"string\">&quot;encoder&quot;</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">StringEncoder</span>());</span><br><span class=\"line\">                            <span class=\"comment\">//加入自己的业务处理handler</span></span><br><span class=\"line\">                            pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">GroupChatServerHandler</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;netty 服务器启动&quot;</span>);</span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> b.bind(port).sync();</span><br><span class=\"line\">            <span class=\"comment\">//监听关闭</span></span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            bossGroup.shutdownGracefully();</span><br><span class=\"line\">            workerGroup.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">     <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">GroupChatServer</span>(<span class=\"number\">7000</span>).run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p><code>GroupChatServerHandler</code> <code>服务端处理器</code>  <code>extends SimpleChannelInboundHandler</code> 需要重写下面的方法</p>\n<ul>\n<li>\n<p>定义一个<code>channle</code> 组，并指定事件执行类型，管理所有的<code>channel</code></p>\n</li>\n<li>\n<p>重写建立连接<code>handlerAdded</code></p>\n<ul>\n<li>获取<code>channel</code>并 加到<code> ChannelGroup</code>中</li>\n<li>将该客户加入聊天的信息,即遍历<code>channelGroup</code> 中所有的<code>channel</code> ，随后推送给其他在线的客户端</li>\n</ul>\n</li>\n<li>\n<p>重写断开连接<code>handlerRemoved</code></p>\n</li>\n<li>\n<p>重写处于活动状态<code>channelActive</code></p>\n</li>\n<li>\n<p>重写处于非活动状态<code>channelInactive</code></p>\n</li>\n<li>\n<p>重写读取事件<code>channelRead0</code></p>\n<ul>\n<li>获取到当前<code>channel</code></li>\n<li>遍历<code>channelGroup</code>, 根据不同的情况，回送不同的消息\n<ul>\n<li>不是当前的<code>channel</code>,转发消息</li>\n<li>是当前的<code>channel</code> ，回显自己发送的消息给自己</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>重写通道发生异常事件<code>exceptionCaught</code></p>\n<ul>\n<li>关闭通道</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">GroupChatServerHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleChannelInboundHandler</span>&lt;String&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">//定义一个channle 组，管理所有的channel</span></span><br><span class=\"line\">    <span class=\"comment\">//GlobalEventExecutor.INSTANCE) 是全局的事件执行器，是一个单例</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">ChannelGroup</span> <span class=\"variable\">channelGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">DefaultChannelGroup</span>(GlobalEventExecutor.INSTANCE);</span><br><span class=\"line\">    <span class=\"type\">SimpleDateFormat</span> <span class=\"variable\">sdf</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SimpleDateFormat</span>(<span class=\"string\">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//handlerAdded 表示连接建立，一旦连接，第一个被执行</span></span><br><span class=\"line\">    <span class=\"comment\">//将当前channel 加入到  channelGroup</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handlerAdded</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">Channel</span> <span class=\"variable\">channel</span> <span class=\"operator\">=</span> ctx.channel();</span><br><span class=\"line\">        <span class=\"comment\">//将该客户加入聊天的信息推送给其它在线的客户端</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        该方法会将 channelGroup 中所有的channel 遍历，并发送 消息，</span></span><br><span class=\"line\"><span class=\"comment\">        我们不需要自己遍历</span></span><br><span class=\"line\"><span class=\"comment\">         */</span></span><br><span class=\"line\">        channelGroup.writeAndFlush(<span class=\"string\">&quot;[客户端]&quot;</span> + channel.remoteAddress() + <span class=\"string\">&quot; 加入聊天&quot;</span> + sdf.format(<span class=\"keyword\">new</span> <span class=\"title class_\">java</span>.util.Date()) + <span class=\"string\">&quot; \\n&quot;</span>);</span><br><span class=\"line\">        channelGroup.add(channel);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//断开连接, 将xx客户离开信息推送给当前在线的客户</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handlerRemoved</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">Channel</span> <span class=\"variable\">channel</span> <span class=\"operator\">=</span> ctx.channel();</span><br><span class=\"line\">        channelGroup.writeAndFlush(<span class=\"string\">&quot;[客户端]&quot;</span> + channel.remoteAddress() + <span class=\"string\">&quot; 离开了\\n&quot;</span>);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;channelGroup size&quot;</span> + channelGroup.size());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//表示channel 处于活动状态, 提示 xx上线</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelActive</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(ctx.channel().remoteAddress() + <span class=\"string\">&quot; 上线了~&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//表示channel 处于不活动状态, 提示 xx离线了</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelInactive</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(ctx.channel().remoteAddress() + <span class=\"string\">&quot; 离线了~&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//读取数据</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead0</span><span class=\"params\">(ChannelHandlerContext ctx, String msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//获取到当前channel</span></span><br><span class=\"line\">        <span class=\"type\">Channel</span> <span class=\"variable\">channel</span> <span class=\"operator\">=</span> ctx.channel();</span><br><span class=\"line\">        <span class=\"comment\">//这时我们遍历channelGroup, 根据不同的情况，回送不同的消息</span></span><br><span class=\"line\">        channelGroup.forEach(ch -&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (channel != ch) &#123; <span class=\"comment\">//不是当前的channel,转发消息</span></span><br><span class=\"line\">                ch.writeAndFlush(<span class=\"string\">&quot;[客户]&quot;</span> + channel.remoteAddress() + <span class=\"string\">&quot; 发送了消息&quot;</span> + msg + <span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;<span class=\"comment\">//回显自己发送的消息给自己</span></span><br><span class=\"line\">                ch.writeAndFlush(<span class=\"string\">&quot;[自己]发送了消息&quot;</span> + msg + <span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//关闭通道</span></span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>客户端\n<ul>\n<li>定义一个线程组</li>\n<li>定义启动服务并进行配置</li>\n<li>将服务链接到对应位置并使用异步方法声明</li>\n<li>得到<code>channel</code></li>\n<li>客户端输入要传输的信息</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">GroupChatClient</span> &#123;</span><br><span class=\"line\">   </span><br><span class=\"line\">    <span class=\"comment\">//属性</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String host;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> port;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">GroupChatClient</span><span class=\"params\">(String host, <span class=\"type\">int</span> port)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.host = host;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.port = port;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">group</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"type\">Bootstrap</span> <span class=\"variable\">bootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Bootstrap</span>()</span><br><span class=\"line\">                    .group(group)</span><br><span class=\"line\">                    .channel(NioSocketChannel.class)</span><br><span class=\"line\">                    .handler(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"meta\">@Override</span></span><br><span class=\"line\">                        <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"comment\">//得到pipeline</span></span><br><span class=\"line\">                            <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\">                            <span class=\"comment\">//加入相关handler</span></span><br><span class=\"line\">                            pipeline.addLast(<span class=\"string\">&quot;decoder&quot;</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">StringDecoder</span>());</span><br><span class=\"line\">                            pipeline.addLast(<span class=\"string\">&quot;encoder&quot;</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">StringEncoder</span>());</span><br><span class=\"line\">                            <span class=\"comment\">//加入自定义的handler</span></span><br><span class=\"line\">                            pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">GroupChatClientHandler</span>());</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> bootstrap.connect(host, port).sync();</span><br><span class=\"line\">            <span class=\"comment\">//得到channel</span></span><br><span class=\"line\">            <span class=\"type\">Channel</span> <span class=\"variable\">channel</span> <span class=\"operator\">=</span> channelFuture.channel();</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;-------&quot;</span> + channel.localAddress() + <span class=\"string\">&quot;--------&quot;</span>);</span><br><span class=\"line\">            <span class=\"comment\">//客户端需要输入信息，创建一个扫描器</span></span><br><span class=\"line\">            <span class=\"type\">Scanner</span> <span class=\"variable\">scanner</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Scanner</span>(System.in);</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (scanner.hasNextLine()) &#123;</span><br><span class=\"line\">                <span class=\"type\">String</span> <span class=\"variable\">msg</span> <span class=\"operator\">=</span> scanner.nextLine();</span><br><span class=\"line\">                <span class=\"comment\">//通过channel 发送到服务器端</span></span><br><span class=\"line\">                channel.writeAndFlush(msg + <span class=\"string\">&quot;\\r\\n&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            group.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">GroupChatClient</span>(<span class=\"string\">&quot;127.0.0.1&quot;</span>, <span class=\"number\">7000</span>).run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>GroupChatClientHandler</code>  客户端处理器</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">GroupChatClientHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleChannelInboundHandler</span>&lt;String&gt; &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead0</span><span class=\"params\">(ChannelHandlerContext ctx, String msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(msg.trim());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"心跳检测机制案例\">心跳检测机制案例</h4>\n<h6 id=\"服务端\">服务端</h6>\n<blockquote>\n<p>需求</p>\n</blockquote>\n<ul>\n<li>编写一个 <code>Netty</code> 心跳检测机制案例,当服务器超过 <code>3</code> 秒没有读时，就提示读空闲</li>\n<li>当服务器超过 <code>5</code> 秒没有写操作时，就提示写空闲</li>\n<li>实现当服务器超过 <code>7</code> 秒没有读或者写操作时，就提示读写空闲</li>\n</ul>\n<blockquote>\n<p>实现思路</p>\n</blockquote>\n<ul>\n<li>创建两个线程组分别为<code>bossGroup</code>和<code>workerGroup</code>\n<ul>\n<li><code>bossGroup</code>负责<code>接收客户端连接</code>请求，而<code>workerGroup</code>则负责<code>处理户客户端端连接</code>的I/O操作</li>\n</ul>\n</li>\n<li>初始化<code>ServerBootstrap</code>对象，并通过<code>group</code>方法将<code>bossGroup</code>和<code>workerGroup</code>线程组注册到<code>ServerBootstrap</code>中，实现线程组和服务端的绑定。</li>\n<li>通过<code>channel</code>方法设置服务端通道类型为<code>NioServerSocketChannel</code>，表示使用NIO客户端通道。</li>\n<li>通过<code>handler</code>方法，设置服务端初始化的<code>handler</code>为<code>LoggingHandler</code>类，用于输出网络日志信息。\n<ul>\n<li>在<code>childHandler</code>方法中，设置<code>ChannelInitializer</code>类，该类作用是<code>自定义通道初始化</code>方法，将自定义的空闲检测处理器<code>MyServerHandler</code>添加到通道中。在自定义的空闲检测处理器中，使用了<code>IdleStateHandler</code>类进行<code>空闲状态处理</code>，在读、写、读写空闲时会发送心跳检测包探测连接是否正常。</li>\n</ul>\n</li>\n<li>在<code>bind</code>方法中指定监听的端口号为7000，然后通过sync方法等待服务端启动完成。</li>\n<li>最后，在程序执行结束之后，调用<code>shutdownGracefully</code>方法关闭服务端并释放所有的资源。</li>\n</ul>\n<blockquote>\n<p>代码</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServer</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">       </span><br><span class=\"line\">        <span class=\"comment\">//创建两个线程组</span></span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">bossGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">workerGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(); <span class=\"comment\">//8个NioEventLoop</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">ServerBootstrap</span> <span class=\"variable\">serverBootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ServerBootstrap</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">            serverBootstrap.group(bossGroup, workerGroup);</span><br><span class=\"line\">            serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class=\"line\">            serverBootstrap.handler(<span class=\"keyword\">new</span> <span class=\"title class_\">LoggingHandler</span>(LogLevel.INFO));</span><br><span class=\"line\">            serverBootstrap.childHandler(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                    <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\">                    <span class=\"comment\">//加入一个netty 提供 IdleStateHandler</span></span><br><span class=\"line\">                    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">                    说明</span></span><br><span class=\"line\"><span class=\"comment\">                    1. IdleStateHandler 是netty 提供的处理空闲状态的处理器</span></span><br><span class=\"line\"><span class=\"comment\">                    2. long readerIdleTime : 表示多长时间没有读, 就会发送一个心跳检测包检测是否连接</span></span><br><span class=\"line\"><span class=\"comment\">                    3. long writerIdleTime : 表示多长时间没有写, 就会发送一个心跳检测包检测是否连接</span></span><br><span class=\"line\"><span class=\"comment\">                    4. long allIdleTime : 表示多长时间没有读写, 就会发送一个心跳检测包检测是否连接</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">                    5. 文档说明</span></span><br><span class=\"line\"><span class=\"comment\">                    triggers an &#123;@link IdleStateEvent&#125; when a &#123;@link Channel&#125; has not performed</span></span><br><span class=\"line\"><span class=\"comment\"> * read, write, or both operation for a while.</span></span><br><span class=\"line\"><span class=\"comment\"> *                  6. 当 IdleStateEvent 触发后 , 就会传递给管道 的下一个handler去处理</span></span><br><span class=\"line\"><span class=\"comment\"> *                  通过调用(触发)下一个handler 的 userEventTiggered , 在该方法中去处理 IdleStateEvent(读空闲，写空闲，读写空闲)</span></span><br><span class=\"line\"><span class=\"comment\">                     */</span></span><br><span class=\"line\">                    pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">IdleStateHandler</span>(<span class=\"number\">7000</span>, <span class=\"number\">7000</span>, <span class=\"number\">10</span>, TimeUnit.SECONDS));</span><br><span class=\"line\">                    </span><br><span class=\"line\">                    </span><br><span class=\"line\">                    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">                    说明</span></span><br><span class=\"line\"><span class=\"comment\">1.在初始化SocketChannel通道的时候，通过调用Pipeline对象的addLast方法来添加IdleStateHandler空闲状态监测处理器，将其加入到通道的处理管道中。</span></span><br><span class=\"line\"><span class=\"comment\">2.在添加IdleStateHandler处理器时，需要指定三个参数：readerIdleTime、writerIdleTime和allIdleTime。分别表示读空闲时间、写空闲时间和读写空闲时间。对于读空闲和写空闲，如果在指定时间内没有进行相应的读写操作，就会自动触发IdleStateEvent事件，表示心跳包需要被发送。</span></span><br><span class=\"line\"><span class=\"comment\">3.除了指定以上三个参数外，还需要指定一个时间单位，可以使用常见的时间单位，例如秒、毫秒等。这里采用的是TimeUnit.SECONDS，表示时间单位为秒。</span></span><br><span class=\"line\"><span class=\"comment\">4.当IdleStateEvent事件被触发时，将会进一步调用自定义的MyServerHandler类中的userEventTriggered方法进行处理。</span></span><br><span class=\"line\"><span class=\"comment\">                    */</span></span><br><span class=\"line\">                    <span class=\"comment\">//加入一个对空闲检测进一步处理的handler(自定义)</span></span><br><span class=\"line\">                    pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyServerHandler</span>());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//启动服务器</span></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> serverBootstrap.bind(<span class=\"number\">7000</span>).sync();</span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            bossGroup.shutdownGracefully();</span><br><span class=\"line\">            workerGroup.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>handler </code>   处理器</p>\n</blockquote>\n<ul>\n<li>\n<p>其<code>主要思路</code>如下：</p>\n<ul>\n<li>首先判断<code>evt</code>是否是<code>IdleStateEvent</code>类型的事件。如果是，则表示发生了空闲状态的事件。</li>\n<li>将事件向下转型为<code>IdleStateEvent</code>类型的事件，并获取事件的<code>state</code>属性，判断当前的事件类型，是读空闲、写空闲还是读写空闲。</li>\n<li>根据eventType的类型输出日志信息，提示客户端的连接地址和触发的超时事件类型。</li>\n<li>根据实际业务需求做出相应处理。\n<ul>\n<li>在这里，代码只是简单地输出了一行提示语句，需要根据实际业务场景进行定制处理，确保服务器与客户端连接正常。</li>\n</ul>\n</li>\n<li>对于空闲状态的事件，可以选择关闭通道，也可以选择保持连接，根据实际情况进行处理</li>\n</ul>\n</li>\n<li>\n<p>代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServerHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> ctx 上下文</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> evt 事件</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">userEventTriggered</span><span class=\"params\">(ChannelHandlerContext ctx, Object evt)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (evt <span class=\"keyword\">instanceof</span> IdleStateEvent) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//将  evt 向下转型 IdleStateEvent</span></span><br><span class=\"line\">            <span class=\"type\">IdleStateEvent</span> <span class=\"variable\">event</span> <span class=\"operator\">=</span> (IdleStateEvent) evt;</span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">eventType</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">switch</span> (event.state()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> READER_IDLE:</span><br><span class=\"line\">                    eventType = <span class=\"string\">&quot;读空闲&quot;</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> WRITER_IDLE:</span><br><span class=\"line\">                    eventType = <span class=\"string\">&quot;写空闲&quot;</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> ALL_IDLE:</span><br><span class=\"line\">                    eventType = <span class=\"string\">&quot;读写空闲&quot;</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            System.out.println(ctx.channel().remoteAddress() + <span class=\"string\">&quot;--超时时间--&quot;</span> + eventType);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;服务器做相应处理..&quot;</span>);</span><br><span class=\"line\">            <span class=\"comment\">//如果发生空闲，我们关闭通道</span></span><br><span class=\"line\">            <span class=\"comment\">// ctx.channel().close();</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h4 id=\"Netty-通过-WebSocket-编程实现服务器和客户端长连接\">Netty 通过 WebSocket 编程实现服务器和客户端长连接</h4>\n<p>需求：</p>\n<ol>\n<li><code>Http</code> 协议是无状态的，浏览器和服务器间的请求响应一次，下一次会重新创建连接。</li>\n<li>要求：实现基于 <code>WebSocket</code> 的<code>长连接的全双工的交互</code></li>\n<li>改变 <code>Http</code> 协议多次请求的约束，实现长连接了，服务器可以发送消息给浏览器</li>\n<li>客户端浏览器和服务器端会相互感知，比如服务器关闭了，浏览器会感知，同样浏览器关闭了，服务器会感知</li>\n<li>运行界面</li>\n</ol>\n<blockquote>\n<p>未了解，可以借助 gpt 进行理解和翻译</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.atguigu.netty.websocket;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.channel.ChannelFuture;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.channel.ChannelInitializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.channel.ChannelPipeline;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.channel.EventLoopGroup;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.handler.codec.http.HttpObjectAggregator;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.handler.codec.http.HttpServerCodec;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.handler.logging.LogLevel;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.handler.logging.LoggingHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.handler.stream.ChunkedWriteHandler;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServer</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//创建两个线程组</span></span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">bossGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">workerGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(); <span class=\"comment\">//8个NioEventLoop</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">ServerBootstrap</span> <span class=\"variable\">serverBootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ServerBootstrap</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">            serverBootstrap.group(bossGroup, workerGroup);</span><br><span class=\"line\">            serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class=\"line\">            serverBootstrap.handler(<span class=\"keyword\">new</span> <span class=\"title class_\">LoggingHandler</span>(LogLevel.INFO));</span><br><span class=\"line\">            serverBootstrap.childHandler(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                    <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//因为基于http协议，使用http的编码和解码器</span></span><br><span class=\"line\">                    pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">HttpServerCodec</span>());</span><br><span class=\"line\">                    <span class=\"comment\">//是以块方式写，添加ChunkedWriteHandler处理器</span></span><br><span class=\"line\">                    pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">ChunkedWriteHandler</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">                    说明</span></span><br><span class=\"line\"><span class=\"comment\">                    1. http数据在传输过程中是分段, HttpObjectAggregator ，就是可以将多个段聚合</span></span><br><span class=\"line\"><span class=\"comment\">                    2. 这就就是为什么，当浏览器发送大量数据时，就会发出多次http请求</span></span><br><span class=\"line\"><span class=\"comment\">                     */</span></span><br><span class=\"line\">                    pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">HttpObjectAggregator</span>(<span class=\"number\">8192</span>));</span><br><span class=\"line\">                    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">                    说明</span></span><br><span class=\"line\"><span class=\"comment\">                    1. 对应websocket ，它的数据是以 帧(frame) 形式传递</span></span><br><span class=\"line\"><span class=\"comment\">                    2. 可以看到WebSocketFrame 下面有六个子类</span></span><br><span class=\"line\"><span class=\"comment\">                    3. 浏览器请求时 ws://localhost:7000/hello 表示请求的uri</span></span><br><span class=\"line\"><span class=\"comment\">                    4. WebSocketServerProtocolHandler 核心功能是将 http协议升级为 ws协议 , 保持长连接</span></span><br><span class=\"line\"><span class=\"comment\">                    5. 是通过一个 状态码 101</span></span><br><span class=\"line\"><span class=\"comment\">                     */</span></span><br><span class=\"line\">                    pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">WebSocketServerProtocolHandler</span>(<span class=\"string\">&quot;/hello2&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//自定义的handler ，处理业务逻辑</span></span><br><span class=\"line\">                    pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyTextWebSocketFrameHandler</span>());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//启动服务器</span></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> serverBootstrap.bind(<span class=\"number\">7000</span>).sync();</span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            bossGroup.shutdownGracefully();</span><br><span class=\"line\">            workerGroup.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.atguigu.netty.websocket;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.netty.handler.codec.http.websocketx.TextWebSocketFrame;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.LocalDateTime;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//这里 TextWebSocketFrame 类型，表示一个文本帧(frame)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyTextWebSocketFrameHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleChannelInboundHandler</span>&lt;TextWebSocketFrame&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead0</span><span class=\"params\">(ChannelHandlerContext ctx, TextWebSocketFrame msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器收到消息 &quot;</span> + msg.text());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//回复消息</span></span><br><span class=\"line\">        ctx.channel().writeAndFlush(<span class=\"keyword\">new</span> <span class=\"title class_\">TextWebSocketFrame</span>(<span class=\"string\">&quot;服务器时间&quot;</span> + LocalDateTime.now() + <span class=\"string\">&quot; &quot;</span> + msg.text()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//当web客户端连接后， 触发方法</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handlerAdded</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//id 表示唯一的值，LongText 是唯一的 ShortText 不是唯一</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;handlerAdded 被调用&quot;</span> + ctx.channel().id().asLongText());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;handlerAdded 被调用&quot;</span> + ctx.channel().id().asShortText());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">handlerRemoved</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;handlerRemoved 被调用&quot;</span> + ctx.channel().id().asLongText());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;异常发生 &quot;</span> + cause.getMessage());</span><br><span class=\"line\">        ctx.close(); <span class=\"comment\">//关闭连接</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">hello.html</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html lang=<span class=\"string\">&quot;en&quot;</span>&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;meta charset=<span class=\"string\">&quot;UTF-8&quot;</span>&gt;</span><br><span class=\"line\">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> socket;</span><br><span class=\"line\">    <span class=\"comment\">//判断当前浏览器是否支持websocket</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(window.WebSocket) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//go on</span></span><br><span class=\"line\">        socket = <span class=\"keyword\">new</span> <span class=\"title class_\">WebSocket</span>(<span class=\"string\">&quot;ws://localhost:7000/hello2&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//相当于channelReado, ev 收到服务器端回送的消息</span></span><br><span class=\"line\">        socket.onmessage = function (ev) &#123;</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">rt</span> <span class=\"operator\">=</span> document.getElementById(<span class=\"string\">&quot;responseText&quot;</span>);</span><br><span class=\"line\">            rt.value = rt.value + <span class=\"string\">&quot;\\n&quot;</span> + ev.data;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//相当于连接开启(感知到连接开启)</span></span><br><span class=\"line\">        socket.onopen = function (ev) &#123;</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">rt</span> <span class=\"operator\">=</span> document.getElementById(<span class=\"string\">&quot;responseText&quot;</span>);</span><br><span class=\"line\">            rt.value = <span class=\"string\">&quot;连接开启了..&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//相当于连接关闭(感知到连接关闭)</span></span><br><span class=\"line\">        socket.onclose = function (ev) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">rt</span> <span class=\"operator\">=</span> document.getElementById(<span class=\"string\">&quot;responseText&quot;</span>);</span><br><span class=\"line\">            rt.value = rt.value + <span class=\"string\">&quot;\\n&quot;</span> + <span class=\"string\">&quot;连接关闭了..&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        alert(<span class=\"string\">&quot;当前浏览器不支持websocket&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//发送消息到服务器</span></span><br><span class=\"line\">    function <span class=\"title function_\">send</span><span class=\"params\">(message)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!window.socket) &#123; <span class=\"comment\">//先判断socket是否创建好</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(socket.readyState == WebSocket.OPEN) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//通过socket 发送消息</span></span><br><span class=\"line\">            socket.send(message)</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            alert(<span class=\"string\">&quot;连接没有开启&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">    &lt;form onsubmit=<span class=\"string\">&quot;return false&quot;</span>&gt;</span><br><span class=\"line\">        &lt;textarea name=<span class=\"string\">&quot;message&quot;</span> style=<span class=\"string\">&quot;height: 300px; width: 300px&quot;</span>&gt;&lt;/textarea&gt;</span><br><span class=\"line\">        &lt;input type=<span class=\"string\">&quot;button&quot;</span> value=<span class=\"string\">&quot;发生消息&quot;</span> onclick=<span class=\"string\">&quot;send(this.form.message.value)&quot;</span>&gt;</span><br><span class=\"line\">        &lt;textarea id=<span class=\"string\">&quot;responseText&quot;</span> style=<span class=\"string\">&quot;height: 300px; width: 300px&quot;</span>&gt;&lt;/textarea&gt;</span><br><span class=\"line\">        &lt;input type=<span class=\"string\">&quot;button&quot;</span> value=<span class=\"string\">&quot;清空内容&quot;</span> onclick=<span class=\"string\">&quot;document.getElementById(&#x27;responseText&#x27;).value=&#x27;&#x27;&quot;</span>&gt;</span><br><span class=\"line\">    &lt;/form&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"Google-Protobuf\">Google Protobuf</h2>\n<blockquote>\n<p><code>Google Protobuf</code>是什么：</p>\n<ul>\n<li>是Google开发的一种高效的数据交换格式，也是一种轻量级的数据序列化框架。它可以将结构化的数据序列化、反序列化，并可用于网络传输、数据存储等场景。</li>\n</ul>\n<p><code>Netty</code>中的<code>Google Protobuf</code>:</p>\n<ul>\n<li><code>Netty</code>提供了一种基于<code>Google Protobuf</code>的编解码器，可以方便地将<code>Protobuf</code>格式的消息进行<code>序列化和反序列化</code>，并与Netty的数据处理管道（<code>Pipeline</code>）无缝集成</li>\n</ul>\n</blockquote>\n<h4 id=\"编码解码基本介绍\">编码解码基本介绍</h4>\n<ul>\n<li>编码解码的原因：因为数据在网络中传输的都是<code>二进制字节码数据</code>，在<code>发送数据时就需要编码</code>，<code>接收数据时就需要解码</code></li>\n<li><code>codec</code>（编解码器）的组成部分有两个：\n<ul>\n<li><code>decoder</code>（解码器）：<code>encoder</code> 负责把业务数据转换成字节码数据</li>\n<li><code>encoder</code>（编码器）：<code>decoder</code> 负责把字节码数据转换成业务数据</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"Netty本身编码解码所携带的问题\">Netty本身编码解码所携带的问题</h4>\n<ul>\n<li>\n<p><code>Netty</code> 自身提供了一些 <code>codec</code>(编解码器)</p>\n</li>\n<li>\n<p><code>Netty</code> 提供的编码器</p>\n<ul>\n<li><code>StringEncoder</code>，对字符串数据进行编码</li>\n<li><code>ObjectEncoder</code>，对<code>Java</code>对象进行编码</li>\n</ul>\n</li>\n<li>\n<p><code>Netty</code> 提供的解码器</p>\n<ul>\n<li><code>StringDecoder</code>，对字符串数据进行解码</li>\n<li><code>ObjectDecoder</code>，对 <code>Java</code> 对象进行解码</li>\n</ul>\n</li>\n<li>\n<p><code>Netty</code> 本身自带的 <code>ObjectDecoder</code> 和 <code>ObjectEncoder</code> 可以用来实现 <code>POJO</code> 对象或各种业务对象的<code>编码和解码</code>，底层使用的仍是Java序列化技术,而Java序列化技术本身效率就不高，存在如下问题</p>\n<ul>\n<li>\n<p>无法跨语言</p>\n</li>\n<li>\n<p>序列化后的体积太大，是二进制编码的5倍多。</p>\n</li>\n<li>\n<p>序列化性能太低</p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"解决方案—Protobuf\">解决方案—Protobuf</h4>\n<ul>\n<li>\n<p><code>Protobuf</code> 是以 <code>message</code> 的方式来管理数据的.</p>\n</li>\n<li>\n<p>[官方文档][<a href=\"https://developers.google.com/protocol-buffers/docs/proto\">https://developers.google.com/protocol-buffers/docs/proto</a>]</p>\n</li>\n<li>\n<p>使用 <code>protobuf</code> 编译器能自动生成代码，<code>Protobuf</code> 是将类的定义使用 <code>.proto</code> 文件进行描述。</p>\n<ul>\n<li>说明，在 <code>idea</code> 中编写 <code>.proto</code> 文件时，会自动提示是否下载 <code>.ptoto</code> 编写插件，作用是可以让语法高亮。</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"案例理解\">案例理解</h4>\n<blockquote>\n<p>需求：</p>\n<ol>\n<li>编写程序，使用 <code>Protobuf</code> 完成如下功能</li>\n<li>客户端可以随机发送 <code>StudentPoJo</code> / <code>WorkerPoJo</code> 对象到服务器(通过 <code>Protobuf</code> 编码)</li>\n<li>服务端能接收 <code>StudentPoJo</code> / <code>WorkerPoJo</code> 对象(需要判断是哪种类型)，并显示信息(通过 <code>Protobuf</code> 解码)</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>.Proto文件</p>\n</blockquote>\n<figure class=\"highlight protobuf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">syntax = <span class=\"string\">&quot;proto3&quot;</span>; <span class=\"comment\">//版本</span></span><br><span class=\"line\"><span class=\"keyword\">option</span> optimize_for = SPEED; <span class=\"comment\">// 加快解析</span></span><br><span class=\"line\"><span class=\"keyword\">option</span> java_package=<span class=\"string\">&quot;com.ry.netty.codec&quot;</span>;   <span class=\"comment\">//指定生成到哪个包下</span></span><br><span class=\"line\"><span class=\"keyword\">option</span> java_outer_classname = <span class=\"string\">&quot;MyDataInfo&quot;</span>;<span class=\"comment\">//生成的外部类名，同时也是文件名</span></span><br><span class=\"line\"><span class=\"comment\">//protobuf 使用message 管理数据</span></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">1.protobuf 可以使用message 管理其他的message。最终决定使用哪一个message作为传输对象</span></span><br><span class=\"line\"><span class=\"comment\">2.假设你某个项目需要传输20个对象，你不可能新建20个proto文件吧。此时你就可以在一个文件里定义20个message，最后再用一个总的message（比方说这里的MyMessage）来决定在实际传输时真正需要传输哪一个对象</span></span><br><span class=\"line\"><span class=\"comment\">3.因为你实际传输的时候大部分情况传输的都是一个对象，所以下面用oneof进行了限制</span></span><br><span class=\"line\"><span class=\"comment\">4.是否可以传多个对象呢？我个人认为是可以的，比如可以通过map(目前我也不太了解proto的语法)</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">message </span><span class=\"title class_\">MyMessage</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//定义一个枚举类型,DataType如果是0则表示一个Student对象实例，DataType这个名称自定义</span></span><br><span class=\"line\">    <span class=\"keyword\">enum </span><span class=\"title class_\">DataType</span> &#123;</span><br><span class=\"line\">        StudentType = <span class=\"number\">0</span>; <span class=\"comment\">//在proto3 要求enum的编号从0开始</span></span><br><span class=\"line\">        WorkerType = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//用data_type 来标识传的是哪一个枚举类型，这里才真正开始定义MyMessage的数据类型</span></span><br><span class=\"line\">    DataType data_type = <span class=\"number\">1</span>;  <span class=\"comment\">//所有后面的数字都只是编号而已</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    1.oneof关键字 表示每次枚举类型进行传输时，限制最多只能传输一个对象。</span></span><br><span class=\"line\"><span class=\"comment\">    dataBody名称也是自定义的</span></span><br><span class=\"line\"><span class=\"comment\">    2.为什么这里的序号是2呢？因为上面DataType data_type = 1  占了第一个序号了</span></span><br><span class=\"line\"><span class=\"comment\">    3.MyMessage里真正出现的类型只有两个</span></span><br><span class=\"line\"><span class=\"comment\">      ①DataType类型</span></span><br><span class=\"line\"><span class=\"comment\">      ②Student类型或者Worker类型（这两个在真正传输的时候只会有一个出现）</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">oneof</span> dataBody &#123;</span><br><span class=\"line\">        Student student = <span class=\"number\">2</span>;  <span class=\"comment\">//注意这后面的数字也都只是编号而已</span></span><br><span class=\"line\">        Worker worker = <span class=\"number\">3</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">message </span><span class=\"title class_\">Student</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int32</span> id = <span class=\"number\">1</span>;<span class=\"comment\">//Student类的属性</span></span><br><span class=\"line\">    <span class=\"type\">string</span> name = <span class=\"number\">2</span>; <span class=\"comment\">//</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">message </span><span class=\"title class_\">Worker</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">string</span> name=<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"type\">int32</span> age=<span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>编译<br>\n<code>protoc.exe--java_out=.MyMessage.proto</code><br>\n将生成的 <code>MyMessagePOJO</code> 放入到项目使用</p>\n</blockquote>\n<blockquote>\n<p><code>NettyServer</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyServer</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">bossGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">workerGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(); </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//创建服务器端的启动对象，配置参数</span></span><br><span class=\"line\">            <span class=\"type\">ServerBootstrap</span> <span class=\"variable\">bootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ServerBootstrap</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//使用链式编程来进行设置</span></span><br><span class=\"line\">            bootstrap.group(bossGroup, workerGroup) <span class=\"comment\">//设置两个线程组</span></span><br><span class=\"line\">                    .channel(NioServerSocketChannel.class) <span class=\"comment\">//使用NioSocketChannel 作为服务器的通道实现</span></span><br><span class=\"line\">                    .option(ChannelOption.SO_BACKLOG, <span class=\"number\">128</span>) <span class=\"comment\">// 设置线程队列得到连接个数</span></span><br><span class=\"line\">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class=\"literal\">true</span>) <span class=\"comment\">//设置保持活动连接状态</span></span><br><span class=\"line\"><span class=\"comment\">//                    .handler(null) // 该 handler对应 bossGroup , childHandler 对应 workerGroup</span></span><br><span class=\"line\">                    .childHandler(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;<span class=\"comment\">//创建一个通道初始化对象(匿名对象)</span></span><br><span class=\"line\">                        <span class=\"comment\">//给pipeline 设置处理器</span></span><br><span class=\"line\">                        <span class=\"meta\">@Override</span></span><br><span class=\"line\">                        <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\">                            <span class=\"comment\">//在pipeline加入ProtoBufDecoder</span></span><br><span class=\"line\"> ====================改进==========    </span><br><span class=\"line\"><span class=\"comment\">//指定对哪种对象进行解码，并显示信息</span></span><br><span class=\"line\"> pipeline.addLast(<span class=\"string\">&quot;decoder&quot;</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">ProtobufDecoder</span>(MyDataInfo.MyMessage.getDefaultInstance()));</span><br><span class=\"line\">                            pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">NettyServerHandler</span>());</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;); <span class=\"comment\">// 给我们的workerGroup 的 EventLoop 对应的管道设置处理器</span></span><br><span class=\"line\"></span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;.....服务器 is ready...&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//绑定一个端口并且同步, 生成了一个 ChannelFuture 对象</span></span><br><span class=\"line\">            <span class=\"comment\">//启动服务器(并绑定端口)</span></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">cf</span> <span class=\"operator\">=</span> bootstrap.bind(<span class=\"number\">6668</span>).sync();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//给cf 注册监听器，监控我们关心的事件</span></span><br><span class=\"line\"></span><br><span class=\"line\">            cf.addListener(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelFutureListener</span>() &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">operationComplete</span><span class=\"params\">(ChannelFuture future)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (cf.isSuccess()) &#123;</span><br><span class=\"line\">                        System.out.println(<span class=\"string\">&quot;监听端口 6668 成功&quot;</span>);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        System.out.println(<span class=\"string\">&quot;监听端口 6668 失败&quot;</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//对关闭通道进行监听</span></span><br><span class=\"line\">            cf.channel().closeFuture().sync();</span><br><span class=\"line\">        &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            bossGroup.shutdownGracefully();</span><br><span class=\"line\">            workerGroup.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>NettyServerHandler</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyServerHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleChannelInboundHandler</span>&lt;MyDataInfo.MyMessage&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//读取数据实际(这里我们可以读取客户端发送的消息)</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    1. ChannelHandlerContext ctx:上下文对象, 含有 管道pipeline , 通道channel, 地址</span></span><br><span class=\"line\"><span class=\"comment\">    2. Object msg: 就是客户端发送的数据 默认Object</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead0</span><span class=\"params\">(ChannelHandlerContext ctx, MyDataInfo.MyMessage msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//根据dataType 来显示不同的信息</span></span><br><span class=\"line\">        MyDataInfo.MyMessage.<span class=\"type\">DataType</span> <span class=\"variable\">dataType</span> <span class=\"operator\">=</span> msg.getDataType();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(dataType == MyDataInfo.MyMessage.DataType.StudentType) &#123;</span><br><span class=\"line\">            MyDataInfo.<span class=\"type\">Student</span> <span class=\"variable\">student</span> <span class=\"operator\">=</span> msg.getStudent();</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;学生id=&quot;</span> + student.getId() + <span class=\"string\">&quot; 学生名字=&quot;</span> + student.getName());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(dataType == MyDataInfo.MyMessage.DataType.WorkerType) &#123;</span><br><span class=\"line\">            MyDataInfo.<span class=\"type\">Worker</span> <span class=\"variable\">worker</span> <span class=\"operator\">=</span> msg.getWorker();</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;工人的名字=&quot;</span> + worker.getName() + <span class=\"string\">&quot; 年龄=&quot;</span> + worker.getAge());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;传输的类型不正确&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//数据读取完毕</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelReadComplete</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//writeAndFlush 是 write + flush</span></span><br><span class=\"line\">        <span class=\"comment\">//将数据写入到缓存，并刷新</span></span><br><span class=\"line\">        <span class=\"comment\">//一般讲，我们对这个发送的数据进行编码</span></span><br><span class=\"line\">        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class=\"string\">&quot;hello, 客户端~(&gt;^ω^&lt;)喵1&quot;</span>, CharsetUtil.UTF_8));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//处理异常, 一般是需要关闭通道</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>NettyClient</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyClient</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//客户端需要一个事件循环组</span></span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">group</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//创建客户端启动对象</span></span><br><span class=\"line\">            <span class=\"comment\">//注意客户端使用的不是 ServerBootstrap 而是 Bootstrap</span></span><br><span class=\"line\">            <span class=\"type\">Bootstrap</span> <span class=\"variable\">bootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Bootstrap</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//设置相关参数</span></span><br><span class=\"line\">            bootstrap.group(group) <span class=\"comment\">//设置线程组</span></span><br><span class=\"line\">                    .channel(NioSocketChannel.class) <span class=\"comment\">// 设置客户端通道的实现类(反射)</span></span><br><span class=\"line\">                    .handler(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class=\"line\">                        <span class=\"meta\">@Override</span></span><br><span class=\"line\">                        <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                            <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\"><span class=\"comment\">//在pipeline中加入 ProtoBufEncoder</span></span><br><span class=\"line\"> pipeline.addLast(<span class=\"string\">&quot;encoder&quot;</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">ProtobufEncoder</span>());</span><br><span class=\"line\">                            pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">NettyClientHandler</span>()); <span class=\"comment\">//加入自己的处理器</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;客户端 ok..&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//启动客户端去连接服务器端</span></span><br><span class=\"line\">            <span class=\"comment\">//关于 ChannelFuture 要分析，涉及到netty的异步模型</span></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> bootstrap.connect(<span class=\"string\">&quot;127.0.0.1&quot;</span>, <span class=\"number\">6668</span>).sync();</span><br><span class=\"line\">            <span class=\"comment\">//给关闭通道进行监听</span></span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\">        &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            group.shutdownGracefully();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>NettyClientHandler</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyClientHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//当通道就绪就会触发该方法</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelActive</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//随机的发送Student 或者 Workder 对象</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">random</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Random</span>().nextInt(<span class=\"number\">3</span>);</span><br><span class=\"line\">        MyDataInfo.<span class=\"type\">MyMessage</span> <span class=\"variable\">myMessage</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"number\">0</span> == random) &#123; <span class=\"comment\">//发送 MyDataInfo 对象</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">//客户端随机发送   StudentPoJo/WorkerPoJo  对象到服务器</span></span><br><span class=\"line\"> myMessage = MyDataInfo.MyMessage.newBuilder().setDataType(MyDataInfo.MyMessage.DataType.StudentType).setStudent(MyDataInfo.Student.newBuilder().setId(<span class=\"number\">5</span>).setName(<span class=\"string\">&quot;玉麒麟 卢俊义&quot;</span>).build()).build();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 发送一个Worker 对象</span></span><br><span class=\"line\"></span><br><span class=\"line\">            myMessage = MyDataInfo.MyMessage.newBuilder().setDataType(MyDataInfo.MyMessage.DataType.WorkerType).setWorker(MyDataInfo.Worker.newBuilder().setAge(<span class=\"number\">20</span>).setName(<span class=\"string\">&quot;老李&quot;</span>).build()).build();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        ctx.writeAndFlush(myMessage);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//当通道有读取事件时，会触发</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead</span><span class=\"params\">(ChannelHandlerContext ctx, Object msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">ByteBuf</span> <span class=\"variable\">buf</span> <span class=\"operator\">=</span> (ByteBuf) msg;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器回复的消息:&quot;</span> + buf.toString(CharsetUtil.UTF_8));</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器的地址： &quot;</span>+ ctx.channel().remoteAddress());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        cause.printStackTrace();</span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Netty-编解码器和-Handler-调用机制\">Netty 编解码器和 Handler 调用机制</h2>\n<h4 id=\"基本说明\">基本说明</h4>\n<ol>\n<li><code>Netty</code> 的组件设计：<code>Netty</code> 的主要组件有 <code>Channel</code>、<code>EventLoop</code>、<code>ChannelFuture</code>、<code>ChannelHandler</code>、<code>ChannelPipe</code> 等</li>\n<li><code>ChannelHandler</code> 充当了处理入站和出站数据的应用程序逻辑的容器。\n<ul>\n<li>例如,实现 <code>ChannelInboundHandler</code> 接口（或<code>ChannelInboundHandlerAdapter</code>）,可以接收入站事件和数据，这些数据会被业务逻辑处理。</li>\n<li>当要给客户端发送响应时，也可以从 <code>ChannelInboundHandler</code> 冲刷数据。</li>\n<li>业务逻辑通常写在一个或者多个 <code>ChannelInboundHandler</code> 中。</li>\n<li><code>ChannelOutboundHandler</code> 原理一样，只不过它是用来处理出站数据的</li>\n</ul>\n</li>\n<li><code>ChannelPipeline</code> 提供了 <code>ChannelHandler</code> 链的容器。以客户端应用程序为例，如果事件的运动方向是从客户端到服务端的，那么我们称这些事件为出站的，即客户端发送给服务端的数据会通过 <code>pipeline</code> 中的一系列 <code>ChannelOutboundHandler</code>，并被这些 <code>Handler</code> 处理，反之则称为入站的</li>\n</ol>\n<h4 id=\"编解码器\">编解码器</h4>\n<ul>\n<li>当 <code>Netty</code> 发送或者接受一个消息的时候，就将会发生一次数据转换。\n<ul>\n<li>入站消息会被解码：从字节转换为另一种格式（比如 <code>java</code> 对象）</li>\n<li>如果是出站消息，它会被编码成字节。</li>\n</ul>\n</li>\n<li><code>Netty</code> 提供一系列实用的编解码器，他们都实现了 <code>ChannelInboundHadnler</code> 或者 <code>ChannelOutboundHandler</code> 接口。\n<ul>\n<li>在这些类中，<code>channelRead</code> 方法已经被重写了。\n<ul>\n<li>以入站为例，对于每个从入站 <code>Channel</code> 读取的消息，这个方法会被调用。随后，它将调用由解码器所提供的 <code>decode()</code> 方法进行解码，并将已经解码的字节转发给 <code>ChannelPipeline</code> 中的下一个 <code>ChannelInboundHandler</code>。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"解码器\">解码器</h4>\n<h5 id=\"解码器-ByteToMessageDecoder\">解码器 - ByteToMessageDecoder</h5>\n<ul>\n<li>继承类关系</li>\n</ul>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306132035154.png\" style=\"zoom:33%;\">\n<ul>\n<li>由于不可能知道远程节点<code>是否会一次性</code>发送<code>一个完整的信息</code>，<code>tcp</code> 有可能出现<code>粘包拆包</code>的问题，这个类会对<code>入站数据</code>进行<code>缓冲</code>，直到它准备好被处理</li>\n</ul>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306132047720.png\" alt=\"image-20230613204729620\" style=\"zoom:43%;\">\n<h5 id=\"Netty-的-handler-链的调用机制\">Netty 的 handler 链的调用机制</h5>\n<ul>\n<li>不论解码器 <code>handler</code> 还是编码器 <code>handler</code> 即接收的消息类型必须与待处理的消息类型一致，否则该 <code>handler</code> 不会被执行</li>\n<li>在解码器进行<code>数据解码</code>时，需要判断缓存区（<code>ByteBuf</code>）的数据是否足够，否则<code>接收到的结果</code>和<code>期望结果可能</code>不一致</li>\n</ul>\n<h6 id=\"应用实例：\">应用实例：</h6>\n<blockquote>\n<p>使用自定义的编码器和解码器来说明 <code>Netty</code> 的 <code>handler</code> 调用机制 客户端发送 <code>long</code> -&gt; 服务器 服务端发送 <code>long</code> -&gt; 客户端</p>\n</blockquote>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306132057949.png\" alt=\"image-20230613205733785\" style=\"zoom:50%;\">\n<h6 id=\"服务端-2\">服务端</h6>\n<blockquote>\n<p><code>Myserver</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServer</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">bossGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">workerGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">ServerBootstrap</span> <span class=\"variable\">serverBootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ServerBootstrap</span>();</span><br><span class=\"line\">            serverBootstrap</span><br><span class=\"line\">                .group(bossGroup,workerGroup)</span><br><span class=\"line\">                .channel(NioServerSocketChannel.class)</span><br><span class=\"line\">                .childHandler(<span class=\"keyword\">new</span> <span class=\"title class_\">MyServerInitializer</span>()); <span class=\"comment\">//自定义一个初始化类</span></span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> serverBootstrap.bind(<span class=\"number\">7000</span>).sync();</span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\">        &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            bossGroup.shutdownGracefully();</span><br><span class=\"line\">            workerGroup.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyServerInitializer</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServerInitializer</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//入站的handler进行解码 MyByteToLongDecoder</span></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyByteToLongDecoder</span>());</span><br><span class=\"line\">        <span class=\"comment\">//出站的handler进行编码</span></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyLongToByteEncoder</span>());</span><br><span class=\"line\">        <span class=\"comment\">//自定义的handler 处理业务逻辑</span></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyServerHandler</span>());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;xx&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyServerHandler</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServerHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleChannelInboundHandler</span>&lt;Long&gt; &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead0</span><span class=\"params\">(ChannelHandlerContext ctx, Long msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;从客户端&quot;</span> + ctx.channel().remoteAddress() + <span class=\"string\">&quot; 读取到long &quot;</span> + msg);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//给客户端发送一个long</span></span><br><span class=\"line\">        ctx.writeAndFlush(<span class=\"number\">98765L</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        cause.printStackTrace();</span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"客户端\">客户端</h6>\n<blockquote>\n<p><code>MyClient</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyClient</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span>  <span class=\"keyword\">throws</span>  Exception&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">group</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">Bootstrap</span> <span class=\"variable\">bootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Bootstrap</span>();</span><br><span class=\"line\">            bootstrap</span><br><span class=\"line\">                .group(group)</span><br><span class=\"line\">                .channel(NioSocketChannel.class)   </span><br><span class=\"line\">                .handler(<span class=\"keyword\">new</span> <span class=\"title class_\">MyClientInitializer</span>()); <span class=\"comment\">//自定义一个初始化类</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> bootstrap.connect(<span class=\"string\">&quot;localhost&quot;</span>, <span class=\"number\">7000</span>).sync();</span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            group.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyClientInitializer</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyClientInitializer</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//加入一个出站的handler 对数据进行一个编码</span></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyLongToByteEncoder</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//这时一个入站的解码器(入站handler )</span></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyByteToLongDecoder</span>());</span><br><span class=\"line\">        <span class=\"comment\">//加入一个自定义的handler ， 处理业务</span></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyClientHandler</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyClientHandler </code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyClientHandler</span>  <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleChannelInboundHandler</span>&lt;Long&gt; &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead0</span><span class=\"params\">(ChannelHandlerContext ctx, Long msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器的ip=&quot;</span> + ctx.channel().remoteAddress());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;收到服务器消息=&quot;</span> + msg);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//重写channelActive 发送数据</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelActive</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;MyClientHandler 发送数据&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;&quot;))</span></span><br><span class=\"line\">        ctx.writeAndFlush(<span class=\"number\">123456L</span>); <span class=\"comment\">//发送的是一个long</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyByteToLongDecoder</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyByteToLongDecoder</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ByteToMessageDecoder</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * decode 会根据接收的数据，被调用多次, 直到确定没有新的元素被添加到list, 或者是ByteBuf 没有更多的可读字节为止</span></span><br><span class=\"line\"><span class=\"comment\">     * 如果list out 不为空，就会将list的内容传递给下一个 channelinboundhandler处理,</span></span><br><span class=\"line\"><span class=\"comment\">     * 该处理器的方法也会被调用多次</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> ctx 上下文对象</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> in 入站的 ByteBuf</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> out List 集合，将解码后的数据传给下一个handler</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">decode</span><span class=\"params\">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;MyByteToLongDecoder 被调用&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//因为 long 8个字节, 需要判断有8个字节，才能读取一个long</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(in.readableBytes() &gt;= <span class=\"number\">8</span>) &#123;</span><br><span class=\"line\">            out.add(in.readLong());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyLongToByteDecoder</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyLongToByteEncoder</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">MessageToByteEncoder</span>&lt;Long&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">//编码方法</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">encode</span><span class=\"params\">(ChannelHandlerContext ctx, Long msg, ByteBuf out)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;MyLongToByteEncoder encode 被调用&quot;</span>);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;msg=&quot;</span> + msg);</span><br><span class=\"line\">        out.writeLong(msg);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>效果</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306132103233.png\" alt></p>\n<blockquote>\n<p>关于<code>出站入站</code>，很多人可能有点迷糊</p>\n<ul>\n<li>客户端有出站入站，服务端也有出站入站</li>\n<li>以客户端为例，如果有服务端传送的数据到达客户端，那么对于客户端来说就是入站； 如果客户端传送数据到服务端，那么对于客户端来说就是出站； 同理，对于服务端来说，也是一样的，有数据来就是入站，有数据输出就是出站</li>\n<li>为什么服务端和客户端的<code>Serverhandler</code>都是继承<code>SimpleChannelInboundHandler</code>，而没有<code>ChannelOutboundHandler</code>出站类？\n<ul>\n<li>实际上当我们在<code>handler</code>中调用<code>ctx.writeAndFlush()</code>方法后，就会将数据交给<code>ChannelOutboundHandler</code>进行出站处理，只是我们没有去定义出站类而已，若有需求可以自己去实现<code>ChannelOutboundHandler</code>出站类</li>\n</ul>\n</li>\n<li>总结\n<ul>\n<li>就是客户端和服务端都有出站和入站的操作\n<ul>\n<li>**服务端发数据给客户端：**服务端—&gt;出站—&gt;Socket通道—&gt;入站—&gt;客户端</li>\n<li>**客户端发数据给服务端：**客户端—&gt;出站—&gt;Socket通道—&gt;入站—&gt;服务端</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<h5 id=\"解码器-ReplayingDecoder\">解码器 - ReplayingDecoder</h5>\n<ul>\n<li><code>public abstract class ReplayingDecoder&lt;S&gt; extends ByteToMessageDecoder</code></li>\n<li><code>ReplayingDecoder</code> 扩展了 <code>ByteToMessageDecoder</code> 类，使用这个类，我们不必调用 <code>readableBytes()</code> 方法。参数 <code>S</code> 指定了用户状态管理的类型，其中 <code>Void</code> 代表不需要状态管理</li>\n</ul>\n<p>特点</p>\n<ul>\n<li>使用方便但是有局限性\n<ul>\n<li>并不是所有的 <code>ByteBuf</code> 操作都被支持，如果调用了一个不被支持的方法，将会抛出一个 <code>UnsupportedOperationException</code>。</li>\n<li><code>ReplayingDecoder</code> 在某些情况下可能稍慢于 <code>ByteToMessageDecoder</code>，\n<ul>\n<li>例如网络缓慢并且消息格式复杂时，消息会被拆成了多个碎片，速度变慢</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>应用实例：使用 <code>ReplayingDecoder</code> 编写解码器，对上面的案例的进行简化</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyByteToLongDecoder2</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ReplayingDecoder</span>&lt;Void&gt; &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">decode</span><span class=\"params\">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;MyByteToLongDecoder2 被调用&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//在 ReplayingDecoder 不需要判断数据是否足够读取，内部会进行处理判断</span></span><br><span class=\"line\">        out.add(in.readLong());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"其他编解码器\">其他编解码器</h5>\n<ol>\n<li><code>LineBasedFrameDecoder</code>：这个类在 <code>Netty</code> 内部也有使用，它使用行尾控制字符（\\n或者\\r\\n）作为分隔符来解析数据。</li>\n<li><code>DelimiterBasedFrameDecoder</code>：使用自定义的特殊字符作为消息的分隔符。</li>\n<li><code>HttpObjectDecoder</code>：一个 <code>HTTP</code> 数据的解码器</li>\n<li><code>LengthFieldBasedFrameDecoder</code>：通过指定长度来标识整包消息，这样就可以自动的处理黏包和半包消息。</li>\n</ol>\n<h4 id=\"Log4j整合到Netty\">Log4j整合到Netty</h4>\n<blockquote>\n<ol>\n<li>在 <code>Maven</code> 中添加对 <code>Log4j</code> 的依赖在 <code>pom.xml</code></li>\n</ol>\n</blockquote>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>log4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>log4j<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.2.17<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-api<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.25<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-log4j12<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.25<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-simple<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.25<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<blockquote>\n<ol start=\"2\">\n<li>配置 <code>Log4j</code>，在 <code>resources/log4j.properties</code></li>\n</ol>\n</blockquote>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">log4j.rootLogger</span>=<span class=\"string\">DEBUG,stdout</span></span><br><span class=\"line\"><span class=\"attr\">log4j.appender.stdout</span>=<span class=\"string\">org.apache.log4j.ConsoleAppender</span></span><br><span class=\"line\"><span class=\"attr\">log4j.appender.stdout.layout</span>=<span class=\"string\">org.apache.log4j.PatternLayout</span></span><br><span class=\"line\"><span class=\"attr\">log4j.appender.stdout.layout.ConversionPattern</span>=<span class=\"string\">[%p]%C&#123;1&#125;-%m%n</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"TCP-的粘包拆包\">TCP 的粘包拆包</h2>\n<h4 id=\"基本介绍\">基本介绍</h4>\n<ol>\n<li><code>TCP</code> 是面向连接的，面向流的，提供高可靠性服务。收发两端（客户端和服务器端）都要有一一成对的 <code>socket</code>，因此，发送端为了将多个发给接收端的包，更有效的发给对方，使用了优化方法（<code>Nagle</code> 算法），<strong>将多次间隔较小且数据量小的数据，合并成一个大的数据块，然后进行封包</strong>。这样做虽然提高了效率，但是接收端就难于分辨出完整的数据包了，因为<code>面向流</code>的通信是<code>无消息保护边界的</code></li>\n<li>由于 <code>TCP</code> 无消息保护边界,<code>需要</code>在接收端<code>处理消息边界问题</code>，也就是我们所说的粘包、拆包问题</li>\n<li>示意图 <code>TCP</code> 粘包、拆包图解</li>\n</ol>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306132117070.png\" alt=\"image-20230613211748941\" style=\"zoom:33%;\">\n<p>对图的说明: 假设客户端分别发送了两个数据包 <code>D1</code> 和 <code>D2</code> 给服务端，由于服务端一次读取到字节数是不确定的，故可能存在以下四种情况：</p>\n<ol>\n<li>服务端分两次读取到了两个独立的数据包，分别是 <code>D1</code> 和 <code>D2</code>，==没有粘包和拆包==</li>\n<li>服务端一次接受到了两个数据包，==<code>D1</code> 和 <code>D2</code> 粘合在一起==，称之为 <code>TCP</code> 粘包</li>\n<li>服务端分两次读取到了数据包，第一次读取到了完整的 <code>D1</code> 包和 <code>D2</code>= 包的部分内容，=第二次读取到了 <code>D2</code> 包的剩余内容==，这称之为 <code>TCP</code> 拆包</li>\n<li>服务端分两次读取到了数据包，第一次读取到了 <code>D1</code> 包的部分内容 <code>D1_1</code>，第二次读取到了 <code>D1</code> 包的剩余部分内容 <code>D1_2</code> 和完整的 <code>D2</code> 包。</li>\n</ol>\n<h4 id=\"问题模拟\">问题模拟</h4>\n<blockquote>\n<p><code>MyServer</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServer</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception&#123;</span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">bossGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">workerGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">ServerBootstrap</span> <span class=\"variable\">serverBootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ServerBootstrap</span>();</span><br><span class=\"line\">            serverBootstrap.group(bossGroup,workerGroup).channel(NioServerSocketChannel.class).childHandler(<span class=\"keyword\">new</span> <span class=\"title class_\">MyServerInitializer</span>()); <span class=\"comment\">//自定义一个初始化类</span></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> serverBootstrap.bind(<span class=\"number\">7000</span>).sync();</span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\">        &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            bossGroup.shutdownGracefully();</span><br><span class=\"line\">            workerGroup.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyServerInitializer</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServerInitializer</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\"></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyServerHandler</span>());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyServerHandler</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServerHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleChannelInboundHandler</span>&lt;ByteBuf&gt;&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> count;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//cause.printStackTrace();</span></span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead0</span><span class=\"params\">(ChannelHandlerContext ctx, ByteBuf msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"title class_\">byte</span>[msg.readableBytes()];</span><br><span class=\"line\">        msg.readBytes(buffer);</span><br><span class=\"line\">        <span class=\"comment\">//将buffer转成字符串</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>(buffer, Charset.forName(<span class=\"string\">&quot;utf-8&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器接收到数据 &quot;</span> + message);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器接收到消息量=&quot;</span> + (++<span class=\"built_in\">this</span>.count));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//服务器回送数据给客户端, 回送一个随机id ,</span></span><br><span class=\"line\">        <span class=\"type\">ByteBuf</span> <span class=\"variable\">responseByteBuf</span> <span class=\"operator\">=</span> Unpooled.copiedBuffer(UUID.randomUUID().toString() + <span class=\"string\">&quot; &quot;</span>, Charset.forName(<span class=\"string\">&quot;utf-8&quot;</span>));</span><br><span class=\"line\">        ctx.writeAndFlush(responseByteBuf);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyClient</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyClient</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span>  <span class=\"keyword\">throws</span>  Exception&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">group</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">Bootstrap</span> <span class=\"variable\">bootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Bootstrap</span>();</span><br><span class=\"line\">            bootstrap.group(group).channel(NioSocketChannel.class)</span><br><span class=\"line\">                    .handler(<span class=\"keyword\">new</span> <span class=\"title class_\">MyClientInitializer</span>()); <span class=\"comment\">//自定义一个初始化类</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> bootstrap.connect(<span class=\"string\">&quot;localhost&quot;</span>, <span class=\"number\">7000</span>).sync();</span><br><span class=\"line\"></span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            group.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyClientInitializer</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyClientInitializer</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyClientHandler</span>());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyClientHandler</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyClientHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleChannelInboundHandler</span>&lt;ByteBuf&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> count;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelActive</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//使用客户端发送10条数据 hello,server 编号</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i= <span class=\"number\">0</span>; i&lt; <span class=\"number\">10</span>; ++i) &#123;</span><br><span class=\"line\">            <span class=\"type\">ByteBuf</span> <span class=\"variable\">buffer</span> <span class=\"operator\">=</span> Unpooled.copiedBuffer(<span class=\"string\">&quot;hello,server &quot;</span> + i, Charset.forName(<span class=\"string\">&quot;utf-8&quot;</span>));</span><br><span class=\"line\">            ctx.writeAndFlush(buffer);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead0</span><span class=\"params\">(ChannelHandlerContext ctx, ByteBuf msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"title class_\">byte</span>[msg.readableBytes()];</span><br><span class=\"line\">        msg.readBytes(buffer);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>(buffer, Charset.forName(<span class=\"string\">&quot;utf-8&quot;</span>));</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;客户端接收到消息=&quot;</span> + message);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;客户端接收消息数量=&quot;</span> + (++<span class=\"built_in\">this</span>.count));</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        cause.printStackTrace();</span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>效果：可以看到第一次运行时，服务器一次性将10个数据都接收了，第二次运行时分六次接收的，这就很形象的看出了TCP的粘包现象。</p>\n</blockquote>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306132126512.jpg\" alt=\"202306132126482\" style=\"zoom:33%;\">\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306132124774.png\" alt=\"image-20230613212455650\" style=\"zoom:33%;\">\n<h4 id=\"解决方案\">解决方案</h4>\n<ul>\n<li>\n<p>使用<code>自定义协议+编解码器</code>来解决</p>\n<blockquote>\n<p>关键就是要解决服务器端每次读取数据长度的问题，这个问题解决，就不会出现服务器多读或少读数据的问题，从而避免的 <code>TCP</code> 粘包、拆包。</p>\n</blockquote>\n</li>\n</ul>\n<h5 id=\"具体实例\">具体实例</h5>\n<blockquote>\n<p>需求</p>\n</blockquote>\n<pre><code>- 要求客户端总共发送 `5` 个 `Message` 对象，客户端每次发送一个 `Message` 对象\n- 服务器端每次接收一个 `Message`，分 `5` 次进行解码，每读取到一个 `Message`，会回复一个 `Message` 对象给客户端。\n</code></pre>\n<h6 id=\"数据\">数据</h6>\n<blockquote>\n<p><code>MessageProtocol</code></p>\n</blockquote>\n<figure class=\"highlight protobuf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//协议包</span></span><br><span class=\"line\">public class MessageProtocol &#123;</span><br><span class=\"line\">    private int len; <span class=\"comment\">//关键</span></span><br><span class=\"line\">    private byte[] content;</span><br><span class=\"line\"></span><br><span class=\"line\">    public int getLen() &#123;</span><br><span class=\"line\">        return len;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public void setLen(int len) &#123;</span><br><span class=\"line\">        this.len = len;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public byte[] getContent() &#123;</span><br><span class=\"line\">        return content;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public void setContent(byte[] content) &#123;</span><br><span class=\"line\">        this.content = content;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"服务端-3\">服务端</h6>\n<blockquote>\n<p><code>MyServer</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServer</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">bossGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">workerGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">ServerBootstrap</span> <span class=\"variable\">serverBootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ServerBootstrap</span>();</span><br><span class=\"line\">            serverBootstrap.group(bossGroup,workerGroup).channel(NioServerSocketChannel.class).childHandler(<span class=\"keyword\">new</span> <span class=\"title class_\">MyServerInitializer</span>()); <span class=\"comment\">//自定义一个初始化类</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> serverBootstrap.bind(<span class=\"number\">7000</span>).sync();</span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            bossGroup.shutdownGracefully();</span><br><span class=\"line\">            workerGroup.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyServerInitializer</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServerInitializer</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\"></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyMessageDecoder</span>());<span class=\"comment\">//解码器</span></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyMessageEncoder</span>());<span class=\"comment\">//编码器</span></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyServerHandler</span>());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyServerHandler</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//处理业务的handler</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyServerHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleChannelInboundHandler</span>&lt;MessageProtocol&gt;&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> count;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//cause.printStackTrace();</span></span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead0</span><span class=\"params\">(ChannelHandlerContext ctx, MessageProtocol msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//接收到数据，并处理</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">len</span> <span class=\"operator\">=</span> msg.getLen();</span><br><span class=\"line\">        <span class=\"type\">byte</span>[] content = msg.getContent();</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器接收到信息如下&quot;</span>);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;长度=&quot;</span> + len);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;内容=&quot;</span> + <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>(content, Charset.forName(<span class=\"string\">&quot;utf-8&quot;</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务器接收到消息包数量=&quot;</span> + (++<span class=\"built_in\">this</span>.count));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//回复消息</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务端开始回复消息------&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">responseContent</span> <span class=\"operator\">=</span> UUID.randomUUID().toString();</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">responseLen</span> <span class=\"operator\">=</span> responseContent.getBytes(<span class=\"string\">&quot;utf-8&quot;</span>).length;</span><br><span class=\"line\">        <span class=\"type\">byte</span>[]  responseContent2 = responseContent.getBytes(<span class=\"string\">&quot;utf-8&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//构建一个协议包</span></span><br><span class=\"line\">        <span class=\"type\">MessageProtocol</span> <span class=\"variable\">messageProtocol</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MessageProtocol</span>();</span><br><span class=\"line\">        messageProtocol.setLen(responseLen);</span><br><span class=\"line\">        messageProtocol.setContent(responseContent2);</span><br><span class=\"line\"></span><br><span class=\"line\">        ctx.writeAndFlush(messageProtocol);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"客户端-2\">客户端</h6>\n<blockquote>\n<p><code>MyClient</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyClient</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span>  <span class=\"keyword\">throws</span>  Exception&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">EventLoopGroup</span> <span class=\"variable\">group</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">Bootstrap</span> <span class=\"variable\">bootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Bootstrap</span>();</span><br><span class=\"line\">            bootstrap.group(group).channel(NioSocketChannel.class)</span><br><span class=\"line\">                    .handler(<span class=\"keyword\">new</span> <span class=\"title class_\">MyClientInitializer</span>()); <span class=\"comment\">//自定义一个初始化类</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> bootstrap.connect(<span class=\"string\">&quot;localhost&quot;</span>, <span class=\"number\">7000</span>).sync();</span><br><span class=\"line\"></span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            group.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyClientInitializer</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyClientInitializer</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyMessageEncoder</span>()); <span class=\"comment\">//加入编码器</span></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyMessageDecoder</span>()); <span class=\"comment\">//加入解码器</span></span><br><span class=\"line\">        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">MyClientHandler</span>());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyClientHandler</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyClientHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">SimpleChannelInboundHandler</span>&lt;MessageProtocol&gt; &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> count;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelActive</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//使用客户端发送10条数据 &quot;今天天气冷，吃火锅&quot; 编号</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i&lt; <span class=\"number\">5</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">mes</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;今天天气冷，吃火锅&quot;</span>;</span><br><span class=\"line\">            <span class=\"type\">byte</span>[] content = mes.getBytes(Charset.forName(<span class=\"string\">&quot;utf-8&quot;</span>));</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">length</span> <span class=\"operator\">=</span> mes.getBytes(Charset.forName(<span class=\"string\">&quot;utf-8&quot;</span>)).length;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//创建协议包对象</span></span><br><span class=\"line\">            <span class=\"type\">MessageProtocol</span> <span class=\"variable\">messageProtocol</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MessageProtocol</span>();</span><br><span class=\"line\">            messageProtocol.setLen(length);</span><br><span class=\"line\">            messageProtocol.setContent(content);</span><br><span class=\"line\">            ctx.writeAndFlush(messageProtocol);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;异常消息=&quot;</span> + cause.getMessage());</span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyMessageDecoder</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyMessageDecoder</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ReplayingDecoder</span>&lt;Void&gt; &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">decode</span><span class=\"params\">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println();</span><br><span class=\"line\">        System.out.println();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;MyMessageDecoder decode 被调用&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//需要将得到二进制字节码-&gt; MessageProtocol 数据包(对象)</span></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">length</span> <span class=\"operator\">=</span> in.readInt();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">byte</span>[] content = <span class=\"keyword\">new</span> <span class=\"title class_\">byte</span>[length];</span><br><span class=\"line\">        in.readBytes(content);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//封装成 MessageProtocol 对象，放入 out， 传递下一个handler业务处理</span></span><br><span class=\"line\">        <span class=\"type\">MessageProtocol</span> <span class=\"variable\">messageProtocol</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MessageProtocol</span>();</span><br><span class=\"line\">        messageProtocol.setLen(length);</span><br><span class=\"line\">        messageProtocol.setContent(content);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//放入out传给下一个hanlder进行处理</span></span><br><span class=\"line\">        out.add(messageProtocol);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>MyMessageEncoder</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyMessageEncoder</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">MessageToByteEncoder</span>&lt;MessageProtocol&gt; &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">encode</span><span class=\"params\">(ChannelHandlerContext ctx, MessageProtocol msg, ByteBuf out)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;MyMessageEncoder encode 方法被调用&quot;</span>);</span><br><span class=\"line\">        out.writeInt(msg.getLen());</span><br><span class=\"line\">        out.writeBytes(msg.getContent());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"效果\">效果</h6>\n<blockquote>\n<p>无论运行几次，Server都是分5次接收的，这样就解决了TCP粘包问题</p>\n</blockquote>\n<p><strong>Client输出</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MyMessageEncoder encode 方法被调用</span><br><span class=\"line\">MyMessageEncoder encode 方法被调用</span><br><span class=\"line\">MyMessageEncoder encode 方法被调用</span><br><span class=\"line\">MyMessageEncoder encode 方法被调用</span><br><span class=\"line\">MyMessageEncoder encode 方法被调用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//下面是客户端开始一个一个的收到服务端的回复</span></span><br><span class=\"line\">MyMessageDecoder decode 被调用</span><br><span class=\"line\">客户端接收到消息如下</span><br><span class=\"line\">长度=<span class=\"number\">36</span></span><br><span class=\"line\">内容=1b5286dd-0fc2-4f62-9bf7-d5fad84179b5</span><br><span class=\"line\">客户端接收消息数量=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MyMessageDecoder decode 被调用</span><br><span class=\"line\">客户端接收到消息如下</span><br><span class=\"line\">长度=<span class=\"number\">36</span></span><br><span class=\"line\">内容=653d18cb-ab72-<span class=\"number\">4163</span>-8b95-09c94ecac873</span><br><span class=\"line\">客户端接收消息数量=<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MyMessageDecoder decode 被调用</span><br><span class=\"line\">客户端接收到消息如下</span><br><span class=\"line\">长度=<span class=\"number\">36</span></span><br><span class=\"line\">内容=3be6e403-91bb-<span class=\"number\">4437</span>-ada8-6cdb9eb7ef00</span><br><span class=\"line\">客户端接收消息数量=<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MyMessageDecoder decode 被调用</span><br><span class=\"line\">客户端接收到消息如下</span><br><span class=\"line\">长度=<span class=\"number\">36</span></span><br><span class=\"line\">内容=94c8f306-fd9c-455a-956c-16698ce4150b</span><br><span class=\"line\">客户端接收消息数量=<span class=\"number\">4</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MyMessageDecoder decode 被调用</span><br><span class=\"line\">客户端接收到消息如下</span><br><span class=\"line\">长度=<span class=\"number\">36</span></span><br><span class=\"line\">内容=7890de9c-0fa2-<span class=\"number\">4317</span>-8de1-1d464315fa1b</span><br><span class=\"line\">客户端接收消息数量=<span class=\"number\">5</span></span><br></pre></td></tr></table></figure>\n<p><strong>Server输出</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MyMessageDecoder decode 被调用</span><br><span class=\"line\">服务器接收到信息如下</span><br><span class=\"line\">长度=<span class=\"number\">27</span></span><br><span class=\"line\">内容=今天天气冷，吃火锅</span><br><span class=\"line\">服务器接收到消息包数量=<span class=\"number\">1</span></span><br><span class=\"line\">服务端开始回复消息------</span><br><span class=\"line\">MyMessageEncoder encode 方法被调用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MyMessageDecoder decode 被调用</span><br><span class=\"line\">服务器接收到信息如下</span><br><span class=\"line\">长度=<span class=\"number\">27</span></span><br><span class=\"line\">内容=今天天气冷，吃火锅</span><br><span class=\"line\">服务器接收到消息包数量=<span class=\"number\">2</span></span><br><span class=\"line\">服务端开始回复消息------</span><br><span class=\"line\">MyMessageEncoder encode 方法被调用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MyMessageDecoder decode 被调用</span><br><span class=\"line\">服务器接收到信息如下</span><br><span class=\"line\">长度=<span class=\"number\">27</span></span><br><span class=\"line\">内容=今天天气冷，吃火锅</span><br><span class=\"line\">服务器接收到消息包数量=<span class=\"number\">3</span></span><br><span class=\"line\">服务端开始回复消息------</span><br><span class=\"line\">MyMessageEncoder encode 方法被调用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MyMessageDecoder decode 被调用</span><br><span class=\"line\">服务器接收到信息如下</span><br><span class=\"line\">长度=<span class=\"number\">27</span></span><br><span class=\"line\">内容=今天天气冷，吃火锅</span><br><span class=\"line\">服务器接收到消息包数量=<span class=\"number\">4</span></span><br><span class=\"line\">服务端开始回复消息------</span><br><span class=\"line\">MyMessageEncoder encode 方法被调用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">MyMessageDecoder decode 被调用</span><br><span class=\"line\">服务器接收到信息如下</span><br><span class=\"line\">长度=<span class=\"number\">27</span></span><br><span class=\"line\">内容=今天天气冷，吃火锅</span><br><span class=\"line\">服务器接收到消息包数量=<span class=\"number\">5</span></span><br><span class=\"line\">服务端开始回复消息------</span><br><span class=\"line\">MyMessageEncoder encode 方法被调用</span><br></pre></td></tr></table></figure>\n<h1>Netty实现RPC</h1>\n<h3 id=\"RPC介绍\">RPC介绍</h3>\n<ol>\n<li>\n<p><code>RPC（Remote Procedure Call）</code>—远程过程调用，是一个计算机通信协议。该协议允许运行于一台计算机的程序调用另一台计算机的子程序，而程序员无需额外地为这个交互作用编程</p>\n</li>\n<li>\n<p>两个或多个应用程序都分布在不同的服务器上，它们之间的调用都像是本地方法调用一样</p>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306132254686.png\" style=\"zoom:50%;\">\n<p>上图(<code>RPC远程调用</code>)的过程说明</p>\n<ul>\n<li>调用者(<code>Caller</code>)，调用远程API(<code>Remote API</code>)</li>\n<li>调用远程API会通过一个RPC代理(<code>RpcProxy</code>)</li>\n<li>RPC代理再去调用<code>RpcInvoker</code>(这个是PRC的调用者)</li>\n<li><code>RpcInvoker</code>通过RPC连接器(<code>RpcConnector</code>)</li>\n<li>RPC连接器用两台机器规定好的PRC协议(<code>RpcProtocol</code>)把数据进行编码</li>\n<li>接着RPC连接器通过RpcChannel通道发送到对方的PRC接收器(<code>RpcAcceptor</code>)</li>\n<li>PRC接收器通过PRC协议进行解码拿到数据</li>\n<li>然后将数据传给<code>RpcProcessor</code></li>\n<li><code>RpcProcessor</code>再传给<code>RpcInvoker</code></li>\n<li><code>RpcInvoker</code>调用<code>Remote API</code></li>\n<li>最后推给被调用者(<code>Callee</code>)</li>\n</ul>\n</li>\n</ol>\n<blockquote>\n<p>常见的 <code>RPC</code> 框架有：比较知名的如阿里的 <code>Dubbo</code>、<code>Google</code> 的 <code>gRPC</code>、<code>Go</code> 语言的 <code>rpcx</code>、<code>Apache</code> 的 <code>thrift</code>，<code>Spring</code> 旗下的 <code>SpringCloud</code>。</p>\n</blockquote>\n<h3 id=\"RPC调用\">RPC调用</h3>\n<h5 id=\"流程图\">流程图</h5>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306132249146.png\" alt=\"image-20230613224952992\" style=\"zoom:43%;\">\n<h5 id=\"流程说明\">流程说明</h5>\n<ol>\n<li>服务消费方（<code>client</code>）以本地调用方式调用服务</li>\n<li><code>client stub</code> 接收到调用后负责将方法、参数等封装成能够进行网络传输的消息体</li>\n<li><code>client stub</code> 将消息进行编码并发送到服务端</li>\n<li><code>server stub</code> 收到消息后进行解码</li>\n<li><code>server stub</code> 根据解码结果调用本地的服务</li>\n<li>本地服务执行并将结果返回给 <code>server stub</code></li>\n<li><code>server stub</code> 将返回导入结果进行编码并发送至消费者</li>\n<li><code>client stub</code> 接收到消息并进行解码</li>\n<li>服务消费方（<code>client</code>）得到结果</li>\n</ol>\n<p>小结：<code>RPC</code> 的目标就是将 <code>2 - 8</code> 这些步骤都封装起来，用户无需关心这些细节，可以像调用本地方法一样即可完成远程服务调用</p>\n<h3 id=\"实现Dubbo-RPC\">实现Dubbo RPC</h3>\n<h5 id=\"需求说明\">需求说明</h5>\n<ul>\n<li>要求用 <code>Netty</code> 实现一个简单的 <code>RPC</code> 框架；模仿 <code>Dubbo</code>，消费者和提供者约定接口和协议，消费者远程调用提供者的服务，提供者返回一个字符串，消费者打印提供者返回的数据。</li>\n</ul>\n<h5 id=\"设计说明\">设计说明</h5>\n<ol>\n<li>创建一个<code>接口</code>，定义抽象方法。用于消费者和提供者之间的约定。</li>\n<li>创建一个<code>提供者</code>，该类需要监听消费者的请求，并按照约定返回数据。</li>\n<li>创建一个<code>消费者</code>，该类需要透明的调用自己不存在的方法，内部需要使用 <code>Netty</code> 请求提供者返回数据</li>\n</ol>\n<h5 id=\"分析图\">分析图</h5>\n<img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202306132305994.png\" alt=\"image-20230613230543933\" style=\"zoom:33%;\">\n<h5 id=\"代码演示\">代码演示</h5>\n<p><code>/Users/yangrui/Z_IdeaProjects/Netty/Dubbo_RPC</code></p>\n<blockquote>\n<p><code>HelloService</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">HelloService</span> &#123;</span><br><span class=\"line\">    String <span class=\"title function_\">hello</span><span class=\"params\">(String mes)</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>HelloServieImpl</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HelloServiceImpl</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">HelloService</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"variable\">count</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 当有消费方调用该方法的时候，就返回一个结果</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">hello</span><span class=\"params\">(String mes)</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;收到客户端消息=&quot;</span> + mes);</span><br><span class=\"line\">        System.out.println();</span><br><span class=\"line\">        <span class=\"comment\">//根据传入的参数mes   返回不同的结果</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(mes != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;你好客户端, 我已经收到你的消息。消息为：[&quot;</span> + mes + <span class=\"string\">&quot;] ，第&quot;</span> + (++count) + <span class=\"string\">&quot; 次 \\n&quot;</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;你好客户端, 我已经收到你的消息 &quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>ServerBootstrap</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ServerBootstrap 会启动一个服务提供者(nettyServer)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ServerBootstrap</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        NettyServer.startServer(<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">8000</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>NettyServer</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyServer</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span>  <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startServer</span><span class=\"params\">(String hostName, <span class=\"type\">int</span> port)</span>&#123;</span><br><span class=\"line\">        startServer0(hostName, port);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//startServer0 完成对NettyServer的   初始化和  启动</span></span><br><span class=\"line\">    <span class=\"comment\">//  传入的参数就是  主机名 和 端口号</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">startServer0</span><span class=\"params\">(String hostName, <span class=\"type\">int</span> port)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">NioEventLoopGroup</span> <span class=\"variable\">bossGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"type\">NioEventLoopGroup</span> <span class=\"variable\">workerGroup</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//</span></span><br><span class=\"line\">            <span class=\"type\">ServerBootstrap</span> <span class=\"variable\">serverBootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ServerBootstrap</span>();</span><br><span class=\"line\">            serverBootstrap</span><br><span class=\"line\">                    .group(bossGroup,workerGroup) <span class=\"comment\">//填入bossGroup,workerGroup</span></span><br><span class=\"line\">                    .channel(NioServerSocketChannel.class) <span class=\"comment\">//使用NioSocketChannel 作为服务器的通道实现</span></span><br><span class=\"line\">                    .childHandler(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123; <span class=\"comment\">//设置通道的处理器,是一个初始化工具</span></span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"meta\">@Override</span></span><br><span class=\"line\">                        <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                            <span class=\"comment\">//获取到pipeline</span></span><br><span class=\"line\">                            <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\">                            <span class=\"comment\">//向pipeline加入解码器</span></span><br><span class=\"line\">                            pipeline.addLast(<span class=\"string\">&quot;decoder&quot;</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">StringDecoder</span>());</span><br><span class=\"line\">                            <span class=\"comment\">//向pipeline加入编码器</span></span><br><span class=\"line\">                            pipeline.addLast(<span class=\"string\">&quot;encoder&quot;</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">StringEncoder</span>());</span><br><span class=\"line\">                            <span class=\"comment\">//加入自己的业务处理handler</span></span><br><span class=\"line\">                            pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">NettyServerHandler</span>());</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;);</span><br><span class=\"line\">            <span class=\"comment\">//启动服务绑定端口和主机名，并进行一个异步的处理获取结果,调用 sync() 方法阻塞当前线程，并等待该 ChannelFuture 对象的完成，即等待该 Channel 关闭操作的完成</span></span><br><span class=\"line\">            <span class=\"type\">ChannelFuture</span> <span class=\"variable\">channelFuture</span> <span class=\"operator\">=</span> serverBootstrap.bind(hostName, port).sync();</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;服务提供方开始提供服务&quot;</span>);</span><br><span class=\"line\">            <span class=\"comment\">//获得该 Channel 关闭的 Future，表示关闭操作的结果</span></span><br><span class=\"line\">            <span class=\"comment\">//一旦 ChannelFuture 完成，即说明服务器已经成功关闭了所有客户端连接，并且释放了所有资源和线程。此时，我们的 TCP 服务已经结束运行，可以执行一些其他的清理、日志记录等工作。</span></span><br><span class=\"line\">            channelFuture.channel().closeFuture().sync();</span><br><span class=\"line\">        &#125;<span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;<span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 最后线程组将其全部关闭</span></span><br><span class=\"line\">            bossGroup.shutdownGracefully();</span><br><span class=\"line\">            workerGroup.shutdownGracefully();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>NettyServerHandler</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyServerHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead</span><span class=\"params\">(ChannelHandlerContext ctx, Object msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;服务端开始后到来自客户端的消息&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//获取客户端发送的消息，并调用服务</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;&quot;</span>+ msg);</span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">         1.客户端在调用服务器的api 时，我们需要定义一个规则，只有符合规则的时候才会调用对应的服务</span></span><br><span class=\"line\"><span class=\"comment\">                比如我们要求 每次发消息是都必须以某个字符串开头 &quot;HelloService#hello#你好&quot;</span></span><br><span class=\"line\"><span class=\"comment\">         2.Dubbo 注册在Zookeeper里时，这种就是类的全路径字符串，用IDEA的zookeeper插件就可以清楚地看到</span></span><br><span class=\"line\"><span class=\"comment\">         */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(msg.toString().startsWith(ClientBootstrap.providerName))&#123;  <span class=\"comment\">// startsWith 以... 为开始</span></span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span>   <span class=\"keyword\">new</span> <span class=\"title class_\">HelloServiceImpl</span>().hello(msg.toString().substring(msg.toString().lastIndexOf(<span class=\"string\">&quot;#&quot;</span>)+<span class=\"number\">1</span>));</span><br><span class=\"line\">            <span class=\"comment\">// 将 result 数据写入到该 ctx 的输出缓冲区，并进行网络传输，即将数据通过底层传输协议发送给客户端。</span></span><br><span class=\"line\">            <span class=\"comment\">//  writeAndFlush() 方法将数据从服务器端发送给客户端，实现双向通信</span></span><br><span class=\"line\">            ctx.writeAndFlush(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//关闭当前连接，即该 ctx 所代表的客户端与服务器之间的 Socket 连接。</span></span><br><span class=\"line\">        <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">        在调用 close() 方法时，Netty 会依次执行以下操作：</span></span><br><span class=\"line\"><span class=\"comment\">            1 将未发送完毕的数据强制刷新到底层传输。</span></span><br><span class=\"line\"><span class=\"comment\">            2 关闭底层传输（NIO 等）对应的连接，释放相关资源。</span></span><br><span class=\"line\"><span class=\"comment\">            3 触发关闭事件，执行相应的处理逻辑。</span></span><br><span class=\"line\"><span class=\"comment\">         */</span></span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>NettyClientHandler</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyClientHandler</span>  <span class=\"keyword\">extends</span> <span class=\"title class_\">ChannelInboundHandlerAdapter</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Callable</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> ChannelHandlerContext context;<span class=\"comment\">//上下文</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String result; <span class=\"comment\">//返回的结果</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String para; <span class=\"comment\">//客户端调用方法时，传入的参数</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 只要和 服务器的连接  创建之后就会被调用     ①</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelActive</span><span class=\"params\">(ChannelHandlerContext ctx)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot; channelActive 被调用  &quot;</span>);</span><br><span class=\"line\">        context = ctx; <span class=\"comment\">//在其它方法会使用到 ctx</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//④</span></span><br><span class=\"line\">    <span class=\"comment\">// 收到服务器的调用之后就会调用此方法</span></span><br><span class=\"line\">    <span class=\"comment\">// 要加上 synchronized   因为  channelRead  和下面的 call   是同步的关系</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title function_\">channelRead</span><span class=\"params\">(ChannelHandlerContext ctx, Object msg)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot; channelRead 被调用  &quot;</span>);</span><br><span class=\"line\">        result = msg.toString();</span><br><span class=\"line\">        notify(); <span class=\"comment\">//唤醒等待的线程</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//异常时调用</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exceptionCaught</span><span class=\"params\">(ChannelHandlerContext ctx, Throwable cause)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot; exceptionCaught 被调用  &quot;</span>);</span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//③</span></span><br><span class=\"line\">    <span class=\"comment\">//被代理对象调用, 发送数据给服务器-&gt; wait -&gt; 等待被唤醒(channelRead) -&gt; 返回结果 (调用③)-&gt; 调用④-&gt; 随后再次调用③ 进行唤醒</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> Object <span class=\"title function_\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot; call1 被调用  &quot;</span>);</span><br><span class=\"line\">        context.writeAndFlush(para);  <span class=\"comment\">// 将 para  传给服务端，参数上面的体现就是  msg</span></span><br><span class=\"line\">        <span class=\"comment\">//进行wait</span></span><br><span class=\"line\">        wait(); <span class=\"comment\">//等待channelRead 方法获取到服务器的结果并唤醒  就是 HelloServiceImpl 中的 两个&quot;你好客户端, 我已经收到你的消息...&quot; 之一</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot; call2 被调用  &quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>  result; <span class=\"comment\">//服务方返回的结果</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setPara</span><span class=\"params\">(String para)</span> &#123;        <span class=\"comment\">//②</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot; setPara被调用   &quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.para = para;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>NettyClient</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NettyClient</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//创建线程池</span></span><br><span class=\"line\">    <span class=\"comment\">//Runtime.getRuntime().availableProcessors() 表示获取当前机器的处理器核心数，该值通常用于计算系统资源的分配和利用率</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">ExecutorService</span> <span class=\"variable\">executor</span> <span class=\"operator\">=</span> Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> NettyClientHandler client;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">count</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//编写方法使用代理模式，获取一个代理对象</span></span><br><span class=\"line\">    <span class=\"comment\">//serviceClass 具体的是哪一个类     providerName 就是指 NettyServerHandler 中预定义的 规则</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Object <span class=\"title function_\">getBean</span><span class=\"params\">(<span class=\"keyword\">final</span> Class&lt;?&gt; serviceClass,<span class=\"keyword\">final</span> String providerName)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>&lt;?&gt;[] &#123;serviceClass&#125;,</span><br><span class=\"line\">                <span class=\"comment\">//下面的的代码，客户端每调用一次 hello, 就会进入到该代码</span></span><br><span class=\"line\">                (proxy, method,args)-&gt;&#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;(proxy, method, args) 进入....&quot;</span> + (++count) + <span class=\"string\">&quot; 次&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (client == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                        initClient();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//设置要发给服务器端的信息</span></span><br><span class=\"line\">                    <span class=\"comment\">//providerName：协议头</span></span><br><span class=\"line\">                    <span class=\"comment\">//args[0]：就是客户端 调用  HelloService 中的参数 要发送给服务端的数据</span></span><br><span class=\"line\">                    client.setPara(providerName + args[<span class=\"number\">0</span>]);</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> executor.submit(client).get();</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 初始化客户端</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initClient</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        client = <span class=\"keyword\">new</span> <span class=\"title class_\">NettyClientHandler</span>();</span><br><span class=\"line\">        <span class=\"type\">NioEventLoopGroup</span> <span class=\"variable\">group</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NioEventLoopGroup</span>();</span><br><span class=\"line\">        <span class=\"type\">Bootstrap</span> <span class=\"variable\">bootstrap</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Bootstrap</span>();</span><br><span class=\"line\">        bootstrap.group(group)</span><br><span class=\"line\">                .channel(NioSocketChannel.class)</span><br><span class=\"line\">                <span class=\"comment\">//设置TCP协议中的Nagle算法。</span></span><br><span class=\"line\">                <span class=\"comment\">// Nagle算法可以将小的数据包合并为一个大的数据包进行传输，从而减少网络传输的次数，提高传输效率。但是这也造成了一定的延迟，特别是对于实时性要求较高的应用程序而言，会对系统性能产生一定的影响。</span></span><br><span class=\"line\">                <span class=\"comment\">//如果调用.option(ChannelOption.TCP_NODELAY, true)方法，</span></span><br><span class=\"line\">                <span class=\"comment\">//并且将参数设为true，则表示关闭Nagle算法。</span></span><br><span class=\"line\">                <span class=\"comment\">// 这意味着即使只有很小的数据包需要传输，Netty也会立即发送这些数据，而不是等待其他数据的到达。</span></span><br><span class=\"line\">                <span class=\"comment\">// 这样可以降低网络传输的延迟，提高数据传输的实时性和性能。</span></span><br><span class=\"line\">                .option(ChannelOption.TCP_NODELAY,<span class=\"literal\">true</span>)</span><br><span class=\"line\">                .handler(<span class=\"keyword\">new</span> <span class=\"title class_\">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"meta\">@Override</span></span><br><span class=\"line\">                    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">initChannel</span><span class=\"params\">(SocketChannel ch)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">                        <span class=\"comment\">//获取到pipeline</span></span><br><span class=\"line\">                        <span class=\"type\">ChannelPipeline</span> <span class=\"variable\">pipeline</span> <span class=\"operator\">=</span> ch.pipeline();</span><br><span class=\"line\">                        <span class=\"comment\">//向pipeline加入解码器</span></span><br><span class=\"line\">                        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">StringDecoder</span>());</span><br><span class=\"line\">                        <span class=\"comment\">//向pipeline加入编码器</span></span><br><span class=\"line\">                        pipeline.addLast(<span class=\"keyword\">new</span> <span class=\"title class_\">StringEncoder</span>());</span><br><span class=\"line\">                        <span class=\"comment\">//加入自己的业务处理handler</span></span><br><span class=\"line\">                        pipeline.addLast(client);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">            <span class=\"comment\">// 连接服务器</span></span><br><span class=\"line\">            <span class=\"comment\">//.sync()方法则是同步阻塞等待连接成功。它会一直阻塞当前线程，直到连接成功或者连接失败才会返回。</span></span><br><span class=\"line\">            <span class=\"comment\">//如果连接成功，则返回一个ChannelFuture对象，可以通过它获取到连接后的Channel通道，从而进行后续的数据传输和处理操作。</span></span><br><span class=\"line\">            bootstrap.connect(<span class=\"string\">&quot;127.0.0.1&quot;</span>,<span class=\"number\">8000</span>).sync();</span><br><span class=\"line\">        &#125;<span class=\"keyword\">catch</span> (Exception e)&#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>ClientBootstrap</code></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ClientBootstrap</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//定义协议头,就是 NettyServerHandler 的接收规则</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">providerName</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;HelloService#hello#&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//创建一个消费者</span></span><br><span class=\"line\">        <span class=\"type\">NettyClient</span> <span class=\"variable\">customer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NettyClient</span>();</span><br><span class=\"line\">        <span class=\"comment\">//创建代理对象</span></span><br><span class=\"line\">        <span class=\"type\">HelloService</span> <span class=\"variable\">service</span> <span class=\"operator\">=</span> (HelloService) customer.getBean(HelloService.class, providerName);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">            Thread.sleep(<span class=\"number\">2000</span>);</span><br><span class=\"line\">            <span class=\"comment\">//通过代理对象调用服务提供者的方法(服务)</span></span><br><span class=\"line\">            <span class=\"type\">String</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> service.hello(<span class=\"string\">&quot;你好 ~&quot;</span>);</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;调用的结果 res= &quot;</span> + res);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"效果演示\">效果演示</h5>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ClientBootstrap 输出</span></span><br><span class=\"line\">    </span><br><span class=\"line\">(proxy, method, args) 进入...<span class=\"number\">.1</span> 次</span><br><span class=\"line\"> channelActive 被调用  </span><br><span class=\"line\"> setPara被调用   </span><br><span class=\"line\"> call1 被调用  </span><br><span class=\"line\"> channelRead 被调用  </span><br><span class=\"line\"> call2 被调用  </span><br><span class=\"line\">调用的结果 res= 你好客户端, 我已经收到你的消息。消息为：[你好 ~] ，第<span class=\"number\">108</span> 次 </span><br><span class=\"line\"></span><br><span class=\"line\">(proxy, method, args) 进入...<span class=\"number\">.2</span> 次</span><br><span class=\"line\"> setPara被调用   </span><br><span class=\"line\"> call1 被调用  </span><br><span class=\"line\"> channelRead 被调用  </span><br><span class=\"line\"> call2 被调用  </span><br><span class=\"line\">调用的结果 res= 你好客户端, 我已经收到你的消息。消息为：[你好 ~] ，第<span class=\"number\">109</span> 次 </span><br><span class=\"line\"></span><br><span class=\"line\">(proxy, method, args) 进入...<span class=\"number\">.3</span> 次</span><br><span class=\"line\"> setPara被调用   </span><br><span class=\"line\"> call1 被调用  </span><br><span class=\"line\"> channelRead 被调用  </span><br><span class=\"line\"> call2 被调用  </span><br><span class=\"line\">调用的结果 res= 你好客户端, 我已经收到你的消息。消息为：[你好 ~] ，第<span class=\"number\">110</span> 次 </span><br><span class=\"line\"></span><br><span class=\"line\">(proxy, method, args) 进入...<span class=\"number\">.4</span> 次</span><br><span class=\"line\"> setPara被调用   </span><br><span class=\"line\"> call1 被调用  </span><br><span class=\"line\"> channelRead 被调用  </span><br><span class=\"line\"> call2 被调用  </span><br><span class=\"line\">调用的结果 res= 你好客户端, 我已经收到你的消息。消息为：[你好 ~] ，第<span class=\"number\">111</span> 次 </span><br><span class=\"line\"></span><br><span class=\"line\">(proxy, method, args) 进入...<span class=\"number\">.5</span> 次</span><br><span class=\"line\"> setPara被调用   </span><br><span class=\"line\"> call1 被调用  </span><br><span class=\"line\"> channelRead 被调用  </span><br><span class=\"line\"> call2 被调用  </span><br><span class=\"line\">调用的结果 res= 你好客户端, 我已经收到你的消息。消息为：[你好 ~] ，第<span class=\"number\">112</span> 次 </span><br><span class=\"line\"></span><br><span class=\"line\">......</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ServerBootstrap 输出</span></span><br><span class=\"line\">服务端开始后到来自客户端的消息</span><br><span class=\"line\">HelloService#hello#你好 ~</span><br><span class=\"line\">收到客户端消息=你好 ~</span><br><span class=\"line\"></span><br><span class=\"line\">服务端开始后到来自客户端的消息</span><br><span class=\"line\">HelloService#hello#你好 ~</span><br><span class=\"line\">收到客户端消息=你好 ~</span><br><span class=\"line\"></span><br><span class=\"line\">服务端开始后到来自客户端的消息</span><br><span class=\"line\">HelloService#hello#你好 ~</span><br><span class=\"line\">收到客户端消息=你好 ~</span><br><span class=\"line\">服务端开始后到来自客户端的消息</span><br><span class=\"line\">HelloService#hello#你好 ~</span><br><span class=\"line\">收到客户端消息=你好 ~</span><br><span class=\"line\"></span><br><span class=\"line\">服务端开始后到来自客户端的消息</span><br><span class=\"line\">HelloService#hello#你好 ~</span><br><span class=\"line\">收到客户端消息=你好 ~</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h5 id=\"代码过程梳理\">代码过程梳理</h5>\n<blockquote>\n<ul>\n<li><code>ClientBootstrap#main</code>发起调用 会走到下面这一行代码后</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//创建代理对象</span></span><br><span class=\"line\"><span class=\"type\">HelloService</span> <span class=\"variable\">service</span> <span class=\"operator\">=</span> (HelloService) customer.getBean(HelloService.class, providerName);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p>调用<code>NettyClient#getBean</code>，在此方法里与服务端建立链接。于是就执行<code>NettyClientHandler#channelActive</code></p>\n</li>\n<li>\n<p>接着回到<code>NettyClient#getBean</code>调用<code>NettyClientHandler#setPara</code>，调用完之后再回到<code>NettyClient#getBean</code>，用线程池提交任务</p>\n</li>\n<li>\n<p>因为用线程池提交了任务，就准备执行<code>NettyClientHandler#call</code>线程任务</p>\n</li>\n<li>\n<p>在<code>NettyClientHandler#call</code>中发送数据给服务提供者</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">context.writeAndFlush(para);</span><br></pre></td></tr></table></figure>\n<p>由于还没收到服务提供者的数据结果，所以<code>wait() </code>随后进行等待</p>\n<ul>\n<li>来到了服务提供者这边，从<code>Socket</code>通道中收到了数据，所以执行<code>NettyServerHandler#channelRead</code>，然后因为此方法中执行了</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">HelloServiceImpl</span>().hello(msg.toString().substring(msg.toString().lastIndexOf(<span class=\"string\">&quot;#&quot;</span>) + <span class=\"number\">1</span>));</span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p>随后到达<code>HelloServiceImpl#hello</code>中执行业务逻辑，将返回数据给<code>NettyServerHandler#channelRead</code> ，<code>NettyServerHandler#channelRead</code>再把数据发给客户端</p>\n<ul>\n<li><code>NettyClientHandler#channelRead</code>收到服务提供者发来的数据，唤醒之前<code>wait</code>的线程</li>\n</ul>\n</li>\n<li>\n<p>所以之前<code>wait</code>的线程从<code>NettyClientHandler#call</code>苏醒，返回result给<code>NettyClient#getBean</code></p>\n</li>\n<li>\n<p><code>NettyClient#getBeanget()</code>到数据，<code>ClientBootstrap#main</code>中的此函数调用返回，得到服务端提供的数据。</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">res</span> <span class=\"operator\">=</span> service.hello(<span class=\"string\">&quot;你好 dubbo~&quot;</span>);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>至此，一次RPC调用结束。</li>\n</ul>\n</blockquote>\n","_path":"post/4f46b5ba.html","_link":"http://rycan.top/post/4f46b5ba.html","_id":"cloioo9dw001xni0p0h75eqjk"}}