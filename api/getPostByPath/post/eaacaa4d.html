{"type":"getPostByPath","data":{"title":"redis初学","date":"2023-07-03T12:51:18.000Z","description":"redis初学","categories":[{"name":"redis","_id":"clo9tj5vm002tl10p7tfx7fqt"}],"tags":[{"name":"redis","_id":"clo9tj5vx005ml10phaep1i1s"}],"content":"<meta name=\"referrer\" content=\"no-referrer\">\n\n\n\n\n\n\n<h2 id=\"历史概述\"><a href=\"#历史概述\" class=\"headerlink\" title=\"历史概述\"></a>历史概述</h2><h4 id=\"CPU及内存压力解决过程\"><a href=\"#CPU及内存压力解决过程\" class=\"headerlink\" title=\"CPU及内存压力解决过程\"></a>CPU及内存压力解决过程</h4><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131505703.png\" alt=\"image-20230313150543675\" style=\"zoom:25%;\"></p>\n<h4 id=\"NoSQL\"><a href=\"#NoSQL\" class=\"headerlink\" title=\"NoSQL\"></a>NoSQL</h4><p>NoSQL(NoSQL = Not Only SQL )，意即“不仅仅是SQL”，泛指非关系型的数据库。</p>\n<p>NoSQL 不依赖业务逻辑方式存储，而以简单的key-value模式存储。因此大大的增加了数据库的扩展能力。</p>\n<h2 id=\"Redis-概述\"><a href=\"#Redis-概述\" class=\"headerlink\" title=\"Redis 概述\"></a>Redis 概述</h2><h3 id=\"Redis-介绍\"><a href=\"#Redis-介绍\" class=\"headerlink\" title=\"Redis 介绍\"></a>Redis 介绍</h3><ul>\n<li><p>Redis 是一个开源的 <code>key-value</code> 存储系统。</p>\n</li>\n<li><p>和 Memcached 类似，它支持存储的 value 类型相对更多，包括 <code>string (字符串)、list (链表)、set (集合)、zset (sorted set –有序集合) 和 hash（哈希类型）</code>。</p>\n</li>\n<li><p>这些数据类型都支持 push/pop、add/remove 及取交集并集和差集及更丰富的操作，而且这些操作都是<code>原子性</code>的。</p>\n</li>\n<li><p>在此基础上，Redis 支持各种不同方式的<code>排序</code>。</p>\n</li>\n<li><p>与 memcached 一样，为了保证效率，<code>数据都是缓存在内存中</code>。</p>\n</li>\n<li><p>区别的是 Redis 会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件。</p>\n</li>\n<li><p>并且在此基础上实现了 master-slave (主从) 同步。</p>\n</li>\n</ul>\n<h3 id=\"特点\"><a href=\"#特点\" class=\"headerlink\" title=\"特点\"></a>特点</h3><h4 id=\"配合关系型数据库做高速缓存\"><a href=\"#配合关系型数据库做高速缓存\" class=\"headerlink\" title=\"配合关系型数据库做高速缓存\"></a>配合关系型数据库做高速缓存</h4><ul>\n<li><p>高频次，热门访问的数据，降低数据库 IO。</p>\n</li>\n<li><p>分布式架构，做 session 共享。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131511200.png\" alt=\"image-20230313151134174\" style=\"zoom:25%;\"></p>\n</li>\n</ul>\n<h4 id=\"多样的数据结构存储持久化数据\"><a href=\"#多样的数据结构存储持久化数据\" class=\"headerlink\" title=\"多样的数据结构存储持久化数据\"></a>多样的数据结构存储持久化数据</h4><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131515898.png\" alt=\"image-20230313151545879\" style=\"zoom:25%;\"></p>\n<h2 id=\"redis使用\"><a href=\"#redis使用\" class=\"headerlink\" title=\"redis使用\"></a>redis使用</h2><h4 id=\"前台启动（不推荐）\"><a href=\"#前台启动（不推荐）\" class=\"headerlink\" title=\"前台启动（不推荐）\"></a>前台启动（不推荐）</h4><p><code>redis-server</code></p>\n<h4 id=\"后台启动\"><a href=\"#后台启动\" class=\"headerlink\" title=\"后台启动\"></a>后台启动</h4><h6 id=\"备份redis-conf\"><a href=\"#备份redis-conf\" class=\"headerlink\" title=\"备份redis.conf\"></a>备份redis.conf</h6><p>拷贝一份redis.conf到其他目录</p>\n<blockquote>\n<p>cp  /opt/redis-3.2.5/redis.conf  /myredis</p>\n</blockquote>\n<h6 id=\"后台启动设置daemonize-no改成yes\"><a href=\"#后台启动设置daemonize-no改成yes\" class=\"headerlink\" title=\"后台启动设置daemonize no改成yes\"></a>后台启动设置daemonize no改成yes</h6><blockquote>\n<p>修改redis.conf文件将里面的daemonize no 改成 yes，让服务在后台启动</p>\n</blockquote>\n<h6 id=\"Redis启动\"><a href=\"#Redis启动\" class=\"headerlink\" title=\"Redis启动\"></a>Redis启动</h6><blockquote>\n<p><code>redis-server/myredis/redis.conf</code></p>\n<p>用客户端访问：<code>redis-cli</code></p>\n<p>多个端口可以指定某一端口：<code>redis-cli -p 6379</code></p>\n</blockquote>\n<h6 id=\"Redis关闭\"><a href=\"#Redis关闭\" class=\"headerlink\" title=\"Redis关闭\"></a>Redis关闭</h6><blockquote>\n<p>单实例关闭：<code>ps -ef|grep redis</code>   再 <code>kill -9 端口号</code>   或者   <code>redis-cli shutdown</code></p>\n<p>或进入终端后再关闭：&gt; <code>shutdown</code></p>\n<p>多实例关闭，指定端口关闭：<code>redis-cli -p 6379 shutdown</code></p>\n</blockquote>\n<h6 id=\"问题解决\"><a href=\"#问题解决\" class=\"headerlink\" title=\"问题解决\"></a>问题解决</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303122044017.png\" alt=\"image-20230312204422996\" style=\"zoom:33%;\"></p>\n<h2 id=\"rdis理论知识介绍\"><a href=\"#rdis理论知识介绍\" class=\"headerlink\" title=\"rdis理论知识介绍\"></a>rdis理论知识介绍</h2><ul>\n<li><p>redis默认有16个数据库，类似数组下标从0开始，初始默认使用0号库。</p>\n</li>\n<li><p>统一密码管理，所有库有同样的密码  我的密码是<code>00000000</code></p>\n</li>\n</ul>\n<h4 id=\"Redis-使用的是单线程-多路-IO-复用技术：\"><a href=\"#Redis-使用的是单线程-多路-IO-复用技术：\" class=\"headerlink\" title=\"Redis 使用的是单线程 + 多路 IO 复用技术：\"></a>Redis 使用的是单线程 + 多路 IO 复用技术：</h4><h5 id=\"多路复用\"><a href=\"#多路复用\" class=\"headerlink\" title=\"多路复用\"></a>多路复用</h5><p>​    指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用 select 和 poll 函数，传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）。</p>\n<p>==串行    vs    多线程 + 锁（memcached）   vs     单线程 + 多路 IO 复用 (Redis)==</p>\n<p>（与 Memcache有 三点不同：1、支持多数据类型，2、支持持久化，3、单线程 + 多路 IO 复用）</p>\n<h2 id=\"Redis-基本数据类型\"><a href=\"#Redis-基本数据类型\" class=\"headerlink\" title=\"Redis 基本数据类型\"></a>Redis 基本数据类型</h2><h4 id=\"指令指导-http-www-redis-cn-commands-html\"><a href=\"#指令指导-http-www-redis-cn-commands-html\" class=\"headerlink\" title=\"[指令指导][http://www.redis.cn/commands.html]\"></a>[指令指导][<a href=\"http://www.redis.cn/commands.html\">http://www.redis.cn/commands.html</a>]</h4><h4 id=\"Redis键-key\"><a href=\"#Redis键-key\" class=\"headerlink\" title=\"Redis键(key)\"></a>Redis键(key)</h4><ul>\n<li><code>keys *</code> 查看当前库所有key    (匹配：keys *1)</li>\n<li><code>exists key</code>判断某个key是否存在</li>\n<li><code>type key</code> 查看你的key是什么类型</li>\n<li><code>del key</code>       删除指定的key数据</li>\n<li><code>unlink key</code>根据value选择非阻塞删除;仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作。</li>\n<li><code>expire key 10</code>   10秒钟：为给定的key设置过期时间</li>\n<li><code>ttl key</code> 查看还有多少秒过期，-1表示永不过期，-2表示已过期</li>\n<li>redis默认有16个数据库，类似数组下标从0开始，初始默认使用0号库。使用命令<code>select &lt;dbid&gt;</code>来切换数据库。如: select 8</li>\n<li><code>dbsize</code>查看当前数据库的key的数量</li>\n<li><code>flushdb</code>清空当前库</li>\n<li><code>flushall</code>通杀全部库</li>\n<li>统一密码管理，所有库有同样的密码  我的密码是<code>00000000</code></li>\n</ul>\n<h4 id=\"Redis-字符串-String\"><a href=\"#Redis-字符串-String\" class=\"headerlink\" title=\"Redis 字符串 (String)\"></a>Redis 字符串 (String)</h4><h5 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h5><ul>\n<li><p>String 是 Redis 最基本的类型，你可以理解成与 Memcached 一模一样的类型，一个 key 对应一个 value。</p>\n</li>\n<li><p>String 类型是二进制安全的。意味着 Redis 的 string 可以包含任何数据。比如 jpg 图片或者序列化的对象。</p>\n</li>\n<li><p>String 类型是 Redis 最基本的数据类型，一个 Redis 中字符串 value 最多可以是 512M。</p>\n</li>\n</ul>\n<h5 id=\"命令\"><a href=\"#命令\" class=\"headerlink\" title=\"命令\"></a>命令</h5><ul>\n<li><p><code>set   &lt;key&gt;&lt;value&gt;</code>添加键值对</p>\n<ul>\n<li>*NX：当数据库中key不存在时，可以将key-value添加数据库</li>\n<li>*XX：当数据库中key存在时，可以将key-value添加数据库，与NX参数互斥</li>\n<li>*EX：key的超时秒数</li>\n<li>*PX：key的超时毫秒数，与EX互斥</li>\n</ul>\n</li>\n<li><p><code>get   &lt;key&gt;</code>查询对应键值</p>\n</li>\n<li><p><code>append  &lt;key&gt;&lt;value&gt;</code>将给定的<code>&lt;value&gt;</code>追加到原值的末尾</p>\n</li>\n<li><p><code>strlen  &lt;key&gt;</code>获得值的长度</p>\n</li>\n<li><p><code>setnx  &lt;key&gt;&lt;value&gt;</code>只有在 key 不存在时才设置 key 的值</p>\n</li>\n<li><p><code>incr  &lt;key&gt;</code><br>将 key 中储存的数字值增1;只能对数字值操作，如果为空，新增值为1</p>\n</li>\n<li><p><code>decr  &lt;key&gt;</code><br>将 key 中储存的数字值减1;只能对数字值操作，如果为空，新增值为-1;</p>\n</li>\n<li><p><code>incrby / decrby  &lt;key&gt;&lt;步长&gt;</code></p>\n<p>将 key 中储存的数字值增减。自定义步长。</p>\n</li>\n</ul>\n<p><strong>原子性</strong>:所谓原子操作是指不会被线程调度机制打断的操作；这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch （切换到另一个线程）。<br>（1）在单线程中， 能够在单条指令中完成的操作都可以认为是”原子操作”，因为中断只能发生于指令之间。<br>（2）在多线程中，不能被其它进程（线程）打断的操作就叫原子操作。Redis单命令的原子性主要得益于Redis的单线程。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131541948.png\" alt=\"image-20230313154142903\" style=\"zoom:25%;\"></p>\n<ul>\n<li><code>mset  &lt;key1&gt;&lt;value1&gt;&lt;key2&gt;&lt;value2&gt; .....</code><br>同时设置一个或多个 key-value对</li>\n<li><code>mget  &lt;key1&gt;&lt;key2&gt;&lt;key3&gt; .....</code><br>同时获取一个或多个 value</li>\n<li><p><code>msetnx &lt;key1&gt;&lt;value1&gt;&lt;key2&gt;&lt;value2&gt;.....</code><br>同时设置一个或多个 key-value 对，当且仅当所有给定 key 都不存在。<br>原子性，有一个失败则都失败</p>\n</li>\n<li><p><code>getrange  &lt;key&gt;&lt;起始位置&gt;&lt;结束位置&gt;</code><br>获得值的范围，类似java中的substring，前包，后包</p>\n</li>\n<li><p><code>setrange  &lt;key&gt;&lt;起始位置&gt;&lt;value&gt;</code><br>用 \\<value>  覆写\\<key>所储存的字符串值，从&lt;起始位置&gt;开始(索引从0开始)。</key></value></p>\n</li>\n<li><p><code>setex  &lt;key&gt;&lt;过期时间&gt;&lt;value&gt;</code><br>设置键值的同时，设置过期时间，单位秒。</p>\n</li>\n<li><code>getset &lt;key&gt;&lt;value&gt;</code><br>以新换旧，设置了新值同时获得旧值。</li>\n</ul>\n<h5 id=\"数据结构\"><a href=\"#数据结构\" class=\"headerlink\" title=\"数据结构\"></a>数据结构</h5><p>String 的数据结构为<code>简单动态字符串</code>(Simple Dynamic String, 缩写 SDS)，是可以修改的字符串，内部结构实现上类似于 Java 的 ArrayList，采用<code>预分配冗余空间的方式</code>来减少内存的频繁分配.</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131543888.png\" style=\"zoom:33%;\"></p>\n<p>如图中所示，内部为当前字符串实际分配的空间 capacity 一般要高于实际字符串长度 len。当字符串长度小于 1M 时，扩容都是加倍现有的空间，如果超过 1M，扩容时一次只会多扩 1M 的空间。需要注意的是字符串最大长度为 512M。</p>\n<h4 id=\"Redis-列表（List\"><a href=\"#Redis-列表（List\" class=\"headerlink\" title=\"Redis 列表（List)\"></a>Redis 列表（List)</h4><h5 id=\"概述-1\"><a href=\"#概述-1\" class=\"headerlink\" title=\"概述\"></a>概述</h5><p>单键多值：Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。它的底层实际是个双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131544393.png\" alt=\"image-20230313154443372\" style=\"zoom:33%;\"></p>\n<h5 id=\"命令-1\"><a href=\"#命令-1\" class=\"headerlink\" title=\"命令\"></a>命令</h5><ul>\n<li><code>lpush/rpush  &lt;key&gt;&lt;value1&gt;&lt;value2&gt;&lt;value3&gt; ....</code>从左边/右边插入一个或多个值。</li>\n<li><code>lpop/rpop  &lt;key&gt;</code>从左边/右边吐出一个值。值在键在，值光键亡。</li>\n<li><code>rpop/lpush  &lt;key1&gt;&lt;key2&gt;</code>从\\<key1>列表右边吐出一个值，插到\\<key2>列表左边。</key2></key1></li>\n<li><code>lrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;</code><br>按照索引下标获得元素(从左到右)；lrange mylist 0 -1   0左边第一个，-1右边第一个，（0-1表示获取所有）</li>\n<li><code>lindex &lt;key&gt;&lt;index&gt;</code>按照索引下标获得元素(从左到右)</li>\n<li><code>llen &lt;key&gt;</code>获得列表长度</li>\n<li><code>linsert &lt;key&gt;  before &lt;value&gt;&lt;newvalue&gt;</code>在\\<value>的后面插入\\<newvalue>插入值</newvalue></value></li>\n<li><code>lrem &lt;key&gt;&lt;n&gt;&lt;value&gt;</code>从左边删除n个value(从左到右)</li>\n<li><code>lset&lt;key&gt;&lt;index&gt;&lt;value&gt;</code>将列表key下标为index的值替换成value</li>\n</ul>\n<h5 id=\"数据结构-1\"><a href=\"#数据结构-1\" class=\"headerlink\" title=\"数据结构\"></a>数据结构</h5><p>List 的数据结构为快速链表 quickList。<br>首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构是 ziplist，也即是压缩列表。它将所有的元素紧挨着一起存储，分配的是一块连续的内存。<br>当数据量比较多的时候才会改成 quicklist。因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是 int 类型的数据，结构上还需要两个额外的指针 prev 和 next。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131547885.png\" alt=\"image-20230313154703834\" style=\"zoom:33%;\"><br>Redis 将链表和 ziplist 结合起来组成了 quicklist。也就是将多个 ziplist 使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</p>\n<h4 id=\"Redis-集合（Set\"><a href=\"#Redis-集合（Set\" class=\"headerlink\" title=\"Redis 集合（Set)\"></a>Redis 集合（Set)</h4><h5 id=\"概述-2\"><a href=\"#概述-2\" class=\"headerlink\" title=\"概述\"></a>概述</h5><p>Redis set 对外提供的功能与 list 类似，是一个列表的功能，特殊之处在于 set 是可以==自动排重==的，当你需要存储一个列表数据，又不希望出现重复数据时，set 是一个很好的选择，并且 set 提供了判断某个成员是否在一个 set 集合内的重要接口，这个也是 list 所不能提供的。</p>\n<p>Redis 的 Set 是 string 类型的<code>无序集合</code>。它底层其实是一个 value 为 null 的 hash 表，所以添加，删除，查找的 <strong>复杂度都是 O (1)</strong>。一个算法，随着数据的增加，执行时间的长短，如果是 O (1)，数据增加，查找数据的时间不变。</p>\n<h5 id=\"命令-2\"><a href=\"#命令-2\" class=\"headerlink\" title=\"命令\"></a>命令</h5><ul>\n<li><code>sadd &lt;key&gt;&lt;value1&gt;&lt;value2&gt; .....</code><br>将一个或多个 member 元素加入到集合 key 中，已经存在的 member 元素将被忽略</li>\n<li><code>smembers &lt;key&gt;</code>取出该集合的所有值。</li>\n<li><code>sismember &lt;key&gt;&lt;value&gt;</code>判断集合\\<key>是否为含有该\\<value>值，有1，没有0</value></key></li>\n<li><code>scard&lt;key&gt;</code>返回该集合的元素个数。</li>\n<li><code>srem &lt;key&gt;&lt;value1&gt;&lt;value2&gt; ....</code>删除集合中的某个元素。</li>\n<li><code>spop &lt;key&gt;</code>随机从该集合中吐出一个值。</li>\n<li><code>srandmember &lt;key&gt;&lt;n&gt;</code>随机从该集合中取出n个值。不会从集合中删除 。</li>\n<li><code>smove &lt;source&gt;&lt;destination&gt;value</code>把集合中一个值从一个集合移动到另一个集合</li>\n<li><code>sinter &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的交集元素。</li>\n<li><code>sunion &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的并集元素。</li>\n<li><code>sdiff &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的差集元素(key1中的，不包含key2中的)</li>\n</ul>\n<h5 id=\"数据结构-2\"><a href=\"#数据结构-2\" class=\"headerlink\" title=\"数据结构\"></a>数据结构</h5><p>Set 数据结构是<code>dict 字典</code>，字典是用哈希表实现的。<br>Java 中 HashSet 的内部实现使用的是 HashMap，只不过所有的 value 都指向同一个对象。Redis 的 set 结构也是一样，它的内部也使用 hash 结构，所有的 value 都指向同一个内部值。</p>\n<h4 id=\"Redis-哈希（Hash）\"><a href=\"#Redis-哈希（Hash）\" class=\"headerlink\" title=\"Redis 哈希（Hash）\"></a>Redis 哈希（Hash）</h4><h5 id=\"概述-3\"><a href=\"#概述-3\" class=\"headerlink\" title=\"概述\"></a>概述</h5><p>Redis hash 是一个键值对集合。</p>\n<p>Redis hash 是一个 string 类型的 field 和 value 的映射表，hash 特别适合用于存储对象。</p>\n<p>类似 Java 里面的 Map<String,Object>。</String,Object></p>\n<p>用户 ID 为查找的 key，存储的 value 用户对象包含姓名，年龄，生日等信息，如果用普通的 key/value 结构来存储，主要有以下 2 种存储方式：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131551078.png\" alt=\"image-20230313155130055\" style=\"zoom:18%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131552063.png\" style=\"zoom:25%;\"></p>\n<p>方法一：每次修改用户的某个属性需要，先反序列化改好后再序列化回去。开销较大。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131552118.png\" alt=\"image-20230313155248097\" style=\"zoom:25%;\"></p>\n<p>方法二：用户 ID 数据冗余。</p>\n<p>​                                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131552567.png\" style=\"zoom:25%;\"><br>通过 key (用户 ID) + field (属性标签) 就可以操作对应属性数据了，既不需要重复存储数据，也不会带来序列化和并发修改控制的问题。</p>\n<h5 id=\"命令-3\"><a href=\"#命令-3\" class=\"headerlink\" title=\"命令\"></a>命令</h5><ul>\n<li><code>hset &lt;key&gt;&lt;field&gt;&lt;value&gt;</code>给\\<key>集合中的  \\<field>键赋值\\<value></value></field></key></li>\n<li><code>hget &lt;key1&gt;&lt;field&gt;从&lt;key1&gt;</code>集合\\<field>取出 value</field></li>\n<li><code>hmset &lt;key1&gt;&lt;field1&gt;&lt;value1&gt;&lt;field2&gt;&lt;value2&gt;...</code>批量设置hash的值</li>\n<li><code>hexists&lt;key1&gt;&lt;field&gt;</code>查看哈希表 key 中，给定域 field 是否存在。</li>\n<li><code>hkeys &lt;key&gt;</code>列出该hash集合的所有field</li>\n<li><code>hvals &lt;key&gt;</code>列出该hash集合的所有value</li>\n<li><code>hincrby &lt;key&gt;&lt;field&gt;&lt;increment&gt;</code>为哈希表 key 中的域 field 的值加上增量 1   -1</li>\n<li><code>hsetnx &lt;key&gt;&lt;field&gt;&lt;value&gt;</code>将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在 .</li>\n</ul>\n<h5 id=\"数据结构-3\"><a href=\"#数据结构-3\" class=\"headerlink\" title=\"数据结构\"></a>数据结构</h5><p>Hash 类型对应的数据结构是两种：ziplist（压缩列表），hashtable（哈希表）。当 field-value 长度较短且个数较少时，使用 ziplist，否则使用 hashtable。</p>\n<h4 id=\"Redis-有序集合-Zset（Sorted-set）\"><a href=\"#Redis-有序集合-Zset（Sorted-set）\" class=\"headerlink\" title=\"Redis 有序集合 Zset（Sorted set）\"></a>Redis 有序集合 Zset（Sorted set）</h4><h5 id=\"概述-4\"><a href=\"#概述-4\" class=\"headerlink\" title=\"概述\"></a>概述</h5><ul>\n<li><p>Redis 有序集合 zset 与普通集合 set 非常相似，是一个没有重复元素的字符串集合。</p>\n</li>\n<li><p>不同之处是有序集合的每个成员都关联了一个评分（score），这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。集合的成员是唯一的，但是评分可以是重复了 。</p>\n</li>\n<li><p>因为元素是有序的，所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</p>\n</li>\n<li><p>访问有序集合的中间元素也是非常快的，因此你能够使用有序集合作为一个没有重复成员的智能列表。</p>\n</li>\n</ul>\n<h5 id=\"命令-4\"><a href=\"#命令-4\" class=\"headerlink\" title=\"命令\"></a>命令</h5><ul>\n<li><code>zadd  &lt;key&gt;&lt;score1&gt;&lt;value1&gt;&lt;score2&gt;&lt;value2&gt;…</code><br>将一个或多个 member 元素及其 score 值加入到有序集 key 当中。</li>\n<li><code>zrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;  [WITHSCORES]</code><br>返回有序集 key 中，下标在\\<start><stop></stop>之间的元素<br>带WITHSCORES，可以让分数一起和值返回到结果集。</start></li>\n<li><code>zrangebyscore key minmax [withscores] [limit offset count]</code><br>返回有序集 key 中，所有 score 值介于 min 和 max 之间(包括等于 min 或 max )的成员。有序集成员按 score 值递增(从小到大)次序排列。</li>\n<li><code>zrevrangebyscore key maxmin [withscores] [limit offset count]</code><br>同上，改为从大到小排列。</li>\n<li><code>zincrby &lt;key&gt;&lt;increment&gt;&lt;value&gt;</code>      为元素的score加上增量</li>\n<li><code>zrem  &lt;key&gt;&lt;value&gt;</code>删除该集合下，指定值的元素</li>\n<li><code>zcount &lt;key&gt;&lt;min&gt;&lt;max&gt;</code>统计该集合，分数区间内的元素个数</li>\n<li><code>zrank &lt;key&gt;&lt;value&gt;</code>返回该值在集合中的排名，从0开始。</li>\n</ul>\n<h5 id=\"数据结构-4\"><a href=\"#数据结构-4\" class=\"headerlink\" title=\"数据结构\"></a>数据结构</h5><ul>\n<li><p>SortedSet (zset) 是 Redis 提供的一个非常特别的数据结构，</p>\n<ul>\n<li>一方面它等价于 Java 的数据结构 Map<String,Double>，可以给每一个元素 value 赋予一个权重 score，</String,Double></li>\n<li>另一方面它又类似于 TreeSet，内部的元素会按照权重 score 进行排序，可以得到每个元素的名次，还可以通过 score 的范围来获取元素的列表。</li>\n</ul>\n</li>\n<li><p>zset 底层使用了两个数据结构：</p>\n<ul>\n<li>hash，hash 的作用就是关联元素 value 和权重 score，保障元素 value 的唯一性，可以通过元素 value 找到相应的 score 值。</li>\n<li>跳跃表，跳跃表的目的在于给元素 value 排序，根据 score 的范围获取元素列表。</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"跳跃表\"><a href=\"#跳跃表\" class=\"headerlink\" title=\"跳跃表\"></a>跳跃表</h5><h6 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h6><p>对于有序集合的底层实现，可以用数组、平衡树、链表等。数组不便元素的插入、删除；平衡树或红黑树虽然效率高但结构复杂；链表查询需要遍历所有效率低。Redis 采用的是跳跃表，跳跃表效率堪比红黑树，实现远比红黑树简单。</p>\n<h6 id=\"实例\"><a href=\"#实例\" class=\"headerlink\" title=\"实例\"></a>实例</h6><p>对比有序链表和跳跃表，从链表中查询出 51：</p>\n<ul>\n<li>有序链表</li>\n</ul>\n<p>​                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131558143.png\" alt=\"image-20230313155851093\" style=\"zoom:33%;\"><br>要查找值为 51 的元素，需要从第一个元素开始依次查找、比较才能找到。共需要 6 次比较。</p>\n<ul>\n<li>跳跃表</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131559675.png\" alt=\"image-20230313155905619\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>从第 2 层开始，1 节点比 51 节点小，向后比较；</p>\n<p>21 节点比 51 节点小，继续向后比较，后面就是 NULL 了，所以从 21 节点向下到第 1 层；</p>\n<p>在第 1 层，41 节点比 51 节点小，继续向后，61 节点比 51 节点大，所以从 41 向下；</p>\n<p>在第 0 层，51 节点为要查找的节点，节点被找到，共查找 4 次。</p>\n<p>从此可以看出跳跃表比有序链表效率要高。</p>\n</blockquote>\n<h2 id=\"Redis-新数据类型\"><a href=\"#Redis-新数据类型\" class=\"headerlink\" title=\"Redis 新数据类型\"></a>Redis 新数据类型</h2><h4 id=\"Redis-Bitmaps\"><a href=\"#Redis-Bitmaps\" class=\"headerlink\" title=\"Redis Bitmaps\"></a>Redis Bitmaps</h4><h5 id=\"概述-5\"><a href=\"#概述-5\" class=\"headerlink\" title=\"概述\"></a>概述</h5><ul>\n<li><p>Redis 提供了 Bitmaps 这个 “数据类型” 可以实现对位的操作：Bitmaps 本身不是一种数据类型， 实际上它就是字符串（key-value） ， 但是它可以对字符串的位进行操作。</p>\n</li>\n<li><p>Bitmaps 单独提供了一套命令， 所以在 Redis 中使用 Bitmaps 和使用字符串的方法不太相同。 可以把 Bitmaps 想象成一个以位为单位的数组， 数组的每个单元只能存储 0 和 1， 数组的下标在 Bitmaps 中叫做偏移量。</p>\n</li>\n</ul>\n<p>​                                            <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131617867.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<h5 id=\"命令-5\"><a href=\"#命令-5\" class=\"headerlink\" title=\"命令\"></a>命令</h5><h6 id=\"setbit命令\"><a href=\"#setbit命令\" class=\"headerlink\" title=\"setbit命令\"></a>setbit命令</h6><p>（1）格式<br><code>setbit&lt;key&gt;&lt;offset&gt;&lt;value&gt;</code>设置Bitmaps中某个偏移量的值（0或1）     *offset:偏移量从0开始</p>\n<p>（2）实例<br>每个独立用户是否访问过网站存放在Bitmaps中， 将访问的用户记做1， 没有访问的用户记做0， 用偏移量作为用户的id。设置键的第offset个位的值（从0算起） ， 假设现在有20个用户，userid=1， 6， 11， 15， 19的用户对网站进行了访问， 那么当前Bitmaps初始化结果如图</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131618551.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<p>unique:users:20201106代表2020-11-06这天的独立访问用户的Bitmaps</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131619177.jpg\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>注：很多应用的用户id以一个指定数字（例如10000） 开头， 直接将用户id和Bitmaps的偏移量对应势必会造成一定的浪费， 通常的做法是每次做setbit操作时将用户id减去这个指定数字。<br>在第一次初始化Bitmaps时， 假如偏移量非常大， 那么整个初始化过程执行会比较慢， 可能会造成Redis的阻塞。</p>\n</blockquote>\n<h6 id=\"getbit\"><a href=\"#getbit\" class=\"headerlink\" title=\"getbit\"></a>getbit</h6><p>（1）格式<br><code>getbit&lt;key&gt;&lt;offset&gt;</code>获取Bitmaps中某个偏移量的值      获取键的第offset位的值（从0开始算）</p>\n<p>（2）实例<br>获取id=8的用户是否在2020-11-06这天访问过， 返回0说明没有访问过：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131620898.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>注：因为100根本不存在，所以也是返回0</p>\n</blockquote>\n<h6 id=\"bitcount\"><a href=\"#bitcount\" class=\"headerlink\" title=\"bitcount\"></a>bitcount</h6><p>统计字符串被设置为1的bit数。一般情况下，给定的整个字符串都会被进行计数，通过指定额外的 start 或 end 参数，可以让计数只在特定的位上进行。start 和 end 参数的设置，都可以使用负数值：比如 -1 表示最后一个位，而 -2 表示倒数第二个位，start、end 是指bit组的字节的下标数，二者皆包含。<br>（1）格式<br><code>bitcount&lt;key&gt;[start end]</code>统计字符串从start字节到end字节比特值为1的数量</p>\n<p>（2）实例<br>计算2022-11-06这天的独立访问用户数量</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131620491.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<p>start和end代表起始和结束字节数， 下面操作计算用户id在第1个字节到第3个字节之间的独立访问用户数， 对应的用户id是11， 15， 19。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131620426.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<p>举例： K1 【01000001 01000000  00000000 00100001】，对应【0，1，2，3】</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bitcount K1 1 2  ： </span><br><span class=\"line\">\t\t统计下标1、2字节组中bit=1的个数，</span><br><span class=\"line\">\t\t\t即01000000  00000000--&gt;bitcount K1 1 2 --&gt;1</span><br><span class=\"line\"></span><br><span class=\"line\">bitcount K1 1 3  ： </span><br><span class=\"line\">        统计下标1、2字节组中bit=1的个数，</span><br><span class=\"line\">        \t即01000000  00000000 00100001--&gt;bitcount K1 1 3 --&gt;3</span><br><span class=\"line\"></span><br><span class=\"line\">bitcount K1 0 -2  ： </span><br><span class=\"line\">        统计下标0到下标倒数第2，字节组中bit=1的个数，</span><br><span class=\"line\">        \t即01000001  01000000   00000000--&gt;bitcount K1 0 -2--&gt;3</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>注意：redis的setbit设置或清除的是bit位置，而bitcount计算的是byte位置。</p>\n</blockquote>\n<h6 id=\"bitop\"><a href=\"#bitop\" class=\"headerlink\" title=\"bitop\"></a>bitop</h6><p>(1)格式<br><code>bitop  and(or/not/xor) &lt;destkey&gt; [key…]</code></p>\n<p>bitop是一个复合操作， 它可以做多个Bitmaps的<code>and（交集） 、 or（并集） 、 not（非） 、 xor（异或）</code> 操作并将结果保存在destkey中。</p>\n<p>(2)实例<br>2020-11-04 日访问网站的userid=1,2,5,9。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setbit unique:users:20201104 1 1</span><br><span class=\"line\">setbit unique:users:20201104 2 1</span><br><span class=\"line\">setbit unique:users:20201104 5 1</span><br><span class=\"line\">setbit unique:users:20201104 9 1</span><br></pre></td></tr></table></figure>\n<p>2020-11-03 日访问网站的userid=0,1,4,9。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setbit unique:users:20201103 0 1</span><br><span class=\"line\">setbit unique:users:20201103 1 1</span><br><span class=\"line\">setbit unique:users:20201103 4 1</span><br><span class=\"line\">setbit unique:users:20201103 9 1</span><br></pre></td></tr></table></figure>\n<p>计算出两天都访问过网站的用户数量</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bitop and unique:users:and:20201104_03</span><br><span class=\"line\"> unique:users:20201103unique:users:20201104</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131623822.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<p>计算出任意一天都访问过网站的用户数量（例如月活跃就是类似这种） ， 可以使用or求并集</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131623067.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<h5 id=\"Bitmaps-与-set-对比\"><a href=\"#Bitmaps-与-set-对比\" class=\"headerlink\" title=\"Bitmaps 与 set 对比\"></a>Bitmaps 与 set 对比</h5><p>假设网站有 1 亿用户， 每天独立访问的用户有 5 千万， 如果每天用集合类型和 Bitmaps 分别存储活跃用户可以得到表：</p>\n<p>​                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131624854.png\" alt=\"image-20230313162418827\" style=\"zoom:25%;\"><br>很明显， 这种情况下使用 Bitmaps 能节省很多的内存空间， 尤其是随着时间推移节省的内存还是非常可观的。</p>\n<p>​                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131625787.png\" alt=\"image-20230313162500728\" style=\"zoom:33%;\"></p>\n<p>但 Bitmaps 并不是万金油， 假如该网站每天的独立访问用户很少， 例如只有 10 万（大量的僵尸用户) ， 那么两者的对比如下表所示， 很显然， 这时候使用 Bitmaps 就不太合适了， 因为基本上大部分位都是 0。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131625394.png\" alt=\"image-20230313162539364\" style=\"zoom:33%;\"></p>\n<h4 id=\"HyperLogLog\"><a href=\"#HyperLogLog\" class=\"headerlink\" title=\"HyperLogLog\"></a>HyperLogLog</h4><h5 id=\"概述：\"><a href=\"#概述：\" class=\"headerlink\" title=\"概述：\"></a>概述：</h5><p>​    在工作当中，我们经常会遇到与统计相关的功能需求，比如统计网站 PV（PageView 页面访问量），可以使用 Redis 的 incr、incrby 轻松实现。但像 UV（UniqueVisitor 独立访客)、独立 IP 数、搜索记录数等需要去重和计数的问题如何解决？这种求集合中不重复元素个数的问题称为基数问题。</p>\n<p>解决基数问题有很多种方案：</p>\n<ul>\n<li><p>数据存储在 MySQL 表中，使用 distinct count 计算不重复个数。</p>\n</li>\n<li><p>使用 Redis 提供的 hash、set、bitmaps 等数据结构来处理。</p>\n</li>\n</ul>\n<p>​    以上的方案结果精确，但随着数据不断增加，导致占用空间越来越大，对于非常大的数据集是不切实际的。能否能够降低一定的精度来平衡存储空间？Redis 推出了 <code>HyperLogLog</code>。</p>\n<p>​    Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是：在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>\n<p>​    在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64^ 个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>\n<p>​    但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>\n<h5 id=\"什么是基数？\"><a href=\"#什么是基数？\" class=\"headerlink\" title=\"什么是基数？\"></a>什么是基数？</h5><p>比如数据集 {1, 3, 5, 7, 5, 7, 8}，那么这个数据集的基数集为 {1, 3, 5 ,7, 8}，基数 (不重复元素) 为 5。 基数估计就是在误差可接受的范围内，快速计算基数。</p>\n<h6 id=\"命令：\"><a href=\"#命令：\" class=\"headerlink\" title=\"命令：\"></a>命令：</h6><p>pfadd<br>（1）格式</p>\n<p><code>pfadd &lt;key&gt;&lt; element&gt; [element ...]</code> 添加指定元素到 HyperLogLog 中</p>\n<p>（2）实例</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131629451.jpg\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>将所有元素添加到指定HyperLogLog数据结构中。如果执行命令后HLL估计的近似基数发生变化，则返回1，否则返回0。</p>\n</blockquote>\n<h6 id=\"pfcount\"><a href=\"#pfcount\" class=\"headerlink\" title=\"pfcount\"></a>pfcount</h6><p>（1）格式<br><code>pfcount&lt;key&gt; [key ...]</code> 计算HLL的近似基数，可以计算多个HLL，比如用HLL存储每天的UV，计算一周的UV可以使用7天的UV合并计算即可</p>\n<p>（2）实例</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131630299.jpg\" style=\"zoom:33%;\"></p>\n<h6 id=\"pfmerge\"><a href=\"#pfmerge\" class=\"headerlink\" title=\"pfmerge\"></a>pfmerge</h6><p>（1）格式<br><code>pfmerge&lt;destkey&gt;&lt;sourcekey&gt; [sourcekey ...]</code> 将一个或多个HLL合并后的结果存储在另一个HLL中，比如每月活跃用户可以使用每天的活跃用户来合并计算可得</p>\n<p>（2）实例</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131630833.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<h4 id=\"Geospatial\"><a href=\"#Geospatial\" class=\"headerlink\" title=\"Geospatial\"></a>Geospatial</h4><h6 id=\"概述-6\"><a href=\"#概述-6\" class=\"headerlink\" title=\"概述\"></a>概述</h6><p>​    Redis 3.2 中增加了对 GEO 类型的支持。GEO，Geographic，地理信息的缩写。该类型，就是元素的 2 维坐标，在地图上就是经纬度。redis 基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度 Hash 等常见操作。</p>\n<h5 id=\"命令-6\"><a href=\"#命令-6\" class=\"headerlink\" title=\"命令\"></a>命令</h5><h6 id=\"geoadd\"><a href=\"#geoadd\" class=\"headerlink\" title=\"geoadd\"></a>geoadd</h6><p>（1）格式<br><code>geoadd&lt;key&gt;&lt; longitude&gt;&lt;latitude&gt;&lt;member&gt; [longitude latitude member...]</code> 添加地理位置（经度，纬度，名称）</p>\n<p>（2）实例<br><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131632682.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>两极无法直接添加，一般会下载城市数据，直接通过 Java 程序一次性导入。<br>有效的经度从 -180 度到 180 度。有效的纬度从 -85.05112878 度到 85.05112878 度。<br>当坐标位置超出指定范围时，该命令将会返回一个错误。<br>已经添加的数据，是无法再次往里面添加的。</p>\n</blockquote>\n<h6 id=\"geopos\"><a href=\"#geopos\" class=\"headerlink\" title=\"geopos\"></a>geopos</h6><p>（1）格式<br><code>geopos  &lt;key&gt;&lt;member&gt; [member...]</code>获得指定地区的坐标值</p>\n<p>（2）实例</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131633010.jpg\" alt=\"img\" style=\"zoom:25%;\"></p>\n<h6 id=\"geodist\"><a href=\"#geodist\" class=\"headerlink\" title=\"geodist\"></a>geodist</h6><p>（1）格式<br><code>geodist&lt;key&gt;&lt;member1&gt;&lt;member2&gt;  [m|km|ft|mi ]</code>  获取两个位置之间的直线距离</p>\n<p>（2）实例<br>获取两个位置之间的直线距离</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131633545.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<p>单位：</p>\n<blockquote>\n<p>​        m 表示单位为米[默认值]。</p>\n<p>​        km 表示单位为千米。</p>\n<p>​        mi 表示单位为英里。</p>\n<p>​        ft 表示单位为英尺。</p>\n<p>如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位</p>\n</blockquote>\n<h6 id=\"georadius\"><a href=\"#georadius\" class=\"headerlink\" title=\"georadius\"></a>georadius</h6><p>（1）格式<br><code>georadius&lt;key&gt;&lt; longitude&gt;&lt;latitude&gt;radius  m|km|ft|mi</code>  以给定的经纬度为中心，找出某一半径内的元素</p>\n<p>经度 纬度 距离 单位</p>\n<p>（2）实例</p>\n<p>​                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131631535.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<h2 id=\"redis配置文件介绍\"><a href=\"#redis配置文件介绍\" class=\"headerlink\" title=\"redis配置文件介绍\"></a>redis配置文件介绍</h2><p><strong>自定义目录</strong> ：/myredis/redis.conf</p>\n<h5 id=\"Units单位\"><a href=\"#Units单位\" class=\"headerlink\" title=\"Units单位\"></a>Units单位</h5><p>配置大小单位,开头定义了一些基本的度量单位，只支持bytes，不支持bit；大小写不敏感</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131602243.png\" alt=\"image-20230313160255217\" style=\"zoom:33%;\"></p>\n<h5 id=\"INCLUDES包含\"><a href=\"#INCLUDES包含\" class=\"headerlink\" title=\"INCLUDES包含\"></a>INCLUDES包含</h5><p>类似jsp中的include，多实例的情况可以把公用的配置文件提取出来</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131603332.png\" style=\"zoom:33%;\"></p>\n<h5 id=\"网络相关配置\"><a href=\"#网络相关配置\" class=\"headerlink\" title=\"网络相关配置\"></a>网络相关配置</h5><h6 id=\"bind\"><a href=\"#bind\" class=\"headerlink\" title=\"bind\"></a>bind</h6><p>默认情况bind=127.0.0.1只能接受本机的访问请求；不写的情况下，无限制接受任何ip地址的访问；生产环境肯定要写你应用服务器的地址；服务器是需要远程访问的，所以需要将其注释掉；如果开启了protected-mode，那么在没有设定bind ip且没有设密码的情况下，Redis只允许接受本机的响应</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131604836.png\" style=\"zoom:33%;\"></p>\n<p>保存配置，停止服务，重启启动查看进程，不再是本机访问了。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131604515.png\" alt=\"image-20230313160421487\" style=\"zoom:33%;\"></p>\n<h6 id=\"protected-mode\"><a href=\"#protected-mode\" class=\"headerlink\" title=\"protected-mode\"></a>protected-mode</h6><p>将本机访问保护模式设置no</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131604114.png\" style=\"zoom:33%;\"></p>\n<h6 id=\"Port\"><a href=\"#Port\" class=\"headerlink\" title=\"Port\"></a>Port</h6><p>端口号，默认 6379</p>\n<h6 id=\"4-3-4-tcp-backlog\"><a href=\"#4-3-4-tcp-backlog\" class=\"headerlink\" title=\"4.3.4.tcp-backlog\"></a>4.3.4.tcp-backlog</h6><p>设置tcp的backlog，backlog其实是一个连接队列，backlog队列总和=未完成三次握手队列 + 已经完成三次握手队列。在高并发环境下你需要一个高backlog值来避免慢客户端连接问题。</p>\n<p>注意Linux内核会将这个值减小到/proc/sys/net/core/somaxconn的值（128），所以需要确认增大/proc/sys/net/core/somaxconn 和/proc/sys/net/ipv4/tcp_max_syn_backlog（128）两个值来达到想要的效果</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131607174.png\" style=\"zoom:33%;\"></p>\n<h6 id=\"timeout\"><a href=\"#timeout\" class=\"headerlink\" title=\"timeout\"></a>timeout</h6><p>一个空闲的客户端维持多少秒会关闭，0表示关闭该功能。即永不关闭。</p>\n<h6 id=\"tcp-keepalive\"><a href=\"#tcp-keepalive\" class=\"headerlink\" title=\"tcp-keepalive\"></a>tcp-keepalive</h6><p>对访问客户端的一种心跳检测，每个n秒检测一次。单位为秒，如果设置为0，则不会进行Keepalive检测，建议设置成60</p>\n<h4 id=\"GENERAL通用\"><a href=\"#GENERAL通用\" class=\"headerlink\" title=\"GENERAL通用\"></a>GENERAL通用</h4><h6 id=\"daemonize\"><a href=\"#daemonize\" class=\"headerlink\" title=\"daemonize\"></a>daemonize</h6><p>是否为后台进程，设置为yes;守护进程，后台启动</p>\n<h6 id=\"pidfile\"><a href=\"#pidfile\" class=\"headerlink\" title=\"pidfile\"></a>pidfile</h6><p>存放pid文件的位置，每个实例会产生一个不同的pid文件</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131607278.png\" alt=\"image-20230313160747239\" style=\"zoom:33%;\"></p>\n<h6 id=\"loglevel\"><a href=\"#loglevel\" class=\"headerlink\" title=\"loglevel\"></a>loglevel</h6><p>指定日志记录级别，Redis总共支持四个级别：<code>debug、verbose、notice、warning</code>，默认为notice<br>四个级别根据使用阶段来选择，生产环境选择notice 或者warning</p>\n<h6 id=\"logfile\"><a href=\"#logfile\" class=\"headerlink\" title=\"logfile\"></a>logfile</h6><p>日志文件名称</p>\n<h6 id=\"databases-16\"><a href=\"#databases-16\" class=\"headerlink\" title=\"databases 16\"></a>databases 16</h6><p>设定库的数量 默认16，默认数据库为0，可以使用<code>SELECT &lt;dbid&gt;</code>命令在连接上指定数据库id</p>\n<h5 id=\"SECURITY安全\"><a href=\"#SECURITY安全\" class=\"headerlink\" title=\"SECURITY安全\"></a>SECURITY安全</h5><h6 id=\"设置密码\"><a href=\"#设置密码\" class=\"headerlink\" title=\"设置密码\"></a>设置密码</h6><p>访问密码的查看、设置和取消<br>在命令中设置密码，只是临时的。重启redis服务器，密码就还原了。<br>永久设置，需要再配置文件中进行设置。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132153952.png\" alt=\"image-20230313215334826\" style=\"zoom:33%;\"></p>\n<h5 id=\"LIMITS限制\"><a href=\"#LIMITS限制\" class=\"headerlink\" title=\"LIMITS限制\"></a>LIMITS限制</h5><h6 id=\"maxclients\"><a href=\"#maxclients\" class=\"headerlink\" title=\"maxclients\"></a>maxclients</h6><p>设置redis同时可以与多少个客户端进行连接。<br>默认情况下为10000个客户端。<br>如果达到了此限制，redis则会拒绝新的连接请求，并且向这些连接请求方发出“max number of clients reached”以作回应。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131610164.png\" style=\"zoom:33%;\"></p>\n<h6 id=\"maxmemory\"><a href=\"#maxmemory\" class=\"headerlink\" title=\"maxmemory\"></a>maxmemory</h6><ul>\n<li>建议==必须设置==，否则，将内存占满，造成服务器宕机</li>\n<li>设置redis可以使用的内存量。一旦到达内存使用上限，redis将会试图移除内部数据，移除规则可以通过maxmemory-policy来指定。</li>\n<li>如果redis无法根据移除规则来移除内存中的数据，或者设置了“不允许移除”，那么redis则会针对那些需要申请内存的指令返回错误信息，比如SET、LPUSH等。</li>\n<li>但是对于无内存申请的指令，仍然会正常响应，比如GET等。如果你的redis是主redis（说明你的redis有从redis），那么在设置内存使用上限时，需要在系统中留出一些内存空间给同步队列缓存，只有在你设置的是“不移除”的情况下，才不用考虑这个因素。</li>\n</ul>\n<h6 id=\"maxmemory-policy\"><a href=\"#maxmemory-policy\" class=\"headerlink\" title=\"maxmemory-policy\"></a>maxmemory-policy</h6><ul>\n<li><p>volatile-lru：使用LRU算法移除key，只对设置了过期时间的键；（最近最少使用）</p>\n</li>\n<li><p>allkeys-lru：在所有集合key中，使用LRU算法移除key</p>\n</li>\n<li><p>volatile-random：在过期集合中移除随机的key，只对设置了过期时间的键</p>\n</li>\n<li><p>allkeys-random：在所有集合key中，移除随机的key</p>\n</li>\n<li><p>volatile-ttl：移除那些TTL值最小的key，即那些最近要过期的key</p>\n</li>\n<li><p>noeviction：不进行移除。针对写操作，只是返回错误信息</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131611261.png\" alt=\"image-20230313161141233\" style=\"zoom: 25%;\"></p>\n</li>\n</ul>\n<h6 id=\"maxmemory-samples\"><a href=\"#maxmemory-samples\" class=\"headerlink\" title=\"maxmemory-samples\"></a>maxmemory-samples</h6><p>设置样本数量，LRU算法和最小TTL算法都并非是精确的算法，而是估算值，所以你可以设置样本的大小，redis默认会检查这么多个key并选择其中LRU的那个。<br>一般设置3到7的数字，数值越小样本越不准确，但性能消耗越小。</p>\n<h2 id=\"Redis-的发布和订阅\"><a href=\"#Redis-的发布和订阅\" class=\"headerlink\" title=\"Redis 的发布和订阅\"></a>Redis 的发布和订阅</h2><h5 id=\"什么是发布和订阅\"><a href=\"#什么是发布和订阅\" class=\"headerlink\" title=\"什么是发布和订阅\"></a>什么是发布和订阅</h5><p>Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。</p>\n<p>Redis 客户端可以订阅任意数量的频道。</p>\n<h5 id=\"Redis-的发布和订阅-1\"><a href=\"#Redis-的发布和订阅-1\" class=\"headerlink\" title=\"Redis 的发布和订阅\"></a>Redis 的发布和订阅</h5><p>客户端可以订阅频道如下图：</p>\n<p>​                                                            <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131613901.png\" style=\"zoom:35%;\"><br>当给这个频道发布消息后，消息就会发送给订阅的客户端：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131613347.jpg\" alt=\"img\" style=\"zoom: 25%;\"></p>\n<h5 id=\"发布订阅命令行实现\"><a href=\"#发布订阅命令行实现\" class=\"headerlink\" title=\"发布订阅命令行实现\"></a>发布订阅命令行实现</h5><p>打开一个客户端订阅 channel1：</p>\n<p>​                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131614266.jpg\" alt=\"img\" style=\"zoom:33%;\"><br>打开另一个客户端，给 channel1 发布消息 hello：</p>\n<p>​                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131614116.jpg\" style=\"zoom:33%;\"><br>打开第一个客户端可以看到发送的消息：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131615302.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>注：发布的消息没有持久化，如果在订阅的客户端收不到hello，只能收到订阅后发布的消息</p>\n</blockquote>\n<h2 id=\"Jedis-操作\"><a href=\"#Jedis-操作\" class=\"headerlink\" title=\"Jedis 操作\"></a>Jedis 操作</h2><h6 id=\"1、创建Maven工程\"><a href=\"#1、创建Maven工程\" class=\"headerlink\" title=\"1、创建Maven工程\"></a>1、创建Maven工程</h6><h6 id=\"2、测试相关代码\"><a href=\"#2、测试相关代码\" class=\"headerlink\" title=\"2、测试相关代码\"></a>2、测试相关代码</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.redis;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.junit.Test;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.Jedis;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JedisDemo1</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>,<span class=\"number\">6379</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">pong</span> <span class=\"operator\">=</span> jedis.ping();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;连接成功：&quot;</span>+pong);</span><br><span class=\"line\">        jedis.close();</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//修改redis配置文件之后要重启，</span></span><br><span class=\"line\">    <span class=\"comment\">//   可能需要输入 /usr/local/bin/redis-server /etc/redis.conf 再重启，否则会有问题。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//操作String key</span></span><br><span class=\"line\"><span class=\"meta\">@Test</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">terst01</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>,<span class=\"number\">6379</span>);</span><br><span class=\"line\">    jedis.set(<span class=\"string\">&quot;k1&quot;</span>, <span class=\"string\">&quot;v1&quot;</span>);</span><br><span class=\"line\">    jedis.set(<span class=\"string\">&quot;k2&quot;</span>, <span class=\"string\">&quot;v2&quot;</span>);</span><br><span class=\"line\">    jedis.set(<span class=\"string\">&quot;k3&quot;</span>, <span class=\"string\">&quot;v3&quot;</span>);</span><br><span class=\"line\">    Set&lt;String&gt; keys = jedis.keys(<span class=\"string\">&quot;*&quot;</span>);</span><br><span class=\"line\">    System.out.println(keys.size());</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (String key : keys) &#123;</span><br><span class=\"line\">        System.out.println(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    System.out.println(jedis.exists(<span class=\"string\">&quot;k1&quot;</span>));</span><br><span class=\"line\">    System.out.println(jedis.ttl(<span class=\"string\">&quot;k1&quot;</span>));  <span class=\"comment\">//多久过期</span></span><br><span class=\"line\">    System.out.println(jedis.get(<span class=\"string\">&quot;k1&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    jedis.mset(<span class=\"string\">&quot;str1&quot;</span>,<span class=\"string\">&quot;v1&quot;</span>,<span class=\"string\">&quot;str2&quot;</span>,<span class=\"string\">&quot;v2&quot;</span>,<span class=\"string\">&quot;str3&quot;</span>,<span class=\"string\">&quot;v3&quot;</span>);</span><br><span class=\"line\">    System.out.println(jedis.mget(<span class=\"string\">&quot;str1&quot;</span>,<span class=\"string\">&quot;str2&quot;</span>,<span class=\"string\">&quot;str3&quot;</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//操作 List</span></span><br><span class=\"line\">    <span class=\"meta\">@Test</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">terst02</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>,<span class=\"number\">6379</span>);</span><br><span class=\"line\">        jedis.lpush(<span class=\"string\">&quot;mylist&quot;</span>,<span class=\"string\">&quot;q&quot;</span>,<span class=\"string\">&quot;qw&quot;</span>,<span class=\"string\">&quot;qwe&quot;</span>);</span><br><span class=\"line\">        List&lt;String&gt; list = jedis.lrange(<span class=\"string\">&quot;mylist&quot;</span>,<span class=\"number\">0</span>,-<span class=\"number\">1</span>);</span><br><span class=\"line\">        System.out.println(list);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String element : list) &#123;</span><br><span class=\"line\">            System.out.println(element);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//操作 Set</span></span><br><span class=\"line\">    <span class=\"meta\">@Test</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">terst03</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>,<span class=\"number\">6379</span>);</span><br><span class=\"line\">        jedis.sadd(<span class=\"string\">&quot;orders&quot;</span>, <span class=\"string\">&quot;order01&quot;</span>);</span><br><span class=\"line\">        jedis.sadd(<span class=\"string\">&quot;orders&quot;</span>, <span class=\"string\">&quot;order02&quot;</span>);</span><br><span class=\"line\">        jedis.sadd(<span class=\"string\">&quot;orders&quot;</span>, <span class=\"string\">&quot;order03&quot;</span>);</span><br><span class=\"line\">        jedis.sadd(<span class=\"string\">&quot;orders&quot;</span>, <span class=\"string\">&quot;order04&quot;</span>);</span><br><span class=\"line\">        Set&lt;String&gt; smembers = jedis.smembers(<span class=\"string\">&quot;orders&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">//        for (String order : smembers) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//            System.out.println(order);</span></span><br><span class=\"line\"><span class=\"comment\">//        &#125;</span></span><br><span class=\"line\"><span class=\"comment\">//        jedis.srem(&quot;orders&quot;, &quot;order02&quot;);</span></span><br><span class=\"line\">        System.out.println(smembers);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//操作 Hash</span></span><br><span class=\"line\">    <span class=\"meta\">@Test</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">terst04</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>,<span class=\"number\">6379</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        jedis.hset(<span class=\"string\">&quot;hash1&quot;</span>,<span class=\"string\">&quot;userName&quot;</span>,<span class=\"string\">&quot;lisi&quot;</span>);</span><br><span class=\"line\">        System.out.println(jedis.hget(<span class=\"string\">&quot;hash1&quot;</span>,<span class=\"string\">&quot;userName&quot;</span>));</span><br><span class=\"line\">        Map&lt;String,String&gt; map = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;String,String&gt;();</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;telphone&quot;</span>,<span class=\"string\">&quot;13810169999&quot;</span>);</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;address&quot;</span>,<span class=\"string\">&quot;atguigu&quot;</span>);</span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;email&quot;</span>,<span class=\"string\">&quot;abc@163.com&quot;</span>);</span><br><span class=\"line\">        jedis.hmset(<span class=\"string\">&quot;hash2&quot;</span>,map);</span><br><span class=\"line\">        List&lt;String&gt; result = jedis.hmget(<span class=\"string\">&quot;hash2&quot;</span>, <span class=\"string\">&quot;telphone&quot;</span>,<span class=\"string\">&quot;email&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String element : result) &#123;</span><br><span class=\"line\">            System.out.println(element);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//操作 Zset</span></span><br><span class=\"line\">    <span class=\"meta\">@Test</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">terst05</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>,<span class=\"number\">6379</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        jedis.zadd(<span class=\"string\">&quot;zset01&quot;</span>, <span class=\"number\">100d</span>, <span class=\"string\">&quot;z3&quot;</span>);</span><br><span class=\"line\">        jedis.zadd(<span class=\"string\">&quot;zset01&quot;</span>, <span class=\"number\">90d</span>, <span class=\"string\">&quot;l4&quot;</span>);</span><br><span class=\"line\">        jedis.zadd(<span class=\"string\">&quot;zset01&quot;</span>, <span class=\"number\">80d</span>, <span class=\"string\">&quot;w5&quot;</span>);</span><br><span class=\"line\">        jedis.zadd(<span class=\"string\">&quot;zset01&quot;</span>, <span class=\"number\">70d</span>, <span class=\"string\">&quot;z6&quot;</span>);</span><br><span class=\"line\">        Set&lt;String&gt; zrange = jedis.zrange(<span class=\"string\">&quot;zset01&quot;</span>, <span class=\"number\">0</span>, -<span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String e : zrange) &#123;</span><br><span class=\"line\">            System.out.println(e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"3、jedis-案例\"><a href=\"#3、jedis-案例\" class=\"headerlink\" title=\"3、jedis 案例\"></a>3、jedis 案例</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131637238.png\" alt=\"image-20230313163736198\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>注意:测试的话需要结合终端</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.redis;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.Jedis;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Random;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">PhoneCode</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\"><span class=\"comment\">//        String code = getCode();</span></span><br><span class=\"line\"><span class=\"comment\">//        System.out.println(code);</span></span><br><span class=\"line\">        <span class=\"comment\">//模拟</span></span><br><span class=\"line\">        verifyCode(<span class=\"string\">&quot;123456&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        getRedisCode(<span class=\"string\">&quot;123456&quot;</span>, <span class=\"string\">&quot;849911&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//1、生成6位数字验证码</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title function_\">getCode</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Random</span> <span class=\"variable\">random</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Random</span>();</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">code</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; <span class=\"number\">6</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">rand</span> <span class=\"operator\">=</span> random.nextInt(<span class=\"number\">10</span>);</span><br><span class=\"line\">            code += rand;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> code;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//2. 每个手机每天只能发送三次，验证码放到redis中，设置过期时间</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">verifyCode</span><span class=\"params\">(String phone)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//连接redis</span></span><br><span class=\"line\">        <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>, <span class=\"number\">6379</span>);</span><br><span class=\"line\">        <span class=\"comment\">//拼接key</span></span><br><span class=\"line\">        <span class=\"comment\">//手机发送次数key</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">countKey</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;verifyCode&quot;</span> + phone + <span class=\"string\">&quot;:count&quot;</span>;</span><br><span class=\"line\">        <span class=\"comment\">//验证码key</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">codeKey</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;verifyCode&quot;</span> + phone + <span class=\"string\">&quot;:code&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">number</span> <span class=\"operator\">=</span> jedis.get(countKey);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (number == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//没有发送次数，第一次发送</span></span><br><span class=\"line\">            <span class=\"comment\">//设置发送次数是1</span></span><br><span class=\"line\">            jedis.setex(countKey,<span class=\"number\">24</span>*<span class=\"number\">60</span>*<span class=\"number\">60</span>,<span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(Integer.parseInt(number) &lt;= <span class=\"number\">2</span>)&#123;</span><br><span class=\"line\">            <span class=\"comment\">//发送次数+1</span></span><br><span class=\"line\">            jedis.incr(countKey);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(Integer.parseInt(number) == <span class=\"number\">3</span>)&#123;</span><br><span class=\"line\">            <span class=\"comment\">//发送次数三发送</span></span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;不能发了&quot;</span>);</span><br><span class=\"line\">            jedis.close();</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//验证码放到redis中</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">code1</span> <span class=\"operator\">=</span> getCode();</span><br><span class=\"line\">        jedis.setex(codeKey, <span class=\"number\">120</span>, code1);</span><br><span class=\"line\">        jedis.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//3. 验证码校验</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span>  <span class=\"keyword\">static</span>  <span class=\"keyword\">void</span>  <span class=\"title function_\">getRedisCode</span><span class=\"params\">(String phone ,String code)</span>&#123;</span><br><span class=\"line\">        <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>, <span class=\"number\">6379</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">codekey</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;verifyCode&quot;</span>+phone+<span class=\"string\">&quot;:code&quot;</span>;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">redisCode</span> <span class=\"operator\">=</span> jedis.get(codekey);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(redisCode.equals(code))&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;success&quot;</span>);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;failed&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        jedis.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303122129854.png\" alt=\"image-20230312212933831\" style=\"zoom:23%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303122129574.png\" alt=\"image-20230312212956549\" style=\"zoom:13%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131641127.png\" alt=\"image-20230313164128098\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131652977.png\" alt=\"image-20230313165212938\" style=\"zoom:33%;\"></p>\n<h2 id=\"Redis-和SpringBoot的整合\"><a href=\"#Redis-和SpringBoot的整合\" class=\"headerlink\" title=\"Redis 和SpringBoot的整合\"></a>Redis 和SpringBoot的整合</h2><h6 id=\"1、-创建springBoot工程\"><a href=\"#1、-创建springBoot工程\" class=\"headerlink\" title=\"1、 创建springBoot工程\"></a>1、 创建springBoot工程</h6><h6 id=\"2、导入依赖\"><a href=\"#2、导入依赖\" class=\"headerlink\" title=\"2、导入依赖\"></a>2、导入依赖</h6><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">java.version</span>&gt;</span>1.8<span class=\"tag\">&lt;/<span class=\"name\">java.version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">aliyun-spring-boot.version</span>&gt;</span>1.0.0<span class=\"tag\">&lt;/<span class=\"name\">aliyun-spring-boot.version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-web<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>aliyun-redis-spring-boot-starter<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.12.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-annotations<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.11.4<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-databind<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.11.4<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.projectlombok<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>lombok<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">optional</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">optional</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-test<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- redis --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">        spring2.X集成redis所需common-pool2</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">        此时已经不需要了，因为springboot 已经自动注入了</span></span><br><span class=\"line\"><span class=\"comment\">        --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        &lt;dependency&gt;--&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;--&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--            &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;--&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--            &lt;version&gt;2.6.0&lt;/version&gt;--&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--        &lt;/dependency&gt;--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>aliyun-spring-boot-dependencies<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>$&#123;aliyun-spring-boot.version&#125;<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>pom<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>import<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.maven.plugins<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-compiler-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.8.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span>1.8<span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">target</span>&gt;</span>1.8<span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">encoding</span>&gt;</span>UTF-8<span class=\"tag\">&lt;/<span class=\"name\">encoding</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">build</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h6 id=\"3、添加配置\"><a href=\"#3、添加配置\" class=\"headerlink\" title=\"3、添加配置\"></a>3、添加配置</h6><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Redis服务器地址</span></span><br><span class=\"line\"><span class=\"attr\">spring.redis.host</span>=<span class=\"string\">192.168.10.33</span></span><br><span class=\"line\"><span class=\"comment\">#Redis服务器密码</span></span><br><span class=\"line\"><span class=\"attr\">spring.redis.password</span>=<span class=\"string\">00000000</span></span><br><span class=\"line\"><span class=\"comment\">#Redis服务器连接端口</span></span><br><span class=\"line\"><span class=\"attr\">spring.redis.port</span>=<span class=\"string\">6379</span></span><br><span class=\"line\"><span class=\"comment\">#Redis数据库索引（默认为0）</span></span><br><span class=\"line\"><span class=\"attr\">spring.redis.database</span>= <span class=\"string\">0</span></span><br><span class=\"line\"><span class=\"comment\">#连接超时时间（毫秒）</span></span><br><span class=\"line\"><span class=\"attr\">spring.redis.timeout</span>=<span class=\"string\">1800000</span></span><br><span class=\"line\"><span class=\"comment\">#连接池最大连接数（使用负值表示没有限制）</span></span><br><span class=\"line\"><span class=\"attr\">spring.redis.lettuce.pool.max-active</span>=<span class=\"string\">20</span></span><br><span class=\"line\"><span class=\"comment\">#最大阻塞等待时间(负数表示没限制)</span></span><br><span class=\"line\"><span class=\"attr\">spring.redis.lettuce.pool.max-wait</span>=<span class=\"string\">-1</span></span><br><span class=\"line\"><span class=\"comment\">#连接池中的最大空闲连接</span></span><br><span class=\"line\"><span class=\"attr\">spring.redis.lettuce.pool.max-idle</span>=<span class=\"string\">5</span></span><br><span class=\"line\"><span class=\"comment\">#连接池中的最小空闲连接</span></span><br><span class=\"line\"><span class=\"attr\">spring.redis.lettuce.pool.min-idle</span>=<span class=\"string\">0</span></span><br></pre></td></tr></table></figure>\n<h6 id=\"4、添加配置类\"><a href=\"#4、添加配置类\" class=\"headerlink\" title=\"4、添加配置类\"></a>4、添加配置类</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.redis.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.cache.CacheManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.cache.annotation.CachingConfigurerSupport;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.cache.RedisCacheManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.Duration;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@EnableCaching</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RedisConfig</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">CachingConfigurerSupport</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> RedisTemplate&lt;String, Object&gt; <span class=\"title function_\">redisTemplate</span><span class=\"params\">(RedisConnectionFactory factory)</span> &#123;</span><br><span class=\"line\">        RedisTemplate&lt;String, Object&gt; template = <span class=\"keyword\">new</span> <span class=\"title class_\">RedisTemplate</span>&lt;&gt;();</span><br><span class=\"line\">        RedisSerializer&lt;String&gt; redisSerializer = <span class=\"keyword\">new</span> <span class=\"title class_\">StringRedisSerializer</span>();</span><br><span class=\"line\">        <span class=\"type\">Jackson2JsonRedisSerializer</span> <span class=\"variable\">jackson2JsonRedisSerializer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class=\"line\">        <span class=\"type\">ObjectMapper</span> <span class=\"variable\">om</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObjectMapper</span>();</span><br><span class=\"line\">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class=\"line\">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class=\"line\">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class=\"line\">        template.setConnectionFactory(factory);</span><br><span class=\"line\"><span class=\"comment\">//key序列化方式</span></span><br><span class=\"line\">        template.setKeySerializer(redisSerializer);</span><br><span class=\"line\"><span class=\"comment\">//value序列化</span></span><br><span class=\"line\">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class=\"line\"><span class=\"comment\">//value hashmap序列化</span></span><br><span class=\"line\">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> template;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> CacheManager <span class=\"title function_\">cacheManager</span><span class=\"params\">(RedisConnectionFactory factory)</span> &#123;</span><br><span class=\"line\">        RedisSerializer&lt;String&gt; redisSerializer = <span class=\"keyword\">new</span> <span class=\"title class_\">StringRedisSerializer</span>();</span><br><span class=\"line\">        <span class=\"type\">Jackson2JsonRedisSerializer</span> <span class=\"variable\">jackson2JsonRedisSerializer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class=\"line\"><span class=\"comment\">//解决查询缓存转换异常的问题</span></span><br><span class=\"line\">        <span class=\"type\">ObjectMapper</span> <span class=\"variable\">om</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObjectMapper</span>();</span><br><span class=\"line\">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class=\"line\">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class=\"line\">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class=\"line\"><span class=\"comment\">// 配置序列化（解决乱码的问题）,过期时间600秒</span></span><br><span class=\"line\">        <span class=\"type\">RedisCacheConfiguration</span> <span class=\"variable\">config</span> <span class=\"operator\">=</span> RedisCacheConfiguration.defaultCacheConfig()</span><br><span class=\"line\">                .entryTtl(Duration.ofSeconds(<span class=\"number\">600</span>))</span><br><span class=\"line\">                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))</span><br><span class=\"line\">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))</span><br><span class=\"line\">                .disableCachingNullValues();</span><br><span class=\"line\">        <span class=\"type\">RedisCacheManager</span> <span class=\"variable\">cacheManager</span> <span class=\"operator\">=</span> RedisCacheManager.builder(factory)</span><br><span class=\"line\">                .cacheDefaults(config)</span><br><span class=\"line\">                .build();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> cacheManager;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"5、测试代码\"><a href=\"#5、测试代码\" class=\"headerlink\" title=\"5、测试代码\"></a>5、测试代码</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.redis.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/redisTest&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RedisController</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> RedisTemplate redisTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@GetMapping</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">testRedis</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//设置值到redis</span></span><br><span class=\"line\">        redisTemplate.opsForValue().set(<span class=\"string\">&quot;name&quot;</span>,<span class=\"string\">&quot;ry&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//从redis获取值</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">name</span> <span class=\"operator\">=</span> (String)redisTemplate.opsForValue().get(<span class=\"string\">&quot;name&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"6、测试结果\"><a href=\"#6、测试结果\" class=\"headerlink\" title=\"6、测试结果\"></a>6、测试结果</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131648798.png\" alt=\"image-20230313164835709\"></p>\n<h2 id=\"Redis-事务、锁机制秒杀\"><a href=\"#Redis-事务、锁机制秒杀\" class=\"headerlink\" title=\"Redis 事务、锁机制秒杀\"></a>Redis 事务、锁机制秒杀</h2><h3 id=\"Redis-事务定义\"><a href=\"#Redis-事务定义\" class=\"headerlink\" title=\"Redis 事务定义\"></a>Redis 事务定义</h3><p>Redis 事务是一个单独的<code>隔离操作</code>：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</p>\n<p>Redis 事务的主要作用就是串联多个命令防止别的命令插队。</p>\n<h3 id=\"Multi、Exec、discard\"><a href=\"#Multi、Exec、discard\" class=\"headerlink\" title=\"Multi、Exec、discard\"></a>Multi、Exec、discard</h3><p>Redis 事务中有 Multi、Exec 和 discard 三个指令，在 Redis 中，从输入 Multi 命令开始，输入的命令都会依次进入命令队列中，但不会执行，直到输入 Exec 后，Redis 会将之前的命令队列中的命令依次执行。而组队的过程中可以通过 discard 来放弃组队。</p>\n<p>​                                                    <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131654845.jpg\" alt=\"img\" style=\"zoom: 23%;\"><br>案例说明：</p>\n<p>​                                                    <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131654085.jpg\" alt=\"img\" style=\"zoom:13%;\"></p>\n<blockquote>\n<p>组队成功，提交成功。</p>\n</blockquote>\n<p>​                                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131655858.jpg\" alt=\"img\" style=\"zoom:13%;\"></p>\n<blockquote>\n<p>组队阶段报错，提交失败。</p>\n</blockquote>\n<p>​                                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131655047.jpg\" style=\"zoom:13%;\"></p>\n<blockquote>\n<p>组队成功，提交有成功有失败情况。</p>\n</blockquote>\n<h3 id=\"事务错误的处理\"><a href=\"#事务错误的处理\" class=\"headerlink\" title=\"事务错误的处理\"></a>事务错误的处理</h3><p>组队中某个命令出现了报告错误，执行时整个的所有队列都会被取消。</p>\n<p>​                                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131657080.png\" alt=\"image-20230313165655298\" style=\"zoom:33%;\"><br>如果执行阶段某个命令报出了错误，则只有报错的命令不会被执行，而其他的命令都会执行，不会回滚。</p>\n<p>​                                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131657763.png\" alt=\"image-20230313165705664\" style=\"zoom:33%;\"></p>\n<h3 id=\"为什么要做成事务\"><a href=\"#为什么要做成事务\" class=\"headerlink\" title=\"为什么要做成事务\"></a>为什么要做成事务</h3><p>想想一个场景：有很多人有你的账户，同时去参加双十一抢购。</p>\n<h5 id=\"事务冲突的问题\"><a href=\"#事务冲突的问题\" class=\"headerlink\" title=\"事务冲突的问题\"></a>事务冲突的问题</h5><h6 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h6><blockquote>\n<p>一个请求想给金额减 8000；</p>\n<p>一个请求想给金额减 5000；</p>\n<p>一个请求想给金额减 1000。</p>\n<p>最终我们可以发现，总共金额是 10000，如果请求全部执行，那最后的金额变为 - 4000，很明显不合理。</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131658975.png\" style=\"zoom:33%;\"></p>\n<h6 id=\"悲观锁\"><a href=\"#悲观锁\" class=\"headerlink\" title=\"悲观锁\"></a>悲观锁</h6><p>​                                            <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131658670.png\" alt=\"image-20230313165837574\" style=\"zoom:33%;\"><br>悲观锁 (Pessimistic Lock)，顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会 block 直到它拿到锁。传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。</p>\n<h6 id=\"乐观锁\"><a href=\"#乐观锁\" class=\"headerlink\" title=\"乐观锁\"></a>乐观锁</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131659097.png\" style=\"zoom:33%;\"></p>\n<p>乐观锁 (Optimistic Lock)，顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。乐观锁适用于多读的应用类型，这样可以提高吞吐量。Redis 就是利用这种 check-and-set 机制实现事务的。</p>\n<h6 id=\"WATCH-key-key-…\"><a href=\"#WATCH-key-key-…\" class=\"headerlink\" title=\"WATCH key [key …]\"></a>WATCH key [key …]</h6><p>在执行 multi 之前，先执行 watch key1 [key2]，可以监视一个 (或多个) key ，如果在事务执行之前这个 (或这些) key 被其他命令所改动，那么事务将被打断。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131700188.jpg\" style=\"zoom:15%;\"></p>\n<p>​                                            <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131700452.jpg\" alt=\"img\" style=\"zoom:15%;\"></p>\n<h6 id=\"unwatch\"><a href=\"#unwatch\" class=\"headerlink\" title=\"unwatch\"></a>unwatch</h6><p>取消 WATCH 命令对所有 key 的监视。如果在执行 WATCH 命令之后，EXEC 命令或 DISCARD 命令先被执行了的话，那么就不需要再执行 UNWATCH 了。</p>\n<h6 id=\"事务-http-doc-redisfans-com-transaction-exec-html\"><a href=\"#事务-http-doc-redisfans-com-transaction-exec-html\" class=\"headerlink\" title=\"[事务][http://doc.redisfans.com/transaction/exec.html]\"></a>[事务][<a href=\"http://doc.redisfans.com/transaction/exec.html\">http://doc.redisfans.com/transaction/exec.html</a>]</h6><h3 id=\"Redis-事务三特性\"><a href=\"#Redis-事务三特性\" class=\"headerlink\" title=\"Redis 事务三特性\"></a>Redis 事务三特性</h3><ul>\n<li><p>单独的隔离操作 ：</p>\n<ul>\n<li>事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</li>\n</ul>\n</li>\n<li><p>没有隔离级别的概念 ：</p>\n<ul>\n<li>队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行。</li>\n</ul>\n</li>\n<li><p>不保证原子性 ：</p>\n<ul>\n<li>事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚 。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Redis-事务-秒杀案例\"><a href=\"#Redis-事务-秒杀案例\" class=\"headerlink\" title=\"Redis 事务 秒杀案例\"></a>Redis 事务 秒杀案例</h3><h4 id=\"解决计数器和人员记录的事务操作\"><a href=\"#解决计数器和人员记录的事务操作\" class=\"headerlink\" title=\"解决计数器和人员记录的事务操作\"></a>解决计数器和人员记录的事务操作</h4><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131702173.png\" alt=\"image-20230313170246135\" style=\"zoom:33%;\"></p>\n<h4 id=\"秒杀\"><a href=\"#秒杀\" class=\"headerlink\" title=\"秒杀\"></a>秒杀</h4><h5 id=\"模拟非并发\"><a href=\"#模拟非并发\" class=\"headerlink\" title=\"模拟非并发\"></a>模拟非并发</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.redis;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.Jedis;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.Transaction;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SecKill_redis</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span><span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>,<span class=\"number\">6379</span>);</span><br><span class=\"line\">\t\tSystem.out.println(jedis.ping());</span><br><span class=\"line\">\t\tjedis.close();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//秒杀过程</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"type\">boolean</span> <span class=\"title function_\">doSecKill</span><span class=\"params\">(String uid,String prodid)</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">//1 uid和prodid非空判断</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(uid == <span class=\"literal\">null</span> || prodid == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//2 连接redis</span></span><br><span class=\"line\">\t\t<span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>,<span class=\"number\">6379</span>);</span><br><span class=\"line\">\t\t<span class=\"comment\">//通过连接池得到jedis对象</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//JedisPool jedisPoolInstance = JedisPoolUtil.getJedisPoolInstance();</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//Jedis jedis = jedisPoolInstance.getResource();</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//3 拼接key</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// 3.1 库存key</span></span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">kcKey</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;sk:&quot;</span>+prodid+<span class=\"string\">&quot;:qt&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 3.2 秒杀成功用户key</span></span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">userKey</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;sk:&quot;</span>+prodid+<span class=\"string\">&quot;:user&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//监视库存</span></span><br><span class=\"line\">\t\tjedis.watch(kcKey);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//4 获取库存，如果库存null，秒杀还没有开始</span></span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">kc</span> <span class=\"operator\">=</span> jedis.get(kcKey);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(kc == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">\t\t\tSystem.out.println(<span class=\"string\">&quot;秒杀还没有开始，请等待&quot;</span>);</span><br><span class=\"line\">\t\t\tjedis.close();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// 5 判断用户是否重复秒杀操作</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//用户id用set&lt;不重复&gt;存储</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(jedis.sismember(userKey, uid)) &#123;</span><br><span class=\"line\">\t\t\tSystem.out.println(<span class=\"string\">&quot;已经秒杀成功了，不能重复秒杀&quot;</span>);</span><br><span class=\"line\">\t\t\tjedis.close();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//6 判断如果商品数量，库存数量小于1，秒杀结束</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(Integer.parseInt(kc)&lt;=<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t\tSystem.out.println(<span class=\"string\">&quot;秒杀已经结束了&quot;</span>);</span><br><span class=\"line\">\t\t\tjedis.close();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//7 秒杀过程</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//7.1 库存-1</span></span><br><span class=\"line\">\t\tjedis.decr(kcKey);</span><br><span class=\"line\">\t\t<span class=\"comment\">//7.2 把秒杀成功用户添加清单里面</span></span><br><span class=\"line\">\t\tjedis.sadd(userKey,uid);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tSystem.out.println(<span class=\"string\">&quot;秒杀成功了..&quot;</span>);</span><br><span class=\"line\">\t\tjedis.close();</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>servelt</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.redis;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.LinkedList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Random;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.ServletException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.http.HttpServlet;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.xml.ws.soap.AddressingFeature.Responses;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 秒杀案例</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SecKillServlet</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">HttpServlet</span> &#123;</span><br><span class=\"line\">   <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">1L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">SecKillServlet</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">super</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">doPost</span><span class=\"params\">(HttpServletRequest request, HttpServletResponse response)</span> <span class=\"keyword\">throws</span> ServletException, IOException &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"type\">String</span> <span class=\"variable\">userid</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Random</span>().nextInt(<span class=\"number\">50000</span>) +<span class=\"string\">&quot;&quot;</span> ;</span><br><span class=\"line\">      <span class=\"type\">String</span> <span class=\"variable\">prodid</span> <span class=\"operator\">=</span>request.getParameter(<span class=\"string\">&quot;prodid&quot;</span>);</span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"type\">boolean</span> isSuccess=SecKill_redis.doSecKill(userid,prodid);</span><br><span class=\"line\">      response.getWriter().print(isSuccess);</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>测试结果</strong></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131704047.png\" alt=\"image-20230312224919141\" style=\"zoom:23%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303122250092.png\" alt=\"image-20230312225005049\" style=\"zoom:35%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303122251757.png\" alt=\"image-20230312225122728\" style=\"zoom:33%;\"></p>\n<h5 id=\"就用上述代码模拟并发\"><a href=\"#就用上述代码模拟并发\" class=\"headerlink\" title=\"就用上述代码模拟并发\"></a>就用上述代码模拟并发</h5><p>需要说明的是：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303122349666.png\" alt=\"image-20230312234932648\" style=\"zoom:33%;\"></p>\n<h6 id=\"使用工具ab-模拟测试\"><a href=\"#使用工具ab-模拟测试\" class=\"headerlink\" title=\"使用工具ab 模拟测试\"></a>使用工具ab 模拟测试</h6><blockquote>\n<p>执行：ab -n 2000 -c 200 -k -p ~/postfile -T application/x-www-form-urlencoded</p>\n</blockquote>\n<p>参数postfile  要单独出创建文件，就在当前目录</p>\n<p>vim postfile 模拟表单提交参数， 以 &amp; 符号结尾，存放当前目录。</p>\n<p>内容：prodid=0101&amp;</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303122353979.png\" alt=\"image-20230312235349954\" style=\"zoom:45%;\"></p>\n<p>执行命令</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303122349262.png\" alt=\"image-20230312234955221\" style=\"zoom: 33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131704025.png\" alt=\"image-20230312234855382\" style=\"zoom:33%;\"></p>\n<p>访问：<a href=\"http://192.168.2.115:8081/Seckill/doseckill\">http://192.168.2.115:8081/Seckill/doseckill</a></p>\n<h5 id=\"并发会出现的问题：\"><a href=\"#并发会出现的问题：\" class=\"headerlink\" title=\"并发会出现的问题：\"></a>并发会出现的问题：</h5><h6 id=\"1、\"><a href=\"#1、\" class=\"headerlink\" title=\"1、\"></a>1、</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131711269.png\" alt=\"image-20230312235038679\" style=\"zoom:25%;\"></p>\n<h6 id=\"2、连接超时（超卖）、（超卖）现象\"><a href=\"#2、连接超时（超卖）、（超卖）现象\" class=\"headerlink\" title=\"2、连接超时（超卖）、（超卖）现象\"></a>2、连接超时（超卖）、（超卖）现象</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131712701.png\" alt=\"image-20230312235056831\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131712102.png\" alt=\"image-20230313171259063\" style=\"zoom:25%;\"></p>\n<h5 id=\"解决问题\"><a href=\"#解决问题\" class=\"headerlink\" title=\"解决问题\"></a>解决问题</h5><h6 id=\"解决问题1：使用连接池\"><a href=\"#解决问题1：使用连接池\" class=\"headerlink\" title=\"解决问题1：使用连接池\"></a>解决问题1：使用连接池</h6><blockquote>\n<p>连接池参数：</p>\n<ul>\n<li><p>MaxTotal：控制一个 pool 可分配多少个 jedis 实例，通过 pool.getResource () 来获取；如果赋值为 - 1，则表示不限制；如果 pool 已经分配了 MaxTotal 个 jedis 实例，则此时 pool 的状态为 exhausted。</p>\n</li>\n<li><p>maxIdle：控制一个 pool 最多有多少个状态为 idle (空闲) 的 jedis 实例；</p>\n</li>\n<li><p>MaxWaitMillis：表示当 borrow 一个 jedis 实例时，最大的等待毫秒数，如果超过等待时间，则直接抛 JedisConnectionException；</p>\n</li>\n<li><p>testOnBorrow：获得一个 jedis 实例的时候是否检查连接可用性（ping ()）；如果为 true，则得到的 jedis 实例均是可用的。</p>\n</li>\n</ul>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.redis;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.Jedis;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.JedisPool;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JedisPoolUtil</span> &#123;</span><br><span class=\"line\">   <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">volatile</span> <span class=\"type\">JedisPool</span> <span class=\"variable\">jedisPool</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">private</span> <span class=\"title function_\">JedisPoolUtil</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> JedisPool <span class=\"title function_\">getJedisPoolInstance</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"literal\">null</span> == jedisPool) &#123;</span><br><span class=\"line\">         <span class=\"keyword\">synchronized</span> (JedisPoolUtil.class) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"literal\">null</span> == jedisPool) &#123;</span><br><span class=\"line\">               <span class=\"type\">JedisPoolConfig</span> <span class=\"variable\">poolConfig</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JedisPoolConfig</span>();</span><br><span class=\"line\">               poolConfig.setMaxTotal(<span class=\"number\">200</span>);</span><br><span class=\"line\">               poolConfig.setMaxIdle(<span class=\"number\">32</span>);</span><br><span class=\"line\">               poolConfig.setMaxWaitMillis(<span class=\"number\">100</span>*<span class=\"number\">1000</span>);</span><br><span class=\"line\">               poolConfig.setBlockWhenExhausted(<span class=\"literal\">true</span>);</span><br><span class=\"line\">               poolConfig.setTestOnBorrow(<span class=\"literal\">true</span>);  <span class=\"comment\">// ping  PONG</span></span><br><span class=\"line\">             </span><br><span class=\"line\">               jedisPool = <span class=\"keyword\">new</span> <span class=\"title class_\">JedisPool</span>(poolConfig, <span class=\"string\">&quot;192.168.10.33&quot;</span>, <span class=\"number\">6379</span>, <span class=\"number\">60000</span> );</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> jedisPool;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">release</span><span class=\"params\">(JedisPool jedisPool, Jedis jedis)</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"literal\">null</span> != jedis) &#123;</span><br><span class=\"line\">         jedisPool.returnResource(jedis);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修改代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SecKill_redis</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">//秒杀过程</span></span><br><span class=\"line\">   <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"type\">boolean</span> <span class=\"title function_\">doSecKill</span><span class=\"params\">(String uid,String prodid)</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">      <span class=\"comment\">//1 uid和prodid非空判断</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(uid == <span class=\"literal\">null</span> || prodid == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//2 连接redis</span></span><br><span class=\"line\">      <span class=\"comment\">//Jedis jedis = new Jedis(&quot;192.168.10.33&quot;,6379);</span></span><br><span class=\"line\">      <span class=\"comment\">//通过连接池得到jedis对象</span></span><br><span class=\"line\">      <span class=\"type\">JedisPool</span> <span class=\"variable\">jedisPoolInstance</span> <span class=\"operator\">=</span> JedisPoolUtil.getJedisPoolInstance();</span><br><span class=\"line\">      <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> jedisPoolInstance.getResource();</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"解决问题2：利用乐观锁\"><a href=\"#解决问题2：利用乐观锁\" class=\"headerlink\" title=\"解决问题2：利用乐观锁\"></a>解决问题2：利用乐观锁</h6><p>使用乐观锁淘汰用户，解决超卖问题。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132153545.png\" alt=\"image-20230313215354491\" style=\"zoom:25%;\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.redis;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.Jedis;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.JedisPool;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.Transaction;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SecKill_redis</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">      <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span><span class=\"keyword\">new</span> <span class=\"title class_\">Jedis</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>,<span class=\"number\">6379</span>);</span><br><span class=\"line\">      System.out.println(jedis.ping());</span><br><span class=\"line\">      jedis.close();</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">//秒杀过程</span></span><br><span class=\"line\">   <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"type\">boolean</span> <span class=\"title function_\">doSecKill</span><span class=\"params\">(String uid,String prodid)</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">      <span class=\"comment\">//1 uid和prodid非空判断</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(uid == <span class=\"literal\">null</span> || prodid == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//2 连接redis</span></span><br><span class=\"line\">      <span class=\"comment\">//Jedis jedis = new Jedis(&quot;192.168.10.33&quot;,6379);</span></span><br><span class=\"line\">      <span class=\"comment\">//通过连接池得到jedis对象</span></span><br><span class=\"line\">      <span class=\"type\">JedisPool</span> <span class=\"variable\">jedisPoolInstance</span> <span class=\"operator\">=</span> JedisPoolUtil.getJedisPoolInstance();</span><br><span class=\"line\">      <span class=\"type\">Jedis</span> <span class=\"variable\">jedis</span> <span class=\"operator\">=</span> jedisPoolInstance.getResource();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//3 拼接key</span></span><br><span class=\"line\">      <span class=\"comment\">// 3.1 库存key</span></span><br><span class=\"line\">      <span class=\"type\">String</span> <span class=\"variable\">kcKey</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;sk:&quot;</span>+prodid+<span class=\"string\">&quot;:qt&quot;</span>;</span><br><span class=\"line\">      <span class=\"comment\">// 3.2 秒杀成功用户key</span></span><br><span class=\"line\">      <span class=\"type\">String</span> <span class=\"variable\">userKey</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;sk:&quot;</span>+prodid+<span class=\"string\">&quot;:user&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//监视库存</span></span><br><span class=\"line\">      jedis.watch(kcKey);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//4 获取库存，如果库存null，秒杀还没有开始</span></span><br><span class=\"line\">      <span class=\"type\">String</span> <span class=\"variable\">kc</span> <span class=\"operator\">=</span> jedis.get(kcKey);</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(kc == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">         System.out.println(<span class=\"string\">&quot;秒杀还没有开始，请等待&quot;</span>);</span><br><span class=\"line\">         jedis.close();</span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 5 判断用户是否重复秒杀操作</span></span><br><span class=\"line\">      <span class=\"comment\">//用户id用set&lt;不重复&gt;存储</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(jedis.sismember(userKey, uid)) &#123;</span><br><span class=\"line\">         System.out.println(<span class=\"string\">&quot;已经秒杀成功了，不能重复秒杀&quot;</span>);</span><br><span class=\"line\">         jedis.close();</span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//6 判断如果商品数量，库存数量小于1，秒杀结束</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(Integer.parseInt(kc)&lt;=<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">         System.out.println(<span class=\"string\">&quot;秒杀已经结束了&quot;</span>);</span><br><span class=\"line\">         jedis.close();</span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//7 秒杀过程</span></span><br><span class=\"line\">      <span class=\"comment\">//使用事务</span></span><br><span class=\"line\">      <span class=\"type\">Transaction</span> <span class=\"variable\">multi</span> <span class=\"operator\">=</span> jedis.multi();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//组队操作</span></span><br><span class=\"line\">      multi.decr(kcKey);</span><br><span class=\"line\">      multi.sadd(userKey,uid);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">//执行</span></span><br><span class=\"line\">      List&lt;Object&gt; results = multi.exec();</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span>(results == <span class=\"literal\">null</span> || results.size()==<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">         System.out.println(<span class=\"string\">&quot;秒杀失败了....&quot;</span>);</span><br><span class=\"line\">         jedis.close();</span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      System.out.println(<span class=\"string\">&quot;秒杀成功了..&quot;</span>);</span><br><span class=\"line\">      jedis.close();</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>添加数据：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131716391.png\" alt=\"image-20230313000210194\" style=\"zoom:25%;\"></p>\n<p>ab测试：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130002341.png\" alt=\"image-20230313000223300\" style=\"zoom:25%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130002037.png\" alt=\"image-20230313000242996\" style=\"zoom:45%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130002307.png\" alt=\"image-20230313000255265\" style=\"zoom:33%;\"></p>\n<h4 id=\"遗留问题\"><a href=\"#遗留问题\" class=\"headerlink\" title=\"遗留问题\"></a>遗留问题</h4><p>继续增加并发测试导致连接有限制增加 - r 参数，-r  Don’t exit on socket receive errors。</p>\n<p><code>ab -n 2000 -c 100 -r -p postfile -T &#39;application/x-www-form-urlencoded&#39; http://192.168.10.33:8080/seckill/doseckill</code></p>\n<h6 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h6><p>已经秒光，可是还有库存。</p>\n<h6 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h6><p>乐观锁导致很多请求都失败。先点的没秒到，后点的可能秒到了。但是redis又不能直接使用悲观锁</p>\n<h6 id=\"LUA-脚本在-Redis-中的优势\"><a href=\"#LUA-脚本在-Redis-中的优势\" class=\"headerlink\" title=\"LUA 脚本在 Redis 中的优势\"></a>LUA 脚本在 Redis 中的优势</h6><p>将复杂的或者多步的 redis 操作，写为一个脚本，一次提交给 redis 执行，减少反复连接 redis 的次数，提升性能。</p>\n<p>LUA 脚本是类似 redis 事务，有一定的原子性，不会被其他命令插队，可以完成一些 redis 事务性的操作。</p>\n<p>但是注意 redis 的 lua 脚本功能，只有在 Redis 2.6 以上的版本才可以使用。</p>\n<p>利用 lua 脚本淘汰用户，解决超卖问题，redis 2.6 版本以后，通过 lua 脚本解决争抢问题，实际上是 redis 利用其单线程的特性，用任务队列的方式解决多任务并发问题。</p>\n<p>​                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131723519.png\" style=\"zoom:33%;\"></p>\n<p>LUA解决—-SecKill_redisByScript.java</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.redis;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashSet;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.pool2.impl.GenericObjectPoolConfig;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.slf4j.LoggerFactory;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> ch.qos.logback.core.joran.conditional.ElseAction;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.HostAndPort;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.Jedis;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.JedisCluster;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.JedisPool;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.ShardedJedisPool;</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis.clients.jedis.Transaction;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SecKill_redisByScript</span> &#123;</span><br><span class=\"line\">   </span><br><span class=\"line\">   <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span>  org.slf4j.<span class=\"type\">Logger</span> <span class=\"variable\">logger</span> <span class=\"operator\">=</span>LoggerFactory.getLogger(SecKill_redisByScript.class) ;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">      <span class=\"type\">JedisPool</span> <span class=\"variable\">jedispool</span> <span class=\"operator\">=</span>  JedisPoolUtil.getJedisPoolInstance();</span><br><span class=\"line\"> </span><br><span class=\"line\">      Jedis jedis=jedispool.getResource();</span><br><span class=\"line\">      System.out.println(jedis.ping());</span><br><span class=\"line\">      </span><br><span class=\"line\">      Set&lt;HostAndPort&gt; set=<span class=\"keyword\">new</span> <span class=\"title class_\">HashSet</span>&lt;HostAndPort&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">// doSecKill(&quot;201&quot;,&quot;sk:0101&quot;);</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">   <span class=\"keyword\">static</span> <span class=\"type\">String</span> <span class=\"variable\">secKillScript</span> <span class=\"operator\">=</span><span class=\"string\">&quot;local userid=KEYS[1];\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;local prodid=KEYS[2];\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;local qtkey=&#x27;sk:&#x27;..prodid..\\&quot;:qt\\&quot;;\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;local usersKey=&#x27;sk:&#x27;..prodid..\\&quot;:usr\\&quot;;\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;local userExists=redis.call(\\&quot;sismember\\&quot;,usersKey,userid);\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;if tonumber(userExists)==1 then \\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;   return 2;\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;end\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;local num= redis.call(\\&quot;get\\&quot; ,qtkey);\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;if tonumber(num)&lt;=0 then \\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;   return 0;\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;else \\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;   redis.call(\\&quot;decr\\&quot;,qtkey);\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;   redis.call(\\&quot;sadd\\&quot;,usersKey,userid);\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;end\\r\\n&quot;</span> + </span><br><span class=\"line\">         <span class=\"string\">&quot;return 1&quot;</span> ;</span><br><span class=\"line\">          </span><br><span class=\"line\">   <span class=\"keyword\">static</span> <span class=\"type\">String</span> <span class=\"variable\">secKillScript2</span> <span class=\"operator\">=</span> </span><br><span class=\"line\">         <span class=\"string\">&quot;local userExists=redis.call(\\&quot;sismember\\&quot;,\\&quot;&#123;sk&#125;:0101:usr\\&quot;,userid);\\r\\n&quot;</span> +</span><br><span class=\"line\">         <span class=\"string\">&quot; return 1&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"type\">boolean</span> <span class=\"title function_\">doSecKill</span><span class=\"params\">(String uid,String prodid)</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"type\">JedisPool</span> <span class=\"variable\">jedispool</span> <span class=\"operator\">=</span>  JedisPoolUtil.getJedisPoolInstance();</span><br><span class=\"line\">      Jedis jedis=jedispool.getResource();</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">//String sha1=  .secKillScript;</span></span><br><span class=\"line\">      String sha1=  jedis.scriptLoad(secKillScript);</span><br><span class=\"line\">      Object result= jedis.evalsha(sha1, <span class=\"number\">2</span>, uid,prodid);</span><br><span class=\"line\"></span><br><span class=\"line\">        String reString=String.valueOf(result);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"string\">&quot;0&quot;</span>.equals( reString )  ) &#123;</span><br><span class=\"line\">         System.err.println(<span class=\"string\">&quot;已抢空！！&quot;</span>);</span><br><span class=\"line\">      &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"string\">&quot;1&quot;</span>.equals( reString )  )  &#123;</span><br><span class=\"line\">         System.out.println(<span class=\"string\">&quot;抢购成功！！！！&quot;</span>);</span><br><span class=\"line\">      &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"string\">&quot;2&quot;</span>.equals( reString )  )  &#123;</span><br><span class=\"line\">         System.err.println(<span class=\"string\">&quot;该用户已抢过！！&quot;</span>);</span><br><span class=\"line\">      &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">         System.err.println(<span class=\"string\">&quot;抢购异常！！&quot;</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      jedis.close();</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时修改：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SecKillServlet</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">HttpServlet</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      </span><br><span class=\"line\">      <span class=\"comment\">//boolean isSuccess=SecKill_redis.doSecKill(userid,prodid);</span></span><br><span class=\"line\">      <span class=\"type\">boolean</span> isSuccess= SecKill_redisByScript.doSecKill(userid,prodid);</span><br><span class=\"line\">      response.getWriter().print(isSuccess);</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>测试结果</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130022706.png\" alt=\"image-20230313002252658\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131724922.png\" alt=\"image-20230313002306795\" style=\"zoom:33%;\"></p>\n<p>此时结果：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131724212.png\" alt=\"image-20230313002320449\" style=\"zoom:33%;\"></p>\n<h6 id=\"回顾流程：\"><a href=\"#回顾流程：\" class=\"headerlink\" title=\"回顾流程：\"></a>回顾流程：</h6><p><strong>第一版</strong>：简单版<br>正常点10次，秒杀没有问题。这是因为还达不到并发的效果。<br>使用工具ab模拟并发测试，会出现超卖情况。查看库存会出现负数。<br><strong>第二版</strong>：加事务-乐观锁(解决超卖),但出现遗留库存和连接超时<br><strong>第三版</strong>：连接池解决超时问题<br><strong>第四版</strong>：解决库存依赖问题，LUA脚本</p>\n<h2 id=\"单机的Redis存在四大问题：\"><a href=\"#单机的Redis存在四大问题：\" class=\"headerlink\" title=\"单机的Redis存在四大问题：\"></a>单机的Redis存在四大问题：</h2><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305191614638.png\" alt=\"image-20230519161419561\"></p>\n<h2 id=\"Redis-持久化\"><a href=\"#Redis-持久化\" class=\"headerlink\" title=\"Redis 持久化\"></a>Redis 持久化</h2><h3 id=\"总体介绍\"><a href=\"#总体介绍\" class=\"headerlink\" title=\"总体介绍\"></a>总体介绍</h3><h5 id=\"持久化\"><a href=\"#持久化\" class=\"headerlink\" title=\"持久化\"></a>持久化</h5><p>redis将数据写到硬盘上</p>\n<p>[官网介绍][<a href=\"http://www.redis.io\">http://www.redis.io</a>]</p>\n<h5 id=\"Redis-提供了-2-个不同形式的持久化方式：\"><a href=\"#Redis-提供了-2-个不同形式的持久化方式：\" class=\"headerlink\" title=\"Redis 提供了 2 个不同形式的持久化方式：\"></a>Redis 提供了 2 个不同形式的持久化方式：</h5><ul>\n<li><p>RDB（Redis DataBase）</p>\n</li>\n<li><p>AOF（Append Of File）</p>\n</li>\n</ul>\n<h3 id=\"RDB\"><a href=\"#RDB\" class=\"headerlink\" title=\"RDB\"></a>RDB</h3><h4 id=\"简介-1\"><a href=\"#简介-1\" class=\"headerlink\" title=\"简介\"></a>简介</h4><p>在指定的时间间隔内将内存中的数据集快照写入磁盘， 也就是行话讲的 Snapshot 快照，它恢复时是将快照文件直接读到内存里。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131729852.png\" alt=\"image-20230313172905797\" style=\"zoom:13%;\"></p>\n<h4 id=\"执行时机\"><a href=\"#执行时机\" class=\"headerlink\" title=\"执行时机\"></a>执行时机</h4><p>RDB持久化在四种情况下会执行：</p>\n<ul>\n<li>执行save命令(主进程进行执行所以会阻塞， 除非redis完全停止之前，之后不再使用，可以使用save)</li>\n<li>执行bgsave命令(子线程执行，所以不会阻塞)</li>\n<li>Redis停机时</li>\n<li>触发RDB条件时</li>\n</ul>\n<h4 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h4><blockquote>\n<p>是一种<code>异步持久化</code>的</p>\n</blockquote>\n<p>bgsave开始时会fork主进程得到子进程，子进程共享主进程的内存数据。完成fork后读取内存数据并写入 RDB 文件。</p>\n<p>fork采用的是copy-on-write技术：</p>\n<ul>\n<li>当主进程执行读操作时，访问共享内存；</li>\n<li>当主进程执行写操作时，则会拷贝一份数据，执行写操作。</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305191617814.png\" alt=\"image-20230519161731774\"></p>\n<p>RDB方式bgsave的基本流程？</p>\n<ul>\n<li>fork主进程得到一个子进程，共享内存空间</li>\n<li>子进程读取内存数据并写入新的RDB文件</li>\n<li>用新RDB文件替换 （是新的替换不是简单的修改）旧的RDB文件</li>\n</ul>\n<p>RDB会在什么时候执行？save 60 1000代表什么含义？</p>\n<ul>\n<li>默认是<code>服务停止</code>时</li>\n<li>代表60秒内至少执行1000次修改则触发RDB</li>\n</ul>\n<p>RDB的缺点？</p>\n<ul>\n<li>RDB执行间隔时间长，两次RDB之间写入数据有丢失的风险(存在 数据安全的漏洞)</li>\n<li>fork子进程、压缩、写出RDB文件都比较耗时</li>\n</ul>\n<h4 id=\"备份是如何执行的\"><a href=\"#备份是如何执行的\" class=\"headerlink\" title=\"备份是如何执行的\"></a>备份是如何执行的</h4><p>Redis 会单独创建（fork）一个子进程来进行持久化，首先会将数据写入到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何 IO 操作的，这就确保了极高的性能。如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那 RDB 方式要比 AOF 方式更加的高效。RDB 的缺点是最后一次持久化后的数据可能丢失。</p>\n<h4 id=\"Fork\"><a href=\"#Fork\" class=\"headerlink\" title=\"Fork\"></a>Fork</h4><ul>\n<li><p>Fork 的作用是复制一个与当前进程一样的进程。新进程的所有数据（变量、环境变量、程序计数器等） 数值都和原进程一致，但是是一个全新的进程，并作为原进程的子进程。</p>\n</li>\n<li><p>在 Linux 程序中，fork () 会产生一个和父进程完全相同的子进程，但子进程在此后多会 exec 系统调用，出于效率考虑，Linux 中引入了 “写时复制技术”。</p>\n</li>\n<li><p>一般情况父进程和子进程会共用同一段物理内存，只有进程空间的各段的内容要发生变化时，才会将父进程的内容复制一份给子进程。</p>\n</li>\n</ul>\n<h4 id=\"RDB-持久化流程\"><a href=\"#RDB-持久化流程\" class=\"headerlink\" title=\"RDB 持久化流程\"></a>RDB 持久化流程</h4><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131730670.png\" alt=\"image-20230313173047534\" style=\"zoom:25%;\"></p>\n<h4 id=\"dump-rdb-文件\"><a href=\"#dump-rdb-文件\" class=\"headerlink\" title=\"dump.rdb 文件\"></a>dump.rdb 文件</h4><p>在 redis.conf 中配置文件名称，默认为 dump.rdb。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131732893.png\" alt=\"image-20230313173223851\" style=\"zoom:33%;\"></p>\n<h4 id=\"配置位置\"><a href=\"#配置位置\" class=\"headerlink\" title=\"配置位置\"></a>配置位置</h4><p>rdb 文件的保存路径，也是可以修改的。默认为 Redis 启动时命令行所在的目录下 “dir ./”</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131732568.png\" style=\"zoom:33%;\"></p>\n<h4 id=\"如何触发-RDB-快照；保持策略\"><a href=\"#如何触发-RDB-快照；保持策略\" class=\"headerlink\" title=\"如何触发 RDB 快照；保持策略\"></a>如何触发 RDB 快照；保持策略</h4><h5 id=\"配置文件中默认的快照配置\"><a href=\"#配置文件中默认的快照配置\" class=\"headerlink\" title=\"配置文件中默认的快照配置\"></a>配置文件中默认的快照配置</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131732363.png\" alt=\"image-20230313173215174\" style=\"zoom:33%;\"></p>\n<h5 id=\"命令-save-VS-bgsave\"><a href=\"#命令-save-VS-bgsave\" class=\"headerlink\" title=\"命令 save VS bgsave\"></a>命令 save VS bgsave</h5><ul>\n<li><p><code>save</code> ：save 时只管保存，其它不管，全部阻塞。手动保存，不建议。</p>\n</li>\n<li><p><code>bgsave</code> ：Redis 会在后台异步进行快照操作， 快照同时还可以响应客户端请求。</p>\n</li>\n</ul>\n<p>可以通过 lastsave 命令获取最后一次成功执行快照的时间。</p>\n<h5 id=\"Save\"><a href=\"#Save\" class=\"headerlink\" title=\"Save\"></a>Save</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131734036.jpg\" alt=\"img\" style=\"zoom:13%;\"></p>\n<h6 id=\"格式：save-秒钟-写操作次数\"><a href=\"#格式：save-秒钟-写操作次数\" class=\"headerlink\" title=\"格式：save 秒钟 写操作次数\"></a>格式：<code>save 秒钟 写操作次数</code></h6><ul>\n<li><p>RDB是整个内存的压缩过的Snapshot，RDB的数据结构，可以配置复合的快照触发条件，</p>\n</li>\n<li><p>默认是1分钟内改了1万次，或5分钟内改了10次，或15分钟内改了1次。</p>\n</li>\n<li><p>禁用:  不设置save指令，或者给save传入空字符串</p>\n</li>\n</ul>\n<h6 id=\"演示\"><a href=\"#演示\" class=\"headerlink\" title=\"演示:\"></a>演示:</h6><p>修改redis.conf</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132154310.png\" alt=\"image-20230313215414269\" style=\"zoom:25%;\"></p>\n<p>添加数据</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131737533.png\" alt=\"image-20230313173726393\" style=\"zoom:18%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131734047.jpg\" alt=\"img\" style=\"zoom:18%;\"></p>\n<h5 id=\"flushall-命令\"><a href=\"#flushall-命令\" class=\"headerlink\" title=\"flushall 命令\"></a>flushall 命令</h5><p>执行 flushall 命令，也会产生 dump.rdb 文件，但里面是空的，无意义。</p>\n<h5 id=\"stop-writes-on-bgsave-error\"><a href=\"#stop-writes-on-bgsave-error\" class=\"headerlink\" title=\"stop-writes-on-bgsave-error\"></a>stop-writes-on-bgsave-error</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131734034.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>当Redis无法写入磁盘的话，直接关掉Redis的写操作。推荐yes.</p>\n</blockquote>\n<h5 id=\"rdbcompression-压缩文件\"><a href=\"#rdbcompression-压缩文件\" class=\"headerlink\" title=\"rdbcompression 压缩文件\"></a>rdbcompression 压缩文件</h5><p>​                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131740547.png\" alt=\"image-20230313174040402\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>对于存储到磁盘中的快照，可以设置是否进行压缩存储。如果是的话，redis会采用LZF算法进行压缩。</p>\n<p>如果你不想消耗CPU来进行压缩的话，可以设置为关闭此功能。推荐yes.</p>\n</blockquote>\n<h5 id=\"rdbchecksum检查完整性\"><a href=\"#rdbchecksum检查完整性\" class=\"headerlink\" title=\"rdbchecksum检查完整性\"></a>rdbchecksum检查完整性</h5><p>​                                                    <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131740926.png\" alt=\"image-20230313174013786\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>在存储快照后，还可以让redis使用CRC64算法来进行数据校验，</p>\n<p>但是这样做会增加大约10%的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能.推荐yes.</p>\n</blockquote>\n<h5 id=\"rdb的备份\"><a href=\"#rdb的备份\" class=\"headerlink\" title=\"rdb的备份\"></a>rdb的备份</h5><p>先通过config get dir  查询rdb文件的目录 ;将*.rdb的文件拷贝到别的地方</p>\n<h5 id=\"rdb的恢复\"><a href=\"#rdb的恢复\" class=\"headerlink\" title=\"rdb的恢复\"></a>rdb的恢复</h5><ul>\n<li><p>关闭Redis</p>\n</li>\n<li><p>先把备份的文件拷贝到工作目录下 cp dump2.rdb dump.rdb</p>\n</li>\n<li><p>启动Redis, 备份数据会直接加载</p>\n</li>\n<li><p>演示：</p>\n<p>修改<strong>redis.conf</strong></p>\n</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131734096.jpg\" alt=\"img\" style=\"zoom:13%;\"></p>\n<p>​    <strong>添加数据</strong></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131743987.png\" alt=\"image-20230313174341843\" style=\"zoom:18%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131744298.png\" alt=\"image-20230313174410158\" style=\"zoom:18%;\"></p>\n<pre><code>                                 &lt;img src=&quot;https://gitee.com/Ryang1118/typora/raw/master/images/202303131734220.jpg&quot; alt=&quot;img&quot; style=&quot;zoom:18%;&quot; /&gt; \n</code></pre><p>​                                        <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131734404.jpg\" alt=\"img\" style=\"zoom:18%;\"></p>\n<h4 id=\"优势\"><a href=\"#优势\" class=\"headerlink\" title=\"优势\"></a>优势</h4><ul>\n<li><p>适合大规模的数据恢复</p>\n</li>\n<li><p>对数据完整性和一致性要求不高更适合使用</p>\n</li>\n<li><p>节省磁盘空间</p>\n</li>\n<li><p>恢复速度快</p>\n</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131745017.png\" alt=\"image-20230313174555877\" style=\"zoom:33%;\"></p>\n<h4 id=\"劣势\"><a href=\"#劣势\" class=\"headerlink\" title=\"劣势\"></a>劣势</h4><ul>\n<li><p>Fork 的时候，内存中的数据被克隆了一份，大致 2 倍的膨胀性需要考虑。</p>\n</li>\n<li><p>虽然 Redis 在 fork 时使用了写时拷贝技术，但是如果数据庞大时还是比较消耗性能。</p>\n</li>\n<li><p>在备份周期在一定间隔时间做一次备份，所以如果 Redis 意外 down 掉的话，就会丢失最后一次快照后的所有修改。</p>\n</li>\n</ul>\n<h4 id=\"如何停止\"><a href=\"#如何停止\" class=\"headerlink\" title=\"如何停止\"></a>如何停止</h4><blockquote>\n<p>动态停止 RDB：redis-cli config set save “”#save 后给空值，表示禁用保存策略。</p>\n</blockquote>\n<h4 id=\"小总结\"><a href=\"#小总结\" class=\"headerlink\" title=\"小总结\"></a>小总结</h4><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131746269.png\" style=\"zoom:33%;\"></p>\n<h3 id=\"AOF\"><a href=\"#AOF\" class=\"headerlink\" title=\"AOF\"></a>AOF</h3><h4 id=\"简介-2\"><a href=\"#简介-2\" class=\"headerlink\" title=\"简介\"></a>简介</h4><p>以日志的形式来记录每个写操作（增量保存），将 Redis 执行过的所有写指令记录下来 (读操作不记录)， <code>只许追加文件但不可以改写文件</code>，redis 启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。</p>\n<h4 id=\"AOF-默认不开启\"><a href=\"#AOF-默认不开启\" class=\"headerlink\" title=\"AOF 默认不开启\"></a>AOF 默认不开启</h4><blockquote>\n<p>可以在 redis.conf 中配置文件名称默认为 appendonly.aof 文件中开启。</p>\n</blockquote>\n<p>修改</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131807145.jpg\" alt=\"img\" style=\"zoom:23%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131807147.jpg\" alt=\"img\" style=\"zoom:22%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131807095.png\" alt=\"image-20230313180748039\" style=\"zoom:23%;\"></p>\n<blockquote>\n<p>AOF 文件的保存路径，同 RDB 的路径一致。</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131808073.png\" style=\"zoom:25%;\"></p>\n<blockquote>\n<p>上面没有数据的原因：AOF 和 RDB 同时开启，系统默认取 AOF 的数据（数据不会存在丢失）</p>\n</blockquote>\n<h4 id=\"AOF-和-RDB-同时开启，redis-听谁的？\"><a href=\"#AOF-和-RDB-同时开启，redis-听谁的？\" class=\"headerlink\" title=\"AOF 和 RDB 同时开启，redis 听谁的？\"></a>AOF 和 RDB 同时开启，redis 听谁的？</h4><blockquote>\n<p>AOF 和 RDB 同时开启，系统默认取 AOF 的数据（数据不会存在丢失）。</p>\n</blockquote>\n<p>​                                    <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131810503.jpg\" alt=\"img\" style=\"zoom:18%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131810677.png\" alt=\"image-20230313181045635\" style=\"zoom:18%;\"></p>\n<h4 id=\"AOF-启动、修复、恢复\"><a href=\"#AOF-启动、修复、恢复\" class=\"headerlink\" title=\"AOF 启动、修复、恢复\"></a>AOF 启动、修复、恢复</h4><ul>\n<li><p>AOF 的备份机制和性能虽然和 RDB 不同，但是备份和恢复的操作同 RDB 一样，都是拷贝备份文件，需要恢复时再拷贝到 Redis 工作目录下，启动系统即加载。</p>\n</li>\n<li><p>正常恢复</p>\n<ul>\n<li><p>修改默认的 appendonly no，改为 yes。</p>\n</li>\n<li><p>将有数据的 aof 文件复制一份保存到对应目录 (查看目录：config get dir)。</p>\n</li>\n<li><p>恢复：重启 redis 然后重新加载。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131811787.png\" alt=\"image-20230313181144752\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131811934.png\" alt=\"image-20230313181155898\" style=\"zoom:33%;\"></p>\n</li>\n</ul>\n</li>\n<li><p>异常恢复</p>\n<ul>\n<li><p>修改默认的 appendonly no，改为 yes。</p>\n</li>\n<li><p>如遇到 AOF 文件损坏，通过 /usr/local/bin/ redis-check-aof–fix appendonly.aof 进行恢复。<br>备份被写坏的 AOF 文件。</p>\n</li>\n<li><p>恢复：重启 redis，然后重新加载。</p>\n<p>操作演示：</p>\n<p><code>加一条数据</code></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131813238.png\" alt=\"image-20230313181329198\" style=\"zoom:18%;\"> </p>\n<p><code>关闭之后重启出错</code></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131812354.jpg\" alt=\"img\" style=\"zoom:18%;\"> </p>\n<p><code>修复</code></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131814444.png\" style=\"zoom:18%;\"></p>\n<p>​                            <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131812351.jpg\" alt=\"img\" style=\"zoom:18%;\"></p>\n</li>\n</ul>\n</li>\n</ul>\n<pre><code>`重启即可`\n\n&lt;img src=&quot;https://gitee.com/Ryang1118/typora/raw/master/images/202303131814093.png&quot; alt=&quot;image-20230313181457054&quot; style=&quot;zoom:18%;&quot; /&gt;\n</code></pre><h4 id=\"AOF-同步频率设置\"><a href=\"#AOF-同步频率设置\" class=\"headerlink\" title=\"AOF 同步频率设置\"></a>AOF 同步频率设置</h4><p><code>appendfsync always</code>：始终同步，每次 Redis 的写入都会立刻记入日志；性能较差但数据完整性比较好。</p>\n<p><code>appendfsync everysec</code>：每秒同步，每秒记入日志一次，如果宕机，本秒的数据可能丢失。</p>\n<p><code>appendfsync no</code>：redis 不主动进行同步，把同步时机交给操作系统。</p>\n<h4 id=\"Rewrite-压缩-重写压缩\"><a href=\"#Rewrite-压缩-重写压缩\" class=\"headerlink\" title=\"Rewrite 压缩(重写压缩)\"></a>Rewrite 压缩(重写压缩)</h4><h5 id=\"是什么\"><a href=\"#是什么\" class=\"headerlink\" title=\"是什么\"></a>是什么</h5><p>AOF 采用文件追加方式，文件会越来越大为避免出现此种情况，新增了重写机制，当 AOF 文件的大小超过所设定的阈值时，Redis 就会启动 AOF 文件的内容压缩，只保留可以恢复数据的最小指令集，可以使用命令 bgrewriteaof。</p>\n<h5 id=\"重写原理，如何实现重写\"><a href=\"#重写原理，如何实现重写\" class=\"headerlink\" title=\"重写原理，如何实现重写\"></a>重写原理，如何实现重写</h5><p>AOF 文件持续增长而过大时，会 fork 出一条新进程来将文件重写 (也是先写临时文件最后再 rename)，redis4.0 版本后的重写，是指把 rdb 的快照，以二进制的形式附在新的 aof 头部，作为已有的历史数据，替换掉原来的流水账操作。</p>\n<h6 id=\"no-appendfsync-on-rewrite：\"><a href=\"#no-appendfsync-on-rewrite：\" class=\"headerlink\" title=\"no-appendfsync-on-rewrite：\"></a>no-appendfsync-on-rewrite：</h6><ul>\n<li><p>如果 no-appendfsync-on-rewrite=yes ，不写入 aof 文件只写入缓存，用户请求不会阻塞，但是在这段时间如果宕机会丢失这段时间的缓存数据。（降低数据安全性，提高性能）</p>\n</li>\n<li><p>如果 no-appendfsync-on-rewrite=no，还是会把数据往磁盘里刷，但是遇到重写操作，可能会发生阻塞。（数据安全，但是性能降低）</p>\n</li>\n</ul>\n<h6 id=\"触发机制，何时重写\"><a href=\"#触发机制，何时重写\" class=\"headerlink\" title=\"触发机制，何时重写\"></a>触发机制，何时重写</h6><ul>\n<li><p>Redis 会记录上次重写时的 AOF 大小，默认配置是当 AOF 文件大小是上次 rewrite 后大小的一倍且文件大于 64M 时触发。</p>\n</li>\n<li><p>重写虽然可以节约大量磁盘空间，减少恢复时间。但是每次重写还是有一定的负担的，因此设定 Redis 要满足一定条件才会进行重写。</p>\n</li>\n</ul>\n<h6 id=\"auto-aof-rewrite-percentage：\"><a href=\"#auto-aof-rewrite-percentage：\" class=\"headerlink\" title=\"auto-aof-rewrite-percentage：\"></a>auto-aof-rewrite-percentage：</h6><p>设置重写的基准值，文件达到 100% 时开始重写（文件是原来重写后文件的 2 倍时触发）。</p>\n<h6 id=\"auto-aof-rewrite-min-size：\"><a href=\"#auto-aof-rewrite-min-size：\" class=\"headerlink\" title=\"auto-aof-rewrite-min-size：\"></a>auto-aof-rewrite-min-size：</h6><p>设置重写的基准值，最小文件 64MB。达到这个值开始重写。系统载入时或者上次重写完毕时，Redis 会记录此时 AOF 大小，设为 base_size,如果 Redis 的 AOF 当前大小 &gt;= base_size +base_size*100% (默认) 且当前大小 &gt;=64mb (默认) 的情况下，Redis 会对 AOF 进行重写。</p>\n<p>例如：文件达到 70MB 开始重写，降到 50MB，下次什么时候开始重写？100MB</p>\n<h5 id=\"重写流程\"><a href=\"#重写流程\" class=\"headerlink\" title=\"重写流程\"></a>重写流程</h5><ul>\n<li><p>bgrewriteaof 触发重写，判断是否当前有 bgsave 或 bgrewriteaof 在运行，如果有，则等待该命令结束后再继续执行；</p>\n</li>\n<li><p>主进程 fork 出子进程执行重写操作，保证主进程不会阻塞；</p>\n</li>\n<li><p>子进程遍历 redis 内存中数据到临时文件，客户端的写请求同时写入 aof_buf 缓冲区和 aof_rewrite_buf 重写缓冲区，保证原 AOF 文件完整以及新 AOF 文件生成期间的新的数据修改动作不会丢失；</p>\n</li>\n<li><p>子进程写完新的 AOF 文件后，向主进程发信号，父进程更新统计信息。主进程把 aof_rewrite_buf 中的数据写入到新的 AOF 文件；</p>\n</li>\n<li><p>使用新的 AOF 文件覆盖旧的 AOF 文件，完成 AOF 重写。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131819158.png\" alt=\"image-20230313181918100\" style=\"zoom:33%;\"></p>\n</li>\n</ul>\n<h4 id=\"AOF持久化流程\"><a href=\"#AOF持久化流程\" class=\"headerlink\" title=\"AOF持久化流程\"></a>AOF持久化流程</h4><blockquote>\n<p>（1）客户端的请求写命令会被append追加到AOF缓冲区内；</p>\n<p>（2）AOF缓冲区根据AOF持久化策略[always,everysec,no]将操作sync同步到磁盘的AOF文件中；</p>\n<p>（3）AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量；</p>\n<p>（4）Redis服务重启时，会重新load加载AOF文件中的写操作达到数据恢复的目的；</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131820297.png\" style=\"zoom:33%;\"></p>\n<h4 id=\"优势-1\"><a href=\"#优势-1\" class=\"headerlink\" title=\"优势\"></a>优势</h4><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131820187.png\" style=\"zoom:25%;\"></p>\n<ul>\n<li><p>备份机制更稳健，丢失数据概率更低。</p>\n</li>\n<li><p>可读的日志文本，通过操作 AOF 稳健，可以处理误操作。</p>\n</li>\n</ul>\n<h4 id=\"劣势-1\"><a href=\"#劣势-1\" class=\"headerlink\" title=\"劣势\"></a>劣势</h4><ul>\n<li><p>比起 RDB 占用更多的磁盘空间。</p>\n</li>\n<li><p>恢复备份速度要慢。</p>\n</li>\n<li><p>每次读写都同步的话，有一定的性能压力。</p>\n</li>\n<li><p>存在个别 Bug，造成恢复不能。</p>\n</li>\n</ul>\n<h4 id=\"小总结-1\"><a href=\"#小总结-1\" class=\"headerlink\" title=\"小总结\"></a>小总结</h4><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131821207.png\" style=\"zoom:25%;\"></p>\n<h3 id=\"总结-Which-one\"><a href=\"#总结-Which-one\" class=\"headerlink\" title=\"总结 (Which one)\"></a>总结 (Which one)</h3><h4 id=\"用哪个好\"><a href=\"#用哪个好\" class=\"headerlink\" title=\"用哪个好\"></a>用哪个好</h4><p>官方推荐两个都启用：</p>\n<ul>\n<li><p>如果对数据不敏感，可以选单独用 RDB。</p>\n</li>\n<li><p>不建议单独用 AOF，因为可能会出现 Bug。</p>\n</li>\n<li><p>如果只是做纯内存缓存，可以都不用。</p>\n</li>\n</ul>\n<h4 id=\"官网建议\"><a href=\"#官网建议\" class=\"headerlink\" title=\"官网建议\"></a>官网建议</h4><ul>\n<li><p>RDB 持久化方式能够在指定的时间间隔能对你的数据进行快照存储。</p>\n</li>\n<li><p>AOF 持久化方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，AOF 命令以 redis 协议追加保存每次写的操作到文件末尾。</p>\n</li>\n<li><p>Redis 还能对 AOF 文件进行后台重写，使得 AOF 文件的体积不至于过大。</p>\n</li>\n<li><p>只做缓存：如果你只希望你的数据在服务器运行的时候存在，你也可以不使用任何持久化方式。</p>\n</li>\n<li><p>同时开启两种持久化方式：在这种情况下，当 redis 重启的时候会优先载入 AOF 文件来恢复原始的数据，因为在通常情况下 AOF 文件保存的数据集要比 RDB 文件保存的数据集要完整。</p>\n</li>\n<li><p>RDB 的数据不实时，同时使用两者时服务器重启也只会找 AOF 文件。那要不要只使用 AOF 呢？</p>\n</li>\n<li><p>建议不要，因为 RDB 更适合用于备份数据库 (AOF 在不断变化不好备份)，快速重启，而且不会有 AOF 可能潜在的 bug，留着作为一个万一的手段。</p>\n</li>\n</ul>\n<h4 id=\"性能建议：\"><a href=\"#性能建议：\" class=\"headerlink\" title=\"性能建议：\"></a>性能建议：</h4><ul>\n<li><p>因为 RDB 文件只用作后备用途，建议只在 Slave 上持久化 RDB 文件，而且只要 15 分钟备份一次就够了，只保留 save 9001 这条规则。</p>\n</li>\n<li><p>如果使用 AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单，只 load 自己的 AOF 文件就可以了。aof 代价：一是带来了持续的 IO，二是 AOF rewrite 的最后，将 rewrite 过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。</p>\n</li>\n<li><p>只要硬盘许可，应该尽量减少 AOF rewrite 的频率，AOF 重写的基础大小默认值 64M 太小了，可以设到 5G 以上。默认超过原大小 100% 大小时重写可以改到适当的数值。</p>\n</li>\n</ul>\n<h2 id=\"Redis-主从复制\"><a href=\"#Redis-主从复制\" class=\"headerlink\" title=\"Redis 主从复制\"></a>Redis 主从复制</h2><h3 id=\"概念：\"><a href=\"#概念：\" class=\"headerlink\" title=\"概念：\"></a>概念：</h3><p>单节点Redis的并发能力是有上限的，要进一步提高Redis的并发能力，就需要搭建主从集群，实现读写分离。</p>\n<p>主机数据更新后根据配置和策略， 自动同步到备机的 master/slaver 机制，Master 以写为主，Slave 以读为主，主从复制节点间数据是全量的。</p>\n<h3 id=\"作用：\"><a href=\"#作用：\" class=\"headerlink\" title=\"作用：\"></a>作用：</h3><ul>\n<li><p>读写分离，性能扩展</p>\n</li>\n<li><p>容灾快速恢复</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305191618366.png\" alt=\"image-20230519161836326\" style=\"zoom:33%;\"></p>\n</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131851741.png\" alt=\"image-20230313185133667\" style=\"zoom:33%;\"></p>\n<h3 id=\"操作实施：\"><a href=\"#操作实施：\" class=\"headerlink\" title=\"操作实施：\"></a>操作实施：</h3><h5 id=\"一主两从的配置：\"><a href=\"#一主两从的配置：\" class=\"headerlink\" title=\"一主两从的配置：\"></a>一主两从的配置：</h5><h6 id=\"1、创建-myredis文件夹\"><a href=\"#1、创建-myredis文件夹\" class=\"headerlink\" title=\"1、创建 /myredis文件夹\"></a>1、创建 /myredis文件夹</h6><h6 id=\"2、复制redis-conf配置文件到文件夹中\"><a href=\"#2、复制redis-conf配置文件到文件夹中\" class=\"headerlink\" title=\"2、复制redis.conf配置文件到文件夹中\"></a>2、复制redis.conf配置文件到文件夹中</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131853370.png\" alt=\"image-20230313014153936\" style=\"zoom:53%;\"></p>\n<h6 id=\"3、配置一主两从，创建三个配置文件\"><a href=\"#3、配置一主两从，创建三个配置文件\" class=\"headerlink\" title=\"3、配置一主两从，创建三个配置文件\"></a>3、配置一主两从，创建三个配置文件</h6><blockquote>\n<ul>\n<li>redis6379.conf</li>\n<li>redis6380.conf</li>\n<li>redis6381.conf</li>\n</ul>\n</blockquote>\n<h6 id=\"4、关闭redis-conf-的-appendonly\"><a href=\"#4、关闭redis-conf-的-appendonly\" class=\"headerlink\" title=\"4、关闭redis.conf 的 appendonly\"></a>4、关闭redis.conf 的 appendonly</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130141454.png\" alt=\"image-20230313014126403\" style=\"zoom:43%;\"></p>\n<h6 id=\"5、在三个配置文件写入内容\"><a href=\"#5、在三个配置文件写入内容\" class=\"headerlink\" title=\"5、在三个配置文件写入内容\"></a>5、在三个配置文件写入内容</h6><blockquote>\n<ul>\n<li>include /myredis/redis.conf</li>\n<li>pidfile /var/run/redis_6379.pid</li>\n<li>port 6379</li>\n<li>dbfilename dump6379.rdb</li>\n</ul>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130143954.png\" alt=\"image-20230313014313907\" style=\"zoom:53%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130144900.png\" alt=\"image-20230313014411839\" style=\"zoom:63%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130144688.png\" alt=\"image-20230313014420638\" style=\"zoom:33%;\"></p>\n<h6 id=\"6、启动所有redis服务\"><a href=\"#6、启动所有redis服务\" class=\"headerlink\" title=\"6、启动所有redis服务\"></a>6、启动所有redis服务</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130146094.png\" alt=\"image-20230313014625039\" style=\"zoom:33%;\"></p>\n<h6 id=\"7、链接各个redis\"><a href=\"#7、链接各个redis\" class=\"headerlink\" title=\"7、链接各个redis\"></a>7、链接各个redis</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131853727.png\" alt=\"image-20230313014815426\" style=\"zoom:73%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130148344.png\" alt=\"image-20230313014837288\" style=\"zoom:60%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130148754.png\" alt=\"image-20230313014844701\" style=\"zoom:50%;\"></p>\n<h6 id=\"8、配从-库-不配主-库\"><a href=\"#8、配从-库-不配主-库\" class=\"headerlink\" title=\"8、配从(库)不配主(库)\"></a>8、配从(库)不配主(库)</h6><p><code>slaveof  &lt;ip&gt;&lt;port&gt;</code>在<strong>从机</strong>上执行slaveof主机ip端口号  配置主从，否则全是主机</p>\n<p>在6380和6381上执行: slaveof 127.0.0.1 6379</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130200259.png\" alt=\"image-20230313020053219\"></p>\n<h6 id=\"9、查看运行状况\"><a href=\"#9、查看运行状况\" class=\"headerlink\" title=\"9、查看运行状况\"></a>9、查看运行状况</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130151055.png\" alt=\"image-20230313015044039\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130201077.png\" alt=\"image-20230313020123040\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131853074.png\" alt=\"image-20230313015140195\" style=\"zoom:33%;\"></p>\n<h6 id=\"10、在主机上写，在从机上可以读取数据\"><a href=\"#10、在主机上写，在从机上可以读取数据\" class=\"headerlink\" title=\"10、在主机上写，在从机上可以读取数据\"></a>10、在主机上写，在从机上可以读取数据</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130154226.png\" alt=\"image-20230313015400183\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131853277.png\" alt=\"image-20230313015400183\" style=\"zoom:33%;\"></p>\n<h6 id=\"11、在从机上写数据报错\"><a href=\"#11、在从机上写数据报错\" class=\"headerlink\" title=\"11、在从机上写数据报错\"></a>11、在从机上写数据报错</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303130154126.png\" style=\"zoom:33%;\"></p>\n<h3 id=\"三种主从复制的实现方式\"><a href=\"#三种主从复制的实现方式\" class=\"headerlink\" title=\"三种主从复制的实现方式\"></a>三种主从复制的实现方式</h3><h4 id=\"一主二仆\"><a href=\"#一主二仆\" class=\"headerlink\" title=\"一主二仆\"></a>一主二仆</h4><h5 id=\"演示-从机挂掉\"><a href=\"#演示-从机挂掉\" class=\"headerlink\" title=\"演示 从机挂掉\"></a>演示 从机挂掉</h5><h6 id=\"1、让6380挂掉\"><a href=\"#1、让6380挂掉\" class=\"headerlink\" title=\"1、让6380挂掉\"></a>1、让6380挂掉</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131904226.png\" alt=\"image-20230313102525195\" style=\"zoom:47%;\"></p>\n<h6 id=\"2、给6379-加一个数据\"><a href=\"#2、给6379-加一个数据\" class=\"headerlink\" title=\"2、给6379 加一个数据\"></a>2、给6379 加一个数据</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131026664.png\" alt=\"image-20230313102602606\" style=\"zoom:67%;\"></p>\n<h6 id=\"3、重启6380\"><a href=\"#3、重启6380\" class=\"headerlink\" title=\"3、重启6380\"></a>3、重启6380</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131904792.png\" alt=\"image-20230313102649965\" style=\"zoom:57%;\"></p>\n<h6 id=\"4、结果是6380重启之后就变为主机了\"><a href=\"#4、结果是6380重启之后就变为主机了\" class=\"headerlink\" title=\"4、结果是6380重启之后就变为主机了\"></a>4、结果是6380重启之后就变为主机了</h6><h6 id=\"5、使6380再变为从机\"><a href=\"#5、使6380再变为从机\" class=\"headerlink\" title=\"5、使6380再变为从机\"></a>5、使6380再变为从机</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131027613.png\" alt=\"image-20230313102745558\" style=\"zoom:67%;\"></p>\n<h6 id=\"6、此时查看6380与6379-中的数据是一样的\"><a href=\"#6、此时查看6380与6379-中的数据是一样的\" class=\"headerlink\" title=\"6、此时查看6380与6379 中的数据是一样的\"></a>6、此时查看6380与6379 中的数据是一样的</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131904377.png\" alt=\"image-20230313102831318\" style=\"zoom:40%;\"></p>\n<h5 id=\"演示主机挂掉时\"><a href=\"#演示主机挂掉时\" class=\"headerlink\" title=\"演示主机挂掉时\"></a>演示主机挂掉时</h5><h6 id=\"1、主机6379挂掉\"><a href=\"#1、主机6379挂掉\" class=\"headerlink\" title=\"1、主机6379挂掉\"></a>1、主机6379挂掉</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131029072.png\" alt=\"image-20230313102913014\" style=\"zoom:47%;\"></p>\n<h6 id=\"2、从机仍然是从机\"><a href=\"#2、从机仍然是从机\" class=\"headerlink\" title=\"2、从机仍然是从机\"></a>2、从机仍然是从机</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131904083.png\" alt=\"image-20230313102938250\" style=\"zoom:47%;\"></p>\n<h6 id=\"3、让主机重启之后仍然是主机\"><a href=\"#3、让主机重启之后仍然是主机\" class=\"headerlink\" title=\"3、让主机重启之后仍然是主机\"></a>3、让主机重启之后仍然是主机</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131030070.png\" alt=\"image-20230313103019014\" style=\"zoom:47%;\"></p>\n<h4 id=\"薪火相传\"><a href=\"#薪火相传\" class=\"headerlink\" title=\"薪火相传\"></a>薪火相传</h4><h5 id=\"解释：\"><a href=\"#解释：\" class=\"headerlink\" title=\"解释：\"></a>解释：</h5><p>上一个Slave可以是下一个slave的Master，Slave同样可以接收其他 slaves的连接和同步请求，那么该slave作为了链条中下一个的master, 可以有效减轻master的写压力,去中心化降低风险。</p>\n<h5 id=\"做法：\"><a href=\"#做法：\" class=\"headerlink\" title=\"做法：\"></a>做法：</h5><p>用 <code>slaveof  &lt;ip&gt;&lt;port&gt;</code></p>\n<h5 id=\"注意：\"><a href=\"#注意：\" class=\"headerlink\" title=\"注意：\"></a>注意：</h5><ul>\n<li><p>如果中途变更转向:会清除之前的数据，重新建立拷贝最新的</p>\n</li>\n<li><p>风险是一旦某个slave宕机，后面的slave都没法备份</p>\n</li>\n<li><p>主机挂了，从机还是从机，无法写数据了</p>\n</li>\n</ul>\n<h5 id=\"演示-1\"><a href=\"#演示-1\" class=\"headerlink\" title=\"演示\"></a>演示</h5><h6 id=\"1、使6381的主机变为6380-不再是6379了\"><a href=\"#1、使6381的主机变为6380-不再是6379了\" class=\"headerlink\" title=\"1、使6381的主机变为6380 不再是6379了\"></a>1、使6381的主机变为6380 不再是6379了</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131913077.png\" alt=\"image-20230313103406495\" style=\"zoom:70%;\"></p>\n<h6 id=\"2、可以看到，此时6379的从机就只有6380了\"><a href=\"#2、可以看到，此时6379的从机就只有6380了\" class=\"headerlink\" title=\"2、可以看到，此时6379的从机就只有6380了\"></a>2、可以看到，此时6379的从机就只有6380了</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131036395.png\" alt=\"image-20230313103641355\" style=\"zoom:38%;\"></p>\n<h4 id=\"反客为主\"><a href=\"#反客为主\" class=\"headerlink\" title=\"反客为主\"></a>反客为主</h4><p>反客为主：当一个 master 宕机后，后面的 slave 可以立刻升为 master，其后面的 slave 不用做任何修改。用 <code>slaveof no one</code> 指令将从机变为主机。而<code>哨兵模式</code>是反客为主的<code>自动版</code>，能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库。</p>\n<h5 id=\"1、手动实现–slaveof-no-one\"><a href=\"#1、手动实现–slaveof-no-one\" class=\"headerlink\" title=\"1、手动实现–slaveof  no one\"></a>1、手动实现–<code>slaveof  no one</code></h5><h6 id=\"1、让6379-挂掉\"><a href=\"#1、让6379-挂掉\" class=\"headerlink\" title=\"1、让6379 挂掉\"></a>1、让6379 挂掉</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131915550.png\" alt=\"image-20230313103539185\" style=\"zoom: 55%;\"></p>\n<h6 id=\"2、6381-实现反客为主\"><a href=\"#2、6381-实现反客为主\" class=\"headerlink\" title=\"2、6381 实现反客为主\"></a>2、6381 实现反客为主</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131035255.png\" alt=\"image-20230313103559200\" style=\"zoom:53%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131915141.png\" alt=\"image-20230313103619457\" style=\"zoom:35%;\"></p>\n<h5 id=\"2、自动实现——哨兵模式\"><a href=\"#2、自动实现——哨兵模式\" class=\"headerlink\" title=\"2、自动实现——哨兵模式\"></a>2、自动实现——哨兵模式</h5><h4 id=\"哨兵模式-sentinel-：\"><a href=\"#哨兵模式-sentinel-：\" class=\"headerlink\" title=\"哨兵模式 (sentinel)：\"></a>哨兵模式 (sentinel)：</h4><h5 id=\"概念：-1\"><a href=\"#概念：-1\" class=\"headerlink\" title=\"概念：\"></a>概念：</h5><p>反客为主的<code>自动版</code>，能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131919162.png\" style=\"zoom:33%;\"></p>\n<h5 id=\"演示步骤：\"><a href=\"#演示步骤：\" class=\"headerlink\" title=\"演示步骤：\"></a>演示步骤：</h5><h6 id=\"1、重启6379-6380-6381\"><a href=\"#1、重启6379-6380-6381\" class=\"headerlink\" title=\"1、重启6379 6380 6381\"></a>1、重启6379 6380 6381</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131920769.png\" alt=\"image-20230313103911488\" style=\"zoom:53%;\"></p>\n<h6 id=\"2、设置6379-为主机，6380和-6381-为从机\"><a href=\"#2、设置6379-为主机，6380和-6381-为从机\" class=\"headerlink\" title=\"2、设置6379 为主机，6380和 6381 为从机\"></a>2、设置6379 为主机，6380和 6381 为从机</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131039109.png\" alt=\"image-20230313103946047\" style=\"zoom:53%;\"></p>\n<h6 id=\"3、自定义的myredis目录下新建sentinel-conf文件，名字绝不能错\"><a href=\"#3、自定义的myredis目录下新建sentinel-conf文件，名字绝不能错\" class=\"headerlink\" title=\"3、自定义的myredis目录下新建sentinel.conf文件，名字绝不能错\"></a>3、自定义的myredis目录下新建sentinel.conf文件，名字绝不能错</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131040736.png\" alt=\"image-20230313104034688\" style=\"zoom:53%;\"></p>\n<blockquote>\n<p>配置哨兵，在新建的文件中填写下面一行内容</p>\n<p><code>sentinel monitor mymaster 127.0.0.1 6379 1</code></p>\n<p>其中mymaster为监控对象起的服务器名称， 1 为至少有多少个哨兵同意迁移的数量。</p>\n</blockquote>\n<h6 id=\"4、执行\"><a href=\"#4、执行\" class=\"headerlink\" title=\"4、执行\"></a>4、执行</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131042602.png\" alt=\"image-20230313104227536\" style=\"zoom:47%;\"></p>\n<h6 id=\"5、结果会显示\"><a href=\"#5、结果会显示\" class=\"headerlink\" title=\"5、结果会显示\"></a>5、结果会显示<26379在java代码中有体现></26379在java代码中有体现></h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131043521.png\" alt=\"image-20230313104325472\" style=\"zoom:37%;\"></p>\n<h6 id=\"7、此时让主机6379挂掉\"><a href=\"#7、此时让主机6379挂掉\" class=\"headerlink\" title=\"7、此时让主机6379挂掉\"></a>7、此时让主机6379挂掉</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131044681.png\" alt=\"image-20230313104409611\" style=\"zoom:57%;\"></p>\n<h6 id=\"8、从机就会显示\"><a href=\"#8、从机就会显示\" class=\"headerlink\" title=\"8、从机就会显示\"></a>8、从机就会显示</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131045322.png\" alt=\"image-20230313104507272\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131920128.png\" alt=\"image-20230313104614977\" style=\"zoom:33%;\"></p>\n<h6 id=\"9、此时，主机6379即使重启也变为从机了\"><a href=\"#9、此时，主机6379即使重启也变为从机了\" class=\"headerlink\" title=\"9、此时，主机6379即使重启也变为从机了\"></a>9、此时，主机6379即使重启也变为从机了</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131047232.png\" alt=\"image-20230313104741175\" style=\"zoom:33%;\"></p>\n<h6 id=\"10、查看此时的6380状态，已然变为主机了\"><a href=\"#10、查看此时的6380状态，已然变为主机了\" class=\"headerlink\" title=\"10、查看此时的6380状态，已然变为主机了\"></a>10、查看此时的6380状态，已然变为主机了</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131920127.png\" alt=\"image-20230313104839167\"></p>\n<h6 id=\"11、重启6379-，变为6380的从机了\"><a href=\"#11、重启6379-，变为6380的从机了\" class=\"headerlink\" title=\"11、重启6379 ，变为6380的从机了\"></a>11、重启6379 ，变为6380的从机了</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131049672.png\" alt=\"image-20230313104914615\"></p>\n<h6 id=\"12、此时6380显示有两个从机\"><a href=\"#12、此时6380显示有两个从机\" class=\"headerlink\" title=\"12、此时6380显示有两个从机\"></a>12、此时6380显示有两个从机</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131049616.png\" alt=\"image-20230313104936555\"></p>\n<h6 id=\"ps-上述10的原因：\"><a href=\"#ps-上述10的原因：\" class=\"headerlink\" title=\"ps:上述10的原因：\"></a>ps:上述10的原因：</h6><p>当主机挂掉，从机选举产生新的主机,但是哪个<code>从机</code>会被选举为主机呢?会根据三种方案进行判断,==祥见故障恢复== 。</p>\n<h4 id=\"复制原理：\"><a href=\"#复制原理：\" class=\"headerlink\" title=\"复制原理：\"></a>复制原理：</h4><ul>\n<li><p>Slave 启动成功连接到 master 后会发送一个 sync 命令；</p>\n</li>\n<li><p>Master 接到命令启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，master 将传送整个数据文件到 slave，以完成一次完全同步。</p>\n</li>\n<li><p>全量复制：slave 服务器在接收到数据库文件数据后，将其存盘并加载到内存中。</p>\n</li>\n<li><p>增量复制：Master 继续将新的所有收集到的修改命令依次传给 slave，完成同步。</p>\n</li>\n<li><p>但是只要是重新连接 master，一次完全同步（全量复制) 将被自动执行。</p>\n</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131902479.png\" alt=\"image-20230313190215397\" style=\"zoom:33%;\"></p>\n<h6 id=\"主从复制原理：\"><a href=\"#主从复制原理：\" class=\"headerlink\" title=\"主从复制原理：\"></a>主从复制原理：</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131904688.png\" alt=\"03-主从复制原理\" style=\"zoom:35%;\"></p>\n<h3 id=\"复制延时\"><a href=\"#复制延时\" class=\"headerlink\" title=\"复制延时\"></a>复制延时</h3><p>由于所有的写操作都是先在 Master 上操作，然后同步更新到 Slave 上，所以从 Master 同步到 Slave 机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave 机器数量的增加也会使这个问题更加严重。</p>\n<h3 id=\"故障恢复\"><a href=\"#故障恢复\" class=\"headerlink\" title=\"故障恢复\"></a>故障恢复</h3><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131932784.png\" alt=\"image-20230313193204680\" style=\"zoom:33%;\"></p>\n<h6 id=\"优先级：在-redis-conf-中默认-slave-priority-100，值越小优先级越高。\"><a href=\"#优先级：在-redis-conf-中默认-slave-priority-100，值越小优先级越高。\" class=\"headerlink\" title=\"优先级：在 redis.conf 中默认 slave-priority 100，值越小优先级越高。\"></a>优先级：在 redis.conf 中默认 slave-priority 100，值越小优先级越高。</h6><ul>\n<li>其中<code>优先级</code>显示&lt;可以设置&gt;：</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131053258.png\" alt=\"image-20230313105311197\" style=\"zoom:33%;\"></p>\n<h6 id=\"偏移量：指获得原主机数据最全的概率。\"><a href=\"#偏移量：指获得原主机数据最全的概率。\" class=\"headerlink\" title=\"偏移量：指获得原主机数据最全的概率。\"></a>偏移量：指获得原主机数据最全的概率。</h6><h6 id=\"runid：每个-redis-实例启动后都会随机生成一个-40-位的-runid。\"><a href=\"#runid：每个-redis-实例启动后都会随机生成一个-40-位的-runid。\" class=\"headerlink\" title=\"runid：每个 redis 实例启动后都会随机生成一个 40 位的 runid。\"></a>runid：每个 redis 实例启动后都会随机生成一个 40 位的 runid。</h6><h3 id=\"主从复制哨兵模式的代码实现：\"><a href=\"#主从复制哨兵模式的代码实现：\" class=\"headerlink\" title=\"主从复制哨兵模式的代码实现：\"></a>主从复制哨兵模式的代码实现：</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> JedisSentinelPool jedisSentinelPool=<span class=\"literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span>  Jedis <span class=\"title function_\">getJedisFromSentinel</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(jedisSentinelPool==<span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">            Set&lt;String&gt; sentinelSet=<span class=\"keyword\">new</span> <span class=\"title class_\">HashSet</span>&lt;&gt;();</span><br><span class=\"line\">            sentinelSet.add(<span class=\"string\">&quot;192.168.10.33:26379&quot;</span>); </span><br><span class=\"line\">            <span class=\"type\">JedisPoolConfig</span> <span class=\"variable\">jedisPoolConfig</span> <span class=\"operator\">=</span><span class=\"keyword\">new</span> <span class=\"title class_\">JedisPoolConfig</span>();</span><br><span class=\"line\">            jedisPoolConfig.setMaxTotal(<span class=\"number\">10</span>); <span class=\"comment\">//最大可用连接数</span></span><br><span class=\"line\">            jedisPoolConfig.setMaxIdle(<span class=\"number\">5</span>); <span class=\"comment\">//最大闲置连接数</span></span><br><span class=\"line\">            jedisPoolConfig.setMinIdle(<span class=\"number\">5</span>); <span class=\"comment\">//最小闲置连接数</span></span><br><span class=\"line\">            jedisPoolConfig.setBlockWhenExhausted(<span class=\"literal\">true</span>); <span class=\"comment\">//连接耗尽是否等待</span></span><br><span class=\"line\">            jedisPoolConfig.setMaxWaitMillis(<span class=\"number\">2000</span>); <span class=\"comment\">//等待时间</span></span><br><span class=\"line\">            jedisPoolConfig.setTestOnBorrow(<span class=\"literal\">true</span>); <span class=\"comment\">//取连接的时候进行一下测试 ping pong</span></span><br><span class=\"line\">\t\t\tjedisSentinelPool=\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"keyword\">new</span> <span class=\"title class_\">JedisSentinelPool</span>(<span class=\"string\">&quot;mymaster&quot;</span>,sentinelSet,jedisPoolConfig);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> jedisSentinelPool.getResource();</span><br><span class=\"line\">       \t&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> jedisSentinelPool.getResource();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Redis-集群（cluster-模式）\"><a href=\"#Redis-集群（cluster-模式）\" class=\"headerlink\" title=\"Redis 集群（cluster 模式）\"></a>Redis 集群（cluster 模式）</h2><h4 id=\"概念\"><a href=\"#概念\" class=\"headerlink\" title=\"概念\"></a>概念</h4><ul>\n<li><p>Redis 集群（包括很多小集群）实现了对 Redis 的水平扩容，即启动 N 个 redis 节点，将整个数据库分布存储在这 N 个节点中，每个节点存储总数据的 1/N，即一个小集群存储 1/N 的数据，每个小集群里面维护好自己的 1/N 的数据。</p>\n</li>\n<li><p>Redis 集群通过分区（partition）来提供一定程度的可用性（availability）： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。</p>\n</li>\n<li><p>该模式的 redis 集群特点是：分治、分片。</p>\n</li>\n</ul>\n<h4 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h4><ul>\n<li><p>容量不够，redis 如何进行扩容？</p>\n</li>\n<li><p>并发写操作， redis 如何分摊？</p>\n</li>\n<li><p>另外，主从模式，薪火相传模式，主机宕机，导致 ip 地址发生变化，应用程序中配置需要修改对应的主机地址、端口等信息。</p>\n</li>\n<li><p>之前通过代理主机来解决，但是 redis3.0 中提供了解决方案。就是<code>无中心化集群配置</code>。</p>\n<ul>\n<li><p>代理主机：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131941895.png\" alt=\"image-20230313110010196\" style=\"zoom:23%;\"></p>\n</li>\n<li><p>无中心化集群配置：</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131942746.png\" alt=\"image-20230313113053552\" style=\"zoom:33%;\"></p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"操作演示\"><a href=\"#操作演示\" class=\"headerlink\" title=\"操作演示:\"></a>操作演示:</h4><h6 id=\"1、删除持久化数据\"><a href=\"#1、删除持久化数据\" class=\"headerlink\" title=\"1、删除持久化数据\"></a>1、删除持久化数据</h6><blockquote>\n<p>将rdb,aof文件都删除掉。</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131950844.png\" style=\"zoom:23%;\"></p>\n<h6 id=\"2、制作6个实例，6379-6380-6381-6389-6390-6391\"><a href=\"#2、制作6个实例，6379-6380-6381-6389-6390-6391\" class=\"headerlink\" title=\"2、制作6个实例，6379,6380,6381,6389,6390,6391\"></a>2、制作6个实例，6379,6380,6381,6389,6390,6391</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131950409.png\" alt=\"image-20230313195031362\" style=\"zoom:23%;\"></p>\n<h6 id=\"3、使上面六个文件配置基本信息包含\"><a href=\"#3、使上面六个文件配置基本信息包含\" class=\"headerlink\" title=\"3、使上面六个文件配置基本信息包含\"></a>3、使上面六个文件配置基本信息包含</h6><blockquote>\n<ul>\n<li>开启daemonize yes</li>\n<li>Pid文件名字</li>\n<li>指定端口</li>\n<li>Log文件名字</li>\n<li>Dump.rdb名字</li>\n<li>Appendonly 关掉或者换名字</li>\n</ul>\n</blockquote>\n<h6 id=\"4、对redis-cluster配置进行修改\"><a href=\"#4、对redis-cluster配置进行修改\" class=\"headerlink\" title=\"4、对redis cluster配置进行修改\"></a>4、对redis cluster配置进行修改</h6><blockquote>\n<p><code>cluster-enabled yes</code>   打开集群模式<br><code>cluster-config-file nodes-6379.conf</code>  设定节点配置文件名<br><code>cluster-node-timeout 15000</code>  设定节点失联时间，超过该时间（毫秒），集群自动进行主从切换。</p>\n</blockquote>\n<p>即：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">include /home/bigdata/redis.conf</span><br><span class=\"line\">port 6379</span><br><span class=\"line\">pidfile &quot;/var/run/redis_6379.pid&quot;</span><br><span class=\"line\">dbfilename &quot;dump6379.rdb&quot;</span><br><span class=\"line\">dir &quot;/home/bigdata/redis_cluster&quot;</span><br><span class=\"line\">logfile &quot;/home/bigdata/redis_cluster/redis_err_6379.log&quot;</span><br><span class=\"line\">cluster-enabled yes</span><br><span class=\"line\">cluster-config-file nodes-6379.conf</span><br><span class=\"line\">cluster-node-timeout 15000</span><br></pre></td></tr></table></figure>\n<h6 id=\"5、对其他文件进行微调\"><a href=\"#5、对其他文件进行微调\" class=\"headerlink\" title=\"5、对其他文件进行微调\"></a>5、对其他文件进行微调</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131951145.png\" alt=\"image-20230313195127105\" style=\"zoom:23%;\"></p>\n<h6 id=\"6、启动6个redis服务\"><a href=\"#6、启动6个redis服务\" class=\"headerlink\" title=\"6、启动6个redis服务\"></a>6、启动6个redis服务</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131955076.png\" alt=\"image-20230313195541039\" style=\"zoom:23%;\"></p>\n<h6 id=\"7、确保所有redis实例启动后，nodes-xxxx-conf文件都生成正常。\"><a href=\"#7、确保所有redis实例启动后，nodes-xxxx-conf文件都生成正常。\" class=\"headerlink\" title=\"7、确保所有redis实例启动后，nodes-xxxx.conf文件都生成正常。\"></a>7、确保所有redis实例启动后，nodes-xxxx.conf文件都生成正常。</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131956373.png\" alt=\"image-20230313195608333\" style=\"zoom:33%;\"></p>\n<h6 id=\"8、将六个节点合成一个集群，合体\"><a href=\"#8、将六个节点合成一个集群，合体\" class=\"headerlink\" title=\"8、将六个节点合成一个集群，合体\"></a>8、将六个节点合成一个集群，合体</h6><p><code>cd  /opt/redis-6.2.1/src</code></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131957558.png\" alt=\"image-20230313114422313\"></p>\n<blockquote>\n<p>此处不要用127.0.0.1， 请用真实IP地址</p>\n<p>—replicas 1 采用最简单的方式配置集群，一台主机，一台从机，正好三组。</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131957814.png\" alt=\"image-20230313195758772\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131958497.png\" alt=\"image-20230313195805458\" style=\"zoom:13%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131958920.png\" alt=\"image-20230313195818881\" style=\"zoom:15%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131958701.png\" alt=\"image-20230313195828662\" style=\"zoom:15%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132154509.png\" alt=\"image-20230313215447456\" style=\"zoom:25%;\"></p>\n<h6 id=\"9、通过-cluster-nodes-命令查看集群信息\"><a href=\"#9、通过-cluster-nodes-命令查看集群信息\" class=\"headerlink\" title=\"9、通过 cluster nodes 命令查看集群信息\"></a>9、通过 cluster nodes 命令查看集群信息</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132001073.png\" alt=\"image-20230313200157033\" style=\"zoom:33%;\"></p>\n<h4 id=\"集群连接方式\"><a href=\"#集群连接方式\" class=\"headerlink\" title=\"集群连接方式\"></a>集群连接方式</h4><h5 id=\"普通方式登录：\"><a href=\"#普通方式登录：\" class=\"headerlink\" title=\"普通方式登录：\"></a>普通方式登录：</h5><h6 id=\"弊端：\"><a href=\"#弊端：\" class=\"headerlink\" title=\"弊端：\"></a>弊端：</h6><blockquote>\n<p>可能直接进入，读主机，存储数据时，会出现 MOVED 重定向操作，所以，应该以集群方式登录。</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131944252.png\" alt=\"image-20230313194430210\" style=\"zoom:33%;\"></p>\n<h5 id=\"集群登录\"><a href=\"#集群登录\" class=\"headerlink\" title=\"集群登录:\"></a>集群登录:</h5><h6 id=\"方式：\"><a href=\"#方式：\" class=\"headerlink\" title=\"方式：\"></a>方式：</h6><p><code>redis-cli -c -p 6379</code> 采用集群策略连接，设置数据会自动切换到相应的写主机.</p>\n<h5 id=\"redis-cluster-如何分配这六个节点？\"><a href=\"#redis-cluster-如何分配这六个节点？\" class=\"headerlink\" title=\"redis cluster 如何分配这六个节点？\"></a>redis cluster 如何分配这六个节点？</h5><ul>\n<li>首先确保：一个集群至少要有三个主节点。</li>\n<li>选项 –cluster-replicas 1 ：表示我们希望为集群中的每个主节点创建一个从节点。</li>\n<li>分配原则尽量保证每个主数据库运行在不同的 IP 地址，每个从库和主库不在一个 IP 地址上。</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132002108.png\" alt=\"image-20230313200239055\" style=\"zoom:23%;\"></p>\n<h6 id=\"参数解析\"><a href=\"#参数解析\" class=\"headerlink\" title=\"参数解析\"></a>参数解析</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131947234.png\" alt=\"image-20230313114422313\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131959874.png\" alt=\"image-20230313195926836\" style=\"zoom:23%;\"></p>\n<h4 id=\"什么是-slots\"><a href=\"#什么是-slots\" class=\"headerlink\" title=\"什么是 slots\"></a>什么是 slots</h4><ul>\n<li>一个 Redis 集群包含 16384 个插槽（hash slot），数据库中的每个键都属于这 16384 个插槽的其中一个。集群使用公式 CRC16 (key) % 16384 来计算键 key 属于哪个槽， 其中 CRC16 (key) 语句用于计算键 key 的 CRC16 校验和 。</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131959252.png\" alt=\"image-20230313195935209\" style=\"zoom:43%;\"></p>\n<ul>\n<li>集群中的每个节点负责处理一部分插槽。 举个例子， 如果一个集群可以有主节点， 其中：</li>\n</ul>\n<blockquote>\n<p>节点 A 负责处理 0 号至 5460 号插槽。<br>节点 B 负责处理 5461 号至 10922 号插槽。<br>节点 C 负责处理 10923 号至 16383 号插槽。</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132003346.png\" alt=\"image-20230313200307262\" style=\"zoom:15%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132004444.png\" alt=\"image-20230313200415410\" style=\"zoom:15%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132004980.png\" alt=\"image-20230313200422936\" style=\"zoom:15%;\"></p>\n<blockquote>\n<p>例如：下面的会直接切换到6381</p>\n</blockquote>\n<p> <img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132004570.jpg\" style=\"zoom:25%;\"></p>\n<h4 id=\"在集群中录入值\"><a href=\"#在集群中录入值\" class=\"headerlink\" title=\"在集群中录入值\"></a>在集群中录入值</h4><p>在 redis-cli 每次录入、查询键值，redis 都会计算出该 key 应该送往的插槽，如果不是该客户端对应服务器的插槽，redis 会报错，并告知应前往的 <code>redis 实例地址和端口</code>。</p>\n<p>redis-cli 客户端提供了 –c 参数实现自动重定向。如 redis-cli -c –p 6379 登入后，再录入、查询键值对可以自动重定向。不在一个 slot 下的键值，是不能使用 mget,mset 等多键操作。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132006205.png\" alt=\"image-20230313200613077\" style=\"zoom:33%;\"></p>\n<p>可以通过{}来定义组的概念，从而使key中{}内相同内容的键值对放到一个slot中去。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132006012.jpg\" alt=\"img\" style=\"zoom:33%;\"> </p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132006016.png\" alt=\"img\" style=\"zoom: 54%;\"></p>\n<h4 id=\"查询集群中的值\"><a href=\"#查询集群中的值\" class=\"headerlink\" title=\"查询集群中的值\"></a>查询集群中的值</h4><p><code>CLUSTER GETKEYSINSLOT &lt;slot&gt;&lt;count&gt;</code> 返回 count 个 slot 槽中的键。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132007482.png\" alt=\"image-20230313200755441\" style=\"zoom:20%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132008282.png\" alt=\"image-20230313200808200\" style=\"zoom:20%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132008634.png\" alt=\"image-20230313200820584\" style=\"zoom:20%;\"></p>\n<h4 id=\"故障恢复-1\"><a href=\"#故障恢复-1\" class=\"headerlink\" title=\"故障恢复\"></a>故障恢复</h4><ul>\n<li><p>如果主节点下线？从节点能否自动升为主节点？    注意：15 秒超时</p>\n</li>\n<li><p>主节点恢复后，主从关系会如何？     主节点回来变成从机。</p>\n</li>\n<li><p>如果所有某一段插槽的主从节点都宕掉，redis 服务是否还能继续？</p>\n<ul>\n<li><p>如果某一段插槽的主从都挂掉，而 cluster-require-full-coverage 为 yes ，那么整个集群都挂掉。</p>\n</li>\n<li><p>如果某一段插槽的主从都挂掉，而 cluster-require-full-coverage 为 no ，那么，该插槽数据全都不能使用，也无法存储。</p>\n</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"操作演示：\"><a href=\"#操作演示：\" class=\"headerlink\" title=\"操作演示：\"></a>操作演示：</h5><h6 id=\"挂掉6379，-开启6380-时的状态\"><a href=\"#挂掉6379，-开启6380-时的状态\" class=\"headerlink\" title=\"挂掉6379， 开启6380 时的状态\"></a>挂掉6379， 开启6380 时的状态</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132008160.jpg\" alt=\"img\" style=\"zoom:20%;\"></p>\n<h6 id=\"可以看到挂79-89就升为主机\"><a href=\"#可以看到挂79-89就升为主机\" class=\"headerlink\" title=\"可以看到挂79 89就升为主机\"></a>可以看到挂79 89就升为主机</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132010306.png\" alt=\"image-20230313201015181\" style=\"zoom:20%;\"></p>\n<h6 id=\"重启6379，\"><a href=\"#重启6379，\" class=\"headerlink\" title=\"重启6379，\"></a>重启6379，</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132008162.jpg\" alt=\"img\" style=\"zoom:20%;\"></p>\n<h6 id=\"此时6379就变为从机了\"><a href=\"#此时6379就变为从机了\" class=\"headerlink\" title=\"此时6379就变为从机了\"></a>此时6379就变为从机了</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132010644.png\" alt=\"image-20230313201011521\" style=\"zoom:20%;\"></p>\n<h4 id=\"Jedis集群开发\"><a href=\"#Jedis集群开发\" class=\"headerlink\" title=\"Jedis集群开发\"></a>Jedis集群开发</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 演示redis集群操作</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RedisClusterDemo</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//创建对象</span></span><br><span class=\"line\">        <span class=\"type\">HostAndPort</span> <span class=\"variable\">hostAndPort</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">HostAndPort</span>(<span class=\"string\">&quot;192.168.10.33&quot;</span>, <span class=\"number\">6379</span>);   <span class=\"comment\">// 等价于在终端的操作: redis-cli  -c –p 6379 </span></span><br><span class=\"line\">        <span class=\"type\">JedisCluster</span> <span class=\"variable\">jedisCluster</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JedisCluster</span>(hostAndPort);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//进行操作</span></span><br><span class=\"line\">        jedisCluster.set(<span class=\"string\">&quot;b1&quot;</span>,<span class=\"string\">&quot;value1&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> jedisCluster.get(<span class=\"string\">&quot;b1&quot;</span>);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;value: &quot;</span>+value);</span><br><span class=\"line\"></span><br><span class=\"line\">        jedisCluster.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"Redis-集群优点\"><a href=\"#Redis-集群优点\" class=\"headerlink\" title=\"Redis 集群优点\"></a>Redis 集群优点</h4><ul>\n<li><p>实现扩容</p>\n</li>\n<li><p>分摊压力</p>\n</li>\n<li><p>无中心配置相对简单</p>\n</li>\n</ul>\n<h4 id=\"Redis-集群不足\"><a href=\"#Redis-集群不足\" class=\"headerlink\" title=\"Redis 集群不足\"></a>Redis 集群不足</h4><ul>\n<li><p>多键操作是不被支持的,加上组的多键操作是复杂的</p>\n</li>\n<li><p>多键的 Redis 事务是不被支持的，lua 脚本不被支持。</p>\n</li>\n<li><p>由于集群方案出现较晚，很多公司已经采用了其他的集群方案，而代理或者客户端分片的方案想要迁移至 redis cluster，需要整体迁移而不是逐步过渡，复杂度较大。</p>\n</li>\n</ul>\n<h2 id=\"Redis-应用问题解决\"><a href=\"#Redis-应用问题解决\" class=\"headerlink\" title=\"Redis 应用问题解决\"></a>Redis 应用问题解决</h2><h3 id=\"缓存穿透\"><a href=\"#缓存穿透\" class=\"headerlink\" title=\"缓存穿透\"></a>缓存穿透</h3><h4 id=\"问题描述\"><a href=\"#问题描述\" class=\"headerlink\" title=\"问题描述\"></a>问题描述</h4><p>key 对应的数据在数据源并不存在，每次针对此 key 的请求从缓存获取不到，请求都会压到数据源（数据库），从而可能压垮数据源。比如用一个不存在的用户 id 获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132053077.png\" style=\"zoom:33%;\"></p>\n<h5 id=\"缓存穿透发生的现象：\"><a href=\"#缓存穿透发生的现象：\" class=\"headerlink\" title=\"缓存穿透发生的现象：\"></a>缓存穿透发生的现象：</h5><ul>\n<li><p>应用服务器压力变大</p>\n</li>\n<li><p>redis 命中率降低</p>\n</li>\n<li><p>一直查询数据库，使得数据库压力太大而压垮</p>\n<p>其实 redis 在这个过程中一直平稳运行，崩溃的是我们的数据库（如 MySQL）。</p>\n</li>\n</ul>\n<h5 id=\"缓存穿透发生的原因：\"><a href=\"#缓存穿透发生的原因：\" class=\"headerlink\" title=\"缓存穿透发生的原因：\"></a>缓存穿透发生的原因：</h5><ul>\n<li>黑客或者其他非正常用户频繁进行很多非正常的 url 访问，使得 redis 查询不到数据库。</li>\n</ul>\n<h4 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h4><ul>\n<li><p>对空值缓存：如果一个查询返回的数据为空（不管是数据是否不存在），我们仍然把这个空结果（null）进行缓存，设置空结果的过期时间会很短，最长不超过五分钟。</p>\n</li>\n<li><p>设置可访问的名单（白名单）：使用 bitmaps 类型定义一个可以访问的名单，名单 id 作为 bitmaps 的偏移量，每次访问和 bitmap 里面的 id 进行比较，如果访问 id 不在 bitmaps 里面，进行拦截，不允许访问。</p>\n</li>\n<li><p>采用布隆过滤器：布隆过滤器（Bloom Filter）是 1970 年由布隆提出的。它实际上是一个很长的二进制向量 (位图) 和一系列随机映射函数（哈希函数）。布隆过滤器可以用于检索一个元素是否在一个集合中。它的优点是空间效率和查询时间都远远超过一般的算法，缺点是有一定的误识别率和删除困难。</p>\n</li>\n<li><p>进行实时监控：当发现 Redis 的命中率开始急速降低，需要排查访问对象和访问的数据，和运维人员配合，可以设置黑名单限制服务。</p>\n</li>\n</ul>\n<h3 id=\"缓存击穿\"><a href=\"#缓存击穿\" class=\"headerlink\" title=\"缓存击穿\"></a>缓存击穿</h3><h4 id=\"问题描述-1\"><a href=\"#问题描述-1\" class=\"headerlink\" title=\"问题描述\"></a>问题描述</h4><p>key 对应的数据存在，但在 redis 中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端数据库加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端数据库压垮。</p>\n<h5 id=\"缓存击穿的现象：\"><a href=\"#缓存击穿的现象：\" class=\"headerlink\" title=\"缓存击穿的现象：\"></a>缓存击穿的现象：</h5><ul>\n<li>数据库访问压力瞬时增加，数据库崩溃</li>\n<li>redis 里面没有出现大量 key 过期</li>\n<li>redis 正常运行</li>\n</ul>\n<h5 id=\"缓存击穿发生的原因：\"><a href=\"#缓存击穿发生的原因：\" class=\"headerlink\" title=\"缓存击穿发生的原因：\"></a>缓存击穿发生的原因：</h5><ul>\n<li>redis 某个 key 过期了，大量访问使用这个 key（热门 key）。</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132057382.png\" alt=\"image-20230313205707206\" style=\"zoom:23%;\"></p>\n<h4 id=\"解决方案-1\"><a href=\"#解决方案-1\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h4><p>key 可能会在某些时间点被超高并发地访问，是一种非常 “热点” 的数据。</p>\n<ul>\n<li><p>预先设置热门数据：在 redis 高峰访问之前，把一些热门数据提前存入到 redis 里面，加大这些热门数据 key 的时长。</p>\n</li>\n<li><p>实时调整：现场监控哪些数据热门，实时调整 key 的过期时长。</p>\n</li>\n<li><p>使用锁：</p>\n<ul>\n<li>就是在缓存失效的时候（判断拿出来的值为空），不是立即去 load db。</li>\n<li>先使用缓存工具的某些带成功操作返回值的操作（比如 Redis 的 SETNX）去 set 一个 mutex key。</li>\n<li>当操作返回成功时，再进行 load db 的操作，并回设缓存，最后删除 mutex key；</li>\n<li>当操作返回失败，证明有线程在 load db，当前线程睡眠一段时间再重试整个 get 缓存的方法。</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132058113.png\" alt=\"image-20230313205848071\" style=\"zoom:33%;\"></p>\n<h3 id=\"缓存雪崩\"><a href=\"#缓存雪崩\" class=\"headerlink\" title=\"缓存雪崩\"></a>缓存雪崩</h3><h4 id=\"问题描述-2\"><a href=\"#问题描述-2\" class=\"headerlink\" title=\"问题描述\"></a>问题描述</h4><p>key 对应的数据存在，但在 redis 中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端数据库加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端数据库压垮。</p>\n<p>缓存雪崩与缓存击穿的区别在于这里针对很多 key 缓存，前者则是某一个 key 正常访问。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132059071.png\" alt=\"image-20230313205930931\" style=\"zoom:33%;\"></p>\n<h6 id=\"缓存失效瞬间：\"><a href=\"#缓存失效瞬间：\" class=\"headerlink\" title=\"缓存失效瞬间：\"></a>缓存失效瞬间：</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132059434.png\" style=\"zoom:18%;\"></p>\n<h4 id=\"解决方案-2\"><a href=\"#解决方案-2\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h4><ul>\n<li><p>构建多级缓存架构：nginx 缓存 + redis 缓存 + 其他缓存（ehcache 等）。</p>\n</li>\n<li><p>使用锁或队列：用加锁或者队列的方式来保证不会有大量的线程对数据库一次性进行读写，从而避免失效时大量的并发请求落到底层存储系统上，该方法不适用高并发情况。</p>\n</li>\n<li><p>设置过期标志更新缓存：记录缓存数据是否过期（设置提前量），如果过期会触发通知另外的线程在后台去更新实际 key 的缓存。</p>\n</li>\n<li><p>将缓存失效时间分散开：比如可以在原有的失效时间基础上增加一个随机值，比如 1-5 分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。</p>\n</li>\n</ul>\n<h3 id=\"分布式锁\"><a href=\"#分布式锁\" class=\"headerlink\" title=\"分布式锁\"></a>分布式锁</h3><h4 id=\"问题描述-3\"><a href=\"#问题描述-3\" class=\"headerlink\" title=\"问题描述\"></a>问题描述</h4><p>随着业务发展的需要，原单体单机部署的系统被演化成分布式集群系统后，由于分布式系统多线程的特点以及分布在不同机器上，这将使原单机部署情况下的并发控制锁策略失效，单纯的 Java API 并不能提供分布式锁的能力。为了解决这个问题就需要一种跨 JVM 的互斥机制来控制共享资源的访问，这就是分布式锁要解决的问题！</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132101879.png\" alt=\"image-20230313210129825\" style=\"zoom:23%;\"></p>\n<h6 id=\"分布式锁主流的实现方案：\"><a href=\"#分布式锁主流的实现方案：\" class=\"headerlink\" title=\"分布式锁主流的实现方案：\"></a>分布式锁主流的实现方案：</h6><ul>\n<li><p>基于数据库实现分布式锁</p>\n</li>\n<li><p>基于缓存（Redis 等）</p>\n</li>\n<li><p>基于 Zookeeper</p>\n</li>\n</ul>\n<h6 id=\"分类\"><a href=\"#分类\" class=\"headerlink\" title=\"分类\"></a>分类</h6><p>根据实现方式，分布式锁还可以分为<code>类 CAS 自旋式分布式锁</code>以及 <code>event 事件类型分布式锁</code>：</p>\n<p>类 CAS 自旋式分布式锁：询问的方式，类似 java 并发编程中的线程获询问的方式尝试加锁，如 mysql、redis。<br>另外一类是 event 事件通知进程后续锁的变化，轮询向外的过程，如 zookeeper、etcd。</p>\n<h6 id=\"每一种分布式锁解决方案都有各自的优缺点：\"><a href=\"#每一种分布式锁解决方案都有各自的优缺点：\" class=\"headerlink\" title=\"每一种分布式锁解决方案都有各自的优缺点：\"></a>每一种分布式锁解决方案都有各自的优缺点：</h6><p><strong>性能</strong>：redis 最高</p>\n<p><strong>可靠性</strong>：zookeeper 最高</p>\n<p><strong>解决方案</strong>：使用 redis 实现分布式锁</p>\n<p>==setnx==</p>\n<p>setnx：通过该命令尝试获得锁，没有获得锁的线程会不断等待尝试。</p>\n<p>set key ex 3000nx：设置过期时间，自动释放锁，解决当某一个业务异常而导致锁无法释放的问题。但是当业务运行超过过期时间时，开辟监控线程增加该业务的运行时间，直到运行结束，释放锁。</p>\n<p>uuid：设置 uuid，释放前获取这个值，判断是否自己的锁，防止误删锁，造成没锁的情况。</p>\n<p>==RedLock==<br>Redlock 是一种算法，Redlock 也就是 Redis Distributed Lock，可用实现多节点 redis 的分布式锁。RedLock 官方推荐，Redisson 完成了对 Redlock 算法封装。</p>\n<p>此种方式具有以下特性：</p>\n<ul>\n<li>互斥访问：即永远只有一个 client 能拿到锁。</li>\n<li>避免死锁：最终 client 都可能拿到锁，不会出现死锁的情况，即使锁定资源的服务崩溃或者分区，仍然能释放锁。</li>\n<li>容错性：只要大部分 Redis 节点存活（一半以上），就可以正常提供服务<br>==RedLock 原理（了解)==</li>\n</ul>\n<p>获取当前 Unix 时间，以毫秒为单位。<br>依次尝试从 N 个实例，使用相同的 key 和随机值获取锁。在步骤 2，当向 Redis 设置锁时，客户端应该设置一个网络连接和响应超时时间，这个超时时间应该小于锁的失效时间。例如你的锁自动失效时间为 10 秒，则超时时间应该在 5-50 毫秒之间。这样可以避免服务器端 Redis 已经挂掉的情况下，客户端还在死死地等待响应结果。如果服务器端没有在规定时间内响应，客户端应该尽快尝试另外一个 Redis 实例。<br>客户端使用当前时间减去开始获取锁时间（步骤 1 记录的时间）就得到获取锁使用的时间。当且仅当从大多数（这里是 3 个节点）的 Redis 节点都取到锁，并且使用的时间小于锁失效时间时，锁才算获取成功。<br>如果取到了锁，key 的真正有效时间等于有效时间减去获取锁所使用的时间（步骤 3 计算的结果）。<br>如果因为某些原因，获取锁失败（没有在至少 N/2+1 个 Redis 实例取到锁或者取锁时间已经超过了有效时间），客户端应该在所有的 Redis 实例上进行解锁（即便某些 Redis 实例根本就没有加锁成功）。</p>\n<h4 id=\"使用redis实现分布式锁\"><a href=\"#使用redis实现分布式锁\" class=\"headerlink\" title=\"使用redis实现分布式锁\"></a>使用redis实现分布式锁</h4><h5 id=\"1、使用setnx上锁，通过del释放锁\"><a href=\"#1、使用setnx上锁，通过del释放锁\" class=\"headerlink\" title=\"1、使用setnx上锁，通过del释放锁\"></a>1、使用setnx上锁，通过del释放锁</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132121540.png\" alt=\"image-20230313212108477\" style=\"zoom:20%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132121771.png\" alt=\"image-20230313212119699\" style=\"zoom:20%;\"></p>\n<h5 id=\"2、锁一直没有释放，设置key过期时间，自动释放-lt-非原子操作-gt\"><a href=\"#2、锁一直没有释放，设置key过期时间，自动释放-lt-非原子操作-gt\" class=\"headerlink\" title=\"2、锁一直没有释放，设置key过期时间，自动释放&lt;非原子操作&gt;\"></a>2、锁一直没有释放，设置key过期时间，自动释放&lt;非原子操作&gt;</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132155362.png\" alt=\"image-20230313215512311\" style=\"zoom:33%;\"></p>\n<h5 id=\"3、上锁时候同时设置过期时间就可以-lt-原子操作-gt\"><a href=\"#3、上锁时候同时设置过期时间就可以-lt-原子操作-gt\" class=\"headerlink\" title=\"3、上锁时候同时设置过期时间就可以&lt;原子操作&gt;\"></a>3、上锁时候同时设置过期时间就可以&lt;原子操作&gt;</h5><p>背景：上锁之后突然出现异常，无法设置过期时间了</p>\n<p>set  users 10 nx ex 12</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132125532.png\" alt=\"image-20230313212502492\" style=\"zoom:23%;\"></p>\n<h4 id=\"代码实现redis\"><a href=\"#代码实现redis\" class=\"headerlink\" title=\"代码实现redis\"></a>代码实现redis</h4><h5 id=\"分布式锁-实现1、使用setnx上锁，通过del释放锁\"><a href=\"#分布式锁-实现1、使用setnx上锁，通过del释放锁\" class=\"headerlink\" title=\"分布式锁 实现1、使用setnx上锁，通过del释放锁\"></a>分布式锁 实现1、使用setnx上锁，通过del释放锁</h5><h6 id=\"前置知识：\"><a href=\"#前置知识：\" class=\"headerlink\" title=\"前置知识：\"></a>前置知识：</h6><p>==redis:命令==</p>\n<h1 id=\"set-sku-1-info-“OK”-NX-PX-10000\"><a href=\"#set-sku-1-info-“OK”-NX-PX-10000\" class=\"headerlink\" title=\"set sku:1:info “OK” NX PX 10000\"></a>set sku:1:info “OK” NX PX 10000</h1><ul>\n<li><p>EX second ：设置键的过期时间为 second 秒。 SET key value EX second 效果等同于 SETEX key second value 。</p>\n</li>\n<li><p>PX millisecond ：设置键的过期时间为 millisecond 毫秒。 SET key value PX millisecond 效果等同于 PSETEX key millisecond value 。</p>\n</li>\n<li><p>NX ：只在键不存在时，才对键进行设置操作。 SET key value NX 效果等同于 SETNX key value 。</p>\n</li>\n<li><p>XX ：只在键已经存在时，才对键进行设置操作。</p>\n</li>\n</ul>\n<p>==思路==</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132128630.png\" alt=\"image-20230313212833564\" style=\"zoom:25%;\"></p>\n<blockquote>\n<ol>\n<li><p>多个客户端同时获取锁（setnx）</p>\n</li>\n<li><p>获取成功，执行业务逻辑{从db获取数据，放入缓存}，执行完成释放锁（del）</p>\n</li>\n<li><p>其他客户端等待重试</p>\n</li>\n</ol>\n</blockquote>\n<p>==代码==</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@GetMapping(&quot;testLock&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">testLock</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">      </span><br><span class=\"line\">        <span class=\"comment\">//1获取锁，setnx</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">Boolean</span> <span class=\"variable\">lock</span> <span class=\"operator\">=</span> redisTemplate.opsForValue().setIfAbsent(<span class=\"string\">&quot;lock&quot;</span>, <span class=\"string\">&quot;111&quot;</span>);  <span class=\"comment\">//等价于 setnx  lock  111</span></span><br><span class=\"line\">        <span class=\"comment\">//2获取锁成功、查询num的值</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(lock)&#123;</span><br><span class=\"line\">            <span class=\"type\">Object</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> redisTemplate.opsForValue().get(<span class=\"string\">&quot;num&quot;</span>);</span><br><span class=\"line\">            <span class=\"comment\">//2.1判断num为空return</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(StringUtils.isEmpty(value))&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//2.2有值就转成int</span></span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">num</span> <span class=\"operator\">=</span> Integer.parseInt(value+<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">            <span class=\"comment\">//2.3把redis的num加1</span></span><br><span class=\"line\">            redisTemplate.opsForValue().set(<span class=\"string\">&quot;num&quot;</span>, ++num);</span><br><span class=\"line\">            <span class=\"comment\">//2.4释放锁，del</span></span><br><span class=\"line\">        </span><br><span class=\"line\">            redisTemplate.delete(<span class=\"string\">&quot;lock&quot;</span>);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"comment\">//3获取锁失败、每隔0.1秒再获取</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                Thread.sleep(<span class=\"number\">100</span>);</span><br><span class=\"line\">                testLock();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>==演示：==</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132130646.png\" alt=\"image-20230313125242001\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131253748.png\" alt=\"image-20230313125356685\" style=\"zoom:23%;\"></p>\n<p>==ab测试：==</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303131254997.png\" alt=\"image-20230313125423935\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132130499.png\" alt=\"image-20230313125436768\" style=\"zoom:33%;\"></p>\n<h5 id=\"分布式锁2、锁一直没有释放，设置key过期时间，自动释放-lt-非原子操作-gt\"><a href=\"#分布式锁2、锁一直没有释放，设置key过期时间，自动释放-lt-非原子操作-gt\" class=\"headerlink\" title=\"分布式锁2、锁一直没有释放，设置key过期时间，自动释放&lt;非原子操作&gt;\"></a>分布式锁2、锁一直没有释放，设置key过期时间，自动释放&lt;非原子操作&gt;</h5><h6 id=\"思路：\"><a href=\"#思路：\" class=\"headerlink\" title=\"思路：\"></a>思路：</h6><p>==设置过期时间有两种方式==：</p>\n<ul>\n<li><p>首先想到通过expire设置过期时间（缺乏原子性：如果在setnx和expire之间出现异常，锁也无法释放）</p>\n</li>\n<li><p>在set时指定过期时间（推荐）</p>\n</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132138420.jpg\" alt=\"img\" style=\"zoom:33%;\"></p>\n<p>==设置过期时间代码实现==</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@GetMapping(&quot;testLock&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">testLock</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//1获取锁，setnx</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">Boolean</span> <span class=\"variable\">lock</span> <span class=\"operator\">=</span> redisTemplate.opsForValue().setIfAbsent(<span class=\"string\">&quot;lock&quot;</span>, <span class=\"string\">&quot;111&quot;</span>,<span class=\"number\">3</span>,TimeUnit.SECONDS);  </span><br><span class=\"line\">        <span class=\"comment\">//2获取锁成功、查询num的值</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(lock)&#123;</span><br><span class=\"line\">            <span class=\"type\">Object</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> redisTemplate.opsForValue().get(<span class=\"string\">&quot;num&quot;</span>);</span><br><span class=\"line\">            <span class=\"comment\">//2.1判断num为空return</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(StringUtils.isEmpty(value))&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//2.2有值就转成成int</span></span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">num</span> <span class=\"operator\">=</span> Integer.parseInt(value+<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">            <span class=\"comment\">//2.3把redis的num加1</span></span><br><span class=\"line\">            redisTemplate.opsForValue().set(<span class=\"string\">&quot;num&quot;</span>, ++num);</span><br><span class=\"line\">            <span class=\"comment\">//2.4释放锁，del</span></span><br><span class=\"line\">        </span><br><span class=\"line\">            redisTemplate.delete(<span class=\"string\">&quot;lock&quot;</span>);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"comment\">//3获取锁失败、每隔0.1秒再获取</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                Thread.sleep(<span class=\"number\">100</span>);</span><br><span class=\"line\">                testLock();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"分布式锁3、—UUID防误删\"><a href=\"#分布式锁3、—UUID防误删\" class=\"headerlink\" title=\"分布式锁3、—UUID防误删\"></a>分布式锁3、—UUID防误删</h5><p>==场景==：如果业务逻辑的执行时间是7s。执行流程如下</p>\n<blockquote>\n<ol>\n<li><p>index1业务逻辑没执行完，3秒后锁被自动释放。</p>\n</li>\n<li><p>index2获取到锁，执行业务逻辑，3秒后锁被自动释放。</p>\n</li>\n<li><p>index3获取到锁，执行业务逻辑</p>\n</li>\n<li><p>index1业务逻辑执行完成，开始调用del释放锁，这时释放的是index3的锁，导致index3的业务只执行1s就被别人释放。最终等于没锁的情况。</p>\n</li>\n</ol>\n</blockquote>\n<p>==场景解析==</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132139903.png\" alt=\"image-20230313213924865\" style=\"zoom:18%;\"></p>\n<p>==解决==</p>\n<p>​        setnx获取锁时，设置一个指定的唯一值（例如：uuid）；释放前获取这个值，判断是否自己的锁</p>\n<p>==流程：==</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132142438.png\" style=\"zoom:23%;\"></p>\n<p>==代码实现：==</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@GetMapping(&quot;testLock&quot;)</span></span><br><span class=\"line\">   <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">testLock</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">       <span class=\"type\">String</span> <span class=\"variable\">uuid</span> <span class=\"operator\">=</span> UUID.randomUUID().toString();</span><br><span class=\"line\">       <span class=\"comment\">//1获取锁，setne</span></span><br><span class=\"line\">      <span class=\"type\">Boolean</span> <span class=\"variable\">lock</span> <span class=\"operator\">=</span> redisTemplate.opsForValue().setIfAbsent(<span class=\"string\">&quot;lock&quot;</span>, uuid,<span class=\"number\">3</span>, TimeUnit.SECONDS);     <span class=\"comment\">//等价于 setnx  lock  3 </span></span><br><span class=\"line\"></span><br><span class=\"line\">       </span><br><span class=\"line\">       <span class=\"comment\">//2获取锁成功、查询num的值</span></span><br><span class=\"line\">       <span class=\"keyword\">if</span>(lock)&#123;</span><br><span class=\"line\">           <span class=\"type\">Object</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> redisTemplate.opsForValue().get(<span class=\"string\">&quot;num&quot;</span>);</span><br><span class=\"line\">           <span class=\"comment\">//2.1判断num为空return</span></span><br><span class=\"line\">           <span class=\"keyword\">if</span>(StringUtils.isEmpty(value))&#123;</span><br><span class=\"line\">               <span class=\"keyword\">return</span>;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">           <span class=\"comment\">//2.2有值就转成成int</span></span><br><span class=\"line\">           <span class=\"type\">int</span> <span class=\"variable\">num</span> <span class=\"operator\">=</span> Integer.parseInt(value+<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">           <span class=\"comment\">//2.3把redis的num加1</span></span><br><span class=\"line\">           redisTemplate.opsForValue().set(<span class=\"string\">&quot;num&quot;</span>, ++num);</span><br><span class=\"line\">           <span class=\"comment\">//2.4释放锁，del</span></span><br><span class=\"line\">           <span class=\"comment\">//判断比较uuid值是否一样</span></span><br><span class=\"line\">           <span class=\"type\">String</span> <span class=\"variable\">lockUuid</span> <span class=\"operator\">=</span> (String)redisTemplate.opsForValue().get(<span class=\"string\">&quot;lock&quot;</span>);</span><br><span class=\"line\">           <span class=\"keyword\">if</span>(lockUuid.equals(uuid)) &#123;</span><br><span class=\"line\">               redisTemplate.delete(<span class=\"string\">&quot;lock&quot;</span>);</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">          </span><br><span class=\"line\">       &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">           <span class=\"comment\">//3获取锁失败、每隔0.1秒再获取</span></span><br><span class=\"line\">           <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">               Thread.sleep(<span class=\"number\">100</span>);</span><br><span class=\"line\">               testLock();</span><br><span class=\"line\">           &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">               e.printStackTrace();</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h5 id=\"分布式锁4、优化之LUA脚本保证删除的原子性\"><a href=\"#分布式锁4、优化之LUA脚本保证删除的原子性\" class=\"headerlink\" title=\"分布式锁4、优化之LUA脚本保证删除的原子性\"></a>分布式锁4、优化之LUA脚本保证删除的原子性</h5><p>==问题==</p>\n<p>​        删除操作缺乏原子性。</p>\n<p>==场景==</p>\n<ol>\n<li>index1执行删除时，查询到的lock值确实和uuid相等</li>\n</ol>\n<blockquote>\n<p>uuid=v1</p>\n<p>set(lock,uuid)；</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132144011.png\" alt></p>\n</blockquote>\n<ol>\n<li>index1执行删除前，lock刚好过期时间已到，被redis自动释放；在redis中没有了lock，没有了锁。</li>\n</ol>\n<blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132144021.png\" alt=\"image-20230313214404904\"></p>\n</blockquote>\n<ol>\n<li>index2获取了lock，index2线程获取到了cpu的资源，开始执行方法</li>\n</ol>\n<blockquote>\n<p>uuid=v2</p>\n<p>set(lock,uuid)；</p>\n</blockquote>\n<ol>\n<li>index1执行删除，此时会把index2的lock删除</li>\n</ol>\n<blockquote>\n<p>index1 因为已经在方法中了，所以不需要重新上锁。index1有执行的权限。index1已经比较完成了，这个时候，开始执行</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132142876.jpg\" alt=\"img\"></p>\n<p>删除的index2的锁！</p>\n</blockquote>\n<p>==图解场景==</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132142878.jpg\" alt=\"img\" style=\"zoom:13%;\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@GetMapping(&quot;testLockLua&quot;)</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">testLockLua</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">//1 声明一个uuid ,将做为一个value 放入我们的key所对应的值中</span></span><br><span class=\"line\">      <span class=\"type\">String</span> <span class=\"variable\">uuid</span> <span class=\"operator\">=</span> UUID.randomUUID().toString();</span><br><span class=\"line\">      <span class=\"comment\">//2 定义一个锁：lua 脚本可以使用同一把锁，来实现删除！</span></span><br><span class=\"line\">      <span class=\"type\">String</span> <span class=\"variable\">skuId</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;25&quot;</span>; <span class=\"comment\">// 访问skuId 为25号的商品 100008348542</span></span><br><span class=\"line\">      <span class=\"type\">String</span> <span class=\"variable\">locKey</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;lock:&quot;</span> + skuId; <span class=\"comment\">// 锁住的是每个商品的数据</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 3 获取锁</span></span><br><span class=\"line\">      <span class=\"type\">Boolean</span> <span class=\"variable\">lock</span> <span class=\"operator\">=</span> redisTemplate.opsForValue().setIfAbsent(locKey, uuid, <span class=\"number\">3</span>, TimeUnit.SECONDS);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 第一种： lock 与过期时间中间不写任何的代码。</span></span><br><span class=\"line\">      <span class=\"comment\">// redisTemplate.expire(&quot;lock&quot;,10, TimeUnit.SECONDS);//设置过期时间</span></span><br><span class=\"line\">      <span class=\"comment\">// 如果true</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (lock) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 执行的业务逻辑开始</span></span><br><span class=\"line\">          <span class=\"comment\">// 获取缓存中的num 数据</span></span><br><span class=\"line\">          <span class=\"type\">Object</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> redisTemplate.opsForValue().get(<span class=\"string\">&quot;num&quot;</span>);</span><br><span class=\"line\">          <span class=\"comment\">// 如果是空直接返回</span></span><br><span class=\"line\">          <span class=\"keyword\">if</span> (StringUtils.isEmpty(value)) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">return</span>;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"comment\">// 不是空 如果说在这出现了异常！ 那么delete 就删除失败！ 也就是说锁永远存在！</span></span><br><span class=\"line\">          <span class=\"type\">int</span> <span class=\"variable\">num</span> <span class=\"operator\">=</span> Integer.parseInt(value + <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">          <span class=\"comment\">// 使num 每次+1 放入缓存</span></span><br><span class=\"line\">          redisTemplate.opsForValue().set(<span class=\"string\">&quot;num&quot;</span>, String.valueOf(++num));</span><br><span class=\"line\">          <span class=\"comment\">/*使用lua脚本来锁*/</span></span><br><span class=\"line\">          <span class=\"comment\">// 定义lua 脚本</span></span><br><span class=\"line\">          <span class=\"type\">String</span> <span class=\"variable\">script</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class=\"line\">          <span class=\"comment\">// 使用redis执行lua执行</span></span><br><span class=\"line\">          DefaultRedisScript&lt;Long&gt; redisScript = <span class=\"keyword\">new</span> <span class=\"title class_\">DefaultRedisScript</span>&lt;&gt;();</span><br><span class=\"line\">          redisScript.setScriptText(script);</span><br><span class=\"line\">          <span class=\"comment\">// 设置一下返回值类型 为Long</span></span><br><span class=\"line\">          <span class=\"comment\">// 因为删除判断的时候，返回的0,给其封装为数据类型。如果不封装那么默认返回String 类型，</span></span><br><span class=\"line\">          <span class=\"comment\">// 那么返回字符串与0 会有发生错误。</span></span><br><span class=\"line\">          redisScript.setResultType(Long.class);</span><br><span class=\"line\">          <span class=\"comment\">// 第一个要是script 脚本 ，第二个需要判断的key，第三个就是key所对应的值。</span></span><br><span class=\"line\">          redisTemplate.execute(redisScript, Arrays.asList(locKey), uuid);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 其他线程等待</span></span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 睡眠</span></span><br><span class=\"line\">              Thread.sleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">              <span class=\"comment\">// 睡醒了之后，调用方法。</span></span><br><span class=\"line\">              testLockLua();</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">              e.printStackTrace();</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p>==LUA脚本详解==</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132147233.png\" alt=\"image-20230313214714182\" style=\"zoom:33%;\"></p>\n<p>==使用上面的脚本==</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//1.定义key，key应该是为每个sku定义的，也就是每个sku有一把锁。</span></span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">locKey</span> <span class=\"operator\">=</span><span class=\"string\">&quot;lock:&quot;</span>+skuId; <span class=\"comment\">// 锁住的是每个商品的数据</span></span><br><span class=\"line\"><span class=\"type\">Boolean</span> <span class=\"variable\">lock</span> <span class=\"operator\">=</span> redisTemplate.opsForValue().setIfAbsent(locKey, uuid,<span class=\"number\">3</span>,TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132148711.png\" alt=\"image-20230313214820676\" style=\"zoom:33%;\"></p>\n<h6 id=\"分布式锁LUA代码总结\"><a href=\"#分布式锁LUA代码总结\" class=\"headerlink\" title=\"分布式锁LUA代码总结\"></a>分布式锁LUA代码总结</h6><h6 id=\"1、加锁\"><a href=\"#1、加锁\" class=\"headerlink\" title=\"1、加锁\"></a>1、加锁</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 1. 从redis中获取锁,set k1 v1 px 20000 nx</span></span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">uuid</span> <span class=\"operator\">=</span> UUID.randomUUID().toString();</span><br><span class=\"line\"><span class=\"type\">Boolean</span> <span class=\"variable\">lock</span> <span class=\"operator\">=</span> <span class=\"built_in\">this</span>.redisTemplate.opsForValue()</span><br><span class=\"line\">      \t\t\t\t.setIfAbsent(<span class=\"string\">&quot;lock&quot;</span>, uuid, <span class=\"number\">2</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>\n<h6 id=\"2、使用lua释放锁\"><a href=\"#2、使用lua释放锁\" class=\"headerlink\" title=\"2、使用lua释放锁\"></a>2、使用lua释放锁</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 2. 释放锁 del</span></span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">script</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class=\"line\"><span class=\"comment\">// 设置lua脚本返回的数据类型</span></span><br><span class=\"line\">DefaultRedisScript&lt;Long&gt; redisScript = <span class=\"keyword\">new</span> <span class=\"title class_\">DefaultRedisScript</span>&lt;&gt;();</span><br><span class=\"line\"><span class=\"comment\">// 设置lua脚本返回类型为Long</span></span><br><span class=\"line\">redisScript.setResultType(Long.class);</span><br><span class=\"line\">redisScript.setScriptText(script);</span><br><span class=\"line\">redisTemplate.execute(redisScript, Arrays.asList(<span class=\"string\">&quot;lock&quot;</span>),uuid);</span><br></pre></td></tr></table></figure>\n<h6 id=\"3、重试\"><a href=\"#3、重试\" class=\"headerlink\" title=\"3、重试\"></a>3、重试</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Thread.sleep(<span class=\"number\">500</span>);</span><br><span class=\"line\">testLock();</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>为了确保分布式锁可用，我们至少要确保锁的实现同时<strong>满足以下四个条件</strong>：</p>\n<ul>\n<li>互斥性。在任意时刻，只有一个客户端能持有锁。</li>\n<li><p>不会发生死锁。即使有一个客户端在持有锁的期间崩溃而没有主动解锁，也能保证后续其他客户端能加锁。//设置过期时间</p>\n</li>\n<li><p>解铃还须系铃人。加锁和解锁必须是同一个客户端，客户端自己不能把别人加的锁给解了。</p>\n</li>\n<li><p>加锁和解锁必须具有原子性。</p>\n</li>\n</ul>\n</blockquote>\n<h2 id=\"Redis-新功能\"><a href=\"#Redis-新功能\" class=\"headerlink\" title=\"Redis 新功能\"></a>Redis 新功能</h2><h3 id=\"ACL\"><a href=\"#ACL\" class=\"headerlink\" title=\"ACL\"></a>ACL</h3><h4 id=\"简介-3\"><a href=\"#简介-3\" class=\"headerlink\" title=\"简介\"></a>简介</h4><ul>\n<li>Redis ACL是Access Control List（访问控制列表）的缩写，该功能允许根据可以执行的命令和可以访问的键来限制某些连接。</li>\n<li>在Redis 5版本之前，Redis 安全规则只有密码控制 还有通过rename 来调整高危命令比如 flushdb ， KEYS* ， shutdown 等。Redis 6 则提供ACL的功能对用户进行更细粒度的权限控制 ：<ul>\n<li>（1）接入权限:用户名和密码</li>\n<li>（2）可以执行的命令</li>\n<li>（3）可以操作的 KEY<br>[参考官网][<a href=\"https://redis.io/topics/acl\">https://redis.io/topics/acl</a>]</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"命令-7\"><a href=\"#命令-7\" class=\"headerlink\" title=\"命令\"></a>命令</h4><h5 id=\"1、使用acl-list命令展现用户权限列表\"><a href=\"#1、使用acl-list命令展现用户权限列表\" class=\"headerlink\" title=\"1、使用acl list命令展现用户权限列表\"></a>1、使用acl list命令展现用户权限列表</h5><h6 id=\"（1）数据说明\"><a href=\"#（1）数据说明\" class=\"headerlink\" title=\"（1）数据说明\"></a>（1）数据说明</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132110590.png\" alt=\"image-20230313211038549\" style=\"zoom:33%;\"></p>\n<h5 id=\"2、使用acl-cat命令\"><a href=\"#2、使用acl-cat命令\" class=\"headerlink\" title=\"2、使用acl cat命令\"></a>2、使用acl cat命令</h5><h6 id=\"（1）查看添加权限指令类别\"><a href=\"#（1）查看添加权限指令类别\" class=\"headerlink\" title=\"（1）查看添加权限指令类别\"></a>（1）查看添加权限指令类别</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132110684.png\" alt=\"image-20230313211050646\" style=\"zoom:23%;\"></p>\n<h6 id=\"（2）加参数类型名可以查看类型下具体命令\"><a href=\"#（2）加参数类型名可以查看类型下具体命令\" class=\"headerlink\" title=\"（2）加参数类型名可以查看类型下具体命令\"></a>（2）加参数类型名可以查看类型下具体命令</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132111595.png\" alt=\"image-20230313211107555\" style=\"zoom:23%;\"></p>\n<h5 id=\"3、使用acl-whoami命令查看当前用户\"><a href=\"#3、使用acl-whoami命令查看当前用户\" class=\"headerlink\" title=\"3、使用acl whoami命令查看当前用户\"></a>3、使用acl whoami命令查看当前用户</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132112199.png\" alt=\"image-20230313211208154\" style=\"zoom:23%;\"></p>\n<h5 id=\"4、使用aclsetuser命令创建和编辑用户ACL\"><a href=\"#4、使用aclsetuser命令创建和编辑用户ACL\" class=\"headerlink\" title=\"4、使用aclsetuser命令创建和编辑用户ACL\"></a>4、使用aclsetuser命令创建和编辑用户ACL</h5><h6 id=\"（1）ACL规则\"><a href=\"#（1）ACL规则\" class=\"headerlink\" title=\"（1）ACL规则\"></a>（1）ACL规则</h6><p>下面是有效ACL规则的列表。某些规则只是用于激活或删除标志，或对用户ACL执行给定更改的单个单词。其他规则是字符前缀，它们与命令或类别名称、键模式等连接在一起。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132114543.png\" alt=\"image-20230313211406495\" style=\"zoom:33%;\"></p>\n<h6 id=\"（2）通过命令创建新用户默认权限\"><a href=\"#（2）通过命令创建新用户默认权限\" class=\"headerlink\" title=\"（2）通过命令创建新用户默认权限\"></a>（2）通过命令创建新用户默认权限</h6><p>acl setuser lucy</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132114291.png\" alt=\"image-20230313211419243\" style=\"zoom:25%;\"></p>\n<p>在上面的示例中，我根本没有指定任何规则。如果用户不存在，这将使用just created的默认属性来创建用户。如果用户已经存在，则上面的命令将不执行任何操作。</p>\n<h6 id=\"（3）设置有用户名、密码、ACL权限、并启用的用户\"><a href=\"#（3）设置有用户名、密码、ACL权限、并启用的用户\" class=\"headerlink\" title=\"（3）设置有用户名、密码、ACL权限、并启用的用户\"></a>（3）设置有用户名、密码、ACL权限、并启用的用户</h6><p>acl setuser user2 on &gt;password ~cached:* +get</p>\n<h6 id=\"4-切换用户，验证权限\"><a href=\"#4-切换用户，验证权限\" class=\"headerlink\" title=\"(4)切换用户，验证权限\"></a>(4)切换用户，验证权限</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132114798.png\" alt=\"image-20230313211443733\" style=\"zoom:23%;\"></p>\n<h3 id=\"Redis-IO-多线程\"><a href=\"#Redis-IO-多线程\" class=\"headerlink\" title=\"Redis IO 多线程\"></a>Redis IO 多线程</h3><h4 id=\"简介-4\"><a href=\"#简介-4\" class=\"headerlink\" title=\"简介\"></a>简介</h4><ul>\n<li><p>Redis6 终于支撑多线程了，告别单线程了吗？</p>\n</li>\n<li><p>IO 多线程其实指客户端交互部分的网络 IO 交互处理模块 多线程，而非执行命令多线程。Redis6 执行命令依然是单线程。</p>\n</li>\n</ul>\n<h4 id=\"原理架构\"><a href=\"#原理架构\" class=\"headerlink\" title=\"原理架构\"></a>原理架构</h4><p>Redis 6 加入多线程，但跟 Memcached 这种从 IO 处理到数据访问多线程的实现模式有些差异。Redis 的多线程部分只是用来处理网络数据的读写和协议解析，执行命令仍然是单线程。之所以这么设计是不想因为多线程而变得复杂，需要去控制 key、lua、事务，LPUSH/LPOP 等等的并发问题。整体的设计大体如下:</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132115446.png\" alt=\"image-20230313211546411\" style=\"zoom:25%;\"></p>\n<p>另外，多线程 IO 默认也是不开启的，需要再配置文件中配置：</p>\n<ul>\n<li><p>io-threads-do-reads yes</p>\n</li>\n<li><p>io-threads 4</p>\n</li>\n</ul>\n<h3 id=\"工具支持-Cluster\"><a href=\"#工具支持-Cluster\" class=\"headerlink\" title=\"工具支持 Cluster\"></a>工具支持 Cluster</h3><h4 id=\"简介-5\"><a href=\"#简介-5\" class=\"headerlink\" title=\"简介\"></a>简介</h4><p>之前老版Redis想要搭集群需要单独安装ruby环境，Redis 5 将 redis-trib.rb 的功能集成到 redis-cli 。另外官方 redis-benchmark 工具开始支持 cluster 模式了，通过多线程的方式对多个分片进行压测。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202303132117942.png\" alt=\"image-20230313211712900\" style=\"zoom:25%;\"></p>\n<h4 id=\"Redis新功能持续关注\"><a href=\"#Redis新功能持续关注\" class=\"headerlink\" title=\"Redis新功能持续关注\"></a>Redis新功能持续关注</h4><h5 id=\"Redis6新功能还有：\"><a href=\"#Redis6新功能还有：\" class=\"headerlink\" title=\"Redis6新功能还有：\"></a>Redis6新功能还有：</h5><ul>\n<li>1、RESP3新的 Redis 通信协议：优化服务端与客户端之间通信</li>\n<li>2、Client side caching客户端缓存：基于 RESP3 协议实现的客户端缓存功能。为了进一步提升缓存的性能，将客户端经常访问的数据cache到客户端。减少TCP网络交互。</li>\n<li>3、Proxy集群代理模式：Proxy 功能，让 Cluster 拥有像单实例一样的接入方式，降低大家使用cluster的门槛。不过需要注意的是代理不改变 Cluster 的功能限制，不支持的命令还是不会支持，比如跨 slot 的多Key操作。</li>\n<li>4、Modules API<br>Redis 6中模块API开发进展非常大，因为Redis Labs为了开发复杂的功能，从一开始就用上Redis模块。Redis可以变成一个框架，利用Modules来构建不同系统，而不需要从头开始写然后还要BSD许可。Redis一开始就是一个向编写各种系统开放的平台。</li>\n</ul>\n","_path":"post/eaacaa4d.html","_link":"http://rycan.top/post/eaacaa4d.html","_id":"clo9tj5vu004rl10p0wti5q8v"}}