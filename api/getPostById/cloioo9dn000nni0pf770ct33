{"type":"getPostById","data":{"title":"JVM调优模拟","date":"2023-11-03T13:38:10.000Z","description":"JVM","categories":[{"name":"JVM","_id":"cloioo9dv001pni0pb18aehel"}],"tags":[{"name":"JVM","_id":"cloioo9dv001rni0p05fdcfjz"}],"content":"<meta name=\"referrer\" content=\"no-referrer\">\n<h3 id=\"Springoot项目\">Springoot项目</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.learning.study.jvm;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Controller;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UserController</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/user/processUser&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">processUser</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        ArrayList&lt;User&gt; list = queryUser();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (User  user :list) &#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;user:&quot;</span> + user.toString());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;end&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ArrayList&lt;User&gt; <span class=\"title function_\">queryUser</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        ArrayList&lt;User&gt; user = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; <span class=\"number\">500_000</span>; i++) &#123;</span><br><span class=\"line\">            user.add(<span class=\"keyword\">new</span> <span class=\"title class_\">User</span>(i,<span class=\"string\">&quot;zhangsan&quot;</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> user;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.learning.study.jvm;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.AllArgsConstructor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Data;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.NoArgsConstructor;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"meta\">@AllArgsConstructor</span></span><br><span class=\"line\"><span class=\"meta\">@NoArgsConstructor</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">User</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> id;</span><br><span class=\"line\">    <span class=\"type\">byte</span> a[] =<span class=\"keyword\">new</span> <span class=\"title class_\">byte</span>[<span class=\"number\">1024</span> * <span class=\"number\">1024</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">User</span><span class=\"params\">(<span class=\"type\">int</span> id, String name)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.id = id;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"结果\">结果</h3>\n<blockquote>\n<p>OOM</p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java.lang.OutOfMemoryError: Java heap space     -- OOM</span><br><span class=\"line\">\tat com.ry.learning.study.jvm.User.&lt;init&gt;(User.java:13) ~[classes/:na]</span><br><span class=\"line\">\tat com.ry.learning.study.jvm.UserController.queryUser(UserController.java:22) ~[classes/:na]</span><br><span class=\"line\">\tat com.ry.learning.study.jvm.UserController.processUser(UserController.java:12) ~[classes/:na]</span><br><span class=\"line\">\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_381]</span><br><span class=\"line\">\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_381]</span><br><span class=\"line\">\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_381]</span><br><span class=\"line\">\tat java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_381]</span><br><span class=\"line\">\tat org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:205) ~[spring-web-5.3.23.jar:5.3.23]</span><br><span class=\"line\">\tat org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:150) ~[spring-web-5.3.23.jar:5.3.23]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"配置\">配置</h3>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-<span class=\"title class_\">Xms1536</span>M -<span class=\"title class_\">Xmx1536</span>M -<span class=\"title class_\">Xmn512</span>M -<span class=\"title class_\">Xss256</span>K -<span class=\"variable constant_\">XX</span><span class=\"symbol\">:SurvivorRatio=</span><span class=\"number\">6</span> -<span class=\"variable constant_\">XX</span><span class=\"symbol\">:MetaspaceSize=</span>256M -<span class=\"variable constant_\">XX</span><span class=\"symbol\">:MaxMetaspaceSize=</span>256M -<span class=\"variable constant_\">XX</span><span class=\"symbol\">:+UseParNewGC</span> -<span class=\"variable constant_\">XX</span><span class=\"symbol\">:+UseConcMarkSweepGC</span> -<span class=\"variable constant_\">XX</span><span class=\"symbol\">:CMSInitiatingOccupancyFraction=</span><span class=\"number\">75</span> -<span class=\"variable constant_\">XX</span><span class=\"symbol\">:+UseCMSInitiatingOccupancyOnly</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jstat -gc <span class=\"number\">7153</span>  <span class=\"number\">1000</span> <span class=\"number\">10000</span>                                                                                                                                        ~ <span class=\"number\">130</span> ↵</span><br><span class=\"line\"> <span class=\"variable constant_\">S0C</span>    <span class=\"variable constant_\">S1C</span>    <span class=\"variable constant_\">S0U</span>    <span class=\"variable constant_\">S1U</span>      <span class=\"variable constant_\">EC</span>       <span class=\"variable constant_\">EU</span>        <span class=\"variable constant_\">OC</span>         <span class=\"variable constant_\">OU</span>       <span class=\"variable constant_\">MC</span>     <span class=\"variable constant_\">MU</span>    <span class=\"variable constant_\">CCSC</span>   <span class=\"variable constant_\">CCSU</span>   <span class=\"variable constant_\">YGC</span>     <span class=\"variable constant_\">YGCT</span>    <span class=\"variable constant_\">FGC</span>    <span class=\"variable constant_\">FGCT</span>     <span class=\"variable constant_\">GCT</span></span><br><span class=\"line\"><span class=\"number\">65536.0</span> <span class=\"number\">65536.0</span>  <span class=\"number\">0.0</span>    <span class=\"number\">0.0</span>   <span class=\"number\">393216.0</span> <span class=\"number\">16205.9</span>  <span class=\"number\">1048576.0</span>   <span class=\"number\">10997.5</span>   <span class=\"number\">37376.0</span> <span class=\"number\">34944.8</span> <span class=\"number\">4864.0</span> <span class=\"number\">4430.6</span>      <span class=\"number\">4</span>    <span class=\"number\">0.268</span>   <span class=\"number\">9</span>      <span class=\"number\">0.900</span>    <span class=\"number\">1.168</span></span><br><span class=\"line\"><span class=\"number\">65536.0</span> <span class=\"number\">65536.0</span>  <span class=\"number\">0.0</span>    <span class=\"number\">0.0</span>   <span class=\"number\">393216.0</span> <span class=\"number\">20138.1</span>  <span class=\"number\">1048576.0</span>   <span class=\"number\">10997.5</span>   <span class=\"number\">37376.0</span> <span class=\"number\">34944.8</span> <span class=\"number\">4864.0</span> <span class=\"number\">4430.6</span>      <span class=\"number\">4</span>    <span class=\"number\">0.268</span>   <span class=\"number\">9</span>      <span class=\"number\">0.900</span>    <span class=\"number\">1.168</span></span><br><span class=\"line\"><span class=\"number\">65536.0</span> <span class=\"number\">65536.0</span>  <span class=\"number\">0.0</span>    <span class=\"number\">0.0</span>   <span class=\"number\">393216.0</span> <span class=\"number\">20138.1</span>  <span class=\"number\">1048576.0</span>   <span class=\"number\">10997.5</span>   <span class=\"number\">37376.0</span> <span class=\"number\">34944.8</span> <span class=\"number\">4864.0</span> <span class=\"number\">4430.6</span>      <span class=\"number\">4</span>    <span class=\"number\">0.268</span>   <span class=\"number\">9</span>      <span class=\"number\">0.900</span>    <span class=\"number\">1.168</span></span><br><span class=\"line\"><span class=\"number\">65536.0</span> <span class=\"number\">65536.0</span>  <span class=\"number\">0.0</span>    <span class=\"number\">0.0</span>   <span class=\"number\">393216.0</span> <span class=\"number\">20138.1</span>  <span class=\"number\">1048576.0</span>   <span class=\"number\">10997.5</span>   <span class=\"number\">37376.0</span> <span class=\"number\">34944.8</span> <span class=\"number\">4864.0</span> <span class=\"number\">4430.6</span>      <span class=\"number\">4</span>    <span class=\"number\">0.268</span>   <span class=\"number\">9</span>      <span class=\"number\">0.900</span>    <span class=\"number\">1.168</span></span><br><span class=\"line\"><span class=\"number\">65536.0</span> <span class=\"number\">65536.0</span>  <span class=\"number\">0.0</span>    <span class=\"number\">0.0</span>   <span class=\"number\">393216.0</span> <span class=\"number\">20138.1</span>  <span class=\"number\">1048576.0</span>   <span class=\"number\">10997.5</span>   <span class=\"number\">37376.0</span> <span class=\"number\">34944.8</span> <span class=\"number\">4864.0</span> <span class=\"number\">4430.6</span>      <span class=\"number\">4</span>    <span class=\"number\">0.268</span>   <span class=\"number\">9</span>      <span class=\"number\">0.900</span>    <span class=\"number\">1.168</span></span><br><span class=\"line\"><span class=\"number\">65536.0</span> <span class=\"number\">65536.0</span>  <span class=\"number\">0.0</span>    <span class=\"number\">0.0</span>   <span class=\"number\">393216.0</span> <span class=\"number\">20138.1</span>  <span class=\"number\">1048576.0</span>   <span class=\"number\">10997.5</span>   <span class=\"number\">37376.0</span> <span class=\"number\">34944.8</span> <span class=\"number\">4864.0</span> <span class=\"number\">4430.6</span>      <span class=\"number\">4</span>    <span class=\"number\">0.268</span>   <span class=\"number\">9</span>      <span class=\"number\">0.900</span>    <span class=\"number\">1.168</span></span><br><span class=\"line\"><span class=\"number\">65536.0</span> <span class=\"number\">65536.0</span>  <span class=\"number\">0.0</span>    <span class=\"number\">0.0</span>   <span class=\"number\">393216.0</span> <span class=\"number\">20138.1</span>  <span class=\"number\">1048576.0</span>   <span class=\"number\">10997.5</span>   <span class=\"number\">37376.0</span> <span class=\"number\">34944.8</span> <span class=\"number\">4864.0</span> <span class=\"number\">4430.6</span>      <span class=\"number\">4</span>    <span class=\"number\">0.268</span>   <span class=\"number\">9</span>      <span class=\"number\">0.900</span>    <span class=\"number\">1.168</span></span><br><span class=\"line\"><span class=\"number\">65536.0</span> <span class=\"number\">65536.0</span>  <span class=\"number\">0.0</span>    <span class=\"number\">0.0</span>   <span class=\"number\">393216.0</span> <span class=\"number\">20138.1</span>  <span class=\"number\">1048576.0</span>   <span class=\"number\">10997.5</span>   <span class=\"number\">37376.0</span> <span class=\"number\">34944.8</span> <span class=\"number\">4864.0</span> <span class=\"number\">4430.6</span>      <span class=\"number\">4</span>    <span class=\"number\">0.268</span>   <span class=\"number\">9</span>      <span class=\"number\">0.900</span>    <span class=\"number\">1.168</span></span><br></pre></td></tr></table></figure>\n<p>程序启动以后都是出发了4次young gc， 9次full gc</p>\n<h3 id=\"调优：\">调优：</h3>\n<h4 id=\"思路先导：\">思路先导：</h4>\n<p>eden 过小就会导致频繁young gc，过大就会导致young gc 的时间会变长扫描时间边长</p>\n<p>Survivor 过小就会导致提前进入老年代，过大就会浪费一部分内存</p>\n<h4 id=\"常见参数\">常见参数</h4>\n<p>-Xms  -Xmx  -Xmn</p>\n<p>-XX:NewSize</p>\n<p>-XX:MaxNewSize</p>\n<p>-XX:SurvivorRatio</p>\n<p>-XX:MaxTenuringThreshold</p>\n<p>-XX:+CMSInitiatingOccupancyFraction</p>\n<p>-XX:+UseCMSInitiatingOccupancyOnly</p>\n<p>-XX:+CMSScavengeBeforeRemark</p>\n<p>-XX:+UseCMSCompactAtFullCollection</p>\n<p>-XX:CMSFullGCsBeforeCompaction</p>\n<p>-XX:MetaspaceSize</p>\n<p>-XX:MaxMetaspaceSize</p>\n<h4 id=\"回答思路：\">回答思路：</h4>\n<p>合理的使用jvm的参数是大多数情况下是不用调优的；只有极少数的情况下才会进行调优，可以对JVM的核心指标配置监控告警，只有出现波动的时候才会进行人为分析；</p>\n<p>通常情况下，JVM 的配置参数还是按照官方建议的来：</p>\n<ul>\n<li>-XX:NewRatio=2，年轻代:老年代=1:2</li>\n<li>-XX:SurvivorRatio=8，eden:survivor=8:1</li>\n<li>堆内存设置为物理内存的3/4左右</li>\n</ul>\n<p>大部分情况其实 应该是   自己的代码 bug 导致   OOM、CPU load高、GC频繁啥的，这些场景也基本都是代码修复即可，通常不需要动 JVM，需要用的时候可以升级垃圾回收器就可以解决了</p>\n<h4 id=\"JVM优化步骤\">JVM优化步骤</h4>\n<h5 id=\"分析和定位当前系统的瓶颈\">分析和定位当前系统的瓶颈</h5>\n<h6 id=\"1、CPU指标\">1、<strong>CPU指标</strong></h6>\n<ul>\n<li>查看占用CPU最多的<code>进</code>程</li>\n<li>查看占用CPU最多的<code>线</code>程</li>\n<li><code>查看线程堆栈快照信息</code></li>\n<li><code>分析代码执行热点</code></li>\n<li>查看<code>哪个代码</code>占用CPU执行时间最长</li>\n<li>查看<code>每个方法占用CPU时间比例</code></li>\n</ul>\n<blockquote>\n<p>常见的工具：JProfiler、JVM Profiler、Arthas等。</p>\n</blockquote>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/<span class=\"regexp\">/ 显示系统各个进程的资源使用情况</span></span><br><span class=\"line\"><span class=\"regexp\">top</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 查看某个进程中的线程占用情况</span></span><br><span class=\"line\"><span class=\"regexp\">top -Hp pid</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 查看当前 Java 进程的线程堆栈信息</span></span><br><span class=\"line\"><span class=\"regexp\">jstack pid</span></span><br></pre></td></tr></table></figure>\n<h6 id=\"2、JVM-内存指标\">2、<strong>JVM 内存指标</strong></h6>\n<ul>\n<li>查看当前 JVM 堆内存参数配置是否合理</li>\n<li>查看堆中对象的统计信息</li>\n<li>查看堆存储快照，分析内存的占用情况</li>\n<li>查看堆各区域的内存增长是否正常</li>\n<li>查看是哪个区域导致的GC</li>\n<li>查看GC后能否正常回收到内存</li>\n</ul>\n<blockquote>\n<p>常见的工具：Eclipse MAT、JConsole等。</p>\n</blockquote>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/<span class=\"regexp\">/ 查看当前的 JVM 参数配置</span></span><br><span class=\"line\"><span class=\"regexp\">ps -ef | grep java</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 查看 Java 进程的配置信息，包括系统属性和JVM命令行标志</span></span><br><span class=\"line\"><span class=\"regexp\">jinfo pid</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 输出 Java 进程当前的 gc 情况</span></span><br><span class=\"line\"><span class=\"regexp\">jstat -gc pid</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 输出 Java 堆详细信息</span></span><br><span class=\"line\"><span class=\"regexp\">jmap -heap pid</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 显示堆中对象的统计信息</span></span><br><span class=\"line\"><span class=\"regexp\">jmap -histo:live pid</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 生成 Java 堆存储快照dump文件</span></span><br><span class=\"line\"><span class=\"regexp\">jmap -F -dump:format=b,file=dumpFile.phrof pid</span></span><br></pre></td></tr></table></figure>\n<h6 id=\"3、JVM-GC指标\">3、<strong>JVM GC指标</strong></h6>\n<ul>\n<li>查看每分钟<code>GC</code>时间是否正常</li>\n<li>查看每分钟<code>YGC</code>次数是否正常</li>\n<li>查看<code>FGC</code>次数是否正常</li>\n<li>查看单次<code>FGC</code>时间是否正常</li>\n<li>查看单次<code>GC</code>各阶段详细耗时，找到耗时严重的阶段</li>\n<li>查看对象的动态<code>晋升年龄</code>是否正常</li>\n</ul>\n<p>JVM 的 GC指标一般是从 GC 日志里面查看，默认的 GC 日志可能比较少，我们可以添加以下参数，来丰富我们的GC日志输出，方便我们定位问题。</p>\n<p>GC日志常用 JVM 参数：</p>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/<span class=\"regexp\">/ 打印GC的详细信息</span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintGCDetails</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 打印GC的时间戳</span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintGCDateStamps</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 在GC前后打印堆信息</span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintHeapAtGC</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 打印Survivor区中各个年龄段的对象的分布信息</span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintTenuringDistribution</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ JVM启动时输出所有参数值，方便查看参数是否被覆盖</span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintFlagsFinal</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 打印GC时应用程序的停止时间</span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintGCApplicationStoppedTime</span></span><br><span class=\"line\"><span class=\"regexp\">/</span><span class=\"regexp\">/ 打印在GC期间处理引用对象的时间（仅在PrintGCDetails时启用）</span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintReferenceGC</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"确定优化目标\"><strong>确定优化目标</strong></h5>\n<p>定位出系统瓶颈后，在优化前先制定好优化的目标是什么，比如：</p>\n<ul>\n<li>将FGC次数从每小时1次，降低到1天1次</li>\n<li>将每分钟的GC耗时从3s降低到500ms</li>\n<li>将每次FGC耗时从5s降低到1s以内</li>\n</ul>\n<h5 id=\"制订优化方案\">制订优化方案</h5>\n<p>针对定位出的系统瓶颈制定相应的优化方案，常见的有：</p>\n<ul>\n<li>\n<p>代码bug：升级修复bug。典型的有：死循环、使用无界队列。</p>\n</li>\n<li>\n<p>不合理的JVM参数配置：优化 JVM 参数配置。典型的有：年轻代内存配置过小、堆内存配置过小、元空间配置过小。</p>\n</li>\n</ul>\n<h5 id=\"对比优化前后的指标，统计优化效果\">对比优化前后的指标，统计优化效果</h5>\n<h5 id=\"持续观察和跟踪优化效果\">持续观察和跟踪优化效果</h5>\n<h5 id=\"如果还需要的话，重复以上步骤\">如果还需要的话，重复以上步骤</h5>\n<h4 id=\"实习中的中的JVM-的参数配置\">实习中的中的JVM 的参数配置</h4>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export <span class=\"variable constant_\">JAVA_OPTS</span>=<span class=\"string\">&quot; </span></span><br><span class=\"line\"><span class=\"string\">-Xms10649m  </span></span><br><span class=\"line\"><span class=\"string\">-Xmx10649m  </span></span><br><span class=\"line\"><span class=\"string\">-XX:MaxMetaspaceSize=512m </span></span><br><span class=\"line\"><span class=\"string\">-XX:MetaspaceSize=512m  </span></span><br><span class=\"line\"><span class=\"string\">-Djava.library.path=/usr/local/lib -server </span></span><br><span class=\"line\"><span class=\"string\">-XX:+HeapDumpOnOutOfMemoryError </span></span><br><span class=\"line\"><span class=\"string\">-XX:HeapDumpPath=/export/Logs </span></span><br><span class=\"line\"><span class=\"string\">-Djava.awt.headless=true -Dsun.net.client.defaultConnectTimeout=60000 </span></span><br><span class=\"line\"><span class=\"string\">-Dsun.net.client.defaultReadTimeout=60000 </span></span><br><span class=\"line\"><span class=\"string\">-Djmagick.systemclassloader=no </span></span><br><span class=\"line\"><span class=\"string\">-Dnetworkaddress.cache.ttl=300 </span></span><br><span class=\"line\"><span class=\"string\">-Dsun.net.inetaddr.ttl=300 &quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">-<span class=\"title class_\">Djava</span>.util.logging.config.file=<span class=\"regexp\">/export/</span><span class=\"title class_\">Domains</span>/bargain.jd.com/server1/conf/logging.properties </span><br><span class=\"line\">-<span class=\"title class_\">Djava</span>.util.logging.manager=org.apache.juli.<span class=\"title class_\">ClassLoaderLogManager</span> </span><br><span class=\"line\">-<span class=\"title class_\">Djava</span>.library.path=<span class=\"regexp\">/usr/local</span><span class=\"regexp\">/lib </span></span><br><span class=\"line\"><span class=\"regexp\">-Xms8192m </span></span><br><span class=\"line\"><span class=\"regexp\">-Xmx8192m </span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+HeapDumpOnOutOfMemoryError </span></span><br><span class=\"line\"><span class=\"regexp\">-XX:HeapDumpPath=/export</span><span class=\"regexp\">/Logs </span></span><br><span class=\"line\"><span class=\"regexp\">-Djava.awt.headless=true </span></span><br><span class=\"line\"><span class=\"regexp\">-Dsun.net.client.defaultConnectTimeout=60000 </span></span><br><span class=\"line\"><span class=\"regexp\">-Dsun.net.client.defaultReadTimeout=60000 </span></span><br><span class=\"line\"><span class=\"regexp\">-Djmagick.systemclassloader=no </span></span><br><span class=\"line\"><span class=\"regexp\">-Dnetworkaddress.cache.ttl=300 </span></span><br><span class=\"line\"><span class=\"regexp\">-Dsun.net.inetaddr.ttl=300 </span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintGC </span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintGCDetails </span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintGCDateStamps </span></span><br><span class=\"line\"><span class=\"regexp\">-XX:+PrintHeapAtGC </span></span><br><span class=\"line\"><span class=\"regexp\">-Xloggc:/export</span><span class=\"regexp\">/Logs/bargain</span>.jd.local/gc.log </span><br><span class=\"line\">-<span class=\"variable constant_\">XX</span><span class=\"symbol\">:+UseG1GC</span> </span><br><span class=\"line\">-<span class=\"variable constant_\">XX</span><span class=\"symbol\">:MaxGCPauseMillis=</span><span class=\"number\">100</span> </span><br><span class=\"line\">-<span class=\"variable constant_\">XX</span><span class=\"symbol\">:ParallelGCThreads=</span><span class=\"number\">8</span> </span><br><span class=\"line\">-<span class=\"title class_\">Ddeploy</span>.app.name=jdos_bargain -<span class=\"title class_\">Ddeploy</span>.app.id=<span class=\"number\">1238142</span> </span><br><span class=\"line\">-<span class=\"title class_\">Ddeploy</span>.instance.id=<span class=\"number\">0</span> </span><br><span class=\"line\">-<span class=\"title class_\">Ddeploy</span>.dynamic.config.dir=<span class=\"variable constant_\">WEBINFCLASSES</span> </span><br><span class=\"line\">-<span class=\"variable constant_\">DJDOS_DATACENTER</span>=<span class=\"variable constant_\">ZYX</span> </span><br><span class=\"line\">-<span class=\"symbol\">javaagent:</span>/export/pfinder/bargain/lib/pfinder-profiler-agent-<span class=\"number\">20220930</span>.jar</span><br><span class=\"line\">-<span class=\"title class_\">Djava</span>.endorsed.dirs=<span class=\"regexp\">/export/servers</span><span class=\"regexp\">/tomcat8.0.30/endorsed</span> </span><br><span class=\"line\">-<span class=\"title class_\">Dcatalina</span>.base=<span class=\"regexp\">/export/</span><span class=\"title class_\">Domains</span>/bargain.jd.com/server1 </span><br><span class=\"line\">-<span class=\"title class_\">Dcatalina</span>.home=<span class=\"regexp\">/export/servers</span><span class=\"regexp\">/tomcat8.0.30 </span></span><br><span class=\"line\"><span class=\"regexp\">-Djava.io.tmpdir=/export</span><span class=\"regexp\">/Domains/bargain</span>.jd.com/server1/temp</span><br></pre></td></tr></table></figure>\n<h3 id=\"经典案例：\">经典案例：</h3>\n<h4 id=\"CMS内存碎片化导致的FGC\">CMS内存碎片化导致的FGC</h4>\n<p>现象：</p>\n<p>C端业务高峰期会在服务器发生FGC,导致超时报错，影响用户体验</p>\n<p>原因：</p>\n<p>CMS 使用的标记清除算法不会进行任何压缩和整理的工作，意味着老年代随着应用运行会变得碎片化，碎片过多会影响大对象的分配，虽然老年代还有很大的剩余空间，但是没有连续的空间来分配大对象。长期如期，最终可能会导致FGC的发生。</p>\n<p>优化策略：</p>\n<p>业务低峰期显式触发FGC,优化内存碎片并压缩堆，降低在业务高峰期发生FGC的概率</p>\n<ul>\n<li>System.gc(O,没有开启-XX:+DisableExplicitGC</li>\n<li>jmap-histo:live pid</li>\n</ul>\n<p>优化效果：业务高峰期基本没有出现FGC</p>\n<h4 id=\"YGC-和OLD-GC-频繁\">YGC 和OLD GC 频繁</h4>\n<p>问题现象：</p>\n<p>服务器YGC和OLD GC频繁导致TP999耗时较高，YGC每分钟50次，每次25毫秒，OLD GC几分钟1次，每次200毫秒</p>\n<p>原因分析：</p>\n<p>该服务要求低延迟，为了YGC较快完成，年轻代设置较小，但是由于年轻代较小，反而导致YGC次数过多，查看GC日志发现，由于动态年龄的因素，大量对象较早晋升到老年代，从而导致OLD GC频繁</p>\n<p>优化策略：</p>\n<p>扩大新生代内存到原来的3倍</p>\n<p>优化效果：</p>\n<p>单次YGC耗时增加了5%，频率较低了60%，服务TP99降低了10ms+,OLD GC频率降级为几小时1次</p>\n<h4 id=\"OLD-GC耗时较长影响业务\">OLD GC耗时较长影响业务</h4>\n<p>原因：Remark阶段时间较长</p>\n<p>优化：-XX:+CMSScavengeBeforeRemark</p>\n<h4 id=\"YGC耗时增加\">YGC耗时增加</h4>\n<p>原因：jackson进行反序列化时会将key进行String#intern,导致扫描时，GCRoot变大</p>\n<p>解决：禁用jackson的String#intern</p>\n<h4 id=\"YGC次数增加\">YGC次数增加</h4>\n<p>原因：-XX:MaxGCPauseMillis参数时间设置过小，导致JVM降低年轻代region</p>\n<p>解决：1)调大-XX:MaxGCPauseMillis值：2)将年轻代region大小设置为固定值</p>\n","_path":"post/19fed75e.html","_link":"http://rycan.top/post/19fed75e.html","_id":"cloioo9dn000nni0pf770ct33"}}