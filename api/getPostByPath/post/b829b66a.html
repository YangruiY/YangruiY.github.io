{"type":"getPostByPath","data":{"title":"Zookeeper","date":"2023-07-03T12:51:48.000Z","description":"Zookeeper","categories":[{"name":"中间件","_id":"clnscmc9c000ca80phyp170y4"}],"tags":[{"name":"Zookeeper","_id":"clnscmca6005ra80pgr5cakz4"}],"content":"<meta name=\"referrer\" content=\"no-referrer\">\n\n<h1 id=\"Zookeeeper\"><a href=\"#Zookeeeper\" class=\"headerlink\" title=\"Zookeeeper\"></a>Zookeeeper</h1><h2 id=\"1-Zookeeper入门\"><a href=\"#1-Zookeeper入门\" class=\"headerlink\" title=\"1. Zookeeper入门\"></a>1. Zookeeper入门</h2><p>Zookeeper 是一个开源的分布式的，为分布式框架提供协调服务的 Apache 项目。</p>\n<h3 id=\"1-1-概述\"><a href=\"#1-1-概述\" class=\"headerlink\" title=\"1.1 概述\"></a>1.1 概述</h3><h5 id=\"Zookeeper理解\"><a href=\"#Zookeeper理解\" class=\"headerlink\" title=\"Zookeeper理解\"></a>Zookeeper理解</h5><p>设计模式角度来理解：</p>\n<p>是一个基于<code>观察者模式设计</code>的分布式服务管理框架，它负责存储和管理大家都关心的数据，然后接受观察者的注册，一旦这些数据的状态发生变化，Zookeeper就将负责通知已经在Zookeeper上注册的那些观察者做出相应的反应。</p>\n<p>作用： 用于服务注册与发现。</p>\n<h5 id=\"工作机制\"><a href=\"#工作机制\" class=\"headerlink\" title=\"工作机制\"></a>工作机制</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102245708.jpg\" alt=\"202305102245820\"></p>\n<h3 id=\"1-2-特点\"><a href=\"#1-2-特点\" class=\"headerlink\" title=\"1.2 特点\"></a>1.2 特点</h3><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102246268.png\" alt=\"image-20230510224624236\"></p>\n<p>1）Zookeeper：一个领导者（Leader），多个跟随者（Follower）组成的集群。</p>\n<p>2）服务器集群中只要有<code>半数以上</code>节点存活，Zookeeper集群就能正常服务。所以Zookeeper适合安装<code>奇数台</code>服务器。</p>\n<p>3）<code>全局数据一致</code>：每个Server保存一份相同的数据副本，Client无论连接到哪个Server，数据都是一致的。</p>\n<p>4）更新请求  <code>顺序执行</code>，来自同一个Client的更新请求按其发送顺序依次执行。</p>\n<p>5）<code>数据更新原子性</code>，一次数据更新要么成功，要么失败。</p>\n<p>6）<code>实时性</code>，在一定时间范围内，Client能读到最新数据。</p>\n<h3 id=\"1-3-数据结构\"><a href=\"#1-3-数据结构\" class=\"headerlink\" title=\"1.3 数据结构\"></a>1.3 数据结构</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2021/png/22423156/1631280096596-59e11257-2791-4bb6-9a7b-5a1a05cc8d60.png\" alt=\"img\"></p>\n<p>ZooKeeper 数据模型的结构与 Unix 文件系统很类似，整体上可以看作是一棵树，每个节点(Server)称做一个 ZNode。</p>\n<p>每一个 ZNode 默认能够存储 1MB 的数据，每个 ZNode 都可以通过其路径唯一标识表示。（就是都可以通过唯一路径找到该节点）</p>\n<h3 id=\"1-4-应用场景\"><a href=\"#1-4-应用场景\" class=\"headerlink\" title=\"1.4 应用场景\"></a>1.4 应用场景</h3><p>提供的服务包括：统一命名服务、统一配置管理、统一集群管理、<code>服务器节点动态上下线</code>、<code>软负载均衡</code>等。</p>\n<h5 id=\"1-4-1-统一命名服务\"><a href=\"#1-4-1-统一命名服务\" class=\"headerlink\" title=\"1.4.1 统一命名服务\"></a>1.4.1 统一命名服务</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102249336.png\" alt=\"image-20230510224907303\"></p>\n<h5 id=\"1-4-2-统一配置管理\"><a href=\"#1-4-2-统一配置管理\" class=\"headerlink\" title=\"1.4.2 统一配置管理\"></a>1.4.2 统一配置管理</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102250425.png\" alt=\"image-20230510225031389\" style=\"zoom:43%;\"></p>\n<p>1）分布式环境下，配置文件同步非常常见。</p>\n<ul>\n<li>一般要求一个集群中，所有节点的配置信息是一致的，比如 Kafka 集群。</li>\n<li>对配置文件修改后，希望能够快速同步到各个节点上。</li>\n</ul>\n<p>2）配置管理可交由ZooKeeper实现。</p>\n<ul>\n<li>可将配置信息写入ZooKeeper上的一个Znode。</li>\n<li>各个<code>客户端服务器监听</code>这个Znode。</li>\n<li>一旦Znode中的数据被修改，ZooKeeper将通知各个客户端服务器。</li>\n</ul>\n<h5 id=\"1-4-3-统一集群管理\"><a href=\"#1-4-3-统一集群管理\" class=\"headerlink\" title=\"1.4.3 统一集群管理\"></a>1.4.3 统一集群管理</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102253748.png\" alt=\"202305102252313\"></p>\n<p>1）分布式环境中，实时掌握每个节点的状态是必要的。</p>\n<ul>\n<li>可根据节点实时状态做出一些调整。</li>\n</ul>\n<p>2）ZooKeeper可以实现实时监控节点状态变化</p>\n<ul>\n<li>可将节点信息写入ZooKeeper上的一个ZNode。（状态信息等等）</li>\n<li>监听这个ZNode可获取它的实时状态变化。</li>\n</ul>\n<h5 id=\"1-4-4-服务器动态上下线\"><a href=\"#1-4-4-服务器动态上下线\" class=\"headerlink\" title=\"1.4.4 服务器动态上下线\"></a>1.4.4 服务器动态上下线</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102253760.png\" alt=\"202305102252903\"></p>\n<h5 id=\"1-4-5-软负载均衡\"><a href=\"#1-4-5-软负载均衡\" class=\"headerlink\" title=\"1.4.5 软负载均衡\"></a>1.4.5 软负载均衡</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102254394.png\" alt=\"image-20230510225429327\"></p>\n<h2 id=\"2-Zookeeper下载及安装\"><a href=\"#2-Zookeeper下载及安装\" class=\"headerlink\" title=\"2. Zookeeper下载及安装\"></a>2. Zookeeper下载及安装</h2><p>需要提前安装jdk</p>\n<p>下载网址：<a href=\"https://zookeeper.apache.org/\">https://zookeeper.apache.org/</a></p>\n<p>将下载的安装包复制到linux下</p>\n<h3 id=\"2-1-安装\"><a href=\"#2-1-安装\" class=\"headerlink\" title=\"2.1 安装\"></a>2.1 安装</h3><h5 id=\"2-1-1-安装前准备\"><a href=\"#2-1-1-安装前准备\" class=\"headerlink\" title=\"2.1.1 安装前准备\"></a>2.1.1 安装前准备</h5><h5 id=\"2-1-2-配置修改\"><a href=\"#2-1-2-配置修改\" class=\"headerlink\" title=\"2.1.2 配置修改\"></a>2.1.2 配置修改</h5><blockquote>\n<p>将/opt/module/zookeeper-3.5.7/conf 这个路径下的 zoo_sample.cfg 修改为zoo.cfg；</p>\n<p>mv zoo_sample.cfg zoo.cfg</p>\n<p>在/usr/local/module/zookeeper-3.5.7目录下创建zkData文件夹</p>\n<p>mkdir zkData</p>\n<p>打开 zoo.cfg 文件，修改 dataDir 路径成以下内容：</p>\n<p>dataDir=/usr/local/module/zookeeper-3.5.7/zkData</p>\n<h5 id=\"端口占用问题\"><a href=\"#端口占用问题\" class=\"headerlink\" title=\"端口占用问题\"></a>端口占用问题</h5><p>zookeeper v3.5启动后会占用8080端口，需要对端口进行修改，以免跟tomcat等发生冲突</p>\n<ul>\n<li>方式一：禁用AdminServer；在zoo.cnf 配置文件中增加配置 <strong>admin.enableServer=false，这样就无法访问Zookeeper AdminServer了。</strong>访问方式：http//:localhost:port/commands</li>\n<li>方式二：修改端口号；在zoo.cnf 配置文件中增加<strong>admin.serverPort=未占用的端口号</strong>，如8090，我这里改成了8022</li>\n</ul>\n<p><a href=\"https://blog.csdn.net/jiangxwa/article/details/118805019\">新版Zookeeper v3.5启动后为什么占用8080端口，如何修改端口？</a></p>\n</blockquote>\n<h5 id=\"2-1-3-操作zookeeper\"><a href=\"#2-1-3-操作zookeeper\" class=\"headerlink\" title=\"2.1.3 操作zookeeper\"></a>2.1.3 <code>操作zookeeper</code></h5><p>启动 Zookeeper  <code>./zkServer.sh start</code> 或者通过路径方式启动  <code>bin/zkServer.sh start</code></p>\n<p>查看进程是否启动  <code>jps</code></p>\n<p>查看状态  <code>bin/zkServer.sh status</code>  或者 <code>./zkServer.sh status</code></p>\n<p>启动客户端   <code>bin/zkCli.sh</code>  <code>./zkCli.sh</code></p>\n<p>客户端内退出  <code>quit</code></p>\n<p>停止Zookeeper  <code>bin/zkServer.sh stop</code>   <code>./zkServer.sh stop</code></p>\n<h3 id=\"2-2-配置文件（conf）参数解读\"><a href=\"#2-2-配置文件（conf）参数解读\" class=\"headerlink\" title=\"2.2 配置文件（conf）参数解读\"></a>2.2 配置文件（conf）参数解读</h3><ul>\n<li><p><strong>tickTime = 2000</strong>：通信心跳时间，Zookeeper服务器与客户端心跳时间，单位毫秒</p>\n</li>\n<li><p><strong>initLimit = 10</strong>:<strong>LF</strong>初始通信时限,Leader和Follower初始连接时能容忍的最多心跳数(tickTime的数量)</p>\n</li>\n<li><p><strong>syncLimit = 5</strong>:<strong>LF</strong>同步通信时限,Leader和Follower之间通信时间如果超过syncLimit * tickTime，Leader认为Follwer死 掉，从服务器列表中删除Follwer。</p>\n</li>\n<li><p><strong>dataDir</strong>:保存Zookeeper中的数据 注意:默认的tmp目录，容易被Linux系统定期删除，所以一般不用默认的tmp目录</p>\n</li>\n<li><p><strong>clientPort = 2181</strong>:客户端连接端口，通常不做修改。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102259796.png\" alt=\"image-20230510225917761\" style=\"zoom:49%;\"></p>\n</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102257097.png\" alt=\"image-20230510225745055\" style=\"zoom:47%;\"></p>\n<h2 id=\"3-Zookeeper-集群操作\"><a href=\"#3-Zookeeper-集群操作\" class=\"headerlink\" title=\"3. Zookeeper 集群操作\"></a>3. Zookeeper 集群操作</h2><h3 id=\"3-1-集群操作\"><a href=\"#3-1-集群操作\" class=\"headerlink\" title=\"3.1 集群操作\"></a>3.1 集群操作</h3><h4 id=\"3-1-1-集群安装\"><a href=\"#3-1-1-集群安装\" class=\"headerlink\" title=\"3.1.1 集群安装\"></a>3.1.1 集群安装</h4><h5 id=\"1）集群规划\"><a href=\"#1）集群规划\" class=\"headerlink\" title=\"1）集群规划\"></a>1）集群规划</h5><p>在三台虚拟机上的三个节点上都部署 Zookeeper。n台服务器需要部署多少台Zookeeper？</p>\n<h5 id=\"2）解压安装\"><a href=\"#2）解压安装\" class=\"headerlink\" title=\"2）解压安装\"></a>2）解压安装</h5><blockquote>\n<p>直接克隆</p>\n</blockquote>\n<h5 id=\"3）配置服务器编号\"><a href=\"#3）配置服务器编号\" class=\"headerlink\" title=\"3）配置服务器编号\"></a>3）配置服务器编号</h5><ul>\n<li>在zookeeper/conf/zkData中（上一步配置修改的dataDir目录）目录下创建一个myid的文件</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> zkData</span><br><span class=\"line\"></span><br><span class=\"line\">vi myid</span><br><span class=\"line\"></span><br><span class=\"line\">xsync  myid</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>问题一：</strong></p>\n<p><strong>xsync脚本</strong></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt;<span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">&gt;<span class=\"comment\"># 1. 判断参数个数</span></span><br><span class=\"line\">&gt;<span class=\"keyword\">if</span> [ <span class=\"variable\">$#</span> -lt 1 ]</span><br><span class=\"line\">&gt;<span class=\"keyword\">then</span></span><br><span class=\"line\">&gt;<span class=\"built_in\">echo</span> Not Enough Argument</span><br><span class=\"line\">&gt;<span class=\"built_in\">exit</span></span><br><span class=\"line\">&gt;<span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">&gt;<span class=\"comment\"># 2. 遍历集群所有机器</span></span><br><span class=\"line\">&gt;<span class=\"keyword\">for</span> host <span class=\"keyword\">in</span> centos7 centos7c1 centos7c2</span><br><span class=\"line\">&gt;<span class=\"keyword\">do</span></span><br><span class=\"line\">&gt;<span class=\"built_in\">echo</span> ================== <span class=\"variable\">$host</span> =====================</span><br><span class=\"line\">&gt;<span class=\"comment\"># 3. 遍历所有目录，逐个发送</span></span><br><span class=\"line\">&gt;<span class=\"keyword\">for</span> file <span class=\"keyword\">in</span> <span class=\"variable\">$@</span></span><br><span class=\"line\">&gt;<span class=\"keyword\">do</span></span><br><span class=\"line\">&gt;<span class=\"comment\"># 4. 判断文件是否存在</span></span><br><span class=\"line\">&gt;<span class=\"keyword\">if</span> [ -e <span class=\"variable\">$file</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"comment\"># 5. 获取父目录</span></span><br><span class=\"line\">  <span class=\"comment\"># -P 如果cd后面是一个软链接，-P可以进入软链接指向的真正文件夹</span></span><br><span class=\"line\">  pdir=$(<span class=\"built_in\">cd</span> -P $(<span class=\"built_in\">dirname</span> <span class=\"variable\">$file</span>); <span class=\"built_in\">pwd</span>)</span><br><span class=\"line\">  <span class=\"comment\"># 6. 获取当前文件名称</span></span><br><span class=\"line\">  fname=$(<span class=\"built_in\">basename</span> <span class=\"variable\">$file</span>)</span><br><span class=\"line\">  <span class=\"comment\"># -p 如果存在则不创建,如果不存在则创建</span></span><br><span class=\"line\">  ssh <span class=\"variable\">$host</span> <span class=\"string\">&quot;mkdir -p <span class=\"variable\">$pdir</span>&quot;</span></span><br><span class=\"line\">  rsync -av <span class=\"variable\">$pdir</span>/<span class=\"variable\">$fname</span> <span class=\"variable\">$host</span>:<span class=\"variable\">$pdir</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"variable\">$file</span> does not exists!</span><br><span class=\"line\">&gt;<span class=\"keyword\">fi</span></span><br><span class=\"line\">&gt;<span class=\"keyword\">done</span></span><br><span class=\"line\">&gt;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt;<span class=\"built_in\">chmod</span> 777 xsync</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;./xsync [文件名]</span><br></pre></td></tr></table></figure>\n<p><strong>问题二：</strong></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101136844.png\" alt=\"image-20230510113612814\" style=\"zoom:33%;\"></p>\n<p><strong>解决：</strong></p>\n<p><strong>三台机器都要添加</strong></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt;vim /etc/hosts </span><br><span class=\"line\"></span><br><span class=\"line\">&gt;-- 添加下面的三行即可</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;172.16.108.139 centos7</span><br><span class=\"line\">&gt;172.16.108.138 centos7c1</span><br><span class=\"line\">&gt;172.16.108.140 centos7c2</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101722577.png\" alt=\"image-20230510172215529\" style=\"zoom:33%;\"></p>\n</blockquote>\n<ul>\n<li><p>在myid文件中添加与 server 对应的编号（注意：上下不要有空行，左右不要有空格）</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101149929.png\" alt=\"image-20230510114941901\" style=\"zoom:33%;\"></p>\n</li>\n</ul>\n<blockquote>\n<p>centos7是 1，centos7c1  是2  centos7c2 是3</p>\n</blockquote>\n<h5 id=\"4）配置zoo-cnf文件\"><a href=\"#4）配置zoo-cnf文件\" class=\"headerlink\" title=\"4）配置zoo.cnf文件\"></a>4）配置zoo.cnf文件</h5><ul>\n<li>(1) 重命名 zoo_sample.cfg 为 zoo.cfg</li>\n<li><p>(2) 打开 zoo.cfg 文件，修改数据存储路径配置</p>\n</li>\n<li><p>修改 dataDir 这里的路径为创建的<strong>zkData的绝对</strong>路径</p>\n</li>\n<li><p>增加如下配置</p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#######################cluster##########################</span></span><br><span class=\"line\">server.1=centos7:2888:3888</span><br><span class=\"line\">server.2=centos7C1:2888:3888</span><br><span class=\"line\">server.3=centos7C2:2888:3888</span><br></pre></td></tr></table></figure>\n<ul>\n<li>配置参数解读  <strong>server.A=B:C:D</strong></li>\n<li><ul>\n<li>A 是一个数字，表示这个是第几号服务器；集群模式下配置一个文件 myid，这个文件在 dataDir 目录下，这个文件里面有一个数据就是 A 的值，Zookeeper 启动时读取此文件，拿到里面的数据与 zoo.cfg 里面的配置信息比较从而判断到底是哪个 server。</li>\n</ul>\n</li>\n<li>B 是这个服务器的地址；  可以直接写ip地址</li>\n<li>C 是这个服务器 Follower 与集群中的 Leader 服务器交换信息的端口；</li>\n<li>D是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的Leader，而这个端口就是用来执行选举时服务器相互通信的端口。</li>\n<li>同步配置文件</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xsync conf/zoo.cfg</span><br></pre></td></tr></table></figure>\n<h5 id=\"5）集群操作\"><a href=\"#5）集群操作\" class=\"headerlink\" title=\"5）集群操作\"></a>5）集群操作</h5><p>分别启动Zookeeper，  <code>bin/zkServer.sh start</code>  查看状态 <code>bin/zkServer.sh status</code></p>\n<p>注意：启动过程中需要有半数以上的服务启动才能启动成功，需要<strong>关闭防火墙</strong></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102306580.png\" alt=\"image-20230510230607549\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102306811.png\" alt=\"image-20230510230627784\"></p>\n<h4 id=\"3-1-2-选举机制（面试重点）\"><a href=\"#3-1-2-选举机制（面试重点）\" class=\"headerlink\" title=\"3.1.2 ==选举机制（面试重点）==\"></a>3.1.2 ==选举机制（面试重点）==</h4><h5 id=\"1-第一次启动\"><a href=\"#1-第一次启动\" class=\"headerlink\" title=\"1.第一次启动\"></a>1.第一次启动</h5><p><img src=\"https://cdn.nlark.com/yuque/0/2021/png/22423156/1631358630025-9d308e7c-30c4-4c70-8481-36bc2417555e.png\" alt=\"img\"></p>\n<ol>\n<li>服务器1启动，发起一次选举。服务器1  投自己一票。此时服务器1票数一票，不够半数以上（3票），选举无法完成，服务器1状态为<strong>LOOKING</strong>；</li>\n<li>服务器2启动，再发起一次选举。服务器2也投自己一票并交换选票信息：此时服务器1发现服务器2的<strong>myid</strong>比之前经投票推举的（服务器1）大，更改服务器1和2的选票，此时服务器1票数0票，服务器2票数2票，没有半数以上结果，选举无法完成，服务器1，2状态保持为<strong>LOOKING</strong>；</li>\n<li>服务器3启动，发起一次选举。同样的此次投票结果：服务器1为0票，服务器2为0票，服务器3为3票。此时服务器3的票数已经超过半数，服务器3当选Leader。服务器1，2更改状态为<strong>FOLLOWING</strong>，服务器3更改状态为<strong>LEADING</strong>；</li>\n<li>服务器4启动，发起一次选举。此时服务器1，2，3已经不是LOOKING状态，不会更改选票信息。交换选票信息结果：服务器3为3票，服务器4为1票。此时服务器4服从多数，更改选票信息为服务器3，并更改状态为<strong>FOLLOWING</strong>；</li>\n<li>服务器5启动，同4一样。</li>\n</ol>\n<blockquote>\n<p>总的来说：当启动的服务器数量没有达到一半以上时，选票会<code>集中</code>投给myid大的服务器，直到达到一半以上时选出leader，一旦选出了leader，无论后面的服务器myid如何，均为follower。</p>\n</blockquote>\n<ul>\n<li><strong>SID</strong>：<code>服务器ID</code>。用来唯一标识一台ZooKeeper集群中的机器，每台机器不能重复，和myid一致。</li>\n<li><strong>ZXID</strong>：<code>事务ID</code>。ZXID是一个事务ID，用来标识一次服务器状态的变更。在某一时刻，集群中的每台机器的ZXID值不一定完全一致，这和ZooKeeper服务器对于客户端“更新请求”的处理逻辑有关。</li>\n<li><strong>Epoch</strong>：每个Leader任期的代号。<ul>\n<li>但是当服务器没有Leader时，同一轮投票过程中的<code>逻辑时钟值</code>是相同的。每投完一次票这个数据就会增加。</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"2-非第一次启动\"><a href=\"#2-非第一次启动\" class=\"headerlink\" title=\"2. 非第一次启动\"></a>2. 非第一次启动</h5><p>1）当ZooKeeper集群中的一台服务器出现以下两种情况之一时，就会开始进入Leader选举：</p>\n<ul>\n<li>服务器初始化启动。</li>\n<li>服务器运行期间无法和Leader保持连接。</li>\n</ul>\n<p>2）而当一台机器进入Leader选举流程时，当前集群也可能会处于以下两种状态：</p>\n<ul>\n<li>集群中本来就已经存在一个Leader。</li>\n<li>对于已经存在Leader的情况，机器试图去选举Leader时，会被告知当前服务器的Leader信息，对于该机器来说，仅仅<code>需要和Leader机器建立连接</code>，并进行状态同步即可。</li>\n<li>集群中确实不存在Leader,就会根据选举规则进行选举</li>\n</ul>\n<blockquote>\n<p>选举<strong>Leader</strong>规则:</p>\n<p>​    1、EPOCH大的直接胜出</p>\n<p>​    2、EPOCH相同，事务id大的胜出</p>\n<p>​    3、事务id相同，服务器id大的胜出</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102314611.png\" alt=\"image-20230510231406584\"></p>\n<h4 id=\"3-1-3-zk集群启动停止脚本\"><a href=\"#3-1-3-zk集群启动停止脚本\" class=\"headerlink\" title=\"3.1.3 zk集群启动停止脚本\"></a>3.1.3 zk集群启动停止脚本</h4><h6 id=\"1）在centos7的-root-bin-目录下创建zk-sh脚本\"><a href=\"#1）在centos7的-root-bin-目录下创建zk-sh脚本\" class=\"headerlink\" title=\"1）在centos7的 /root/bin/目录下创建zk.sh脚本\"></a>1）在centos7的 /root/bin/目录下创建zk.sh脚本</h6><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vim zk.sh</span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"variable\">$1</span> <span class=\"keyword\">in</span></span><br><span class=\"line\"><span class=\"string\">&quot;start&quot;</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span>  172.16.108.139 172.16.108.138 172.16.108.140</span><br><span class=\"line\">        <span class=\"keyword\">do</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> ----------------- zookeeper-3 <span class=\"variable\">$i</span> 启动  --------------------</span><br><span class=\"line\">                ssh <span class=\"variable\">$i</span> <span class=\"string\">&quot;sudo  /ryang/zookeeper/zookeeper-3.5.9/bin/zkServer.sh start&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">done</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">;;</span><br><span class=\"line\"><span class=\"string\">&quot;stop&quot;</span>)&#123;</span><br><span class=\"line\">         <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span>  172.16.108.139 172.16.108.138 172.16.108.140</span><br><span class=\"line\">        <span class=\"keyword\">do</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> ----------------- zookeeper-3 <span class=\"variable\">$i</span> 停止  --------------------</span><br><span class=\"line\">                ssh <span class=\"variable\">$i</span> <span class=\"string\">&quot;sudo /ryang/zookeeper/zookeeper-3.5.9/bin/zkServer.sh stop&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">done</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">;;</span><br><span class=\"line\"><span class=\"string\">&quot;status&quot;</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span>  172.16.108.139 172.16.108.138 172.16.108.140</span><br><span class=\"line\">        <span class=\"keyword\">do</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> ----------------- zookeeper-3 <span class=\"variable\">$i</span> 状态  --------------------</span><br><span class=\"line\">                ssh <span class=\"variable\">$i</span> <span class=\"string\">&quot;sudo /ryang/zookeeper/zookeeper-3.5.9/bin/zkServer.sh  status&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">done</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">;;</span><br><span class=\"line\"><span class=\"keyword\">esac</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>解决CentOS <a href=\"https://blog.csdn.net/single_cong/article/details/103792242\">Zookeeper JAVA_HOME is not set and java could not be found in PATH</a> 问题</p>\n</blockquote>\n<h6 id=\"2）增加脚本执行权限\"><a href=\"#2）增加脚本执行权限\" class=\"headerlink\" title=\"2）增加脚本执行权限\"></a>2）增加脚本执行权限</h6><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> 777 zk.sh</span><br></pre></td></tr></table></figure>\n<h6 id=\"3）Zookeeper-集群启动脚本\"><a href=\"#3）Zookeeper-集群启动脚本\" class=\"headerlink\" title=\"3）Zookeeper 集群启动脚本\"></a>3）Zookeeper 集群启动脚本</h6><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./zk.sh start</span><br></pre></td></tr></table></figure>\n<h6 id=\"4）Zookeeper-集群停止脚本\"><a href=\"#4）Zookeeper-集群停止脚本\" class=\"headerlink\" title=\"4）Zookeeper 集群停止脚本\"></a>4）Zookeeper 集群停止脚本</h6><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./zk.sh stop</span><br></pre></td></tr></table></figure>\n<h6 id=\"5）jpsall\"><a href=\"#5）jpsall\" class=\"headerlink\" title=\"5）jpsall\"></a>5）jpsall</h6><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> host <span class=\"keyword\">in</span> centos7 centos7c1 centos7c2</span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> =============== <span class=\"variable\">$host</span> ===============</span><br><span class=\"line\">        ssh <span class=\"variable\">$host</span> jps</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n<h6 id=\"6）通过jpsall查看\"><a href=\"#6）通过jpsall查看\" class=\"headerlink\" title=\"6）通过jpsall查看\"></a>6）通过jpsall查看</h6><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jpsall</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102316060.png\" alt=\"image-20230510231627027\" style=\"zoom:33%;\"></p>\n<h3 id=\"3-2-客户端命令行操作\"><a href=\"#3-2-客户端命令行操作\" class=\"headerlink\" title=\"3.2 客户端命令行操作\"></a>3.2 客户端命令行操作</h3><h4 id=\"3-2-1-命令行语法\"><a href=\"#3-2-1-命令行语法\" class=\"headerlink\" title=\"3.2.1 命令行语法\"></a>3.2.1 命令行语法</h4><ul>\n<li>启动客户端   <code>bin/zkCli.sh -server centos7:2181</code>  这里centos7是服务器域名也就是ip的别名</li>\n<li>显示所有操作命令  <code>help</code></li>\n</ul>\n<h4 id=\"3-2-2-znode节点数据信息\"><a href=\"#3-2-2-znode节点数据信息\" class=\"headerlink\" title=\"3.2.2 znode节点数据信息\"></a>3.2.2 znode节点数据信息</h4><ul>\n<li><p>查看当前znode中所包含的内容  <code>ls /</code></p>\n</li>\n<li><p>查看当前节点详细数据  <code>ls -s /</code></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102319272.png\" alt=\"image-20230510231949236\"></p>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1)czxid:创建节点的事务 zxid  </span><br><span class=\"line\">\t每次修改ZooKeeper状态都会产生一个ZooKeeper事务ID。事务ID是ZooKeeper中所有修改总的次序。每次修改都有唯一的 zxid，如果 zxid1 小于 zxid2，那么 zxid1 在 zxid2 之 前发生。</span><br><span class=\"line\">\t</span><br><span class=\"line\">2)ctime:znode 被创建的毫秒数(从 1970 年开始)</span><br><span class=\"line\"></span><br><span class=\"line\">3)mzxid:znode 最后更新的事务 zxid </span><br><span class=\"line\"></span><br><span class=\"line\">4)mtime:znode 最后修改的毫秒数(从 1970 年开始) </span><br><span class=\"line\"></span><br><span class=\"line\">5)pZxid:znode 最后更新的子节点 zxid</span><br><span class=\"line\"></span><br><span class=\"line\">6)cversion:znode 子节点变化号，znode 子节点修改次数 </span><br><span class=\"line\"></span><br><span class=\"line\">7)dataversion:znode 数据变化号 </span><br><span class=\"line\"></span><br><span class=\"line\">8)aclVersion:znode 访问控制列表的变化号</span><br><span class=\"line\"></span><br><span class=\"line\">9)ephemeralOwner:如果是临时节点，这个是 znode 拥有者的 session <span class=\"built_in\">id</span>。如果不是 临时节点则是 0</span><br><span class=\"line\"></span><br><span class=\"line\">10)dataLength:znode 的数据长度 </span><br><span class=\"line\"></span><br><span class=\"line\">11)numChildren:znode 子节点数量</span><br></pre></td></tr></table></figure>\n<h4 id=\"3-2-3-节点类型（持久-短暂-有序号-无序号）\"><a href=\"#3-2-3-节点类型（持久-短暂-有序号-无序号）\" class=\"headerlink\" title=\"3.2.3 节点类型（持久/短暂/有序号/无序号）\"></a>3.2.3 节点类型（持久/短暂/有序号/无序号）</h4><ul>\n<li><p><code>持久（Persistent）</code>：客户端和服务器端断开连接后，创建的节点（服务器）不删除</p>\n<ul>\n<li><p>持久化目录节点：客户端与Zookeeper断开连接后，该节点依旧存在</p>\n</li>\n<li><p>持久化顺序编号目录节点：客户端与Zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号</p>\n</li>\n</ul>\n</li>\n<li><p><code>短暂（Ephemeral）</code>：客户端和服务器端断开连接后，创建的节点（服务器）自己删除</p>\n<ul>\n<li>临时目录节点：客户端与Zookeeper断开连接后，该节点被删除</li>\n<li>临时顺序编号目录节点：客户端与 Zookeeper 断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号。</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102323092.png\" alt=\"image-20230510232332062\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>说明：创建znode时设置顺序标识，znode名称后会附加一个值，顺序号是一个单调递增的计数器，由父节点维护</p>\n<p>注意：在分布式系统中，顺序号可以被用于为所有的事件进行全局排序，这样客户端可以通过顺序号推断事件的顺序</p>\n</blockquote>\n<h6 id=\"1）分别创建2个普通节点（永久节点-不带序号）\"><a href=\"#1）分别创建2个普通节点（永久节点-不带序号）\" class=\"headerlink\" title=\"1）分别创建2个普通节点（永久节点 + 不带序号）\"></a>1）分别创建2个普通节点（永久节点 + 不带序号）</h6><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create /sanguo <span class=\"string\">&quot;diaochan&quot;</span>     </span><br><span class=\"line\"></span><br><span class=\"line\">create /sanguo/shuguo <span class=\"string\">&quot;liubei&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">ls</span> /sanguo</span><br></pre></td></tr></table></figure>\n<h6 id=\"2）获得节点的值\"><a href=\"#2）获得节点的值\" class=\"headerlink\" title=\"2）获得节点的值\"></a>2）获得节点的值</h6><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">get -s /sanguo  </span><br></pre></td></tr></table></figure>\n<h6 id=\"3）创建带序号的节点（永久节点-带序号）\"><a href=\"#3）创建带序号的节点（永久节点-带序号）\" class=\"headerlink\" title=\"3）创建带序号的节点（永久节点 + 带序号）\"></a>3）创建带序号的节点（永久节点 + 带序号）</h6><p>（1）先创建一个普通的根节点/sanguo/weiguo</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create /sanguo/weiguo <span class=\"string\">&quot;caocao&quot;</span></span><br></pre></td></tr></table></figure>\n<p>（2）创建带序号的节点（可重复，序号递增</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create -s /sanguo/weiguo/zhangliao <span class=\"string\">&quot;zhangliao&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">create -s /sanguo/weiguo/zhangliao <span class=\"string\">&quot;zhangliao&quot;</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>如果原来没有序号节点，序号从 0 开始依次递增。如果原节点下已有 2 个节点，则再排序时从 2 开始，以此类推。</p>\n</blockquote>\n<h6 id=\"4）创建短暂节点（短暂节点-不带序号-or-带序号）\"><a href=\"#4）创建短暂节点（短暂节点-不带序号-or-带序号）\" class=\"headerlink\" title=\"4）创建短暂节点（短暂节点 + 不带序号 or 带序号）\"></a>4）创建短暂节点（短暂节点 + 不带序号 or 带序号）</h6><p>（1）创建短暂的不带序号的节点</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create -e /sanguo/wuguo <span class=\"string\">&quot;zhouyu&quot;</span></span><br></pre></td></tr></table></figure>\n<p>（2）创建短暂的带序号的节点</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create -e -s /sanguo/wuguo <span class=\"string\">&quot;zhouyu&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">ls</span> /sanguo</span><br></pre></td></tr></table></figure>\n<h6 id=\"5）修改节点数据值\"><a href=\"#5）修改节点数据值\" class=\"headerlink\" title=\"5）修改节点数据值\"></a>5）修改节点数据值</h6><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--将weiguo的caocao改为simayi</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">set</span> /sanguo/weiguo <span class=\"string\">&quot;simayi&quot;</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102327469.jpg\" alt=\"202305102327469\" style=\"zoom:33%;\"></p>\n<h4 id=\"3-2-4-监听器原理\"><a href=\"#3-2-4-监听器原理\" class=\"headerlink\" title=\"3.2.4 监听器原理\"></a>3.2.4 <code>监听器原理</code></h4><h5 id=\"1、监听器原理详解\"><a href=\"#1、监听器原理详解\" class=\"headerlink\" title=\"1、监听器原理详解\"></a>1、监听器原理详解</h5><p>1）首先要有一个main()线程</p>\n<p>2）在main线程中创建<code>Zookeeper客户端</code>，这时就会创建两个线程，一个负责网络连接通信（connet），一个负责监听（listener）。</p>\n<p>3）通过connect线程将注册的监听事件发送给Zookeeper。（告诉服务端我要监听什么）</p>\n<p>4）在Zookeeper的注册监听器列表中将注册的监听事件添加到列表中。</p>\n<p>5）Zookeeper监听到有数据或路径变化，就会将这个消息发送给listener线程。（告诉客户端监听的东西发生了变化）</p>\n<p>6）listener线程内部调用了process()方法；进行数据获取的一个处理。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102328542.png\" alt=\"image-20230510232836454\"></p>\n<h5 id=\"2、常见的监听\"><a href=\"#2、常见的监听\" class=\"headerlink\" title=\"2、常见的监听\"></a>2、常见的监听</h5><p>1）监听节点数据的变化</p>\n<p><code>get path [watch]</code></p>\n<p>2）监听子节点增减的变化</p>\n<p><code>ls path [watch]</code></p>\n<h5 id=\"3、演示案例\"><a href=\"#3、演示案例\" class=\"headerlink\" title=\"3、演示案例\"></a>3、演示案例</h5><h6 id=\"1）节点的值变化监听\"><a href=\"#1）节点的值变化监听\" class=\"headerlink\" title=\"1）节点的值变化监听\"></a>1）节点的值变化监听</h6><blockquote>\n<p><strong>注意</strong>：在centos7c1 上多次修改/sanguo的值，centos7上不会再收到监听。因为注册一次，只能监听一次。想再次监听，需要再次注册</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102331261.png\" alt=\"image-20230510233151227\" style=\"zoom:33%;\"></p>\n<h6 id=\"2）节点的子节点变化监听（路径变化）\"><a href=\"#2）节点的子节点变化监听（路径变化）\" class=\"headerlink\" title=\"2）节点的子节点变化监听（路径变化）\"></a>2）节点的子节点变化监听（路径变化）</h6><blockquote>\n<p><strong>注意：</strong>同节点值一样，节点的路径变化，也是注册一次，生效一次。想多次生效，就需要多次注册。</p>\n</blockquote>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102332077.png\" alt=\"image-20230510233233043\" style=\"zoom: 34%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102332171.png\" alt=\"image-20230510233256143\" style=\"zoom:33%;\"></p>\n<h5 id=\"3-2-5-节点删除与查看\"><a href=\"#3-2-5-节点删除与查看\" class=\"headerlink\" title=\"3.2.5 节点删除与查看\"></a>3.2.5 节点删除与查看</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102333575.png\" alt=\"image-20230510233327546\" style=\"zoom:33%;\"></p>\n<h3 id=\"3-3-客户端-API-操作\"><a href=\"#3-3-客户端-API-操作\" class=\"headerlink\" title=\"3.3 客户端 API 操作\"></a>3.3 客户端 API 操作</h3><p><strong>前提</strong>：保证 centos7、centos7c1、centos7c2 服务器上 Zookeeper 集群服务端启动。</p>\n<h5 id=\"3-3-1-IDEA-环境搭建\"><a href=\"#3-3-1-IDEA-环境搭建\" class=\"headerlink\" title=\"3.3.1 IDEA 环境搭建\"></a>3.3.1 IDEA 环境搭建</h5><p>1）创建一个工程：zookeeper</p>\n<p>2）添加pom文件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">       </span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>junit<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>junit<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">       </span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.logging.log4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>log4j-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.8.2<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">       </span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.zookeeper<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>zookeeper<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.5.9<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">       </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>3）拷贝log4j.properties文件到项目根目录</p>\n<p>需要在项目的 src/main/resources 目录下，新建一个文件，命名为“log4j.properties”，在文件中填入。</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">log4j.rootLogger</span>=<span class=\"string\">INFO, stdout </span></span><br><span class=\"line\"><span class=\"attr\">log4j.appender.stdout</span>=<span class=\"string\">org.apache.log4j.ConsoleAppender </span></span><br><span class=\"line\"><span class=\"attr\">log4j.appender.stdout.layout</span>=<span class=\"string\">org.apache.log4j.PatternLayout </span></span><br><span class=\"line\"><span class=\"attr\">log4j.appender.stdout.layout.ConversionPattern</span>=<span class=\"string\">%d %p [%c]- %m%n </span></span><br><span class=\"line\"><span class=\"attr\">log4j.appender.logfile</span>=<span class=\"string\">org.apache.log4j.FileAppender </span></span><br><span class=\"line\"><span class=\"attr\">log4j.appender.logfile.File</span>=<span class=\"string\">target/spring.log </span></span><br><span class=\"line\"><span class=\"attr\">log4j.appender.logfile.layout</span>=<span class=\"string\">org.apache.log4j.PatternLayout </span></span><br><span class=\"line\"><span class=\"attr\">log4j.appender.logfile.layout.ConversionPattern</span>=<span class=\"string\">%d %p [%c]- %m%n </span></span><br></pre></td></tr></table></figure>\n<p>4）创建包</p>\n<p>5）创建类</p>\n<h5 id=\"3-3-2-创建-ZooKeeper-客户端\"><a href=\"#3-3-2-创建-ZooKeeper-客户端\" class=\"headerlink\" title=\"3.3.2 创建 ZooKeeper 客户端\"></a>3.3.2 创建 ZooKeeper 客户端</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ZkClient</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//这里注意,前后不能有空格</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">String</span> <span class=\"variable\">connectString</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;172.16.108.139:2181,172.16.108.138:2181,172.16.108.140:2181&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">sessionTimeout</span> <span class=\"operator\">=</span> <span class=\"number\">200000</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> ZooKeeper zooKeeper;</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"comment\">//创建 ZooKeeper 客户端</span></span><br><span class=\"line\">    <span class=\"meta\">@Before</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">        zooKeeper = <span class=\"keyword\">new</span> <span class=\"title class_\">ZooKeeper</span>(connectString, sessionTimeout, <span class=\"keyword\">new</span> <span class=\"title class_\">Watcher</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">process</span><span class=\"params\">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"3-3-3-创建子节点\"><a href=\"#3-3-3-创建子节点\" class=\"headerlink\" title=\"3.3.3 创建子节点\"></a>3.3.3 创建子节点</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Test</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">create</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException, KeeperException &#123;</span><br><span class=\"line\">    <span class=\"comment\">//string  转为  字节 getBytes()</span></span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">nodeCreated</span> <span class=\"operator\">=</span> zooKeeper.create(<span class=\"string\">&quot;/ry&quot;</span>, <span class=\"string\">&quot;ry.can&quot;</span>.getBytes(),</span><br><span class=\"line\">            ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101736032.png\" style=\"zoom:33%;\"><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101736146.png\" alt=\"image-20230510173615073\" style=\"zoom:33%;\"><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101736865.png\" alt=\"image-20230510173635832\" style=\"zoom: 33%;\"></p>\n<h5 id=\"3-3-4-获取子节点并监听节点变化\"><a href=\"#3-3-4-获取子节点并监听节点变化\" class=\"headerlink\" title=\"3.3.4 获取子节点并监听节点变化\"></a>3.3.4 获取子节点并监听节点变化</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Before</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">    zooKeeper = <span class=\"keyword\">new</span> <span class=\"title class_\">ZooKeeper</span>(connectString, sessionTimeout, <span class=\"keyword\">new</span> <span class=\"title class_\">Watcher</span>() &#123;</span><br><span class=\"line\">        <span class=\"comment\">//process中是需要再次配置监听的e，因为每次发生变化后监听都会失效，需要重新监听</span></span><br><span class=\"line\">        <span class=\"comment\">//而process方法是在每次监听内容发生变化后执行</span></span><br><span class=\"line\">        <span class=\"comment\">//因此在process中再次进行监听，可以达到反复监听的效果</span></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">process</span><span class=\"params\">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">// 每次监听前都要去进行 注册，防止 监听失效</span></span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;--------------------------------------&quot;</span>);</span><br><span class=\"line\">            List&lt;String&gt; children = <span class=\"literal\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                children = zooKeeper.getChildren(<span class=\"string\">&quot;/&quot;</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (String child : children) &#123;</span><br><span class=\"line\">                    System.out.println(child);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;--------------------------------------&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (KeeperException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Test</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">getChildren</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException, KeeperException &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获得所有集合的 子节点</span></span><br><span class=\"line\">    List&lt;String&gt; children = zooKeeper.getChildren(<span class=\"string\">&quot;/&quot;</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (String child : children) &#123;</span><br><span class=\"line\">        System.out.println(child);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  延时结束， 不结束，继续监听，使得在linux上操作还可以继续监听到</span></span><br><span class=\"line\">    Thread.sleep(Long.MAX_VALUE);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"3-3-5-判断-Znode-是否存在\"><a href=\"#3-3-5-判断-Znode-是否存在\" class=\"headerlink\" title=\"3.3.5 判断 Znode 是否存在\"></a>3.3.5 判断 Znode 是否存在</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 判断 znode 是否存在</span></span><br><span class=\"line\"><span class=\"meta\">@Test</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">exist</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException, KeeperException &#123;</span><br><span class=\"line\">    <span class=\"type\">Stat</span> <span class=\"variable\">stat</span> <span class=\"operator\">=</span> zooKeeper.exists(<span class=\"string\">&quot;/atguigu&quot;</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">    System.out.println(stat == <span class=\"literal\">null</span> ? <span class=\"string\">&quot;不存在&quot;</span> : <span class=\"string\">&quot;存在&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-4-客户端向服务端写数据流程\"><a href=\"#3-4-客户端向服务端写数据流程\" class=\"headerlink\" title=\"3.4 客户端向服务端写数据流程\"></a>3.4 客户端向服务端写数据流程</h3><h5 id=\"3-4-1-写流程之写入请求直接发送给Leader节点\"><a href=\"#3-4-1-写流程之写入请求直接发送给Leader节点\" class=\"headerlink\" title=\"3.4.1 写流程之写入请求直接发送给Leader节点\"></a>3.4.1 写流程之写入请求直接发送给Leader节点</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101752427.png\" alt=\"image-20230510175204390\" style=\"zoom:33%;\"></p>\n<ul>\n<li><p>客户端发送写请求给Leader</p>\n</li>\n<li><p>Leader收到后会自己执行写请求</p>\n</li>\n<li><p>然后将写请求发送给Follower让其执行（同步）</p>\n</li>\n<li><p>Follower同步后会返回一个ack给Leader</p>\n</li>\n<li><p>当集群上<code>超过半数服务器</code>完成了写请求，那么Leader会发送ack通知Client已完成请求</p>\n</li>\n<li><p>剩下的Follower会继续写数据同步信息，直到集群中所有的服务器均完成同步。</p>\n</li>\n</ul>\n<blockquote>\n<p>半数的所有节点（此处为3）写完就会进行应答</p>\n</blockquote>\n<h5 id=\"3-4-2-写流程之写入请求发送给follower节点\"><a href=\"#3-4-2-写流程之写入请求发送给follower节点\" class=\"headerlink\" title=\"3.4.2 写流程之写入请求发送给follower节点\"></a>3.4.2 写流程之写入请求发送给follower节点</h5><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305100115363.png\" alt=\"img\"></p>\n<ul>\n<li><p>客户端发送写请求给Follower</p>\n</li>\n<li><p>Follower将写请求转发给Leader</p>\n</li>\n<li><p>Leader处理写请求，然后将写请求发送给Follower让其执行（同步），Follower同步后会返回一个<code>ack</code>给Leader</p>\n</li>\n<li>当集群上<code>超过半数服务器</code>完成了写请求，Leader会发送一个<code>ack</code>给接收Client的Follower ，告诉其半数服务器已完成同步</li>\n<li>随后Follower会发送ack通知Client已完成请求；剩下的Follower会<code>继续写数据</code>同步信息，直到集群中所有的服务器均完成同步</li>\n</ul>\n<h2 id=\"第-4-章-服务器动态上下线监听案例\"><a href=\"#第-4-章-服务器动态上下线监听案例\" class=\"headerlink\" title=\"第 4 章 服务器动态上下线监听案例\"></a>第 4 章 服务器动态上下线监听案例</h2><h4 id=\"4-1-需求\"><a href=\"#4-1-需求\" class=\"headerlink\" title=\"4.1 需求\"></a>4.1 需求</h4><p>某分布式系统中，主节点可以有多台，可以<code>动态上下线</code>，任意一台客户端都能<code>实时感知到主节点服务器的上下线</code>。</p>\n<h4 id=\"4-2-需求分析\"><a href=\"#4-2-需求分析\" class=\"headerlink\" title=\"4.2 需求分析\"></a>4.2 需求分析</h4><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101803478.png\" alt=\"image-20230510180332407\" style=\"zoom:33%;\"></p>\n<h4 id=\"4-3-具体实现\"><a href=\"#4-3-具体实现\" class=\"headerlink\" title=\"4.3 具体实现\"></a>4.3 具体实现</h4><h5 id=\"（1）先在集群上创建-servers节点\"><a href=\"#（1）先在集群上创建-servers节点\" class=\"headerlink\" title=\"（1）先在集群上创建/servers节点\"></a>（1）先在集群上创建<code>/servers</code>节点</h5><p>​    <code>create /servers &quot;servers&quot;</code></p>\n<h5 id=\"（2）在-Idea-中创建包\"><a href=\"#（2）在-Idea-中创建包\" class=\"headerlink\" title=\"（2）在 Idea 中创建包\"></a>（2）在 Idea 中创建包</h5><h5 id=\"（3）服务器端客户端向-Zookeeper-注册代码\"><a href=\"#（3）服务器端客户端向-Zookeeper-注册代码\" class=\"headerlink\" title=\"（3）服务器端客户端向 Zookeeper 注册代码\"></a>（3）服务器端客户端向 Zookeeper 注册代码</h5><h6 id=\"服务器端\"><a href=\"#服务器端\" class=\"headerlink\" title=\"服务器端\"></a>服务器端</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.zk.test1;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.zookeeper.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 1、连接到服务器</span></span><br><span class=\"line\"><span class=\"comment\"> * 2、注册到服务器上</span></span><br><span class=\"line\"><span class=\"comment\"> * 3、启动业务逻辑</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DistributeServer</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ZooKeeper zk;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">String</span> <span class=\"variable\">connectString</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;172.16.108.139:2181,172.16.108.138:2181,172.16.108.140:2181&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">sessionTimeout</span> <span class=\"operator\">=</span> <span class=\"number\">200000</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//封装 连接</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">getConnection</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">        zk = <span class=\"keyword\">new</span> <span class=\"title class_\">ZooKeeper</span>(connectString, sessionTimeout, <span class=\"keyword\">new</span> <span class=\"title class_\">Watcher</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">process</span><span class=\"params\">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> IOException, InterruptedException, KeeperException &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">DistributeServer</span> <span class=\"variable\">server</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">DistributeServer</span>();</span><br><span class=\"line\">        <span class=\"comment\">//1 获取zk连接</span></span><br><span class=\"line\">        server.getConnection();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//2 注册服务器到zk集群</span></span><br><span class=\"line\">        server.regist(args[<span class=\"number\">0</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//3 启动业务逻辑（sleep）</span></span><br><span class=\"line\">        server.business();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">business</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException &#123;</span><br><span class=\"line\">        Thread.sleep(Long.MAX_VALUE);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 传入主机名称</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">regist</span><span class=\"params\">(String hostName)</span> <span class=\"keyword\">throws</span> InterruptedException, KeeperException &#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">create</span> <span class=\"operator\">=</span> zk.create(<span class=\"string\">&quot;/servers/&quot;</span> + hostName, hostName.getBytes(),</span><br><span class=\"line\">                ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);   <span class=\"comment\">// 创建临时节点   EPHEMERAL_SEQUENTIAL</span></span><br><span class=\"line\">        System.out.println(hostName + <span class=\"string\">&quot;已经上线********&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"客户端\"><a href=\"#客户端\" class=\"headerlink\" title=\"客户端\"></a>客户端</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.zk.test1;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.zookeeper.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DistributeClient</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> ZooKeeper zk;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">String</span> <span class=\"variable\">connectString</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;172.16.108.139:2181,172.16.108.138:2181,172.16.108.140:2181&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">sessionTimeout</span> <span class=\"operator\">=</span> <span class=\"number\">200000</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 创建到 zk 的客户端连接</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">getConnect</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">        zk = <span class=\"keyword\">new</span> <span class=\"title class_\">ZooKeeper</span>(connectString, sessionTimeout, <span class=\"keyword\">new</span> <span class=\"title class_\">Watcher</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">process</span><span class=\"params\">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    getServerList();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (KeeperException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> IOException, InterruptedException, KeeperException &#123;</span><br><span class=\"line\">        <span class=\"type\">DistributeClient</span> <span class=\"variable\">client</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">DistributeClient</span>();</span><br><span class=\"line\">        <span class=\"comment\">//1 获取zk连接</span></span><br><span class=\"line\">        client.getConnect();</span><br><span class=\"line\">        <span class=\"comment\">//2 监听/servers下面子节点的增加和删除</span></span><br><span class=\"line\">        client.getServerList();</span><br><span class=\"line\">        <span class=\"comment\">//3 业务逻辑(sleep)</span></span><br><span class=\"line\">        client.business();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 获取服务器列表信息</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">getServerList</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException, KeeperException &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 1 获取服务器子节点信息，并且对父节点进行监听  获取 server1  server2 server3</span></span><br><span class=\"line\">        List&lt;String&gt; children = zk.getChildren(<span class=\"string\">&quot;/servers&quot;</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 2 存储服务器信息列表</span></span><br><span class=\"line\">        ArrayList&lt;String&gt; servers = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">        <span class=\"comment\">// 3 遍历所有节点，获取节点中的主机名称信息</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String child : children) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//path : 路径拼接    取出主机名称</span></span><br><span class=\"line\">            <span class=\"type\">byte</span>[] data = zk.getData(<span class=\"string\">&quot;/servers/&quot;</span> + child, <span class=\"literal\">false</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">            servers.add(<span class=\"keyword\">new</span> <span class=\"title class_\">String</span>(data));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 4 打印服务器列表信息</span></span><br><span class=\"line\">        System.out.println(servers);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 业务功能</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">business</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;client is working ...&quot;</span>);</span><br><span class=\"line\">        Thread.sleep(Long.MAX_VALUE);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"4-4-测试\"><a href=\"#4-4-测试\" class=\"headerlink\" title=\"4.4 测试\"></a>4.4 测试</h4><ul>\n<li>测试一: 只启动客户端并 在 linux 上操作 观察客户端控制台的打印</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101901430.png\" alt=\"image-20230510190111389\" style=\"zoom:33%;\"></p>\n<ul>\n<li>测试二： 测试服务端，观察客户端的响应</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//2 注册服务器到zk集群</span></span><br><span class=\"line\">server.regist(args[<span class=\"number\">0</span>]);   -- 需要进配置的原因</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101903215.png\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101906617.png\" alt=\"image-20230510190650555\" style=\"zoom: 50%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101907847.png\" style=\"zoom:33%;\"></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305101908260.png\" alt=\"image-20230510190814219\" style=\"zoom:43%;\"></p>\n<h2 id=\"第-5-章-ZooKeeper-分布式锁案例\"><a href=\"#第-5-章-ZooKeeper-分布式锁案例\" class=\"headerlink\" title=\"第 5 章 ZooKeeper 分布式锁案例\"></a>第 5 章 ZooKeeper 分布式锁案例</h2><h4 id=\"什么叫做分布式锁呢？\"><a href=\"#什么叫做分布式锁呢？\" class=\"headerlink\" title=\"什么叫做分布式锁呢？\"></a>什么叫做分布式锁呢？</h4><ul>\n<li>比如说<code>进程 1</code>在使用该资源的时候，会先去获得锁</li>\n<li><code>进程 1</code>获得锁以后会对该资源 保持独占，这样<code>其他进程</code>就无法访问该资源</li>\n<li><code>进程 1</code>用完该资源以后就将锁释放掉，让<code>其他进程</code>来获得锁，</li>\n</ul>\n<p>那么通过这个锁机制，我们就能保证了分布式系统中多个进程能够有序的访问该临界资源。</p>\n<p>我们把这个分布式环境下的这个锁叫作分布式锁。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305100115958.png\" alt=\"img\" style=\"zoom:33%;\"></p>\n<h4 id=\"5-1-原生-Zookeeper-实现分布式锁案例\"><a href=\"#5-1-原生-Zookeeper-实现分布式锁案例\" class=\"headerlink\" title=\"5.1 原生 Zookeeper 实现分布式锁案例\"></a>5.1 原生 Zookeeper 实现分布式锁案例</h4><h5 id=\"1）分布式锁实现\"><a href=\"#1）分布式锁实现\" class=\"headerlink\" title=\"1）分布式锁实现\"></a>1）分布式锁实现</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.zk.test2;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.zookeeper.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.zookeeper.data.Stat;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.charset.StandardCharsets;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Collections;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.CountDownLatch;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 客户端与 服务器建立连接   ====== 创建zk</span></span><br><span class=\"line\"><span class=\"comment\"> *      延时等待 让zk 进行正常链接</span></span><br><span class=\"line\"><span class=\"comment\"> * 判断 /locks 的根节点是否存在，不存在的话就进行创建</span></span><br><span class=\"line\"><span class=\"comment\"> * 加锁： 创建节点，并判断这个节点是不是序号最小的</span></span><br><span class=\"line\"><span class=\"comment\"> *          如何判断： 有节点个数进行判断</span></span><br><span class=\"line\"><span class=\"comment\"> *                          如果： 个数是 1 ，那就是最小的</span></span><br><span class=\"line\"><span class=\"comment\"> *                          不是的话就进行排序，并得到自己所在的位置 index</span></span><br><span class=\"line\"><span class=\"comment\"> *                                  如果：  index &lt;0 ， 那就异常</span></span><br><span class=\"line\"><span class=\"comment\"> *                                  如果：  index  = 0  ， 那就最小的  直接获取（return）</span></span><br><span class=\"line\"><span class=\"comment\"> *                                  如果：  index &gt;0 ， 那就监听上一个节点的变化，（递归）</span></span><br><span class=\"line\"><span class=\"comment\"> *                          直到监听器（watch()）中  /locks 有节点删除 并且删除的节点是创建的节点的前一个</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * 解锁  直接删除创建的节点</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">distributeLock</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">String</span> <span class=\"variable\">connecting</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;172.16.108.139:2181,172.16.108.138:2181,172.16.108.140:2181&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span>  <span class=\"keyword\">final</span> <span class=\"type\">int</span>  <span class=\"variable\">sessionTimeOut</span>  <span class=\"operator\">=</span> <span class=\"number\">200000</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ZooKeeper zk ;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">CountDownLatch</span> <span class=\"variable\">countDownLatch</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">CountDownLatch</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">CountDownLatch</span> <span class=\"variable\">waitLatch</span>  <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">CountDownLatch</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//前一个节点的路径记录的变量</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String  waitPath;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span>  <span class=\"title function_\">distributeLock</span> <span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">//获取 连接</span></span><br><span class=\"line\">        zk = <span class=\"keyword\">new</span> <span class=\"title class_\">ZooKeeper</span>(connecting, sessionTimeOut, <span class=\"keyword\">new</span> <span class=\"title class_\">Watcher</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">process</span><span class=\"params\">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//countDownLatch  连接到 zk 之后就要进行释放</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span>(watchedEvent.getState() == Event.KeeperState.SyncConnected)&#123;</span><br><span class=\"line\">                    countDownLatch.countDown();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">//waitLatch 也进行释</span></span><br><span class=\"line\">                <span class=\"comment\">//当前一个节点被删除的时候waitLatch释放</span></span><br><span class=\"line\">                <span class=\"comment\">//判断操作是否是删除节点，同时删除的节点是当前节点的前一个（监听的那个），如果是则释放</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span>(watchedEvent.getType() == Event.EventType.NodeDeleted &amp;&amp; watchedEvent.getPath().equals(waitPath))&#123;</span><br><span class=\"line\">                    waitLatch.countDown();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">        <span class=\"comment\">//等待 zk 进程正常连接之后才会往下走</span></span><br><span class=\"line\">        countDownLatch.await();</span><br><span class=\"line\">        <span class=\"comment\">//判断根节点是否存在</span></span><br><span class=\"line\">        <span class=\"type\">Stat</span> <span class=\"variable\">stat</span> <span class=\"operator\">=</span> zk.exists(<span class=\"string\">&quot;/locks&quot;</span>,<span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(stat == <span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">            <span class=\"comment\">//创建根节点</span></span><br><span class=\"line\">            zk.create(<span class=\"string\">&quot;/locks&quot;</span>,<span class=\"string\">&quot;locks&quot;</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    String CurrentMode;</span><br><span class=\"line\">    <span class=\"comment\">//对 zk 加锁</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">zkLock</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 对应的临时带序号的节点</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">             CurrentMode = zk.create(<span class=\"string\">&quot;/locks/&quot;</span> + <span class=\"string\">&quot;seq-&quot;</span>,<span class=\"literal\">null</span>,ZooDefs.Ids.OPEN_ACL_UNSAFE , CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class=\"line\">            <span class=\"comment\">// 判断创建的节点是否是最小的序号节点，</span></span><br><span class=\"line\">            List&lt;String&gt; children = zk.getChildren(<span class=\"string\">&quot;/locks&quot;</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 如果children 只有一个节点 就获取到 锁</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(children.size() == <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> ;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 如果children 不止一个节点 就监听 这个序号的前一个节点</span></span><br><span class=\"line\">                <span class=\"comment\">// 进行排序</span></span><br><span class=\"line\">                Collections.sort(children);</span><br><span class=\"line\">                <span class=\"comment\">//获取节点名称  seq-xxxxxxxxxx</span></span><br><span class=\"line\">                <span class=\"type\">String</span> <span class=\"variable\">site</span> <span class=\"operator\">=</span> CurrentMode.substring(<span class=\"string\">&quot;/locks/&quot;</span>.length());</span><br><span class=\"line\">                <span class=\"comment\">//获取到 seq-xxxxxxxxxx 的节点 在 children 集合中的位置</span></span><br><span class=\"line\">                <span class=\"type\">int</span>  <span class=\"variable\">index</span> <span class=\"operator\">=</span> children.indexOf(site);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">//判断</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span>(index == -<span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;数据异常&quot;</span>);</span><br><span class=\"line\">                &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(index == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">                    <span class=\"comment\">//直接让下一个节点进行获取到锁</span></span><br><span class=\"line\">                    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//进行监听  要获得前一个节点的变化</span></span><br><span class=\"line\">                    waitPath = <span class=\"string\">&quot;/locks/&quot;</span>+children.get(index - <span class=\"number\">1</span>);</span><br><span class=\"line\">                    zk.getData(waitPath, <span class=\"literal\">true</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">                    <span class=\"comment\">//等待监听</span></span><br><span class=\"line\">                    waitLatch.await();</span><br><span class=\"line\">                    <span class=\"comment\">//监听结束 直接return</span></span><br><span class=\"line\">                    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (KeeperException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//解锁</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span>  <span class=\"keyword\">void</span> <span class=\"title function_\">unZkLock</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 直接删除节点</span></span><br><span class=\"line\">            zk.delete(CurrentMode, -<span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (KeeperException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"2）分布式锁测试\"><a href=\"#2）分布式锁测试\" class=\"headerlink\" title=\"2）分布式锁测试\"></a>2）分布式锁测试</h5><p>有不清楚的兄弟，记住：</p>\n<ul>\n<li>1、这里的线程是模拟多个客户端同时访问集群数据</li>\n<li>2、lock1和lock2实际代表的是两个客户端</li>\n<li>3、这个原理实现的核心有几个：临时顺序节点，还有就是await方法，监听节点删除事件</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.atguigu.zkdistributelock;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.zookeeper.KeeperException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">DistributedLockTest</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> IOException, InterruptedException, KeeperException &#123;</span><br><span class=\"line\">        <span class=\"type\">DistributedLock</span> <span class=\"variable\">lock1</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">DistributedLock</span>();</span><br><span class=\"line\">        <span class=\"type\">DistributedLock</span> <span class=\"variable\">lock2</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">DistributedLock</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    lock1.zkLock();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程1启动&quot;</span>);</span><br><span class=\"line\">                    Thread.sleep(<span class=\"number\">5</span> * <span class=\"number\">1000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    lock1.unzkLock();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程1释放锁&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (InterruptedException | KeeperException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;).start();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    lock2.zkLock();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程2启动&quot;</span>);</span><br><span class=\"line\">                    Thread.sleep(<span class=\"number\">5</span> * <span class=\"number\">1000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    lock2.unzkLock();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程2释放锁&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (InterruptedException | KeeperException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;).start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102055215.png\" alt=\"image-20230510205529113\" style=\"zoom:43%;\"></p>\n<h4 id=\"5-2-Curator-框架实现分布式锁案例\"><a href=\"#5-2-Curator-框架实现分布式锁案例\" class=\"headerlink\" title=\"5.2 Curator 框架实现分布式锁案例\"></a>5.2 Curator 框架实现分布式锁案例</h4><p>详情请查看官方文档：<a href=\"https://curator.apache.org/index.html\">https://curator.apache.org/index.html</a></p>\n<h5 id=\"1）原生的-Java-API-开发存在的问题\"><a href=\"#1）原生的-Java-API-开发存在的问题\" class=\"headerlink\" title=\"1）原生的 Java API 开发存在的问题\"></a>1）原生的 Java API 开发存在的问题</h5><ul>\n<li>（1）会话连接是异步的，需要自己去处理。比如使用 CountDownLatch</li>\n<li>（2）Watch 需要重复注册，不然就不能生效</li>\n<li>（3）开发的复杂性还是比较高的</li>\n<li>（4）不支持多节点删除和创建。需要自己去递归</li>\n</ul>\n<h5 id=\"2）Curator-案例实操\"><a href=\"#2）Curator-案例实操\" class=\"headerlink\" title=\"2）Curator 案例实操\"></a>2）Curator 案例实操</h5><h6 id=\"（1）添加依赖\"><a href=\"#（1）添加依赖\" class=\"headerlink\" title=\"（1）添加依赖\"></a>（1）添加依赖</h6><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.curator<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>curator-framework<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">       </span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.curator<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>curator-recipes<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">       </span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.curator<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>curator-client<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">           <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h6 id=\"（2）代码实现\"><a href=\"#（2）代码实现\" class=\"headerlink\" title=\"（2）代码实现\"></a>（2）代码实现</h6><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.ry.zk.test3;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.sun.jndi.ldap.pool.Pool;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.curator.framework.recipes.locks.InterProcessMutex;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.Policy;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CuratorLock</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//创建分布式锁一</span></span><br><span class=\"line\">        <span class=\"type\">InterProcessMutex</span> <span class=\"variable\">lock1</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InterProcessMutex</span>(getCuratorLockFrame(), <span class=\"string\">&quot;/locks&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//创建分布式锁二</span></span><br><span class=\"line\">        <span class=\"type\">InterProcessMutex</span> <span class=\"variable\">lock2</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InterProcessMutex</span>(getCuratorLockFrame(), <span class=\"string\">&quot;/locks&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    lock1.acquire();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程1获取到锁&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    lock1.acquire();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程1再次获取到锁&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    Thread.sleep(<span class=\"number\">5000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    lock1.release();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程1释放锁&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    lock1.release();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程1再次释放锁&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;).start();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    lock2.acquire();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程1获取到锁&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    lock2.acquire();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程1再次获取到锁&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    Thread.sleep(<span class=\"number\">5000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    lock2.release();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程1释放锁&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    lock2.release();</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程1再次释放锁&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;).start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> CuratorFramework <span class=\"title function_\">getCuratorLockFrame</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">ExponentialBackoffRetry</span> <span class=\"variable\">policy</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ExponentialBackoffRetry</span>(<span class=\"number\">2000</span>, <span class=\"number\">3</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">CuratorFramework</span> <span class=\"variable\">client</span> <span class=\"operator\">=</span> CuratorFrameworkFactory.builder().connectString(<span class=\"string\">&quot;172.16.108.139:2181,172.16.108.138:2181,172.16.108.140:2181&quot;</span>)</span><br><span class=\"line\">                .connectionTimeoutMs(<span class=\"number\">1000</span>)</span><br><span class=\"line\">                .sessionTimeoutMs(<span class=\"number\">1000</span>)</span><br><span class=\"line\">                .retryPolicy(policy)</span><br><span class=\"line\">                .build();</span><br><span class=\"line\"></span><br><span class=\"line\">        client.start();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;zookeeper 启动成功&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> client;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102109540.png\" alt=\"image-20230510210900441\" style=\"zoom:33%;\"></p>\n<h2 id=\"第-6-章-企业面试真题（面试重点）\"><a href=\"#第-6-章-企业面试真题（面试重点）\" class=\"headerlink\" title=\"第 6 章 企业面试真题（面试重点）\"></a>第 6 章 企业面试真题（面试重点）</h2><h4 id=\"6-1-选举机制\"><a href=\"#6-1-选举机制\" class=\"headerlink\" title=\"6.1 选举机制\"></a>6.1 选举机制</h4><p>半数机制，超过半数的投票通过，即通过。</p>\n<p>（1）第一次启动选举规则：</p>\n<p>投票过半数时，服务器 id 大的胜出</p>\n<p>（2）第二次启动选举规则：</p>\n<p>①EPOCH 大的直接胜出</p>\n<p>②EPOCH 相同，事务 id 大的胜出</p>\n<p>③事务 id 相同，服务器 id 大的胜出</p>\n<h4 id=\"6-2-生产集群安装多少-zk-合适？\"><a href=\"#6-2-生产集群安装多少-zk-合适？\" class=\"headerlink\" title=\"6.2 生产集群安装多少 zk 合适？\"></a>6.2 生产集群安装多少 zk 合适？</h4><p>安装奇数台。</p>\n<p>生产经验：</p>\n<ul>\n<li>10 台服务器：3 台 zk；</li>\n<li>20 台服务器：5 台 zk；</li>\n<li>100 台服务器：11 台 zk；</li>\n<li>200 台服务器：11 台 zk</li>\n</ul>\n<p>服务器台数多：</p>\n<ul>\n<li><p>好处，提高可靠性；</p>\n</li>\n<li><p>坏处：提高通信延时</p>\n</li>\n</ul>\n<h4 id=\"6-3常用命令\"><a href=\"#6-3常用命令\" class=\"headerlink\" title=\"6.3常用命令\"></a>6.3常用命令</h4><p><code>ls、get、create、delete</code></p>\n<h2 id=\"第-7-章-分布式一致性的解决情况\"><a href=\"#第-7-章-分布式一致性的解决情况\" class=\"headerlink\" title=\"第 7 章 分布式一致性的解决情况\"></a>第 7 章 分布式一致性的解决情况</h2><h3 id=\"Paxos算法\"><a href=\"#Paxos算法\" class=\"headerlink\" title=\"Paxos算法\"></a>Paxos算法</h3><h4 id=\"Paxos算法——解决什么问题\"><a href=\"#Paxos算法——解决什么问题\" class=\"headerlink\" title=\"Paxos算法——解决什么问题\"></a>Paxos算法——解决什么问题</h4><p><strong>Paxos</strong>算法：一种基于消息传递   且  具有高度容错特性的<code>一致性算法</code>。</p>\n<p><strong>Paxos算法解决的问题：</strong>快速正确的在一个分布式系统中对某个数据值达成一致，并且保证不论发生任何异常，都不会破坏整个系统的一致性</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102118509.png\" style=\"zoom:33%;\"></p>\n<h4 id=\"Paxos算法描述：\"><a href=\"#Paxos算法描述：\" class=\"headerlink\" title=\"Paxos算法描述：\"></a>Paxos算法描述：</h4><p>在一个Paxos系统中，首先将所有节点划分为Proposer（提议者），Acceptor（接受者），和Learner（学习者）。（注意：每个节点都可以身兼数职）。</p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102119103.png\" alt=\"image-20230510211932035\"></p>\n<ul>\n<li><p>一个完整的Paxos算法流程分为三个阶段：</p>\n<ul>\n<li><p>Prepare准备阶段</p>\n<ul>\n<li><p>Proposer向多个Acceptor<code>发出</code>Propose请求Promise（承诺）</p>\n</li>\n<li><p>Acceptor针对收到的Propose请求进行Promise（承诺）</p>\n</li>\n</ul>\n</li>\n<li><p>Accept接受阶段</p>\n<ul>\n<li><p>Proposer收到多数Acceptor承诺的Promise后，向Acceptor发出Propose请求</p>\n</li>\n<li><p>Acceptor针对收到的Propose请求进行Accept<code>处理</code></p>\n</li>\n</ul>\n</li>\n<li><p>Learn学习阶段：Proposer将形成的决议发送给所有Learners</p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"Paxos算法流程\"><a href=\"#Paxos算法流程\" class=\"headerlink\" title=\"Paxos算法流程\"></a>Paxos算法流程</h4><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102120362.png\" alt=\"image-20230510212030297\"></p>\n<ul>\n<li><p>1）<code>Prepare:</code></p>\n<p>Proposer生成全局唯一且递增的Proposal ID，向所有Acceptor发送Propose请求，这里无需携带提案内容，只携带Proposal ID即可。</p>\n</li>\n<li><p>2）<code>Promise:</code></p>\n<p>Acceptor收到Propose请求后，做出<code>两个承诺，一个应答</code></p>\n<ul>\n<li>不再接受Proposal ID小于等于（注意：这里是&lt;= ）当前请求的<code>Propose请求</code>。</li>\n<li>不再接受Proposal ID小于（注意：这里是&lt; ）当前<code>请求的Accept请求</code>。</li>\n<li>不违背以前做出的承诺下，回复已经Accept过的提案中<code>Proposal ID最大</code>的那个提案的Value和Proposal ID，没有则返回空值。</li>\n</ul>\n</li>\n<li><p>3）<code>Propose:</code></p>\n<p>Proposer收到多数Acceptor的Promise应答后，从应答中<code>选择Proposal ID最大的提案的Value（半数以上</code>），作为本次要发起的提案。</p>\n<p>如果所有应答的提案Value均为空值，则可以自己<code>随意决定</code>提案Value。</p>\n<p>然后携带当前Proposal ID，向所有Acceptor发送Propose请求。</p>\n</li>\n<li><p>4）<code>Accept:</code></p>\n<p>Acceptor收到Propose请求后，在不违背自己之前做出的承诺下，接受并持久化当前Proposal ID和提案Value。</p>\n</li>\n<li><p>5）<code>Learn:</code></p>\n<p>Proposer收到多数Acceptor的Accept后，决议形成，将形成的决议发送给所有Learner。</p>\n</li>\n</ul>\n<blockquote>\n<p>下面我们针对上述描述做三种情况的推演举例：为了简化流程，我们这里不设置 Learner。</p>\n</blockquote>\n<h6 id=\"情况1：\"><a href=\"#情况1：\" class=\"headerlink\" title=\"情况1：\"></a>情况1：</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102124671.png\" alt=\"image-20230510212433631\" style=\"zoom:33%;\"></p>\n<h6 id=\"情况2：\"><a href=\"#情况2：\" class=\"headerlink\" title=\"情况2：\"></a>情况2：</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305110004905.png\" alt=\"image-20230511000445866\" style=\"zoom:53%;\"></p>\n<blockquote>\n<p>Paxos 算法<strong>缺陷</strong>:在网络复杂的情况下，一个应用 Paxos 算法的分布式系统，可能很久 无法收敛，甚至陷入活锁的情况。</p>\n</blockquote>\n<h6 id=\"情况3：\"><a href=\"#情况3：\" class=\"headerlink\" title=\"情况3：\"></a>情况3：</h6><p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102127410.png\" alt=\"image-20230510212713380\" style=\"zoom:33%;\"></p>\n<blockquote>\n<p>==问题==</p>\n<p>造成这种情况的原因是系统中有一个以上的 Proposer，多个 Proposers 相互争夺 Acceptor，</p>\n<p>造成 迟迟无法达成一致的情况。</p>\n<p>针对这种情况，一种改进的 Paxos 算法被提出：从系统中选出一个节点作为 Leader，只有 Leader 能够发起提案。这样，一次 Paxos 流程中只有一个Proposer，不会出现活锁的情况，此时只会出现例子中第一种情况。</p>\n</blockquote>\n<h3 id=\"ZAB协议\"><a href=\"#ZAB协议\" class=\"headerlink\" title=\"ZAB协议\"></a>ZAB协议</h3><h6 id=\"什么是-ZAB算法\"><a href=\"#什么是-ZAB算法\" class=\"headerlink\" title=\"什么是 ZAB算法\"></a>什么是 ZAB算法</h6><p>Zab 借鉴了 Paxos 算法，是特别为 Zookeeper 设计的支持崩溃恢复的原子广播协议。</p>\n<p>基于该协议，Zookeeper 设计为只有一台客户端（Leader）负责处理外部的写事务请求，然后Leader 客户端将数据同步到其他 Follower 节点。即 Zookeeper 只有一个 Leader 可以发起提案。</p>\n<h6 id=\"Zab-协议内容\"><a href=\"#Zab-协议内容\" class=\"headerlink\" title=\"Zab 协议内容\"></a>Zab 协议内容</h6><p>Zab 协议包括两种基本的模式：<strong>消息广播、崩溃恢复。</strong></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102130128.png\" alt=\"image-20230510213009084\" style=\"zoom: 55%;\"></p>\n<ul>\n<li>1）客户端发起一个写操作请求。</li>\n<li>2）Leader服务器将客户端的请求转化为事务Proposal 提案，同时为每个Proposal 分配一个全局的ID，即 事务ID。</li>\n<li>3）Leader服务器为每个Follower服务器分配一个单独的<code>队列(FIFO)</code>，然后将需要广播的 Proposal依次放到队列中去，并且根据FIFO策略进行消息发送。</li>\n<li>4）Follower接收到Proposal后，会首先将其以事务日志的方式写入本地磁盘中，写入成功后向Leader反馈一个Ack响应消息。</li>\n<li>5）Leader接收到<code>超过半数以上</code>Follower的Ack响应消息后，即认为消息发送成功，<code>可以发送commit消息</code>。</li>\n<li>6）<code>Leader</code>向所有Follower广播commit消息，同时<code>自身也会完成事务提交</code>。Follower 接收到commit消息后，会将上一条事务提交。</li>\n<li>7）Zookeeper采用Zab协议的核心: 只要有一台服务器提交了Proposal，就要确保所有的服务器最终都能正确提交Proposal。</li>\n</ul>\n<blockquote>\n<p><strong>ZAB协议针对事务请求的处理过程类似于一个两阶段提交过程</strong></p>\n<p>1）广播事务阶段</p>\n<p>2）广播提交操作</p>\n<p><strong>这两阶段提交模型如下，有可能因为Leader宕机带来数据不一致，比如</strong></p>\n<p>1 ） Leader 发起一个事务Proposal1 后就<code>宕机</code>，Follower <code>都没有</code>Proposal1</p>\n<p>2） Leader收到半数ACK宕机，<code>没来得及</code>向Follower发送Commit</p>\n<p>怎么解决呢？==ZAB引入了崩溃恢复模式==</p>\n</blockquote>\n<h4 id=\"崩溃恢复\"><a href=\"#崩溃恢复\" class=\"headerlink\" title=\"崩溃恢复\"></a>崩溃恢复</h4><h5 id=\"崩溃恢复——异常假设\"><a href=\"#崩溃恢复——异常假设\" class=\"headerlink\" title=\"崩溃恢复——异常假设\"></a>崩溃恢复——异常假设</h5><p>一旦Leader服务器出现崩溃或者由于网络原因导致Leader服务器失去了与<code>过半 Follower</code>的联系，那么就会进入<strong>崩溃恢复模式。</strong></p>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102136883.png\" alt=\"image-20230510213624822\"></p>\n<h6 id=\"假设两种服务器异常情况：\"><a href=\"#假设两种服务器异常情况：\" class=\"headerlink\" title=\"假设两种服务器异常情况：\"></a>假设两种服务器异常情况：</h6><ul>\n<li>一个事务在Leader提出之后，<code>Leader挂了</code>（proposal 的 时候挂了）</li>\n<li>一个事务在Leader上提交了，并且过半的Follower都响应Ack了，但是<code>Leader在Commit消息发出之前挂了</code> （commit 的 时候挂了）</li>\n</ul>\n<h6 id=\"Zab协议崩溃恢复要求满足以下两个要求：\"><a href=\"#Zab协议崩溃恢复要求满足以下两个要求：\" class=\"headerlink\" title=\"Zab协议崩溃恢复要求满足以下两个要求：\"></a>Zab协议崩溃恢复要求满足以下两个要求：</h6><ul>\n<li><p>确保已经被Leader提交的提案Proposal必须最终被所有的Follower服务器提交。 （已经产生的提案，Follower必须执行）</p>\n</li>\n<li><p>确保<strong>丢弃</strong>已经被Leader提出的，但是没有被提交的Proposal</p>\n</li>\n</ul>\n<h5 id=\"崩溃恢复——Leader选举\"><a href=\"#崩溃恢复——Leader选举\" class=\"headerlink\" title=\"崩溃恢复——Leader选举\"></a>崩溃恢复——Leader选举</h5><p>崩溃恢复主要包括两部分：<code>Leader选举  和  数据恢复</code></p>\n<h6 id=\"Leader选举\"><a href=\"#Leader选举\" class=\"headerlink\" title=\"Leader选举\"></a>Leader选举</h6><blockquote>\n<p>根据上述要求，Zab协议需要保证选举出来的Leader需要满足以下条件：</p>\n</blockquote>\n<ul>\n<li>新选举出来的Leader不能包含未提交的Proposal。即新Leader必须都是已经提交了Proposal的Follower服务器节点</li>\n<li>新选举的Leader节点中含有最大的<code>zxid</code>。这样做的好处是可以避免Leader服务器检查Proposall的提交和丢弃工作。</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102143676.png\" alt=\"image-20230510214332632\"></p>\n<h6 id=\"Zab如何数据同步\"><a href=\"#Zab如何数据同步\" class=\"headerlink\" title=\"Zab如何数据同步\"></a>Zab如何数据同步</h6><ul>\n<li><p>完成Leaderi选举后，在正式开始工作之前（接收事务请求，然后提出新的Proposal),Leader服务器会首先确认事务日志中的所有的Proposal是否已经被集群中过半的服务器Commit</p>\n</li>\n<li><p>Leader服务器需要确保所有的Follower服务器能够接收到每一条事务的Proposal,并且能将所有己经提交的事务Proposal应用到内存数据中。</p>\n<p>等到Follower将所有尚未同步的事务Proposal都从Leader服务器上同步过，并且应用到内存数据中以后，Leader才会把该Follower加入到真正可用的Follower列表中。</p>\n</li>\n</ul>\n<p><img src=\"https://gitee.com/Ryang1118/typora/raw/master/images/202305102143394.png\" alt=\"image-20230510214348360\"></p>\n<h3 id=\"CAP\"><a href=\"#CAP\" class=\"headerlink\" title=\"CAP\"></a>CAP</h3><p>CAP理论告诉我们，一个分布式系统不可能同时满足以下三种</p>\n<h5 id=\"CAP理论\"><a href=\"#CAP理论\" class=\"headerlink\" title=\"CAP理论\"></a>CAP理论</h5><ul>\n<li><p>一致性（C:Consistency）</p>\n</li>\n<li><p>可用性（A:Available）</p>\n</li>\n<li><p>分区容错性（P:Partition Tolerance）</p>\n</li>\n</ul>\n<p>这三个基本需求，最多只能同时满足其中的两项，因为P是必须的，因此往往选择就在CP或者AP中。</p>\n<h6 id=\"一致性（C-Consistency）\"><a href=\"#一致性（C-Consistency）\" class=\"headerlink\" title=\"一致性（C:Consistency）\"></a>一致性（C:Consistency）</h6><p>在分布式环境中，一致性是指数据在多个副本之间是否能够保持数据一致的特性。在一致性的需求下，当一个系统在数</p>\n<p>据一致的状态下执行更新操作后，应该保证系统的数据仍然处于一致的状态。</p>\n<h6 id=\"可用性（A-Available）\"><a href=\"#可用性（A-Available）\" class=\"headerlink\" title=\"可用性（A:Available）\"></a>可用性（A:Available）</h6><p>可用性是指系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。</p>\n<h6 id=\"分区容错性（P-Partition-Tolerance\"><a href=\"#分区容错性（P-Partition-Tolerance\" class=\"headerlink\" title=\"分区容错性（P:Partition Tolerance)\"></a>分区容错性（P:Partition Tolerance)</h6><p>分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络</p>\n<p>环境都发生了故障。</p>\n<p>==ZooKeeper保证的是CP==</p>\n<p>ZooKeeper不能保证每次服务请求的可用性。（注：在极端环境下，ZooKeeper可能会丢弃一些请求，消费者程序需要</p>\n<p>重新请求才能获得结果）。所以说，ZooKeeper不能保证服务可用性。</p>\n<p>进行Leader选举时集群都是不可用(因为在正在选举)</p>\n<h2 id=\"源码-略\"><a href=\"#源码-略\" class=\"headerlink\" title=\"源码 (略)\"></a>源码 (略)</h2>","_path":"post/b829b66a.html","_link":"http://rycan.top/post/b829b66a.html","_id":"clnscmca4005ca80p51ejf4r8"}}